<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8"/>
    <title>二维码研究 | 看看俺 - KanKanAn.com</title>
    <link rel="shortcut icon" href="/static/favicon.ico" />
    <link rel="stylesheet" type="text/less" href="../../../style/less/o-blog.less"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="generator" content="o-blog"/>
    <script src="../../../style/js/less-1.3.0.min.js" type="text/javascript"></script>
    <script src="../../../style/js/jquery-1.7.1.min.js" type="text/javascript"></script>
    <script src="../../../style/bootstrap/js/bootstrap-modal.js" type="text/javascript"></script>
    <script src="../../../style/bootstrap/js/bootstrap-transition.js" type="text/javascript"></script>
    <script src="../../../style/bootstrap/js/bootstrap-dropdown.js" type="text/javascript"></script>
    <script src="../../../style/bootstrap/js/bootstrap-collapse.js" type="text/javascript"></script>
    <script src="../../../style/js/prettify.js" type="text/javascript"></script>
    <script src="../../../style/js/o-blog.linenumber.js" type="text/javascript"></script>
    <script src="../../../style/js/o-blog-fix.js" type="text/javascript"></script>
    
    
  </head>
  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
	<div class="container">
	  <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
	  <a class="brand" href="../../../index.html">看看俺 - KanKanAn.com</a>
	  <div class="nav-collapse collapse">
	    <ul>
<li><a href="../../../archives.html"><i>icon-list icon-white</i> 归档</a>

</li>
<li><a href="../../../tags.html"><i>icon-tags icon-white</i> 标签</a>

</li>
<li><a href="../../../index.xml"><i>icon-rss icon-white</i> 订阅</a>
</li>
</ul>



	  </div>
	</div>
      </div>
    </div>
    <div class="container container-fluid" style="padding-top: 60px;">
      <div class="row-fluid">
        <div id="page" class="span9">

  <div class="article">
  <header class="article-header">

    <div class="page-header">
      <div class="row">
	<div class="date span1">
	  <div class=" date-d">30</div>
	  <div class=" date-m"><a href="../../../posts/2013/03/index.html">3月</a></div>
	  <div class=" date-y"><a href="../../../posts/2013/index.html">2013</a>
	  </div>
	</div>
	<div class="span1">
	  <div class="qr-code">
  <img style="min-width:90px; min-height:90px; max-width:90px; max-height:90px;" src="http://chart.apis.google.com/chart?chs=90x90&cht=qr&chld=|0&chl=http%3A%2F%2Fblog.kankanan.com%2Fposts%2F2013%2F03%2F30_4e8c7ef4780178147a76.html"
       alt="qr-code" />
</div>

	</div>
	<h1 class="offset3">二维码研究</h1>
      </div>
      <nav>
	<ul class="pager">
	  <li class="previous"><a href="../../../posts/2013/03/27_archlinux4e0b5b8988c5cups625353707cfb7edf.html"><i class="icon-chevron-left"></i>&nbsp;Archlinux下安装cups打印系统</a></li><li class="next" style="text-align: right;"><a href="../../../posts/2013/03/30_5728emacs4e2d59824f554ee5root674396504f7f7528gdb8c038bd57a0b5e8f.html">在emacs中如何以root权限使用gdb调试程序&nbsp;<i class="icon-chevron-right"></i></a></li>
	</ul>
      </nav>
    </div>

  </header>
  <div class="article-content">
    <div id="outline-container-1" class="outline-3">
<h3 id="sec-1">介绍</h3>
<div class="outline-text-3" id="text-1">

<dl>
<dt><a href="http://www.itsc.org.sg/pdf/synthesis08/Three_QR_Code.pdf">Three_QR_Code.pdf</a></dt><dd>
<p>
     RFC式的文档
</p>
</dd>
<dt><a href="http://suflow.iteye.com/blog/1100678">二维码 编码原理简介</a></dt><dd>
<p>
     通俗易懂的编码细节介绍
</p>
</dd>
<dt><a href="http://zh.wikipedia.org/wiki/QR碼">QR碼 - 维基百科，自由的百科全书</a></dt><dd>

</dd>
<dt><a href="http://www.qrstuff.com/blog/2011/11/23/qr-code-minimum-size">QR Code Minimum Size</a> 与 <a href="http://www.qrstuff.com/blog/2011/01/18/what-size-should-a-qr-code-be">What Size Should A Printed QR Code Be?</a></dt><dd>
<p>
     关于可识别性的一些结论，该网站上有大量二维码研究相关的文章
</p></dd>
</dl>


</div>

</div>

<div id="outline-container-2" class="outline-3">
<h3 id="sec-2">二维码开发库</h3>
<div class="outline-text-3" id="text-2">

<dl>
<dt><a href="https://github.com/fukuchi/libqrencode">libqrencode</a></dt><dd>
<p>
     基础的c语言二维码编码库，很多语言基于它开发扩展，不包含生成png图的功能，如需生成png可参考<a href="https://github.com/bitly/simplehttp/blob/master/qrencode/qrencode.c">这里</a>
</p></dd>
<dt><a href="https://github.com/jeromeetienne/jquery-qrcode">jquery-qrcode</a></dt><dd>
<p>
     使用javascript直接在客户端生成二维码，中文支持参见<a href="http://suflow.iteye.com/blog/1687396">JS生成二维码，支持中文字符</a>
</p></dd>
<dt><a href="http://people.freebsd.org/~vanilla/qrencode-0.3.tar.bz2">php's qrencode extension</a></dt><dd>
<p>
     使用nginx的扩展性能会更好一点，参考后面<a href="#sec-3">nginx的相关扩展</a>.
</p></dd>
<dt><a href="http://trac.koka-in.org/libdecodeqr">libdecodeqr</a></dt><dd>
<p>
     二维码解码库
</p></dd>
</dl>


</div>

</div>

<div id="outline-container-3" class="outline-3">
<h3 id="sec-3">nginx的相关扩展</h3>
<div class="outline-text-3" id="text-3">


</div>

<div id="outline-container-3-1" class="outline-4">
<h4 id="sec-3-1">基本的二维码</h4>
<div class="outline-text-4" id="text-3-1">

<p>    <a href="https://github.com/dcshi/ngx_http_qrcode_module">ngx_http_qrcode_module</a>
</p>
</div>

</div>

<div id="outline-container-3-2" class="outline-4">
<h4 id="sec-3-2">二维码个性化水印</h4>
<div class="outline-text-4" id="text-3-2">

<p>   nginx_http_image_filter加上<a href="http://forum.nginx.org/read.php?21,235958">水印补丁</a>即可。
</p>
<p>
   下面的是经过修改后的 <code>nginx image filter</code> 模块代码，加入居中的水印效果:
</p>


<div class="o-blog-source"><a class="btn btn-info" data-toggle="modal" data-target="#ngx5fhttp5fimage5ffilter5fmodule2ec" ><i class="icon-file icon-white"></i>&nbsp;ngx_http_image_filter_module.c</a></div><div class="modal fade hide" id="ngx5fhttp5fimage5ffilter5fmodule2ec"><div class="modal-header"><a class="close" data-dismiss="modal">×</a><h3>ngx_http_image_filter_module.c</h3></div><div class="modal-body"><pre>

<span style="color: #888a85;">/*</span><span style="color: #888a85;">
 * Copyright (C) Igor Sysoev
 * Copyright (C) Nginx, Inc.
 </span><span style="color: #888a85;">*/</span>


<span style="color: #729fcf;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;ngx_config.h&gt;</span>
<span style="color: #729fcf;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;ngx_core.h&gt;</span>
<span style="color: #729fcf;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;ngx_http.h&gt;</span>

<span style="color: #729fcf;">#include</span> <span style="color: #ad7fa8; font-style: italic;">&lt;gd.h&gt;</span>


<span style="color: #729fcf;">#define</span> <span style="color: #eeeeec;">NGX_HTTP_IMAGE_OFF</span>       0
<span style="color: #729fcf;">#define</span> <span style="color: #eeeeec;">NGX_HTTP_IMAGE_TEST</span>      1
<span style="color: #729fcf;">#define</span> <span style="color: #eeeeec;">NGX_HTTP_IMAGE_SIZE</span>      2
<span style="color: #729fcf;">#define</span> <span style="color: #eeeeec;">NGX_HTTP_IMAGE_RESIZE</span>    3
<span style="color: #729fcf;">#define</span> <span style="color: #eeeeec;">NGX_HTTP_IMAGE_CROP</span>      4
<span style="color: #729fcf;">#define</span> <span style="color: #eeeeec;">NGX_HTTP_IMAGE_ROTATE</span>    5
<span style="color: #729fcf;">#define</span> <span style="color: #eeeeec;">NGX_HTTP_IMAGE_WATERMARK</span> 6


<span style="color: #729fcf;">#define</span> <span style="color: #eeeeec;">NGX_HTTP_IMAGE_START</span>     0
<span style="color: #729fcf;">#define</span> <span style="color: #eeeeec;">NGX_HTTP_IMAGE_READ</span>      1
<span style="color: #729fcf;">#define</span> <span style="color: #eeeeec;">NGX_HTTP_IMAGE_PROCESS</span>   2
<span style="color: #729fcf;">#define</span> <span style="color: #eeeeec;">NGX_HTTP_IMAGE_PASS</span>      3
<span style="color: #729fcf;">#define</span> <span style="color: #eeeeec;">NGX_HTTP_IMAGE_DONE</span>      4


<span style="color: #729fcf;">#define</span> <span style="color: #eeeeec;">NGX_HTTP_IMAGE_NONE</span>      0
<span style="color: #729fcf;">#define</span> <span style="color: #eeeeec;">NGX_HTTP_IMAGE_JPEG</span>      1
<span style="color: #729fcf;">#define</span> <span style="color: #eeeeec;">NGX_HTTP_IMAGE_GIF</span>       2
<span style="color: #729fcf;">#define</span> <span style="color: #eeeeec;">NGX_HTTP_IMAGE_PNG</span>       3


<span style="color: #729fcf;">#define</span> <span style="color: #eeeeec;">NGX_HTTP_IMAGE_BUFFERED</span>  0x08


<span style="color: #729fcf; font-weight: bold;">typedef</span> <span style="color: #729fcf; font-weight: bold;">struct</span> {
    <span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span>                   <span style="color: #eeeeec;">filter</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span>                   <span style="color: #eeeeec;">width</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span>                   <span style="color: #eeeeec;">height</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span>                   <span style="color: #eeeeec;">angle</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span>                   <span style="color: #eeeeec;">jpeg_quality</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span>                   <span style="color: #eeeeec;">sharpen</span>;

    <span style="color: #8ae234; font-weight: bold;">ngx_flag_t</span>                   <span style="color: #eeeeec;">transparency</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_str_t</span>                    <span style="color: #eeeeec;">watermark</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span>                   <span style="color: #eeeeec;">watermark_transparency</span>;
    
    <span style="color: #8ae234; font-weight: bold;">ngx_http_complex_value_t</span>    *<span style="color: #eeeeec;">wcv</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_http_complex_value_t</span>    *<span style="color: #eeeeec;">hcv</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_http_complex_value_t</span>    *<span style="color: #eeeeec;">acv</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_http_complex_value_t</span>    *<span style="color: #eeeeec;">jqcv</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_http_complex_value_t</span>    *<span style="color: #eeeeec;">shcv</span>;

    <span style="color: #8ae234; font-weight: bold;">size_t</span>                       <span style="color: #eeeeec;">buffer_size</span>;
} <span style="color: #8ae234; font-weight: bold;">ngx_http_image_filter_conf_t</span>;


<span style="color: #729fcf; font-weight: bold;">typedef</span> <span style="color: #729fcf; font-weight: bold;">struct</span> {
    <span style="color: #8ae234; font-weight: bold;">u_char</span>                      *<span style="color: #eeeeec;">image</span>;
    <span style="color: #8ae234; font-weight: bold;">u_char</span>                      *<span style="color: #eeeeec;">last</span>;

    <span style="color: #8ae234; font-weight: bold;">size_t</span>                       <span style="color: #eeeeec;">length</span>;

    <span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span>                   <span style="color: #eeeeec;">width</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span>                   <span style="color: #eeeeec;">height</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span>                   <span style="color: #eeeeec;">max_width</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span>                   <span style="color: #eeeeec;">max_height</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span>                   <span style="color: #eeeeec;">angle</span>;

    <span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span>                   <span style="color: #eeeeec;">phase</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span>                   <span style="color: #eeeeec;">type</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span>                   <span style="color: #eeeeec;">force</span>;
} <span style="color: #8ae234; font-weight: bold;">ngx_http_image_filter_ctx_t</span>;


<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">ngx_int_t</span> <span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_send</span>(<span style="color: #8ae234; font-weight: bold;">ngx_http_request_t</span> *<span style="color: #eeeeec;">r</span>,
    <span style="color: #8ae234; font-weight: bold;">ngx_http_image_filter_ctx_t</span> *<span style="color: #eeeeec;">ctx</span>, <span style="color: #8ae234; font-weight: bold;">ngx_chain_t</span> *<span style="color: #eeeeec;">in</span>);
<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span> <span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_test</span>(<span style="color: #8ae234; font-weight: bold;">ngx_http_request_t</span> *<span style="color: #eeeeec;">r</span>, <span style="color: #8ae234; font-weight: bold;">ngx_chain_t</span> *<span style="color: #eeeeec;">in</span>);
<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">ngx_int_t</span> <span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_read</span>(<span style="color: #8ae234; font-weight: bold;">ngx_http_request_t</span> *<span style="color: #eeeeec;">r</span>, <span style="color: #8ae234; font-weight: bold;">ngx_chain_t</span> *<span style="color: #eeeeec;">in</span>);
<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">ngx_buf_t</span> *<span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_process</span>(<span style="color: #8ae234; font-weight: bold;">ngx_http_request_t</span> *<span style="color: #eeeeec;">r</span>);
<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">ngx_buf_t</span> *<span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_json</span>(<span style="color: #8ae234; font-weight: bold;">ngx_http_request_t</span> *<span style="color: #eeeeec;">r</span>,
    <span style="color: #8ae234; font-weight: bold;">ngx_http_image_filter_ctx_t</span> *<span style="color: #eeeeec;">ctx</span>);
<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">ngx_buf_t</span> *<span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_asis</span>(<span style="color: #8ae234; font-weight: bold;">ngx_http_request_t</span> *<span style="color: #eeeeec;">r</span>,
    <span style="color: #8ae234; font-weight: bold;">ngx_http_image_filter_ctx_t</span> *<span style="color: #eeeeec;">ctx</span>);
<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">void</span> <span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_length</span>(<span style="color: #8ae234; font-weight: bold;">ngx_http_request_t</span> *<span style="color: #eeeeec;">r</span>, <span style="color: #8ae234; font-weight: bold;">ngx_buf_t</span> *<span style="color: #eeeeec;">b</span>);
<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">ngx_int_t</span> <span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_size</span>(<span style="color: #8ae234; font-weight: bold;">ngx_http_request_t</span> *<span style="color: #eeeeec;">r</span>,
    <span style="color: #8ae234; font-weight: bold;">ngx_http_image_filter_ctx_t</span> *<span style="color: #eeeeec;">ctx</span>);

<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">ngx_buf_t</span> *<span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_resize</span>(<span style="color: #8ae234; font-weight: bold;">ngx_http_request_t</span> *<span style="color: #eeeeec;">r</span>,
    <span style="color: #8ae234; font-weight: bold;">ngx_http_image_filter_ctx_t</span> *<span style="color: #eeeeec;">ctx</span>);
<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">gdImagePtr</span> <span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_source</span>(<span style="color: #8ae234; font-weight: bold;">ngx_http_request_t</span> *<span style="color: #eeeeec;">r</span>,
    <span style="color: #8ae234; font-weight: bold;">ngx_http_image_filter_ctx_t</span> *<span style="color: #eeeeec;">ctx</span>);
<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">gdImagePtr</span> <span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_new</span>(<span style="color: #8ae234; font-weight: bold;">ngx_http_request_t</span> *<span style="color: #eeeeec;">r</span>, <span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #eeeeec;">w</span>, <span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #eeeeec;">h</span>,
    <span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #eeeeec;">colors</span>);
<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">u_char</span> *<span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_out</span>(<span style="color: #8ae234; font-weight: bold;">ngx_http_request_t</span> *<span style="color: #eeeeec;">r</span>, <span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span> <span style="color: #eeeeec;">type</span>,
    <span style="color: #8ae234; font-weight: bold;">gdImagePtr</span> <span style="color: #eeeeec;">img</span>, <span style="color: #8ae234; font-weight: bold;">int</span> *<span style="color: #eeeeec;">size</span>);
<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">void</span> <span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_cleanup</span>(<span style="color: #8ae234; font-weight: bold;">void</span> *<span style="color: #eeeeec;">data</span>);
<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span> <span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_filter_get_value</span>(<span style="color: #8ae234; font-weight: bold;">ngx_http_request_t</span> *<span style="color: #eeeeec;">r</span>,
    <span style="color: #8ae234; font-weight: bold;">ngx_http_complex_value_t</span> *<span style="color: #eeeeec;">cv</span>, <span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span> <span style="color: #eeeeec;">v</span>);
<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span> <span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_filter_value</span>(<span style="color: #8ae234; font-weight: bold;">ngx_str_t</span> *<span style="color: #eeeeec;">value</span>);


<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">void</span> *<span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_filter_create_conf</span>(<span style="color: #8ae234; font-weight: bold;">ngx_conf_t</span> *<span style="color: #eeeeec;">cf</span>);
<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_filter_merge_conf</span>(<span style="color: #8ae234; font-weight: bold;">ngx_conf_t</span> *<span style="color: #eeeeec;">cf</span>, <span style="color: #8ae234; font-weight: bold;">void</span> *<span style="color: #eeeeec;">parent</span>,
    <span style="color: #8ae234; font-weight: bold;">void</span> *<span style="color: #eeeeec;">child</span>);
<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_filter</span>(<span style="color: #8ae234; font-weight: bold;">ngx_conf_t</span> *<span style="color: #eeeeec;">cf</span>, <span style="color: #8ae234; font-weight: bold;">ngx_command_t</span> *<span style="color: #eeeeec;">cmd</span>,
    <span style="color: #8ae234; font-weight: bold;">void</span> *<span style="color: #eeeeec;">conf</span>);
<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_filter_jpeg_quality</span>(<span style="color: #8ae234; font-weight: bold;">ngx_conf_t</span> *<span style="color: #eeeeec;">cf</span>,
    <span style="color: #8ae234; font-weight: bold;">ngx_command_t</span> *<span style="color: #eeeeec;">cmd</span>, <span style="color: #8ae234; font-weight: bold;">void</span> *<span style="color: #eeeeec;">conf</span>);
<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">char</span> *<span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_filter_sharpen</span>(<span style="color: #8ae234; font-weight: bold;">ngx_conf_t</span> *<span style="color: #eeeeec;">cf</span>, <span style="color: #8ae234; font-weight: bold;">ngx_command_t</span> *<span style="color: #eeeeec;">cmd</span>,
    <span style="color: #8ae234; font-weight: bold;">void</span> *<span style="color: #eeeeec;">conf</span>);
<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">ngx_int_t</span> <span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_filter_init</span>(<span style="color: #8ae234; font-weight: bold;">ngx_conf_t</span> *<span style="color: #eeeeec;">cf</span>);


<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">ngx_command_t</span>  <span style="color: #eeeeec;">ngx_http_image_filter_commands</span>[] = {

    { ngx_string(<span style="color: #ad7fa8; font-style: italic;">"image_filter"</span>),
      NGX_HTTP_LOC_CONF|NGX_CONF_TAKE123,
      ngx_http_image_filter,
      NGX_HTTP_LOC_CONF_OFFSET,
      0,
      <span style="color: #8ae234;">NULL</span> },

    { ngx_string(<span style="color: #ad7fa8; font-style: italic;">"image_filter_jpeg_quality"</span>),
      NGX_HTTP_MAIN_CONF|NGX_HTTP_SRV_CONF|NGX_HTTP_LOC_CONF|NGX_CONF_TAKE1,
      ngx_http_image_filter_jpeg_quality,
      NGX_HTTP_LOC_CONF_OFFSET,
      0,
      <span style="color: #8ae234;">NULL</span> },

    { ngx_string(<span style="color: #ad7fa8; font-style: italic;">"image_filter_sharpen"</span>),
      NGX_HTTP_MAIN_CONF|NGX_HTTP_SRV_CONF|NGX_HTTP_LOC_CONF|NGX_CONF_TAKE1,
      ngx_http_image_filter_sharpen,
      NGX_HTTP_LOC_CONF_OFFSET,
      0,
      <span style="color: #8ae234;">NULL</span> },

    { ngx_string(<span style="color: #ad7fa8; font-style: italic;">"image_filter_transparency"</span>),
      NGX_HTTP_MAIN_CONF|NGX_HTTP_SRV_CONF|NGX_HTTP_LOC_CONF|NGX_CONF_FLAG,
      ngx_conf_set_flag_slot,
      NGX_HTTP_LOC_CONF_OFFSET,
      offsetof(ngx_http_image_filter_conf_t, transparency),
      <span style="color: #8ae234;">NULL</span> },

    { ngx_string(<span style="color: #ad7fa8; font-style: italic;">"image_filter_buffer"</span>),
      NGX_HTTP_MAIN_CONF|NGX_HTTP_SRV_CONF|NGX_HTTP_LOC_CONF|NGX_CONF_TAKE1,
      ngx_conf_set_size_slot,
      NGX_HTTP_LOC_CONF_OFFSET,
      offsetof(ngx_http_image_filter_conf_t, buffer_size),
      <span style="color: #8ae234;">NULL</span> },

    { ngx_string(<span style="color: #ad7fa8; font-style: italic;">"image_filter_watermark"</span>),
      NGX_HTTP_MAIN_CONF|NGX_HTTP_SRV_CONF|NGX_HTTP_LOC_CONF|NGX_CONF_TAKE1,
      ngx_conf_set_str_slot,
      NGX_HTTP_LOC_CONF_OFFSET,
      offsetof(ngx_http_image_filter_conf_t, watermark),
      <span style="color: #8ae234;">NULL</span> },

    { ngx_string(<span style="color: #ad7fa8; font-style: italic;">"image_filter_watermark_transparency"</span>),
      NGX_HTTP_MAIN_CONF|NGX_HTTP_SRV_CONF|NGX_HTTP_LOC_CONF|NGX_CONF_TAKE1,
      ngx_conf_set_num_slot,
      NGX_HTTP_LOC_CONF_OFFSET,
      offsetof(ngx_http_image_filter_conf_t, watermark_transparency),
      <span style="color: #8ae234;">NULL</span> },
    
      ngx_null_command
};


<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">ngx_http_module_t</span>  <span style="color: #eeeeec;">ngx_http_image_filter_module_ctx</span> = {
    <span style="color: #8ae234;">NULL</span>,                                  <span style="color: #888a85;">/* </span><span style="color: #888a85;">preconfiguration </span><span style="color: #888a85;">*/</span>
    ngx_http_image_filter_init,            <span style="color: #888a85;">/* </span><span style="color: #888a85;">postconfiguration </span><span style="color: #888a85;">*/</span>

    <span style="color: #8ae234;">NULL</span>,                                  <span style="color: #888a85;">/* </span><span style="color: #888a85;">create main configuration </span><span style="color: #888a85;">*/</span>
    <span style="color: #8ae234;">NULL</span>,                                  <span style="color: #888a85;">/* </span><span style="color: #888a85;">init main configuration </span><span style="color: #888a85;">*/</span>

    <span style="color: #8ae234;">NULL</span>,                                  <span style="color: #888a85;">/* </span><span style="color: #888a85;">create server configuration </span><span style="color: #888a85;">*/</span>
    <span style="color: #8ae234;">NULL</span>,                                  <span style="color: #888a85;">/* </span><span style="color: #888a85;">merge server configuration </span><span style="color: #888a85;">*/</span>

    ngx_http_image_filter_create_conf,     <span style="color: #888a85;">/* </span><span style="color: #888a85;">create location configuration </span><span style="color: #888a85;">*/</span>
    ngx_http_image_filter_merge_conf       <span style="color: #888a85;">/* </span><span style="color: #888a85;">merge location configuration </span><span style="color: #888a85;">*/</span>
};


<span style="color: #8ae234; font-weight: bold;">ngx_module_t</span>  <span style="color: #eeeeec;">ngx_http_image_filter_module</span> = {
    NGX_MODULE_V1,
    &amp;ngx_http_image_filter_module_ctx,     <span style="color: #888a85;">/* </span><span style="color: #888a85;">module context </span><span style="color: #888a85;">*/</span>
    ngx_http_image_filter_commands,        <span style="color: #888a85;">/* </span><span style="color: #888a85;">module directives </span><span style="color: #888a85;">*/</span>
    NGX_HTTP_MODULE,                       <span style="color: #888a85;">/* </span><span style="color: #888a85;">module type </span><span style="color: #888a85;">*/</span>
    <span style="color: #8ae234;">NULL</span>,                                  <span style="color: #888a85;">/* </span><span style="color: #888a85;">init master </span><span style="color: #888a85;">*/</span>
    <span style="color: #8ae234;">NULL</span>,                                  <span style="color: #888a85;">/* </span><span style="color: #888a85;">init module </span><span style="color: #888a85;">*/</span>
    <span style="color: #8ae234;">NULL</span>,                                  <span style="color: #888a85;">/* </span><span style="color: #888a85;">init process </span><span style="color: #888a85;">*/</span>
    <span style="color: #8ae234;">NULL</span>,                                  <span style="color: #888a85;">/* </span><span style="color: #888a85;">init thread </span><span style="color: #888a85;">*/</span>
    <span style="color: #8ae234;">NULL</span>,                                  <span style="color: #888a85;">/* </span><span style="color: #888a85;">exit thread </span><span style="color: #888a85;">*/</span>
    <span style="color: #8ae234;">NULL</span>,                                  <span style="color: #888a85;">/* </span><span style="color: #888a85;">exit process </span><span style="color: #888a85;">*/</span>
    <span style="color: #8ae234;">NULL</span>,                                  <span style="color: #888a85;">/* </span><span style="color: #888a85;">exit master </span><span style="color: #888a85;">*/</span>
    NGX_MODULE_V1_PADDING
};


<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">ngx_http_output_header_filter_pt</span>  <span style="color: #eeeeec;">ngx_http_next_header_filter</span>;
<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">ngx_http_output_body_filter_pt</span>    <span style="color: #eeeeec;">ngx_http_next_body_filter</span>;


<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">ngx_str_t</span>  <span style="color: #eeeeec;">ngx_http_image_types</span>[] = {
    ngx_string(<span style="color: #ad7fa8; font-style: italic;">"image/jpeg"</span>),
    ngx_string(<span style="color: #ad7fa8; font-style: italic;">"image/gif"</span>),
    ngx_string(<span style="color: #ad7fa8; font-style: italic;">"image/png"</span>)
};


<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">ngx_int_t</span>
<span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_header_filter</span>(<span style="color: #8ae234; font-weight: bold;">ngx_http_request_t</span> *<span style="color: #eeeeec;">r</span>)
{
    <span style="color: #8ae234; font-weight: bold;">off_t</span>                          <span style="color: #eeeeec;">len</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_http_image_filter_ctx_t</span>   *<span style="color: #eeeeec;">ctx</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_http_image_filter_conf_t</span>  *<span style="color: #eeeeec;">conf</span>;

    <span style="color: #729fcf; font-weight: bold;">if</span> (r-&gt;headers_out.status == NGX_HTTP_NOT_MODIFIED) {
        <span style="color: #729fcf; font-weight: bold;">return</span> ngx_http_next_header_filter(r);
    }

    ctx = ngx_http_get_module_ctx(r, ngx_http_image_filter_module);

    <span style="color: #729fcf; font-weight: bold;">if</span> (ctx) {
        ngx_http_set_ctx(r, <span style="color: #8ae234;">NULL</span>, ngx_http_image_filter_module);
        <span style="color: #729fcf; font-weight: bold;">return</span> ngx_http_next_header_filter(r);
    }

    conf = ngx_http_get_module_loc_conf(r, ngx_http_image_filter_module);

    <span style="color: #729fcf; font-weight: bold;">if</span> (conf-&gt;filter == NGX_HTTP_IMAGE_OFF) {
        <span style="color: #729fcf; font-weight: bold;">return</span> ngx_http_next_header_filter(r);
    }

    <span style="color: #729fcf; font-weight: bold;">if</span> (r-&gt;headers_out.content_type.len
            &gt;= <span style="color: #729fcf; font-weight: bold;">sizeof</span>(<span style="color: #ad7fa8; font-style: italic;">"multipart/x-mixed-replace"</span>) - 1
        &amp;&amp; ngx_strncasecmp(r-&gt;headers_out.content_type.data,
                           (<span style="color: #8ae234; font-weight: bold;">u_char</span> *) <span style="color: #ad7fa8; font-style: italic;">"multipart/x-mixed-replace"</span>,
                           <span style="color: #729fcf; font-weight: bold;">sizeof</span>(<span style="color: #ad7fa8; font-style: italic;">"multipart/x-mixed-replace"</span>) - 1)
           == 0)
    {
        ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;log, 0,
                      <span style="color: #ad7fa8; font-style: italic;">"image filter: multipart/x-mixed-replace response"</span>);

        <span style="color: #729fcf; font-weight: bold;">return</span> NGX_ERROR;
    }

    ctx = ngx_pcalloc(r-&gt;pool, <span style="color: #729fcf; font-weight: bold;">sizeof</span>(ngx_http_image_filter_ctx_t));
    <span style="color: #729fcf; font-weight: bold;">if</span> (ctx == <span style="color: #8ae234;">NULL</span>) {
        <span style="color: #729fcf; font-weight: bold;">return</span> NGX_ERROR;
    }

    ngx_http_set_ctx(r, ctx, ngx_http_image_filter_module);

    len = r-&gt;headers_out.content_length_n;

    <span style="color: #729fcf; font-weight: bold;">if</span> (len != -1 &amp;&amp; len &gt; (<span style="color: #8ae234; font-weight: bold;">off_t</span>) conf-&gt;buffer_size) {
        ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;log, 0,
                      <span style="color: #ad7fa8; font-style: italic;">"image filter: too big response: %O"</span>, len);

        <span style="color: #729fcf; font-weight: bold;">return</span> NGX_HTTP_UNSUPPORTED_MEDIA_TYPE;
    }

    <span style="color: #729fcf; font-weight: bold;">if</span> (len == -1) {
        ctx-&gt;length = conf-&gt;buffer_size;

    } <span style="color: #729fcf; font-weight: bold;">else</span> {
        ctx-&gt;length = (<span style="color: #8ae234; font-weight: bold;">size_t</span>) len;
    }

    <span style="color: #729fcf; font-weight: bold;">if</span> (r-&gt;headers_out.refresh) {
        r-&gt;headers_out.refresh-&gt;hash = 0;
    }

    r-&gt;main_filter_need_in_memory = 1;
    r-&gt;allow_ranges = 0;

    <span style="color: #729fcf; font-weight: bold;">return</span> NGX_OK;
}


<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">ngx_int_t</span>
<span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_body_filter</span>(<span style="color: #8ae234; font-weight: bold;">ngx_http_request_t</span> *<span style="color: #eeeeec;">r</span>, <span style="color: #8ae234; font-weight: bold;">ngx_chain_t</span> *<span style="color: #eeeeec;">in</span>)
{
    <span style="color: #8ae234; font-weight: bold;">ngx_int_t</span>                      <span style="color: #eeeeec;">rc</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_str_t</span>                     *<span style="color: #eeeeec;">ct</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_chain_t</span>                    <span style="color: #eeeeec;">out</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_http_image_filter_ctx_t</span>   *<span style="color: #eeeeec;">ctx</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_http_image_filter_conf_t</span>  *<span style="color: #eeeeec;">conf</span>;

    ngx_log_debug0(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;log, 0, <span style="color: #ad7fa8; font-style: italic;">"image filter"</span>);

    <span style="color: #729fcf; font-weight: bold;">if</span> (in == <span style="color: #8ae234;">NULL</span>) {
        <span style="color: #729fcf; font-weight: bold;">return</span> ngx_http_next_body_filter(r, in);
    }

    ctx = ngx_http_get_module_ctx(r, ngx_http_image_filter_module);

    <span style="color: #729fcf; font-weight: bold;">if</span> (ctx == <span style="color: #8ae234;">NULL</span>) {
        <span style="color: #729fcf; font-weight: bold;">return</span> ngx_http_next_body_filter(r, in);
    }

    <span style="color: #729fcf; font-weight: bold;">switch</span> (ctx-&gt;phase) {

    <span style="color: #729fcf; font-weight: bold;">case</span> NGX_HTTP_IMAGE_START:

        ctx-&gt;type = ngx_http_image_test(r, in);

        conf = ngx_http_get_module_loc_conf(r, ngx_http_image_filter_module);

        <span style="color: #729fcf; font-weight: bold;">if</span> (ctx-&gt;type == NGX_HTTP_IMAGE_NONE) {

            <span style="color: #729fcf; font-weight: bold;">if</span> (conf-&gt;filter == NGX_HTTP_IMAGE_SIZE) {
                out.buf = ngx_http_image_json(r, <span style="color: #8ae234;">NULL</span>);

                <span style="color: #729fcf; font-weight: bold;">if</span> (out.buf) {
                    out.next = <span style="color: #8ae234;">NULL</span>;
                    ctx-&gt;phase = NGX_HTTP_IMAGE_DONE;

                    <span style="color: #729fcf; font-weight: bold;">return</span> ngx_http_image_send(r, ctx, &amp;out);
                }
            }

            <span style="color: #729fcf; font-weight: bold;">return</span> ngx_http_filter_finalize_request(r,
                                              &amp;ngx_http_image_filter_module,
                                              NGX_HTTP_UNSUPPORTED_MEDIA_TYPE);
        }

        <span style="color: #888a85;">/* </span><span style="color: #888a85;">override content type </span><span style="color: #888a85;">*/</span>

        ct = &amp;ngx_http_image_types[ctx-&gt;type - 1];
        r-&gt;headers_out.content_type_len = ct-&gt;len;
        r-&gt;headers_out.content_type = *ct;
        r-&gt;headers_out.content_type_lowcase = <span style="color: #8ae234;">NULL</span>;

        <span style="color: #729fcf; font-weight: bold;">if</span> (conf-&gt;filter == NGX_HTTP_IMAGE_TEST) {
            ctx-&gt;phase = NGX_HTTP_IMAGE_PASS;

            <span style="color: #729fcf; font-weight: bold;">return</span> ngx_http_image_send(r, ctx, in);
        }

        ctx-&gt;phase = NGX_HTTP_IMAGE_READ;

        <span style="color: #888a85;">/* </span><span style="color: #888a85;">fall through </span><span style="color: #888a85;">*/</span>

    <span style="color: #729fcf; font-weight: bold;">case</span> NGX_HTTP_IMAGE_READ:

        rc = ngx_http_image_read(r, in);

        <span style="color: #729fcf; font-weight: bold;">if</span> (rc == NGX_AGAIN) {
            <span style="color: #729fcf; font-weight: bold;">return</span> NGX_OK;
        }

        <span style="color: #729fcf; font-weight: bold;">if</span> (rc == NGX_ERROR) {
            <span style="color: #729fcf; font-weight: bold;">return</span> ngx_http_filter_finalize_request(r,
                                              &amp;ngx_http_image_filter_module,
                                              NGX_HTTP_UNSUPPORTED_MEDIA_TYPE);
        }

        <span style="color: #888a85;">/* </span><span style="color: #888a85;">fall through </span><span style="color: #888a85;">*/</span>

    <span style="color: #729fcf; font-weight: bold;">case</span> NGX_HTTP_IMAGE_PROCESS:

        out.buf = ngx_http_image_process(r);

        <span style="color: #729fcf; font-weight: bold;">if</span> (out.buf == <span style="color: #8ae234;">NULL</span>) {
            <span style="color: #729fcf; font-weight: bold;">return</span> ngx_http_filter_finalize_request(r,
                                              &amp;ngx_http_image_filter_module,
                                              NGX_HTTP_UNSUPPORTED_MEDIA_TYPE);
        }

        out.next = <span style="color: #8ae234;">NULL</span>;
        ctx-&gt;phase = NGX_HTTP_IMAGE_PASS;

        <span style="color: #729fcf; font-weight: bold;">return</span> ngx_http_image_send(r, ctx, &amp;out);

    <span style="color: #729fcf; font-weight: bold;">case</span> NGX_HTTP_IMAGE_PASS:

        <span style="color: #729fcf; font-weight: bold;">return</span> ngx_http_next_body_filter(r, in);

    <span style="color: #729fcf; font-weight: bold;">default</span>: <span style="color: #888a85;">/* </span><span style="color: #888a85;">NGX_HTTP_IMAGE_DONE </span><span style="color: #888a85;">*/</span>

        rc = ngx_http_next_body_filter(r, <span style="color: #8ae234;">NULL</span>);

        <span style="color: #888a85;">/* </span><span style="color: #888a85;">NGX_ERROR resets any pending data </span><span style="color: #888a85;">*/</span>
        <span style="color: #729fcf; font-weight: bold;">return</span> (rc == NGX_OK) ? NGX_ERROR : rc;
    }
}


<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">ngx_int_t</span>
<span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_send</span>(<span style="color: #8ae234; font-weight: bold;">ngx_http_request_t</span> *<span style="color: #eeeeec;">r</span>, <span style="color: #8ae234; font-weight: bold;">ngx_http_image_filter_ctx_t</span> *<span style="color: #eeeeec;">ctx</span>,
    <span style="color: #8ae234; font-weight: bold;">ngx_chain_t</span> *<span style="color: #eeeeec;">in</span>)
{
    <span style="color: #8ae234; font-weight: bold;">ngx_int_t</span>  <span style="color: #eeeeec;">rc</span>;

    rc = ngx_http_next_header_filter(r);

    <span style="color: #729fcf; font-weight: bold;">if</span> (rc == NGX_ERROR || rc &gt; NGX_OK || r-&gt;header_only) {
        <span style="color: #729fcf; font-weight: bold;">return</span> NGX_ERROR;
    }

    rc = ngx_http_next_body_filter(r, in);

    <span style="color: #729fcf; font-weight: bold;">if</span> (ctx-&gt;phase == NGX_HTTP_IMAGE_DONE) {
        <span style="color: #888a85;">/* </span><span style="color: #888a85;">NGX_ERROR resets any pending data </span><span style="color: #888a85;">*/</span>
        <span style="color: #729fcf; font-weight: bold;">return</span> (rc == NGX_OK) ? NGX_ERROR : rc;
    }

    <span style="color: #729fcf; font-weight: bold;">return</span> rc;
}


<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span>
<span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_test</span>(<span style="color: #8ae234; font-weight: bold;">ngx_http_request_t</span> *<span style="color: #eeeeec;">r</span>, <span style="color: #8ae234; font-weight: bold;">ngx_chain_t</span> *<span style="color: #eeeeec;">in</span>)
{
    <span style="color: #8ae234; font-weight: bold;">u_char</span>  *<span style="color: #eeeeec;">p</span>;

    p = in-&gt;buf-&gt;pos;

    <span style="color: #729fcf; font-weight: bold;">if</span> (in-&gt;buf-&gt;last - p &lt; 16) {
        <span style="color: #729fcf; font-weight: bold;">return</span> NGX_HTTP_IMAGE_NONE;
    }

    ngx_log_debug2(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;log, 0,
                   <span style="color: #ad7fa8; font-style: italic;">"image filter: \"%c%c\""</span>, p[0], p[1]);

    <span style="color: #729fcf; font-weight: bold;">if</span> (p[0] == 0xff &amp;&amp; p[1] == 0xd8) {

        <span style="color: #888a85;">/* </span><span style="color: #888a85;">JPEG </span><span style="color: #888a85;">*/</span>

        <span style="color: #729fcf; font-weight: bold;">return</span> NGX_HTTP_IMAGE_JPEG;

    } <span style="color: #729fcf; font-weight: bold;">else</span> <span style="color: #729fcf; font-weight: bold;">if</span> (p[0] == <span style="color: #ad7fa8; font-style: italic;">'G'</span> &amp;&amp; p[1] == <span style="color: #ad7fa8; font-style: italic;">'I'</span> &amp;&amp; p[2] == <span style="color: #ad7fa8; font-style: italic;">'F'</span> &amp;&amp; p[3] == <span style="color: #ad7fa8; font-style: italic;">'8'</span>
               &amp;&amp; p[5] == <span style="color: #ad7fa8; font-style: italic;">'a'</span>)
    {
        <span style="color: #729fcf; font-weight: bold;">if</span> (p[4] == <span style="color: #ad7fa8; font-style: italic;">'9'</span> || p[4] == <span style="color: #ad7fa8; font-style: italic;">'7'</span>) {
            <span style="color: #888a85;">/* </span><span style="color: #888a85;">GIF </span><span style="color: #888a85;">*/</span>
            <span style="color: #729fcf; font-weight: bold;">return</span> NGX_HTTP_IMAGE_GIF;
        }

    } <span style="color: #729fcf; font-weight: bold;">else</span> <span style="color: #729fcf; font-weight: bold;">if</span> (p[0] == 0x89 &amp;&amp; p[1] == <span style="color: #ad7fa8; font-style: italic;">'P'</span> &amp;&amp; p[2] == <span style="color: #ad7fa8; font-style: italic;">'N'</span> &amp;&amp; p[3] == <span style="color: #ad7fa8; font-style: italic;">'G'</span>
               &amp;&amp; p[4] == 0x0d &amp;&amp; p[5] == 0x0a &amp;&amp; p[6] == 0x1a &amp;&amp; p[7] == 0x0a)
    {
        <span style="color: #888a85;">/* </span><span style="color: #888a85;">PNG </span><span style="color: #888a85;">*/</span>

        <span style="color: #729fcf; font-weight: bold;">return</span> NGX_HTTP_IMAGE_PNG;
    }

    <span style="color: #729fcf; font-weight: bold;">return</span> NGX_HTTP_IMAGE_NONE;
}


<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">ngx_int_t</span>
<span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_read</span>(<span style="color: #8ae234; font-weight: bold;">ngx_http_request_t</span> *<span style="color: #eeeeec;">r</span>, <span style="color: #8ae234; font-weight: bold;">ngx_chain_t</span> *<span style="color: #eeeeec;">in</span>)
{
    <span style="color: #8ae234; font-weight: bold;">u_char</span>                       *<span style="color: #eeeeec;">p</span>;
    <span style="color: #8ae234; font-weight: bold;">size_t</span>                        <span style="color: #eeeeec;">size</span>, <span style="color: #eeeeec;">rest</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_buf_t</span>                    *<span style="color: #eeeeec;">b</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_chain_t</span>                  *<span style="color: #eeeeec;">cl</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_http_image_filter_ctx_t</span>  *<span style="color: #eeeeec;">ctx</span>;

    ctx = ngx_http_get_module_ctx(r, ngx_http_image_filter_module);

    <span style="color: #729fcf; font-weight: bold;">if</span> (ctx-&gt;image == <span style="color: #8ae234;">NULL</span>) {
        ctx-&gt;image = ngx_palloc(r-&gt;pool, ctx-&gt;length);
        <span style="color: #729fcf; font-weight: bold;">if</span> (ctx-&gt;image == <span style="color: #8ae234;">NULL</span>) {
            <span style="color: #729fcf; font-weight: bold;">return</span> NGX_ERROR;
        }

        ctx-&gt;last = ctx-&gt;image;
    }

    p = ctx-&gt;last;

    <span style="color: #729fcf; font-weight: bold;">for</span> (cl = in; cl; cl = cl-&gt;next) {

        b = cl-&gt;buf;
        size = b-&gt;last - b-&gt;pos;

        ngx_log_debug1(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;log, 0,
                       <span style="color: #ad7fa8; font-style: italic;">"image buf: %uz"</span>, size);

        rest = ctx-&gt;image + ctx-&gt;length - p;
        size = (rest &lt; size) ? rest : size;

        p = ngx_cpymem(p, b-&gt;pos, size);
        b-&gt;pos += size;

        <span style="color: #729fcf; font-weight: bold;">if</span> (b-&gt;last_buf) {
            ctx-&gt;last = p;
            <span style="color: #729fcf; font-weight: bold;">return</span> NGX_OK;
        }
    }

    ctx-&gt;last = p;
    r-&gt;connection-&gt;buffered |= NGX_HTTP_IMAGE_BUFFERED;

    <span style="color: #729fcf; font-weight: bold;">return</span> NGX_AGAIN;
}


<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">ngx_buf_t</span> *
<span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_process</span>(<span style="color: #8ae234; font-weight: bold;">ngx_http_request_t</span> *<span style="color: #eeeeec;">r</span>)
{
    <span style="color: #8ae234; font-weight: bold;">ngx_int_t</span>                      <span style="color: #eeeeec;">rc</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_http_image_filter_ctx_t</span>   *<span style="color: #eeeeec;">ctx</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_http_image_filter_conf_t</span>  *<span style="color: #eeeeec;">conf</span>;

    r-&gt;connection-&gt;buffered &amp;= ~NGX_HTTP_IMAGE_BUFFERED;

    ctx = ngx_http_get_module_ctx(r, ngx_http_image_filter_module);

    rc = ngx_http_image_size(r, ctx);

    conf = ngx_http_get_module_loc_conf(r, ngx_http_image_filter_module);

    <span style="color: #729fcf; font-weight: bold;">if</span> (conf-&gt;filter == NGX_HTTP_IMAGE_SIZE) {
        <span style="color: #729fcf; font-weight: bold;">return</span> ngx_http_image_json(r, rc == NGX_OK ? ctx : <span style="color: #8ae234;">NULL</span>);
    }

    ctx-&gt;angle = ngx_http_image_filter_get_value(r, conf-&gt;acv, conf-&gt;angle);

    <span style="color: #729fcf; font-weight: bold;">if</span> (conf-&gt;filter == NGX_HTTP_IMAGE_ROTATE) {

        <span style="color: #729fcf; font-weight: bold;">if</span> (ctx-&gt;angle != 90 &amp;&amp; ctx-&gt;angle != 180 &amp;&amp; ctx-&gt;angle != 270) {
            <span style="color: #729fcf; font-weight: bold;">return</span> <span style="color: #8ae234;">NULL</span>;
        }

        <span style="color: #729fcf; font-weight: bold;">return</span> ngx_http_image_resize(r, ctx);
    }

    <span style="color: #729fcf; font-weight: bold;">if</span> (conf-&gt;filter == NGX_HTTP_IMAGE_WATERMARK) {

        <span style="color: #729fcf; font-weight: bold;">if</span> (!conf-&gt;watermark.data) {
            <span style="color: #729fcf; font-weight: bold;">return</span> <span style="color: #8ae234;">NULL</span>;
        }

        <span style="color: #729fcf; font-weight: bold;">return</span> ngx_http_image_resize(r, ctx);
    }    

    ctx-&gt;max_width = ngx_http_image_filter_get_value(r, conf-&gt;wcv, conf-&gt;width);
    <span style="color: #729fcf; font-weight: bold;">if</span> (ctx-&gt;max_width == 0) {
        <span style="color: #729fcf; font-weight: bold;">return</span> <span style="color: #8ae234;">NULL</span>;
    }

    ctx-&gt;max_height = ngx_http_image_filter_get_value(r, conf-&gt;hcv,
                                                      conf-&gt;height);
    <span style="color: #729fcf; font-weight: bold;">if</span> (ctx-&gt;max_height == 0) {
        <span style="color: #729fcf; font-weight: bold;">return</span> <span style="color: #8ae234;">NULL</span>;
    }

    <span style="color: #729fcf; font-weight: bold;">if</span> (rc == NGX_OK
        &amp;&amp; ctx-&gt;width &lt;= ctx-&gt;max_width
        &amp;&amp; ctx-&gt;height &lt;= ctx-&gt;max_height
        &amp;&amp; ctx-&gt;angle == 0
        &amp;&amp; !ctx-&gt;force)
    {
        <span style="color: #729fcf; font-weight: bold;">return</span> ngx_http_image_asis(r, ctx);
    }

    <span style="color: #729fcf; font-weight: bold;">return</span> ngx_http_image_resize(r, ctx);
}


<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">ngx_buf_t</span> *
<span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_json</span>(<span style="color: #8ae234; font-weight: bold;">ngx_http_request_t</span> *<span style="color: #eeeeec;">r</span>, <span style="color: #8ae234; font-weight: bold;">ngx_http_image_filter_ctx_t</span> *<span style="color: #eeeeec;">ctx</span>)
{
    <span style="color: #8ae234; font-weight: bold;">size_t</span>      <span style="color: #eeeeec;">len</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_buf_t</span>  *<span style="color: #eeeeec;">b</span>;

    b = ngx_pcalloc(r-&gt;pool, <span style="color: #729fcf; font-weight: bold;">sizeof</span>(ngx_buf_t));
    <span style="color: #729fcf; font-weight: bold;">if</span> (b == <span style="color: #8ae234;">NULL</span>) {
        <span style="color: #729fcf; font-weight: bold;">return</span> <span style="color: #8ae234;">NULL</span>;
    }

    b-&gt;memory = 1;
    b-&gt;last_buf = 1;

    ngx_http_clean_header(r);

    r-&gt;headers_out.status = NGX_HTTP_OK;
    ngx_str_set(&amp;r-&gt;headers_out.content_type, <span style="color: #ad7fa8; font-style: italic;">"text/plain"</span>);
    r-&gt;headers_out.content_type_lowcase = <span style="color: #8ae234;">NULL</span>;

    <span style="color: #729fcf; font-weight: bold;">if</span> (ctx == <span style="color: #8ae234;">NULL</span>) {
        b-&gt;pos = (<span style="color: #8ae234; font-weight: bold;">u_char</span> *) <span style="color: #ad7fa8; font-style: italic;">"{}"</span> CRLF;
        b-&gt;last = b-&gt;pos + <span style="color: #729fcf; font-weight: bold;">sizeof</span>(<span style="color: #ad7fa8; font-style: italic;">"{}"</span> CRLF) - 1;

        ngx_http_image_length(r, b);

        <span style="color: #729fcf; font-weight: bold;">return</span> b;
    }

    len = <span style="color: #729fcf; font-weight: bold;">sizeof</span>(<span style="color: #ad7fa8; font-style: italic;">"{ \"img\" : "</span>
                 <span style="color: #ad7fa8; font-style: italic;">"{ \"width\": , \"height\": , \"type\": \"jpeg\" } }"</span> CRLF) - 1
          + 2 * NGX_SIZE_T_LEN;

    b-&gt;pos = ngx_pnalloc(r-&gt;pool, len);
    <span style="color: #729fcf; font-weight: bold;">if</span> (b-&gt;pos == <span style="color: #8ae234;">NULL</span>) {
        <span style="color: #729fcf; font-weight: bold;">return</span> <span style="color: #8ae234;">NULL</span>;
    }

    b-&gt;last = ngx_sprintf(b-&gt;pos,
                          <span style="color: #ad7fa8; font-style: italic;">"{ \"img\" : "</span>
                                       <span style="color: #ad7fa8; font-style: italic;">"{ \"width\": %uz,"</span>
                                        <span style="color: #ad7fa8; font-style: italic;">" \"height\": %uz,"</span>
                                        <span style="color: #ad7fa8; font-style: italic;">" \"type\": \"%s\" } }"</span> CRLF,
                          ctx-&gt;width, ctx-&gt;height,
                          ngx_http_image_types[ctx-&gt;type - 1].data + 6);

    ngx_http_image_length(r, b);

    <span style="color: #729fcf; font-weight: bold;">return</span> b;
}


<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">ngx_buf_t</span> *
<span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_asis</span>(<span style="color: #8ae234; font-weight: bold;">ngx_http_request_t</span> *<span style="color: #eeeeec;">r</span>, <span style="color: #8ae234; font-weight: bold;">ngx_http_image_filter_ctx_t</span> *<span style="color: #eeeeec;">ctx</span>)
{
    <span style="color: #8ae234; font-weight: bold;">ngx_buf_t</span>  *<span style="color: #eeeeec;">b</span>;

    b = ngx_pcalloc(r-&gt;pool, <span style="color: #729fcf; font-weight: bold;">sizeof</span>(ngx_buf_t));
    <span style="color: #729fcf; font-weight: bold;">if</span> (b == <span style="color: #8ae234;">NULL</span>) {
        <span style="color: #729fcf; font-weight: bold;">return</span> <span style="color: #8ae234;">NULL</span>;
    }

    b-&gt;pos = ctx-&gt;image;
    b-&gt;last = ctx-&gt;last;
    b-&gt;memory = 1;
    b-&gt;last_buf = 1;

    ngx_http_image_length(r, b);

    <span style="color: #729fcf; font-weight: bold;">return</span> b;
}


<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">void</span>
<span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_length</span>(<span style="color: #8ae234; font-weight: bold;">ngx_http_request_t</span> *<span style="color: #eeeeec;">r</span>, <span style="color: #8ae234; font-weight: bold;">ngx_buf_t</span> *<span style="color: #eeeeec;">b</span>)
{
    r-&gt;headers_out.content_length_n = b-&gt;last - b-&gt;pos;

    <span style="color: #729fcf; font-weight: bold;">if</span> (r-&gt;headers_out.content_length) {
        r-&gt;headers_out.content_length-&gt;hash = 0;
    }

    r-&gt;headers_out.content_length = <span style="color: #8ae234;">NULL</span>;
}


<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">ngx_int_t</span>
<span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_size</span>(<span style="color: #8ae234; font-weight: bold;">ngx_http_request_t</span> *<span style="color: #eeeeec;">r</span>, <span style="color: #8ae234; font-weight: bold;">ngx_http_image_filter_ctx_t</span> *<span style="color: #eeeeec;">ctx</span>)
{
    <span style="color: #8ae234; font-weight: bold;">u_char</span>      *<span style="color: #eeeeec;">p</span>, *<span style="color: #eeeeec;">last</span>;
    <span style="color: #8ae234; font-weight: bold;">size_t</span>       <span style="color: #eeeeec;">len</span>, <span style="color: #eeeeec;">app</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span>   <span style="color: #eeeeec;">width</span>, <span style="color: #eeeeec;">height</span>;

    p = ctx-&gt;image;

    <span style="color: #729fcf; font-weight: bold;">switch</span> (ctx-&gt;type) {

    <span style="color: #729fcf; font-weight: bold;">case</span> NGX_HTTP_IMAGE_JPEG:

        p += 2;
        last = ctx-&gt;image + ctx-&gt;length - 10;
        width = 0;
        height = 0;
        app = 0;

        <span style="color: #729fcf; font-weight: bold;">while</span> (p &lt; last) {

            <span style="color: #729fcf; font-weight: bold;">if</span> (p[0] == 0xff &amp;&amp; p[1] != 0xff) {

                ngx_log_debug2(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;log, 0,
                               <span style="color: #ad7fa8; font-style: italic;">"JPEG: %02xd %02xd"</span>, p[0], p[1]);

                p++;

                <span style="color: #729fcf; font-weight: bold;">if</span> ((*p == 0xc0 || *p == 0xc1 || *p == 0xc2 || *p == 0xc3
                     || *p == 0xc9 || *p == 0xca || *p == 0xcb)
                    &amp;&amp; (width == 0 || height == 0))
                {
                    width = p[6] * 256 + p[7];
                    height = p[4] * 256 + p[5];
                }

                ngx_log_debug2(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;log, 0,
                               <span style="color: #ad7fa8; font-style: italic;">"JPEG: %02xd %02xd"</span>, p[1], p[2]);

                len = p[1] * 256 + p[2];

                <span style="color: #729fcf; font-weight: bold;">if</span> (*p &gt;= 0xe1 &amp;&amp; *p &lt;= 0xef) {
                    <span style="color: #888a85;">/* </span><span style="color: #888a85;">application data, e.g., EXIF, Adobe XMP, etc. </span><span style="color: #888a85;">*/</span>
                    app += len;
                }

                p += len;

                <span style="color: #729fcf; font-weight: bold;">continue</span>;
            }

            p++;
        }

        <span style="color: #729fcf; font-weight: bold;">if</span> (width == 0 || height == 0) {
            <span style="color: #729fcf; font-weight: bold;">return</span> NGX_DECLINED;
        }

        <span style="color: #729fcf; font-weight: bold;">if</span> (ctx-&gt;length / 20 &lt; app) {
            <span style="color: #888a85;">/* </span><span style="color: #888a85;">force conversion if application data consume more than 5% </span><span style="color: #888a85;">*/</span>
            ctx-&gt;force = 1;
            ngx_log_debug1(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;log, 0,
                           <span style="color: #ad7fa8; font-style: italic;">"app data size: %uz"</span>, app);
        }

        <span style="color: #729fcf; font-weight: bold;">break</span>;

    <span style="color: #729fcf; font-weight: bold;">case</span> NGX_HTTP_IMAGE_GIF:

        <span style="color: #729fcf; font-weight: bold;">if</span> (ctx-&gt;length &lt; 10) {
            <span style="color: #729fcf; font-weight: bold;">return</span> NGX_DECLINED;
        }

        width = p[7] * 256 + p[6];
        height = p[9] * 256 + p[8];

        <span style="color: #729fcf; font-weight: bold;">break</span>;

    <span style="color: #729fcf; font-weight: bold;">case</span> NGX_HTTP_IMAGE_PNG:

        <span style="color: #729fcf; font-weight: bold;">if</span> (ctx-&gt;length &lt; 24) {
            <span style="color: #729fcf; font-weight: bold;">return</span> NGX_DECLINED;
        }

        width = p[18] * 256 + p[19];
        height = p[22] * 256 + p[23];

        <span style="color: #729fcf; font-weight: bold;">break</span>;

    <span style="color: #729fcf; font-weight: bold;">default</span>:

        <span style="color: #729fcf; font-weight: bold;">return</span> NGX_DECLINED;
    }

    ngx_log_debug2(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;log, 0,
                   <span style="color: #ad7fa8; font-style: italic;">"image size: %d x %d"</span>, width, height);

    ctx-&gt;width = width;
    ctx-&gt;height = height;

    <span style="color: #729fcf; font-weight: bold;">return</span> NGX_OK;
}


<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">ngx_buf_t</span> *
<span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_resize</span>(<span style="color: #8ae234; font-weight: bold;">ngx_http_request_t</span> *<span style="color: #eeeeec;">r</span>, <span style="color: #8ae234; font-weight: bold;">ngx_http_image_filter_ctx_t</span> *<span style="color: #eeeeec;">ctx</span>)
{
    <span style="color: #8ae234; font-weight: bold;">int</span>                            <span style="color: #eeeeec;">sx</span>, <span style="color: #eeeeec;">sy</span>, <span style="color: #eeeeec;">dx</span>, <span style="color: #eeeeec;">dy</span>, <span style="color: #eeeeec;">ox</span>, <span style="color: #eeeeec;">oy</span>, <span style="color: #eeeeec;">ax</span>, <span style="color: #eeeeec;">ay</span>, <span style="color: #eeeeec;">size</span>,
                                   <span style="color: #eeeeec;">colors</span>, <span style="color: #eeeeec;">palette</span>, <span style="color: #eeeeec;">transparent</span>, <span style="color: #eeeeec;">sharpen</span>,
                                   <span style="color: #eeeeec;">red</span>, <span style="color: #eeeeec;">green</span>, <span style="color: #eeeeec;">blue</span>, <span style="color: #eeeeec;">t</span>;
    <span style="color: #8ae234; font-weight: bold;">u_char</span>                        *<span style="color: #eeeeec;">out</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_buf_t</span>                     *<span style="color: #eeeeec;">b</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span>                     <span style="color: #eeeeec;">resize</span>;
    <span style="color: #8ae234; font-weight: bold;">gdImagePtr</span>                     <span style="color: #eeeeec;">src</span>, <span style="color: #eeeeec;">dst</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_pool_cleanup_t</span>            *<span style="color: #eeeeec;">cln</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_http_image_filter_conf_t</span>  *<span style="color: #eeeeec;">conf</span>;

    src = ngx_http_image_source(r, ctx);

    <span style="color: #729fcf; font-weight: bold;">if</span> (src == <span style="color: #8ae234;">NULL</span>) {
        <span style="color: #729fcf; font-weight: bold;">return</span> <span style="color: #8ae234;">NULL</span>;
    }

    sx = gdImageSX(src);
    sy = gdImageSY(src);

    conf = ngx_http_get_module_loc_conf(r, ngx_http_image_filter_module);

    <span style="color: #729fcf; font-weight: bold;">if</span> (!ctx-&gt;force
        &amp;&amp; ctx-&gt;angle == 0
        &amp;&amp; (<span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span>) sx &lt;= ctx-&gt;max_width
        &amp;&amp; (<span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span>) sy &lt;= ctx-&gt;max_height)
    {
        gdImageDestroy(src);
        <span style="color: #729fcf; font-weight: bold;">return</span> ngx_http_image_asis(r, ctx);
    }

    colors = gdImageColorsTotal(src);

    <span style="color: #729fcf; font-weight: bold;">if</span> (colors &amp;&amp; conf-&gt;transparency) {
        transparent = gdImageGetTransparent(src);

        <span style="color: #729fcf; font-weight: bold;">if</span> (transparent != -1) {
            palette = colors;
            red = gdImageRed(src, transparent);
            green = gdImageGreen(src, transparent);
            blue = gdImageBlue(src, transparent);

            <span style="color: #729fcf; font-weight: bold;">goto</span> <span style="color: #8ae234;">transparent</span>;
        }
    }

    palette = 0;
    transparent = -1;
    red = 0;
    green = 0;
    blue = 0;

<span style="color: #8ae234;">transparent</span>:

    gdImageColorTransparent(src, -1);

    dx = sx;
    dy = sy;

    <span style="color: #729fcf; font-weight: bold;">if</span> (conf-&gt;filter == NGX_HTTP_IMAGE_RESIZE) {

        <span style="color: #729fcf; font-weight: bold;">if</span> ((<span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span>) dx &gt; ctx-&gt;max_width) {
            dy = dy * ctx-&gt;max_width / dx;
            dy = dy ? dy : 1;
            dx = ctx-&gt;max_width;
        }

        <span style="color: #729fcf; font-weight: bold;">if</span> ((<span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span>) dy &gt; ctx-&gt;max_height) {
            dx = dx * ctx-&gt;max_height / dy;
            dx = dx ? dx : 1;
            dy = ctx-&gt;max_height;
        }

        resize = 1;

    } <span style="color: #729fcf; font-weight: bold;">else</span> <span style="color: #729fcf; font-weight: bold;">if</span> (conf-&gt;filter == NGX_HTTP_IMAGE_ROTATE) {

        resize = 0;
    } <span style="color: #729fcf; font-weight: bold;">else</span> <span style="color: #729fcf; font-weight: bold;">if</span> (conf-&gt;filter == NGX_HTTP_IMAGE_WATERMARK) {
        
        resize = 0;
    } <span style="color: #729fcf; font-weight: bold;">else</span> { <span style="color: #888a85;">/* </span><span style="color: #888a85;">NGX_HTTP_IMAGE_CROP </span><span style="color: #888a85;">*/</span>

        resize = 0;

        <span style="color: #729fcf; font-weight: bold;">if</span> ((<span style="color: #8ae234; font-weight: bold;">double</span>) dx / dy &lt; (<span style="color: #8ae234; font-weight: bold;">double</span>) ctx-&gt;max_width / ctx-&gt;max_height) {
            <span style="color: #729fcf; font-weight: bold;">if</span> ((<span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span>) dx &gt; ctx-&gt;max_width) {
                dy = dy * ctx-&gt;max_width / dx;
                dy = dy ? dy : 1;
                dx = ctx-&gt;max_width;
                resize = 1;
            }

        } <span style="color: #729fcf; font-weight: bold;">else</span> {
            <span style="color: #729fcf; font-weight: bold;">if</span> ((<span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span>) dy &gt; ctx-&gt;max_height) {
                dx = dx * ctx-&gt;max_height / dy;
                dx = dx ? dx : 1;
                dy = ctx-&gt;max_height;
                resize = 1;
            }
        }
    }

    <span style="color: #729fcf; font-weight: bold;">if</span> (resize) {
        dst = ngx_http_image_new(r, dx, dy, palette);
        <span style="color: #729fcf; font-weight: bold;">if</span> (dst == <span style="color: #8ae234;">NULL</span>) {
            gdImageDestroy(src);
            <span style="color: #729fcf; font-weight: bold;">return</span> <span style="color: #8ae234;">NULL</span>;
        }

        <span style="color: #729fcf; font-weight: bold;">if</span> (colors == 0) {
            gdImageSaveAlpha(dst, 1);
            gdImageAlphaBlending(dst, 0);
        }

        gdImageCopyResampled(dst, src, 0, 0, 0, 0, dx, dy, sx, sy);

        <span style="color: #729fcf; font-weight: bold;">if</span> (colors) {
            gdImageTrueColorToPalette(dst, 1, 256);
        }

        gdImageDestroy(src);

    } <span style="color: #729fcf; font-weight: bold;">else</span> {
        dst = src;
    }

    <span style="color: #729fcf; font-weight: bold;">if</span> (ctx-&gt;angle) {
        src = dst;

        ax = (dx % 2 == 0) ? 1 : 0;
        ay = (dy % 2 == 0) ? 1 : 0;

        <span style="color: #729fcf; font-weight: bold;">switch</span> (ctx-&gt;angle) {

        <span style="color: #729fcf; font-weight: bold;">case</span> 90:
        <span style="color: #729fcf; font-weight: bold;">case</span> 270:
            dst = ngx_http_image_new(r, dy, dx, palette);
            <span style="color: #729fcf; font-weight: bold;">if</span> (dst == <span style="color: #8ae234;">NULL</span>) {
                gdImageDestroy(src);
                <span style="color: #729fcf; font-weight: bold;">return</span> <span style="color: #8ae234;">NULL</span>;
            }
            <span style="color: #729fcf; font-weight: bold;">if</span> (ctx-&gt;angle == 90) {
                ox = dy / 2 + ay;
                oy = dx / 2 - ax;

            } <span style="color: #729fcf; font-weight: bold;">else</span> {
                ox = dy / 2 - ay;
                oy = dx / 2 + ax;
            }

            gdImageCopyRotated(dst, src, ox, oy, 0, 0,
                               dx + ax, dy + ay, ctx-&gt;angle);
            gdImageDestroy(src);

            t = dx;
            dx = dy;
            dy = t;
            <span style="color: #729fcf; font-weight: bold;">break</span>;

        <span style="color: #729fcf; font-weight: bold;">case</span> 180:
            dst = ngx_http_image_new(r, dx, dy, palette);
            <span style="color: #729fcf; font-weight: bold;">if</span> (dst == <span style="color: #8ae234;">NULL</span>) {
                gdImageDestroy(src);
                <span style="color: #729fcf; font-weight: bold;">return</span> <span style="color: #8ae234;">NULL</span>;
            }
            gdImageCopyRotated(dst, src, dx / 2 - ax, dy / 2 - ay, 0, 0,
                               dx + ax, dy + ay, ctx-&gt;angle);
            gdImageDestroy(src);
            <span style="color: #729fcf; font-weight: bold;">break</span>;
        }
    }

    <span style="color: #729fcf; font-weight: bold;">if</span> (conf-&gt;filter == NGX_HTTP_IMAGE_CROP) {

        src = dst;

        <span style="color: #729fcf; font-weight: bold;">if</span> ((<span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span>) dx &gt; ctx-&gt;max_width) {
            ox = dx - ctx-&gt;max_width;

        } <span style="color: #729fcf; font-weight: bold;">else</span> {
            ox = 0;
        }

        <span style="color: #729fcf; font-weight: bold;">if</span> ((<span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span>) dy &gt; ctx-&gt;max_height) {
            oy = dy - ctx-&gt;max_height;

        } <span style="color: #729fcf; font-weight: bold;">else</span> {
            oy = 0;
        }

        <span style="color: #729fcf; font-weight: bold;">if</span> (ox || oy) {

            dst = ngx_http_image_new(r, dx - ox, dy - oy, colors);

            <span style="color: #729fcf; font-weight: bold;">if</span> (dst == <span style="color: #8ae234;">NULL</span>) {
                gdImageDestroy(src);
                <span style="color: #729fcf; font-weight: bold;">return</span> <span style="color: #8ae234;">NULL</span>;
            }

            ox /= 2;
            oy /= 2;

            ngx_log_debug4(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;log, 0,
                           <span style="color: #ad7fa8; font-style: italic;">"image crop: %d x %d @ %d x %d"</span>,
                           dx, dy, ox, oy);

            <span style="color: #729fcf; font-weight: bold;">if</span> (colors == 0) {
                gdImageSaveAlpha(dst, 1);
                gdImageAlphaBlending(dst, 0);
            }

            gdImageCopy(dst, src, 0, 0, ox, oy, dx - ox, dy - oy);

            <span style="color: #729fcf; font-weight: bold;">if</span> (colors) {
                gdImageTrueColorToPalette(dst, 1, 256);
            }

            gdImageDestroy(src);
        }
    }

    <span style="color: #729fcf; font-weight: bold;">if</span> (transparent != -1 &amp;&amp; colors) {
        gdImageColorTransparent(dst, gdImageColorExact(dst, red, green, blue));
    }

    <span style="color: #729fcf; font-weight: bold;">if</span> (conf-&gt;filter == NGX_HTTP_IMAGE_WATERMARK &amp;&amp; conf-&gt;watermark.data) {
        <span style="color: #8ae234; font-weight: bold;">FILE</span> *<span style="color: #eeeeec;">watermark_file</span> = fopen((<span style="color: #729fcf; font-weight: bold;">const</span> <span style="color: #8ae234; font-weight: bold;">char</span> *)conf-&gt;watermark.data, <span style="color: #ad7fa8; font-style: italic;">"r"</span>);
        <span style="color: #729fcf; font-weight: bold;">if</span> (watermark_file) {
            <span style="color: #8ae234; font-weight: bold;">gdImagePtr</span> <span style="color: #eeeeec;">watermark</span>, <span style="color: #eeeeec;">watermark_mix</span>;
            <span style="color: #8ae234; font-weight: bold;">ngx_int_t</span> <span style="color: #eeeeec;">wdx</span> = 0, <span style="color: #eeeeec;">wdy</span> = 0;
            
            watermark = gdImageCreateFromPng(watermark_file);
                
            <span style="color: #729fcf; font-weight: bold;">if</span>(watermark != <span style="color: #8ae234;">NULL</span>) {
                watermark_mix = gdImageCreateTrueColor(watermark-&gt;sx, watermark-&gt;sy);
                wdx = dx/2 - watermark-&gt;sx/2;
                wdy = dy/2 - watermark-&gt;sy/2;
                gdImageCopy(watermark_mix, dst, 0, 0, wdx, wdy, watermark-&gt;sx, watermark-&gt;sy);
                gdImageCopy(watermark_mix, watermark, 0, 0, 0, 0, watermark-&gt;sx, watermark-&gt;sy);
                gdImageCopyMerge(dst, watermark_mix, wdx, wdy, 0, 0, watermark-&gt;sx, watermark-&gt;sy, conf-&gt;watermark_transparency);
                gdFree(watermark);
                gdFree(watermark_mix);
            } <span style="color: #729fcf; font-weight: bold;">else</span> { ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;log, 0, <span style="color: #ad7fa8; font-style: italic;">"watermark file '%s' is not PNG"</span>, conf-&gt;watermark.data);}
        } <span style="color: #729fcf; font-weight: bold;">else</span> {
            ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;log, 0, <span style="color: #ad7fa8; font-style: italic;">"watermark file '%s' not found"</span>, conf-&gt;watermark.data);
        }
    }
    
    sharpen = ngx_http_image_filter_get_value(r, conf-&gt;shcv, conf-&gt;sharpen);
    <span style="color: #729fcf; font-weight: bold;">if</span> (sharpen &gt; 0) {
        gdImageSharpen(dst, sharpen);
    }

    out = ngx_http_image_out(r, ctx-&gt;type, dst, &amp;size);

    ngx_log_debug3(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;log, 0,
                   <span style="color: #ad7fa8; font-style: italic;">"image: %d x %d %d"</span>, sx, sy, colors);

    gdImageDestroy(dst);
    ngx_pfree(r-&gt;pool, ctx-&gt;image);

    <span style="color: #729fcf; font-weight: bold;">if</span> (out == <span style="color: #8ae234;">NULL</span>) {
        <span style="color: #729fcf; font-weight: bold;">return</span> <span style="color: #8ae234;">NULL</span>;
    }

    cln = ngx_pool_cleanup_add(r-&gt;pool, 0);
    <span style="color: #729fcf; font-weight: bold;">if</span> (cln == <span style="color: #8ae234;">NULL</span>) {
        gdFree(out);
        <span style="color: #729fcf; font-weight: bold;">return</span> <span style="color: #8ae234;">NULL</span>;
    }

    b = ngx_pcalloc(r-&gt;pool, <span style="color: #729fcf; font-weight: bold;">sizeof</span>(ngx_buf_t));
    <span style="color: #729fcf; font-weight: bold;">if</span> (b == <span style="color: #8ae234;">NULL</span>) {
        gdFree(out);
        <span style="color: #729fcf; font-weight: bold;">return</span> <span style="color: #8ae234;">NULL</span>;
    }

    cln-&gt;handler = ngx_http_image_cleanup;
    cln-&gt;data = out;

    b-&gt;pos = out;
    b-&gt;last = out + size;
    b-&gt;memory = 1;
    b-&gt;last_buf = 1;

    ngx_http_image_length(r, b);

    <span style="color: #729fcf; font-weight: bold;">return</span> b;
}


<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">gdImagePtr</span>
<span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_source</span>(<span style="color: #8ae234; font-weight: bold;">ngx_http_request_t</span> *<span style="color: #eeeeec;">r</span>, <span style="color: #8ae234; font-weight: bold;">ngx_http_image_filter_ctx_t</span> *<span style="color: #eeeeec;">ctx</span>)
{
    <span style="color: #8ae234; font-weight: bold;">char</span>        *<span style="color: #eeeeec;">failed</span>;
    <span style="color: #8ae234; font-weight: bold;">gdImagePtr</span>   <span style="color: #eeeeec;">img</span>;

    img = <span style="color: #8ae234;">NULL</span>;

    <span style="color: #729fcf; font-weight: bold;">switch</span> (ctx-&gt;type) {

    <span style="color: #729fcf; font-weight: bold;">case</span> NGX_HTTP_IMAGE_JPEG:
        img = gdImageCreateFromJpegPtr(ctx-&gt;length, ctx-&gt;image);
        failed = <span style="color: #ad7fa8; font-style: italic;">"gdImageCreateFromJpegPtr() failed"</span>;
        <span style="color: #729fcf; font-weight: bold;">break</span>;

    <span style="color: #729fcf; font-weight: bold;">case</span> NGX_HTTP_IMAGE_GIF:
        img = gdImageCreateFromGifPtr(ctx-&gt;length, ctx-&gt;image);
        failed = <span style="color: #ad7fa8; font-style: italic;">"gdImageCreateFromGifPtr() failed"</span>;
        <span style="color: #729fcf; font-weight: bold;">break</span>;

    <span style="color: #729fcf; font-weight: bold;">case</span> NGX_HTTP_IMAGE_PNG:
        img = gdImageCreateFromPngPtr(ctx-&gt;length, ctx-&gt;image);
        failed = <span style="color: #ad7fa8; font-style: italic;">"gdImageCreateFromPngPtr() failed"</span>;
        <span style="color: #729fcf; font-weight: bold;">break</span>;

    <span style="color: #729fcf; font-weight: bold;">default</span>:
        failed = <span style="color: #ad7fa8; font-style: italic;">"unknown image type"</span>;
        <span style="color: #729fcf; font-weight: bold;">break</span>;
    }

    <span style="color: #729fcf; font-weight: bold;">if</span> (img == <span style="color: #8ae234;">NULL</span>) {
        ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;log, 0, failed);
    }

    <span style="color: #729fcf; font-weight: bold;">return</span> img;
}


<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">gdImagePtr</span>
<span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_new</span>(<span style="color: #8ae234; font-weight: bold;">ngx_http_request_t</span> *<span style="color: #eeeeec;">r</span>, <span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #eeeeec;">w</span>, <span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #eeeeec;">h</span>, <span style="color: #8ae234; font-weight: bold;">int</span> <span style="color: #eeeeec;">colors</span>)
{
    <span style="color: #8ae234; font-weight: bold;">gdImagePtr</span>  <span style="color: #eeeeec;">img</span>;

    <span style="color: #729fcf; font-weight: bold;">if</span> (colors == 0) {
        img = gdImageCreateTrueColor(w, h);

        <span style="color: #729fcf; font-weight: bold;">if</span> (img == <span style="color: #8ae234;">NULL</span>) {
            ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;log, 0,
                          <span style="color: #ad7fa8; font-style: italic;">"gdImageCreateTrueColor() failed"</span>);
            <span style="color: #729fcf; font-weight: bold;">return</span> <span style="color: #8ae234;">NULL</span>;
        }

    } <span style="color: #729fcf; font-weight: bold;">else</span> {
        img = gdImageCreate(w, h);

        <span style="color: #729fcf; font-weight: bold;">if</span> (img == <span style="color: #8ae234;">NULL</span>) {
            ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;log, 0,
                          <span style="color: #ad7fa8; font-style: italic;">"gdImageCreate() failed"</span>);
            <span style="color: #729fcf; font-weight: bold;">return</span> <span style="color: #8ae234;">NULL</span>;
        }
    }

    <span style="color: #729fcf; font-weight: bold;">return</span> img;
}


<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">u_char</span> *
<span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_out</span>(<span style="color: #8ae234; font-weight: bold;">ngx_http_request_t</span> *<span style="color: #eeeeec;">r</span>, <span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span> <span style="color: #eeeeec;">type</span>, <span style="color: #8ae234; font-weight: bold;">gdImagePtr</span> <span style="color: #eeeeec;">img</span>,
    <span style="color: #8ae234; font-weight: bold;">int</span> *<span style="color: #eeeeec;">size</span>)
{
    <span style="color: #8ae234; font-weight: bold;">char</span>                          *<span style="color: #eeeeec;">failed</span>;
    <span style="color: #8ae234; font-weight: bold;">u_char</span>                        *<span style="color: #eeeeec;">out</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_int_t</span>                      <span style="color: #eeeeec;">jq</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_http_image_filter_conf_t</span>  *<span style="color: #eeeeec;">conf</span>;

    out = <span style="color: #8ae234;">NULL</span>;

    <span style="color: #729fcf; font-weight: bold;">switch</span> (type) {

    <span style="color: #729fcf; font-weight: bold;">case</span> NGX_HTTP_IMAGE_JPEG:
        conf = ngx_http_get_module_loc_conf(r, ngx_http_image_filter_module);

        jq = ngx_http_image_filter_get_value(r, conf-&gt;jqcv, conf-&gt;jpeg_quality);
        <span style="color: #729fcf; font-weight: bold;">if</span> (jq &lt;= 0) {
            <span style="color: #729fcf; font-weight: bold;">return</span> <span style="color: #8ae234;">NULL</span>;
        }

        out = gdImageJpegPtr(img, size, jq);
        failed = <span style="color: #ad7fa8; font-style: italic;">"gdImageJpegPtr() failed"</span>;
        <span style="color: #729fcf; font-weight: bold;">break</span>;

    <span style="color: #729fcf; font-weight: bold;">case</span> NGX_HTTP_IMAGE_GIF:
        out = gdImageGifPtr(img, size);
        failed = <span style="color: #ad7fa8; font-style: italic;">"gdImageGifPtr() failed"</span>;
        <span style="color: #729fcf; font-weight: bold;">break</span>;

    <span style="color: #729fcf; font-weight: bold;">case</span> NGX_HTTP_IMAGE_PNG:
        out = gdImagePngPtr(img, size);
        failed = <span style="color: #ad7fa8; font-style: italic;">"gdImagePngPtr() failed"</span>;
        <span style="color: #729fcf; font-weight: bold;">break</span>;

    <span style="color: #729fcf; font-weight: bold;">default</span>:
        failed = <span style="color: #ad7fa8; font-style: italic;">"unknown image type"</span>;
        <span style="color: #729fcf; font-weight: bold;">break</span>;
    }

    <span style="color: #729fcf; font-weight: bold;">if</span> (out == <span style="color: #8ae234;">NULL</span>) {
        ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;log, 0, failed);
    }

    <span style="color: #729fcf; font-weight: bold;">return</span> out;
}


<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">void</span>
<span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_cleanup</span>(<span style="color: #8ae234; font-weight: bold;">void</span> *<span style="color: #eeeeec;">data</span>)
{
    gdFree(data);
}


<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span>
<span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_filter_get_value</span>(<span style="color: #8ae234; font-weight: bold;">ngx_http_request_t</span> *<span style="color: #eeeeec;">r</span>,
    <span style="color: #8ae234; font-weight: bold;">ngx_http_complex_value_t</span> *<span style="color: #eeeeec;">cv</span>, <span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span> <span style="color: #eeeeec;">v</span>)
{
    <span style="color: #8ae234; font-weight: bold;">ngx_str_t</span>  <span style="color: #eeeeec;">val</span>;

    <span style="color: #729fcf; font-weight: bold;">if</span> (cv == <span style="color: #8ae234;">NULL</span>) {
        <span style="color: #729fcf; font-weight: bold;">return</span> v;
    }

    <span style="color: #729fcf; font-weight: bold;">if</span> (ngx_http_complex_value(r, cv, &amp;val) != NGX_OK) {
        <span style="color: #729fcf; font-weight: bold;">return</span> 0;
    }

    <span style="color: #729fcf; font-weight: bold;">return</span> ngx_http_image_filter_value(&amp;val);
}


<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span>
<span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_filter_value</span>(<span style="color: #8ae234; font-weight: bold;">ngx_str_t</span> *<span style="color: #eeeeec;">value</span>)
{
    <span style="color: #8ae234; font-weight: bold;">ngx_int_t</span>  <span style="color: #eeeeec;">n</span>;

    <span style="color: #729fcf; font-weight: bold;">if</span> (value-&gt;len == 1 &amp;&amp; value-&gt;data[0] == <span style="color: #ad7fa8; font-style: italic;">'-'</span>) {
        <span style="color: #729fcf; font-weight: bold;">return</span> (<span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span>) -1;
    }

    n = ngx_atoi(value-&gt;data, value-&gt;len);

    <span style="color: #729fcf; font-weight: bold;">if</span> (n &gt; 0) {
        <span style="color: #729fcf; font-weight: bold;">return</span> (<span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span>) n;
    }

    <span style="color: #729fcf; font-weight: bold;">return</span> 0;
}


<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">void</span> *
<span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_filter_create_conf</span>(<span style="color: #8ae234; font-weight: bold;">ngx_conf_t</span> *<span style="color: #eeeeec;">cf</span>)
{
    <span style="color: #8ae234; font-weight: bold;">ngx_http_image_filter_conf_t</span>  *<span style="color: #eeeeec;">conf</span>;

    conf = ngx_pcalloc(cf-&gt;pool, <span style="color: #729fcf; font-weight: bold;">sizeof</span>(ngx_http_image_filter_conf_t));
    <span style="color: #729fcf; font-weight: bold;">if</span> (conf == <span style="color: #8ae234;">NULL</span>) {
        <span style="color: #729fcf; font-weight: bold;">return</span> <span style="color: #8ae234;">NULL</span>;
    }

    <span style="color: #888a85;">/*</span><span style="color: #888a85;">
     * set by ngx_pcalloc():
     *
     *     conf-&gt;width = 0;
     *     conf-&gt;height = 0;
     *     conf-&gt;angle = 0;
     *     conf-&gt;wcv = NULL;
     *     conf-&gt;hcv = NULL;
     *     conf-&gt;acv = NULL;
     *     conf-&gt;jqcv = NULL;
     *     conf-&gt;shcv = NULL;
     </span><span style="color: #888a85;">*/</span>

    conf-&gt;filter = NGX_CONF_UNSET_UINT;
    conf-&gt;jpeg_quality = NGX_CONF_UNSET_UINT;
    conf-&gt;sharpen = NGX_CONF_UNSET_UINT;
    conf-&gt;transparency = NGX_CONF_UNSET;
    conf-&gt;buffer_size = NGX_CONF_UNSET_SIZE;
    conf-&gt;watermark_transparency = NGX_CONF_UNSET_UINT;

    <span style="color: #729fcf; font-weight: bold;">return</span> conf;
}


<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">char</span> *
<span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_filter_merge_conf</span>(<span style="color: #8ae234; font-weight: bold;">ngx_conf_t</span> *<span style="color: #eeeeec;">cf</span>, <span style="color: #8ae234; font-weight: bold;">void</span> *<span style="color: #eeeeec;">parent</span>, <span style="color: #8ae234; font-weight: bold;">void</span> *<span style="color: #eeeeec;">child</span>)
{
    <span style="color: #8ae234; font-weight: bold;">ngx_http_image_filter_conf_t</span> *<span style="color: #eeeeec;">prev</span> = parent;
    <span style="color: #8ae234; font-weight: bold;">ngx_http_image_filter_conf_t</span> *<span style="color: #eeeeec;">conf</span> = child;

    <span style="color: #729fcf; font-weight: bold;">if</span> (conf-&gt;filter == NGX_CONF_UNSET_UINT) {

        <span style="color: #729fcf; font-weight: bold;">if</span> (prev-&gt;filter == NGX_CONF_UNSET_UINT) {
            conf-&gt;filter = NGX_HTTP_IMAGE_OFF;

        } <span style="color: #729fcf; font-weight: bold;">else</span> {
            conf-&gt;filter = prev-&gt;filter;
            conf-&gt;width = prev-&gt;width;
            conf-&gt;height = prev-&gt;height;
            conf-&gt;angle = prev-&gt;angle;
            conf-&gt;wcv = prev-&gt;wcv;
            conf-&gt;hcv = prev-&gt;hcv;
            conf-&gt;acv = prev-&gt;acv;
        }
    }

    <span style="color: #729fcf; font-weight: bold;">if</span> (conf-&gt;jpeg_quality == NGX_CONF_UNSET_UINT) {

        <span style="color: #888a85;">/* </span><span style="color: #888a85;">75 is libjpeg default quality </span><span style="color: #888a85;">*/</span>
        ngx_conf_merge_uint_value(conf-&gt;jpeg_quality, prev-&gt;jpeg_quality, 75);

        <span style="color: #729fcf; font-weight: bold;">if</span> (conf-&gt;jqcv == <span style="color: #8ae234;">NULL</span>) {
            conf-&gt;jqcv = prev-&gt;jqcv;
        }
    }

    <span style="color: #729fcf; font-weight: bold;">if</span> (conf-&gt;sharpen == NGX_CONF_UNSET_UINT) {
        ngx_conf_merge_uint_value(conf-&gt;sharpen, prev-&gt;sharpen, 0);

        <span style="color: #729fcf; font-weight: bold;">if</span> (conf-&gt;shcv == <span style="color: #8ae234;">NULL</span>) {
            conf-&gt;shcv = prev-&gt;shcv;
        }
    }

    ngx_conf_merge_value(conf-&gt;transparency, prev-&gt;transparency, 1);

    ngx_conf_merge_size_value(conf-&gt;buffer_size, prev-&gt;buffer_size,
                              1 * 1024 * 1024);

    ngx_conf_merge_str_value(conf-&gt;watermark, prev-&gt;watermark, <span style="color: #ad7fa8; font-style: italic;">""</span>);

    ngx_conf_merge_uint_value(conf-&gt;watermark_transparency,
                              prev-&gt;watermark_transparency, 90);
    
    <span style="color: #729fcf; font-weight: bold;">return</span> NGX_CONF_OK;
}


<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">char</span> *
<span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_filter</span>(<span style="color: #8ae234; font-weight: bold;">ngx_conf_t</span> *<span style="color: #eeeeec;">cf</span>, <span style="color: #8ae234; font-weight: bold;">ngx_command_t</span> *<span style="color: #eeeeec;">cmd</span>, <span style="color: #8ae234; font-weight: bold;">void</span> *<span style="color: #eeeeec;">conf</span>)
{
    <span style="color: #8ae234; font-weight: bold;">ngx_http_image_filter_conf_t</span> *<span style="color: #eeeeec;">imcf</span> = conf;

    <span style="color: #8ae234; font-weight: bold;">ngx_str_t</span>                         *<span style="color: #eeeeec;">value</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_int_t</span>                          <span style="color: #eeeeec;">n</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span>                         <span style="color: #eeeeec;">i</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_http_complex_value_t</span>           <span style="color: #eeeeec;">cv</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_http_compile_complex_value_t</span>   <span style="color: #eeeeec;">ccv</span>;

    value = cf-&gt;args-&gt;elts;

    i = 1;

    <span style="color: #729fcf; font-weight: bold;">if</span> (cf-&gt;args-&gt;nelts == 2) {
        <span style="color: #729fcf; font-weight: bold;">if</span> (ngx_strcmp(value[i].data, <span style="color: #ad7fa8; font-style: italic;">"off"</span>) == 0) {
            imcf-&gt;filter = NGX_HTTP_IMAGE_OFF;

        } <span style="color: #729fcf; font-weight: bold;">else</span> <span style="color: #729fcf; font-weight: bold;">if</span> (ngx_strcmp(value[i].data, <span style="color: #ad7fa8; font-style: italic;">"test"</span>) == 0) {
            imcf-&gt;filter = NGX_HTTP_IMAGE_TEST;

        } <span style="color: #729fcf; font-weight: bold;">else</span> <span style="color: #729fcf; font-weight: bold;">if</span> (ngx_strcmp(value[i].data, <span style="color: #ad7fa8; font-style: italic;">"size"</span>) == 0) {
            imcf-&gt;filter = NGX_HTTP_IMAGE_SIZE;

        } <span style="color: #729fcf; font-weight: bold;">else</span> <span style="color: #729fcf; font-weight: bold;">if</span> (ngx_strcmp(value[i].data, <span style="color: #ad7fa8; font-style: italic;">"watermark"</span>) == 0) {
            imcf-&gt;filter = NGX_HTTP_IMAGE_WATERMARK;
            
        } <span style="color: #729fcf; font-weight: bold;">else</span> {
            <span style="color: #729fcf; font-weight: bold;">goto</span> <span style="color: #8ae234;">failed</span>;
        }

        <span style="color: #729fcf; font-weight: bold;">return</span> NGX_CONF_OK;

    } <span style="color: #729fcf; font-weight: bold;">else</span> <span style="color: #729fcf; font-weight: bold;">if</span> (cf-&gt;args-&gt;nelts == 3) {

        <span style="color: #729fcf; font-weight: bold;">if</span> (ngx_strcmp(value[i].data, <span style="color: #ad7fa8; font-style: italic;">"rotate"</span>) == 0) {
            <span style="color: #729fcf; font-weight: bold;">if</span> (imcf-&gt;filter != NGX_HTTP_IMAGE_RESIZE
                &amp;&amp; imcf-&gt;filter != NGX_HTTP_IMAGE_CROP)
            {
                imcf-&gt;filter = NGX_HTTP_IMAGE_ROTATE;
            }

            ngx_memzero(&amp;ccv, <span style="color: #729fcf; font-weight: bold;">sizeof</span>(ngx_http_compile_complex_value_t));

            ccv.cf = cf;
            ccv.value = &amp;value[++i];
            ccv.complex_value = &amp;cv;

            <span style="color: #729fcf; font-weight: bold;">if</span> (ngx_http_compile_complex_value(&amp;ccv) != NGX_OK) {
                <span style="color: #729fcf; font-weight: bold;">return</span> NGX_CONF_ERROR;
            }

            <span style="color: #729fcf; font-weight: bold;">if</span> (cv.lengths == <span style="color: #8ae234;">NULL</span>) {
                n = ngx_http_image_filter_value(&amp;value[i]);

                <span style="color: #729fcf; font-weight: bold;">if</span> (n != 90 &amp;&amp; n != 180 &amp;&amp; n != 270) {
                    <span style="color: #729fcf; font-weight: bold;">goto</span> <span style="color: #8ae234;">failed</span>;
                }

                imcf-&gt;angle = (<span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span>) n;

            } <span style="color: #729fcf; font-weight: bold;">else</span> {
                imcf-&gt;acv = ngx_palloc(cf-&gt;pool,
                                       <span style="color: #729fcf; font-weight: bold;">sizeof</span>(ngx_http_complex_value_t));
                <span style="color: #729fcf; font-weight: bold;">if</span> (imcf-&gt;acv == <span style="color: #8ae234;">NULL</span>) {
                    <span style="color: #729fcf; font-weight: bold;">return</span> NGX_CONF_ERROR;
                }

                *imcf-&gt;acv = cv;
            }

            <span style="color: #729fcf; font-weight: bold;">return</span> NGX_CONF_OK;

        } <span style="color: #729fcf; font-weight: bold;">else</span> {
            <span style="color: #729fcf; font-weight: bold;">goto</span> <span style="color: #8ae234;">failed</span>;
        }
    }

    <span style="color: #729fcf; font-weight: bold;">if</span> (ngx_strcmp(value[i].data, <span style="color: #ad7fa8; font-style: italic;">"resize"</span>) == 0) {
        imcf-&gt;filter = NGX_HTTP_IMAGE_RESIZE;

    } <span style="color: #729fcf; font-weight: bold;">else</span> <span style="color: #729fcf; font-weight: bold;">if</span> (ngx_strcmp(value[i].data, <span style="color: #ad7fa8; font-style: italic;">"crop"</span>) == 0) {
        imcf-&gt;filter = NGX_HTTP_IMAGE_CROP;

    } <span style="color: #729fcf; font-weight: bold;">else</span> {
        <span style="color: #729fcf; font-weight: bold;">goto</span> <span style="color: #8ae234;">failed</span>;
    }

    ngx_memzero(&amp;ccv, <span style="color: #729fcf; font-weight: bold;">sizeof</span>(ngx_http_compile_complex_value_t));

    ccv.cf = cf;
    ccv.value = &amp;value[++i];
    ccv.complex_value = &amp;cv;

    <span style="color: #729fcf; font-weight: bold;">if</span> (ngx_http_compile_complex_value(&amp;ccv) != NGX_OK) {
        <span style="color: #729fcf; font-weight: bold;">return</span> NGX_CONF_ERROR;
    }

    <span style="color: #729fcf; font-weight: bold;">if</span> (cv.lengths == <span style="color: #8ae234;">NULL</span>) {
        n = ngx_http_image_filter_value(&amp;value[i]);

        <span style="color: #729fcf; font-weight: bold;">if</span> (n == 0) {
            <span style="color: #729fcf; font-weight: bold;">goto</span> <span style="color: #8ae234;">failed</span>;
        }

        imcf-&gt;width = (<span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span>) n;

    } <span style="color: #729fcf; font-weight: bold;">else</span> {
        imcf-&gt;wcv = ngx_palloc(cf-&gt;pool, <span style="color: #729fcf; font-weight: bold;">sizeof</span>(ngx_http_complex_value_t));
        <span style="color: #729fcf; font-weight: bold;">if</span> (imcf-&gt;wcv == <span style="color: #8ae234;">NULL</span>) {
            <span style="color: #729fcf; font-weight: bold;">return</span> NGX_CONF_ERROR;
        }

        *imcf-&gt;wcv = cv;
    }

    ngx_memzero(&amp;ccv, <span style="color: #729fcf; font-weight: bold;">sizeof</span>(ngx_http_compile_complex_value_t));

    ccv.cf = cf;
    ccv.value = &amp;value[++i];
    ccv.complex_value = &amp;cv;

    <span style="color: #729fcf; font-weight: bold;">if</span> (ngx_http_compile_complex_value(&amp;ccv) != NGX_OK) {
        <span style="color: #729fcf; font-weight: bold;">return</span> NGX_CONF_ERROR;
    }

    <span style="color: #729fcf; font-weight: bold;">if</span> (cv.lengths == <span style="color: #8ae234;">NULL</span>) {
        n = ngx_http_image_filter_value(&amp;value[i]);

        <span style="color: #729fcf; font-weight: bold;">if</span> (n == 0) {
            <span style="color: #729fcf; font-weight: bold;">goto</span> <span style="color: #8ae234;">failed</span>;
        }

        imcf-&gt;height = (<span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span>) n;

    } <span style="color: #729fcf; font-weight: bold;">else</span> {
        imcf-&gt;hcv = ngx_palloc(cf-&gt;pool, <span style="color: #729fcf; font-weight: bold;">sizeof</span>(ngx_http_complex_value_t));
        <span style="color: #729fcf; font-weight: bold;">if</span> (imcf-&gt;hcv == <span style="color: #8ae234;">NULL</span>) {
            <span style="color: #729fcf; font-weight: bold;">return</span> NGX_CONF_ERROR;
        }

        *imcf-&gt;hcv = cv;
    }

    <span style="color: #729fcf; font-weight: bold;">return</span> NGX_CONF_OK;

<span style="color: #8ae234;">failed</span>:

    ngx_conf_log_error(NGX_LOG_EMERG, cf, 0, <span style="color: #ad7fa8; font-style: italic;">"invalid parameter \"%V\""</span>,
                       &amp;value[i]);

    <span style="color: #729fcf; font-weight: bold;">return</span> NGX_CONF_ERROR;
}


<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">char</span> *
<span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_filter_jpeg_quality</span>(<span style="color: #8ae234; font-weight: bold;">ngx_conf_t</span> *<span style="color: #eeeeec;">cf</span>, <span style="color: #8ae234; font-weight: bold;">ngx_command_t</span> *<span style="color: #eeeeec;">cmd</span>,
    <span style="color: #8ae234; font-weight: bold;">void</span> *<span style="color: #eeeeec;">conf</span>)
{
    <span style="color: #8ae234; font-weight: bold;">ngx_http_image_filter_conf_t</span> *<span style="color: #eeeeec;">imcf</span> = conf;

    <span style="color: #8ae234; font-weight: bold;">ngx_str_t</span>                         *<span style="color: #eeeeec;">value</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_int_t</span>                          <span style="color: #eeeeec;">n</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_http_complex_value_t</span>           <span style="color: #eeeeec;">cv</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_http_compile_complex_value_t</span>   <span style="color: #eeeeec;">ccv</span>;

    value = cf-&gt;args-&gt;elts;

    ngx_memzero(&amp;ccv, <span style="color: #729fcf; font-weight: bold;">sizeof</span>(ngx_http_compile_complex_value_t));

    ccv.cf = cf;
    ccv.value = &amp;value[1];
    ccv.complex_value = &amp;cv;

    <span style="color: #729fcf; font-weight: bold;">if</span> (ngx_http_compile_complex_value(&amp;ccv) != NGX_OK) {
        <span style="color: #729fcf; font-weight: bold;">return</span> NGX_CONF_ERROR;
    }

    <span style="color: #729fcf; font-weight: bold;">if</span> (cv.lengths == <span style="color: #8ae234;">NULL</span>) {
        n = ngx_http_image_filter_value(&amp;value[1]);

        <span style="color: #729fcf; font-weight: bold;">if</span> (n &lt;= 0) {
            ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,
                               <span style="color: #ad7fa8; font-style: italic;">"invalid value \"%V\""</span>, &amp;value[1]);
            <span style="color: #729fcf; font-weight: bold;">return</span> NGX_CONF_ERROR;
        }

        imcf-&gt;jpeg_quality = (<span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span>) n;

    } <span style="color: #729fcf; font-weight: bold;">else</span> {
        imcf-&gt;jqcv = ngx_palloc(cf-&gt;pool, <span style="color: #729fcf; font-weight: bold;">sizeof</span>(ngx_http_complex_value_t));
        <span style="color: #729fcf; font-weight: bold;">if</span> (imcf-&gt;jqcv == <span style="color: #8ae234;">NULL</span>) {
            <span style="color: #729fcf; font-weight: bold;">return</span> NGX_CONF_ERROR;
        }

        *imcf-&gt;jqcv = cv;
    }

    <span style="color: #729fcf; font-weight: bold;">return</span> NGX_CONF_OK;
}


<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">char</span> *
<span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_filter_sharpen</span>(<span style="color: #8ae234; font-weight: bold;">ngx_conf_t</span> *<span style="color: #eeeeec;">cf</span>, <span style="color: #8ae234; font-weight: bold;">ngx_command_t</span> *<span style="color: #eeeeec;">cmd</span>,
    <span style="color: #8ae234; font-weight: bold;">void</span> *<span style="color: #eeeeec;">conf</span>)
{
    <span style="color: #8ae234; font-weight: bold;">ngx_http_image_filter_conf_t</span> *<span style="color: #eeeeec;">imcf</span> = conf;

    <span style="color: #8ae234; font-weight: bold;">ngx_str_t</span>                         *<span style="color: #eeeeec;">value</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_int_t</span>                          <span style="color: #eeeeec;">n</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_http_complex_value_t</span>           <span style="color: #eeeeec;">cv</span>;
    <span style="color: #8ae234; font-weight: bold;">ngx_http_compile_complex_value_t</span>   <span style="color: #eeeeec;">ccv</span>;

    value = cf-&gt;args-&gt;elts;

    ngx_memzero(&amp;ccv, <span style="color: #729fcf; font-weight: bold;">sizeof</span>(ngx_http_compile_complex_value_t));

    ccv.cf = cf;
    ccv.value = &amp;value[1];
    ccv.complex_value = &amp;cv;

    <span style="color: #729fcf; font-weight: bold;">if</span> (ngx_http_compile_complex_value(&amp;ccv) != NGX_OK) {
        <span style="color: #729fcf; font-weight: bold;">return</span> NGX_CONF_ERROR;
    }

    <span style="color: #729fcf; font-weight: bold;">if</span> (cv.lengths == <span style="color: #8ae234;">NULL</span>) {
        n = ngx_http_image_filter_value(&amp;value[1]);

        <span style="color: #729fcf; font-weight: bold;">if</span> (n &lt; 0) {
            ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,
                               <span style="color: #ad7fa8; font-style: italic;">"invalid value \"%V\""</span>, &amp;value[1]);
            <span style="color: #729fcf; font-weight: bold;">return</span> NGX_CONF_ERROR;
        }

        imcf-&gt;sharpen = (<span style="color: #8ae234; font-weight: bold;">ngx_uint_t</span>) n;

    } <span style="color: #729fcf; font-weight: bold;">else</span> {
        imcf-&gt;shcv = ngx_palloc(cf-&gt;pool, <span style="color: #729fcf; font-weight: bold;">sizeof</span>(ngx_http_complex_value_t));
        <span style="color: #729fcf; font-weight: bold;">if</span> (imcf-&gt;shcv == <span style="color: #8ae234;">NULL</span>) {
            <span style="color: #729fcf; font-weight: bold;">return</span> NGX_CONF_ERROR;
        }

        *imcf-&gt;shcv = cv;
    }

    <span style="color: #729fcf; font-weight: bold;">return</span> NGX_CONF_OK;
}


<span style="color: #729fcf; font-weight: bold;">static</span> <span style="color: #8ae234; font-weight: bold;">ngx_int_t</span>
<span style="color: #edd400; font-weight: bold; font-style: italic;">ngx_http_image_filter_init</span>(<span style="color: #8ae234; font-weight: bold;">ngx_conf_t</span> *<span style="color: #eeeeec;">cf</span>)
{
    ngx_http_next_header_filter = ngx_http_top_header_filter;
    ngx_http_top_header_filter = ngx_http_image_header_filter;

    ngx_http_next_body_filter = ngx_http_top_body_filter;
    ngx_http_top_body_filter = ngx_http_image_body_filter;

    <span style="color: #729fcf; font-weight: bold;">return</span> NGX_OK;
}
</pre></div></div>


</div>

</div>

<div id="outline-container-3-3" class="outline-4">
<h4 id="sec-3-3">编译</h4>
<div class="outline-text-4" id="text-3-3">




<pre class="src src-sh">--with-debug --with-http_image_filter_module --add-module=/home/tangxinfa/Opensource/nginx-1.2.7/../ngx_http_qrcode_module/ --add-module=/home/tangxinfa/Opensource/nginx-1.2.7/../ngx_devel_kit/ --add-module=/home/tangxinfa/Opensource/nginx-1.2.7/../set-misc-nginx-module/ --add-module=/home/tangxinfa/Opensource/nginx-1.2.7/../echo-nginx-module/
</pre>


</div>

</div>

<div id="outline-container-3-4" class="outline-4">
<h4 id="sec-3-4">配置</h4>
<div class="outline-text-4" id="text-3-4">




<pre class="example">location ~ /qr {
    qrcode_fg_color FF0000;
    qrcode_bg_color FFFFFF;    
    qrcode_level 2;
    qrcode_hint 2;
    qrcode_size 120;
    qrcode_margin 2;
    qrcode_version 5;
    set_unescape_uri $txt $arg_txt;
    qrcode_txt $txt;
    qrcode_casesensitive 1; 
    qrcode_gen;  

    image_filter_watermark "/usr/share/pixmaps/gnome-word.png";
    image_filter_watermark_transparency 95; #0-100
    image_filter watermark;
}
</pre>


</div>

</div>

<div id="outline-container-3-5" class="outline-4">
<h4 id="sec-3-5">访问</h4>
<div class="outline-text-4" id="text-3-5">




<pre class="example">http://localhost:8080/qr?txt=hello
</pre>

<ul>
<li>显示效果：
</li>
</ul>

<p>     <img src="../../../posts/2013/03/30_4e8c7ef4780178147a76/hello_qr.png"  alt="../../../posts/2013/03/30_4e8c7ef4780178147a76/hello_qr.png" />
</p>
</div>
</div>

</div>

<div id="outline-container-4" class="outline-3">
<h3 id="sec-4">二维码基础服务的一点思索</h3>
<div class="outline-text-3" id="text-4">

<ul>
<li>必须建立在cdn的基础上
</li>
<li>用户只需按照约定将内容以及定制参数按照直观的方式编码成二维码图片链接即可
</li>
</ul>


<p>
   参考：<a href="https://developers.google.com/chart/infographics/docs/qr_codes">https://developers.google.com/chart/infographics/docs/qr_codes</a>
</p></div>
</div>

  </div>
  
  <footer class="article-footer">
    <nav class="tag-cloud">
      <ul>
	<li class="label label-inverse small"><a href="../../../tags/qrcode.html">qrcode</a></li>
      </ul>
    </nav>
    <span class="muted">
      发布于 <time datetime="2013-03-30T11:21:00Z"> 2013-03-30 11:21</time>
    </span>
  </footer>
  </div>
  <div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'kankananblog'; // required: replace example with your forum shortname
  var disqus_url = 'http://blog.kankanan.com/posts/2013/03/30_4e8c7ef4780178147a76.html';

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

      </div>
      <div id="sidebar" class="span3">
        <h5>最新文章</h5>
        <div id="recent-posts">
          <ul>
            <li><a href="../../../posts/2014/03/10_5f006e90987976ee7ba174067cfb7edfff1atrac.html">开源项目管理系统：trac</a></li> <li><a href="../../../index.html">python应用国际化：Babel</a></li> <li><a href="../../../posts/2014/03/07_centos-62e44e0b5b8988c5redmine.html">CentOS 6.4下安装redmine</a></li> <li><a href="../../../posts/2014/02/17_7f168bd15b8988c5redis.html">编译安装redis</a></li> <li><a href="../../../posts/2014/02/17_7f168bd15b8988c5node2ejs.html">编译安装node.js</a></li> <li><a href="../../../posts/2014/02/14_express2ejs4e2d59824f5557287b2c4e006b218bf76c42768454cd5e944e2d53d65f97connect2esid.html">express.js中如何在第一次请求的响应中取得connect.sid</a></li> <li><a href="../../../posts/2013/12/26_linux4e0b51418bb8666e901a752862376267884c97008981root674396507684547d4ee4.html">linux下允许普通用户执行需要root权限的命令</a></li> <li><a href="../../../posts/2013/12/20_4e3a4ec04e484e0d80fd57286784902051fd65704e2d8c037528shared5ffrom5fthis.html">为什么不能在构造函数中调用shared_from_this</a></li> <li><a href="../../../posts/2013/12/20_discuz8bbf95ee63a85e7f4efb52a153cd4f5c5f0a.html">Discuz访问推广任务反作弊</a></li> <li><a href="../../../posts/2013/10/11_node2ejs4e0b8bbf95eemysql6ce8610f4e8b9879.html">node.js下访问mysql注意事项</a></li> 
          </ul>
        </div>
	    <h5>标签</h5>
        <div id="tags">
	      <ul>
  <li style="font-size: 185.00%;"><a href="../../../tags/archlinux.html">archlinux</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/babel.html">babel</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/bitbucket.html">bitbucket</a></li> <li style="font-size: 115.00%;"><a href="../../../tags/c.html">c</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/chosen.html">chosen</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/comet.html">comet</a></li> <li style="font-size: 115.00%;"><a href="../../../tags/cpp.html">cpp</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/discuz.html">discuz</a></li> <li style="font-size: 115.00%;"><a href="../../../tags/emacs.html">emacs</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/english.html">english</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/fcitx.html">fcitx</a></li> <li style="font-size: 115.00%;"><a href="../../../tags/hash.html">hash</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/hg.html">hg</a></li> <li style="font-size: 115.00%;"><a href="../../../tags/http.html">http</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/jabber.html">jabber</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/jquery.html">jquery</a></li> <li style="font-size: 220.00%;"><a href="../../../tags/linux.html">linux</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/log4cxx.html">log4cxx</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/log4php.html">log4php</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/memcached.html">memcached</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/mongodb.html">mongodb</a></li> <li style="font-size: 150.00%;"><a href="../../../tags/mysql.html">mysql</a></li> <li style="font-size: 150.00%;"><a href="../../../tags/nginx.html">nginx</a></li> <li style="font-size: 185.00%;"><a href="../../../tags/node.html">node</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/o-blog.html">o-blog</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/openssl.html">openssl</a></li> <li style="font-size: 185.00%;"><a href="../../../tags/php.html">php</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/pomodoro.html">pomodoro</a></li> <li style="font-size: 220.00%;"><a href="../../../tags/python.html">python</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/qrcode.html">qrcode</a></li> <li style="font-size: 220.00%;"><a href="../../../tags/redis.html">redis</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/redmine.html">redmine</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/spdy.html">spdy</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/trac.html">trac</a></li> <li style="font-size: 150.00%;"><a href="../../../tags/web.html">web</a></li> 
</ul>

        </div>
        <h5>最新评论</h5>
        <div id="recent-comments">
          <script src="http://kankananblog.disqus.com/recent_comments_widget.js?num_items=5&hide_avatars=0&avatar_size=32&excerpt_length=100" type="text/javascript"></script>
        </div>
      </div>
    </div>
  </div>
  <div id="footer">
	<div class="copyright" style="text-align: center;">
	  <p>
版权所有 © 2011-2013 看看俺 – KanKanAn.com
</p>
	  <p>Powered by <a href="https://github.com/renard/o-blog">o-blog</a>.</p>
	</div>
  </div>
</body>
</html>

