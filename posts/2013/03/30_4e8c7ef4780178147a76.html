<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8"/>
    <title>二维码研究 | 看看俺 - KanKanAn.com</title>
    <link rel="shortcut icon" href="/static/favicon.ico" />
    <link rel="stylesheet" type="text/less" href="../../../style/less/o-blog.less"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="generator" content="o-blog"/>
    <script src="../../../style/js/less-1.3.0.min.js" type="text/javascript"></script>
    <script src="../../../style/js/jquery-1.7.1.min.js" type="text/javascript"></script>
    <script src="../../../style/bootstrap/js/bootstrap-modal.js" type="text/javascript"></script>
    <script src="../../../style/bootstrap/js/bootstrap-transition.js" type="text/javascript"></script>
    <script src="../../../style/bootstrap/js/bootstrap-dropdown.js" type="text/javascript"></script>
    <script src="../../../style/bootstrap/js/bootstrap-collapse.js" type="text/javascript"></script>
    <script src="../../../style/js/prettify.js" type="text/javascript"></script>
    <script src="../../../style/js/o-blog.linenumber.js" type="text/javascript"></script>
    <script src="../../../style/js/o-blog-fix.js" type="text/javascript"></script>
    
    
  </head>
  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
	<div class="container">
	  <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
	  <a class="brand" href="../../../index.html">看看俺 - KanKanAn.com</a>
	  <div class="nav-collapse collapse">
	    <ul>
<li><a href="../../../archives.html"><i>icon-list icon-white</i> 归档</a>

</li>
<li><a href="../../../tags.html"><i>icon-tags icon-white</i> 标签</a>

</li>
<li><a href="../../../index.xml"><i>icon-rss icon-white</i> 订阅</a>
</li>
</ul>



	  </div>
	</div>
      </div>
    </div>
    <div class="container container-fluid" style="padding-top: 60px;">
      <div class="row-fluid">
        <div id="page" class="span9">

  <div class="article">
  <header class="article-header">

    <div class="page-header">
      <div class="row">
	<div class="date span1">
	  <div class=" date-d">30</div>
	  <div class=" date-m"><a href="../../../posts/2013/03/index.html">3月</a></div>
	  <div class=" date-y"><a href="../../../posts/2013/index.html">2013</a>
	  </div>
	</div>
	<div class="span1">
	  <div class="qr-code">
  <img style="min-width:90px; min-height:90px; max-width:90px; max-height:90px;" src="http://chart.apis.google.com/chart?chs=90x90&cht=qr&chld=|0&chl=http%3A%2F%2Fblog.kankanan.com%2Fposts%2F2013%2F03%2F30_4e8c7ef4780178147a76.html"
       alt="qr-code" />
</div>

	</div>
	<h1 class="offset3">二维码研究</h1>
      </div>
      <nav>
	<ul class="pager">
	  <li class="previous"><a href="../../../posts/2013/03/27_archlinux4e0b5b8988c5cups625353707cfb7edf.html"><i class="icon-chevron-left"></i>&nbsp;Archlinux下安装cups打印系统</a></li><li class="next" style="text-align: right;"><a href="../../../posts/2013/03/30_5728emacs4e2d59824f554ee5root674396504f7f7528gdb8c038bd57a0b5e8f.html">在emacs中如何以root权限使用gdb调试程序&nbsp;<i class="icon-chevron-right"></i></a></li>
	</ul>
      </nav>
    </div>

  </header>
  <div class="article-content">
    <div id="outline-container-1" class="outline-3">
<h3 id="sec-1">介绍</h3>
<div class="outline-text-3" id="text-1">

<dl>
<dt><a href="http://www.itsc.org.sg/pdf/synthesis08/Three_QR_Code.pdf">Three_QR_Code.pdf</a></dt><dd>
<p>
     RFC式的文档
</p>
</dd>
<dt><a href="http://suflow.iteye.com/blog/1100678">二维码 编码原理简介</a></dt><dd>
<p>
     通俗易懂的编码细节介绍
</p>
</dd>
<dt><a href="http://zh.wikipedia.org/wiki/QR碼">QR碼 - 维基百科，自由的百科全书</a></dt><dd>

</dd>
<dt><a href="http://www.qrstuff.com/blog/2011/11/23/qr-code-minimum-size">QR Code Minimum Size</a> 与 <a href="http://www.qrstuff.com/blog/2011/01/18/what-size-should-a-qr-code-be">What Size Should A Printed QR Code Be?</a></dt><dd>
<p>
     关于可识别性的一些结论，该网站上有大量二维码研究相关的文章
</p></dd>
</dl>


</div>

</div>

<div id="outline-container-2" class="outline-3">
<h3 id="sec-2">二维码开发库</h3>
<div class="outline-text-3" id="text-2">

<dl>
<dt><a href="https://github.com/fukuchi/libqrencode">libqrencode</a></dt><dd>
<p>
     基础的c语言二维码编码库，很多语言基于它开发扩展，不包含生成png图的功能，如需生成png可参考<a href="https://github.com/bitly/simplehttp/blob/master/qrencode/qrencode.c">这里</a>
</p></dd>
<dt><a href="https://github.com/jeromeetienne/jquery-qrcode">jquery-qrcode</a></dt><dd>
<p>
     使用javascript直接在客户端生成二维码，中文支持参见<a href="http://suflow.iteye.com/blog/1687396">JS生成二维码，支持中文字符</a>
</p></dd>
<dt><a href="http://people.freebsd.org/~vanilla/qrencode-0.3.tar.bz2">php's qrencode extension</a></dt><dd>
<p>
     使用nginx的扩展性能会更好一点，参考后面<a href="#sec-3">nginx的相关扩展</a>.
</p></dd>
<dt><a href="http://trac.koka-in.org/libdecodeqr">libdecodeqr</a></dt><dd>
<p>
     二维码解码库
</p></dd>
</dl>


</div>

</div>

<div id="outline-container-3" class="outline-3">
<h3 id="sec-3">nginx的相关扩展</h3>
<div class="outline-text-3" id="text-3">


</div>

<div id="outline-container-3-1" class="outline-4">
<h4 id="sec-3-1">基本的二维码</h4>
<div class="outline-text-4" id="text-3-1">

<p>    <a href="https://github.com/dcshi/ngx_http_qrcode_module">ngx_http_qrcode_module</a>
</p>
</div>

</div>

<div id="outline-container-3-2" class="outline-4">
<h4 id="sec-3-2">二维码个性化水印</h4>
<div class="outline-text-4" id="text-3-2">

<p>   nginx_http_image_filter加上<a href="http://forum.nginx.org/read.php?21,235958">水印补丁</a>即可。
</p>
<p>
   下面的是经过修改后的 <code>nginx image filter</code> 模块代码，加入居中的水印效果:
</p>


<div class="o-blog-source"><a class="btn btn-info" data-toggle="modal" data-target="#ngx5fhttp5fimage5ffilter5fmodule2ec" ><i class="icon-file icon-white"></i>&nbsp;ngx_http_image_filter_module.c</a></div><div class="modal fade hide" id="ngx5fhttp5fimage5ffilter5fmodule2ec"><div class="modal-header"><a class="close" data-dismiss="modal">×</a><h3>ngx_http_image_filter_module.c</h3></div><div class="modal-body"><pre>

<span style="color: #888a85;">/*</span><span style="color: #888a85;">
 * Copyright (C) Igor Sysoev
 * Copyright (C) Nginx, Inc.
 </span><span style="color: #888a85;">*/</span>


#include &lt;ngx_config.h&gt;
#include &lt;ngx_core.h&gt;
#include &lt;ngx_http.h&gt;

#include &lt;gd.h&gt;


#define NGX_HTTP_IMAGE_OFF<span style="background-color: #404040;"> </span>      0
#define NGX_HTTP_IMAGE_TEST<span style="background-color: #404040;"> </span>     1
#define NGX_HTTP_IMAGE_SIZE<span style="background-color: #404040;"> </span>     2
#define NGX_HTTP_IMAGE_RESIZE<span style="background-color: #404040;"> </span>   3
#define NGX_HTTP_IMAGE_CROP<span style="background-color: #404040;"> </span>     4
#define NGX_HTTP_IMAGE_ROTATE<span style="background-color: #404040;"> </span>   5
#define NGX_HTTP_IMAGE_WATERMARK 6


#define NGX_HTTP_IMAGE_START<span style="background-color: #404040;"> </span>    0
#define NGX_HTTP_IMAGE_READ<span style="background-color: #404040;"> </span>     1
#define NGX_HTTP_IMAGE_PROCESS   2
#define NGX_HTTP_IMAGE_PASS<span style="background-color: #404040;"> </span>     3
#define NGX_HTTP_IMAGE_DONE<span style="background-color: #404040;"> </span>     4


#define NGX_HTTP_IMAGE_NONE<span style="background-color: #404040;"> </span>     0
#define NGX_HTTP_IMAGE_JPEG<span style="background-color: #404040;"> </span>     1
#define NGX_HTTP_IMAGE_GIF<span style="background-color: #404040;"> </span>      2
#define NGX_HTTP_IMAGE_PNG<span style="background-color: #404040;"> </span>      3


#define NGX_HTTP_IMAGE_BUFFERED  0x08


typedef struct {
<span style="background-color: #404040;"> </span>   ngx_uint_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      filter;
<span style="background-color: #404040;"> </span>   ngx_uint_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      width;
<span style="background-color: #404040;"> </span>   ngx_uint_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      height;
<span style="background-color: #404040;"> </span>   ngx_uint_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      angle;
<span style="background-color: #404040;"> </span>   ngx_uint_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      jpeg_quality;
<span style="background-color: #404040;"> </span>   ngx_uint_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      sharpen;

<span style="background-color: #404040;"> </span>   ngx_flag_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      transparency;
<span style="background-color: #404040;"> </span>   ngx_str_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   watermark;
<span style="background-color: #404040;"> </span>   ngx_uint_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      watermark_transparency;
<span style="color: #ffff00; background-color: #ff0000; font-weight: bold;">    </span>
<span style="background-color: #404040;"> </span>   ngx_http_complex_value_t<span style="background-color: #404040;"> </span>   *wcv;
<span style="background-color: #404040;"> </span>   ngx_http_complex_value_t<span style="background-color: #404040;"> </span>   *hcv;
<span style="background-color: #404040;"> </span>   ngx_http_complex_value_t<span style="background-color: #404040;"> </span>   *acv;
<span style="background-color: #404040;"> </span>   ngx_http_complex_value_t<span style="background-color: #404040;"> </span>   *jqcv;
<span style="background-color: #404040;"> </span>   ngx_http_complex_value_t<span style="background-color: #404040;"> </span>   *shcv;

<span style="background-color: #404040;"> </span>   size_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      buffer_size;
} ngx_http_image_filter_conf_t;


typedef struct {
<span style="background-color: #404040;"> </span>   u_char<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     *image;
<span style="background-color: #404040;"> </span>   u_char<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     *last;

<span style="background-color: #404040;"> </span>   size_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      length;

<span style="background-color: #404040;"> </span>   ngx_uint_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      width;
<span style="background-color: #404040;"> </span>   ngx_uint_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      height;
<span style="background-color: #404040;"> </span>   ngx_uint_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      max_width;
<span style="background-color: #404040;"> </span>   ngx_uint_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      max_height;
<span style="background-color: #404040;"> </span>   ngx_uint_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      angle;

<span style="background-color: #404040;"> </span>   ngx_uint_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      phase;
<span style="background-color: #404040;"> </span>   ngx_uint_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      type;
<span style="background-color: #404040;"> </span>   ngx_uint_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      force;
} ngx_http_image_filter_ctx_t;


static ngx_int_t ngx_http_image_send(ngx_http_request_t *r,
<span style="background-color: #404040;"> </span>   ngx_http_image_filter_ctx_t *ctx, ngx_chain_t *in);
static ngx_uint_t ngx_http_image_test(ngx_http_request_t *r, ngx_chain_t *in);
static ngx_int_t ngx_http_image_read(ngx_http_request_t *r, ngx_chain_t *in);
static ngx_buf_t *ngx_http_image_process(ngx_http_request_t *r);
static ngx_buf_t *ngx_http_image_json(ngx_http_request_t *r,
<span style="background-color: #404040;"> </span>   ngx_http_image_filter_ctx_t *ctx);
static ngx_buf_t *ngx_http_image_asis(ngx_http_request_t *r,
<span style="background-color: #404040;"> </span>   ngx_http_image_filter_ctx_t *ctx);
static void ngx_http_image_length(ngx_http_request_t *r, ngx_buf_t *b);
static ngx_int_t ngx_http_image_size(ngx_http_request_t *r,
<span style="background-color: #404040;"> </span>   ngx_http_image_filter_ctx_t *ctx);

static ngx_buf_t *ngx_http_image_resize(ngx_http_request_t *r,
<span style="background-color: #404040;"> </span>   ngx_http_image_filter_ctx_t *ctx);
static gdImagePtr ngx_http_image_source(ngx_http_request_t *r,
<span style="background-color: #404040;"> </span>   ngx_http_image_filter_ctx_t *ctx);
static gdImagePtr ngx_http_image_new(ngx_http_request_t *r, int w, int h,
<span style="background-color: #404040;"> </span>   int colors);
static u_char *ngx_http_image_out(ngx_http_request_t *r, ngx_uint_t type,
<span style="background-color: #404040;"> </span>   gdImagePtr img, int *size);
static void ngx_http_image_cleanup(void *data);
static ngx_uint_t ngx_http_image_filter_get_value(ngx_http_request_t *r,
<span style="background-color: #404040;"> </span>   ngx_http_complex_value_t *cv, ngx_uint_t v);
static ngx_uint_t ngx_http_image_filter_value(ngx_str_t *value);


static void *ngx_http_image_filter_create_conf(ngx_conf_t *cf);
static char *ngx_http_image_filter_merge_conf(ngx_conf_t *cf, void *parent,
<span style="background-color: #404040;"> </span>   void *child);
static char *ngx_http_image_filter(ngx_conf_t *cf, ngx_command_t *cmd,
<span style="background-color: #404040;"> </span>   void *conf);
static char *ngx_http_image_filter_jpeg_quality(ngx_conf_t *cf,
<span style="background-color: #404040;"> </span>   ngx_command_t *cmd, void *conf);
static char *ngx_http_image_filter_sharpen(ngx_conf_t *cf, ngx_command_t *cmd,
<span style="background-color: #404040;"> </span>   void *conf);
static ngx_int_t ngx_http_image_filter_init(ngx_conf_t *cf);


static ngx_command_t  ngx_http_image_filter_commands[] = {

<span style="background-color: #404040;"> </span>   { ngx_string(<span style="color: #ad7fa8; font-style: italic;">"image_filter"</span>),
<span style="background-color: #404040;"> </span>     NGX_HTTP_LOC_CONF|NGX_CONF_TAKE123,
<span style="background-color: #404040;"> </span>     ngx_http_image_filter,
<span style="background-color: #404040;"> </span>     NGX_HTTP_LOC_CONF_OFFSET,
<span style="background-color: #404040;"> </span>     0,
<span style="background-color: #404040;"> </span>     NULL },

<span style="background-color: #404040;"> </span>   { ngx_string(<span style="color: #ad7fa8; font-style: italic;">"image_filter_jpeg_quality"</span>),
<span style="background-color: #404040;"> </span>     NGX_HTTP_MAIN_CONF|NGX_HTTP_SRV_CONF|NGX_HTTP_LOC_CONF|NGX_CONF_TAKE1,
<span style="background-color: #404040;"> </span>     ngx_http_image_filter_jpeg_quality,
<span style="background-color: #404040;"> </span>     NGX_HTTP_LOC_CONF_OFFSET,
<span style="background-color: #404040;"> </span>     0,
<span style="background-color: #404040;"> </span>     NULL },

<span style="background-color: #404040;"> </span>   { ngx_string(<span style="color: #ad7fa8; font-style: italic;">"image_filter_sharpen"</span>),
<span style="background-color: #404040;"> </span>     NGX_HTTP_MAIN_CONF|NGX_HTTP_SRV_CONF|NGX_HTTP_LOC_CONF|NGX_CONF_TAKE1,
<span style="background-color: #404040;"> </span>     ngx_http_image_filter_sharpen,
<span style="background-color: #404040;"> </span>     NGX_HTTP_LOC_CONF_OFFSET,
<span style="background-color: #404040;"> </span>     0,
<span style="background-color: #404040;"> </span>     NULL },

<span style="background-color: #404040;"> </span>   { ngx_string(<span style="color: #ad7fa8; font-style: italic;">"image_filter_transparency"</span>),
<span style="background-color: #404040;"> </span>     NGX_HTTP_MAIN_CONF|NGX_HTTP_SRV_CONF|NGX_HTTP_LOC_CONF|NGX_CONF_FLAG,
<span style="background-color: #404040;"> </span>     ngx_conf_set_flag_slot,
<span style="background-color: #404040;"> </span>     NGX_HTTP_LOC_CONF_OFFSET,
<span style="background-color: #404040;"> </span>     offsetof(ngx_http_image_filter_conf_t, transparency),
<span style="background-color: #404040;"> </span>     NULL },

<span style="background-color: #404040;"> </span>   { ngx_string(<span style="color: #ad7fa8; font-style: italic;">"image_filter_buffer"</span>),
<span style="background-color: #404040;"> </span>     NGX_HTTP_MAIN_CONF|NGX_HTTP_SRV_CONF|NGX_HTTP_LOC_CONF|NGX_CONF_TAKE1,
<span style="background-color: #404040;"> </span>     ngx_conf_set_size_slot,
<span style="background-color: #404040;"> </span>     NGX_HTTP_LOC_CONF_OFFSET,
<span style="background-color: #404040;"> </span>     offsetof(ngx_http_image_filter_conf_t, buffer_size),
<span style="background-color: #404040;"> </span>     NULL },

<span style="background-color: #404040;"> </span>   { ngx_string(<span style="color: #ad7fa8; font-style: italic;">"image_filter_watermark"</span>),
<span style="background-color: #404040;"> </span>     NGX_HTTP_MAIN_CONF|NGX_HTTP_SRV_CONF|NGX_HTTP_LOC_CONF|NGX_CONF_TAKE1,
<span style="background-color: #404040;"> </span>     ngx_conf_set_str_slot,
<span style="background-color: #404040;"> </span>     NGX_HTTP_LOC_CONF_OFFSET,
<span style="background-color: #404040;"> </span>     offsetof(ngx_http_image_filter_conf_t, watermark),
<span style="background-color: #404040;"> </span>     NULL },

<span style="background-color: #404040;"> </span>   { ngx_string(<span style="color: #ad7fa8; font-style: italic;">"image_filter_watermark_transparency"</span>),
<span style="background-color: #404040;"> </span>     NGX_HTTP_MAIN_CONF|NGX_HTTP_SRV_CONF|NGX_HTTP_LOC_CONF|NGX_CONF_TAKE1,
<span style="background-color: #404040;"> </span>     ngx_conf_set_num_slot,
<span style="background-color: #404040;"> </span>     NGX_HTTP_LOC_CONF_OFFSET,
<span style="background-color: #404040;"> </span>     offsetof(ngx_http_image_filter_conf_t, watermark_transparency),
<span style="background-color: #404040;"> </span>     NULL },
<span style="color: #ffff00; background-color: #ff0000; font-weight: bold;">    </span>
<span style="background-color: #404040;"> </span>     ngx_null_command
};


static ngx_http_module_t  ngx_http_image_filter_module_ctx = {
<span style="background-color: #404040;"> </span>   NULL,<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     <span style="color: #888a85;">/* </span><span style="color: #888a85;">preconfiguration </span><span style="color: #888a85;">*/</span>
<span style="background-color: #404040;"> </span>   ngx_http_image_filter_init,<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="color: #888a85;">/* </span><span style="color: #888a85;">postconfiguration </span><span style="color: #888a85;">*/</span>

<span style="background-color: #404040;"> </span>   NULL,<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     <span style="color: #888a85;">/* </span><span style="color: #888a85;">create main configuration </span><span style="color: #888a85;">*/</span>
<span style="background-color: #404040;"> </span>   NULL,<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     <span style="color: #888a85;">/* </span><span style="color: #888a85;">init main configuration </span><span style="color: #888a85;">*/</span>

<span style="background-color: #404040;"> </span>   NULL,<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     <span style="color: #888a85;">/* </span><span style="color: #888a85;">create server configuration </span><span style="color: #888a85;">*/</span>
<span style="background-color: #404040;"> </span>   NULL,<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     <span style="color: #888a85;">/* </span><span style="color: #888a85;">merge server configuration </span><span style="color: #888a85;">*/</span>

<span style="background-color: #404040;"> </span>   ngx_http_image_filter_create_conf,<span style="background-color: #404040;"> </span>    <span style="color: #888a85;">/* </span><span style="color: #888a85;">create location configuration </span><span style="color: #888a85;">*/</span>
<span style="background-color: #404040;"> </span>   ngx_http_image_filter_merge_conf<span style="background-color: #404040;"> </span>      <span style="color: #888a85;">/* </span><span style="color: #888a85;">merge location configuration </span><span style="color: #888a85;">*/</span>
};


ngx_module_t  ngx_http_image_filter_module = {
<span style="background-color: #404040;"> </span>   NGX_MODULE_V1,
<span style="background-color: #404040;"> </span>   &amp;ngx_http_image_filter_module_ctx,<span style="background-color: #404040;"> </span>    <span style="color: #888a85;">/* </span><span style="color: #888a85;">module context </span><span style="color: #888a85;">*/</span>
<span style="background-color: #404040;"> </span>   ngx_http_image_filter_commands,<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="color: #888a85;">/* </span><span style="color: #888a85;">module directives </span><span style="color: #888a85;">*/</span>
<span style="background-color: #404040;"> </span>   NGX_HTTP_MODULE,<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      <span style="color: #888a85;">/* </span><span style="color: #888a85;">module type </span><span style="color: #888a85;">*/</span>
<span style="background-color: #404040;"> </span>   NULL,<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     <span style="color: #888a85;">/* </span><span style="color: #888a85;">init master </span><span style="color: #888a85;">*/</span>
<span style="background-color: #404040;"> </span>   NULL,<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     <span style="color: #888a85;">/* </span><span style="color: #888a85;">init module </span><span style="color: #888a85;">*/</span>
<span style="background-color: #404040;"> </span>   NULL,<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     <span style="color: #888a85;">/* </span><span style="color: #888a85;">init process </span><span style="color: #888a85;">*/</span>
<span style="background-color: #404040;"> </span>   NULL,<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     <span style="color: #888a85;">/* </span><span style="color: #888a85;">init thread </span><span style="color: #888a85;">*/</span>
<span style="background-color: #404040;"> </span>   NULL,<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     <span style="color: #888a85;">/* </span><span style="color: #888a85;">exit thread </span><span style="color: #888a85;">*/</span>
<span style="background-color: #404040;"> </span>   NULL,<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     <span style="color: #888a85;">/* </span><span style="color: #888a85;">exit process </span><span style="color: #888a85;">*/</span>
<span style="background-color: #404040;"> </span>   NULL,<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     <span style="color: #888a85;">/* </span><span style="color: #888a85;">exit master </span><span style="color: #888a85;">*/</span>
<span style="background-color: #404040;"> </span>   NGX_MODULE_V1_PADDING
};


static ngx_http_output_header_filter_pt  ngx_http_next_header_filter;
static ngx_http_output_body_filter_pt<span style="background-color: #404040;"> </span>   ngx_http_next_body_filter;


static ngx_str_t  ngx_http_image_types[] = {
<span style="background-color: #404040;"> </span>   ngx_string(<span style="color: #ad7fa8; font-style: italic;">"image/jpeg"</span>),
<span style="background-color: #404040;"> </span>   ngx_string(<span style="color: #ad7fa8; font-style: italic;">"image/gif"</span>),
<span style="background-color: #404040;"> </span>   ngx_string(<span style="color: #ad7fa8; font-style: italic;">"image/png"</span>)
};


static ngx_int_t
ngx_http_image_header_filter(ngx_http_request_t *r)
{
<span style="background-color: #404040;"> </span>   off_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     len;
<span style="background-color: #404040;"> </span>   ngx_http_image_filter_ctx_t   *ctx;
<span style="background-color: #404040;"> </span>   ngx_http_image_filter_conf_t  *conf;

<span style="background-color: #404040;"> </span>   if (r-&gt;headers_out.status == NGX_HTTP_NOT_MODIFIED) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return ngx_http_next_header_filter(r);
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   ctx = ngx_http_get_module_ctx(r, ngx_http_image_filter_module);

<span style="background-color: #404040;"> </span>   if (ctx) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ngx_http_set_ctx(r, NULL, ngx_http_image_filter_module);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return ngx_http_next_header_filter(r);
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   conf = ngx_http_get_module_loc_conf(r, ngx_http_image_filter_module);

<span style="background-color: #404040;"> </span>   if (conf-&gt;filter == NGX_HTTP_IMAGE_OFF) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return ngx_http_next_header_filter(r);
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   if (r-&gt;headers_out.content_type.len
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   &gt;= sizeof(<span style="color: #ad7fa8; font-style: italic;">"multipart/x-mixed-replace"</span>) - 1
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   &amp;&amp; ngx_strncasecmp(r-&gt;headers_out.content_type.data,
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      (u_char *) <span style="color: #ad7fa8; font-style: italic;">"multipart/x-mixed-replace"</span>,
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      sizeof(<span style="color: #ad7fa8; font-style: italic;">"multipart/x-mixed-replace"</span>) - 1)
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      == 0)
<span style="background-color: #404040;"> </span>   {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;log, 0,
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     <span style="color: #ad7fa8; font-style: italic;">"image filter: multipart/x-mixed-replace response"</span>);

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NGX_ERROR;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   ctx = ngx_pcalloc(r-&gt;pool, sizeof(ngx_http_image_filter_ctx_t));
<span style="background-color: #404040;"> </span>   if (ctx == NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NGX_ERROR;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   ngx_http_set_ctx(r, ctx, ngx_http_image_filter_module);

<span style="background-color: #404040;"> </span>   len = r-&gt;headers_out.content_length_n;

<span style="background-color: #404040;"> </span>   if (len != -1 &amp;&amp; len &gt; (off_t) conf-&gt;buffer_size) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;log, 0,
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     <span style="color: #ad7fa8; font-style: italic;">"image filter: too big response: %O"</span>, len);

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NGX_HTTP_UNSUPPORTED_MEDIA_TYPE;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   if (len == -1) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ctx-&gt;length = conf-&gt;buffer_size;

<span style="background-color: #404040;"> </span>   } else {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ctx-&gt;length = (size_t) len;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   if (r-&gt;headers_out.refresh) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   r-&gt;headers_out.refresh-&gt;hash = 0;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   r-&gt;main_filter_need_in_memory = 1;
<span style="background-color: #404040;"> </span>   r-&gt;allow_ranges = 0;

<span style="background-color: #404040;"> </span>   return NGX_OK;
}


static ngx_int_t
ngx_http_image_body_filter(ngx_http_request_t *r, ngx_chain_t *in)
{
<span style="background-color: #404040;"> </span>   ngx_int_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     rc;
<span style="background-color: #404040;"> </span>   ngx_str_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>    *ct;
<span style="background-color: #404040;"> </span>   ngx_chain_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   out;
<span style="background-color: #404040;"> </span>   ngx_http_image_filter_ctx_t   *ctx;
<span style="background-color: #404040;"> </span>   ngx_http_image_filter_conf_t  *conf;

<span style="background-color: #404040;"> </span>   ngx_log_debug0(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;log, 0, <span style="color: #ad7fa8; font-style: italic;">"image filter"</span>);

<span style="background-color: #404040;"> </span>   if (in == NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return ngx_http_next_body_filter(r, in);
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   ctx = ngx_http_get_module_ctx(r, ngx_http_image_filter_module);

<span style="background-color: #404040;"> </span>   if (ctx == NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return ngx_http_next_body_filter(r, in);
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   switch (ctx-&gt;phase) {

<span style="background-color: #404040;"> </span>   case NGX_HTTP_IMAGE_START:

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ctx-&gt;type = ngx_http_image_test(r, in);

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   conf = ngx_http_get_module_loc_conf(r, ngx_http_image_filter_module);

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (ctx-&gt;type == NGX_HTTP_IMAGE_NONE) {

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (conf-&gt;filter == NGX_HTTP_IMAGE_SIZE) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   out.buf = ngx_http_image_json(r, NULL);

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (out.buf) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   out.next = NULL;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ctx-&gt;phase = NGX_HTTP_IMAGE_DONE;

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return ngx_http_image_send(r, ctx, &amp;out);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return ngx_http_filter_finalize_request(r,
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     &amp;ngx_http_image_filter_module,
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     NGX_HTTP_UNSUPPORTED_MEDIA_TYPE);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="color: #888a85;">/* </span><span style="color: #888a85;">override content type </span><span style="color: #888a85;">*/</span>

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ct = &amp;ngx_http_image_types[ctx-&gt;type - 1];
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   r-&gt;headers_out.content_type_len = ct-&gt;len;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   r-&gt;headers_out.content_type = *ct;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   r-&gt;headers_out.content_type_lowcase = NULL;

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (conf-&gt;filter == NGX_HTTP_IMAGE_TEST) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ctx-&gt;phase = NGX_HTTP_IMAGE_PASS;

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return ngx_http_image_send(r, ctx, in);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ctx-&gt;phase = NGX_HTTP_IMAGE_READ;

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="color: #888a85;">/* </span><span style="color: #888a85;">fall through </span><span style="color: #888a85;">*/</span>

<span style="background-color: #404040;"> </span>   case NGX_HTTP_IMAGE_READ:

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   rc = ngx_http_image_read(r, in);

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (rc == NGX_AGAIN) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NGX_OK;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (rc == NGX_ERROR) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return ngx_http_filter_finalize_request(r,
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     &amp;ngx_http_image_filter_module,
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     NGX_HTTP_UNSUPPORTED_MEDIA_TYPE);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="color: #888a85;">/* </span><span style="color: #888a85;">fall through </span><span style="color: #888a85;">*/</span>

<span style="background-color: #404040;"> </span>   case NGX_HTTP_IMAGE_PROCESS:

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   out.buf = ngx_http_image_process(r);

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (out.buf == NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return ngx_http_filter_finalize_request(r,
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     &amp;ngx_http_image_filter_module,
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     NGX_HTTP_UNSUPPORTED_MEDIA_TYPE);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   out.next = NULL;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ctx-&gt;phase = NGX_HTTP_IMAGE_PASS;

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return ngx_http_image_send(r, ctx, &amp;out);

<span style="background-color: #404040;"> </span>   case NGX_HTTP_IMAGE_PASS:

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return ngx_http_next_body_filter(r, in);

<span style="background-color: #404040;"> </span>   default: <span style="color: #888a85;">/* </span><span style="color: #888a85;">NGX_HTTP_IMAGE_DONE </span><span style="color: #888a85;">*/</span>

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   rc = ngx_http_next_body_filter(r, NULL);

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="color: #888a85;">/* </span><span style="color: #888a85;">NGX_ERROR resets any pending data </span><span style="color: #888a85;">*/</span>
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return (rc == NGX_OK) ? NGX_ERROR : rc;
<span style="background-color: #404040;"> </span>   }
}


static ngx_int_t
ngx_http_image_send(ngx_http_request_t *r, ngx_http_image_filter_ctx_t *ctx,
<span style="background-color: #404040;"> </span>   ngx_chain_t *in)
{
<span style="background-color: #404040;"> </span>   ngx_int_t  rc;

<span style="background-color: #404040;"> </span>   rc = ngx_http_next_header_filter(r);

<span style="background-color: #404040;"> </span>   if (rc == NGX_ERROR || rc &gt; NGX_OK || r-&gt;header_only) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NGX_ERROR;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   rc = ngx_http_next_body_filter(r, in);

<span style="background-color: #404040;"> </span>   if (ctx-&gt;phase == NGX_HTTP_IMAGE_DONE) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="color: #888a85;">/* </span><span style="color: #888a85;">NGX_ERROR resets any pending data </span><span style="color: #888a85;">*/</span>
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return (rc == NGX_OK) ? NGX_ERROR : rc;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   return rc;
}


static ngx_uint_t
ngx_http_image_test(ngx_http_request_t *r, ngx_chain_t *in)
{
<span style="background-color: #404040;"> </span>   u_char  *p;

<span style="background-color: #404040;"> </span>   p = in-&gt;buf-&gt;pos;

<span style="background-color: #404040;"> </span>   if (in-&gt;buf-&gt;last - p &lt; 16) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NGX_HTTP_IMAGE_NONE;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   ngx_log_debug2(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;log, 0,
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      <span style="color: #ad7fa8; font-style: italic;">"image filter: \"%c%c\""</span>, p[0], p[1]);

<span style="background-color: #404040;"> </span>   if (p[0] == 0xff &amp;&amp; p[1] == 0xd8) {

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="color: #888a85;">/* </span><span style="color: #888a85;">JPEG </span><span style="color: #888a85;">*/</span>

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NGX_HTTP_IMAGE_JPEG;

<span style="background-color: #404040;"> </span>   } else if (p[0] == <span style="color: #ad7fa8; font-style: italic;">'G'</span> &amp;&amp; p[1] == <span style="color: #ad7fa8; font-style: italic;">'I'</span> &amp;&amp; p[2] == <span style="color: #ad7fa8; font-style: italic;">'F'</span> &amp;&amp; p[3] == <span style="color: #ad7fa8; font-style: italic;">'8'</span>
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      &amp;&amp; p[5] == <span style="color: #ad7fa8; font-style: italic;">'a'</span>)
<span style="background-color: #404040;"> </span>   {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (p[4] == <span style="color: #ad7fa8; font-style: italic;">'9'</span> || p[4] == <span style="color: #ad7fa8; font-style: italic;">'7'</span>) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="color: #888a85;">/* </span><span style="color: #888a85;">GIF </span><span style="color: #888a85;">*/</span>
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NGX_HTTP_IMAGE_GIF;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   } else if (p[0] == 0x89 &amp;&amp; p[1] == <span style="color: #ad7fa8; font-style: italic;">'P'</span> &amp;&amp; p[2] == <span style="color: #ad7fa8; font-style: italic;">'N'</span> &amp;&amp; p[3] == <span style="color: #ad7fa8; font-style: italic;">'G'</span>
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      &amp;&amp; p[4] == 0x0d &amp;&amp; p[5] == 0x0a &amp;&amp; p[6] == 0x1a &amp;&amp; p[7] == 0x0a)
<span style="background-color: #404040;"> </span>   {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="color: #888a85;">/* </span><span style="color: #888a85;">PNG </span><span style="color: #888a85;">*/</span>

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NGX_HTTP_IMAGE_PNG;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   return NGX_HTTP_IMAGE_NONE;
}


static ngx_int_t
ngx_http_image_read(ngx_http_request_t *r, ngx_chain_t *in)
{
<span style="background-color: #404040;"> </span>   u_char<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      *p;
<span style="background-color: #404040;"> </span>   size_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   size, rest;
<span style="background-color: #404040;"> </span>   ngx_buf_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   *b;
<span style="background-color: #404040;"> </span>   ngx_chain_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     *cl;
<span style="background-color: #404040;"> </span>   ngx_http_image_filter_ctx_t  *ctx;

<span style="background-color: #404040;"> </span>   ctx = ngx_http_get_module_ctx(r, ngx_http_image_filter_module);

<span style="background-color: #404040;"> </span>   if (ctx-&gt;image == NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ctx-&gt;image = ngx_palloc(r-&gt;pool, ctx-&gt;length);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (ctx-&gt;image == NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NGX_ERROR;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ctx-&gt;last = ctx-&gt;image;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   p = ctx-&gt;last;

<span style="background-color: #404040;"> </span>   for (cl = in; cl; cl = cl-&gt;next) {

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   b = cl-&gt;buf;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   size = b-&gt;last - b-&gt;pos;

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ngx_log_debug1(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;log, 0,
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      <span style="color: #ad7fa8; font-style: italic;">"image buf: %uz"</span>, size);

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   rest = ctx-&gt;image + ctx-&gt;length - p;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   size = (rest &lt; size) ? rest : size;

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   p = ngx_cpymem(p, b-&gt;pos, size);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   b-&gt;pos += size;

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (b-&gt;last_buf) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ctx-&gt;last = p;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NGX_OK;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   ctx-&gt;last = p;
<span style="background-color: #404040;"> </span>   r-&gt;connection-&gt;buffered |= NGX_HTTP_IMAGE_BUFFERED;

<span style="background-color: #404040;"> </span>   return NGX_AGAIN;
}


static ngx_buf_t *
ngx_http_image_process(ngx_http_request_t *r)
{
<span style="background-color: #404040;"> </span>   ngx_int_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     rc;
<span style="background-color: #404040;"> </span>   ngx_http_image_filter_ctx_t   *ctx;
<span style="background-color: #404040;"> </span>   ngx_http_image_filter_conf_t  *conf;

<span style="background-color: #404040;"> </span>   r-&gt;connection-&gt;buffered &amp;= ~NGX_HTTP_IMAGE_BUFFERED;

<span style="background-color: #404040;"> </span>   ctx = ngx_http_get_module_ctx(r, ngx_http_image_filter_module);

<span style="background-color: #404040;"> </span>   rc = ngx_http_image_size(r, ctx);

<span style="background-color: #404040;"> </span>   conf = ngx_http_get_module_loc_conf(r, ngx_http_image_filter_module);

<span style="background-color: #404040;"> </span>   if (conf-&gt;filter == NGX_HTTP_IMAGE_SIZE) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return ngx_http_image_json(r, rc == NGX_OK ? ctx : NULL);
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   ctx-&gt;angle = ngx_http_image_filter_get_value(r, conf-&gt;acv, conf-&gt;angle);

<span style="background-color: #404040;"> </span>   if (conf-&gt;filter == NGX_HTTP_IMAGE_ROTATE) {

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (ctx-&gt;angle != 90 &amp;&amp; ctx-&gt;angle != 180 &amp;&amp; ctx-&gt;angle != 270) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NULL;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return ngx_http_image_resize(r, ctx);
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   if (conf-&gt;filter == NGX_HTTP_IMAGE_WATERMARK) {

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (!conf-&gt;watermark.data) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NULL;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return ngx_http_image_resize(r, ctx);
<span style="background-color: #404040;"> </span>   }<span style="color: #ffff00; background-color: #ff0000; font-weight: bold;">    </span>

<span style="background-color: #404040;"> </span>   ctx-&gt;max_width = ngx_http_image_filter_get_value(r, conf-&gt;wcv, conf-&gt;width);
<span style="background-color: #404040;"> </span>   if (ctx-&gt;max_width == 0) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NULL;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   ctx-&gt;max_height = ngx_http_image_filter_get_value(r, conf-&gt;hcv,
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     conf-&gt;height);
<span style="background-color: #404040;"> </span>   if (ctx-&gt;max_height == 0) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NULL;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   if (rc == NGX_OK
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   &amp;&amp; ctx-&gt;width &lt;= ctx-&gt;max_width
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   &amp;&amp; ctx-&gt;height &lt;= ctx-&gt;max_height
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   &amp;&amp; ctx-&gt;angle == 0
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   &amp;&amp; !ctx-&gt;force)
<span style="background-color: #404040;"> </span>   {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return ngx_http_image_asis(r, ctx);
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   return ngx_http_image_resize(r, ctx);
}


static ngx_buf_t *
ngx_http_image_json(ngx_http_request_t *r, ngx_http_image_filter_ctx_t *ctx)
{
<span style="background-color: #404040;"> </span>   size_t<span style="background-color: #404040;"> </span>     len;
<span style="background-color: #404040;"> </span>   ngx_buf_t  *b;

<span style="background-color: #404040;"> </span>   b = ngx_pcalloc(r-&gt;pool, sizeof(ngx_buf_t));
<span style="background-color: #404040;"> </span>   if (b == NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NULL;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   b-&gt;memory = 1;
<span style="background-color: #404040;"> </span>   b-&gt;last_buf = 1;

<span style="background-color: #404040;"> </span>   ngx_http_clean_header(r);

<span style="background-color: #404040;"> </span>   r-&gt;headers_out.status = NGX_HTTP_OK;
<span style="background-color: #404040;"> </span>   ngx_str_set(&amp;r-&gt;headers_out.content_type, <span style="color: #ad7fa8; font-style: italic;">"text/plain"</span>);
<span style="background-color: #404040;"> </span>   r-&gt;headers_out.content_type_lowcase = NULL;

<span style="background-color: #404040;"> </span>   if (ctx == NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   b-&gt;pos = (u_char *) <span style="color: #ad7fa8; font-style: italic;">"{}"</span> CRLF;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   b-&gt;last = b-&gt;pos + sizeof(<span style="color: #ad7fa8; font-style: italic;">"{}"</span> CRLF) - 1;

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ngx_http_image_length(r, b);

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return b;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   len = sizeof(<span style="color: #ad7fa8; font-style: italic;">"{ \"img\" : "</span>
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>    <span style="color: #ad7fa8; font-style: italic;">"{ \"width\": , \"height\": , \"type\": \"jpeg\" } }"</span> CRLF) - 1
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     + 2 * NGX_SIZE_T_LEN;

<span style="background-color: #404040;"> </span>   b-&gt;pos = ngx_pnalloc(r-&gt;pool, len);
<span style="background-color: #404040;"> </span>   if (b-&gt;pos == NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NULL;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   b-&gt;last = ngx_sprintf(b-&gt;pos,
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     <span style="color: #ad7fa8; font-style: italic;">"{ \"img\" : "</span>
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      <span style="color: #ad7fa8; font-style: italic;">"{ \"width\": %uz,"</span>
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="color: #ad7fa8; font-style: italic;">" \"height\": %uz,"</span>
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="color: #ad7fa8; font-style: italic;">" \"type\": \"%s\" } }"</span> CRLF,
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     ctx-&gt;width, ctx-&gt;height,
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     ngx_http_image_types[ctx-&gt;type - 1].data + 6);

<span style="background-color: #404040;"> </span>   ngx_http_image_length(r, b);

<span style="background-color: #404040;"> </span>   return b;
}


static ngx_buf_t *
ngx_http_image_asis(ngx_http_request_t *r, ngx_http_image_filter_ctx_t *ctx)
{
<span style="background-color: #404040;"> </span>   ngx_buf_t  *b;

<span style="background-color: #404040;"> </span>   b = ngx_pcalloc(r-&gt;pool, sizeof(ngx_buf_t));
<span style="background-color: #404040;"> </span>   if (b == NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NULL;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   b-&gt;pos = ctx-&gt;image;
<span style="background-color: #404040;"> </span>   b-&gt;last = ctx-&gt;last;
<span style="background-color: #404040;"> </span>   b-&gt;memory = 1;
<span style="background-color: #404040;"> </span>   b-&gt;last_buf = 1;

<span style="background-color: #404040;"> </span>   ngx_http_image_length(r, b);

<span style="background-color: #404040;"> </span>   return b;
}


static void
ngx_http_image_length(ngx_http_request_t *r, ngx_buf_t *b)
{
<span style="background-color: #404040;"> </span>   r-&gt;headers_out.content_length_n = b-&gt;last - b-&gt;pos;

<span style="background-color: #404040;"> </span>   if (r-&gt;headers_out.content_length) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   r-&gt;headers_out.content_length-&gt;hash = 0;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   r-&gt;headers_out.content_length = NULL;
}


static ngx_int_t
ngx_http_image_size(ngx_http_request_t *r, ngx_http_image_filter_ctx_t *ctx)
{
<span style="background-color: #404040;"> </span>   u_char<span style="background-color: #404040;"> </span>     *p, *last;
<span style="background-color: #404040;"> </span>   size_t<span style="background-color: #404040;"> </span>      len, app;
<span style="background-color: #404040;"> </span>   ngx_uint_t   width, height;

<span style="background-color: #404040;"> </span>   p = ctx-&gt;image;

<span style="background-color: #404040;"> </span>   switch (ctx-&gt;type) {

<span style="background-color: #404040;"> </span>   case NGX_HTTP_IMAGE_JPEG:

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   p += 2;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   last = ctx-&gt;image + ctx-&gt;length - 10;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   width = 0;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   height = 0;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   app = 0;

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   while (p &lt; last) {

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (p[0] == 0xff &amp;&amp; p[1] != 0xff) {

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ngx_log_debug2(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;log, 0,
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      <span style="color: #ad7fa8; font-style: italic;">"JPEG: %02xd %02xd"</span>, p[0], p[1]);

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   p++;

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if ((*p == 0xc0 || *p == 0xc1 || *p == 0xc2 || *p == 0xc3
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>    || *p == 0xc9 || *p == 0xca || *p == 0xcb)
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   &amp;&amp; (width == 0 || height == 0))
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   width = p[6] * 256 + p[7];
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   height = p[4] * 256 + p[5];
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ngx_log_debug2(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;log, 0,
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      <span style="color: #ad7fa8; font-style: italic;">"JPEG: %02xd %02xd"</span>, p[1], p[2]);

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   len = p[1] * 256 + p[2];

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (*p &gt;= 0xe1 &amp;&amp; *p &lt;= 0xef) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="color: #888a85;">/* </span><span style="color: #888a85;">application data, e.g., EXIF, Adobe XMP, etc. </span><span style="color: #888a85;">*/</span>
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   app += len;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   p += len;

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   continue;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   p++;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (width == 0 || height == 0) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NGX_DECLINED;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (ctx-&gt;length / 20 &lt; app) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="color: #888a85;">/* </span><span style="color: #888a85;">force conversion if application data consume more than 5% </span><span style="color: #888a85;">*/</span>
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ctx-&gt;force = 1;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ngx_log_debug1(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;log, 0,
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      <span style="color: #ad7fa8; font-style: italic;">"app data size: %uz"</span>, app);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   break;

<span style="background-color: #404040;"> </span>   case NGX_HTTP_IMAGE_GIF:

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (ctx-&gt;length &lt; 10) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NGX_DECLINED;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   width = p[7] * 256 + p[6];
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   height = p[9] * 256 + p[8];

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   break;

<span style="background-color: #404040;"> </span>   case NGX_HTTP_IMAGE_PNG:

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (ctx-&gt;length &lt; 24) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NGX_DECLINED;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   width = p[18] * 256 + p[19];
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   height = p[22] * 256 + p[23];

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   break;

<span style="background-color: #404040;"> </span>   default:

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NGX_DECLINED;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   ngx_log_debug2(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;log, 0,
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      <span style="color: #ad7fa8; font-style: italic;">"image size: %d x %d"</span>, width, height);

<span style="background-color: #404040;"> </span>   ctx-&gt;width = width;
<span style="background-color: #404040;"> </span>   ctx-&gt;height = height;

<span style="background-color: #404040;"> </span>   return NGX_OK;
}


static ngx_buf_t *
ngx_http_image_resize(ngx_http_request_t *r, ngx_http_image_filter_ctx_t *ctx)
{
<span style="background-color: #404040;"> </span>   int<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   sx, sy, dx, dy, ox, oy, ax, ay, size,
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      colors, palette, transparent, sharpen,
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      red, green, blue, t;
<span style="background-color: #404040;"> </span>   u_char<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   *out;
<span style="background-color: #404040;"> </span>   ngx_buf_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>    *b;
<span style="background-color: #404040;"> </span>   ngx_uint_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>    resize;
<span style="background-color: #404040;"> </span>   gdImagePtr<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>    src, dst;
<span style="background-color: #404040;"> </span>   ngx_pool_cleanup_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   *cln;
<span style="background-color: #404040;"> </span>   ngx_http_image_filter_conf_t  *conf;

<span style="background-color: #404040;"> </span>   src = ngx_http_image_source(r, ctx);

<span style="background-color: #404040;"> </span>   if (src == NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NULL;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   sx = gdImageSX(src);
<span style="background-color: #404040;"> </span>   sy = gdImageSY(src);

<span style="background-color: #404040;"> </span>   conf = ngx_http_get_module_loc_conf(r, ngx_http_image_filter_module);

<span style="background-color: #404040;"> </span>   if (!ctx-&gt;force
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   &amp;&amp; ctx-&gt;angle == 0
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   &amp;&amp; (ngx_uint_t) sx &lt;= ctx-&gt;max_width
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   &amp;&amp; (ngx_uint_t) sy &lt;= ctx-&gt;max_height)
<span style="background-color: #404040;"> </span>   {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   gdImageDestroy(src);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return ngx_http_image_asis(r, ctx);
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   colors = gdImageColorsTotal(src);

<span style="background-color: #404040;"> </span>   if (colors &amp;&amp; conf-&gt;transparency) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   transparent = gdImageGetTransparent(src);

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (transparent != -1) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   palette = colors;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   red = gdImageRed(src, transparent);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   green = gdImageGreen(src, transparent);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   blue = gdImageBlue(src, transparent);

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   goto transparent;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   palette = 0;
<span style="background-color: #404040;"> </span>   transparent = -1;
<span style="background-color: #404040;"> </span>   red = 0;
<span style="background-color: #404040;"> </span>   green = 0;
<span style="background-color: #404040;"> </span>   blue = 0;

transparent:

<span style="background-color: #404040;"> </span>   gdImageColorTransparent(src, -1);

<span style="background-color: #404040;"> </span>   dx = sx;
<span style="background-color: #404040;"> </span>   dy = sy;

<span style="background-color: #404040;"> </span>   if (conf-&gt;filter == NGX_HTTP_IMAGE_RESIZE) {

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if ((ngx_uint_t) dx &gt; ctx-&gt;max_width) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   dy = dy * ctx-&gt;max_width / dx;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   dy = dy ? dy : 1;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   dx = ctx-&gt;max_width;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if ((ngx_uint_t) dy &gt; ctx-&gt;max_height) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   dx = dx * ctx-&gt;max_height / dy;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   dx = dx ? dx : 1;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   dy = ctx-&gt;max_height;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   resize = 1;

<span style="background-color: #404040;"> </span>   } else if (conf-&gt;filter == NGX_HTTP_IMAGE_ROTATE) {

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   resize = 0;
<span style="background-color: #404040;"> </span>   } else if (conf-&gt;filter == NGX_HTTP_IMAGE_WATERMARK) {
<span style="color: #ffff00; background-color: #ff0000; font-weight: bold;">        </span>
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   resize = 0;
<span style="background-color: #404040;"> </span>   } else { <span style="color: #888a85;">/* </span><span style="color: #888a85;">NGX_HTTP_IMAGE_CROP </span><span style="color: #888a85;">*/</span>

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   resize = 0;

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if ((double) dx / dy &lt; (double) ctx-&gt;max_width / ctx-&gt;max_height) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if ((ngx_uint_t) dx &gt; ctx-&gt;max_width) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   dy = dy * ctx-&gt;max_width / dx;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   dy = dy ? dy : 1;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   dx = ctx-&gt;max_width;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   resize = 1;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   } else {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if ((ngx_uint_t) dy &gt; ctx-&gt;max_height) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   dx = dx * ctx-&gt;max_height / dy;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   dx = dx ? dx : 1;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   dy = ctx-&gt;max_height;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   resize = 1;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   if (resize) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   dst = ngx_http_image_new(r, dx, dy, palette);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (dst == NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   gdImageDestroy(src);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NULL;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (colors == 0) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   gdImageSaveAlpha(dst, 1);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   gdImageAlphaBlending(dst, 0);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   gdImageCopyResampled(dst, src, 0, 0, 0, 0, dx, dy, sx, sy);

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (colors) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   gdImageTrueColorToPalette(dst, 1, 256);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   gdImageDestroy(src);

<span style="background-color: #404040;"> </span>   } else {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   dst = src;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   if (ctx-&gt;angle) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   src = dst;

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ax = (dx % 2 == 0) ? 1 : 0;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ay = (dy % 2 == 0) ? 1 : 0;

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   switch (ctx-&gt;angle) {

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   case 90:
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   case 270:
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   dst = ngx_http_image_new(r, dy, dx, palette);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (dst == NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   gdImageDestroy(src);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NULL;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (ctx-&gt;angle == 90) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ox = dy / 2 + ay;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   oy = dx / 2 - ax;

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   } else {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ox = dy / 2 - ay;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   oy = dx / 2 + ax;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   gdImageCopyRotated(dst, src, ox, oy, 0, 0,
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      dx + ax, dy + ay, ctx-&gt;angle);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   gdImageDestroy(src);

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   t = dx;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   dx = dy;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   dy = t;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   break;

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   case 180:
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   dst = ngx_http_image_new(r, dx, dy, palette);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (dst == NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   gdImageDestroy(src);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NULL;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   gdImageCopyRotated(dst, src, dx / 2 - ax, dy / 2 - ay, 0, 0,
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      dx + ax, dy + ay, ctx-&gt;angle);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   gdImageDestroy(src);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   break;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   if (conf-&gt;filter == NGX_HTTP_IMAGE_CROP) {

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   src = dst;

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if ((ngx_uint_t) dx &gt; ctx-&gt;max_width) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ox = dx - ctx-&gt;max_width;

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   } else {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ox = 0;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if ((ngx_uint_t) dy &gt; ctx-&gt;max_height) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   oy = dy - ctx-&gt;max_height;

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   } else {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   oy = 0;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (ox || oy) {

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   dst = ngx_http_image_new(r, dx - ox, dy - oy, colors);

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (dst == NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   gdImageDestroy(src);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NULL;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ox /= 2;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   oy /= 2;

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ngx_log_debug4(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;log, 0,
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      <span style="color: #ad7fa8; font-style: italic;">"image crop: %d x %d @ %d x %d"</span>,
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      dx, dy, ox, oy);

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (colors == 0) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   gdImageSaveAlpha(dst, 1);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   gdImageAlphaBlending(dst, 0);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   gdImageCopy(dst, src, 0, 0, ox, oy, dx - ox, dy - oy);

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (colors) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   gdImageTrueColorToPalette(dst, 1, 256);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   gdImageDestroy(src);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   if (transparent != -1 &amp;&amp; colors) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   gdImageColorTransparent(dst, gdImageColorExact(dst, red, green, blue));
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   if (conf-&gt;filter == NGX_HTTP_IMAGE_WATERMARK &amp;&amp; conf-&gt;watermark.data) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   FILE *watermark_file = fopen((const char *)conf-&gt;watermark.data, <span style="color: #ad7fa8; font-style: italic;">"r"</span>);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (watermark_file) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   gdImagePtr watermark, watermark_mix;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ngx_int_t wdx = 0, wdy = 0;
<span style="color: #ffff00; background-color: #ff0000; font-weight: bold;">            </span>
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   watermark = gdImageCreateFromPng(watermark_file);
<span style="color: #ffff00; background-color: #ff0000; font-weight: bold;">                </span>
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if(watermark != NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   watermark_mix = gdImageCreateTrueColor(watermark-&gt;sx, watermark-<span style="text-decoration: underline;">&gt;sy);</span>
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   wdx = dx/2 - watermark-&gt;sx/2;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   wdy = dy/2 - watermark-&gt;sy/2;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   gdImageCopy(watermark_mix, dst, 0, 0, wdx, wdy, watermark-&gt;sx, w<span style="text-decoration: underline;">atermark-&gt;sy);</span>
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   gdImageCopy(watermark_mix, watermark, 0, 0, 0, 0, watermark-&gt;sx,<span style="text-decoration: underline;"> watermark-&gt;sy);</span>
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   gdImageCopyMerge(dst, watermark_mix, wdx, wdy, 0, 0, watermark-&gt;<span style="text-decoration: underline;">sx, watermark-&gt;sy, conf-&gt;watermark_transparency);</span>
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   gdFree(watermark);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   gdFree(watermark_mix);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   } else { ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;log, 0, <span style="color: #ad7fa8; font-style: italic;">"watermar</span><span style="text-decoration: underline;">k file '%s' is not PNG", conf-&gt;watermark.data);}</span>
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   } else {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;log, 0, <span style="color: #ad7fa8; font-style: italic;">"watermark file '%</span><span style="text-decoration: underline;">s' not found", conf-&gt;watermark.data);</span>
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }
<span style="background-color: #404040;"> </span>   }
<span style="color: #ffff00; background-color: #ff0000; font-weight: bold;">    </span>
<span style="background-color: #404040;"> </span>   sharpen = ngx_http_image_filter_get_value(r, conf-&gt;shcv, conf-&gt;sharpen);
<span style="background-color: #404040;"> </span>   if (sharpen &gt; 0) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   gdImageSharpen(dst, sharpen);
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   out = ngx_http_image_out(r, ctx-&gt;type, dst, &amp;size);

<span style="background-color: #404040;"> </span>   ngx_log_debug3(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;log, 0,
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      <span style="color: #ad7fa8; font-style: italic;">"image: %d x %d %d"</span>, sx, sy, colors);

<span style="background-color: #404040;"> </span>   gdImageDestroy(dst);
<span style="background-color: #404040;"> </span>   ngx_pfree(r-&gt;pool, ctx-&gt;image);

<span style="background-color: #404040;"> </span>   if (out == NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NULL;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   cln = ngx_pool_cleanup_add(r-&gt;pool, 0);
<span style="background-color: #404040;"> </span>   if (cln == NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   gdFree(out);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NULL;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   b = ngx_pcalloc(r-&gt;pool, sizeof(ngx_buf_t));
<span style="background-color: #404040;"> </span>   if (b == NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   gdFree(out);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NULL;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   cln-&gt;handler = ngx_http_image_cleanup;
<span style="background-color: #404040;"> </span>   cln-&gt;data = out;

<span style="background-color: #404040;"> </span>   b-&gt;pos = out;
<span style="background-color: #404040;"> </span>   b-&gt;last = out + size;
<span style="background-color: #404040;"> </span>   b-&gt;memory = 1;
<span style="background-color: #404040;"> </span>   b-&gt;last_buf = 1;

<span style="background-color: #404040;"> </span>   ngx_http_image_length(r, b);

<span style="background-color: #404040;"> </span>   return b;
}


static gdImagePtr
ngx_http_image_source(ngx_http_request_t *r, ngx_http_image_filter_ctx_t *ctx)
{
<span style="background-color: #404040;"> </span>   char<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   *failed;
<span style="background-color: #404040;"> </span>   gdImagePtr   img;

<span style="background-color: #404040;"> </span>   img = NULL;

<span style="background-color: #404040;"> </span>   switch (ctx-&gt;type) {

<span style="background-color: #404040;"> </span>   case NGX_HTTP_IMAGE_JPEG:
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   img = gdImageCreateFromJpegPtr(ctx-&gt;length, ctx-&gt;image);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   failed = <span style="color: #ad7fa8; font-style: italic;">"gdImageCreateFromJpegPtr() failed"</span>;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   break;

<span style="background-color: #404040;"> </span>   case NGX_HTTP_IMAGE_GIF:
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   img = gdImageCreateFromGifPtr(ctx-&gt;length, ctx-&gt;image);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   failed = <span style="color: #ad7fa8; font-style: italic;">"gdImageCreateFromGifPtr() failed"</span>;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   break;

<span style="background-color: #404040;"> </span>   case NGX_HTTP_IMAGE_PNG:
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   img = gdImageCreateFromPngPtr(ctx-&gt;length, ctx-&gt;image);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   failed = <span style="color: #ad7fa8; font-style: italic;">"gdImageCreateFromPngPtr() failed"</span>;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   break;

<span style="background-color: #404040;"> </span>   default:
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   failed = <span style="color: #ad7fa8; font-style: italic;">"unknown image type"</span>;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   break;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   if (img == NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;log, 0, failed);
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   return img;
}


static gdImagePtr
ngx_http_image_new(ngx_http_request_t *r, int w, int h, int colors)
{
<span style="background-color: #404040;"> </span>   gdImagePtr  img;

<span style="background-color: #404040;"> </span>   if (colors == 0) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   img = gdImageCreateTrueColor(w, h);

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (img == NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;log, 0,
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     <span style="color: #ad7fa8; font-style: italic;">"gdImageCreateTrueColor() failed"</span>);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NULL;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   } else {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   img = gdImageCreate(w, h);

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (img == NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;log, 0,
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     <span style="color: #ad7fa8; font-style: italic;">"gdImageCreate() failed"</span>);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NULL;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   return img;
}


static u_char *
ngx_http_image_out(ngx_http_request_t *r, ngx_uint_t type, gdImagePtr img,
<span style="background-color: #404040;"> </span>   int *size)
{
<span style="background-color: #404040;"> </span>   char<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     *failed;
<span style="background-color: #404040;"> </span>   u_char<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   *out;
<span style="background-color: #404040;"> </span>   ngx_int_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     jq;
<span style="background-color: #404040;"> </span>   ngx_http_image_filter_conf_t  *conf;

<span style="background-color: #404040;"> </span>   out = NULL;

<span style="background-color: #404040;"> </span>   switch (type) {

<span style="background-color: #404040;"> </span>   case NGX_HTTP_IMAGE_JPEG:
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   conf = ngx_http_get_module_loc_conf(r, ngx_http_image_filter_module);

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   jq = ngx_http_image_filter_get_value(r, conf-&gt;jqcv, conf-&gt;jpeg_quality);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (jq &lt;= 0) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NULL;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   out = gdImageJpegPtr(img, size, jq);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   failed = <span style="color: #ad7fa8; font-style: italic;">"gdImageJpegPtr() failed"</span>;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   break;

<span style="background-color: #404040;"> </span>   case NGX_HTTP_IMAGE_GIF:
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   out = gdImageGifPtr(img, size);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   failed = <span style="color: #ad7fa8; font-style: italic;">"gdImageGifPtr() failed"</span>;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   break;

<span style="background-color: #404040;"> </span>   case NGX_HTTP_IMAGE_PNG:
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   out = gdImagePngPtr(img, size);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   failed = <span style="color: #ad7fa8; font-style: italic;">"gdImagePngPtr() failed"</span>;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   break;

<span style="background-color: #404040;"> </span>   default:
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   failed = <span style="color: #ad7fa8; font-style: italic;">"unknown image type"</span>;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   break;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   if (out == NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;log, 0, failed);
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   return out;
}


static void
ngx_http_image_cleanup(void *data)
{
<span style="background-color: #404040;"> </span>   gdFree(data);
}


static ngx_uint_t
ngx_http_image_filter_get_value(ngx_http_request_t *r,
<span style="background-color: #404040;"> </span>   ngx_http_complex_value_t *cv, ngx_uint_t v)
{
<span style="background-color: #404040;"> </span>   ngx_str_t  val;

<span style="background-color: #404040;"> </span>   if (cv == NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return v;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   if (ngx_http_complex_value(r, cv, &amp;val) != NGX_OK) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return 0;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   return ngx_http_image_filter_value(&amp;val);
}


static ngx_uint_t
ngx_http_image_filter_value(ngx_str_t *value)
{
<span style="background-color: #404040;"> </span>   ngx_int_t  n;

<span style="background-color: #404040;"> </span>   if (value-&gt;len == 1 &amp;&amp; value-&gt;data[0] == <span style="color: #ad7fa8; font-style: italic;">'-'</span>) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return (ngx_uint_t) -1;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   n = ngx_atoi(value-&gt;data, value-&gt;len);

<span style="background-color: #404040;"> </span>   if (n &gt; 0) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return (ngx_uint_t) n;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   return 0;
}


static void *
ngx_http_image_filter_create_conf(ngx_conf_t *cf)
{
<span style="background-color: #404040;"> </span>   ngx_http_image_filter_conf_t  *conf;

<span style="background-color: #404040;"> </span>   conf = ngx_pcalloc(cf-&gt;pool, sizeof(ngx_http_image_filter_conf_t));
<span style="background-color: #404040;"> </span>   if (conf == NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NULL;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="color: #888a85;">/*</span><span style="color: #888a85;">
     * set by ngx_pcalloc():
     *
     *     conf-&gt;width = 0;
     *     conf-&gt;height = 0;
     *     conf-&gt;angle = 0;
     *     conf-&gt;wcv = NULL;
     *     conf-&gt;hcv = NULL;
     *     conf-&gt;acv = NULL;
     *     conf-&gt;jqcv = NULL;
     *     conf-&gt;shcv = NULL;
     </span><span style="color: #888a85;">*/</span>

<span style="background-color: #404040;"> </span>   conf-&gt;filter = NGX_CONF_UNSET_UINT;
<span style="background-color: #404040;"> </span>   conf-&gt;jpeg_quality = NGX_CONF_UNSET_UINT;
<span style="background-color: #404040;"> </span>   conf-&gt;sharpen = NGX_CONF_UNSET_UINT;
<span style="background-color: #404040;"> </span>   conf-&gt;transparency = NGX_CONF_UNSET;
<span style="background-color: #404040;"> </span>   conf-&gt;buffer_size = NGX_CONF_UNSET_SIZE;
<span style="background-color: #404040;"> </span>   conf-&gt;watermark_transparency = NGX_CONF_UNSET_UINT;

<span style="background-color: #404040;"> </span>   return conf;
}


static char *
ngx_http_image_filter_merge_conf(ngx_conf_t *cf, void *parent, void *child)
{
<span style="background-color: #404040;"> </span>   ngx_http_image_filter_conf_t *prev = parent;
<span style="background-color: #404040;"> </span>   ngx_http_image_filter_conf_t *conf = child;

<span style="background-color: #404040;"> </span>   if (conf-&gt;filter == NGX_CONF_UNSET_UINT) {

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (prev-&gt;filter == NGX_CONF_UNSET_UINT) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   conf-&gt;filter = NGX_HTTP_IMAGE_OFF;

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   } else {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   conf-&gt;filter = prev-&gt;filter;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   conf-&gt;width = prev-&gt;width;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   conf-&gt;height = prev-&gt;height;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   conf-&gt;angle = prev-&gt;angle;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   conf-&gt;wcv = prev-&gt;wcv;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   conf-&gt;hcv = prev-&gt;hcv;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   conf-&gt;acv = prev-&gt;acv;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   if (conf-&gt;jpeg_quality == NGX_CONF_UNSET_UINT) {

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="color: #888a85;">/* </span><span style="color: #888a85;">75 is libjpeg default quality </span><span style="color: #888a85;">*/</span>
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ngx_conf_merge_uint_value(conf-&gt;jpeg_quality, prev-&gt;jpeg_quality, 75);

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (conf-&gt;jqcv == NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   conf-&gt;jqcv = prev-&gt;jqcv;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   if (conf-&gt;sharpen == NGX_CONF_UNSET_UINT) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ngx_conf_merge_uint_value(conf-&gt;sharpen, prev-&gt;sharpen, 0);

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (conf-&gt;shcv == NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   conf-&gt;shcv = prev-&gt;shcv;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   ngx_conf_merge_value(conf-&gt;transparency, prev-&gt;transparency, 1);

<span style="background-color: #404040;"> </span>   ngx_conf_merge_size_value(conf-&gt;buffer_size, prev-&gt;buffer_size,
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     1 * 1024 * 1024);

<span style="background-color: #404040;"> </span>   ngx_conf_merge_str_value(conf-&gt;watermark, prev-&gt;watermark, <span style="color: #ad7fa8; font-style: italic;">""</span>);

<span style="background-color: #404040;"> </span>   ngx_conf_merge_uint_value(conf-&gt;watermark_transparency,
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     prev-&gt;watermark_transparency, 90);
<span style="color: #ffff00; background-color: #ff0000; font-weight: bold;">    </span>
<span style="background-color: #404040;"> </span>   return NGX_CONF_OK;
}


static char *
ngx_http_image_filter(ngx_conf_t *cf, ngx_command_t *cmd, void *conf)
{
<span style="background-color: #404040;"> </span>   ngx_http_image_filter_conf_t *imcf = conf;

<span style="background-color: #404040;"> </span>   ngx_str_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>    *value;
<span style="background-color: #404040;"> </span>   ngx_int_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     n;
<span style="background-color: #404040;"> </span>   ngx_uint_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>    i;
<span style="background-color: #404040;"> </span>   ngx_http_complex_value_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      cv;
<span style="background-color: #404040;"> </span>   ngx_http_compile_complex_value_t   ccv;

<span style="background-color: #404040;"> </span>   value = cf-&gt;args-&gt;elts;

<span style="background-color: #404040;"> </span>   i = 1;

<span style="background-color: #404040;"> </span>   if (cf-&gt;args-&gt;nelts == 2) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (ngx_strcmp(value[i].data, <span style="color: #ad7fa8; font-style: italic;">"off"</span>) == 0) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   imcf-&gt;filter = NGX_HTTP_IMAGE_OFF;

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   } else if (ngx_strcmp(value[i].data, <span style="color: #ad7fa8; font-style: italic;">"test"</span>) == 0) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   imcf-&gt;filter = NGX_HTTP_IMAGE_TEST;

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   } else if (ngx_strcmp(value[i].data, <span style="color: #ad7fa8; font-style: italic;">"size"</span>) == 0) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   imcf-&gt;filter = NGX_HTTP_IMAGE_SIZE;

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   } else if (ngx_strcmp(value[i].data, <span style="color: #ad7fa8; font-style: italic;">"watermark"</span>) == 0) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   imcf-&gt;filter = NGX_HTTP_IMAGE_WATERMARK;
<span style="color: #ffff00; background-color: #ff0000; font-weight: bold;">            </span>
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   } else {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   goto failed;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NGX_CONF_OK;

<span style="background-color: #404040;"> </span>   } else if (cf-&gt;args-&gt;nelts == 3) {

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (ngx_strcmp(value[i].data, <span style="color: #ad7fa8; font-style: italic;">"rotate"</span>) == 0) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (imcf-&gt;filter != NGX_HTTP_IMAGE_RESIZE
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   &amp;&amp; imcf-&gt;filter != NGX_HTTP_IMAGE_CROP)
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   imcf-&gt;filter = NGX_HTTP_IMAGE_ROTATE;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ngx_memzero(&amp;ccv, sizeof(ngx_http_compile_complex_value_t));

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ccv.cf = cf;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ccv.value = &amp;value[++i];
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ccv.complex_value = &amp;cv;

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (ngx_http_compile_complex_value(&amp;ccv) != NGX_OK) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NGX_CONF_ERROR;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (cv.lengths == NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   n = ngx_http_image_filter_value(&amp;value[i]);

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (n != 90 &amp;&amp; n != 180 &amp;&amp; n != 270) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   goto failed;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   imcf-&gt;angle = (ngx_uint_t) n;

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   } else {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   imcf-&gt;acv = ngx_palloc(cf-&gt;pool,
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      sizeof(ngx_http_complex_value_t));
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (imcf-&gt;acv == NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NGX_CONF_ERROR;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   *imcf-&gt;acv = cv;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NGX_CONF_OK;

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   } else {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   goto failed;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   if (ngx_strcmp(value[i].data, <span style="color: #ad7fa8; font-style: italic;">"resize"</span>) == 0) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   imcf-&gt;filter = NGX_HTTP_IMAGE_RESIZE;

<span style="background-color: #404040;"> </span>   } else if (ngx_strcmp(value[i].data, <span style="color: #ad7fa8; font-style: italic;">"crop"</span>) == 0) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   imcf-&gt;filter = NGX_HTTP_IMAGE_CROP;

<span style="background-color: #404040;"> </span>   } else {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   goto failed;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   ngx_memzero(&amp;ccv, sizeof(ngx_http_compile_complex_value_t));

<span style="background-color: #404040;"> </span>   ccv.cf = cf;
<span style="background-color: #404040;"> </span>   ccv.value = &amp;value[++i];
<span style="background-color: #404040;"> </span>   ccv.complex_value = &amp;cv;

<span style="background-color: #404040;"> </span>   if (ngx_http_compile_complex_value(&amp;ccv) != NGX_OK) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NGX_CONF_ERROR;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   if (cv.lengths == NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   n = ngx_http_image_filter_value(&amp;value[i]);

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (n == 0) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   goto failed;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   imcf-&gt;width = (ngx_uint_t) n;

<span style="background-color: #404040;"> </span>   } else {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   imcf-&gt;wcv = ngx_palloc(cf-&gt;pool, sizeof(ngx_http_complex_value_t));
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (imcf-&gt;wcv == NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NGX_CONF_ERROR;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   *imcf-&gt;wcv = cv;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   ngx_memzero(&amp;ccv, sizeof(ngx_http_compile_complex_value_t));

<span style="background-color: #404040;"> </span>   ccv.cf = cf;
<span style="background-color: #404040;"> </span>   ccv.value = &amp;value[++i];
<span style="background-color: #404040;"> </span>   ccv.complex_value = &amp;cv;

<span style="background-color: #404040;"> </span>   if (ngx_http_compile_complex_value(&amp;ccv) != NGX_OK) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NGX_CONF_ERROR;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   if (cv.lengths == NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   n = ngx_http_image_filter_value(&amp;value[i]);

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (n == 0) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   goto failed;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   imcf-&gt;height = (ngx_uint_t) n;

<span style="background-color: #404040;"> </span>   } else {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   imcf-&gt;hcv = ngx_palloc(cf-&gt;pool, sizeof(ngx_http_complex_value_t));
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (imcf-&gt;hcv == NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NGX_CONF_ERROR;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   *imcf-&gt;hcv = cv;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   return NGX_CONF_OK;

failed:

<span style="background-color: #404040;"> </span>   ngx_conf_log_error(NGX_LOG_EMERG, cf, 0, <span style="color: #ad7fa8; font-style: italic;">"invalid parameter \"%V\""</span>,
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      &amp;value[i]);

<span style="background-color: #404040;"> </span>   return NGX_CONF_ERROR;
}


static char *
ngx_http_image_filter_jpeg_quality(ngx_conf_t *cf, ngx_command_t *cmd,
<span style="background-color: #404040;"> </span>   void *conf)
{
<span style="background-color: #404040;"> </span>   ngx_http_image_filter_conf_t *imcf = conf;

<span style="background-color: #404040;"> </span>   ngx_str_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>    *value;
<span style="background-color: #404040;"> </span>   ngx_int_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     n;
<span style="background-color: #404040;"> </span>   ngx_http_complex_value_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      cv;
<span style="background-color: #404040;"> </span>   ngx_http_compile_complex_value_t   ccv;

<span style="background-color: #404040;"> </span>   value = cf-&gt;args-&gt;elts;

<span style="background-color: #404040;"> </span>   ngx_memzero(&amp;ccv, sizeof(ngx_http_compile_complex_value_t));

<span style="background-color: #404040;"> </span>   ccv.cf = cf;
<span style="background-color: #404040;"> </span>   ccv.value = &amp;value[1];
<span style="background-color: #404040;"> </span>   ccv.complex_value = &amp;cv;

<span style="background-color: #404040;"> </span>   if (ngx_http_compile_complex_value(&amp;ccv) != NGX_OK) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NGX_CONF_ERROR;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   if (cv.lengths == NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   n = ngx_http_image_filter_value(&amp;value[1]);

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (n &lt;= 0) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      <span style="color: #ad7fa8; font-style: italic;">"invalid value \"%V\""</span>, &amp;value[1]);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NGX_CONF_ERROR;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   imcf-&gt;jpeg_quality = (ngx_uint_t) n;

<span style="background-color: #404040;"> </span>   } else {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   imcf-&gt;jqcv = ngx_palloc(cf-&gt;pool, sizeof(ngx_http_complex_value_t));
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (imcf-&gt;jqcv == NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NGX_CONF_ERROR;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   *imcf-&gt;jqcv = cv;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   return NGX_CONF_OK;
}


static char *
ngx_http_image_filter_sharpen(ngx_conf_t *cf, ngx_command_t *cmd,
<span style="background-color: #404040;"> </span>   void *conf)
{
<span style="background-color: #404040;"> </span>   ngx_http_image_filter_conf_t *imcf = conf;

<span style="background-color: #404040;"> </span>   ngx_str_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>    *value;
<span style="background-color: #404040;"> </span>   ngx_int_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>     n;
<span style="background-color: #404040;"> </span>   ngx_http_complex_value_t<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      cv;
<span style="background-color: #404040;"> </span>   ngx_http_compile_complex_value_t   ccv;

<span style="background-color: #404040;"> </span>   value = cf-&gt;args-&gt;elts;

<span style="background-color: #404040;"> </span>   ngx_memzero(&amp;ccv, sizeof(ngx_http_compile_complex_value_t));

<span style="background-color: #404040;"> </span>   ccv.cf = cf;
<span style="background-color: #404040;"> </span>   ccv.value = &amp;value[1];
<span style="background-color: #404040;"> </span>   ccv.complex_value = &amp;cv;

<span style="background-color: #404040;"> </span>   if (ngx_http_compile_complex_value(&amp;ccv) != NGX_OK) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NGX_CONF_ERROR;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   if (cv.lengths == NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   n = ngx_http_image_filter_value(&amp;value[1]);

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (n &lt; 0) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>      <span style="color: #ad7fa8; font-style: italic;">"invalid value \"%V\""</span>, &amp;value[1]);
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NGX_CONF_ERROR;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   imcf-&gt;sharpen = (ngx_uint_t) n;

<span style="background-color: #404040;"> </span>   } else {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   imcf-&gt;shcv = ngx_palloc(cf-&gt;pool, sizeof(ngx_http_complex_value_t));
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   if (imcf-&gt;shcv == NULL) {
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   return NGX_CONF_ERROR;
<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   <span style="background-color: #404040;"> </span>   *imcf-&gt;shcv = cv;
<span style="background-color: #404040;"> </span>   }

<span style="background-color: #404040;"> </span>   return NGX_CONF_OK;
}


static ngx_int_t
ngx_http_image_filter_init(ngx_conf_t *cf)
{
<span style="background-color: #404040;"> </span>   ngx_http_next_header_filter = ngx_http_top_header_filter;
<span style="background-color: #404040;"> </span>   ngx_http_top_header_filter = ngx_http_image_header_filter;

<span style="background-color: #404040;"> </span>   ngx_http_next_body_filter = ngx_http_top_body_filter;
<span style="background-color: #404040;"> </span>   ngx_http_top_body_filter = ngx_http_image_body_filter;

<span style="background-color: #404040;"> </span>   return NGX_OK;
}
</pre></div></div>


</div>

</div>

<div id="outline-container-3-3" class="outline-4">
<h4 id="sec-3-3">编译</h4>
<div class="outline-text-4" id="text-3-3">




<pre class="src src-sh">--with-debug --with-http_image_filter_module --add-module=/home/tangxinfa/Openso<span style="text-decoration: underline;">urce/nginx-1.2.7/../ngx_http_qrcode_module/ --add-module=/home/tangxinfa/Opensource/nginx-1.2.7/../ngx_devel_kit/ --add-module=/home/tangxinfa/Opensource/nginx-1.2.7/../set-misc-nginx-module/ --add-module=/home/tangxinfa/Opensource/nginx-1.2.7/../echo-nginx-module/</span>
</pre>


</div>

</div>

<div id="outline-container-3-4" class="outline-4">
<h4 id="sec-3-4">配置</h4>
<div class="outline-text-4" id="text-3-4">




<pre class="example">location ~ /qr {
    qrcode_fg_color FF0000;
    qrcode_bg_color FFFFFF;    
    qrcode_level 2;
    qrcode_hint 2;
    qrcode_size 120;
    qrcode_margin 2;
    qrcode_version 5;
    set_unescape_uri $txt $arg_txt;
    qrcode_txt $txt;
    qrcode_casesensitive 1; 
    qrcode_gen;  

    image_filter_watermark "/usr/share/pixmaps/gnome-word.png";
    image_filter_watermark_transparency 95; #0-100
    image_filter watermark;
}
</pre>


</div>

</div>

<div id="outline-container-3-5" class="outline-4">
<h4 id="sec-3-5">访问</h4>
<div class="outline-text-4" id="text-3-5">




<pre class="example">http://localhost:8080/qr?txt=hello
</pre>

<ul>
<li>显示效果：
</li>
</ul>

<p>     <img src="../../../posts/2013/03/30_4e8c7ef4780178147a76/hello_qr.png"  alt="../../../posts/2013/03/30_4e8c7ef4780178147a76/hello_qr.png" />
</p>
</div>
</div>

</div>

<div id="outline-container-4" class="outline-3">
<h3 id="sec-4">二维码基础服务的一点思索</h3>
<div class="outline-text-3" id="text-4">

<ul>
<li>必须建立在cdn的基础上
</li>
<li>用户只需按照约定将内容以及定制参数按照直观的方式编码成二维码图片链接即可
</li>
</ul>


<p>
   参考：<a href="https://developers.google.com/chart/infographics/docs/qr_codes">https://developers.google.com/chart/infographics/docs/qr_codes</a>
</p></div>
</div>

  </div>
  
  <footer class="article-footer">
    <nav class="tag-cloud">
      <ul>
	<li class="label label-inverse small"><a href="../../../tags/qrcode.html">qrcode</a></li>
      </ul>
    </nav>
    <span class="muted">
      发布于 <time datetime="2013-03-30T11:21:00Z"> 2013-03-30 11:21</time>
    </span>
  </footer>
  </div>
  <div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'kankananblog'; // required: replace example with your forum shortname
  var disqus_url = 'http://blog.kankanan.com/posts/2013/03/30_4e8c7ef4780178147a76.html';

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

      </div>
      <div id="sidebar" class="span3">
        <h5>最新文章</h5>
        <div id="recent-posts">
          <ul>
            <li><a href="../../../posts/2014/04/01_8bba575b88ab6302669794fe95ee9898520667904e0e89e351b3.html">论坛被挂暗链问题分析与解决</a></li> <li><a href="../../../posts/2014/03/12_archlinux7f517edc63a553e34e0a51fa73b04e244e2aip.html">Archlinux网络接口上出现两个IP</a></li> <li><a href="../../../posts/2014/03/10_5f006e90987976ee7ba174067cfb7edfff1atrac.html">开源项目管理系统：trac</a></li> <li><a href="../../../index.html">python应用国际化：Babel</a></li> <li><a href="../../../posts/2014/03/07_centos-62e44e0b5b8988c5redmine.html">CentOS 6.4下安装redmine</a></li> <li><a href="../../../posts/2014/02/17_7f168bd15b8988c5redis.html">编译安装redis</a></li> <li><a href="../../../posts/2014/02/17_7f168bd15b8988c5node2ejs.html">编译安装node.js</a></li> <li><a href="../../../posts/2014/02/14_express2ejs4e2d59824f5557287b2c4e006b218bf76c42768454cd5e944e2d53d65f97connect2esid.html">express.js中如何在第一次请求的响应中取得connect.sid</a></li> <li><a href="../../../posts/2013/12/26_linux4e0b51418bb8666e901a752862376267884c97008981root674396507684547d4ee4.html">linux下允许普通用户执行需要root权限的命令</a></li> <li><a href="../../../posts/2013/12/20_4e3a4ec04e484e0d80fd57286784902051fd65704e2d8c037528shared5ffrom5fthis.html">为什么不能在构造函数中调用shared_from_this</a></li> 
          </ul>
        </div>
	    <h5>标签</h5>
        <div id="tags">
	      <ul>
  <li style="font-size: 220.00%;"><a href="../../../tags/archlinux.html">archlinux</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/babel.html">babel</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/bitbucket.html">bitbucket</a></li> <li style="font-size: 115.00%;"><a href="../../../tags/c.html">c</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/chosen.html">chosen</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/comet.html">comet</a></li> <li style="font-size: 115.00%;"><a href="../../../tags/cpp.html">cpp</a></li> <li style="font-size: 115.00%;"><a href="../../../tags/discuz.html">discuz</a></li> <li style="font-size: 115.00%;"><a href="../../../tags/emacs.html">emacs</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/english.html">english</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/fcitx.html">fcitx</a></li> <li style="font-size: 115.00%;"><a href="../../../tags/hash.html">hash</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/hg.html">hg</a></li> <li style="font-size: 115.00%;"><a href="../../../tags/http.html">http</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/jabber.html">jabber</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/jquery.html">jquery</a></li> <li style="font-size: 220.00%;"><a href="../../../tags/linux.html">linux</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/log4cxx.html">log4cxx</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/log4php.html">log4php</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/memcached.html">memcached</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/mongodb.html">mongodb</a></li> <li style="font-size: 150.00%;"><a href="../../../tags/mysql.html">mysql</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/network.html">network</a></li> <li style="font-size: 150.00%;"><a href="../../../tags/nginx.html">nginx</a></li> <li style="font-size: 185.00%;"><a href="../../../tags/node.html">node</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/o-blog.html">o-blog</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/openssl.html">openssl</a></li> <li style="font-size: 185.00%;"><a href="../../../tags/php.html">php</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/pomodoro.html">pomodoro</a></li> <li style="font-size: 220.00%;"><a href="../../../tags/python.html">python</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/qrcode.html">qrcode</a></li> <li style="font-size: 220.00%;"><a href="../../../tags/redis.html">redis</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/redmine.html">redmine</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/security.html">security</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/spdy.html">spdy</a></li> <li style="font-size: 80.00%;"><a href="../../../tags/trac.html">trac</a></li> <li style="font-size: 185.00%;"><a href="../../../tags/web.html">web</a></li> 
</ul>

        </div>
        <h5>最新评论</h5>
        <div id="recent-comments">
          <script src="http://kankananblog.disqus.com/recent_comments_widget.js?num_items=5&hide_avatars=0&avatar_size=32&excerpt_length=100" type="text/javascript"></script>
        </div>
      </div>
    </div>
  </div>
  <div id="footer">
	<div class="copyright" style="text-align: center;">
	  <p>
版权所有 © 2011-2013 看看俺 – KanKanAn.com
</p>
	  <p>Powered by <a href="https://github.com/renard/o-blog">o-blog</a>.</p>
	</div>
  </div>
</body>
</html>

