<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>看看俺 - KanKanAn.com</title>
  <link href="http://blog.kankanan.comindex.xml" rel="self" />
  <link href="http://blog.kankanan.com"/>
  <updated>2013-04-09T12:00:00Z</updated>
  <id>http://blog.kankanan.comindex.xml</id>
  <entry><title type="html">log4php初步使用</title><author><name>nil</name></author><link href="http://blog.kankanan.com/posts/2013/05/06_log4php521d6b654f7f7528.html"/><updated>2013-05-06T18:32:00Z</updated><published>2013-05-06T18:32:00Z</published><id>posts/2013/05/06_log4php521d6b654f7f7528.html</id><category scheme="/tags/log4php.html" term="log4php" label="log4php"/><content type="html">&lt;div id="outline-container-1" class="outline-3"&gt;
&lt;h3 id="sec-1"&gt;&#31616;&#20171;&lt;/h3&gt;
&lt;div class="outline-text-3" id="text-1"&gt;

&lt;p&gt;   apache&#20986;&#21697;&#24517;&#23646;&#31934;&#21697;&#12290;&#27491;&#23447;php&#26085;&#24535;&#24211;&#65292;&#19982;log4j&#19968;&#33033;&#30456;&#25215;&#12290;
&lt;/p&gt;
&lt;p&gt;
   &lt;a href="http://logging.apache.org/log4php/"&gt;http://logging.apache.org/log4php/&lt;/a&gt;
&lt;/p&gt;
&lt;/div&gt;

&lt;/div&gt;

&lt;div id="outline-container-2" class="outline-3"&gt;
&lt;h3 id="sec-2"&gt;&#23433;&#35013;&lt;/h3&gt;
&lt;div class="outline-text-3" id="text-2"&gt;

&lt;p&gt;   &#21442;&#32771;&#65306;&lt;a href="http://logging.apache.org/log4php/install.html"&gt;http://logging.apache.org/log4php/install.html&lt;/a&gt;
&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&#26377;root&#26435;&#38480;&#65292;&#23433;&#35013;&#21040;&#31995;&#32479;&#30446;&#24405;




&lt;pre class="src src-sh"&gt;sudo apt-get install php-pear
sudo pear channel-discover pear.apache.org/log4php
sudo pear install log4php/Apache_log4php
&lt;/pre&gt;


&lt;/li&gt;
&lt;li&gt;&#27809;&#26377;root&#26435;&#38480;&#65292;&#23433;&#35013;&#21040;&#24403;&#21069;&#30446;&#24405;&#19979;




&lt;pre class="src src-sh"&gt;&lt;span style="color: #729fcf;"&gt;cd&lt;/span&gt; libs
wget http://mirrors.tuna.tsinghua.edu.cn/apache/logging/log4php/2.3.0/apache-log4php-2.3.0-src.tar.gz
tar xzvf apache-log4php-2.3.0-src.tar.gz
ln -sf apache-log4php-2.3.0/src/main/php ./log4php
&lt;/pre&gt;

&lt;/li&gt;
&lt;/ul&gt;


&lt;/div&gt;

&lt;/div&gt;

&lt;div id="outline-container-3" class="outline-3"&gt;
&lt;h3 id="sec-3"&gt;&#20351;&#29992;&lt;/h3&gt;
&lt;div class="outline-text-3" id="text-3"&gt;


&lt;ul&gt;
&lt;li&gt;&#36827;&#34892;&#19968;&#19979;&#23553;&#35013;&#23450;&#21046;&#65292;&#21487;&#20197;&#28385;&#36275;&#32477;&#22823;&#37096;&#20998;&#24773;&#20917;&#19979;&#30340;&#20351;&#29992;

&lt;ul&gt;
&lt;li&gt;&#31867;&#20284;nginx&#30340;&#35775;&#38382;&#26085;&#24535;&#35760;&#24405;&#26684;&#24335;
&lt;/li&gt;
&lt;li&gt;&#26085;&#24535;&#20013;&#36755;&#20986;&#25991;&#20214;&#21517;&#21450;&#34892;&#21495;
&lt;/li&gt;
&lt;li&gt;&#26085;&#24535;&#25991;&#20214;&#25968;&#25454;&#38480;&#21046;&#20026;10&#20010;&#65292;&#27599;&#20010;&#26085;&#24535;&#25991;&#20214;&#22823;&#23567;&#20026;10MB
&lt;/li&gt;
&lt;/ul&gt;

&lt;/li&gt;
&lt;/ul&gt;




&lt;div class="o-blog-source"&gt;&lt;a class="btn btn-info" data-toggle="modal" data-target="#logging2einc" &gt;&lt;i class="icon-file icon-white"&gt;&lt;/i&gt;&amp;nbsp;logging.inc&lt;/a&gt;&lt;/div&gt;&lt;div class="modal fade hide" id="logging2einc"&gt;&lt;div class="modal-header"&gt;&lt;a class="close" data-dismiss="modal"&gt;&#215;&lt;/a&gt;&lt;h3&gt;logging.inc&lt;/h3&gt;&lt;/div&gt;&lt;div class="modal-body"&gt;&lt;pre&gt;
&lt;span style="color: #729fcf;"&gt;&amp;lt;?php&lt;/span&gt;
  &lt;span style="color: #888a85;"&gt;/// &lt;/span&gt;&lt;span style="color: #888a85;"&gt;please define LOGGING_APPNAME before include this file.
&lt;/span&gt;  &lt;span style="color: #888a85;"&gt;/// &lt;/span&gt;&lt;span style="color: #888a85;"&gt;e.g:
&lt;/span&gt;  &lt;span style="color: #888a85;"&gt;///    &lt;/span&gt;&lt;span style="color: #888a85;"&gt;define('LOGGING_APPNAME', 'example_app');
&lt;/span&gt;  &lt;span style="color: #888a85;"&gt;///    &lt;/span&gt;&lt;span style="color: #888a85;"&gt;require_once(dirname(__FILE__) . "/logging.inc");
&lt;/span&gt;
&lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt;(&lt;span style="color: #eeeeec; background-color: #2e3436;"&gt;file_exists(dirname(&lt;/span&gt;&lt;span style="color: #8ae234;"&gt;__FILE__&lt;/span&gt;) . &lt;span style="color: #ad7fa8; font-style: italic;"&gt;'/libs/log4php/Logger.php'&lt;/span&gt;)){
  &lt;span style="color: #729fcf; font-weight: bold;"&gt;require_once&lt;/span&gt;(&lt;span style="color: #eeeeec; background-color: #2e3436;"&gt;dirname(&lt;/span&gt;&lt;span style="color: #8ae234;"&gt;__FILE__&lt;/span&gt;) . &lt;span style="color: #ad7fa8; font-style: italic;"&gt;'/libs/log4php/Logger.php'&lt;/span&gt;);
}&lt;span style="color: #729fcf; font-weight: bold;"&gt;else&lt;/span&gt;{
  &lt;span style="color: #729fcf; font-weight: bold;"&gt;require_once&lt;/span&gt;(&lt;span style="color: #ad7fa8; font-style: italic;"&gt;'log4php/Logger.php'&lt;/span&gt;);
}

&lt;span style="color: #8ae234; font-weight: bold;"&gt;Logger&lt;/span&gt;::&lt;span style="color: #eeeeec; background-color: #2e3436;"&gt;configure(array(&lt;/span&gt;&lt;span style="color: #ad7fa8; font-style: italic;"&gt;'rootLogger'&lt;/span&gt; =&lt;span style="color: #8ae234;"&gt;&amp;gt;&lt;/span&gt; &lt;span style="color: #eeeeec; background-color: #2e3436;"&gt;array(&lt;/span&gt;&lt;span style="color: #ad7fa8; font-style: italic;"&gt;'appenders'&lt;/span&gt; =&amp;gt; &lt;span style="color: #eeeeec; background-color: #2e3436;"&gt;array(&lt;/span&gt;&lt;span style="color: #ad7fa8; font-style: italic;"&gt;'default'&lt;/span&gt;)),
                        &lt;span style="color: #ad7fa8; font-style: italic;"&gt;'appenders'&lt;/span&gt; =&amp;gt; &lt;span style="color: #eeeeec; background-color: #2e3436;"&gt;array(&lt;/span&gt;&lt;span style="color: #ad7fa8; font-style: italic;"&gt;'default'&lt;/span&gt; =&amp;gt; &lt;span style="color: #eeeeec; background-color: #2e3436;"&gt;array(&lt;/span&gt;&lt;span style="color: #ad7fa8; font-style: italic;"&gt;'class'&lt;/span&gt; =&amp;gt; &lt;span style="color: #ad7fa8; font-style: italic;"&gt;'LoggerAppenderRollingFile'&lt;/span&gt;,
                                                                &lt;span style="color: #ad7fa8; font-style: italic;"&gt;'layout'&lt;/span&gt; =&amp;gt; &lt;span style="color: #eeeeec; background-color: #2e3436;"&gt;array(&lt;/span&gt;&lt;span style="color: #ad7fa8; font-style: italic;"&gt;'class'&lt;/span&gt; =&amp;gt; &lt;span style="color: #ad7fa8; font-style: italic;"&gt;'LoggerLayoutPattern'&lt;/span&gt;,
                                                                                  &lt;span style="color: #ad7fa8; font-style: italic;"&gt;'params'&lt;/span&gt; =&amp;gt; &lt;span style="color: #eeeeec; background-color: #2e3436;"&gt;array(&lt;/span&gt;&lt;span style="color: #ad7fa8; font-style: italic;"&gt;'conversionPattern'&lt;/span&gt; =&amp;gt; &lt;span style="color: #ad7fa8; font-style: italic;"&gt;'%date{Y-m-d H:i:s,u} [%level] %logger: %msg (%F:%L)%newline%ex'&lt;/span&gt;)),
                                                                &lt;span style="color: #ad7fa8; font-style: italic;"&gt;'params'&lt;/span&gt; =&amp;gt; &lt;span style="color: #eeeeec; background-color: #2e3436;"&gt;array(&lt;/span&gt;&lt;span style="color: #ad7fa8; font-style: italic;"&gt;'file'&lt;/span&gt; =&amp;gt; &lt;span style="color: #eeeeec; background-color: #2e3436;"&gt;dirname(&lt;/span&gt;&lt;span style="color: #8ae234;"&gt;__FILE__&lt;/span&gt;) . &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"/logs/"&lt;/span&gt; . &lt;span style="color: #f57900; font-weight: bold;"&gt;LOGGING_APPNAME&lt;/span&gt; . &lt;span style="color: #ad7fa8; font-style: italic;"&gt;".log"&lt;/span&gt;,
                                                                                  &lt;span style="color: #ad7fa8; font-style: italic;"&gt;'append'&lt;/span&gt; =&amp;gt; &lt;span style="color: #8ae234;"&gt;true&lt;/span&gt;,
                                                                                  &lt;span style="color: #ad7fa8; font-style: italic;"&gt;'maxFileSize'&lt;/span&gt; =&amp;gt; &lt;span style="color: #ad7fa8; font-style: italic;"&gt;'10MB'&lt;/span&gt;,
                                                                                  &lt;span style="color: #ad7fa8; font-style: italic;"&gt;'maxBackupIndex'&lt;/span&gt; =&amp;gt; &lt;span style="color: #eeeeec; background-color: #2e3436;"&gt;10&lt;/span&gt;)))));&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;


&lt;ul&gt;
&lt;li&gt;&#20351;&#29992;&#31034;&#20363;

&lt;p&gt;
      &lt;code&gt;example.php&lt;/code&gt;
&lt;/p&gt;


&lt;pre class="src src-php"&gt;&lt;span style="color: #729fcf;"&gt;&amp;lt;?php&lt;/span&gt;
&lt;span style="color: #eeeeec; background-color: #2e3436;"&gt;define(&lt;/span&gt;&lt;span style="color: #ad7fa8; font-style: italic;"&gt;'LOGGING_APPNAME'&lt;/span&gt;, &lt;span style="color: #ad7fa8; font-style: italic;"&gt;'example'&lt;/span&gt;);
&lt;span style="color: #729fcf; font-weight: bold;"&gt;require_once&lt;/span&gt;(&lt;span style="color: #eeeeec; background-color: #2e3436;"&gt;dirname(&lt;/span&gt;&lt;span style="color: #8ae234;"&gt;__FILE__&lt;/span&gt;) . &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"/logging.inc"&lt;/span&gt;);

$&lt;span style="color: #eeeeec;"&gt;logger&lt;/span&gt; = &lt;span style="color: #8ae234; font-weight: bold;"&gt;Logger&lt;/span&gt;::&lt;span style="color: #eeeeec; background-color: #2e3436;"&gt;getLogger(&lt;/span&gt;&lt;span style="color: #ad7fa8; font-style: italic;"&gt;"main"&lt;/span&gt;);
$&lt;span style="color: #eeeeec;"&gt;logger&lt;/span&gt;-&lt;span style="color: #8ae234;"&gt;&amp;gt;&lt;/span&gt;&lt;span style="color: #eeeeec; background-color: #2e3436;"&gt;debug&lt;/span&gt;(&lt;span style="color: #ad7fa8; font-style: italic;"&gt;"info log"&lt;/span&gt;);
$&lt;span style="color: #eeeeec;"&gt;logger&lt;/span&gt;-&amp;gt;&lt;span style="color: #eeeeec; background-color: #2e3436;"&gt;warn&lt;/span&gt;(&lt;span style="color: #ad7fa8; font-style: italic;"&gt;"info log"&lt;/span&gt;);
$&lt;span style="color: #eeeeec;"&gt;logger&lt;/span&gt;-&amp;gt;&lt;span style="color: #eeeeec; background-color: #2e3436;"&gt;error&lt;/span&gt;(&lt;span style="color: #ad7fa8; font-style: italic;"&gt;"info log"&lt;/span&gt;);
&lt;span style="color: #729fcf;"&gt;?&amp;gt;&lt;/span&gt;
&lt;/pre&gt;


&lt;/li&gt;
&lt;li&gt;&#36816;&#34892;&#32467;&#26524;




&lt;pre class="src src-sh"&gt;$ php ./example.php
$ tail -f ./logs/example.log
2013-05-06 18:24:57,925 [DEBUG] main: info log (/home/tangxinfa/php/example.php:6)
2013-05-06 18:24:57,930 [WARN] main: info log (/home/tangxinfa/php/example.php:7)
2013-05-06 18:24:57,930 [ERROR] main: info log (/home/tangxinfa/php/example.php:8)
&lt;/pre&gt;

&lt;/li&gt;
&lt;/ul&gt;

&lt;/div&gt;
&lt;/div&gt;
</content></entry><entry><title type="html">使用o-blog搭建个人博客</title><author><name>nil</name></author><link href="http://blog.kankanan.com/index.html"/><updated>2013-04-09T12:30:00Z</updated><published>2013-04-09T12:30:00Z</published><id>index.html</id><category scheme="/tags/o-blog.html" term="o-blog" label="o-blog"/><content type="html">&lt;p&gt;
  &#26032;&#30340;&#21338;&#23458;&#20351;&#29992;&lt;a href="http://renard.github.com/o-blog"&gt;o-blog&lt;/a&gt;&#25645;&#24314;&#65292;&#20351;&#29992;&#30340;&#26159;&#33258;&#24050;&#30340;&#20998;&#26525;&lt;a href="https://github.com/tangxinfa/o-blog"&gt;tangxinfa-o-blog&lt;/a&gt;&#65292;&#25105;&#30340;&#20998;&#26525;&#20027;&#35201;&#26159;&#23545;&#21407;&#31995;&#32479;&#20570;&#20102;&#19968;&#23450;&#30340;&#31616;&#21270;&#20197;&#20415;&#36866;&#29992;&#20110;&#21019;&#24314;&#20010;&#20154;&#21338;&#23458;&#65292;&#21478;&#20462;&#22797;&#20102;&#19968;&#20123;bug&#65288;&#20027;&#35201;&#26159;&#20013;&#25991;&#30456;&#20851;&#65289;&#65292;&#21487;&#20351;&#29992;&#20197;&#19979;&#37197;&#32622;&#23433;&#35013;&#25105;&#30340;&#20998;&#26525;&#65306;
&lt;/p&gt;


&lt;pre class="src src-lisp"&gt;(setq el-get-sources '((&lt;span style="color: #729fcf;"&gt;:name&lt;/span&gt; tangxinfa-o-blog
                                  &lt;span style="color: #729fcf;"&gt;:type&lt;/span&gt; git 
                                  &lt;span style="color: #729fcf;"&gt;:url&lt;/span&gt; &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"https://github.com/tangxinfa/o-blog.git"&lt;/span&gt;
                                  &lt;span style="color: #729fcf;"&gt;:load&lt;/span&gt; &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"o-blog.el"&lt;/span&gt;
                                  &lt;span style="color: #729fcf;"&gt;:features&lt;/span&gt; o-blog)))
&lt;/pre&gt;


&lt;pre class="src src-sh"&gt;M-x el-get-install tangxinfa-o-blog
&lt;/pre&gt;


&lt;p&gt;
  &#20855;&#20307;&#20351;&#29992;&#21487;&#21442;&#32771;&#26412;&#21338;&#23458;&#30340;&#21407;&#22987;org&#25991;&#20214;&#65306;
&lt;/p&gt;



&lt;pre class="src src-sh"&gt;git clone https://github.com/tangxinfa/tangxinfa.github.com.git
&lt;/pre&gt;

</content></entry><entry><title type="html">如何学习英语</title><author><name>nil</name></author><link href="http://blog.kankanan.com/posts/2013/04/07_59824f555b664e6082f18bed.html"/><updated>2013-04-07T09:49:00Z</updated><published>2013-04-07T09:49:00Z</published><id>posts/2013/04/07_59824f555b664e6082f18bed.html</id><category scheme="/tags/english.html" term="english" label="english"/><content type="html">&lt;p&gt;
  &#32463;&#36807;&#19968;&#22825;&#30340;&#33521;&#23386;&#21450;&#38886;&#21338;&#35797;&#21548;&#65292;&#24635;&#32467;&#20986;&#20197;&#19979;&#20960;&#28857;&#65306;
&lt;/p&gt;&lt;dl&gt;
&lt;dt&gt;&#35821;&#27861;&lt;/dt&gt;&lt;dd&gt;
&lt;p&gt;
    &#29087;&#35835;&#24120;&#29992;&#21477;&#22411;&#65292;&#25193;&#23637;&#33267;&#31867;&#20284;&#35821;&#21477;&#65292;&#20174;&#20013;&#25552;&#28860;&#35821;&#27861;&#65292;&#21478;&#19968;&#26041;&#38754;&#20063;&#21487;&#20197;&#32451;&#23601;&#19968;&#21475;&#27969;&#21033;&#30340;&#26085;&#29992;&#21475;&#35821;&#12290;
&lt;/p&gt;&lt;/dd&gt;
&lt;dt&gt;&#21548;&#21147;&lt;/dt&gt;&lt;dd&gt;
&lt;p&gt;
    &#19981;&#20250;&#35828;&#23601;&#19981;&#20250;&#21548;&#65292;&#22810;&#35828;&#25165;&#33021;&#22815;&#24555;&#36895;&#35782;&#21035;&#21548;&#21040;&#30340;&#19996;&#35199;&#12290;
&lt;/p&gt;&lt;/dd&gt;
&lt;dt&gt;&#38405;&#35835;&lt;/dt&gt;&lt;dd&gt;
&lt;p&gt;
    &#22810;&#35760;&#21333;&#35789;&#65292;&#19981;&#26029;&#30340;&#37325;&#22797;&#37325;&#22797;&#20877;&#37325;&#22797;&#65292;&#30452;&#21040;&#30475;&#21040;&#21333;&#35789;&#33073;&#21475;&#32780;&#20986;&#12290;
&lt;/p&gt;&lt;/dd&gt;
&lt;/dl&gt;


</content></entry><entry><title type="html">在emacs中如何以root权限使用gdb调试程序</title><author><name>nil</name></author><link href="http://blog.kankanan.com/posts/2013/03/30_5728emacs4e2d59824f554ee5root674396504f7f7528gdb8c038bd57a0b5e8f.html"/><updated>2013-03-30T14:21:00Z</updated><published>2013-03-30T14:21:00Z</published><id>posts/2013/03/30_5728emacs4e2d59824f554ee5root674396504f7f7528gdb8c038bd57a0b5e8f.html</id><category scheme="/tags/emacs.html" term="emacs" label="emacs"/><content type="html">&lt;ul&gt;
&lt;li&gt;&#30001;&#20110;M-x&#21629;&#20196;&#20013;&#20351;&#29992;sudo&#36755;&#20837;&#23494;&#30721;&#26080;&#25928;&#65292;&#38656;&#35201;&#37197;&#32622;&#20026;&#20801;&#35768;&#29992;&#25143;sudo gdb&#20813;&#23494;&#30721;
&lt;/li&gt;
&lt;/ul&gt;




&lt;pre class="example"&gt;visudo
# Allow user to sudo gdb without password
&#29992;&#25143; ALL=NOPASSWD: /usr/bin/gdb
&lt;/pre&gt;


&lt;ul&gt;
&lt;li&gt;&#20351;&#29992;root&#26435;&#38480;&#21551;&#21160;gdb
&lt;/li&gt;
&lt;/ul&gt;




&lt;pre class="example"&gt;M-x gdb
sudo gdb &amp;lt;program&amp;gt; &amp;lt;pid&amp;gt; --annotate=3
&lt;/pre&gt;

</content></entry><entry><title type="html">二维码研究</title><author><name>nil</name></author><link href="http://blog.kankanan.com/posts/2013/03/30_4e8c7ef4780178147a76.html"/><updated>2013-03-30T11:21:00Z</updated><published>2013-03-30T11:21:00Z</published><id>posts/2013/03/30_4e8c7ef4780178147a76.html</id><category scheme="/tags/qrcode.html" term="qrcode" label="qrcode"/><content type="html">&lt;div id="outline-container-1" class="outline-3"&gt;
&lt;h3 id="sec-1"&gt;&#20171;&#32461;&lt;/h3&gt;
&lt;div class="outline-text-3" id="text-1"&gt;

&lt;dl&gt;
&lt;dt&gt;&lt;a href="http://www.itsc.org.sg/pdf/synthesis08/Three_QR_Code.pdf"&gt;Three_QR_Code.pdf&lt;/a&gt;&lt;/dt&gt;&lt;dd&gt;
&lt;p&gt;
     RFC&#24335;&#30340;&#25991;&#26723;
&lt;/p&gt;
&lt;/dd&gt;
&lt;dt&gt;&lt;a href="http://suflow.iteye.com/blog/1100678"&gt;&#20108;&#32500;&#30721; &#32534;&#30721;&#21407;&#29702;&#31616;&#20171;&lt;/a&gt;&lt;/dt&gt;&lt;dd&gt;
&lt;p&gt;
     &#36890;&#20439;&#26131;&#25026;&#30340;&#32534;&#30721;&#32454;&#33410;&#20171;&#32461;
&lt;/p&gt;
&lt;/dd&gt;
&lt;dt&gt;&lt;a href="http://zh.wikipedia.org/wiki/QR&#30908;"&gt;QR&#30908; - &#32500;&#22522;&#30334;&#31185;&#65292;&#33258;&#30001;&#30340;&#30334;&#31185;&#20840;&#20070;&lt;/a&gt;&lt;/dt&gt;&lt;dd&gt;

&lt;/dd&gt;
&lt;dt&gt;&lt;a href="http://www.qrstuff.com/blog/2011/11/23/qr-code-minimum-size"&gt;QR Code Minimum Size&lt;/a&gt; &#19982; &lt;a href="http://www.qrstuff.com/blog/2011/01/18/what-size-should-a-qr-code-be"&gt;What Size Should A Printed QR Code Be?&lt;/a&gt;&lt;/dt&gt;&lt;dd&gt;
&lt;p&gt;
     &#20851;&#20110;&#21487;&#35782;&#21035;&#24615;&#30340;&#19968;&#20123;&#32467;&#35770;&#65292;&#35813;&#32593;&#31449;&#19978;&#26377;&#22823;&#37327;&#20108;&#32500;&#30721;&#30740;&#31350;&#30456;&#20851;&#30340;&#25991;&#31456;
&lt;/p&gt;&lt;/dd&gt;
&lt;/dl&gt;


&lt;/div&gt;

&lt;/div&gt;

&lt;div id="outline-container-2" class="outline-3"&gt;
&lt;h3 id="sec-2"&gt;&#20108;&#32500;&#30721;&#24320;&#21457;&#24211;&lt;/h3&gt;
&lt;div class="outline-text-3" id="text-2"&gt;

&lt;dl&gt;
&lt;dt&gt;&lt;a href="https://github.com/fukuchi/libqrencode"&gt;libqrencode&lt;/a&gt;&lt;/dt&gt;&lt;dd&gt;
&lt;p&gt;
     &#22522;&#30784;&#30340;c&#35821;&#35328;&#20108;&#32500;&#30721;&#32534;&#30721;&#24211;&#65292;&#24456;&#22810;&#35821;&#35328;&#22522;&#20110;&#23427;&#24320;&#21457;&#25193;&#23637;&#65292;&#19981;&#21253;&#21547;&#29983;&#25104;png&#22270;&#30340;&#21151;&#33021;&#65292;&#22914;&#38656;&#29983;&#25104;png&#21487;&#21442;&#32771;&lt;a href="https://github.com/bitly/simplehttp/blob/master/qrencode/qrencode.c"&gt;&#36825;&#37324;&lt;/a&gt;
&lt;/p&gt;&lt;/dd&gt;
&lt;dt&gt;&lt;a href="https://github.com/jeromeetienne/jquery-qrcode"&gt;jquery-qrcode&lt;/a&gt;&lt;/dt&gt;&lt;dd&gt;
&lt;p&gt;
     &#20351;&#29992;javascript&#30452;&#25509;&#22312;&#23458;&#25143;&#31471;&#29983;&#25104;&#20108;&#32500;&#30721;&#65292;&#20013;&#25991;&#25903;&#25345;&#21442;&#35265;&lt;a href="http://suflow.iteye.com/blog/1687396"&gt;JS&#29983;&#25104;&#20108;&#32500;&#30721;&#65292;&#25903;&#25345;&#20013;&#25991;&#23383;&#31526;&lt;/a&gt;
&lt;/p&gt;&lt;/dd&gt;
&lt;dt&gt;&lt;a href="http://people.freebsd.org/~vanilla/qrencode-0.3.tar.bz2"&gt;php's qrencode extension&lt;/a&gt;&lt;/dt&gt;&lt;dd&gt;
&lt;p&gt;
     &#20351;&#29992;nginx&#30340;&#25193;&#23637;&#24615;&#33021;&#20250;&#26356;&#22909;&#19968;&#28857;&#65292;&#21442;&#32771;&#21518;&#38754;&lt;a href="#sec-3"&gt;nginx&#30340;&#30456;&#20851;&#25193;&#23637;&lt;/a&gt;.
&lt;/p&gt;&lt;/dd&gt;
&lt;dt&gt;&lt;a href="http://trac.koka-in.org/libdecodeqr"&gt;libdecodeqr&lt;/a&gt;&lt;/dt&gt;&lt;dd&gt;
&lt;p&gt;
     &#20108;&#32500;&#30721;&#35299;&#30721;&#24211;
&lt;/p&gt;&lt;/dd&gt;
&lt;/dl&gt;


&lt;/div&gt;

&lt;/div&gt;

&lt;div id="outline-container-3" class="outline-3"&gt;
&lt;h3 id="sec-3"&gt;nginx&#30340;&#30456;&#20851;&#25193;&#23637;&lt;/h3&gt;
&lt;div class="outline-text-3" id="text-3"&gt;


&lt;/div&gt;

&lt;div id="outline-container-3-1" class="outline-4"&gt;
&lt;h4 id="sec-3-1"&gt;&#22522;&#26412;&#30340;&#20108;&#32500;&#30721;&lt;/h4&gt;
&lt;div class="outline-text-4" id="text-3-1"&gt;

&lt;p&gt;    &lt;a href="https://github.com/dcshi/ngx_http_qrcode_module"&gt;ngx_http_qrcode_module&lt;/a&gt;
&lt;/p&gt;
&lt;/div&gt;

&lt;/div&gt;

&lt;div id="outline-container-3-2" class="outline-4"&gt;
&lt;h4 id="sec-3-2"&gt;&#20108;&#32500;&#30721;&#20010;&#24615;&#21270;&#27700;&#21360;&lt;/h4&gt;
&lt;div class="outline-text-4" id="text-3-2"&gt;

&lt;p&gt;   nginx_http_image_filter&#21152;&#19978;&lt;a href="http://forum.nginx.org/read.php?21,235958"&gt;&#27700;&#21360;&#34917;&#19969;&lt;/a&gt;&#21363;&#21487;&#12290;
&lt;/p&gt;
&lt;p&gt;
   &#19979;&#38754;&#30340;&#26159;&#32463;&#36807;&#20462;&#25913;&#21518;&#30340; &lt;code&gt;nginx image filter&lt;/code&gt; &#27169;&#22359;&#20195;&#30721;&#65292;&#21152;&#20837;&#23621;&#20013;&#30340;&#27700;&#21360;&#25928;&#26524;:
&lt;/p&gt;


&lt;div class="o-blog-source"&gt;&lt;a class="btn btn-info" data-toggle="modal" data-target="#ngx5fhttp5fimage5ffilter5fmodule2ec" &gt;&lt;i class="icon-file icon-white"&gt;&lt;/i&gt;&amp;nbsp;ngx_http_image_filter_module.c&lt;/a&gt;&lt;/div&gt;&lt;div class="modal fade hide" id="ngx5fhttp5fimage5ffilter5fmodule2ec"&gt;&lt;div class="modal-header"&gt;&lt;a class="close" data-dismiss="modal"&gt;&#215;&lt;/a&gt;&lt;h3&gt;ngx_http_image_filter_module.c&lt;/h3&gt;&lt;/div&gt;&lt;div class="modal-body"&gt;&lt;pre&gt;

&lt;span style="color: #888a85;"&gt;/*&lt;/span&gt;&lt;span style="color: #888a85;"&gt;
 * Copyright (C) Igor Sysoev
 * Copyright (C) Nginx, Inc.
 &lt;/span&gt;&lt;span style="color: #888a85;"&gt;*/&lt;/span&gt;


&lt;span style="color: #729fcf;"&gt;#include&lt;/span&gt; &lt;span style="color: #ad7fa8; font-style: italic;"&gt;&amp;lt;ngx_config.h&amp;gt;&lt;/span&gt;
&lt;span style="color: #729fcf;"&gt;#include&lt;/span&gt; &lt;span style="color: #ad7fa8; font-style: italic;"&gt;&amp;lt;ngx_core.h&amp;gt;&lt;/span&gt;
&lt;span style="color: #729fcf;"&gt;#include&lt;/span&gt; &lt;span style="color: #ad7fa8; font-style: italic;"&gt;&amp;lt;ngx_http.h&amp;gt;&lt;/span&gt;

&lt;span style="color: #729fcf;"&gt;#include&lt;/span&gt; &lt;span style="color: #ad7fa8; font-style: italic;"&gt;&amp;lt;gd.h&amp;gt;&lt;/span&gt;


&lt;span style="color: #729fcf;"&gt;#define&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;NGX_HTTP_IMAGE_OFF&lt;/span&gt;       0
&lt;span style="color: #729fcf;"&gt;#define&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;NGX_HTTP_IMAGE_TEST&lt;/span&gt;      1
&lt;span style="color: #729fcf;"&gt;#define&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;NGX_HTTP_IMAGE_SIZE&lt;/span&gt;      2
&lt;span style="color: #729fcf;"&gt;#define&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;NGX_HTTP_IMAGE_RESIZE&lt;/span&gt;    3
&lt;span style="color: #729fcf;"&gt;#define&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;NGX_HTTP_IMAGE_CROP&lt;/span&gt;      4
&lt;span style="color: #729fcf;"&gt;#define&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;NGX_HTTP_IMAGE_ROTATE&lt;/span&gt;    5
&lt;span style="color: #729fcf;"&gt;#define&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;NGX_HTTP_IMAGE_WATERMARK&lt;/span&gt; 6


&lt;span style="color: #729fcf;"&gt;#define&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;NGX_HTTP_IMAGE_START&lt;/span&gt;     0
&lt;span style="color: #729fcf;"&gt;#define&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;NGX_HTTP_IMAGE_READ&lt;/span&gt;      1
&lt;span style="color: #729fcf;"&gt;#define&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;NGX_HTTP_IMAGE_PROCESS&lt;/span&gt;   2
&lt;span style="color: #729fcf;"&gt;#define&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;NGX_HTTP_IMAGE_PASS&lt;/span&gt;      3
&lt;span style="color: #729fcf;"&gt;#define&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;NGX_HTTP_IMAGE_DONE&lt;/span&gt;      4


&lt;span style="color: #729fcf;"&gt;#define&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;NGX_HTTP_IMAGE_NONE&lt;/span&gt;      0
&lt;span style="color: #729fcf;"&gt;#define&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;NGX_HTTP_IMAGE_JPEG&lt;/span&gt;      1
&lt;span style="color: #729fcf;"&gt;#define&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;NGX_HTTP_IMAGE_GIF&lt;/span&gt;       2
&lt;span style="color: #729fcf;"&gt;#define&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;NGX_HTTP_IMAGE_PNG&lt;/span&gt;       3


&lt;span style="color: #729fcf;"&gt;#define&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;NGX_HTTP_IMAGE_BUFFERED&lt;/span&gt;  0x08


&lt;span style="color: #729fcf; font-weight: bold;"&gt;typedef&lt;/span&gt; &lt;span style="color: #729fcf; font-weight: bold;"&gt;struct&lt;/span&gt; {
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt;                   &lt;span style="color: #eeeeec;"&gt;filter&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt;                   &lt;span style="color: #eeeeec;"&gt;width&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt;                   &lt;span style="color: #eeeeec;"&gt;height&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt;                   &lt;span style="color: #eeeeec;"&gt;angle&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt;                   &lt;span style="color: #eeeeec;"&gt;jpeg_quality&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt;                   &lt;span style="color: #eeeeec;"&gt;sharpen&lt;/span&gt;;

    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_flag_t&lt;/span&gt;                   &lt;span style="color: #eeeeec;"&gt;transparency&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_str_t&lt;/span&gt;                    &lt;span style="color: #eeeeec;"&gt;watermark&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt;                   &lt;span style="color: #eeeeec;"&gt;watermark_transparency&lt;/span&gt;;
    
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_complex_value_t&lt;/span&gt;    *&lt;span style="color: #eeeeec;"&gt;wcv&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_complex_value_t&lt;/span&gt;    *&lt;span style="color: #eeeeec;"&gt;hcv&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_complex_value_t&lt;/span&gt;    *&lt;span style="color: #eeeeec;"&gt;acv&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_complex_value_t&lt;/span&gt;    *&lt;span style="color: #eeeeec;"&gt;jqcv&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_complex_value_t&lt;/span&gt;    *&lt;span style="color: #eeeeec;"&gt;shcv&lt;/span&gt;;

    &lt;span style="color: #8ae234; font-weight: bold;"&gt;size_t&lt;/span&gt;                       &lt;span style="color: #eeeeec;"&gt;buffer_size&lt;/span&gt;;
} &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_image_filter_conf_t&lt;/span&gt;;


&lt;span style="color: #729fcf; font-weight: bold;"&gt;typedef&lt;/span&gt; &lt;span style="color: #729fcf; font-weight: bold;"&gt;struct&lt;/span&gt; {
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;u_char&lt;/span&gt;                      *&lt;span style="color: #eeeeec;"&gt;image&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;u_char&lt;/span&gt;                      *&lt;span style="color: #eeeeec;"&gt;last&lt;/span&gt;;

    &lt;span style="color: #8ae234; font-weight: bold;"&gt;size_t&lt;/span&gt;                       &lt;span style="color: #eeeeec;"&gt;length&lt;/span&gt;;

    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt;                   &lt;span style="color: #eeeeec;"&gt;width&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt;                   &lt;span style="color: #eeeeec;"&gt;height&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt;                   &lt;span style="color: #eeeeec;"&gt;max_width&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt;                   &lt;span style="color: #eeeeec;"&gt;max_height&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt;                   &lt;span style="color: #eeeeec;"&gt;angle&lt;/span&gt;;

    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt;                   &lt;span style="color: #eeeeec;"&gt;phase&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt;                   &lt;span style="color: #eeeeec;"&gt;type&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt;                   &lt;span style="color: #eeeeec;"&gt;force&lt;/span&gt;;
} &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_image_filter_ctx_t&lt;/span&gt;;


&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_int_t&lt;/span&gt; &lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_send&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_request_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;r&lt;/span&gt;,
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_image_filter_ctx_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;ctx&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_chain_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;in&lt;/span&gt;);
&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt; &lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_test&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_request_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;r&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_chain_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;in&lt;/span&gt;);
&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_int_t&lt;/span&gt; &lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_read&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_request_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;r&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_chain_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;in&lt;/span&gt;);
&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_buf_t&lt;/span&gt; *&lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_process&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_request_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;r&lt;/span&gt;);
&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_buf_t&lt;/span&gt; *&lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_json&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_request_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;r&lt;/span&gt;,
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_image_filter_ctx_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;ctx&lt;/span&gt;);
&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_buf_t&lt;/span&gt; *&lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_asis&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_request_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;r&lt;/span&gt;,
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_image_filter_ctx_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;ctx&lt;/span&gt;);
&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;void&lt;/span&gt; &lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_length&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_request_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;r&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_buf_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;b&lt;/span&gt;);
&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_int_t&lt;/span&gt; &lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_size&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_request_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;r&lt;/span&gt;,
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_image_filter_ctx_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;ctx&lt;/span&gt;);

&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_buf_t&lt;/span&gt; *&lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_resize&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_request_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;r&lt;/span&gt;,
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_image_filter_ctx_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;ctx&lt;/span&gt;);
&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;gdImagePtr&lt;/span&gt; &lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_source&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_request_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;r&lt;/span&gt;,
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_image_filter_ctx_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;ctx&lt;/span&gt;);
&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;gdImagePtr&lt;/span&gt; &lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_new&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_request_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;r&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;int&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;w&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;int&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;h&lt;/span&gt;,
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;int&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;colors&lt;/span&gt;);
&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;u_char&lt;/span&gt; *&lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_out&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_request_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;r&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;type&lt;/span&gt;,
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;gdImagePtr&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;img&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;int&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;size&lt;/span&gt;);
&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;void&lt;/span&gt; &lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_cleanup&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;void&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;data&lt;/span&gt;);
&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt; &lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_filter_get_value&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_request_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;r&lt;/span&gt;,
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_complex_value_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;cv&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;v&lt;/span&gt;);
&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt; &lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_filter_value&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_str_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;value&lt;/span&gt;);


&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;void&lt;/span&gt; *&lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_filter_create_conf&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_conf_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;cf&lt;/span&gt;);
&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;char&lt;/span&gt; *&lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_filter_merge_conf&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_conf_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;cf&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;void&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;parent&lt;/span&gt;,
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;void&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;child&lt;/span&gt;);
&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;char&lt;/span&gt; *&lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_filter&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_conf_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;cf&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_command_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;cmd&lt;/span&gt;,
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;void&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;conf&lt;/span&gt;);
&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;char&lt;/span&gt; *&lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_filter_jpeg_quality&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_conf_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;cf&lt;/span&gt;,
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_command_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;cmd&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;void&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;conf&lt;/span&gt;);
&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;char&lt;/span&gt; *&lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_filter_sharpen&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_conf_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;cf&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_command_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;cmd&lt;/span&gt;,
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;void&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;conf&lt;/span&gt;);
&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_int_t&lt;/span&gt; &lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_filter_init&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_conf_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;cf&lt;/span&gt;);


&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_command_t&lt;/span&gt;  &lt;span style="color: #eeeeec;"&gt;ngx_http_image_filter_commands&lt;/span&gt;[] = {

    { ngx_string(&lt;span style="color: #ad7fa8; font-style: italic;"&gt;"image_filter"&lt;/span&gt;),
      NGX_HTTP_LOC_CONF|NGX_CONF_TAKE123,
      ngx_http_image_filter,
      NGX_HTTP_LOC_CONF_OFFSET,
      0,
      &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt; },

    { ngx_string(&lt;span style="color: #ad7fa8; font-style: italic;"&gt;"image_filter_jpeg_quality"&lt;/span&gt;),
      NGX_HTTP_MAIN_CONF|NGX_HTTP_SRV_CONF|NGX_HTTP_LOC_CONF|NGX_CONF_TAKE1,
      ngx_http_image_filter_jpeg_quality,
      NGX_HTTP_LOC_CONF_OFFSET,
      0,
      &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt; },

    { ngx_string(&lt;span style="color: #ad7fa8; font-style: italic;"&gt;"image_filter_sharpen"&lt;/span&gt;),
      NGX_HTTP_MAIN_CONF|NGX_HTTP_SRV_CONF|NGX_HTTP_LOC_CONF|NGX_CONF_TAKE1,
      ngx_http_image_filter_sharpen,
      NGX_HTTP_LOC_CONF_OFFSET,
      0,
      &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt; },

    { ngx_string(&lt;span style="color: #ad7fa8; font-style: italic;"&gt;"image_filter_transparency"&lt;/span&gt;),
      NGX_HTTP_MAIN_CONF|NGX_HTTP_SRV_CONF|NGX_HTTP_LOC_CONF|NGX_CONF_FLAG,
      ngx_conf_set_flag_slot,
      NGX_HTTP_LOC_CONF_OFFSET,
      offsetof(ngx_http_image_filter_conf_t, transparency),
      &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt; },

    { ngx_string(&lt;span style="color: #ad7fa8; font-style: italic;"&gt;"image_filter_buffer"&lt;/span&gt;),
      NGX_HTTP_MAIN_CONF|NGX_HTTP_SRV_CONF|NGX_HTTP_LOC_CONF|NGX_CONF_TAKE1,
      ngx_conf_set_size_slot,
      NGX_HTTP_LOC_CONF_OFFSET,
      offsetof(ngx_http_image_filter_conf_t, buffer_size),
      &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt; },

    { ngx_string(&lt;span style="color: #ad7fa8; font-style: italic;"&gt;"image_filter_watermark"&lt;/span&gt;),
      NGX_HTTP_MAIN_CONF|NGX_HTTP_SRV_CONF|NGX_HTTP_LOC_CONF|NGX_CONF_TAKE1,
      ngx_conf_set_str_slot,
      NGX_HTTP_LOC_CONF_OFFSET,
      offsetof(ngx_http_image_filter_conf_t, watermark),
      &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt; },

    { ngx_string(&lt;span style="color: #ad7fa8; font-style: italic;"&gt;"image_filter_watermark_transparency"&lt;/span&gt;),
      NGX_HTTP_MAIN_CONF|NGX_HTTP_SRV_CONF|NGX_HTTP_LOC_CONF|NGX_CONF_TAKE1,
      ngx_conf_set_num_slot,
      NGX_HTTP_LOC_CONF_OFFSET,
      offsetof(ngx_http_image_filter_conf_t, watermark_transparency),
      &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt; },
    
      ngx_null_command
};


&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_module_t&lt;/span&gt;  &lt;span style="color: #eeeeec;"&gt;ngx_http_image_filter_module_ctx&lt;/span&gt; = {
    &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;,                                  &lt;span style="color: #888a85;"&gt;/* &lt;/span&gt;&lt;span style="color: #888a85;"&gt;preconfiguration &lt;/span&gt;&lt;span style="color: #888a85;"&gt;*/&lt;/span&gt;
    ngx_http_image_filter_init,            &lt;span style="color: #888a85;"&gt;/* &lt;/span&gt;&lt;span style="color: #888a85;"&gt;postconfiguration &lt;/span&gt;&lt;span style="color: #888a85;"&gt;*/&lt;/span&gt;

    &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;,                                  &lt;span style="color: #888a85;"&gt;/* &lt;/span&gt;&lt;span style="color: #888a85;"&gt;create main configuration &lt;/span&gt;&lt;span style="color: #888a85;"&gt;*/&lt;/span&gt;
    &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;,                                  &lt;span style="color: #888a85;"&gt;/* &lt;/span&gt;&lt;span style="color: #888a85;"&gt;init main configuration &lt;/span&gt;&lt;span style="color: #888a85;"&gt;*/&lt;/span&gt;

    &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;,                                  &lt;span style="color: #888a85;"&gt;/* &lt;/span&gt;&lt;span style="color: #888a85;"&gt;create server configuration &lt;/span&gt;&lt;span style="color: #888a85;"&gt;*/&lt;/span&gt;
    &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;,                                  &lt;span style="color: #888a85;"&gt;/* &lt;/span&gt;&lt;span style="color: #888a85;"&gt;merge server configuration &lt;/span&gt;&lt;span style="color: #888a85;"&gt;*/&lt;/span&gt;

    ngx_http_image_filter_create_conf,     &lt;span style="color: #888a85;"&gt;/* &lt;/span&gt;&lt;span style="color: #888a85;"&gt;create location configuration &lt;/span&gt;&lt;span style="color: #888a85;"&gt;*/&lt;/span&gt;
    ngx_http_image_filter_merge_conf       &lt;span style="color: #888a85;"&gt;/* &lt;/span&gt;&lt;span style="color: #888a85;"&gt;merge location configuration &lt;/span&gt;&lt;span style="color: #888a85;"&gt;*/&lt;/span&gt;
};


&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_module_t&lt;/span&gt;  &lt;span style="color: #eeeeec;"&gt;ngx_http_image_filter_module&lt;/span&gt; = {
    NGX_MODULE_V1,
    &amp;amp;ngx_http_image_filter_module_ctx,     &lt;span style="color: #888a85;"&gt;/* &lt;/span&gt;&lt;span style="color: #888a85;"&gt;module context &lt;/span&gt;&lt;span style="color: #888a85;"&gt;*/&lt;/span&gt;
    ngx_http_image_filter_commands,        &lt;span style="color: #888a85;"&gt;/* &lt;/span&gt;&lt;span style="color: #888a85;"&gt;module directives &lt;/span&gt;&lt;span style="color: #888a85;"&gt;*/&lt;/span&gt;
    NGX_HTTP_MODULE,                       &lt;span style="color: #888a85;"&gt;/* &lt;/span&gt;&lt;span style="color: #888a85;"&gt;module type &lt;/span&gt;&lt;span style="color: #888a85;"&gt;*/&lt;/span&gt;
    &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;,                                  &lt;span style="color: #888a85;"&gt;/* &lt;/span&gt;&lt;span style="color: #888a85;"&gt;init master &lt;/span&gt;&lt;span style="color: #888a85;"&gt;*/&lt;/span&gt;
    &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;,                                  &lt;span style="color: #888a85;"&gt;/* &lt;/span&gt;&lt;span style="color: #888a85;"&gt;init module &lt;/span&gt;&lt;span style="color: #888a85;"&gt;*/&lt;/span&gt;
    &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;,                                  &lt;span style="color: #888a85;"&gt;/* &lt;/span&gt;&lt;span style="color: #888a85;"&gt;init process &lt;/span&gt;&lt;span style="color: #888a85;"&gt;*/&lt;/span&gt;
    &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;,                                  &lt;span style="color: #888a85;"&gt;/* &lt;/span&gt;&lt;span style="color: #888a85;"&gt;init thread &lt;/span&gt;&lt;span style="color: #888a85;"&gt;*/&lt;/span&gt;
    &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;,                                  &lt;span style="color: #888a85;"&gt;/* &lt;/span&gt;&lt;span style="color: #888a85;"&gt;exit thread &lt;/span&gt;&lt;span style="color: #888a85;"&gt;*/&lt;/span&gt;
    &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;,                                  &lt;span style="color: #888a85;"&gt;/* &lt;/span&gt;&lt;span style="color: #888a85;"&gt;exit process &lt;/span&gt;&lt;span style="color: #888a85;"&gt;*/&lt;/span&gt;
    &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;,                                  &lt;span style="color: #888a85;"&gt;/* &lt;/span&gt;&lt;span style="color: #888a85;"&gt;exit master &lt;/span&gt;&lt;span style="color: #888a85;"&gt;*/&lt;/span&gt;
    NGX_MODULE_V1_PADDING
};


&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_output_header_filter_pt&lt;/span&gt;  &lt;span style="color: #eeeeec;"&gt;ngx_http_next_header_filter&lt;/span&gt;;
&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_output_body_filter_pt&lt;/span&gt;    &lt;span style="color: #eeeeec;"&gt;ngx_http_next_body_filter&lt;/span&gt;;


&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_str_t&lt;/span&gt;  &lt;span style="color: #eeeeec;"&gt;ngx_http_image_types&lt;/span&gt;[] = {
    ngx_string(&lt;span style="color: #ad7fa8; font-style: italic;"&gt;"image/jpeg"&lt;/span&gt;),
    ngx_string(&lt;span style="color: #ad7fa8; font-style: italic;"&gt;"image/gif"&lt;/span&gt;),
    ngx_string(&lt;span style="color: #ad7fa8; font-style: italic;"&gt;"image/png"&lt;/span&gt;)
};


&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_int_t&lt;/span&gt;
&lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_header_filter&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_request_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;r&lt;/span&gt;)
{
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;off_t&lt;/span&gt;                          &lt;span style="color: #eeeeec;"&gt;len&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_image_filter_ctx_t&lt;/span&gt;   *&lt;span style="color: #eeeeec;"&gt;ctx&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_image_filter_conf_t&lt;/span&gt;  *&lt;span style="color: #eeeeec;"&gt;conf&lt;/span&gt;;

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (r-&amp;gt;headers_out.status == NGX_HTTP_NOT_MODIFIED) {
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; ngx_http_next_header_filter(r);
    }

    ctx = ngx_http_get_module_ctx(r, ngx_http_image_filter_module);

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (ctx) {
        ngx_http_set_ctx(r, &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;, ngx_http_image_filter_module);
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; ngx_http_next_header_filter(r);
    }

    conf = ngx_http_get_module_loc_conf(r, ngx_http_image_filter_module);

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (conf-&amp;gt;filter == NGX_HTTP_IMAGE_OFF) {
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; ngx_http_next_header_filter(r);
    }

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (r-&amp;gt;headers_out.content_type.len
            &amp;gt;= &lt;span style="color: #729fcf; font-weight: bold;"&gt;sizeof&lt;/span&gt;(&lt;span style="color: #ad7fa8; font-style: italic;"&gt;"multipart/x-mixed-replace"&lt;/span&gt;) - 1
        &amp;amp;&amp;amp; ngx_strncasecmp(r-&amp;gt;headers_out.content_type.data,
                           (&lt;span style="color: #8ae234; font-weight: bold;"&gt;u_char&lt;/span&gt; *) &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"multipart/x-mixed-replace"&lt;/span&gt;,
                           &lt;span style="color: #729fcf; font-weight: bold;"&gt;sizeof&lt;/span&gt;(&lt;span style="color: #ad7fa8; font-style: italic;"&gt;"multipart/x-mixed-replace"&lt;/span&gt;) - 1)
           == 0)
    {
        ngx_log_error(NGX_LOG_ERR, r-&amp;gt;connection-&amp;gt;log, 0,
                      &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"image filter: multipart/x-mixed-replace response"&lt;/span&gt;);

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_ERROR;
    }

    ctx = ngx_pcalloc(r-&amp;gt;pool, &lt;span style="color: #729fcf; font-weight: bold;"&gt;sizeof&lt;/span&gt;(ngx_http_image_filter_ctx_t));
    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (ctx == &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_ERROR;
    }

    ngx_http_set_ctx(r, ctx, ngx_http_image_filter_module);

    len = r-&amp;gt;headers_out.content_length_n;

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (len != -1 &amp;amp;&amp;amp; len &amp;gt; (&lt;span style="color: #8ae234; font-weight: bold;"&gt;off_t&lt;/span&gt;) conf-&amp;gt;buffer_size) {
        ngx_log_error(NGX_LOG_ERR, r-&amp;gt;connection-&amp;gt;log, 0,
                      &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"image filter: too big response: %O"&lt;/span&gt;, len);

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_HTTP_UNSUPPORTED_MEDIA_TYPE;
    }

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (len == -1) {
        ctx-&amp;gt;length = conf-&amp;gt;buffer_size;

    } &lt;span style="color: #729fcf; font-weight: bold;"&gt;else&lt;/span&gt; {
        ctx-&amp;gt;length = (&lt;span style="color: #8ae234; font-weight: bold;"&gt;size_t&lt;/span&gt;) len;
    }

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (r-&amp;gt;headers_out.refresh) {
        r-&amp;gt;headers_out.refresh-&amp;gt;hash = 0;
    }

    r-&amp;gt;main_filter_need_in_memory = 1;
    r-&amp;gt;allow_ranges = 0;

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_OK;
}


&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_int_t&lt;/span&gt;
&lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_body_filter&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_request_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;r&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_chain_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;in&lt;/span&gt;)
{
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_int_t&lt;/span&gt;                      &lt;span style="color: #eeeeec;"&gt;rc&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_str_t&lt;/span&gt;                     *&lt;span style="color: #eeeeec;"&gt;ct&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_chain_t&lt;/span&gt;                    &lt;span style="color: #eeeeec;"&gt;out&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_image_filter_ctx_t&lt;/span&gt;   *&lt;span style="color: #eeeeec;"&gt;ctx&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_image_filter_conf_t&lt;/span&gt;  *&lt;span style="color: #eeeeec;"&gt;conf&lt;/span&gt;;

    ngx_log_debug0(NGX_LOG_DEBUG_HTTP, r-&amp;gt;connection-&amp;gt;log, 0, &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"image filter"&lt;/span&gt;);

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (in == &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; ngx_http_next_body_filter(r, in);
    }

    ctx = ngx_http_get_module_ctx(r, ngx_http_image_filter_module);

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (ctx == &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; ngx_http_next_body_filter(r, in);
    }

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;switch&lt;/span&gt; (ctx-&amp;gt;phase) {

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;case&lt;/span&gt; NGX_HTTP_IMAGE_START:

        ctx-&amp;gt;type = ngx_http_image_test(r, in);

        conf = ngx_http_get_module_loc_conf(r, ngx_http_image_filter_module);

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (ctx-&amp;gt;type == NGX_HTTP_IMAGE_NONE) {

            &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (conf-&amp;gt;filter == NGX_HTTP_IMAGE_SIZE) {
                out.buf = ngx_http_image_json(r, &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;);

                &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (out.buf) {
                    out.next = &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;;
                    ctx-&amp;gt;phase = NGX_HTTP_IMAGE_DONE;

                    &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; ngx_http_image_send(r, ctx, &amp;amp;out);
                }
            }

            &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; ngx_http_filter_finalize_request(r,
                                              &amp;amp;ngx_http_image_filter_module,
                                              NGX_HTTP_UNSUPPORTED_MEDIA_TYPE);
        }

        &lt;span style="color: #888a85;"&gt;/* &lt;/span&gt;&lt;span style="color: #888a85;"&gt;override content type &lt;/span&gt;&lt;span style="color: #888a85;"&gt;*/&lt;/span&gt;

        ct = &amp;amp;ngx_http_image_types[ctx-&amp;gt;type - 1];
        r-&amp;gt;headers_out.content_type_len = ct-&amp;gt;len;
        r-&amp;gt;headers_out.content_type = *ct;
        r-&amp;gt;headers_out.content_type_lowcase = &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;;

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (conf-&amp;gt;filter == NGX_HTTP_IMAGE_TEST) {
            ctx-&amp;gt;phase = NGX_HTTP_IMAGE_PASS;

            &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; ngx_http_image_send(r, ctx, in);
        }

        ctx-&amp;gt;phase = NGX_HTTP_IMAGE_READ;

        &lt;span style="color: #888a85;"&gt;/* &lt;/span&gt;&lt;span style="color: #888a85;"&gt;fall through &lt;/span&gt;&lt;span style="color: #888a85;"&gt;*/&lt;/span&gt;

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;case&lt;/span&gt; NGX_HTTP_IMAGE_READ:

        rc = ngx_http_image_read(r, in);

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (rc == NGX_AGAIN) {
            &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_OK;
        }

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (rc == NGX_ERROR) {
            &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; ngx_http_filter_finalize_request(r,
                                              &amp;amp;ngx_http_image_filter_module,
                                              NGX_HTTP_UNSUPPORTED_MEDIA_TYPE);
        }

        &lt;span style="color: #888a85;"&gt;/* &lt;/span&gt;&lt;span style="color: #888a85;"&gt;fall through &lt;/span&gt;&lt;span style="color: #888a85;"&gt;*/&lt;/span&gt;

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;case&lt;/span&gt; NGX_HTTP_IMAGE_PROCESS:

        out.buf = ngx_http_image_process(r);

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (out.buf == &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
            &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; ngx_http_filter_finalize_request(r,
                                              &amp;amp;ngx_http_image_filter_module,
                                              NGX_HTTP_UNSUPPORTED_MEDIA_TYPE);
        }

        out.next = &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;;
        ctx-&amp;gt;phase = NGX_HTTP_IMAGE_PASS;

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; ngx_http_image_send(r, ctx, &amp;amp;out);

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;case&lt;/span&gt; NGX_HTTP_IMAGE_PASS:

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; ngx_http_next_body_filter(r, in);

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;default&lt;/span&gt;: &lt;span style="color: #888a85;"&gt;/* &lt;/span&gt;&lt;span style="color: #888a85;"&gt;NGX_HTTP_IMAGE_DONE &lt;/span&gt;&lt;span style="color: #888a85;"&gt;*/&lt;/span&gt;

        rc = ngx_http_next_body_filter(r, &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;);

        &lt;span style="color: #888a85;"&gt;/* &lt;/span&gt;&lt;span style="color: #888a85;"&gt;NGX_ERROR resets any pending data &lt;/span&gt;&lt;span style="color: #888a85;"&gt;*/&lt;/span&gt;
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; (rc == NGX_OK) ? NGX_ERROR : rc;
    }
}


&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_int_t&lt;/span&gt;
&lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_send&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_request_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;r&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_image_filter_ctx_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;ctx&lt;/span&gt;,
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_chain_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;in&lt;/span&gt;)
{
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_int_t&lt;/span&gt;  &lt;span style="color: #eeeeec;"&gt;rc&lt;/span&gt;;

    rc = ngx_http_next_header_filter(r);

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (rc == NGX_ERROR || rc &amp;gt; NGX_OK || r-&amp;gt;header_only) {
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_ERROR;
    }

    rc = ngx_http_next_body_filter(r, in);

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (ctx-&amp;gt;phase == NGX_HTTP_IMAGE_DONE) {
        &lt;span style="color: #888a85;"&gt;/* &lt;/span&gt;&lt;span style="color: #888a85;"&gt;NGX_ERROR resets any pending data &lt;/span&gt;&lt;span style="color: #888a85;"&gt;*/&lt;/span&gt;
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; (rc == NGX_OK) ? NGX_ERROR : rc;
    }

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; rc;
}


&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt;
&lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_test&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_request_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;r&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_chain_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;in&lt;/span&gt;)
{
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;u_char&lt;/span&gt;  *&lt;span style="color: #eeeeec;"&gt;p&lt;/span&gt;;

    p = in-&amp;gt;buf-&amp;gt;pos;

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (in-&amp;gt;buf-&amp;gt;last - p &amp;lt; 16) {
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_HTTP_IMAGE_NONE;
    }

    ngx_log_debug2(NGX_LOG_DEBUG_HTTP, r-&amp;gt;connection-&amp;gt;log, 0,
                   &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"image filter: \"%c%c\""&lt;/span&gt;, p[0], p[1]);

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (p[0] == 0xff &amp;amp;&amp;amp; p[1] == 0xd8) {

        &lt;span style="color: #888a85;"&gt;/* &lt;/span&gt;&lt;span style="color: #888a85;"&gt;JPEG &lt;/span&gt;&lt;span style="color: #888a85;"&gt;*/&lt;/span&gt;

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_HTTP_IMAGE_JPEG;

    } &lt;span style="color: #729fcf; font-weight: bold;"&gt;else&lt;/span&gt; &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (p[0] == &lt;span style="color: #ad7fa8; font-style: italic;"&gt;'G'&lt;/span&gt; &amp;amp;&amp;amp; p[1] == &lt;span style="color: #ad7fa8; font-style: italic;"&gt;'I'&lt;/span&gt; &amp;amp;&amp;amp; p[2] == &lt;span style="color: #ad7fa8; font-style: italic;"&gt;'F'&lt;/span&gt; &amp;amp;&amp;amp; p[3] == &lt;span style="color: #ad7fa8; font-style: italic;"&gt;'8'&lt;/span&gt;
               &amp;amp;&amp;amp; p[5] == &lt;span style="color: #ad7fa8; font-style: italic;"&gt;'a'&lt;/span&gt;)
    {
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (p[4] == &lt;span style="color: #ad7fa8; font-style: italic;"&gt;'9'&lt;/span&gt; || p[4] == &lt;span style="color: #ad7fa8; font-style: italic;"&gt;'7'&lt;/span&gt;) {
            &lt;span style="color: #888a85;"&gt;/* &lt;/span&gt;&lt;span style="color: #888a85;"&gt;GIF &lt;/span&gt;&lt;span style="color: #888a85;"&gt;*/&lt;/span&gt;
            &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_HTTP_IMAGE_GIF;
        }

    } &lt;span style="color: #729fcf; font-weight: bold;"&gt;else&lt;/span&gt; &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (p[0] == 0x89 &amp;amp;&amp;amp; p[1] == &lt;span style="color: #ad7fa8; font-style: italic;"&gt;'P'&lt;/span&gt; &amp;amp;&amp;amp; p[2] == &lt;span style="color: #ad7fa8; font-style: italic;"&gt;'N'&lt;/span&gt; &amp;amp;&amp;amp; p[3] == &lt;span style="color: #ad7fa8; font-style: italic;"&gt;'G'&lt;/span&gt;
               &amp;amp;&amp;amp; p[4] == 0x0d &amp;amp;&amp;amp; p[5] == 0x0a &amp;amp;&amp;amp; p[6] == 0x1a &amp;amp;&amp;amp; p[7] == 0x0a)
    {
        &lt;span style="color: #888a85;"&gt;/* &lt;/span&gt;&lt;span style="color: #888a85;"&gt;PNG &lt;/span&gt;&lt;span style="color: #888a85;"&gt;*/&lt;/span&gt;

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_HTTP_IMAGE_PNG;
    }

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_HTTP_IMAGE_NONE;
}


&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_int_t&lt;/span&gt;
&lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_read&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_request_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;r&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_chain_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;in&lt;/span&gt;)
{
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;u_char&lt;/span&gt;                       *&lt;span style="color: #eeeeec;"&gt;p&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;size_t&lt;/span&gt;                        &lt;span style="color: #eeeeec;"&gt;size&lt;/span&gt;, &lt;span style="color: #eeeeec;"&gt;rest&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_buf_t&lt;/span&gt;                    *&lt;span style="color: #eeeeec;"&gt;b&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_chain_t&lt;/span&gt;                  *&lt;span style="color: #eeeeec;"&gt;cl&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_image_filter_ctx_t&lt;/span&gt;  *&lt;span style="color: #eeeeec;"&gt;ctx&lt;/span&gt;;

    ctx = ngx_http_get_module_ctx(r, ngx_http_image_filter_module);

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (ctx-&amp;gt;image == &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
        ctx-&amp;gt;image = ngx_palloc(r-&amp;gt;pool, ctx-&amp;gt;length);
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (ctx-&amp;gt;image == &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
            &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_ERROR;
        }

        ctx-&amp;gt;last = ctx-&amp;gt;image;
    }

    p = ctx-&amp;gt;last;

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;for&lt;/span&gt; (cl = in; cl; cl = cl-&amp;gt;next) {

        b = cl-&amp;gt;buf;
        size = b-&amp;gt;last - b-&amp;gt;pos;

        ngx_log_debug1(NGX_LOG_DEBUG_HTTP, r-&amp;gt;connection-&amp;gt;log, 0,
                       &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"image buf: %uz"&lt;/span&gt;, size);

        rest = ctx-&amp;gt;image + ctx-&amp;gt;length - p;
        size = (rest &amp;lt; size) ? rest : size;

        p = ngx_cpymem(p, b-&amp;gt;pos, size);
        b-&amp;gt;pos += size;

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (b-&amp;gt;last_buf) {
            ctx-&amp;gt;last = p;
            &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_OK;
        }
    }

    ctx-&amp;gt;last = p;
    r-&amp;gt;connection-&amp;gt;buffered |= NGX_HTTP_IMAGE_BUFFERED;

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_AGAIN;
}


&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_buf_t&lt;/span&gt; *
&lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_process&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_request_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;r&lt;/span&gt;)
{
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_int_t&lt;/span&gt;                      &lt;span style="color: #eeeeec;"&gt;rc&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_image_filter_ctx_t&lt;/span&gt;   *&lt;span style="color: #eeeeec;"&gt;ctx&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_image_filter_conf_t&lt;/span&gt;  *&lt;span style="color: #eeeeec;"&gt;conf&lt;/span&gt;;

    r-&amp;gt;connection-&amp;gt;buffered &amp;amp;= ~NGX_HTTP_IMAGE_BUFFERED;

    ctx = ngx_http_get_module_ctx(r, ngx_http_image_filter_module);

    rc = ngx_http_image_size(r, ctx);

    conf = ngx_http_get_module_loc_conf(r, ngx_http_image_filter_module);

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (conf-&amp;gt;filter == NGX_HTTP_IMAGE_SIZE) {
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; ngx_http_image_json(r, rc == NGX_OK ? ctx : &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;);
    }

    ctx-&amp;gt;angle = ngx_http_image_filter_get_value(r, conf-&amp;gt;acv, conf-&amp;gt;angle);

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (conf-&amp;gt;filter == NGX_HTTP_IMAGE_ROTATE) {

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (ctx-&amp;gt;angle != 90 &amp;amp;&amp;amp; ctx-&amp;gt;angle != 180 &amp;amp;&amp;amp; ctx-&amp;gt;angle != 270) {
            &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;;
        }

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; ngx_http_image_resize(r, ctx);
    }

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (conf-&amp;gt;filter == NGX_HTTP_IMAGE_WATERMARK) {

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (!conf-&amp;gt;watermark.data) {
            &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;;
        }

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; ngx_http_image_resize(r, ctx);
    }    

    ctx-&amp;gt;max_width = ngx_http_image_filter_get_value(r, conf-&amp;gt;wcv, conf-&amp;gt;width);
    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (ctx-&amp;gt;max_width == 0) {
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;;
    }

    ctx-&amp;gt;max_height = ngx_http_image_filter_get_value(r, conf-&amp;gt;hcv,
                                                      conf-&amp;gt;height);
    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (ctx-&amp;gt;max_height == 0) {
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;;
    }

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (rc == NGX_OK
        &amp;amp;&amp;amp; ctx-&amp;gt;width &amp;lt;= ctx-&amp;gt;max_width
        &amp;amp;&amp;amp; ctx-&amp;gt;height &amp;lt;= ctx-&amp;gt;max_height
        &amp;amp;&amp;amp; ctx-&amp;gt;angle == 0
        &amp;amp;&amp;amp; !ctx-&amp;gt;force)
    {
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; ngx_http_image_asis(r, ctx);
    }

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; ngx_http_image_resize(r, ctx);
}


&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_buf_t&lt;/span&gt; *
&lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_json&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_request_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;r&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_image_filter_ctx_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;ctx&lt;/span&gt;)
{
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;size_t&lt;/span&gt;      &lt;span style="color: #eeeeec;"&gt;len&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_buf_t&lt;/span&gt;  *&lt;span style="color: #eeeeec;"&gt;b&lt;/span&gt;;

    b = ngx_pcalloc(r-&amp;gt;pool, &lt;span style="color: #729fcf; font-weight: bold;"&gt;sizeof&lt;/span&gt;(ngx_buf_t));
    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (b == &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;;
    }

    b-&amp;gt;memory = 1;
    b-&amp;gt;last_buf = 1;

    ngx_http_clean_header(r);

    r-&amp;gt;headers_out.status = NGX_HTTP_OK;
    ngx_str_set(&amp;amp;r-&amp;gt;headers_out.content_type, &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"text/plain"&lt;/span&gt;);
    r-&amp;gt;headers_out.content_type_lowcase = &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;;

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (ctx == &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
        b-&amp;gt;pos = (&lt;span style="color: #8ae234; font-weight: bold;"&gt;u_char&lt;/span&gt; *) &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"{}"&lt;/span&gt; CRLF;
        b-&amp;gt;last = b-&amp;gt;pos + &lt;span style="color: #729fcf; font-weight: bold;"&gt;sizeof&lt;/span&gt;(&lt;span style="color: #ad7fa8; font-style: italic;"&gt;"{}"&lt;/span&gt; CRLF) - 1;

        ngx_http_image_length(r, b);

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; b;
    }

    len = &lt;span style="color: #729fcf; font-weight: bold;"&gt;sizeof&lt;/span&gt;(&lt;span style="color: #ad7fa8; font-style: italic;"&gt;"{ \"img\" : "&lt;/span&gt;
                 &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"{ \"width\": , \"height\": , \"type\": \"jpeg\" } }"&lt;/span&gt; CRLF) - 1
          + 2 * NGX_SIZE_T_LEN;

    b-&amp;gt;pos = ngx_pnalloc(r-&amp;gt;pool, len);
    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (b-&amp;gt;pos == &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;;
    }

    b-&amp;gt;last = ngx_sprintf(b-&amp;gt;pos,
                          &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"{ \"img\" : "&lt;/span&gt;
                                       &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"{ \"width\": %uz,"&lt;/span&gt;
                                        &lt;span style="color: #ad7fa8; font-style: italic;"&gt;" \"height\": %uz,"&lt;/span&gt;
                                        &lt;span style="color: #ad7fa8; font-style: italic;"&gt;" \"type\": \"%s\" } }"&lt;/span&gt; CRLF,
                          ctx-&amp;gt;width, ctx-&amp;gt;height,
                          ngx_http_image_types[ctx-&amp;gt;type - 1].data + 6);

    ngx_http_image_length(r, b);

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; b;
}


&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_buf_t&lt;/span&gt; *
&lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_asis&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_request_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;r&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_image_filter_ctx_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;ctx&lt;/span&gt;)
{
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_buf_t&lt;/span&gt;  *&lt;span style="color: #eeeeec;"&gt;b&lt;/span&gt;;

    b = ngx_pcalloc(r-&amp;gt;pool, &lt;span style="color: #729fcf; font-weight: bold;"&gt;sizeof&lt;/span&gt;(ngx_buf_t));
    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (b == &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;;
    }

    b-&amp;gt;pos = ctx-&amp;gt;image;
    b-&amp;gt;last = ctx-&amp;gt;last;
    b-&amp;gt;memory = 1;
    b-&amp;gt;last_buf = 1;

    ngx_http_image_length(r, b);

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; b;
}


&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;void&lt;/span&gt;
&lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_length&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_request_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;r&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_buf_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;b&lt;/span&gt;)
{
    r-&amp;gt;headers_out.content_length_n = b-&amp;gt;last - b-&amp;gt;pos;

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (r-&amp;gt;headers_out.content_length) {
        r-&amp;gt;headers_out.content_length-&amp;gt;hash = 0;
    }

    r-&amp;gt;headers_out.content_length = &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;;
}


&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_int_t&lt;/span&gt;
&lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_size&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_request_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;r&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_image_filter_ctx_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;ctx&lt;/span&gt;)
{
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;u_char&lt;/span&gt;      *&lt;span style="color: #eeeeec;"&gt;p&lt;/span&gt;, *&lt;span style="color: #eeeeec;"&gt;last&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;size_t&lt;/span&gt;       &lt;span style="color: #eeeeec;"&gt;len&lt;/span&gt;, &lt;span style="color: #eeeeec;"&gt;app&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt;   &lt;span style="color: #eeeeec;"&gt;width&lt;/span&gt;, &lt;span style="color: #eeeeec;"&gt;height&lt;/span&gt;;

    p = ctx-&amp;gt;image;

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;switch&lt;/span&gt; (ctx-&amp;gt;type) {

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;case&lt;/span&gt; NGX_HTTP_IMAGE_JPEG:

        p += 2;
        last = ctx-&amp;gt;image + ctx-&amp;gt;length - 10;
        width = 0;
        height = 0;
        app = 0;

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;while&lt;/span&gt; (p &amp;lt; last) {

            &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (p[0] == 0xff &amp;amp;&amp;amp; p[1] != 0xff) {

                ngx_log_debug2(NGX_LOG_DEBUG_HTTP, r-&amp;gt;connection-&amp;gt;log, 0,
                               &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"JPEG: %02xd %02xd"&lt;/span&gt;, p[0], p[1]);

                p++;

                &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; ((*p == 0xc0 || *p == 0xc1 || *p == 0xc2 || *p == 0xc3
                     || *p == 0xc9 || *p == 0xca || *p == 0xcb)
                    &amp;amp;&amp;amp; (width == 0 || height == 0))
                {
                    width = p[6] * 256 + p[7];
                    height = p[4] * 256 + p[5];
                }

                ngx_log_debug2(NGX_LOG_DEBUG_HTTP, r-&amp;gt;connection-&amp;gt;log, 0,
                               &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"JPEG: %02xd %02xd"&lt;/span&gt;, p[1], p[2]);

                len = p[1] * 256 + p[2];

                &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (*p &amp;gt;= 0xe1 &amp;amp;&amp;amp; *p &amp;lt;= 0xef) {
                    &lt;span style="color: #888a85;"&gt;/* &lt;/span&gt;&lt;span style="color: #888a85;"&gt;application data, e.g., EXIF, Adobe XMP, etc. &lt;/span&gt;&lt;span style="color: #888a85;"&gt;*/&lt;/span&gt;
                    app += len;
                }

                p += len;

                &lt;span style="color: #729fcf; font-weight: bold;"&gt;continue&lt;/span&gt;;
            }

            p++;
        }

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (width == 0 || height == 0) {
            &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_DECLINED;
        }

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (ctx-&amp;gt;length / 20 &amp;lt; app) {
            &lt;span style="color: #888a85;"&gt;/* &lt;/span&gt;&lt;span style="color: #888a85;"&gt;force conversion if application data consume more than 5% &lt;/span&gt;&lt;span style="color: #888a85;"&gt;*/&lt;/span&gt;
            ctx-&amp;gt;force = 1;
            ngx_log_debug1(NGX_LOG_DEBUG_HTTP, r-&amp;gt;connection-&amp;gt;log, 0,
                           &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"app data size: %uz"&lt;/span&gt;, app);
        }

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;break&lt;/span&gt;;

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;case&lt;/span&gt; NGX_HTTP_IMAGE_GIF:

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (ctx-&amp;gt;length &amp;lt; 10) {
            &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_DECLINED;
        }

        width = p[7] * 256 + p[6];
        height = p[9] * 256 + p[8];

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;break&lt;/span&gt;;

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;case&lt;/span&gt; NGX_HTTP_IMAGE_PNG:

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (ctx-&amp;gt;length &amp;lt; 24) {
            &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_DECLINED;
        }

        width = p[18] * 256 + p[19];
        height = p[22] * 256 + p[23];

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;break&lt;/span&gt;;

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;default&lt;/span&gt;:

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_DECLINED;
    }

    ngx_log_debug2(NGX_LOG_DEBUG_HTTP, r-&amp;gt;connection-&amp;gt;log, 0,
                   &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"image size: %d x %d"&lt;/span&gt;, width, height);

    ctx-&amp;gt;width = width;
    ctx-&amp;gt;height = height;

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_OK;
}


&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_buf_t&lt;/span&gt; *
&lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_resize&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_request_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;r&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_image_filter_ctx_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;ctx&lt;/span&gt;)
{
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;int&lt;/span&gt;                            &lt;span style="color: #eeeeec;"&gt;sx&lt;/span&gt;, &lt;span style="color: #eeeeec;"&gt;sy&lt;/span&gt;, &lt;span style="color: #eeeeec;"&gt;dx&lt;/span&gt;, &lt;span style="color: #eeeeec;"&gt;dy&lt;/span&gt;, &lt;span style="color: #eeeeec;"&gt;ox&lt;/span&gt;, &lt;span style="color: #eeeeec;"&gt;oy&lt;/span&gt;, &lt;span style="color: #eeeeec;"&gt;ax&lt;/span&gt;, &lt;span style="color: #eeeeec;"&gt;ay&lt;/span&gt;, &lt;span style="color: #eeeeec;"&gt;size&lt;/span&gt;,
                                   &lt;span style="color: #eeeeec;"&gt;colors&lt;/span&gt;, &lt;span style="color: #eeeeec;"&gt;palette&lt;/span&gt;, &lt;span style="color: #eeeeec;"&gt;transparent&lt;/span&gt;, &lt;span style="color: #eeeeec;"&gt;sharpen&lt;/span&gt;,
                                   &lt;span style="color: #eeeeec;"&gt;red&lt;/span&gt;, &lt;span style="color: #eeeeec;"&gt;green&lt;/span&gt;, &lt;span style="color: #eeeeec;"&gt;blue&lt;/span&gt;, &lt;span style="color: #eeeeec;"&gt;t&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;u_char&lt;/span&gt;                        *&lt;span style="color: #eeeeec;"&gt;out&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_buf_t&lt;/span&gt;                     *&lt;span style="color: #eeeeec;"&gt;b&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt;                     &lt;span style="color: #eeeeec;"&gt;resize&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;gdImagePtr&lt;/span&gt;                     &lt;span style="color: #eeeeec;"&gt;src&lt;/span&gt;, &lt;span style="color: #eeeeec;"&gt;dst&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_pool_cleanup_t&lt;/span&gt;            *&lt;span style="color: #eeeeec;"&gt;cln&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_image_filter_conf_t&lt;/span&gt;  *&lt;span style="color: #eeeeec;"&gt;conf&lt;/span&gt;;

    src = ngx_http_image_source(r, ctx);

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (src == &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;;
    }

    sx = gdImageSX(src);
    sy = gdImageSY(src);

    conf = ngx_http_get_module_loc_conf(r, ngx_http_image_filter_module);

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (!ctx-&amp;gt;force
        &amp;amp;&amp;amp; ctx-&amp;gt;angle == 0
        &amp;amp;&amp;amp; (&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt;) sx &amp;lt;= ctx-&amp;gt;max_width
        &amp;amp;&amp;amp; (&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt;) sy &amp;lt;= ctx-&amp;gt;max_height)
    {
        gdImageDestroy(src);
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; ngx_http_image_asis(r, ctx);
    }

    colors = gdImageColorsTotal(src);

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (colors &amp;amp;&amp;amp; conf-&amp;gt;transparency) {
        transparent = gdImageGetTransparent(src);

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (transparent != -1) {
            palette = colors;
            red = gdImageRed(src, transparent);
            green = gdImageGreen(src, transparent);
            blue = gdImageBlue(src, transparent);

            &lt;span style="color: #729fcf; font-weight: bold;"&gt;goto&lt;/span&gt; &lt;span style="color: #8ae234;"&gt;transparent&lt;/span&gt;;
        }
    }

    palette = 0;
    transparent = -1;
    red = 0;
    green = 0;
    blue = 0;

&lt;span style="color: #8ae234;"&gt;transparent&lt;/span&gt;:

    gdImageColorTransparent(src, -1);

    dx = sx;
    dy = sy;

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (conf-&amp;gt;filter == NGX_HTTP_IMAGE_RESIZE) {

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; ((&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt;) dx &amp;gt; ctx-&amp;gt;max_width) {
            dy = dy * ctx-&amp;gt;max_width / dx;
            dy = dy ? dy : 1;
            dx = ctx-&amp;gt;max_width;
        }

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; ((&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt;) dy &amp;gt; ctx-&amp;gt;max_height) {
            dx = dx * ctx-&amp;gt;max_height / dy;
            dx = dx ? dx : 1;
            dy = ctx-&amp;gt;max_height;
        }

        resize = 1;

    } &lt;span style="color: #729fcf; font-weight: bold;"&gt;else&lt;/span&gt; &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (conf-&amp;gt;filter == NGX_HTTP_IMAGE_ROTATE) {

        resize = 0;
    } &lt;span style="color: #729fcf; font-weight: bold;"&gt;else&lt;/span&gt; &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (conf-&amp;gt;filter == NGX_HTTP_IMAGE_WATERMARK) {
        
        resize = 0;
    } &lt;span style="color: #729fcf; font-weight: bold;"&gt;else&lt;/span&gt; { &lt;span style="color: #888a85;"&gt;/* &lt;/span&gt;&lt;span style="color: #888a85;"&gt;NGX_HTTP_IMAGE_CROP &lt;/span&gt;&lt;span style="color: #888a85;"&gt;*/&lt;/span&gt;

        resize = 0;

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; ((&lt;span style="color: #8ae234; font-weight: bold;"&gt;double&lt;/span&gt;) dx / dy &amp;lt; (&lt;span style="color: #8ae234; font-weight: bold;"&gt;double&lt;/span&gt;) ctx-&amp;gt;max_width / ctx-&amp;gt;max_height) {
            &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; ((&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt;) dx &amp;gt; ctx-&amp;gt;max_width) {
                dy = dy * ctx-&amp;gt;max_width / dx;
                dy = dy ? dy : 1;
                dx = ctx-&amp;gt;max_width;
                resize = 1;
            }

        } &lt;span style="color: #729fcf; font-weight: bold;"&gt;else&lt;/span&gt; {
            &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; ((&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt;) dy &amp;gt; ctx-&amp;gt;max_height) {
                dx = dx * ctx-&amp;gt;max_height / dy;
                dx = dx ? dx : 1;
                dy = ctx-&amp;gt;max_height;
                resize = 1;
            }
        }
    }

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (resize) {
        dst = ngx_http_image_new(r, dx, dy, palette);
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (dst == &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
            gdImageDestroy(src);
            &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;;
        }

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (colors == 0) {
            gdImageSaveAlpha(dst, 1);
            gdImageAlphaBlending(dst, 0);
        }

        gdImageCopyResampled(dst, src, 0, 0, 0, 0, dx, dy, sx, sy);

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (colors) {
            gdImageTrueColorToPalette(dst, 1, 256);
        }

        gdImageDestroy(src);

    } &lt;span style="color: #729fcf; font-weight: bold;"&gt;else&lt;/span&gt; {
        dst = src;
    }

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (ctx-&amp;gt;angle) {
        src = dst;

        ax = (dx % 2 == 0) ? 1 : 0;
        ay = (dy % 2 == 0) ? 1 : 0;

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;switch&lt;/span&gt; (ctx-&amp;gt;angle) {

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;case&lt;/span&gt; 90:
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;case&lt;/span&gt; 270:
            dst = ngx_http_image_new(r, dy, dx, palette);
            &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (dst == &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
                gdImageDestroy(src);
                &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;;
            }
            &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (ctx-&amp;gt;angle == 90) {
                ox = dy / 2 + ay;
                oy = dx / 2 - ax;

            } &lt;span style="color: #729fcf; font-weight: bold;"&gt;else&lt;/span&gt; {
                ox = dy / 2 - ay;
                oy = dx / 2 + ax;
            }

            gdImageCopyRotated(dst, src, ox, oy, 0, 0,
                               dx + ax, dy + ay, ctx-&amp;gt;angle);
            gdImageDestroy(src);

            t = dx;
            dx = dy;
            dy = t;
            &lt;span style="color: #729fcf; font-weight: bold;"&gt;break&lt;/span&gt;;

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;case&lt;/span&gt; 180:
            dst = ngx_http_image_new(r, dx, dy, palette);
            &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (dst == &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
                gdImageDestroy(src);
                &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;;
            }
            gdImageCopyRotated(dst, src, dx / 2 - ax, dy / 2 - ay, 0, 0,
                               dx + ax, dy + ay, ctx-&amp;gt;angle);
            gdImageDestroy(src);
            &lt;span style="color: #729fcf; font-weight: bold;"&gt;break&lt;/span&gt;;
        }
    }

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (conf-&amp;gt;filter == NGX_HTTP_IMAGE_CROP) {

        src = dst;

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; ((&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt;) dx &amp;gt; ctx-&amp;gt;max_width) {
            ox = dx - ctx-&amp;gt;max_width;

        } &lt;span style="color: #729fcf; font-weight: bold;"&gt;else&lt;/span&gt; {
            ox = 0;
        }

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; ((&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt;) dy &amp;gt; ctx-&amp;gt;max_height) {
            oy = dy - ctx-&amp;gt;max_height;

        } &lt;span style="color: #729fcf; font-weight: bold;"&gt;else&lt;/span&gt; {
            oy = 0;
        }

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (ox || oy) {

            dst = ngx_http_image_new(r, dx - ox, dy - oy, colors);

            &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (dst == &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
                gdImageDestroy(src);
                &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;;
            }

            ox /= 2;
            oy /= 2;

            ngx_log_debug4(NGX_LOG_DEBUG_HTTP, r-&amp;gt;connection-&amp;gt;log, 0,
                           &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"image crop: %d x %d @ %d x %d"&lt;/span&gt;,
                           dx, dy, ox, oy);

            &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (colors == 0) {
                gdImageSaveAlpha(dst, 1);
                gdImageAlphaBlending(dst, 0);
            }

            gdImageCopy(dst, src, 0, 0, ox, oy, dx - ox, dy - oy);

            &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (colors) {
                gdImageTrueColorToPalette(dst, 1, 256);
            }

            gdImageDestroy(src);
        }
    }

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (transparent != -1 &amp;amp;&amp;amp; colors) {
        gdImageColorTransparent(dst, gdImageColorExact(dst, red, green, blue));
    }

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (conf-&amp;gt;filter == NGX_HTTP_IMAGE_WATERMARK &amp;amp;&amp;amp; conf-&amp;gt;watermark.data) {
        &lt;span style="color: #8ae234; font-weight: bold;"&gt;FILE&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;watermark_file&lt;/span&gt; = fopen((&lt;span style="color: #729fcf; font-weight: bold;"&gt;const&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;char&lt;/span&gt; *)conf-&amp;gt;watermark.data, &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"r"&lt;/span&gt;);
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (watermark_file) {
            &lt;span style="color: #8ae234; font-weight: bold;"&gt;gdImagePtr&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;watermark&lt;/span&gt;, &lt;span style="color: #eeeeec;"&gt;watermark_mix&lt;/span&gt;;
            &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_int_t&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;wdx&lt;/span&gt; = 0, &lt;span style="color: #eeeeec;"&gt;wdy&lt;/span&gt; = 0;
            
            watermark = gdImageCreateFromPng(watermark_file);
                
            &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt;(watermark != &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
                watermark_mix = gdImageCreateTrueColor(watermark-&amp;gt;sx, watermark-&amp;gt;sy);
                wdx = dx/2 - watermark-&amp;gt;sx/2;
                wdy = dy/2 - watermark-&amp;gt;sy/2;
                gdImageCopy(watermark_mix, dst, 0, 0, wdx, wdy, watermark-&amp;gt;sx, watermark-&amp;gt;sy);
                gdImageCopy(watermark_mix, watermark, 0, 0, 0, 0, watermark-&amp;gt;sx, watermark-&amp;gt;sy);
                gdImageCopyMerge(dst, watermark_mix, wdx, wdy, 0, 0, watermark-&amp;gt;sx, watermark-&amp;gt;sy, conf-&amp;gt;watermark_transparency);
                gdFree(watermark);
                gdFree(watermark_mix);
            } &lt;span style="color: #729fcf; font-weight: bold;"&gt;else&lt;/span&gt; { ngx_log_error(NGX_LOG_ERR, r-&amp;gt;connection-&amp;gt;log, 0, &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"watermark file '%s' is not PNG"&lt;/span&gt;, conf-&amp;gt;watermark.data);}
        } &lt;span style="color: #729fcf; font-weight: bold;"&gt;else&lt;/span&gt; {
            ngx_log_error(NGX_LOG_ERR, r-&amp;gt;connection-&amp;gt;log, 0, &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"watermark file '%s' not found"&lt;/span&gt;, conf-&amp;gt;watermark.data);
        }
    }
    
    sharpen = ngx_http_image_filter_get_value(r, conf-&amp;gt;shcv, conf-&amp;gt;sharpen);
    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (sharpen &amp;gt; 0) {
        gdImageSharpen(dst, sharpen);
    }

    out = ngx_http_image_out(r, ctx-&amp;gt;type, dst, &amp;amp;size);

    ngx_log_debug3(NGX_LOG_DEBUG_HTTP, r-&amp;gt;connection-&amp;gt;log, 0,
                   &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"image: %d x %d %d"&lt;/span&gt;, sx, sy, colors);

    gdImageDestroy(dst);
    ngx_pfree(r-&amp;gt;pool, ctx-&amp;gt;image);

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (out == &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;;
    }

    cln = ngx_pool_cleanup_add(r-&amp;gt;pool, 0);
    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (cln == &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
        gdFree(out);
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;;
    }

    b = ngx_pcalloc(r-&amp;gt;pool, &lt;span style="color: #729fcf; font-weight: bold;"&gt;sizeof&lt;/span&gt;(ngx_buf_t));
    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (b == &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
        gdFree(out);
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;;
    }

    cln-&amp;gt;handler = ngx_http_image_cleanup;
    cln-&amp;gt;data = out;

    b-&amp;gt;pos = out;
    b-&amp;gt;last = out + size;
    b-&amp;gt;memory = 1;
    b-&amp;gt;last_buf = 1;

    ngx_http_image_length(r, b);

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; b;
}


&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;gdImagePtr&lt;/span&gt;
&lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_source&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_request_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;r&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_image_filter_ctx_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;ctx&lt;/span&gt;)
{
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;char&lt;/span&gt;        *&lt;span style="color: #eeeeec;"&gt;failed&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;gdImagePtr&lt;/span&gt;   &lt;span style="color: #eeeeec;"&gt;img&lt;/span&gt;;

    img = &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;;

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;switch&lt;/span&gt; (ctx-&amp;gt;type) {

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;case&lt;/span&gt; NGX_HTTP_IMAGE_JPEG:
        img = gdImageCreateFromJpegPtr(ctx-&amp;gt;length, ctx-&amp;gt;image);
        failed = &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"gdImageCreateFromJpegPtr() failed"&lt;/span&gt;;
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;break&lt;/span&gt;;

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;case&lt;/span&gt; NGX_HTTP_IMAGE_GIF:
        img = gdImageCreateFromGifPtr(ctx-&amp;gt;length, ctx-&amp;gt;image);
        failed = &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"gdImageCreateFromGifPtr() failed"&lt;/span&gt;;
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;break&lt;/span&gt;;

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;case&lt;/span&gt; NGX_HTTP_IMAGE_PNG:
        img = gdImageCreateFromPngPtr(ctx-&amp;gt;length, ctx-&amp;gt;image);
        failed = &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"gdImageCreateFromPngPtr() failed"&lt;/span&gt;;
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;break&lt;/span&gt;;

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;default&lt;/span&gt;:
        failed = &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"unknown image type"&lt;/span&gt;;
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;break&lt;/span&gt;;
    }

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (img == &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
        ngx_log_error(NGX_LOG_ERR, r-&amp;gt;connection-&amp;gt;log, 0, failed);
    }

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; img;
}


&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;gdImagePtr&lt;/span&gt;
&lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_new&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_request_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;r&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;int&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;w&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;int&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;h&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;int&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;colors&lt;/span&gt;)
{
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;gdImagePtr&lt;/span&gt;  &lt;span style="color: #eeeeec;"&gt;img&lt;/span&gt;;

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (colors == 0) {
        img = gdImageCreateTrueColor(w, h);

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (img == &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
            ngx_log_error(NGX_LOG_ERR, r-&amp;gt;connection-&amp;gt;log, 0,
                          &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"gdImageCreateTrueColor() failed"&lt;/span&gt;);
            &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;;
        }

    } &lt;span style="color: #729fcf; font-weight: bold;"&gt;else&lt;/span&gt; {
        img = gdImageCreate(w, h);

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (img == &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
            ngx_log_error(NGX_LOG_ERR, r-&amp;gt;connection-&amp;gt;log, 0,
                          &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"gdImageCreate() failed"&lt;/span&gt;);
            &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;;
        }
    }

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; img;
}


&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;u_char&lt;/span&gt; *
&lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_out&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_request_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;r&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;type&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;gdImagePtr&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;img&lt;/span&gt;,
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;int&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;size&lt;/span&gt;)
{
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;char&lt;/span&gt;                          *&lt;span style="color: #eeeeec;"&gt;failed&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;u_char&lt;/span&gt;                        *&lt;span style="color: #eeeeec;"&gt;out&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_int_t&lt;/span&gt;                      &lt;span style="color: #eeeeec;"&gt;jq&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_image_filter_conf_t&lt;/span&gt;  *&lt;span style="color: #eeeeec;"&gt;conf&lt;/span&gt;;

    out = &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;;

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;switch&lt;/span&gt; (type) {

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;case&lt;/span&gt; NGX_HTTP_IMAGE_JPEG:
        conf = ngx_http_get_module_loc_conf(r, ngx_http_image_filter_module);

        jq = ngx_http_image_filter_get_value(r, conf-&amp;gt;jqcv, conf-&amp;gt;jpeg_quality);
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (jq &amp;lt;= 0) {
            &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;;
        }

        out = gdImageJpegPtr(img, size, jq);
        failed = &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"gdImageJpegPtr() failed"&lt;/span&gt;;
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;break&lt;/span&gt;;

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;case&lt;/span&gt; NGX_HTTP_IMAGE_GIF:
        out = gdImageGifPtr(img, size);
        failed = &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"gdImageGifPtr() failed"&lt;/span&gt;;
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;break&lt;/span&gt;;

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;case&lt;/span&gt; NGX_HTTP_IMAGE_PNG:
        out = gdImagePngPtr(img, size);
        failed = &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"gdImagePngPtr() failed"&lt;/span&gt;;
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;break&lt;/span&gt;;

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;default&lt;/span&gt;:
        failed = &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"unknown image type"&lt;/span&gt;;
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;break&lt;/span&gt;;
    }

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (out == &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
        ngx_log_error(NGX_LOG_ERR, r-&amp;gt;connection-&amp;gt;log, 0, failed);
    }

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; out;
}


&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;void&lt;/span&gt;
&lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_cleanup&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;void&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;data&lt;/span&gt;)
{
    gdFree(data);
}


&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt;
&lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_filter_get_value&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_request_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;r&lt;/span&gt;,
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_complex_value_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;cv&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;v&lt;/span&gt;)
{
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_str_t&lt;/span&gt;  &lt;span style="color: #eeeeec;"&gt;val&lt;/span&gt;;

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (cv == &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; v;
    }

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (ngx_http_complex_value(r, cv, &amp;amp;val) != NGX_OK) {
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; 0;
    }

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; ngx_http_image_filter_value(&amp;amp;val);
}


&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt;
&lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_filter_value&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_str_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;value&lt;/span&gt;)
{
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_int_t&lt;/span&gt;  &lt;span style="color: #eeeeec;"&gt;n&lt;/span&gt;;

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (value-&amp;gt;len == 1 &amp;amp;&amp;amp; value-&amp;gt;data[0] == &lt;span style="color: #ad7fa8; font-style: italic;"&gt;'-'&lt;/span&gt;) {
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; (&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt;) -1;
    }

    n = ngx_atoi(value-&amp;gt;data, value-&amp;gt;len);

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (n &amp;gt; 0) {
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; (&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt;) n;
    }

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; 0;
}


&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;void&lt;/span&gt; *
&lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_filter_create_conf&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_conf_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;cf&lt;/span&gt;)
{
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_image_filter_conf_t&lt;/span&gt;  *&lt;span style="color: #eeeeec;"&gt;conf&lt;/span&gt;;

    conf = ngx_pcalloc(cf-&amp;gt;pool, &lt;span style="color: #729fcf; font-weight: bold;"&gt;sizeof&lt;/span&gt;(ngx_http_image_filter_conf_t));
    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (conf == &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;;
    }

    &lt;span style="color: #888a85;"&gt;/*&lt;/span&gt;&lt;span style="color: #888a85;"&gt;
     * set by ngx_pcalloc():
     *
     *     conf-&amp;gt;width = 0;
     *     conf-&amp;gt;height = 0;
     *     conf-&amp;gt;angle = 0;
     *     conf-&amp;gt;wcv = NULL;
     *     conf-&amp;gt;hcv = NULL;
     *     conf-&amp;gt;acv = NULL;
     *     conf-&amp;gt;jqcv = NULL;
     *     conf-&amp;gt;shcv = NULL;
     &lt;/span&gt;&lt;span style="color: #888a85;"&gt;*/&lt;/span&gt;

    conf-&amp;gt;filter = NGX_CONF_UNSET_UINT;
    conf-&amp;gt;jpeg_quality = NGX_CONF_UNSET_UINT;
    conf-&amp;gt;sharpen = NGX_CONF_UNSET_UINT;
    conf-&amp;gt;transparency = NGX_CONF_UNSET;
    conf-&amp;gt;buffer_size = NGX_CONF_UNSET_SIZE;
    conf-&amp;gt;watermark_transparency = NGX_CONF_UNSET_UINT;

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; conf;
}


&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;char&lt;/span&gt; *
&lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_filter_merge_conf&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_conf_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;cf&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;void&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;parent&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;void&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;child&lt;/span&gt;)
{
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_image_filter_conf_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;prev&lt;/span&gt; = parent;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_image_filter_conf_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;conf&lt;/span&gt; = child;

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (conf-&amp;gt;filter == NGX_CONF_UNSET_UINT) {

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (prev-&amp;gt;filter == NGX_CONF_UNSET_UINT) {
            conf-&amp;gt;filter = NGX_HTTP_IMAGE_OFF;

        } &lt;span style="color: #729fcf; font-weight: bold;"&gt;else&lt;/span&gt; {
            conf-&amp;gt;filter = prev-&amp;gt;filter;
            conf-&amp;gt;width = prev-&amp;gt;width;
            conf-&amp;gt;height = prev-&amp;gt;height;
            conf-&amp;gt;angle = prev-&amp;gt;angle;
            conf-&amp;gt;wcv = prev-&amp;gt;wcv;
            conf-&amp;gt;hcv = prev-&amp;gt;hcv;
            conf-&amp;gt;acv = prev-&amp;gt;acv;
        }
    }

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (conf-&amp;gt;jpeg_quality == NGX_CONF_UNSET_UINT) {

        &lt;span style="color: #888a85;"&gt;/* &lt;/span&gt;&lt;span style="color: #888a85;"&gt;75 is libjpeg default quality &lt;/span&gt;&lt;span style="color: #888a85;"&gt;*/&lt;/span&gt;
        ngx_conf_merge_uint_value(conf-&amp;gt;jpeg_quality, prev-&amp;gt;jpeg_quality, 75);

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (conf-&amp;gt;jqcv == &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
            conf-&amp;gt;jqcv = prev-&amp;gt;jqcv;
        }
    }

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (conf-&amp;gt;sharpen == NGX_CONF_UNSET_UINT) {
        ngx_conf_merge_uint_value(conf-&amp;gt;sharpen, prev-&amp;gt;sharpen, 0);

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (conf-&amp;gt;shcv == &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
            conf-&amp;gt;shcv = prev-&amp;gt;shcv;
        }
    }

    ngx_conf_merge_value(conf-&amp;gt;transparency, prev-&amp;gt;transparency, 1);

    ngx_conf_merge_size_value(conf-&amp;gt;buffer_size, prev-&amp;gt;buffer_size,
                              1 * 1024 * 1024);

    ngx_conf_merge_str_value(conf-&amp;gt;watermark, prev-&amp;gt;watermark, &lt;span style="color: #ad7fa8; font-style: italic;"&gt;""&lt;/span&gt;);

    ngx_conf_merge_uint_value(conf-&amp;gt;watermark_transparency,
                              prev-&amp;gt;watermark_transparency, 90);
    
    &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_CONF_OK;
}


&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;char&lt;/span&gt; *
&lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_filter&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_conf_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;cf&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_command_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;cmd&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;void&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;conf&lt;/span&gt;)
{
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_image_filter_conf_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;imcf&lt;/span&gt; = conf;

    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_str_t&lt;/span&gt;                         *&lt;span style="color: #eeeeec;"&gt;value&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_int_t&lt;/span&gt;                          &lt;span style="color: #eeeeec;"&gt;n&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt;                         &lt;span style="color: #eeeeec;"&gt;i&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_complex_value_t&lt;/span&gt;           &lt;span style="color: #eeeeec;"&gt;cv&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_compile_complex_value_t&lt;/span&gt;   &lt;span style="color: #eeeeec;"&gt;ccv&lt;/span&gt;;

    value = cf-&amp;gt;args-&amp;gt;elts;

    i = 1;

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (cf-&amp;gt;args-&amp;gt;nelts == 2) {
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (ngx_strcmp(value[i].data, &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"off"&lt;/span&gt;) == 0) {
            imcf-&amp;gt;filter = NGX_HTTP_IMAGE_OFF;

        } &lt;span style="color: #729fcf; font-weight: bold;"&gt;else&lt;/span&gt; &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (ngx_strcmp(value[i].data, &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"test"&lt;/span&gt;) == 0) {
            imcf-&amp;gt;filter = NGX_HTTP_IMAGE_TEST;

        } &lt;span style="color: #729fcf; font-weight: bold;"&gt;else&lt;/span&gt; &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (ngx_strcmp(value[i].data, &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"size"&lt;/span&gt;) == 0) {
            imcf-&amp;gt;filter = NGX_HTTP_IMAGE_SIZE;

        } &lt;span style="color: #729fcf; font-weight: bold;"&gt;else&lt;/span&gt; &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (ngx_strcmp(value[i].data, &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"watermark"&lt;/span&gt;) == 0) {
            imcf-&amp;gt;filter = NGX_HTTP_IMAGE_WATERMARK;
            
        } &lt;span style="color: #729fcf; font-weight: bold;"&gt;else&lt;/span&gt; {
            &lt;span style="color: #729fcf; font-weight: bold;"&gt;goto&lt;/span&gt; &lt;span style="color: #8ae234;"&gt;failed&lt;/span&gt;;
        }

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_CONF_OK;

    } &lt;span style="color: #729fcf; font-weight: bold;"&gt;else&lt;/span&gt; &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (cf-&amp;gt;args-&amp;gt;nelts == 3) {

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (ngx_strcmp(value[i].data, &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"rotate"&lt;/span&gt;) == 0) {
            &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (imcf-&amp;gt;filter != NGX_HTTP_IMAGE_RESIZE
                &amp;amp;&amp;amp; imcf-&amp;gt;filter != NGX_HTTP_IMAGE_CROP)
            {
                imcf-&amp;gt;filter = NGX_HTTP_IMAGE_ROTATE;
            }

            ngx_memzero(&amp;amp;ccv, &lt;span style="color: #729fcf; font-weight: bold;"&gt;sizeof&lt;/span&gt;(ngx_http_compile_complex_value_t));

            ccv.cf = cf;
            ccv.value = &amp;amp;value[++i];
            ccv.complex_value = &amp;amp;cv;

            &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (ngx_http_compile_complex_value(&amp;amp;ccv) != NGX_OK) {
                &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_CONF_ERROR;
            }

            &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (cv.lengths == &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
                n = ngx_http_image_filter_value(&amp;amp;value[i]);

                &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (n != 90 &amp;amp;&amp;amp; n != 180 &amp;amp;&amp;amp; n != 270) {
                    &lt;span style="color: #729fcf; font-weight: bold;"&gt;goto&lt;/span&gt; &lt;span style="color: #8ae234;"&gt;failed&lt;/span&gt;;
                }

                imcf-&amp;gt;angle = (&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt;) n;

            } &lt;span style="color: #729fcf; font-weight: bold;"&gt;else&lt;/span&gt; {
                imcf-&amp;gt;acv = ngx_palloc(cf-&amp;gt;pool,
                                       &lt;span style="color: #729fcf; font-weight: bold;"&gt;sizeof&lt;/span&gt;(ngx_http_complex_value_t));
                &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (imcf-&amp;gt;acv == &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
                    &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_CONF_ERROR;
                }

                *imcf-&amp;gt;acv = cv;
            }

            &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_CONF_OK;

        } &lt;span style="color: #729fcf; font-weight: bold;"&gt;else&lt;/span&gt; {
            &lt;span style="color: #729fcf; font-weight: bold;"&gt;goto&lt;/span&gt; &lt;span style="color: #8ae234;"&gt;failed&lt;/span&gt;;
        }
    }

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (ngx_strcmp(value[i].data, &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"resize"&lt;/span&gt;) == 0) {
        imcf-&amp;gt;filter = NGX_HTTP_IMAGE_RESIZE;

    } &lt;span style="color: #729fcf; font-weight: bold;"&gt;else&lt;/span&gt; &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (ngx_strcmp(value[i].data, &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"crop"&lt;/span&gt;) == 0) {
        imcf-&amp;gt;filter = NGX_HTTP_IMAGE_CROP;

    } &lt;span style="color: #729fcf; font-weight: bold;"&gt;else&lt;/span&gt; {
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;goto&lt;/span&gt; &lt;span style="color: #8ae234;"&gt;failed&lt;/span&gt;;
    }

    ngx_memzero(&amp;amp;ccv, &lt;span style="color: #729fcf; font-weight: bold;"&gt;sizeof&lt;/span&gt;(ngx_http_compile_complex_value_t));

    ccv.cf = cf;
    ccv.value = &amp;amp;value[++i];
    ccv.complex_value = &amp;amp;cv;

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (ngx_http_compile_complex_value(&amp;amp;ccv) != NGX_OK) {
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_CONF_ERROR;
    }

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (cv.lengths == &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
        n = ngx_http_image_filter_value(&amp;amp;value[i]);

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (n == 0) {
            &lt;span style="color: #729fcf; font-weight: bold;"&gt;goto&lt;/span&gt; &lt;span style="color: #8ae234;"&gt;failed&lt;/span&gt;;
        }

        imcf-&amp;gt;width = (&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt;) n;

    } &lt;span style="color: #729fcf; font-weight: bold;"&gt;else&lt;/span&gt; {
        imcf-&amp;gt;wcv = ngx_palloc(cf-&amp;gt;pool, &lt;span style="color: #729fcf; font-weight: bold;"&gt;sizeof&lt;/span&gt;(ngx_http_complex_value_t));
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (imcf-&amp;gt;wcv == &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
            &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_CONF_ERROR;
        }

        *imcf-&amp;gt;wcv = cv;
    }

    ngx_memzero(&amp;amp;ccv, &lt;span style="color: #729fcf; font-weight: bold;"&gt;sizeof&lt;/span&gt;(ngx_http_compile_complex_value_t));

    ccv.cf = cf;
    ccv.value = &amp;amp;value[++i];
    ccv.complex_value = &amp;amp;cv;

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (ngx_http_compile_complex_value(&amp;amp;ccv) != NGX_OK) {
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_CONF_ERROR;
    }

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (cv.lengths == &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
        n = ngx_http_image_filter_value(&amp;amp;value[i]);

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (n == 0) {
            &lt;span style="color: #729fcf; font-weight: bold;"&gt;goto&lt;/span&gt; &lt;span style="color: #8ae234;"&gt;failed&lt;/span&gt;;
        }

        imcf-&amp;gt;height = (&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt;) n;

    } &lt;span style="color: #729fcf; font-weight: bold;"&gt;else&lt;/span&gt; {
        imcf-&amp;gt;hcv = ngx_palloc(cf-&amp;gt;pool, &lt;span style="color: #729fcf; font-weight: bold;"&gt;sizeof&lt;/span&gt;(ngx_http_complex_value_t));
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (imcf-&amp;gt;hcv == &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
            &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_CONF_ERROR;
        }

        *imcf-&amp;gt;hcv = cv;
    }

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_CONF_OK;

&lt;span style="color: #8ae234;"&gt;failed&lt;/span&gt;:

    ngx_conf_log_error(NGX_LOG_EMERG, cf, 0, &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"invalid parameter \"%V\""&lt;/span&gt;,
                       &amp;amp;value[i]);

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_CONF_ERROR;
}


&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;char&lt;/span&gt; *
&lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_filter_jpeg_quality&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_conf_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;cf&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_command_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;cmd&lt;/span&gt;,
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;void&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;conf&lt;/span&gt;)
{
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_image_filter_conf_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;imcf&lt;/span&gt; = conf;

    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_str_t&lt;/span&gt;                         *&lt;span style="color: #eeeeec;"&gt;value&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_int_t&lt;/span&gt;                          &lt;span style="color: #eeeeec;"&gt;n&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_complex_value_t&lt;/span&gt;           &lt;span style="color: #eeeeec;"&gt;cv&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_compile_complex_value_t&lt;/span&gt;   &lt;span style="color: #eeeeec;"&gt;ccv&lt;/span&gt;;

    value = cf-&amp;gt;args-&amp;gt;elts;

    ngx_memzero(&amp;amp;ccv, &lt;span style="color: #729fcf; font-weight: bold;"&gt;sizeof&lt;/span&gt;(ngx_http_compile_complex_value_t));

    ccv.cf = cf;
    ccv.value = &amp;amp;value[1];
    ccv.complex_value = &amp;amp;cv;

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (ngx_http_compile_complex_value(&amp;amp;ccv) != NGX_OK) {
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_CONF_ERROR;
    }

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (cv.lengths == &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
        n = ngx_http_image_filter_value(&amp;amp;value[1]);

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (n &amp;lt;= 0) {
            ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,
                               &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"invalid value \"%V\""&lt;/span&gt;, &amp;amp;value[1]);
            &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_CONF_ERROR;
        }

        imcf-&amp;gt;jpeg_quality = (&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt;) n;

    } &lt;span style="color: #729fcf; font-weight: bold;"&gt;else&lt;/span&gt; {
        imcf-&amp;gt;jqcv = ngx_palloc(cf-&amp;gt;pool, &lt;span style="color: #729fcf; font-weight: bold;"&gt;sizeof&lt;/span&gt;(ngx_http_complex_value_t));
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (imcf-&amp;gt;jqcv == &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
            &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_CONF_ERROR;
        }

        *imcf-&amp;gt;jqcv = cv;
    }

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_CONF_OK;
}


&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;char&lt;/span&gt; *
&lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_filter_sharpen&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_conf_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;cf&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_command_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;cmd&lt;/span&gt;,
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;void&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;conf&lt;/span&gt;)
{
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_image_filter_conf_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;imcf&lt;/span&gt; = conf;

    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_str_t&lt;/span&gt;                         *&lt;span style="color: #eeeeec;"&gt;value&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_int_t&lt;/span&gt;                          &lt;span style="color: #eeeeec;"&gt;n&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_complex_value_t&lt;/span&gt;           &lt;span style="color: #eeeeec;"&gt;cv&lt;/span&gt;;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_http_compile_complex_value_t&lt;/span&gt;   &lt;span style="color: #eeeeec;"&gt;ccv&lt;/span&gt;;

    value = cf-&amp;gt;args-&amp;gt;elts;

    ngx_memzero(&amp;amp;ccv, &lt;span style="color: #729fcf; font-weight: bold;"&gt;sizeof&lt;/span&gt;(ngx_http_compile_complex_value_t));

    ccv.cf = cf;
    ccv.value = &amp;amp;value[1];
    ccv.complex_value = &amp;amp;cv;

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (ngx_http_compile_complex_value(&amp;amp;ccv) != NGX_OK) {
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_CONF_ERROR;
    }

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (cv.lengths == &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
        n = ngx_http_image_filter_value(&amp;amp;value[1]);

        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (n &amp;lt; 0) {
            ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,
                               &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"invalid value \"%V\""&lt;/span&gt;, &amp;amp;value[1]);
            &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_CONF_ERROR;
        }

        imcf-&amp;gt;sharpen = (&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_uint_t&lt;/span&gt;) n;

    } &lt;span style="color: #729fcf; font-weight: bold;"&gt;else&lt;/span&gt; {
        imcf-&amp;gt;shcv = ngx_palloc(cf-&amp;gt;pool, &lt;span style="color: #729fcf; font-weight: bold;"&gt;sizeof&lt;/span&gt;(ngx_http_complex_value_t));
        &lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; (imcf-&amp;gt;shcv == &lt;span style="color: #8ae234;"&gt;NULL&lt;/span&gt;) {
            &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_CONF_ERROR;
        }

        *imcf-&amp;gt;shcv = cv;
    }

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_CONF_OK;
}


&lt;span style="color: #729fcf; font-weight: bold;"&gt;static&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_int_t&lt;/span&gt;
&lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;ngx_http_image_filter_init&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;ngx_conf_t&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;cf&lt;/span&gt;)
{
    ngx_http_next_header_filter = ngx_http_top_header_filter;
    ngx_http_top_header_filter = ngx_http_image_header_filter;

    ngx_http_next_body_filter = ngx_http_top_body_filter;
    ngx_http_top_body_filter = ngx_http_image_body_filter;

    &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; NGX_OK;
}
&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;


&lt;/div&gt;

&lt;/div&gt;

&lt;div id="outline-container-3-3" class="outline-4"&gt;
&lt;h4 id="sec-3-3"&gt;&#32534;&#35793;&lt;/h4&gt;
&lt;div class="outline-text-4" id="text-3-3"&gt;




&lt;pre class="src src-sh"&gt;--with-debug --with-http_image_filter_module --add-module=/home/tangxinfa/Opensource/nginx-1.2.7/../ngx_http_qrcode_module/ --add-module=/home/tangxinfa/Opensource/nginx-1.2.7/../ngx_devel_kit/ --add-module=/home/tangxinfa/Opensource/nginx-1.2.7/../set-misc-nginx-module/ --add-module=/home/tangxinfa/Opensource/nginx-1.2.7/../echo-nginx-module/
&lt;/pre&gt;


&lt;/div&gt;

&lt;/div&gt;

&lt;div id="outline-container-3-4" class="outline-4"&gt;
&lt;h4 id="sec-3-4"&gt;&#37197;&#32622;&lt;/h4&gt;
&lt;div class="outline-text-4" id="text-3-4"&gt;




&lt;pre class="example"&gt;location ~ /qr {
    qrcode_fg_color FF0000;
    qrcode_bg_color FFFFFF;    
    qrcode_level 2;
    qrcode_hint 2;
    qrcode_size 120;
    qrcode_margin 2;
    qrcode_version 5;
    set_unescape_uri $txt $arg_txt;
    qrcode_txt $txt;
    qrcode_casesensitive 1; 
    qrcode_gen;  

    image_filter_watermark "/usr/share/pixmaps/gnome-word.png";
    image_filter_watermark_transparency 95; #0-100
    image_filter watermark;
}
&lt;/pre&gt;


&lt;/div&gt;

&lt;/div&gt;

&lt;div id="outline-container-3-5" class="outline-4"&gt;
&lt;h4 id="sec-3-5"&gt;&#35775;&#38382;&lt;/h4&gt;
&lt;div class="outline-text-4" id="text-3-5"&gt;




&lt;pre class="example"&gt;http://localhost:8080/qr?txt=hello
&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;&#26174;&#31034;&#25928;&#26524;&#65306;
&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;     &lt;img src="../../../posts/2013/03/30_4e8c7ef4780178147a76/hello_qr.png"  alt="../../../posts/2013/03/30_4e8c7ef4780178147a76/hello_qr.png" /&gt;
&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;

&lt;/div&gt;

&lt;div id="outline-container-4" class="outline-3"&gt;
&lt;h3 id="sec-4"&gt;&#20108;&#32500;&#30721;&#22522;&#30784;&#26381;&#21153;&#30340;&#19968;&#28857;&#24605;&#32034;&lt;/h3&gt;
&lt;div class="outline-text-3" id="text-4"&gt;

&lt;ul&gt;
&lt;li&gt;&#24517;&#39035;&#24314;&#31435;&#22312;cdn&#30340;&#22522;&#30784;&#19978;
&lt;/li&gt;
&lt;li&gt;&#29992;&#25143;&#21482;&#38656;&#25353;&#29031;&#32422;&#23450;&#23558;&#20869;&#23481;&#20197;&#21450;&#23450;&#21046;&#21442;&#25968;&#25353;&#29031;&#30452;&#35266;&#30340;&#26041;&#24335;&#32534;&#30721;&#25104;&#20108;&#32500;&#30721;&#22270;&#29255;&#38142;&#25509;&#21363;&#21487;
&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;
   &#21442;&#32771;&#65306;&lt;a href="https://developers.google.com/chart/infographics/docs/qr_codes"&gt;https://developers.google.com/chart/infographics/docs/qr_codes&lt;/a&gt;
&lt;/p&gt;&lt;/div&gt;
&lt;/div&gt;
</content></entry><entry><title type="html">Archlinux下安装cups打印系统</title><author><name>nil</name></author><link href="http://blog.kankanan.com/posts/2013/03/27_archlinux4e0b5b8988c5cups625353707cfb7edf.html"/><updated>2013-03-27T21:56:00Z</updated><published>2013-03-27T21:56:00Z</published><id>posts/2013/03/27_archlinux4e0b5b8988c5cups625353707cfb7edf.html</id><category scheme="/tags/archlinux.html" term="archlinux" label="archlinux"/><content type="html">&lt;dl&gt;
&lt;dt&gt;&#23433;&#35013;&lt;/dt&gt;&lt;dd&gt;
&lt;/dd&gt;
&lt;/dl&gt;




&lt;pre class="src src-sh"&gt;yaourt -S cups-pdf
&lt;/pre&gt;


&lt;dl&gt;
&lt;dt&gt;&#21551;&#21160;&lt;/dt&gt;&lt;dd&gt;
&lt;/dd&gt;
&lt;/dl&gt;




&lt;pre class="src src-sh"&gt;sudo systemctl start cups
&lt;/pre&gt;


&lt;dl&gt;
&lt;dt&gt;&#37197;&#32622;&lt;/dt&gt;&lt;dd&gt;
&lt;p&gt;
    &#21442;&#32771;&#65306;&lt;a href="https://wiki.archlinux.org/index.php/Cups#PDF_virtual_printer"&gt;https://wiki.archlinux.org/index.php/Cups#PDF_virtual_printer&lt;/a&gt;
&lt;/p&gt;
&lt;p&gt;
    &#30331;&#24405;&#30340;&#29992;&#25143;&#21517;&#35201;&#20026;root&#65292;&#21542;&#21017;&#21518;&#38754;&#36824;&#26159;&#26080;&#27861;&#28155;&#21152;&#25171;&#21360;&#26426;&#65292;web&#30028;&#38754;&#27809;&#26377;&#36864;&#20986;&#30331;&#24405;&#30340;&#36873;&#39033;&#65292;&#21487;&#20197;&#35797;&#35797;&#37325;&#21551;cups&#26381;&#21153;&#27983;&#35272;&#22120;&#28165;&#38500;&#32531;&#23384;&#30340;&#25968;&#25454;&#12290;
&lt;/p&gt;&lt;/dd&gt;
&lt;/dl&gt;

</content></entry><entry><title type="html">python中的UTC与本地时区处理</title><author><name>nil</name></author><link href="http://blog.kankanan.com/posts/2013/03/20_python4e2d7684utc4e0e672c573065f6533a59047406.html"/><updated>2013-03-20T17:29:00Z</updated><published>2013-03-20T17:29:00Z</published><id>posts/2013/03/20_python4e2d7684utc4e0e672c573065f6533a59047406.html</id><category scheme="/tags/python.html" term="python" label="python"/><content type="html">&lt;p&gt;
  &#22312;&#36890;&#36807;sqlalchemy&#20351;&#29992;sqlite3&#25968;&#25454;&#24211;&#30340;&#36807;&#31243;&#20013;&#65292;&#21457;&#29616;&#26085;&#26399;&#26102;&#38388;&#23383;&#27573;&#40664;&#35748;&#20540;&#20026;CURRENT_TIMESTAMP&#65292;&#20294;&#26159;&#26597;&#20986;&#30340;&#20540;&#23569;&#20102;8&#20010;&#23567;&#26102;&#12290;&#24456;&#26126;&#26174;&#26159;&#36935;&#21040;&#26102;&#21306;&#38382;&#39064;&#20102;&#12290;
&lt;/p&gt;
&lt;p&gt;
  mysql&#30340;TIMESTAMP&#23383;&#27573;&#31867;&#22411;&#21644;sqlite3&#19968;&#26679;&#20351;&#29992;UTC&#26102;&#38388;&#20445;&#23384;&#65292;&#22240;&#20026;&#22312;&#23384;&#21462;&#26102;&#33258;&#21160;&#36827;&#34892;&#20102;&#26412;&#22320;&#26102;&#38388;&#19982;UTC&#26102;&#38388;&#20114;&#36716;&#65292;&#25152;&#20197;&#19981;&#20250;&#36935;&#21040;&#26102;&#21306;&#38382;&#39064;&#12290;&#20294;&#26159;sqlite3&#27809;&#26377;&#33258;&#21160;&#36827;&#34892;&#36825;&#19968;&#36716;&#25442;&#65292;&#38656;&#35201;&#22312;sql&#20013;&#33258;&#34892;&#36716;&#25442;:
&lt;/p&gt;


&lt;pre class="src src-sql"&gt;select datetime(CURRENT_TIMESTAMP, &lt;span style="color: #ad7fa8; font-style: italic;"&gt;'localtime'&lt;/span&gt;)
&lt;/pre&gt;


&lt;p&gt;
  &#36827;&#19968;&#27493;google&#21518;&#65292;&#25214;&#21040;&#20102;&#36825;&#31687;&#25991;&#31456;&#65306;&#12298;&lt;a href="http://lucumr.pocoo.org/2011/7/15/eppur-si-muove/"&gt;Dealing with Timezones in Python&lt;/a&gt;&#12299;&#65292;&#25991;&#31456;&#22823;&#24847;&#26159;python&#20013;&#30340;datetime&#24211;&#40664;&#35748;&#19981;&#25658;&#24102;&#26102;&#21306;&#20449;&#24687;&#65292;&#32780;&#21152;&#19978;&#26102;&#21306;&#21518;&#21448;&#19982;&#19981;&#24102;&#26102;&#21306;&#30340;datetime&#23545;&#35937;&#26080;&#27861;&#19968;&#36215;&#24037;&#20316;&#65288;&#22914;&#65306;&#27604;&#36739;&#65289;&#65292;&#21478;&#22806;&#20687;datetime.datetime.utcnow()&#36820;&#22238;&#30340;utc&#26102;&#38388;&#21644;datetime.datetime.now()&#36820;&#22238;&#30340;&#26412;&#22320;&#26102;&#38388;&#20063;&#26159;&#19981;&#25658;&#24102;&#26102;&#21306;&#20449;&#24687;&#30340;&#65288;tzinfo&#23646;&#24615;&#20026;None&#65289;&#65292;&#23481;&#26131;&#24341;&#36215;&#28151;&#28102;&#65292;&#22240;&#27492;&#22788;&#29702;&#30340;&#31616;&#21333;&#24615;&#65292;&#20869;&#37096;&#26368;&#22909;&#32479;&#19968;&#20351;&#29992;UTC&#26631;&#20934;&#26102;&#38388;&#65292;&#21644;&#29992;&#25143;&#20132;&#20114;&#26102;&#20877;&#36716;&#25442;&#20026;&#26412;&#22320;&#26102;&#38388;&#12290;
&lt;/p&gt;
&lt;p&gt;
  &#19979;&#38754;&#26159;&#20114;&#36716;&#30340;&#31639;&#27861;&#65306;
&lt;/p&gt;


&lt;pre class="src src-python"&gt;&lt;span style="color: #888a85;"&gt;#&lt;/span&gt;&lt;span style="color: #888a85;"&gt;/usr/bin/env python&lt;/span&gt;

&lt;span style="color: #729fcf; font-weight: bold;"&gt;import&lt;/span&gt; datetime
&lt;span style="color: #729fcf; font-weight: bold;"&gt;import&lt;/span&gt; time
&lt;span style="color: #729fcf; font-weight: bold;"&gt;import&lt;/span&gt; sys

&lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; sys.version &amp;gt;= &lt;span style="color: #ad7fa8; font-style: italic;"&gt;'3.2.'&lt;/span&gt;:
    &lt;span style="color: #eeeeec;"&gt;localtimezone&lt;/span&gt; = datetime.timezone(datetime.timedelta(seconds=-time.timezone), time.tzname[0])
    &lt;span style="color: #eeeeec;"&gt;utctimezone&lt;/span&gt; = datetime.timezone.utc
&lt;span style="color: #729fcf; font-weight: bold;"&gt;else&lt;/span&gt;:
    &lt;span style="color: #729fcf; font-weight: bold;"&gt;from&lt;/span&gt; dateutil &lt;span style="color: #729fcf; font-weight: bold;"&gt;import&lt;/span&gt; tz
    &lt;span style="color: #eeeeec;"&gt;localtimezone&lt;/span&gt; = tz.tzlocal()
    &lt;span style="color: #eeeeec;"&gt;utctimezone&lt;/span&gt; = tz.gettz(&lt;span style="color: #ad7fa8; font-style: italic;"&gt;'UTC'&lt;/span&gt;)

&lt;span style="color: #729fcf; font-weight: bold;"&gt;def&lt;/span&gt; &lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;parsedatetime&lt;/span&gt;(dt, fmt=&lt;span style="color: #ad7fa8; font-style: italic;"&gt;"%Y-%m-%d %H:%M:%S"&lt;/span&gt;):
    &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"""parse local datetime string as utc datetime object"""&lt;/span&gt;
    &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; datetime.datetime.strptime(dt, fmt).replace(tzinfo=localtimezone).astimezone(utctimezone)

&lt;span style="color: #729fcf; font-weight: bold;"&gt;def&lt;/span&gt; &lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;formatdatetime&lt;/span&gt;(dt, fmt=&lt;span style="color: #ad7fa8; font-style: italic;"&gt;"%Y-%m-%d %H:%M:%S"&lt;/span&gt;):
    &lt;span style="color: #ad7fa8; font-style: italic;"&gt;"""format utc datetime object as local datetime string"""&lt;/span&gt;
    &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; dt.replace(tzinfo=utctimezone).astimezone(localtimezone).strftime(fmt)

&lt;span style="color: #729fcf; font-weight: bold;"&gt;if&lt;/span&gt; &lt;span style="color: #729fcf;"&gt;__name__&lt;/span&gt; == &lt;span style="color: #ad7fa8; font-style: italic;"&gt;'__main__'&lt;/span&gt;:
    input_local_datetime = &lt;span style="color: #ad7fa8; font-style: italic;"&gt;'2012-01-02 03:04:05'&lt;/span&gt;
    parsed_utc_datetime = parsedatetime(input_local_datetime)
    &lt;span style="color: #729fcf; font-weight: bold;"&gt;assert&lt;/span&gt;(formatdatetime(parsed_utc_datetime) == input_local_datetime)
&lt;/pre&gt;

</content></entry><entry><title type="html">C++的函数、闭包与协程</title><author><name>nil</name></author><link href="http://blog.kankanan.com/posts/2013/03/15_c2b2b768451fd6570300195ed53054e0e534f7a0b.html"/><updated>2013-03-15T10:04:00Z</updated><published>2013-03-15T10:04:00Z</published><id>posts/2013/03/15_c2b2b768451fd6570300195ed53054e0e534f7a0b.html</id><category scheme="/tags/cpp.html" term="cpp" label="cpp"/><content type="html">&lt;div id="outline-container-1" class="outline-3"&gt;
&lt;h3 id="sec-1"&gt;&#23454;&#29616;&#24207;&#21495;&#29983;&#25104;&#22120;&lt;/h3&gt;
&lt;div class="outline-text-3" id="text-1"&gt;


&lt;/div&gt;

&lt;div id="outline-container-1-1" class="outline-4"&gt;
&lt;h4 id="sec-1-1"&gt;&#20989;&#25968;&#65288;Function&#65289;&lt;/h4&gt;
&lt;div class="outline-text-4" id="text-1-1"&gt;




&lt;pre class="src src-c++"&gt;&lt;span style="color: #729fcf;"&gt;#include&lt;/span&gt; &lt;span style="color: #ad7fa8; font-style: italic;"&gt;&amp;lt;cassert&amp;gt;&lt;/span&gt;

&lt;span style="color: #8ae234; font-weight: bold;"&gt;int&lt;/span&gt; &lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;id_generator&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;int&lt;/span&gt;&amp;amp; &lt;span style="color: #eeeeec;"&gt;base&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;int&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;step&lt;/span&gt;)
{
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;int&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;result&lt;/span&gt; = *base;
    *base += step;
    &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; result;
}

&lt;span style="color: #8ae234; font-weight: bold;"&gt;int&lt;/span&gt; &lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;main&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;int&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;argc&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;char&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;argv&lt;/span&gt;[])
{
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;int&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;odd_base&lt;/span&gt; = 1;
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;int&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;even_base&lt;/span&gt; = 0;    
    assert(id_generator(odd_base, 2) == 1);
    assert(id_generator(odd_base, 2) == 3);
    assert(id_generator(odd_base, 2) == 5);
    assert(id_generator(even_base, 2) == 0);
    assert(id_generator(even_base, 2) == 2);
    assert(id_generator(even_base, 2) == 4);        
    &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; 0;
}
&lt;/pre&gt;


&lt;dl&gt;
&lt;dt&gt;&#32534;&#35793;&lt;/dt&gt;&lt;dd&gt;



&lt;pre class="example"&gt;g++ -g add.cpp -o add
&lt;/pre&gt;

&lt;/dd&gt;
&lt;/dl&gt;


&lt;/div&gt;

&lt;/div&gt;

&lt;div id="outline-container-1-2" class="outline-4"&gt;
&lt;h4 id="sec-1-2"&gt;&#38381;&#21253;&#65288;Closure&#65289;&lt;/h4&gt;
&lt;div class="outline-text-4" id="text-1-2"&gt;




&lt;pre class="src src-c++"&gt;&lt;span style="color: #729fcf;"&gt;#include&lt;/span&gt; &lt;span style="color: #ad7fa8; font-style: italic;"&gt;&amp;lt;cassert&amp;gt;&lt;/span&gt;

&lt;span style="color: #8ae234; font-weight: bold;"&gt;int&lt;/span&gt; &lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;main&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;int&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;argc&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;char&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;argv&lt;/span&gt;[])
{
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;int&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;base&lt;/span&gt; = 1;
    &lt;span style="color: #729fcf; font-weight: bold;"&gt;auto&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;id_generator_odd&lt;/span&gt; = [=]() &lt;span style="color: #729fcf; font-weight: bold;"&gt;mutable&lt;/span&gt; { &lt;span style="color: #8ae234; font-weight: bold;"&gt;int&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;result&lt;/span&gt; = base; base += 2; &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; result; };
    base = 0;
    &lt;span style="color: #729fcf; font-weight: bold;"&gt;auto&lt;/span&gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;id_generator_even&lt;/span&gt; = [=]() &lt;span style="color: #729fcf; font-weight: bold;"&gt;mutable&lt;/span&gt; { &lt;span style="color: #8ae234; font-weight: bold;"&gt;int&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;result&lt;/span&gt; = base; base += 2; &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; result; };
    assert(id_generator_odd() == 1);
    assert(id_generator_odd() == 3);
    assert(id_generator_odd() == 5);
    assert(id_generator_even() == 0);
    assert(id_generator_even() == 2);
    assert(id_generator_even() == 4);
    assert(base == 0);
    &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; 0;
}
&lt;/pre&gt;


&lt;dl&gt;
&lt;dt&gt;&#32534;&#35793;&lt;/dt&gt;&lt;dd&gt;



&lt;pre class="example"&gt;g++ -g closure.cpp -o closure -std=c++0x
&lt;/pre&gt;

&lt;/dd&gt;
&lt;/dl&gt;


&lt;/div&gt;

&lt;/div&gt;

&lt;div id="outline-container-1-3" class="outline-4"&gt;
&lt;h4 id="sec-1-3"&gt;&#21327;&#31243;&#65288;Coroutine&#65289;&lt;/h4&gt;
&lt;div class="outline-text-4" id="text-1-3"&gt;




&lt;pre class="src src-c++"&gt;&lt;span style="color: #729fcf;"&gt;#include&lt;/span&gt; &lt;span style="color: #ad7fa8; font-style: italic;"&gt;&amp;lt;boost/bind.hpp&amp;gt;&lt;/span&gt;
&lt;span style="color: #729fcf;"&gt;#include&lt;/span&gt; &lt;span style="color: #ad7fa8; font-style: italic;"&gt;&amp;lt;boost/coroutine/all.hpp&amp;gt;&lt;/span&gt;

&lt;span style="color: #729fcf; font-weight: bold;"&gt;typedef&lt;/span&gt; &lt;span style="color: #8ae234;"&gt;boost&lt;/span&gt;::&lt;span style="color: #8ae234;"&gt;coroutines&lt;/span&gt;::&lt;span style="color: #8ae234; font-weight: bold;"&gt;coroutine&lt;/span&gt;&amp;lt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;int&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;void&lt;/span&gt;) &amp;gt; &lt;span style="color: #8ae234; font-weight: bold;"&gt;IDGenerator&lt;/span&gt;;

&lt;span style="color: #8ae234; font-weight: bold;"&gt;void&lt;/span&gt; &lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;idGenerator&lt;/span&gt;(&lt;span style="color: #8ae234;"&gt;IDGenerator&lt;/span&gt;::&lt;span style="color: #8ae234; font-weight: bold;"&gt;caller_type&lt;/span&gt;&amp;amp; &lt;span style="color: #eeeeec;"&gt;ca&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;int&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;base&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;int&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;step&lt;/span&gt;)
{
    &lt;span style="color: #729fcf; font-weight: bold;"&gt;do&lt;/span&gt;{
        ca(base);
        base += step;
    }&lt;span style="color: #729fcf; font-weight: bold;"&gt;while&lt;/span&gt;(&lt;span style="color: #8ae234;"&gt;true&lt;/span&gt;);
}

&lt;span style="color: #8ae234; font-weight: bold;"&gt;int&lt;/span&gt; &lt;span style="color: #edd400; font-weight: bold; font-style: italic;"&gt;main&lt;/span&gt;(&lt;span style="color: #8ae234; font-weight: bold;"&gt;int&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;argc&lt;/span&gt;, &lt;span style="color: #8ae234; font-weight: bold;"&gt;char&lt;/span&gt; *&lt;span style="color: #eeeeec;"&gt;argv&lt;/span&gt;[])
{
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;IDGenerator&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;id_generator_odd&lt;/span&gt;(&lt;span style="color: #8ae234;"&gt;boost&lt;/span&gt;::bind(idGenerator, _1, 1, 2));
    &lt;span style="color: #8ae234; font-weight: bold;"&gt;IDGenerator&lt;/span&gt; &lt;span style="color: #eeeeec;"&gt;id_generator_even&lt;/span&gt;(&lt;span style="color: #8ae234;"&gt;boost&lt;/span&gt;::bind(idGenerator, _1, 0, 2));
    assert(id_generator_odd.get() == 1);
    assert(id_generator_odd().get() == 3);
    assert(id_generator_odd().get() == 5);
    assert(id_generator_even.get() == 0);
    assert(id_generator_even().get() == 2);
    assert(id_generator_even().get() == 4);
    &lt;span style="color: #729fcf; font-weight: bold;"&gt;return&lt;/span&gt; 0;
}
&lt;/pre&gt;


&lt;dl&gt;
&lt;dt&gt;&#32534;&#35793;&lt;/dt&gt;&lt;dd&gt;



&lt;pre class="example"&gt;g++ -g coroutine.cpp -lboost_context -o coroutine -std=c++0x
&lt;/pre&gt;

&lt;/dd&gt;
&lt;/dl&gt;


&lt;/div&gt;
&lt;/div&gt;

&lt;/div&gt;

&lt;div id="outline-container-2" class="outline-3"&gt;
&lt;h3 id="sec-2"&gt;&#29305;&#24615;&#27604;&#36739;&lt;/h3&gt;
&lt;div class="outline-text-3" id="text-2"&gt;


&lt;/div&gt;

&lt;div id="outline-container-2-1" class="outline-4"&gt;
&lt;h4 id="sec-2-1"&gt;&#20989;&#25968;&#65288;Function&#65289;&lt;/h4&gt;
&lt;div class="outline-text-4" id="text-2-1"&gt;

&lt;ul&gt;
&lt;li&gt;&#26080;&#29366;&#24577;
&lt;/li&gt;
&lt;li&gt;&#38656;&#35201;&#29420;&#31435;&#23450;&#20041;&#25191;&#34892;&#20307;
&lt;/li&gt;
&lt;li&gt;&#35843;&#29992;&#36807;&#31243;&#20013;&#20174;&#22836;&#21040;&#23614;&#25191;&#34892;&#20307;&#20869;&#25152;&#26377;&#20195;&#30721;
&lt;/li&gt;
&lt;li&gt;&#22312;&#36755;&#20837;&#30456;&#21516;&#30340;&#24773;&#20917;&#19979;&#65292;&#33021;&#22815;&#20445;&#35777;&#36755;&#20986;&#20063;&#30456;&#21516;
&lt;/li&gt;
&lt;li&gt;&#27809;&#26377;&#21103;&#20316;&#29992;&#65292;&#22810;&#32447;&#31243;&#23433;&#20840;
&lt;/li&gt;
&lt;li&gt;&#35201;&#20511;&#21161;&#22806;&#37096;&#21464;&#37327;&#20445;&#23384;&#29366;&#24577;
&lt;/li&gt;
&lt;li&gt;&#35843;&#29992;&#27604;&#36739;&#40635;&#28902;&#65292;&#38656;&#35201;&#20256;&#20837;&#20445;&#23384;&#29366;&#24577;&#30340;&#21442;&#25968;
&lt;/li&gt;
&lt;/ul&gt;


&lt;/div&gt;

&lt;/div&gt;

&lt;div id="outline-container-2-2" class="outline-4"&gt;
&lt;h4 id="sec-2-2"&gt;&#38381;&#21253;&#65288;Closure&#65289;&lt;/h4&gt;
&lt;div class="outline-text-4" id="text-2-2"&gt;

&lt;ul&gt;
&lt;li&gt;&#26377;&#29366;&#24577;&#65292;&#20869;&#37096;&#30452;&#25509;&#20445;&#23384;
&lt;/li&gt;
&lt;li&gt;&#30452;&#25509;&#20869;&#32852;&#23450;&#20041;&#25191;&#34892;&#20307;
&lt;/li&gt;
&lt;li&gt;&#35843;&#29992;&#36807;&#31243;&#20013;&#20174;&#22836;&#21040;&#23614;&#25191;&#34892;&#20307;&#20869;&#25152;&#26377;&#20195;&#30721;
&lt;/li&gt;
&lt;li&gt;&#36755;&#20837;&#30456;&#21516;&#30340;&#24773;&#20917;&#19979;&#65292;&#36755;&#20986;&#21487;&#33021;&#19981;&#21516;
&lt;/li&gt;
&lt;li&gt;&#26377;&#21103;&#20316;&#29992;&#65292;&#38750;&#22810;&#32447;&#31243;&#23433;&#20840;
&lt;/li&gt;
&lt;li&gt;&#23450;&#20041;&#26102;&#21487;&#20197;&#22810;&#31181;&#26041;&#24335;&#23433;&#20840;&#22320;&#24341;&#29992;&#22806;&#37096;&#21464;&#37327;
&lt;/li&gt;
&lt;li&gt;&#35843;&#29992;&#31616;&#21333;&#65292;&#19981;&#38656;&#35201;&#20256;&#20837;&#20445;&#23384;&#29366;&#24577;&#30340;&#21442;&#25968;
&lt;/li&gt;
&lt;/ul&gt;


&lt;/div&gt;

&lt;/div&gt;

&lt;div id="outline-container-2-3" class="outline-4"&gt;
&lt;h4 id="sec-2-3"&gt;&#21327;&#31243;&#65288;Coroutine&#65289;&lt;/h4&gt;
&lt;div class="outline-text-4" id="text-2-3"&gt;

&lt;ul&gt;
&lt;li&gt;&#26377;&#29366;&#24577;&#65292;&#20869;&#37096;&#30452;&#25509;&#20445;&#23384;
&lt;/li&gt;
&lt;li&gt;&#38656;&#35201;&#29420;&#31435;&#23450;&#20041;&#25191;&#34892;&#20307;
&lt;/li&gt;
&lt;li&gt;&#35843;&#29992;&#36807;&#31243;&#20013;&#30452;&#25509;&#20174;&#19978;&#27425;&#30340;&#36816;&#34892;&#29366;&#24577;&#32487;&#32493;&#36816;&#34892;
&lt;/li&gt;
&lt;li&gt;&#36755;&#20837;&#30456;&#21516;&#30340;&#24773;&#20917;&#19979;&#65292;&#36755;&#20986;&#21487;&#33021;&#19981;&#21516;
&lt;/li&gt;
&lt;li&gt;&#20005;&#31105;&#22810;&#32447;&#31243;&#35775;&#38382;
&lt;/li&gt;
&lt;li&gt;&#35843;&#29992;&#31616;&#21333;&#65292;&#19981;&#38656;&#35201;&#20256;&#20837;&#20445;&#23384;&#29366;&#24577;&#30340;&#21442;&#25968;    
&lt;/li&gt;
&lt;/ul&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
</content></entry><entry><title type="html">网页中的自动完成的下拉列表框</title><author><name>nil</name></author><link href="http://blog.kankanan.com/posts/2013/03/10_7f5198754e2d768481ea52a85b8c621076844e0b62c9521788686846.html"/><updated>2013-03-10T21:23:00Z</updated><published>2013-03-10T21:23:00Z</published><id>posts/2013/03/10_7f5198754e2d768481ea52a85b8c621076844e0b62c9521788686846.html</id><category scheme="/tags/web.html" term="web" label="web"/><category scheme="/tags/jquery.html" term="jquery" label="jquery"/><category scheme="/tags/chosen.html" term="chosen" label="chosen"/><content type="html">&lt;div id="outline-container-1" class="outline-3"&gt;
&lt;h3 id="sec-1"&gt;jqueryui&#30340;&lt;a href="http://jqueryui.com/autocomplete/#combobox"&gt;&#32452;&#20214;&lt;/a&gt;&lt;/h3&gt;
&lt;div class="outline-text-3" id="text-1"&gt;

&lt;p&gt;   &#31034;&#20363;&#25928;&#26524;&#30475;&#36215;&#26469;&#25403;&#22909;&#65292;&#19981;&#36807;&#21457;&#29616;&#20960;&#20010;&#38382;&#39064;&#65306;
&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&#21644;&lt;a href="http://twitter.github.com/bootstrap/"&gt;bootstrap&lt;/a&gt;&#26377;&#20914;&#31361;&#65292;&#23548;&#33268;&#21491;&#36793;&#30340;&#19979;&#25289;&#31661;&#22836;&#37096;&#20998;&#37117;&#30475;&#19981;&#35265;&#12290;
&lt;/li&gt;
&lt;li&gt;&#25805;&#20316;&#36807;&#31243;&#20013;&#26377;&#26102;&#20505;&#26174;&#31034;&#30340;&#20540;&#21644;&#23454;&#38469;&#30340;&#20540;&#19981;&#19968;&#33268;&#65292;&#24212;&#35813;&#26159;&#20013;&#25991;&#36755;&#20837;&#27861;&#25353;&#38190;&#20107;&#20214;&#22312;firefox&#19979;&#26410;&#35302;&#21457;&#24341;&#36215;&#30340;&#26174;&#31034;&#30340;&#30028;&#38754;&#37096;&#20998;&#21644;&#38544;&#34255;&#30340;select&#36755;&#20837;&#26694;&#20540;&#19981;&#21516;&#27493;&#12290;
&lt;/li&gt;
&lt;li&gt;&#27809;&#26377;&#25552;&#20379;&#35774;&#32622;&#24403;&#21069;&#36873;&#20013;&#39033;&#12289;&#31105;&#29992;&#30340;&#21151;&#33021;&#65292;&#35201;&#33258;&#34892;&#23545;&#29983;&#25104;&#30340;&#30028;&#38754;&#20803;&#32032;&#36827;&#34892;&#22788;&#29702;&#12290;
&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 
   &#36825;&#20010;&#21482;&#26159;jqueryui&#33258;&#21160;&#23436;&#25104;&#36755;&#20837;&#26694;&#30340;&#19968;&#20010;&#23450;&#21046;&#31034;&#20363;&#65292;&#19981;&#26159;&#24456;&#23436;&#21892;&#65292;&#32780;jqueryui&#33258;&#24102;&#30340;&#27491;&#24335;&#29256;&#30475;&#36215;&#26469;&#21482;&#26159;&#19968;&#20010;&#36755;&#20837;&#26694;&#12290;
&lt;/p&gt;
&lt;/div&gt;

&lt;/div&gt;

&lt;div id="outline-container-2" class="outline-3"&gt;
&lt;h3 id="sec-2"&gt;&lt;a href="https://github.com/harvesthq/chosen"&gt;chosen&lt;/a&gt;&lt;/h3&gt;
&lt;div class="outline-text-3" id="text-2"&gt;

&lt;p&gt;   &#38750;&#24120;&#23436;&#32654;&#65292;&#37197;&#32622;&#24456;&#31616;&#21333;&#65292;&#32780;&#19988;&#30028;&#38754;&#24456;&#28418;&#20142;&#65292;&#22312;github&#19978;&#35780;&#20998;&#24456;&#39640;&#12290;
&lt;/p&gt;&lt;/div&gt;
&lt;/div&gt;
</content></entry><entry><title type="html">linux下跨进程传递文件描述符</title><author><name>nil</name></author><link href="http://blog.kankanan.com/posts/2013/03/09_linux4e0b8de88fdb7a0b4f20901265874ef663cf8ff07b26.html"/><updated>2013-03-09T15:11:00Z</updated><published>2013-03-09T15:11:00Z</published><id>posts/2013/03/09_linux4e0b8de88fdb7a0b4f20901265874ef663cf8ff07b26.html</id><category scheme="/tags/linux.html" term="linux" label="linux"/><content type="html">&lt;div id="outline-container-1" class="outline-3"&gt;
&lt;h3 id="sec-1"&gt;&#38382;&#39064;&lt;/h3&gt;
&lt;div class="outline-text-3" id="text-1"&gt;

&lt;p&gt;   &#22312;web&#24320;&#21457;&#20013;&#65292;&#20197;&#20856;&#22411;&#30340;php-fpm&#20026;&#20363;&#65292;&#23545;&#20110;&#21040;&#22806;&#37096;&#31995;&#32479;&#30340;&#36830;&#25509;&#65288;&#22914;&#65306;mysql&#12289;redis&#65289;&#31561;&#37117;&#25552;&#20379;&#20102;&#25345;&#20037;&#36830;&#25509;&#25509;&#21475;&#65288;pconnect&#65289;&#65292;&#20294;&#26159;&#21463;&#38480;&#20110;&#22810;&#36827;&#31243;&#27169;&#22411;&#65292;&#20107;&#23454;&#19978;&#26159;&#27599;&#20010;php-fpm&#36827;&#31243;&#37117;&#26377;&#21333;&#29420;&#30340;&#19968;&#20010;&#36830;&#25509;&#27744;&#30340;&#65288;&#21442;&#35265;&#65306;&#12298;&lt;a href="php_meet_redis.html"&gt;&#24403;php&#36935;&#19978;redis&lt;/a&gt;&#12299;&#65289;&#65292;&#22823;&#37327;&#31354;&#38386;&#36830;&#25509;&#30340;&#23384;&#22312;&#19981;&#20165;&#23545;&#31995;&#32479;&#36164;&#28304;&#36896;&#25104;&#20102;&#28010;&#36153;&#65288;&#19981;&#21333;&#25351;fd&#31354;&#38388;&#65292;&#20687;mysql&#30340;&#27599;&#36830;&#25509;&#19968;&#32447;&#31243;&#20250;&#38468;&#24102;&#22823;&#37327;&#20869;&#23384;&#31354;&#38388;&#65306;sort_buffer&#12289;read_buffer&#31561;&#65289;&#65292;&#32780;&#19988;&#25972;&#20010;&#31995;&#32479;&#23558;&#26080;&#27861;&#27178;&#21521;&#25193;&#23637;&#65288;&#22914;&#65306;mysql&#36830;&#25509;&#25968;&#38480;&#21046;&#65289;&#12290;&#22914;&#26524;&#21487;&#20197;&#22312;&#36827;&#31243;&#38388;&#20849;&#20139;&#25991;&#20214;&#25551;&#36848;&#31526;&#65292;&#23558;&#21487;&#20197;&#22823;&#22823;&#25552;&#21319;&#31995;&#32479;&#24615;&#33021;&#65292;&#20419;&#36827;&#22810;&#36827;&#31243;&#27169;&#22411;&#30340;&#24212;&#29992;&#12290;
&lt;/p&gt;
&lt;/div&gt;

&lt;/div&gt;

&lt;div id="outline-container-2" class="outline-3"&gt;
&lt;h3 id="sec-2"&gt;&#26041;&#26696;&lt;/h3&gt;
&lt;div class="outline-text-3" id="text-2"&gt;

&lt;p&gt;   &#22312;linux&#24179;&#21488;&#19979;&#65292;sendmsg&#12289;recvmsg&#21487;&#20197;&#23558;&#19968;&#20010;&#36827;&#31243;&#30340;&#25991;&#20214;&#25551;&#36848;&#31526;&#20256;&#36882;&#32473;&#21478;&#19968;&#36827;&#31243;&#20351;&#29992;&#65292;&#36825;&#20351;&#24471;&#23454;&#29616;&#31995;&#32479;&#32423;&#30340;&#36830;&#25509;&#27744;&#25104;&#20026;&#21487;&#33021;&#12290;
&lt;/p&gt;
&lt;/div&gt;

&lt;/div&gt;

&lt;div id="outline-container-3" class="outline-3"&gt;
&lt;h3 id="sec-3"&gt;&#23454;&#29616;&lt;/h3&gt;
&lt;div class="outline-text-3" id="text-3"&gt;

&lt;p&gt;   &#12298;The Linux Programming Interface&#12299;61.13.3 Passing File Descriptors
&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
</content></entry>
</feed>
