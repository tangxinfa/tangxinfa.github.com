<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-CN" xml:lang="zh-CN">
<head>
<title>Redis使用记录</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<meta name="title" content="Redis使用记录"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="&lt;2012-12-16 Sun&gt;"/>
<meta name="author" content="tangxinfa"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<link rel='stylesheet' type='text/css' href='css/style.css' />
<script type="text/javascript">
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>

</head>
<body>

<div id="preamble">
<div class='nav-bar'><ul><li><a href='index.html' class='nav-bar-blog' style='color: #FFFFFF;'>博客</a></li></ul></div>
</div>

<div id="content">
<h1 class="title">Redis使用记录</h1>


<div class="tag-bar">
</div>


<div id="outline-container-1" class="outline-2">
<h2 id="sec-1">解决保存快照失败后redis无法写入的问题</h2>
<div class="outline-text-2" id="text-1">

<p>  用命令行工具连上后执行“set test 0”出现以下错误提示：
</p>


<pre class="example">MISCONF Redis is configured to save RDB snapshots, but is currently not able to persist on disk. Commands that may modify the data set are disabled. Please check Redis logs for details about the error.
</pre>

<p>
  这个应该是之前强制停止redis快照导致的，查看redis快照状态证实了这一点：
</p>


<pre class="example">redis 127.0.0.1:6379&gt; info
...
rdb_last_bgsave_status:err
...
</pre>

<p>
  通过关闭配置项stop-writes-on-bgsave-error解决该问题。
</p>


<pre class="example">redis 127.0.0.1:6379&gt; config set stop-writes-on-bgsave-error no
</pre>


</div>

</div>

<div id="outline-container-2" class="outline-2">
<h2 id="sec-2">使用hash表结构减少内存占用</h2>
<div class="outline-text-2" id="text-2">

<p>  当hash结构中的元素较少（少于redis.conf:hash-max-zipmap-entries指定的数量时，配置成&lt;=1000，过大会减低处理速度，参见： <a href="http://stackoverflow.com/questions/11281734/redis-using-hashes">这里</a> 和 <a href="http://instagram-engineering.tumblr.com/post/12202313862/storing-hundreds-of-millions-of-simple-key-value-pairs">这里</a> ），redis使用特殊的方式（数组保存，时间换空间）保存hash结构以减少内存占用，参见 <a href="http://redis.io/topics/memory-optimization">这里</a> 。但当hash结构超过指定数量时将使用普通的<a href="http://redis.io/commands#string">字符串</a>方式保存，也就无法再节省内存了。
</p>
</div>

</div>

<div id="outline-container-3" class="outline-2">
<h2 id="sec-3">估算内存占用</h2>
<div class="outline-text-2" id="text-3">

<p>  参考: <a href="http://lethain.com/notes-on-redis-memory-usage/">Notes on Redis Memory Usage</a>
</p>
</div>

<div id="outline-container-3-1" class="outline-3">
<h3 id="sec-3-1">测试环境</h3>
<div class="outline-text-3" id="text-3-1">

<dl>
<dt>redis版本</dt><dd>
<p>
     redis<sub>version</sub>:2.4.4
</p></dd>
<dt>操作系统（uname -a）</dt><dd>
<p>
     Linux CentOS 2.6.32-220.13.1.el6.x86<sub>64</sub> #1 SMP Tue Apr 17 23:56:34 BST 2012 x86<sub>64</sub> x86<sub>64</sub> x86<sub>64</sub> GNU/Linux
</p></dd>
<dt>python版本（python &ndash;version）</dt><dd>
<p>
     Python 2.6.6
</p></dd>
<dt>测试脚本</dt><dd>
</dd>
</dl>




<pre class="example">#!/bin/env python

import redis
import uuid
import time

r = redis.Redis(host='localhost', port=6379, db=0)
for num_strings in (100000,):
    r.flushall()
    time.sleep(1.0)
    initial_size = r.dbsize()
    initial_info = r.info()

    for i in xrange(0, num_strings):
        r.set(str(uuid.uuid4()), time.time())
        #r.setex(str(uuid.uuid4()), time.time(), 100000)
    final_size = r.dbsize()
    final_info = r.info()

    print "For %s strings." % (num_strings,)
    print "Keys: %s =&gt; %s" % (initial_size, final_size)
    print "Memory: %s =&gt; %s" % (initial_info['used_memory'],
                                    final_info['used_memory'])
    print "Memory per key: %d"%((int(final_info['used_memory']) - int(initial_info['used_memory'])) / num_strings)
</pre>

</div>

</div>

<div id="outline-container-3-2" class="outline-3">
<h3 id="sec-3-2">测试结果</h3>
<div class="outline-text-3" id="text-3-2">

<dl>
<dt>set</dt><dd>
<p>
     每个key-value占用138字节，可见redis本身的维护开销为89字节
</p></dd>
<dt>setex</dt><dd>
<p>
     每个key-value占用180字节，可见redis本身的维护开销为131字节，比set方式多了42字节
</p></dd>
</dl>


</div>
</div>

</div>

<div id="outline-container-4" class="outline-2">
<h2 id="sec-4">除非你能够保证你的机器总是有一半的空闲内存，否则别使用快照方式持久化数据或者通过执行BGREWRITEAOF压缩aof文件</h2>
<div class="outline-text-2" id="text-4">

<p>  redis在执行bgsave时，会进行一次fork，fork后的进程负责将内存中的数据写入磁盘，由于fork采用Copy-On-Write，两个redis进程共享内存中的数据。redis如果有数据更新，则会将对应的共享内存页创建一份副本再更新，当更新操作足够频繁时，共享的内存空间会迅速地副本化，导致物理内存被耗光，系统被迫动用交换空间，从而导致redis服务极不稳定，整个系统堵塞在磁盘io上。
</p>


        <div class="comment_header">评论</div>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = 'kankananblog';
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        <div style="display:none;">
        <script type="text/javascript">
            var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Faa06d8a31344740ac23cbe6cf3d9f23e' type='text/javascript'%3E%3C/script%3E"));
        </script>
        </div>
</div>
</div>
</div>

<div id="postamble">
<p class="date">Date: &lt;2012-12-16 Sun&gt;</p>
<p class="author">Author: tangxinfa</p>
<p class="creator">Org version 7.8.02 with Emacs version 23</p>
<a href="http://validator.w3.org/check?uri=referer">Validate XHTML 1.0</a>

</div>
</body>
</html>
