<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>redis - 看看俺 – KanKanAn.com</title>
        <description>记我所思，忆我所为。</description>
        <link>http://blog.kankanan.com/tag/redis.xml</link>
        <lastBuildDate>Thu, 25 Feb 2016 07:19:59 GMT</lastBuildDate>
        <docs>http://blogs.law.harvard.edu/tech/rss</docs>
        <image>
            <title>redis - 看看俺 – KanKanAn.com</title>
            <url>http://blog.kankanan.com/static/favicon.ico</url>
            <link>http://blog.kankanan.com/tag/redis.xml</link>
        </image>
        <copyright>版权所有 © 2011-2015 看看俺 – KanKanAn.com</copyright>
        <generator>Feed for Node.js</generator>
        <category>技术</category>
        <item>
            <title><![CDATA[迁移redis库的某个db]]></title>
            <link>/article/8fc179fb-redis-5e93768467d04e2a-db.html</link>
            <guid>/article/8fc179fb-redis-5e93768467d04e2a-db.html</guid>
            <pubDate>Thu, 21 Jan 2016 10:00:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
在项目开始的时候，往往会把各种用途的数据放到一个 redis 实例中，如 db1 存放功能 A 的数据、db2 存放功能 B 的数据。
</p>

<p>
当 redis 的压力上来了之后，往往需要将某个 db 迁移到其它的实例上，如果是整个实例进行迁移，通常会通过 Master-Slave 将数据同步到新机器，然后提升新机器上的 redis 为 Master。
</p>

<p>
但是遇到只需要迁移 1 个 db 的数据到新的 redis 实例（该实例已有其它数据）的情况，就需要借助 redis 数据迁移工具了，这里介绍两个工具。
</p>

<p>
假设要将 redis 的 db5 从 192.168.1.100 上的 redis 迁到 192.168.1.101 上的 db5。
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><a href="https://github.com/salimane/redis-tools">redis-copy.py</a></h2>
<div class="outline-text-2" id="text-1">
<p>
使用 python 开发。
</p>

<ul class="org-ul">
<li>安装

<div class="org-src-container">

<pre class="src src-sh">sudo pip2 install redis
wget https://github.com/salimane/redis-tools/raw/master/redis-copy.py
</pre>
</div>
</li>

<li>开始迁移

<div class="org-src-container">

<pre class="src src-sh">python2 ./redis-copy.py --source=192.168.1.100:6379 --target=192.168.1.101:6379 <span style="text-decoration: underline;">--databases=5 --limit=1000000000</span>
python2 ./redis-copy.py --source=192.168.1.100:6379 --target=192.168.1.101:6379 <span style="text-decoration: underline;">--databases=5 --clean</span>
</pre>
</div>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><a href="https://github.com/yaauie/redis-copy">redis-copy</a> （推荐）</h2>
<div class="outline-text-2" id="text-2">
<p>
使用 ruby 开发。
</p>

<ul class="org-ul">
<li>安装

<div class="org-src-container">

<pre class="src src-sh">gem install redis-copy
</pre>
</div>
</li>

<li>开始迁移

<div class="org-src-container">

<pre class="src src-sh">~/.gem/ruby/2.3.0/bin/redis-copy 192.168.1.100:6379/5 192.168.1.101:6379/5
</pre>
</div>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">比较</h2>
<div class="outline-text-2" id="text-3">
<p>
<a href="https://github.com/salimane/redis-tools">redis-copy.py</a> 在迁移过程中 db 号不能改变，需要在源 db 中临时写入大量簿记信息，最终也没有完全清簿记信息（mig:run 键）。
默认一次运行迁移 10000 条记录，可以多次运行迁移后面的数据，也可以通过指定 &#x2013;limit 为一个够大的数量一次性迁移。
支持同时迁移多个 db 。
</p>

<p>
<a href="https://github.com/yaauie/redis-copy">redis-copy</a> 可以任意指定源、目的 db 号，不需要往 redis 写入簿记信息。</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[node.js连接redis高可用性方案：Sentinel]]></title>
            <link>/article/node.js-8fde63a5-redis-9ad853ef7528602765b96848ff1a-sentinel.html</link>
            <guid>/article/node.js-8fde63a5-redis-9ad853ef7528602765b96848ff1a-sentinel.html</guid>
            <pubDate>Sun, 27 Dec 2015 06:27:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
node.js后台应用在开始时往往不会搞得太复杂，使用单实例的redis，一般都会使用官方推荐的模块 <a href="https://github.com/NodeRedis/node_redis">node_redis</a> 。
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">访问单实例node.js</h2>
<div class="outline-text-2" id="text-1">
<p>
在 <a href="https://github.com/NodeRedis/node_redis">node_redis</a> 的基础上稍作封装，主要是避免并行访问时意外创建多个redis连接。
</p>
</div>

<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1">database.js</h3>
<div class="outline-text-3" id="text-1-1">
<div class="org-src-container">

<pre class="src src-js"><span style="color: #99cc99;">var</span> <span style="color: #ffcc66;">redis</span> = require(<span style="color: #66cccc;">'redis'</span>);

<span style="color: #99cc99;">function</span> <span style="color: #f99157;">Database</span>() {
<span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">var</span> <span style="color: #ffcc66;">self</span> = <span style="color: #6699cc;">this</span>;

<span style="background-color: #515151;"> </span>   self._redis_host = <span style="color: #66cccc;">'127.0.0.1'</span>;
<span style="background-color: #515151;"> </span>   self._redis_port = 6379;
<span style="background-color: #515151;"> </span>   self._redis_db = 2;

<span style="background-color: #515151;"> </span>   self._redis = <span style="color: #6699cc;">null</span>;
<span style="background-color: #515151;"> </span>   self._redis_selected = <span style="color: #6699cc;">false</span>;
}

Database.<span style="color: #6699cc;">prototype</span>.redis = <span style="color: #99cc99;">function</span>(<span style="color: #ffcc66;">callback</span>) {
<span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">var</span> <span style="color: #ffcc66;">self</span> = <span style="color: #6699cc;">this</span>;

<span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">if</span> (self._redis &amp;&amp; self._redis_selected) {
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">return</span> callback(<span style="color: #6699cc;">null</span>, self._redis);
<span style="background-color: #515151;"> </span>   }

<span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">if</span> (! self._redis) {
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   self._redis = redis.createClient(self._redis_port, self._redis_host);
<span style="background-color: #515151;"> </span>   }

<span style="background-color: #515151;"> </span>   self._redis.select(self._redis_db, <span style="color: #99cc99;">function</span> (<span style="color: #ffcc66;">err</span>) {
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">if</span> (err) {
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">return</span> callback(err);
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   }

<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   self._redis_selected = <span style="color: #6699cc;">true</span>;

<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">return</span> callback(<span style="color: #6699cc;">null</span>, self._redis);
<span style="background-color: #515151;"> </span>   });
};


module.exports = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">Database</span>();
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2">client.js</h3>
<div class="outline-text-3" id="text-1-2">
<p>
使用 <code>database.js</code>
</p>

<div class="org-src-container">

<pre class="src src-js"><span style="color: #99cc99;">var</span> <span style="color: #ffcc66;">db</span> = require(<span style="color: #66cccc;">'./database'</span>);

db.redis(<span style="color: #99cc99;">function</span> (<span style="color: #ffcc66;">err</span>, <span style="color: #ffcc66;">client</span>) {
<span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">if</span>(err) {
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   console.error(err.toString());
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">return</span> process.exit(1);
<span style="background-color: #515151;"> </span>   }

<span style="background-color: #515151;"> </span>   client.set(<span style="color: #66cccc;">'hello'</span>, <span style="color: #66cccc;">'world'</span>, <span style="color: #99cc99;">function</span> (<span style="color: #ffcc66;">err</span>) {
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">if</span>(err) {
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   console.error(err.toString());
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">return</span> process.exit(1);
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   }

<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   setTimeout(<span style="color: #99cc99;">function</span> () {
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   client.get(<span style="color: #66cccc;">'hello'</span>, <span style="color: #99cc99;">function</span> (<span style="color: #ffcc66;">err</span>, <span style="color: #ffcc66;">value</span>) {
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">if</span>(err) {
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   console.error(err.toString());
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">return</span> process.exit(1);
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   }

<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   console.log(<span style="color: #66cccc;">'hello: '</span> + value);

<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   process.exit(0);
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   });
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   }, 20*1000);
<span style="background-color: #515151;"> </span>   });
});
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">访问主备Redis</h2>
<div class="outline-text-2" id="text-2">
<p>
但是随着服务的成功，用户量开始增加，另外对稳定性、可靠性有了一定要求，确保数据的安全性成了重中之重，redis由单机转向主/备（Replication）甚至集群（Cluster），
本文只关注使用 <code>Sentinel</code> 管理的主/备（Replication）Redis。
</p>

<p>
这就意味着Redis客户端应用不能直接连接Redis实例，而是需要先连接 <code>Sentinel</code> ，根据 <code>Sentinel</code> 提供的 <code>Master</code> 或 <code>Slave</code> 地址连接Redis实例，
还要接收 <code>Sentinel</code> 的 <code>Master</code> <code>Slave</code> 变动通知，重连Redis实例。
</p>

<p>
不幸的是，<a href="https://github.com/NodeRedis/node_redis">node_redis</a> 模块只支持单实例redis，基于 <a href="https://github.com/NodeRedis/node_redis">node_redis</a> 实现与 <code>Sentinel</code> 的交互工作量比较大。
</p>

<p>
所幸的是 <a href="http://github.com/luin/ioredis/">ioredis</a> （现已成为redis官方推荐模块）出现了，它支持 <code>Sentinel</code> ，而且大部分API跟 <a href="https://github.com/NodeRedis/node_redis">node_redis</a> 是兼容的:
</p>

<blockquote>
<p>
ioredis is a robust, full-featured Redis client that is used in the world's biggest online commerce company Alibaba and many other awesome companies.
</p>

<ol class="org-ol">
<li>Full-featured. It supports Cluster, Sentinel, Pipelining and of course Lua scripting &amp; Pub/Sub (with the support of binary messages).
</li>
<li>High performance.
</li>
<li>Delightful API. It works with Node callbacks and Bluebird promises.
</li>
<li>Transformation of command arguments and replies.
</li>
<li>Transparent key prefixing.
</li>
<li>Abstraction for Lua scripting, allowing you to define custom commands.
</li>
<li>Support for binary data.
</li>
<li>Support for TLS.
</li>
<li>Support for offline queue and ready checking.
</li>
<li>Support for ES6 types, such as Map and Set.
</li>
<li>Support for GEO commands (Redis 3.2 Unstable).
</li>
<li>Sophisticated error handling strategy.
</li>
</ol>
</blockquote>

<p>
<a href="http://github.com/luin/ioredis/">ioredis</a> 提供了从 <a href="https://github.com/NodeRedis/node_redis">node_redis</a> 进行迁移的文档 <a href="https://github.com/luin/ioredis/wiki/Migrating-from-node_redis">Migrating from node_redis</a> 。
</p>

<p>
但也要注意 <a href="http://github.com/luin/ioredis/">ioredis</a> 的不同之处，如连接 <code>Redis</code> 失败时， <a href="https://github.com/NodeRedis/node_redis">node_redis</a> 默认是不重连，而 <a href="http://github.com/luin/ioredis/">ioredis</a> 会重连，在 <code>redis</code> 故障时可能导致 <code>node.js</code> 积压大量请求耗尽内存。
</p>

<p>
参考文档 <a href="https://github.com/luin/ioredis/blob/master/README.md#sentinel">ioredis Sentinel</a> ，将上一节 <code>访问单实例node.js</code> 中redis封装代码改成支持 <code>Sentinel</code>
</p>
</div>

<div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1">database.js</h3>
<div class="outline-text-3" id="text-2-1">
<div class="org-src-container">

<pre class="src src-js"><span style="color: #99cc99;">var</span> <span style="color: #ffcc66;">Redis</span> = require(<span style="color: #66cccc;">'ioredis'</span>);

<span style="color: #99cc99;">function</span> <span style="color: #f99157;">Database</span>() {
<span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">var</span> <span style="color: #ffcc66;">self</span> = <span style="color: #6699cc;">this</span>;

<span style="background-color: #515151;"> </span>   self._redis_options = {
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   name: <span style="color: #66cccc;">'mymaster'</span>,
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   sentinels: [{
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   host: <span style="color: #66cccc;">'127.0.0.1'</span>,
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   port: 5000
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   }, {
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   host: <span style="color: #66cccc;">'127.0.0.1'</span>,
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   port: 5001
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   }],
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   db: 2
<span style="background-color: #515151;"> </span>   };

<span style="background-color: #515151;"> </span>   self._redis = <span style="color: #6699cc;">null</span>;
}

Database.<span style="color: #6699cc;">prototype</span>.redis = <span style="color: #99cc99;">function</span>(<span style="color: #ffcc66;">callback</span>) {
<span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">var</span> <span style="color: #ffcc66;">self</span> = <span style="color: #6699cc;">this</span>;

<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span><span style="color: #99cc99;">if</span> (! self._redis) {
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   self._redis = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">Redis</span>(self._redis_options);
<span style="background-color: #515151;"> </span>   }

<span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">return</span> callback(<span style="color: #6699cc;">null</span>, self._redis);
};

module.exports = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">Database</span>();
</pre>
</div>

<p>
和使用 <a href="https://github.com/NodeRedis/node_redis">node_redis</a> 的 <code>database.js</code> 对照一下，可以发现 <a href="http://github.com/luin/ioredis/">ioredis</a> 连接 <code>redis</code> 时，支持 <code>db</code> 选项，可以省去调用 <code>select</code> 。
</p>

<p>
值得注意的是 <a href="https://github.com/NodeRedis/node_redis">node_redis</a> 最近开始支持连接 <code>redis</code> 时指定 <code>db</code> 选项，见 <a href="https://github.com/NodeRedis/node_redis/commit/a4285c156c5b8964d92a36bd7f361a6f40e2449a">Parse redis url just like IANA · NodeRedis/node_redis@a4285c1</a> ，
使用该特性时请安装最新版的 <a href="https://github.com/NodeRedis/node_redis">node_redis</a> 。
</p>

<blockquote>
<p>
db: null; If set, client will run redis select command on connect. This is not recommended.
</p>
</blockquote>
<p>
引用自 <a href="https://github.com/NodeRedis/node_redis#rediscreateclient">redis.createClient()文档</a>
</p>
</div>
</div>

<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2">启动 Redis 及 Sentinel</h3>
<div class="outline-text-3" id="text-2-2">
<p>
启动上一篇文章《 <a href="http://blog.kankanan.com/article/redis-9ad853ef7528602765b96848ff1a-sentinel.html">redis高可用性方案：Sentinel</a> 》配置好的 <code>Sentinel</code>
</p>

<ul class="org-ul">
<li><code>Master</code> <code>redis-server ./redis-master.conf</code> 
</li>

<li><code>Slave</code> <code>redis-server ./redis-slave.conf</code>
</li>

<li><code>Sentinel a</code> <code>redis-sentinel ./redis-sentinel-a.conf</code>
</li>

<li><code>Sentinel b</code> <code>redis-sentinel ./redis-sentinel-b.conf</code>
</li>

<li><code>Sentinel c</code> <code>redis-sentinel ./redis-sentinel-c.conf</code>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3">演示运行</h3>
<div class="outline-text-3" id="text-2-3">
<p>
运行演示脚本
</p>

<div class="org-src-container">

<pre class="src src-sh"><span id="coderef-master_write" class="coderef-off"><span class="linenr">1: </span>node client.js &amp;</span>
<span id="coderef-wait_sync" class="coderef-off"><span class="linenr">2: </span>sleep 1</span>
<span id="coderef-slave_read" class="coderef-off"><span class="linenr">3: </span>redis-cli -p 6380 -n 2 get hello</span>
<span id="coderef-failover" class="coderef-off"><span class="linenr">4: </span>redis-cli -p 6379 debug sleep 30 &amp;</span>
</pre>
</div>

<dl class="org-dl">
<dt> 行 <a href="#coderef-master_write"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-master_write');" onmouseout="CodeHighlightOff(this, 'coderef-master_write');">1</a> </dt><dd>运行 <code>client.js</code> 在 <code>Master</code> 写入键值
</dd>

<dt> 行 <a href="#coderef-wait_sync"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-wait_sync');" onmouseout="CodeHighlightOff(this, 'coderef-wait_sync');">2</a> </dt><dd>等待 <code>Master</code> 同步数据到 <code>Slave</code>
</dd>

<dt> 行 <a href="#coderef-slave_read"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-slave_read');" onmouseout="CodeHighlightOff(this, 'coderef-slave_read');">3</a> </dt><dd>从 <code>Slave</code> 读取键值
</dd>

<dt> 行 <a href="#coderef-failover"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-failover');" onmouseout="CodeHighlightOff(this, 'coderef-failover');">4</a> </dt><dd>触发故障切换
</dd>
</dl>

<p>
演示脚本运行结果
</p>

<pre class="example">
<span id="coderef-slave_read_result" class="coderef-off"><span class="linenr">5: </span>"world"</span>
<span id="coderef-slave_read_status" class="coderef-off"><span class="linenr">6: </span>OK</span>
<span id="coderef-master_read" class="coderef-off"><span class="linenr">7: </span>hello: world</span>
</pre>

<dl class="org-dl">
<dt> 行 <a href="#coderef-slave_read_result"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-slave_read_result');" onmouseout="CodeHighlightOff(this, 'coderef-slave_read_result');">5</a> </dt><dd>演示脚本行 <a href="#coderef-slave_read"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-slave_read');" onmouseout="CodeHighlightOff(this, 'coderef-slave_read');">3</a> 的redis命令执行结果
</dd>

<dt> 行 <a href="#coderef-slave_read_status"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-slave_read_status');" onmouseout="CodeHighlightOff(this, 'coderef-slave_read_status');">6</a> </dt><dd>演示脚本行 <a href="#coderef-slave_read"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-slave_read');" onmouseout="CodeHighlightOff(this, 'coderef-slave_read');">3</a> 的redis命令执行状态
</dd>

<dt> 行 <a href="#coderef-master_read"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-master_read');" onmouseout="CodeHighlightOff(this, 'coderef-master_read');">7</a> </dt><dd>演示脚本行 <a href="#coderef-master_write"class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-master_write');" onmouseout="CodeHighlightOff(this, 'coderef-master_write');">1</a> 后台运行结束时输出的键值，此时由于主备已切换，是从新的 <code>Master</code> （原 <code>Slave</code> ）上获取的
</dd>
</dl>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">参考</h2>
<div class="outline-text-2" id="text-3">
<p>
<a href="https://github.com/luin/ioredis/blob/master/README.md#sentinel">ioredis Sentinel</a></p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[redis高可用性方案：Sentinel]]></title>
            <link>/article/redis-9ad853ef7528602765b96848ff1a-sentinel.html</link>
            <guid>/article/redis-9ad853ef7528602765b96848ff1a-sentinel.html</guid>
            <pubDate>Sat, 26 Dec 2015 14:54:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
在前面一篇文章《 <a href="http://blog.kankanan.com/article/redis-9ad853ef7528602757fa7840ff1a-master-slave.html">redis高可用性基础：Master-Slave</a> 》中，主备切换过程时有好几个步骤，需要人工介入，这势必增加服务的故障时间（Down Time）。
</p>

<p>
而 <code>Sentinel</code> 正是自动化这一过程的官方工具，详细文档请参考《<a href="http://redis.io/topics/sentinel">Redis Sentinel Documentation – Redis</a>》。
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><code>Sentinel</code> 的功能</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>监控

<p>
<code>Sentinel</code> 不断地检测 <code>Master</code> 和 <code>Slave</code> 实例的运行状态。
</p>
</li>

<li>通知

<p>
<code>Sentinel</code> 通过API，能够通知系统管理员、其它程序：监控的Redis实例出问题了。
</p>
</li>

<li>自动故障切换

<p>
如果 <code>Master</code> 实例出问题了， <code>Sentinel</code> 通过将一个 <code>Slave</code> 实例提升为 <code>Master</code> 修复故障，其它 <code>Slave</code> 实例使用新的 <code>Master</code> 实例，同时通知给使用Redis服务的应用程序以便重新建立连接。
</p>
</li>

<li>配置提供者

<p>
<code>Sentinel</code> 做为客户端服务发现的权威来源：客户端连接到 <code>Sentinel</code> 以获取当前 <code>Master</code> 的地址，故障切换后报告新的地址。
</p>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><code>Sentinel</code> 演示</h2>
<div class="outline-text-2" id="text-2">
<p>
<code>Redis Sentinel</code> 推荐的配置为至少三个Sentinel部署在三台不同的机器上，只配一台自已本身就是单点没有意义，二台时可能出现“脑裂”。
</p>

<ul class="org-ul">
<li>启动上一篇文章《 <a href="http://blog.kankanan.com/article/redis-9ad853ef7528602757fa7840ff1a-master-slave.html">redis高可用性基础：Master-Slave</a> 》配置好的 <code>Master</code> 及 <code>Slave</code> Redis实例

<p>
<code>Master</code> 监听在 <code>6379</code> 端口， <code>Slave</code> 监听在 <code>6380</code> 端口。
</p>
</li>

<li>使用端口号 <code>5000</code> <code>5001</code> <code>5002</code> 创建三个 <code>Sentinel</code> 实例

<p>
<code>Sentinel</code> 实例 <code>a</code> 的配置文件 <code>redis-sentinel-a.conf</code>
</p>

<pre class="example">
port 5000
sentinel monitor mymaster 127.0.0.1 6379 2
sentinel down-after-milliseconds mymaster 5000
sentinel failover-timeout mymaster 60000
sentinel parallel-syncs mymaster 1
</pre>

<p>
其它两个 <code>Sentinel</code> 实例 <code>b</code> <code>c</code> 配置和 <code>a</code> 基本一样，只是端口号分别为 <code>5001</code> 和 <code>5002</code> ：
</p>

<p>
<a href="../static/redis-sentinel-a.conf">redis-sentinel-a.conf</a>
</p>

<p>
<a href="../static/redis-sentinel-b.conf">redis-sentinel-b.conf</a>
</p>

<p>
<a href="../static/redis-sentinel-c.conf">redis-sentinel-c.conf</a>
</p>

<p>
终端 <code>3</code> 启动 <code>Sentinel a</code> <code>redis-sentinel ./redis-sentinel-a.conf</code>
</p>

<p>
终端 <code>4</code> 启动 <code>Sentinel b</code> <code>redis-sentinel ./redis-sentinel-b.conf</code>
</p>

<p>
终端 <code>5</code> 启动 <code>Sentinel c</code> <code>redis-sentinel ./redis-sentinel-c.conf</code>
</p>

<p>
可以发现当 <code>Sentinel</code> 实例启动时 <code>Sentinel</code> 的配置文件会自动进行更新，记录 <code>Slave</code> 及其它 <code>Sentinel</code> 的信息。
</p>
</li>

<li>从 <code>Sentinel</code> 获取当前 <code>Master</code> 的地址

<p>
通过 <code>redis-cli</code> 连上任一 <code>Sentinel</code> <code>redis-cli -p 5000</code>
</p>

<pre class="example">
127.0.0.1:5000&gt; sentinel get-master-addr-by-name mymaster
1) "127.0.0.1"
2) "6379"
</pre>
</li>

<li>故障切换测试

<p>
让 <code>Master</code> 停止响应 <code>30</code> 秒 <code>redis-cli -p 6379 debug sleep 30</code>
</p>

<p>
约 <code>10</code> 秒钟后，通过 <code>Sentinel</code> 的日志输出看到发生了主从切换。
</p>

<p>
重新获取当前的 <code>Master</code>
</p>

<pre class="example">
127.0.0.1:5000&gt; sentinel get-master-addr-by-name mymaster
1) "127.0.0.1"
2) "6380"
</pre>

<p>
<code>Redis</code> 实例的配置文件被自动修正，以反映新的 <code>Master-Slave</code> 状态：
</p>

<p>
<code>redis-master.conf</code> 添加了配置行 <code>slaveof 127.0.0.1 6380</code>
</p>

<p>
<code>redis-slave.conf</code> 删除了配置行 <code>slaveof 127.0.0.1 6379</code>
</p>

<p>
和我们在上一篇文章《 <a href="http://blog.kankanan.com/article/redis-9ad853ef7528602757fa7840ff1a-master-slave.html">redis高可用性基础：Master-Slave</a> 》手工做的主备切换如出一辙。
</p>

<p>
三个 <code>Sentinel</code> 配置文件中的 <code>Master-Slave</code> 配置也被自动修正。
</p>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">疑问</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li><code>Redis</code> 实例的配置文件是被谁修改的？

<p>
如果是 <code>Sentinel</code> 那么就意味着所有 <code>Redis</code> 实例的同一机器上必须配置有 <code>Sentinel</code> （《<a href="http://redis.io/topics/sentinel">Redis Sentinel Documentation – Redis</a>》未提及）。
</p>
</li>

<li>万一因为某种原因，原 <code>Master</code> 配置文件未改为 <code>Slave</code> ，会不会出现脑裂？

<p>
感觉应该是会出现脑裂的，但是只要客户端应用总是使用 <code>Sentinel</code> 提供的 <code>Master</code> 地址，就不会有问题。
</p>

<p>
<code>node.js</code> 访问单个 <code>redis</code> 实例已经用得很溜了，下一篇文章会研究 <code>node.js</code> 访问 <code>redis sentinel</code> ，相信答案就会水落石出了。
</p>
</li>

<li><code>Redis Sentinel</code> 能保证不丢数据吗？

<p>
不能。由于 <code>Redis</code> 是异步复制，没有办法防止数据丢失，假设配置如下：
</p>

<pre class="example">
min-slaves-to-write 1
min-slaves-max-lag 10
</pre>

<p>
假设出现了分裂（partition）， <code>Master</code> 要 <code>10</code> 秒钟后才发现 <code>Slave</code> 失联再禁止写入，当分裂消除（partition heals）， 旧 <code>Master</code> 做为 <code>Slave</code> 连上新的 <code>Master</code> ，这 <code>10</code> 秒钟内写入的数据不会合入（merge）新的 <code>Master</code> ，数据丢失了。
</p>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">参考</h2>
<div class="outline-text-2" id="text-4">
<p>
<a href="http://redis.io/topics/sentinel">Redis Sentinel Documentation – Redis</a></p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[redis高可用性基础：Master-Slave]]></title>
            <link>/article/redis-9ad853ef7528602757fa7840ff1a-master-slave.html</link>
            <guid>/article/redis-9ad853ef7528602757fa7840ff1a-master-slave.html</guid>
            <pubDate>Fri, 25 Dec 2015 13:19:00 GMT</pubDate>
            <content:encoded><![CDATA[
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">理解Master-Slave</h2>
<div class="outline-text-2" id="text-1">
<p>
<code>Master-Slave</code> 常常翻译为 <code>主/备</code> ，是一种高可用性（ <a href="https://en.wikipedia.org/wiki/High_availability">High Availability</a> ）方案。
</p>

<p>
举个生活中的 <code>Master-Slave</code> 例子：
</p>

<blockquote>
<p>
参加考试的时候，我们会准备两支钢笔，正常情况下我们只会使用一支，出问题了才会换另外一支。
</p>
</blockquote>

<p>
所以实施 <code>Master-Slave</code> 是有成本的，至少会有 <code>50%</code> 的资源浪费（多备几支浪费会更多），可以让 <code>Slave</code> 承担一部分工作来充分利用资源。
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Redis的Master-Slave</h2>
<div class="outline-text-2" id="text-2">
<p>
关于 <code>Redis</code> 的 <code>Master-Slave</code> ，《<a href="http://redis.io/topics/replication">Replication – Redis</a>》 有详尽描述。
</p>

<p>
需要注意的是 <code>Redis</code> 的 <code>Master-Slave</code> 不能保证绝对不丢数据，而是丢失一小段时间内（如：1秒钟）的数据。
</p>

<p>
下面开始 <code>Redis</code> 的 <code>Master-Slave</code> 实践，使用的 <code>redis</code> 版本为 <code>3.0.6</code> 。
</p>
</div>

<div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1">创建Master结点</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li>redis配置文件

<p>
从 <code>/etc/redis.conf</code> 拷贝一份进行修改，无关的配置项已去掉，使用默认值即可。
</p>

<p>
<a href="../static/redis-master.conf">redis-master.conf</a>
</p>
</li>

<li>在终端 <code>1</code> 启动 <code>Master</code> 结点

<p>
<code>redis-server ./redis-master.conf</code>
</p>
</li>

<li>使用 <code>redis-cli</code> 连接 <code>Master</code>

<pre class="example">
$ redis-cli -p 6379
127.0.0.1:6379&gt;
</pre>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2">创建Slave结点</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li>redis配置文件

<p>
从 <code>redis-master.conf</code> 拷贝一份进行修改，主要是修改监听的端口号（ <code>6380</code> ）、PID文件名、DB文件名，
</p>

<p>
最关键的是设置为 <code>Master</code> 的 <code>Slave</code> <code>slaveof 127.0.0.1 6379</code> 。
</p>

<p>
<a href="../static/redis-slave.conf">redis-slave.conf</a>
</p>
</li>

<li>在终端 <code>2</code> 启动 <code>Slave</code> 结点

<p>
<code>redis-server ./redis-slave.conf</code>
</p>
</li>

<li>使用 <code>redis-cli</code> 连接 <code>Slave</code>

<pre class="example">
$ redis-cli -p 6380
127.0.0.1:6380&gt;
</pre>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3">演示Master写Slave读的场景</h3>
<div class="outline-text-3" id="text-2-3">
<ul class="org-ul">
<li>在 <code>Master</code> 写入

<pre class="example">
127.0.0.1:6379&gt; set hello world
OK
</pre>
</li>

<li>从 <code>Slave</code> 读取

<pre class="example">
127.0.0.1:6380&gt; get hello
"world"
</pre>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2-4" class="outline-3">
<h3 id="sec-2-4">演示Slave挂掉的场景</h3>
<div class="outline-text-3" id="text-2-4">
<ul class="org-ul">
<li>关闭 <code>Slave</code> 

<pre class="example">
127.0.0.1:6380&gt; shutdown
not connected&gt;
</pre>

<p>
终端 <code>2</code> 上的 <code>redis-server</code> 会自动退出，注意到它退出前进行了存盘。
</p>
</li>

<li>在 <code>Master</code> 写入

<pre class="example">
127.0.0.1:6379&gt; set hello redis
OK
</pre>
</li>

<li>在终端 <code>2</code> 上再次启动 <code>Slave</code>

<div class="org-src-container">

<pre class="src src-sh">redis-server ./redis-slave.conf
</pre>
</div>

<p>
从日志上可以看到 <code>Slave</code> 从 <code>Master</code> 重新进行了数据同步。
</p>
</li>

<li>在 <code>Slave</code> 上读取

<pre class="example">
not connected&gt; get hello
"redis"
127.0.0.1:6380&gt;
</pre>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2-5" class="outline-3">
<h3 id="sec-2-5">演示Master挂掉的场景</h3>
<div class="outline-text-3" id="text-2-5">
<ul class="org-ul">
<li>关闭 <code>Master</code>

<pre class="example">
127.0.0.1:6379&gt; shutdown
not connected&gt;
</pre>

<p>
终端 <code>1</code> 上的 <code>redis-server</code> 会自动退出，注意到它退出前进行了存盘， 终端 <code>2</code> 上的 <code>Slave</code> 在不断尝试重连 <code>Master</code> 。
</p>
</li>

<li>Master-Slave角色切换

<p>
将运行中的原 <code>Slave</code> 提升为新 <code>Master</code>
</p>

<pre class="example">
127.0.0.1:6380&gt; slaveof no one
OK
</pre>

<p>
修改原 <code>Slave</code> 的配置文件 <code>redis-slave.conf</code> 删除配置 <code>#slaveof 127.0.0.1 6379</code>
</p>

<p>
修改原 <code>Master</code> 的配置文件 <code>redis-master.conf</code> 添加配置 <code>slaveof 127.0.0.1 6380</code>
</p>
</li>

<li>在新 <code>Master</code> 写入

<pre class="example">
127.0.0.1:6380&gt; set hello master-slave
OK
</pre>
</li>

<li>在终端 <code>1</code> 上再次启动原 <code>Master</code> 

<div class="org-src-container">

<pre class="src src-sh">redis-server ./redis-master.conf
</pre>
</div>

<p>
从日志上可以看到它现在是 <code>Slave</code> 角色了，反而从原 <code>Slave</code> 同步数据。
</p>
</li>

<li>在原 <code>Master</code> 上读取

<pre class="example">
not connected&gt; get hello
"master-slave"
127.0.0.1:6379&gt;
</pre>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2-6" class="outline-3">
<h3 id="sec-2-6">总结</h3>
<div class="outline-text-3" id="text-2-6">
<p>
<code>Redis</code> 的 <code>Master-Slave</code> 是一种动态关系，角色（ <code>Master</code> 、 <code>Slave</code> ）会互相转换，角色转换过程中必须严格按照步骤来，操作不当可能导致数据丢失。
</p>

<p>
后面会发文介绍自动进行这种切换的工具 <code>Redis Sentinel</code> ，以及当 <code>Master-Slave</code> 发生切换后，应用程序该如何重连到新的 <code>Master</code> 。
</p>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">参考</h2>
<div class="outline-text-2" id="text-3">
<p>
<a href="https://en.wikipedia.org/wiki/Master/slave_(technology)">Master/slave (technology) - Wikipedia, the free encyclopedia</a>
</p>

<p>
<a href="http://redis.io/topics/replication">Replication – Redis</a>
</p>

<p>
<a href="http://www.tuicool.com/articles/2QbABj">Redis slave切换为master操作（不停机） - 推酷</a></p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[升级redis到最新版本的过程]]></title>
            <link>/article/53477ea7-redis-5230670065b07248672c76848fc77a0b.html</link>
            <guid>/article/53477ea7-redis-5230670065b07248672c76848fc77a0b.html</guid>
            <pubDate>Mon, 10 Aug 2015 09:56:00 GMT</pubDate>
            <content:encoded><![CDATA[<ul class="org-ul">
<li>编译最新版本的redis，暂不要安装

<p>
参见《<a href="http:7f168bd15b8988c5-redis.html">编译安装redis</a>》
</p>
</li>

<li>将旧版的redis.conf配置文件中的配置项合入新版本redis.conf

<p>
可能需要提前确认一下新版本redis是否兼容旧版本数据文件。
</p>
</li>

<li>卸载并停止旧版本redis
</li>

<li>安装新版本redis

<p>
参见《<a href="http:7f168bd15b8988c5-redis.html">编译安装redis</a>》
</p>
</li>

<li>启动新版本redis
</li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[linux服务器出现大量CLOSE_WAIT状态的连接]]></title>
            <link>/article/linux-670d52a1566851fa73b0592791cf-close_wait-72b6600176848fde63a5.html</link>
            <guid>/article/linux-670d52a1566851fa73b0592791cf-close_wait-72b6600176848fde63a5.html</guid>
            <pubDate>Sat, 01 Aug 2015 19:21:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
昨天服务器停止服务，node.js进程耗光了服务器的内存及CPU，node.js进程卡死无法被 <code>kill</code> 掉，最后要来root帐号密码，直接 <code>kill -9</code> 才结束掉进程。
</p>

<p>
再次鄙视一下 <a href="https://github.com/nodejitsu/forever">forever</a> ，杀不掉原来的 node.js 进程组也就罢了，竟然又拉起了一套新的 node.js 进程组。
</p>

<p>
统计了一下 <code>10</code> 万个fd都耗光了，其中 <code>9</code> 万多个为 <code>CLOSE_WAIT</code> 状态，此时服务器已经无法响应请求。
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">CLOSE_WAIT 状态介绍</h2>
<div class="outline-text-2" id="text-1">
<p>
先看一副TCP连接关闭的状态图（ <a href="http://intronetworks.cs.luc.edu/current/html/tcp.html#index-29">来源</a> ）：
</p>


<div class="figure">
<p><img src="../static/tcp_normal_close.png" alt="tcp_normal_close.png" />
</p>
</div>

<p>
被动关闭一方才会出现 <code>CLOSE_WAIT</code> 状态，由于被动关闭方未调用 <code>close</code> 关闭socket导致，问题肯定是由服务器代码引起。
</p>

<p>
检测到对端socket关闭然后关闭本端socket是由 node.js 自行完成的，最大的可能是没有机会执行 <code>close</code> 。
</p>

<p>
我们的应用客户端与服务器有一个tls长连接，当连接断开时客户端会等待3-10秒后尝试重连服务器，如果服务器出现卡顿会导致客户端频繁重连，
</p>

<p>
如果服务器来不及关闭这些连接，则会出现 CLOSE_WAIT 状态的连接，占用大量文件描述符，减少 CLOSE_WAIT 超时时间能够在一定程度上缓解这个问题，
</p>

<p>
但是对于我们这种长连接的环境，大量CLOSE_WAIT是问题的表象，而非根源。
</p>

<p>
参考：《<a href="http://lvxuehu.iteye.com/blog/452487">解决CLOSE_WAIT 问题</a>》
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">内存及CPU占用彪升问题</h2>
<div class="outline-text-2" id="text-2">
<p>
伴随着 CLOSE_WAIT 出现的状况是 node.js 进程内存及CPU占用超高，单node.js进程内存占用达到 1.5G，CPU占用 90% 以上，此时应该会导致 node.js 响应慢，
来不及关闭连上来的socket。
</p>

<p>
所以解决问题的关键就是：找出什么原因导致 node.js 内存及CPU 100%占用。
</p>

<p>
想到的可能是redis负载过高引起，从运维监控图上可以看出一些蹊跷，node.js出问题时redis的连接数也同样彪升，而出问题的机器上刚好就是跑redis的机器，
另一台服务器一直相安无事，没有跑redis。
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">一次午夜故障元凶浮出水面</h2>
<div class="outline-text-2" id="text-3">
<p>
在晚上两点的时候服务出现问题，同样的现象，特别留意了一下redis的统计，请求速度很低，只有1200，平时都是5000。偶然在进程列表中发现了 redis-rdb-bgsave 的身影，
不断地执行ps看进程列表，发现 redis-rdb-bgsave 进程不断地出现，查看redis的持久化配置如下：
</p>

<pre class="example">
save 900 1
save 300 10
save 60 10000
</pre>

<p>
我们的系统有大量的redis，1分钟肯定过万，这样redis持久化变是常态了，而且由于用的是机械硬盘，持久化肯定会引起系统卡顿，先将它调整为15分钟最多持久化一次：
</p>

<pre class="example">
config set save "900 1"
</pre>

<p>
重启程序释放资源后系统开始正常响应，但是10多分钟后系统再次无响应，才想起一则经验教训：
</p>

<pre class="example">
     跑redis的机器至少要预留和redis占用内存同样大小的空闲内存空间，redis RDB持久化进行fork时最坏会占用双倍内存，内存不足就会动用交换分区，系统性能急剧下降。
</pre>

<p>
于是，立即改配置将redis所在机器上的node.js cluster进程数调小，腾出大把内存，总算没有再出现问题，今晚终于可以入眠。
</p>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">更多疑问</h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li>我们的node.js进程为什么常常会占用很多内存？
</li>

<li>netstat中看到CLOSE_WAIT状态的连接输入缓冲往往有数据，而ESTABLISHED状态的连接读写缓冲区往往为空，为什么？
</li>

<li>node.js卡顿时forever杀不死反而启动了新实例帮倒忙，pm2就一定能够解决吗？
</li>

<li>redis持久化引起服务挂掉，已经是在第二个项目中遇到了，终极解决方案是什么？
</li>
</ul>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[编译安装redis]]></title>
            <link>/article/7f168bd15b8988c5-redis.html</link>
            <guid>/article/7f168bd15b8988c5-redis.html</guid>
            <pubDate>Mon, 17 Feb 2014 08:40:00 GMT</pubDate>
            <content:encoded><![CDATA[<ul class="org-ul">
<li>下载

<p>
到 <a href="http://redis.io/download">http://redis.io/download</a> 下载最新稳定版本。
</p>
</li>

<li>安装

<p>
解压后参照 README 进行安装：
</p>

<div class="org-src-container">

<pre class="src src-sh">make
make install
</pre>
</div>

<p>
默认安装到/usr/local。
</p>

<p>
指定位置安装： 
</p>

<div class="org-src-container">

<pre class="src src-sh">make <span style="color: #ffcc66;">PREFIX</span>=/usr/local/redis install
</pre>
</div>
</li>

<li>安装后

<dl class="org-dl">
<dt> /usr/local/bin/redis-cli </dt><dd>redis客户端程序 
</dd>
<dt> /usr/local/bin/redis-server </dt><dd>redis服务器程序
</dd>
</dl>
</li>

<li>配置

<p>
将源码包附带的配置文件 <code>redis.conf</code> 拷贝到安装位置:
</p>

<div class="org-src-container">

<pre class="src src-sh">mkdir /usr/local/redis/etc/
cp ./redis.conf /usr/local/redis/etc/
</pre>
</div>

<p>
修改配置文件 <code>redis.conf</code> :
</p>

<pre class="example">
daemonize yes
pidfile /usr/local/redis/var/redis.pid
logfile /usr/local/redis/var/redis.log
dir /usr/local/redis/data
stop-writes-on-bgsave-error no
bind 127.0.0.1
</pre>
</li>

<li>启动

<div class="org-src-container">

<pre class="src src-sh">/usr/local/redis/bin/redis-server /usr/local/redis/etc/redis.conf
</pre>
</div>
</li>

<li>停止

<p>
使用redis客户端中执行shutdown命令
</p>

<div class="org-src-container">

<pre class="src src-sh">redis-cli
shutdown
</pre>
</div>
</li>
</ul>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[使用hash表结构减少redis内存占用]]></title>
            <link>/article/4f7f7528-hash-88687ed3678451cf5c11-redis-51855b5853607528.html</link>
            <guid>/article/4f7f7528-hash-88687ed3678451cf5c11-redis-51855b5853607528.html</guid>
            <pubDate>Sun, 16 Dec 2012 07:14:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
当hash结构中的元素较少（少于redis.conf:hash-max-zipmap-entries指定的数量时，配置成&lt;=1000，过大会减低处理速度，参见： <a href="http://stackoverflow.com/questions/11281734/redis-using-hashes">这里</a> 和 <a href="http://instagram-engineering.tumblr.com/post/12202313862/storing-hundreds-of-millions-of-simple-key-value-pairs">这里</a> ）且数据为整型时，redis使用特殊的方式（数组保存，时间换空间）保存hash结构以减少内存占用，参见 <a href="http://redis.io/topics/memory-optimization">这里</a> 和 <a href="http://stackoverflow.com/questions/9625246/what-are-the-underlying-data-structures-used-for-redis">这里</a> 。但当hash结构超过指定数量时将使用普通的<a href="http://redis.io/commands#string">字符串</a>方式保存，也就无法再节省内存了。</p>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[解决保存快照失败后redis无法写入的问题]]></title>
            <link>/article/89e351b34fdd5b585feb716759318d25540e-redis-65e06cd551995165768495ee9898.html</link>
            <guid>/article/89e351b34fdd5b585feb716759318d25540e-redis-65e06cd551995165768495ee9898.html</guid>
            <pubDate>Sun, 16 Dec 2012 07:14:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
用命令行工具连上后执行“set test 0”出现以下错误提示：
</p>
<pre class="example">
MISCONF Redis is configured to save RDB snapshots, but is currently not able to persist on disk. Commands that may modify the data set are disabled. Please check Redis logs for details about the error.
</pre>
<p>
这个应该是之前强制停止redis快照导致的，查看redis快照状态证实了这一点：
</p>
<pre class="example">
redis 127.0.0.1:6379&gt; info
...
rdb_last_bgsave_status:err
...
</pre>
<p>
通过关闭配置项stop-writes-on-bgsave-error解决该问题。
</p>
<pre class="example">
redis 127.0.0.1:6379&gt; config set stop-writes-on-bgsave-error no
</pre>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[估算redis内存占用]]></title>
            <link>/article/4f307b97-redis-51855b5853607528.html</link>
            <guid>/article/4f307b97-redis-51855b5853607528.html</guid>
            <pubDate>Sun, 16 Dec 2012 07:14:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
参考: <a href="http://lethain.com/notes-on-redis-memory-usage/">Notes on Redis Memory Usage</a>
</p>

<ul class="org-ul">
<li>测试环境
<dl class="org-dl">
<dt> redis版本 </dt><dd>redis_version:2.4.4
</dd>
<dt> 操作系统（uname -a） </dt><dd>Linux CentOS 2.6.32-220.13.1.el6.x86_64 #1 SMP Tue Apr 17 23:56:34 BST 2012 x86_64 x86_64 x86_64 GNU/Linux
</dd>
<dt> python版本（python &#x2013;version） </dt><dd>Python 2.6.6
</dd>
</dl>
</li>
</ul>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Strings</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>测试脚本
<div class="org-src-container">

<pre class="src src-python"><span style="color: #999999; font-style: italic;">#</span><span style="color: #999999; font-style: italic;">!/bin/env python</span>

<span style="color: #99cc99;">import</span> redis
<span style="color: #99cc99;">import</span> uuid
<span style="color: #99cc99;">import</span> time

<span style="color: #ffcc66;">r</span> = redis.Redis(host=<span style="color: #66cccc;">'localhost'</span>, port=6379, db=0)
<span style="color: #99cc99;">for</span> num_strings <span style="color: #99cc99;">in</span> (100000,):
<span style="background-color: #515151;"> </span>   r.flushall()
<span style="background-color: #515151;"> </span>   time.sleep(1.0)
<span style="background-color: #515151;"> </span>   <span style="color: #ffcc66;">initial_size</span> = r.dbsize()
<span style="background-color: #515151;"> </span>   <span style="color: #ffcc66;">initial_info</span> = r.info()

<span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">for</span> i <span style="color: #99cc99;">in</span> <span style="color: #cc99cc;">xrange</span>(0, num_strings):
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   r.<span style="color: #cc99cc;">set</span>(<span style="color: #cc99cc;">str</span>(uuid.uuid4()), time.time())
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #999999; font-style: italic;">#</span><span style="color: #999999; font-style: italic;">r.setex(str(uuid.uuid4()), time.time(), 100000)</span>
<span style="background-color: #515151;"> </span>   <span style="color: #ffcc66;">final_size</span> = r.dbsize()
<span style="background-color: #515151;"> </span>   <span style="color: #ffcc66;">final_info</span> = r.info()

<span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">print</span> <span style="color: #66cccc;">"For %s strings."</span> % (num_strings,)
<span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">print</span> <span style="color: #66cccc;">"Keys: %s =&gt; %s"</span> % (initial_size, final_size)
<span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">print</span> <span style="color: #66cccc;">"Memory: %s =&gt; %s"</span> % (initial_info[<span style="color: #66cccc;">'used_memory'</span>],
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   final_info[<span style="color: #66cccc;">'used_memory'</span>])
<span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">print</span> <span style="color: #66cccc;">"Memory per key: %d"</span>%((<span style="color: #cc99cc;">int</span>(final_info[<span style="color: #66cccc;">'used_memory'</span>]) - <span style="color: #cc99cc;">int</span>(initial_in<span style="text-decoration: underline;">fo[</span><span style="color: #66cccc; text-decoration: underline;">'used_memory'</span><span style="text-decoration: underline;">])) / num_strings)</span>
</pre>
</div>
</li>
<li>测试结果
<dl class="org-dl">
<dt> set </dt><dd>每个key-value占用138字节，可见redis本身的维护开销为89字节
</dd>
<dt> setex </dt><dd>每个key-value占用180字节，可见redis本身的维护开销为131字节，启用过期时间需要42字节开销（这是因为redis使用新的链表保存设置了过期时间的条目）。
</dd>
</dl>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Sets</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>测试脚本
<div class="org-src-container">

<pre class="src src-python"><span style="color: #999999; font-style: italic;">#</span><span style="color: #999999; font-style: italic;">!/bin/env python</span>

<span style="color: #99cc99;">import</span> redis
<span style="color: #99cc99;">import</span> math
<span style="color: #99cc99;">import</span> time

<span style="color: #ffcc66;">r</span> = redis.Redis(host=<span style="color: #66cccc;">'localhost'</span>, port=6379, db=0)
<span style="color: #ffcc66;">set_capcity</span> = <span style="color: #cc99cc;">int</span>(r.config_get(<span style="color: #66cccc;">"set-max-intset-entries"</span>)[<span style="color: #66cccc;">"set-max-intset-entries</span><span style="color: #66cccc; text-decoration: underline;">"</span><span style="text-decoration: underline;">])</span>

<span style="color: #99cc99;">def</span> <span style="color: #f99157;">set_name</span>(i, num_strings, set_capcity):
<span style="background-color: #515151;"> </span>   <span style="color: #ffcc66;">set_num</span> = math.ceil(num_strings/<span style="color: #cc99cc;">float</span>(set_capcity))
<span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">return</span> <span style="color: #66cccc;">"s%d"</span>%(i%set_num)

<span style="color: #99cc99;">for</span> num_strings <span style="color: #99cc99;">in</span> (100000,):
<span style="background-color: #515151;"> </span>   r.flushall()
<span style="background-color: #515151;"> </span>   time.sleep(1.0)
<span style="background-color: #515151;"> </span>   <span style="color: #ffcc66;">initial_size</span> = r.dbsize()
<span style="background-color: #515151;"> </span>   <span style="color: #ffcc66;">initial_info</span> = r.info()

<span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">for</span> i <span style="color: #99cc99;">in</span> <span style="color: #cc99cc;">xrange</span>(0, num_strings):
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #999999; font-style: italic;">#</span><span style="color: #999999; font-style: italic;">r.sadd("s", str(i))</span>
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   r.sadd(set_name(i, num_strings, set_capcity), <span style="color: #cc99cc;">str</span>(i))
<span style="background-color: #515151;"> </span>   <span style="color: #ffcc66;">final_size</span> = r.dbsize()
<span style="background-color: #515151;"> </span>   <span style="color: #ffcc66;">final_info</span> = r.info()

<span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">print</span> <span style="color: #66cccc;">"For %s strings."</span> % (num_strings,)
<span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">print</span> <span style="color: #66cccc;">"Keys: %s =&gt; %s"</span> % (initial_size, final_size)
<span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">print</span> <span style="color: #66cccc;">"Memory: %s =&gt; %s"</span> % (initial_info[<span style="color: #66cccc;">'used_memory'</span>],
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   final_info[<span style="color: #66cccc;">'used_memory'</span>])
<span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">print</span> <span style="color: #66cccc;">"Memory per key: %d"</span>%((<span style="color: #cc99cc;">int</span>(final_info[<span style="color: #66cccc;">'used_memory'</span>]) - <span style="color: #cc99cc;">int</span>(initial_in<span style="text-decoration: underline;">fo[</span><span style="color: #66cccc; text-decoration: underline;">'used_memory'</span><span style="text-decoration: underline;">])) / num_strings)</span>
</pre>
</div>
</li>

<li>测试结果
<dl class="org-dl">
<dt> 启用压缩 </dt><dd>每个value占用4字节
</dd>
<dt> 不启用压缩 </dt><dd>每个value占用39字节
</dd>
</dl>
<p>
注意: redis的set仅当值为整型，压缩才会生效。
</p>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">内存预留</h2>
<div class="outline-text-2" id="text-3">
<p>
除非你能够保证你的机器总是有一半的空闲内存，否则别使用快照方式持久化数据或者通过执行BGREWRITEAOF压缩aof文件。
redis在执行bgsave时，会进行一次fork，fork后的进程负责将内存中的数据写入磁盘，由于fork采用Copy-On-Write，两个redis进程共享内存中的数据。redis如果有数据更新，则会将对应的共享内存页创建一份副本再更新，当更新操作足够频繁时，共享的内存空间会迅速地副本化，导致物理内存被耗光，系统被迫动用交换空间，从而导致redis服务极不稳定，整个系统堵塞在磁盘io上。</p>
</div>
</div>
]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[当php遇上redis]]></title>
            <link>/article/5f53-php-90474e0a-redis.html</link>
            <guid>/article/5f53-php-90474e0a-redis.html</guid>
            <pubDate>Sat, 08 Dec 2012 05:41:00 GMT</pubDate>
            <content:encoded><![CDATA[<p>
在最近的项目中，我们需要在php中访问redis，我们选择了使用<a href="https://github.com/nicolasff/phpredis">phpredis</a>库，下面是遇到的一些问题。
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">redis持久连接不靠谱。</h2>
<div class="outline-text-2" id="text-1">
<p>
可以说这是php的通病了，不管是mysql、memcache还是redis，指望由php本身（包含php扩展）来实现持久连接都是行不通的。
</p>

<dl class="org-dl">
<dt> 为什么这么说呢？ </dt><dd>     首先，所谓的持久连接的实现不外乎在进程（php-fpm）内建一个连接池，当php需要连接时，先以ip+port等信息为key在池中查找，找到则直接返回已有连接没有则新建连接。而当一个请求执行结束时，不关闭连接，而是把连接归还到池中。

<p>
这样当php需要用到多个redis实例时（分库），因为一个php-fpm进程会持有每个redis实例的一个连接，所以需要“php-fpm进程数“*“redis实例数"个redis连接，而对于每个redis服务器则有“php-fpm进程数“个客户端连接。
</p>

<p>
举个例子：一个web应用开了1000个php-fpm进程，有10个redis实例，那么保持的redis连接数就为1000*10也就是10000，每个redis实例有1000个客户端连接。如果前端或redis再扩容所需要的连接就会以乘积方式增加。一个redis实例有php-fpm进程数个连接的情况下表现如何呢，这就要好好测一测了，反正是每连接一线程的mysql是直接堵死了。
</p>
</dd>
</dl>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">RedisArray不靠谱。</h2>
<div class="outline-text-2" id="text-2">
<p>
RedisArray实现了一致性hash分布式，但是它在初始化的时候就会连接上每个实例，这在web应用中简直是胡闹，它对一致性hash实现得比较完善，结点失效、动态添加结点时重新hash都有处理，在万不得已进行水平扩容时，可能会用得上。
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">需要自已关闭redis连接。</h2>
<div class="outline-text-2" id="text-3">
<p>
Redis的析构函数没有关闭redis连接，这会导致redis网络负载过高，要确保脚本结束时关闭连接，最好是能够封装一下Redis类再使用。
</p>

<dl class="org-dl">
<dt> 示例封装 </dt><dd></dd>
</dl>
<div class="org-src-container">

<pre class="src src-php"><span style="color: #999999; font-style: italic;">/// </span><span style="color: #999999; font-style: italic;">&#20998;&#24067;&#24335;Redis.</span>
<span style="color: #99cc99;">class</span> <span style="color: #6699cc;">RedisShard</span> {
<span style="background-color: #515151;"> </span>   <span style="color: #999999; font-style: italic;">/// </span><span style="color: #999999; font-style: italic;">&#26500;&#36896;&#20989;&#25968;.</span>
<span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">public</span> <span style="color: #99cc99;">function</span> <span style="color: #f99157;">__construct</span>($<span style="color: #ffcc66;">shards</span>) {
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   $<span style="color: #6699cc;">this</span>-&gt;<span style="color: #cccccc; background-color: #2d2d2d;">reinit</span>($<span style="color: #ffcc66;">shards</span>);
<span style="background-color: #515151;"> </span>   }

<span style="background-color: #515151;"> </span>   <span style="color: #999999; font-style: italic;">/// </span><span style="color: #999999; font-style: italic;">&#26512;&#26500;&#20989;&#25968;.</span>
<span style="background-color: #515151;"> </span>   <span style="color: #999999; font-style: italic;">/// </span><span style="color: #999999; font-style: italic;">&#33050;&#26412;&#32467;&#26463;&#26102;&#65292;phpredis&#19981;&#20250;&#33258;&#21160;&#20851;&#38381;redis&#36830;&#25509;&#65292;&#36825;&#37324;&#28155;&#21152;&#33258;&#21160;&#20851;&#38381;&#36830;&#25509;&#25903;&#25345;.</span>
<span style="background-color: #515151;"> </span>   <span style="color: #999999; font-style: italic;">/// </span><span style="color: #999999; font-style: italic;">&#21487;&#20197;&#36890;&#36807;&#25163;&#21160;unset&#26412;&#31867;&#23545;&#35937;&#24555;&#36895;&#37322;&#25918;&#36164;&#28304;.</span>
<span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">public</span> <span style="color: #99cc99;">function</span> <span style="color: #f99157;">__destruct</span>() {
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">if</span>(<span style="color: #cccccc; background-color: #2d2d2d;">isset(</span>$<span style="color: #6699cc;">this</span>-&gt;<span style="color: #ffcc66;">shard</span>)){
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   $<span style="color: #6699cc;">this</span>-&gt;<span style="color: #ffcc66;">shard</span>[<span style="color: #66cccc;">'redis'</span>]-&gt;<span style="color: #cccccc; background-color: #2d2d2d;">close</span>();
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   }
<span style="background-color: #515151;"> </span>   }

<span style="background-color: #515151;"> </span>   <span style="color: #999999; font-style: italic;">/// </span><span style="color: #999999; font-style: italic;">&#37325;&#26032;&#21021;&#22987;&#21270;.</span>
<span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">public</span> <span style="color: #99cc99;">function</span> <span style="color: #f99157;">reinit</span>($<span style="color: #ffcc66;">shards</span>){
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   $<span style="color: #ffcc66;">index</span> = <span style="color: #cccccc; background-color: #2d2d2d;">0</span>;
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   $<span style="color: #6699cc;">this</span>-&gt;<span style="color: #ffcc66;">shards</span> = <span style="color: #cccccc; background-color: #2d2d2d;">array(</span>);
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">foreach</span>($<span style="color: #ffcc66;">shards</span> <span style="color: #99cc99;">as</span> $<span style="color: #ffcc66;">shard</span>){
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   $<span style="color: #6699cc;">this</span>-&gt;<span style="color: #ffcc66;">shards</span>[$<span style="color: #ffcc66;">index</span>] = <span style="color: #cccccc; background-color: #2d2d2d;">explode(</span><span style="color: #66cccc;">':'</span>, $<span style="color: #ffcc66;">shard</span>); <span style="color: #999999; font-style: italic;">//</span><span style="color: #999999; font-style: italic;">&#26684;&#24335;&#65306;host:port:db</span>
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   $<span style="color: #6699cc;">this</span>-&gt;<span style="color: #ffcc66;">shards</span>[$<span style="color: #ffcc66;">index</span>][<span style="color: #66cccc;">'index'</span>] = $<span style="color: #ffcc66;">index</span>;
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   ++$<span style="color: #ffcc66;">index</span>;
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   }<span style="color: #f2777a; background-color: #515151;">        </span>
<span style="background-color: #515151;"> </span>   }

<span style="background-color: #515151;"> </span>   <span style="color: #999999; font-style: italic;">/// </span><span style="color: #999999; font-style: italic;">&#36716;&#21457;&#26041;&#27861;&#35843;&#29992;&#21040;&#30495;&#27491;&#30340;redis&#23545;&#35937;.</span>
<span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">public</span> <span style="color: #99cc99;">function</span> <span style="color: #f99157;">__call</span>($<span style="color: #ffcc66;">name</span>, $<span style="color: #ffcc66;">arguments</span>) {
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   $<span style="color: #ffcc66;">result</span> = <span style="color: #cccccc; background-color: #2d2d2d;">call_user_func_array(array(</span>$<span style="color: #6699cc;">this</span>-&gt;<span style="color: #cccccc; background-color: #2d2d2d;">redis</span>($<span style="color: #ffcc66;">arguments</span>[<span style="color: #cccccc; background-color: #2d2d2d;">0</span>]), $<span style="color: #ffcc66;">name</span>)<span style="text-decoration: underline;">, $</span><span style="color: #ffcc66; text-decoration: underline;">arguments</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">if</span>($<span style="color: #ffcc66;">result</span> === <span style="color: #6699cc;">false</span> <span style="color: #99cc99;">and</span> <span style="color: #cccccc; background-color: #2d2d2d;">in_array(</span>$<span style="color: #ffcc66;">name</span>, <span style="color: #cccccc; background-color: #2d2d2d;">array(</span><span style="color: #66cccc;">'set'</span>, <span style="color: #66cccc;">'setex'</span>, <span style="color: #66cccc;">'incr'</span>)))<span style="text-decoration: underline;"> {</span>
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #cccccc; background-color: #2d2d2d;">trigger_error(</span><span style="color: #66cccc;">"redis error: "</span> . $<span style="color: #6699cc;">this</span>-&gt;<span style="color: #ffcc66;">shard</span>[<span style="color: #cccccc; background-color: #2d2d2d;">0</span>] . <span style="color: #66cccc;">':'</span> . $<span style="color: #6699cc;">this</span>-&gt;<span style="color: #ffcc66;">shard</span><span style="text-decoration: underline;">[</span><span style="color: #cccccc; background-color: #2d2d2d; text-decoration: underline;">1</span><span style="text-decoration: underline;">] . </span><span style="color: #66cccc; text-decoration: underline;">':'</span><span style="text-decoration: underline;"> .$</span><span style="color: #6699cc; text-decoration: underline;">this</span><span style="text-decoration: underline;">-&gt;</span><span style="color: #ffcc66; text-decoration: underline;">shard</span><span style="text-decoration: underline;">[</span><span style="color: #cccccc; background-color: #2d2d2d; text-decoration: underline;">2</span><span style="text-decoration: underline;">] . </span><span style="color: #66cccc; text-decoration: underline;">" $name "</span><span style="text-decoration: underline;"> . </span><span style="color: #cccccc; background-color: #2d2d2d; text-decoration: underline;">implode(</span><span style="color: #66cccc; text-decoration: underline;">' '</span><span style="text-decoration: underline;">, $</span><span style="color: #ffcc66; text-decoration: underline;">arguments</span><span style="text-decoration: underline;">), </span><span style="color: #6699cc; text-decoration: underline;">E_USER_NOTICE</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   }
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">return</span> $<span style="color: #ffcc66;">result</span>;
<span style="background-color: #515151;"> </span>   }

<span style="background-color: #515151;"> </span>   <span style="color: #999999; font-style: italic;">/// </span><span style="color: #999999; font-style: italic;">&#33719;&#21462;1&#33267;max&#38388;&#30340;&#21807;&#19968;&#24207;&#21495;name&#65292;&#36798;&#21040;max&#21518;&#20250;&#20174;1&#24320;&#22987;.</span>
<span style="background-color: #515151;"> </span>   <span style="color: #999999; font-style: italic;">/// </span><span style="color: #999999; font-style: italic;">redis&#30340;&#36882;&#22686;&#21040;&#26368;&#22823;&#20540;&#21518;&#20250;&#36820;&#22238;&#38169;&#35823;&#65292;&#26412;&#26041;&#27861;&#23454;&#29616;&#23433;&#20840;&#30340;&#36882;&#22686;&#12290;</span>
<span style="background-color: #515151;"> </span>   <span style="color: #999999; font-style: italic;">/// </span><span style="color: #999999; font-style: italic;">&#22833;&#36133;&#36820;&#22238;false&#65292;&#26368;&#35201;&#30830;&#20445;&#24050;&#29992;redis()&#26041;&#27861;&#36830;&#21040;&#29983;&#25104;&#24207;&#21495;&#30340;&#26576;&#20010;redis&#23545;&#35937;.</span>
<span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">public</span> <span style="color: #99cc99;">function</span> <span style="color: #f99157;">id</span>($<span style="color: #ffcc66;">name</span>, $<span style="color: #ffcc66;">max</span>) {
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">if</span>(<span style="color: #cccccc; background-color: #2d2d2d;">isset(</span>$<span style="color: #6699cc;">this</span>-&gt;<span style="color: #ffcc66;">shard</span>)){
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   $<span style="color: #ffcc66;">id</span> = $<span style="color: #6699cc;">this</span>-&gt;<span style="color: #ffcc66;">shard</span>[<span style="color: #66cccc;">'redis'</span>]-&gt;<span style="color: #cccccc; background-color: #2d2d2d;">incr</span>(<span style="color: #66cccc;">'_id_'</span> . $<span style="color: #ffcc66;">name</span>);
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">if</span>($<span style="color: #ffcc66;">id</span>){
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   $<span style="color: #ffcc66;">max</span> = <span style="color: #cccccc; background-color: #2d2d2d;">intval(</span>$<span style="color: #ffcc66;">max</span>/<span style="color: #cccccc; background-color: #2d2d2d;">count(</span>$<span style="color: #6699cc;">this</span>-&gt;<span style="color: #ffcc66;">shards</span>));
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">if</span>($<span style="color: #ffcc66;">id</span> % $<span style="color: #ffcc66;">max</span> == <span style="color: #cccccc; background-color: #2d2d2d;">0</span>){
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">while</span>($<span style="color: #6699cc;">this</span>-&gt;<span style="color: #ffcc66;">shard</span>[<span style="color: #66cccc;">'redis'</span>]-&gt;<span style="color: #cccccc; background-color: #2d2d2d;">decrBy</span>(<span style="color: #66cccc;">'_id_'</span> . $<span style="color: #ffcc66;">name</span>, $<span style="color: #ffcc66;">max</span>) &gt;=<span style="text-decoration: underline;"> $</span><span style="color: #ffcc66; text-decoration: underline;">max</span><span style="text-decoration: underline;">){</span>
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   }
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   $<span style="color: #ffcc66;">id</span> = $<span style="color: #ffcc66;">max</span>;
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   }
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">else</span> <span style="color: #99cc99;">if</span>($<span style="color: #ffcc66;">id</span> &gt; $<span style="color: #ffcc66;">max</span>){
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   $<span style="color: #ffcc66;">id</span> %= $<span style="color: #ffcc66;">max</span>;
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   }
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">return</span> ($<span style="color: #ffcc66;">id</span> - <span style="color: #cccccc; background-color: #2d2d2d;">1</span>)*<span style="color: #cccccc; background-color: #2d2d2d;">count(</span>$<span style="color: #6699cc;">this</span>-&gt;<span style="color: #ffcc66;">shards</span>) + ($<span style="color: #6699cc;">this</span>-&gt;<span style="color: #ffcc66;">shard</span>[<span style="color: #66cccc;">'index'</span>] +<span style="text-decoration: underline;"> </span><span style="color: #cccccc; background-color: #2d2d2d; text-decoration: underline;">1</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   }
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   }
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">return</span> <span style="color: #6699cc;">false</span>;
<span style="background-color: #515151;"> </span>   }

<span style="background-color: #515151;"> </span>   <span style="color: #999999; font-style: italic;">/// </span><span style="color: #999999; font-style: italic;">&#36830;&#25509;&#24182;&#36820;&#22238;key&#23545;&#24212;&#30340;redis&#23545;&#35937;.</span>
<span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">public</span> <span style="color: #99cc99;">function</span> <span style="color: #f99157;">redis</span>($<span style="color: #ffcc66;">key</span>){
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #999999; font-style: italic;">//</span><span style="color: #999999; font-style: italic;">TODO: crc32&#22312;32&#20301;&#31995;&#32479;&#19979;&#20250;&#36820;&#22238;&#36127;&#25968;&#65292;&#22240;&#25105;&#20204;&#26159;&#37096;&#32626;&#22312;64&#20301;&#31995;&#32479;&#19978;&#65292;&#26242;&#26102;&#24573;&#30053;.</span>
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #cccccc; background-color: #2d2d2d;">assert(</span><span style="color: #f2777a; font-weight: bold;">PHP_INT_SIZE</span> === <span style="color: #cccccc; background-color: #2d2d2d;">8</span>);
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   $<span style="color: #ffcc66;">index</span> = <span style="color: #cccccc; background-color: #2d2d2d;">crc32(</span>$<span style="color: #ffcc66;">key</span>) % <span style="color: #cccccc; background-color: #2d2d2d;">count(</span>$<span style="color: #6699cc;">this</span>-&gt;<span style="color: #ffcc66;">shards</span>);
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   $<span style="color: #ffcc66;">shard</span> = $<span style="color: #6699cc;">this</span>-&gt;<span style="color: #ffcc66;">shards</span>[$<span style="color: #ffcc66;">index</span>];
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">if</span>(<span style="color: #cccccc; background-color: #2d2d2d;">isset(</span>$<span style="color: #6699cc;">this</span>-&gt;<span style="color: #ffcc66;">shard</span>)){
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #999999; font-style: italic;">//</span><span style="color: #999999; font-style: italic;">&#23581;&#35797;&#37325;&#29992;&#24050;&#26377;&#36830;&#25509;.</span>
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">if</span>($<span style="color: #6699cc;">this</span>-&gt;<span style="color: #ffcc66;">shard</span>[<span style="color: #cccccc; background-color: #2d2d2d;">0</span>] == $<span style="color: #ffcc66;">shard</span>[<span style="color: #cccccc; background-color: #2d2d2d;">0</span>] <span style="color: #99cc99;">and</span> $<span style="color: #6699cc;">this</span>-&gt;<span style="color: #ffcc66;">shard</span>[<span style="color: #cccccc; background-color: #2d2d2d;">1</span>] == $<span style="color: #ffcc66;">shard</span>[<span style="color: #cccccc; background-color: #2d2d2d;">1</span>]){
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">if</span>($<span style="color: #6699cc;">this</span>-&gt;<span style="color: #ffcc66;">shard</span>[<span style="color: #cccccc; background-color: #2d2d2d;">2</span>] != $<span style="color: #ffcc66;">shard</span>[<span style="color: #cccccc; background-color: #2d2d2d;">2</span>]){
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">if</span>(! $<span style="color: #6699cc;">this</span>-&gt;<span style="color: #ffcc66;">shard</span>[<span style="color: #66cccc;">'redis'</span>]-&gt;<span style="color: #cccccc; background-color: #2d2d2d;">select</span>($<span style="color: #ffcc66;">shard</span>[<span style="color: #cccccc; background-color: #2d2d2d;">2</span>])){
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #cccccc; background-color: #2d2d2d;">trigger_error(</span><span style="color: #66cccc;">'redis error: select '</span> . $<span style="color: #ffcc66;">shard</span>[<span style="color: #cccccc; background-color: #2d2d2d;">0</span>] . <span style="color: #66cccc;">':'</span> .<span style="text-decoration: underline;"> $</span><span style="color: #ffcc66; text-decoration: underline;">shard</span><span style="text-decoration: underline;">[</span><span style="color: #cccccc; background-color: #2d2d2d; text-decoration: underline;">1</span><span style="text-decoration: underline;">] . </span><span style="color: #66cccc; text-decoration: underline;">':'</span><span style="text-decoration: underline;"> .$</span><span style="color: #ffcc66; text-decoration: underline;">shard</span><span style="text-decoration: underline;">[</span><span style="color: #cccccc; background-color: #2d2d2d; text-decoration: underline;">2</span><span style="text-decoration: underline;">], </span><span style="color: #6699cc; text-decoration: underline;">E_USER_ERROR</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">return</span> <span style="color: #6699cc;">false</span>;
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   }
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   $<span style="color: #6699cc;">this</span>-&gt;<span style="color: #ffcc66;">shard</span>[<span style="color: #cccccc; background-color: #2d2d2d;">2</span>] = $<span style="color: #ffcc66;">shard</span>[<span style="color: #cccccc; background-color: #2d2d2d;">2</span>];
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   }
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">return</span> $<span style="color: #6699cc;">this</span>-&gt;<span style="color: #ffcc66;">shard</span>[<span style="color: #66cccc;">'redis'</span>];
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   }
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   $<span style="color: #6699cc;">this</span>-&gt;<span style="color: #ffcc66;">shard</span>[<span style="color: #66cccc;">'redis'</span>]-&gt;<span style="color: #cccccc; background-color: #2d2d2d;">close</span>();
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #cccccc; background-color: #2d2d2d;">unset(</span>$<span style="color: #6699cc;">this</span>-&gt;<span style="color: #ffcc66;">shard</span>);
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   }
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #999999; font-style: italic;">//</span><span style="color: #999999; font-style: italic;">&#26032;&#24314;&#36830;&#25509;.</span>
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   $<span style="color: #ffcc66;">shard</span>[<span style="color: #66cccc;">'redis'</span>] = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">Redis</span>();
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">if</span>(! $<span style="color: #ffcc66;">shard</span>[<span style="color: #66cccc;">'redis'</span>]-&gt;<span style="color: #cccccc; background-color: #2d2d2d;">connect</span>($<span style="color: #ffcc66;">shard</span>[<span style="color: #cccccc; background-color: #2d2d2d;">0</span>], $<span style="color: #ffcc66;">shard</span>[<span style="color: #cccccc; background-color: #2d2d2d;">1</span>])){
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #cccccc; background-color: #2d2d2d;">trigger_error(</span><span style="color: #66cccc;">'redis error: connect '</span> . $<span style="color: #ffcc66;">shard</span>[<span style="color: #cccccc; background-color: #2d2d2d;">0</span>] . <span style="color: #66cccc;">':'</span> . $<span style="color: #ffcc66;">shard</span>[<span style="color: #cccccc; background-color: #2d2d2d;">1</span>],<span style="text-decoration: underline;"> </span><span style="color: #6699cc; text-decoration: underline;">E_USER_ERROR</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">return</span> <span style="color: #6699cc;">false</span>;
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   }
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   $<span style="color: #ffcc66;">db</span> = <span style="color: #cccccc; background-color: #2d2d2d;">intval(</span>$<span style="color: #ffcc66;">shard</span>[<span style="color: #cccccc; background-color: #2d2d2d;">2</span>]);
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">if</span>($<span style="color: #ffcc66;">db</span> != <span style="color: #cccccc; background-color: #2d2d2d;">0</span> <span style="color: #99cc99;">and</span> !$<span style="color: #ffcc66;">shard</span>[<span style="color: #66cccc;">'redis'</span>]-&gt;<span style="color: #cccccc; background-color: #2d2d2d;">select</span>($<span style="color: #ffcc66;">db</span>)){
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #cccccc; background-color: #2d2d2d;">trigger_error(</span><span style="color: #66cccc;">'redis error: select '</span> . $<span style="color: #ffcc66;">shard</span>[<span style="color: #cccccc; background-color: #2d2d2d;">0</span>] . <span style="color: #66cccc;">':'</span> . $<span style="color: #ffcc66;">shard</span>[<span style="color: #cccccc; background-color: #2d2d2d;">1</span>] .<span style="text-decoration: underline;"> </span><span style="color: #66cccc; text-decoration: underline;">':'</span><span style="text-decoration: underline;"> .$</span><span style="color: #ffcc66; text-decoration: underline;">shard</span><span style="text-decoration: underline;">[</span><span style="color: #cccccc; background-color: #2d2d2d; text-decoration: underline;">2</span><span style="text-decoration: underline;">], </span><span style="color: #6699cc; text-decoration: underline;">E_USER_ERROR</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   $<span style="color: #ffcc66;">shard</span>[<span style="color: #66cccc;">'redis'</span>]-&gt;<span style="color: #cccccc; background-color: #2d2d2d;">close</span>();
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">return</span> <span style="color: #6699cc;">false</span>;
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   }
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">if</span>(<span style="color: #f2777a; font-weight: bold;">ENABLE_DEVELOP</span>){
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #cccccc; background-color: #2d2d2d;">trigger_error(</span><span style="color: #66cccc;">'redis connect success. '</span> . $<span style="color: #ffcc66;">shard</span>[<span style="color: #cccccc; background-color: #2d2d2d;">0</span>] . <span style="color: #66cccc;">':'</span> . $<span style="color: #ffcc66;">shard</span>[<span style="color: #cccccc; background-color: #2d2d2d;">1</span><span style="text-decoration: underline;">] . </span><span style="color: #66cccc; text-decoration: underline;">':'</span><span style="text-decoration: underline;"> . $</span><span style="color: #ffcc66; text-decoration: underline;">shard</span><span style="text-decoration: underline;">[</span><span style="color: #cccccc; background-color: #2d2d2d; text-decoration: underline;">2</span><span style="text-decoration: underline;">], </span><span style="color: #6699cc; text-decoration: underline;">E_USER_NOTICE</span><span style="text-decoration: underline;">);</span>
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   }<span style="color: #f2777a; background-color: #515151;">        </span>
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   $<span style="color: #6699cc;">this</span>-&gt;<span style="color: #ffcc66;">shard</span> = $<span style="color: #ffcc66;">shard</span>;
<span style="background-color: #515151;"> </span>   <span style="background-color: #515151;"> </span>   <span style="color: #99cc99;">return</span> $<span style="color: #6699cc;">this</span>-&gt;<span style="color: #ffcc66;">shard</span>[<span style="color: #66cccc;">'redis'</span>];
<span style="background-color: #515151;"> </span>   }
}
</pre>
</div>
</div>
</div>
]]></content:encoded>
        </item>
    </channel>
</rss>