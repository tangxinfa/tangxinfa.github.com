<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>jabber - 看看俺 – KanKanAn.com</title>
        <description>记我所思，忆我所为。</description>
        <link>http://blog.kankanan.com/tag/jabber.xml</link>
        <lastBuildDate>Sun, 21 Feb 2016 05:15:59 GMT</lastBuildDate>
        <docs>http://blogs.law.harvard.edu/tech/rss</docs>
        <image>
            <title>jabber - 看看俺 – KanKanAn.com</title>
            <url>http://blog.kankanan.com/static/favicon.ico</url>
            <link>http://blog.kankanan.com/tag/jabber.xml</link>
        </image>
        <copyright>版权所有 © 2011-2015 看看俺 – KanKanAn.com</copyright>
        <generator>Feed for Node.js</generator>
        <category>技术</category>
        <item>
            <title><![CDATA[搭建jabber服务器]]></title>
            <link>/article/642d5efa-jabber-670d52a15668.html</link>
            <guid>/article/642d5efa-jabber-670d52a15668.html</guid>
            <pubDate>Tue, 03 May 2011 16:32:00 GMT</pubDate>
            <content:encoded><![CDATA[<ul class="org-ul">
<li>编译安装

<p>
<code>下载</code>
</p>
<div class="org-src-container">

<pre class="src src-sh">wget http://download.jabberd.org/jabberd14/jabberd14-1.6.1.1.tar.gz
tar xzvf jabberd14-1.6.1.1.tar.gz
<span style="color: #cc99cc;">cd</span> jabberd14-1.6.1.1
</pre>
</div>

<p>
<code>修改代码以解决编译错误</code>
</p>
<div class="org-src-container">

<pre class="src src-sh">diff -r jabberd14-1.6.1.1/jabberd/lib/xmlnode.cc tmp/jabberd14-1.6.1.1/jabberd/l<span style="text-decoration: underline;">ib/xmlnode.cc</span>
882,884c882,884
&lt;     const char *next_step = NULL;
&lt;     const char *start_predicate = NULL;
&lt;     const char *end_predicate = NULL;
---
&gt;     char *next_step = NULL;
&gt;     char *start_predicate = NULL;
&gt;     char *end_predicate = NULL;
1836c1836
&lt;         ((char*)strchr(lang, <span style="color: #66cccc;">'-'</span>))[0] = 0;
---
&gt;         strchr(lang, <span style="color: #66cccc;">'-'</span>)[0] = 0;
diff -r jabberd14-1.6.1.1/jabberd/log.cc tmp/jabberd14-1.6.1.1/jabberd/log.cc
89c89
&lt;         pos = (char*)strchr(zone,<span style="color: #66cccc;">'.'</span>);
---
&gt;     pos = strchr(zone,<span style="color: #66cccc;">'.'</span>);
diff -r jabberd14-1.6.1.1/jabberd/mio_tls.cc tmp/jabberd14-1.6.1.1/jabberd/mio_t<span style="text-decoration: underline;">ls.cc</span>
615c615
&lt;         ret = gnutls_certificate_set_openpgp_key_file(current_credentials, pub<span style="text-decoration: underline;">file, privfile, GNUTLS_OPENPGP_FMT_BASE64);</span>
---
&gt;         ret = gnutls_certificate_set_openpgp_key_file(current_credentials, pub<span style="text-decoration: underline;">file, privfile);</span>
634c634
&lt;         ret = gnutls_certificate_set_openpgp_keyring_file(current_credentials,<span style="text-decoration: underline;"> file, GNUTLS_OPENPGP_FMT_BASE64);</span>
---
&gt;         ret = gnutls_certificate_set_openpgp_keyring_file(current_credentials,<span style="text-decoration: underline;"> file);</span>
640a641,657
&gt;     }
&gt;
&gt;     // load GnuPG trustdb
&gt;     if (j_strcmp(xmlnode_get_localname(cur), <span style="color: #66cccc;">"trustdb"</span>) == 0) {
&gt;         char const *const file = xmlnode_get_data(cur);
&gt;
&gt;         if (file == NULL) {
&gt;         log_warn(NULL, <span style="color: #66cccc;">"Initializing TLS subsystem: &lt;trustdb/&gt; element inside </span><span style="color: #66cccc; text-decoration: underline;">the TLS configuration, that does not contain a file-name."</span><span style="text-decoration: underline;">);</span>
&gt;         continue;
&gt;         }
&gt;
&gt;         // load the GnuPG trustdb
&gt;         ret = gnutls_certificate_set_openpgp_trustdb(current_credentials, file<span style="text-decoration: underline;">);</span>
&gt;         if (ret &lt; 0) {
&gt;         log_error(NULL, <span style="color: #66cccc;">"Error loading GnuPG trustdb %s: %s"</span>, file, gnutls_str<span style="text-decoration: underline;">error(ret));</span>
&gt;         continue;
&gt;         }
</pre>
</div>

<p>
<code>编译安装</code>
</p>
<div class="org-src-container">

<pre class="src src-sh">./configure &amp;&amp; make &amp;&amp; sudo make install
</pre>
</div>

<p>
如出错通常是少了相关依赖库，用包管理工具（如：ubuntu下的新立得）安装即可。
</p>
</li>

<li>配置

<p>
按照mysql.sql中的注释配置数据库：
</p>

<div class="org-src-container">

<pre class="src src-sh">mysql -uroot -p
mysql&gt; CREATE DATABASE jabber CHARACTER SET utf8;
mysql&gt; use jabber;
mysql&gt; grant all on jabber.* to jabber@localhost identified by <span style="color: #66cccc;">'secret'</span>;
mysql&gt; <span style="color: #66cccc;">\.</span> mysql.sql
</pre>
</div>
</li>

<li>运行

<div class="org-src-container">

<pre class="src src-sh">sudo jabberd -h localhost -B
</pre>
</div>
</li>

<li>注册用户1

<div class="org-src-container">

<pre class="src src-sh">telnet localhost 5222
&lt;stream:stream
<span style="background-color: #515151;"> </span> <span style="color: #ffcc66;">to</span>=<span style="color: #66cccc;">'localhost'</span>
<span style="background-color: #515151;"> </span> <span style="color: #ffcc66;">xmlns</span>=<span style="color: #66cccc;">'jabber:client'</span>
<span style="background-color: #515151;"> </span> xmlns:<span style="color: #ffcc66;">stream</span>=<span style="color: #66cccc;">'http://etherx.jabber.org/streams'</span>&gt;

&lt;iq <span style="color: #ffcc66;">id</span>=<span style="color: #66cccc;">'reg1'</span> <span style="color: #ffcc66;">type</span>=<span style="color: #66cccc;">'set'</span>&gt;
<span style="background-color: #515151;"> </span> &lt;query <span style="color: #ffcc66;">xmlns</span>=<span style="color: #66cccc;">'jabber:iq:register'</span>&gt;
<span style="background-color: #515151;"> </span>   &lt;username&gt;jack&lt;/username&gt;
<span style="background-color: #515151;"> </span>   &lt;password&gt;jack&lt;/password&gt;
<span style="background-color: #515151;"> </span>   &lt;name&gt;jack&lt;/name&gt;
<span style="background-color: #515151;"> </span>   &lt;email&gt;&lt;/email&gt;
<span style="background-color: #515151;"> </span> &lt;/query&gt;
&lt;/iq&gt;

&lt;/stream:stream&gt;
</pre>
</div>
</li>

<li>登录用户1

<pre class="example">
Empathy菜单-&gt;编辑-&gt;帐户-&gt;添加：
协议: Jabber
登录ID: jack@localhost
记住密码
密码: jack
登录
</pre>
</li>

<li>注册用户2

<div class="org-src-container">

<pre class="src src-sh">telnet localhost 5222
&lt;stream:stream
<span style="background-color: #515151;"> </span> <span style="color: #ffcc66;">to</span>=<span style="color: #66cccc;">'localhost'</span>
<span style="background-color: #515151;"> </span> <span style="color: #ffcc66;">xmlns</span>=<span style="color: #66cccc;">'jabber:client'</span>
<span style="background-color: #515151;"> </span> xmlns:<span style="color: #ffcc66;">stream</span>=<span style="color: #66cccc;">'http://etherx.jabber.org/streams'</span>&gt;

&lt;iq <span style="color: #ffcc66;">id</span>=<span style="color: #66cccc;">'reg1'</span> <span style="color: #ffcc66;">type</span>=<span style="color: #66cccc;">'set'</span>&gt;
<span style="background-color: #515151;"> </span> &lt;query <span style="color: #ffcc66;">xmlns</span>=<span style="color: #66cccc;">'jabber:iq:register'</span>&gt;
<span style="background-color: #515151;"> </span>   &lt;username&gt;rose&lt;/username&gt;
<span style="background-color: #515151;"> </span>   &lt;password&gt;rose&lt;/password&gt;
<span style="background-color: #515151;"> </span>   &lt;name&gt;rose&lt;/name&gt;
<span style="background-color: #515151;"> </span>   &lt;email&gt;&lt;/email&gt;
<span style="background-color: #515151;"> </span> &lt;/query&gt;
&lt;/iq&gt;

&lt;/stream:stream&gt;
</pre>
</div>
</li>

<li>用户1加用户2为联系人

<pre class="example">
Empathy菜单-&gt;聊天-&gt;添加联系人:
帐户：jack@localhost
标识符: rose@localhost
添加
</pre>
</li>

<li>登录用户2，并发一个消息给用户1

<div class="org-src-container">

<pre class="src src-sh">telnet localhost 5222
&lt;stream:stream
<span style="background-color: #515151;"> </span> <span style="color: #ffcc66;">to</span>=<span style="color: #66cccc;">'localhost'</span>
<span style="background-color: #515151;"> </span> <span style="color: #ffcc66;">xmlns</span>=<span style="color: #66cccc;">'jabber:client'</span>
<span style="background-color: #515151;"> </span> xmlns:<span style="color: #ffcc66;">stream</span>=<span style="color: #66cccc;">'http://etherx.jabber.org/streams'</span>&gt;

&lt;iq <span style="color: #ffcc66;">id</span>=<span style="color: #66cccc;">'auth1'</span> <span style="color: #ffcc66;">type</span>=<span style="color: #66cccc;">'set'</span>&gt;
<span style="background-color: #515151;"> </span> &lt;query <span style="color: #ffcc66;">xmlns</span>=<span style="color: #66cccc;">'jabber:iq:auth'</span>&gt;
<span style="background-color: #515151;"> </span>   &lt;username&gt;rose&lt;/username&gt;
<span style="background-color: #515151;"> </span>   &lt;password&gt;rose&lt;/password&gt;
<span style="background-color: #515151;"> </span>   &lt;resource&gt;test&lt;/resource&gt;
<span style="background-color: #515151;"> </span> &lt;/query&gt;
&lt;/iq&gt;

&lt;presence/&gt;

&lt;message <span style="color: #ffcc66;">to</span>=<span style="color: #66cccc;">'jack@localhost'</span>&gt;
<span style="background-color: #515151;"> </span> &lt;body&gt;hello, jack&lt;/body&gt;
&lt;/message&gt;

&lt;/stream:stream&gt;
</pre>
</div>
</li>
</ul>
]]></content:encoded>
        </item>
    </channel>
</rss>