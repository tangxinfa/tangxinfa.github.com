<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-CN" xml:lang="zh-CN">
<head>
<title>当php遇上redis</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<meta name="title" content="当php遇上redis"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2012-12-08"/>
<meta name="author" content=""/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<link rel='stylesheet' type='text/css' href='css/style.css' />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012  Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>

</head>
<body>

<div id="preamble">

</div>

<div id="content">
<h1 class="title">当php遇上redis</h1>


<div class="nav-bar">
<ul>
<li><a href="index.html">Blog</a>
</li>
</ul>


</div>

<p>
在最近的项目中，我们需要在php中访问redis，我们选择了使用<a href="https://github.com/nicolasff/phpredis">phpredis</a>库，下面是遇到的一些问题。
</p>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1">redis持久连接不靠谱。</h2>
<div class="outline-text-2" id="text-1">


<p>
  可以说这是php的通病了，不管是mysql、memcache还是redis，指望由php本身（包含php扩展）来实现持久连接都是行不通的。
</p>
<dl>
<dt>为什么这么说呢？</dt><dd>
<p>
    首先，所谓的持久连接的实现不外乎在进程（php-fpm）内建一个连接池，当新建连接时从池中以ip+port等信息为key从池中查找，有则重用没有则新建连接。而当一个请求执行结束时，不关闭连接，而是把连接放回池中。这样当redis有很实例时，一个进程就会持久多个连接，由于一个进程同一时刻只能处理一个请求，所以打开持久连接可能会导致redis无连接可用。
</p>
<p>
    举个例子：一个web应用开了1000个php-fpm进程，有10个redis实例，业务使用hash的方法将数据分布在10个实例上，那么最坏的情况下，每个php-fpm进程会持有每个redis实例的一个连接，1000*10就是10000，如果前端或redis再扩容所需要的连接就会以乘积方式增加。一个redis实例有php-fpm进程数个连接的情况下表现如何呢，这就要好好测一测了，反正是每连接一线程的mysql是直接堵死了。
</p></dd>
</dl>


</div>

</div>

<div id="outline-container-2" class="outline-2">
<h2 id="sec-2">RedisArray不靠谱。</h2>
<div class="outline-text-2" id="text-2">

<p>  RedisArray实现了一致性hash分布式，但是它在初始化的时候就会连接上每个实例，这在web应用中简直是胡闹，它对一致性hash实现得比较完善，结点失效、动态添加结点时重新hash都有处理，在万不得已进行水平扩容时，可能会用得上。
</p>
</div>

</div>

<div id="outline-container-3" class="outline-2">
<h2 id="sec-3">需要自已关闭redis连接。</h2>
<div class="outline-text-2" id="text-3">

<p>  Redis的析构函数没有关闭redis连接，这会导致redis网络负载过高，要确保脚本结束时关闭连接，最好是能够封装一下Redis类再使用。
</p>
<dl>
<dt>示例封装</dt><dd>
</dd>
</dl>




<pre class="src src-php">/// &#20998;&#24067;&#24335;Redis.
class RedisShard {
    public function __construct($shards) {
        $this-&gt;shards = array();
        foreach($shards as $shard){
            $this-&gt;shards[] = explode(':', $shard); //&#26684;&#24335;&#65306;host:port:db
        }
    }

    /// &#26512;&#26500;&#20989;&#25968;.
    /// &#33050;&#26412;&#32467;&#26463;&#26102;&#65292;phpredis&#19981;&#20250;&#33258;&#21160;&#20851;&#38381;redis&#36830;&#25509;&#65292;&#36825;&#37324;&#28155;&#21152;&#33258;&#21160;&#20851;&#38381;&#36830;&#25509;&#25903;&#25345;.
    /// &#21487;&#20197;&#36890;&#36807;&#25163;&#21160;unset&#26412;&#31867;&#23545;&#35937;&#24555;&#36895;&#37322;&#25918;&#36164;&#28304;.
    public function __destruct() {
        if(isset($this-&gt;shard)){
            $this-&gt;shard['redis']-&gt;close();
        }
    }

    /// &#36716;&#21457;&#26041;&#27861;&#35843;&#29992;&#21040;&#30495;&#27491;&#30340;redis&#23545;&#35937;.
    public function __call($name, $arguments) {
        $result = call_user_func_array(array($this-&gt;redis($arguments[0]), $name), $arguments);
        if($result === false and in_array($name, array('set', 'setex', 'incr'))) {
            trigger_error(<span style="font-style: italic;">"redis error: $name "</span> . implode(' ', $arguments), E_USER_NOTICE);
        }
        return $result;
    }

    /// &#33719;&#21462;key&#23545;&#24212;&#30340;redis&#23545;&#35937;.
    private function redis($key){
        //TODO: crc32&#22312;32&#20301;&#31995;&#32479;&#19979;&#20250;&#36820;&#22238;&#36127;&#25968;&#65292;&#22240;&#25105;&#20204;&#26159;&#37096;&#32626;&#22312;64&#20301;&#31995;&#32479;&#19978;&#65292;&#26242;&#26102;&#24573;&#30053;.
        assert(PHP_INT_SIZE === 8);
        $index = crc32($key) % count($this-&gt;shards);
        $shard = $this-&gt;shards[$index];
        if(isset($this-&gt;shard)){
            //&#23581;&#35797;&#37325;&#29992;&#24050;&#26377;&#36830;&#25509;.
            if($this-&gt;shard[0] == $shard[0] and $this-&gt;shard[1] == $shard[1]){
                if($this-&gt;shard[2] != $shard[2]){
                    if(! $this-&gt;shard['redis']-&gt;select($shard[2])){
                        return false;
                    }
                    $this-&gt;shard[2] = $shard[2];
                    return $this-&gt;shard['redis'];
                }
            }
            $this-&gt;shard['redis']-&gt;close();
            unset($this-&gt;shard);
        }
        //&#26032;&#24314;&#36830;&#25509;.
        $shard['redis'] = new Redis();
        if(! $shard['redis']-&gt;connect($shard[0], $shard[1])){
            trigger_error('redis error: connect ' . $shard[0] . ':' . $shard[1], E_USER_NOTICE);
            return false;
        }
        $db = intval($shard[2]);
        if($db != 0 and !$shard['redis']-&gt;select($db)){
            trigger_error('redis error: select ' . $shard[0] . ':' . $shard[1] . ':' .$shard[2], E_USER_NOTICE);
            $shard['redis']-&gt;close();
            return false;
        }
        $this-&gt;shard = $shard;
        return $this-&gt;shard['redis'];
    }
}
</pre>


        <div class="comment_header">评论</div>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = 'kankananblog';
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        <div style="display:none;">
        <script type="text/javascript">
            var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Faa06d8a31344740ac23cbe6cf3d9f23e' type='text/javascript'%3E%3C/script%3E"));
        </script>
        </div>
</div>
</div>
</div>

<div id="postamble">
<p class="date">&#26085;&#26399;: 2012-12-08</p>
<p class="author">&#20316;&#32773;: </p>
<p class="creator"><a href="http://orgmode.org">Org</a> version 7.9.2 with <a href="http://www.gnu.org/software/emacs/">Emacs</a> version 24</p>
<a href="http://validator.w3.org/check?uri=referer">Validate XHTML 1.0</a>

</div>
</body>
</html>
