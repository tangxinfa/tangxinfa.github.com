<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8"/>
    <title>使用 NDK 移植 Linux C/C++ 程序到 Android 系统 | 看看俺 – KanKanAn.com</title>
    <link rel="shortcut icon" href="/static/favicon.ico" />
    <link rel="stylesheet" type="text/css" href="/style/ediary.css"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="generator" content="o-blog"/>
  </head>
  <body>
    <div class="navbar navbar-fixed-top" id="header">
      <div class="navbar-inner">
        <a class="brand" href="/" style="line-height:100%;">看看俺 – KanKanAn.com</a>
        <ul class="navbar-links">
          <li><a href="/index.xml"><i class="icon-rss icon-white"></i> 订阅</a></li>
          
          <li><a href="/index.html"><i class="icon-folder-close icon-white"></i> 技术</a></li>
          <li><a href="/category/life/0.html"><i class="icon-folder-close icon-white"></i> 生活</a></li>
        </ul>
      </div>
    </div>

    <div class="container container-fluid" id="page">
      <div class="push-header"></div>

      <div class="article">
        <header class="article-header">
          <h1>使用 NDK 移植 Linux C/C++ 程序到 Android 系统</h1>
        </header>
      
        <div class="article-content">
          
<div id="outline-container-orgabcf354" class="outline-2">
<h2 id="orgabcf354">区分基础概念：JNI 与 NDK</h2>
<div class="outline-text-2" id="text-orgabcf354">
<ul class="org-ul">
<li>JNI（Java Native Interface）是一种 Java 语言特性</li>
</ul>

<p>
用于 Java 程序与 C、C++ 库间的互相调用。
</p>

<ul class="org-ul">
<li>NDK（Native Development Kit）是 Google 提供的使用 C/C++ 编写 Android 程序的开
发工具包</li>
</ul>

<p>
它使用 JNI 实现 Java 程序调用 C/C++ 本地代码，允许 C/C++ 本地代码访问 Android
API，不只是用来开发或移植 C/C++ 库，也可以是 C/C++ 程序。
</p>

<p>
引用自 <a href="https://developer.android.com/ndk/">Android NDK  |  Android NDK  |  Android Developers</a>
</p>
<blockquote>
<p>
Android NDK
</p>

<p>
The Android NDK is a toolset that lets you implement parts of your app in native
code, using languages such as C and C++. For certain types of apps, this can
help you reuse code libraries written in those languages.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-orga133842" class="outline-2">
<h2 id="orga133842">NDK 交叉编译工具链适用于使用 GNU Autotools 进行构建的项目</h2>
<div class="outline-text-2" id="text-orga133842">
<p>
NDK 自带完整的交叉编译工具链，可以直接将使用 GNU Autotools 构建的一些开源库移植
到 Android 平台，这样可以省去自已去写 Android.mk 编译脚本。
</p>

<p>
通常只需要先设置以下环境变量：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b294bb;">export</span> <span style="color: #f0c674;">PATH</span>=$<span style="color: #f0c674;">PATH</span>:/opt/android-toolchain/bin
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">CC</span>=aarch64-linux-android-clang
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">CXX</span>=aarch64-linux-android-clang++
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">LD</span>=aarch64-linux-android-ld
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">AR</span>=aarch64-linux-android-ar
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">STRIP</span>=aarch64-linux-android-strip
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">RANLIB</span>=aarch64-linux-android-ranlib
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">AS</span>=aarch64-linux-android-clang
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">CFLAGS</span>=<span style="color: #8abeb7;">"-fPIE -fPIC"</span>
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">LDFLAGS</span>=<span style="color: #8abeb7;">"-pie"</span>
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">SYSROOT</span>=/opt/android-toolchain/sysroot
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">CROSS_COMPILE_HOST</span>=aarch64-linux-android
</pre>
</div>

<p>
然后在执行 <code>./configure</code> 时指定 <code>--host=${CROSS_COMPILE_HOST}</code> 选项即可编译成功。
</p>
</div>
</div>

<div id="outline-container-org0be3a78" class="outline-2">
<h2 id="org0be3a78">NDK 的局限性</h2>
<div class="outline-text-2" id="text-org0be3a78">
<p>
NDK 提供一系列稳定的 C/C++ API，头文件在 <code>sysroot/usr/include</code> 下，主要包括 C 标
准库、C++ 标准库、jni、math、pthread、zlib、OpenGL、Android 相关的库。随着时间的推
移 <a href="https://developer.android.com/ndk/guides/stable_apis">NDK 支持的 API</a> 也在增加。
</p>

<p>
除了支持 Android 开发之外，NDK 开发环境只是嵌入式 Linux 开发环境的一个子集，这可
能是因为 Android 安全沙箱需要、GPL 版权限制。
</p>

<ul class="org-ul">
<li>没有使用 <code>glibc</code></li>
</ul>

<p>
<code>glibc</code> 是 Linux 下的 C 标准库实现，除了实现 <code>ANSI C</code> 标准库还有大量方便 Linux
开发的扩展功能。而 NDK 提供的 C 标准库并非 <code>glibc</code> 。这导致移植 Nginx 时由于缺少
<code>crypt.h</code> 头文件而编译不过。如果强行将 <code>glibc</code> 之类的东西也移植过来我估计后面也
很难打包成 APK 从而正常地进行安装、升级。
</p>

<p>
NDK 将在未来的版本中移除 <code>gcc</code> 而只支持 <code>clang</code> ，已知 Standalone 工具链中使用
<code>gcc</code> 会 <a href="https://github.com/android-ndk/ndk/issues/215">出现编译错误</a>：
</p>
<blockquote>
<p>
cstddef:43:25: fatal error: stddef.h: No such file or directory
</p>
</blockquote>
<p>
初步使用 <code>clang</code> 移植了一些库（如 <a href="https://sourceforge.net/projects/pcre/">pcre</a> ）是没有问题的。
</p>
</div>
</div>

<div id="outline-container-org5a9a189" class="outline-2">
<h2 id="org5a9a189">结论</h2>
<div class="outline-text-2" id="text-org5a9a189">
<p>
一般的 C/C++ 库通常本身就会注重可移植性，不会生硬地依赖系统底层特性，使用 NDK
移植是可行的，即使是 <code>ffmpeg</code> 这种大型的库也可以成功移植到 Android。
</p>

<p>
而对于一些 Linux 下的程序，使用 NDK 直接移植会有很大的失败机率，因为他们可能
使用了 NDK 不支持的特性（如 <code>glibc</code> ），应该采用和 Android 源代码一起编译的方
式，这样可以使用 NDK 不支持的特性。
</p>
</div>
</div>

<div id="outline-container-org7b4254f" class="outline-2">
<h2 id="org7b4254f">参考</h2>
<div class="outline-text-2" id="text-org7b4254f">
<ul class="org-ul">
<li><a href="https://developer.android.com/ndk/guides/concepts">Concepts  |  Android NDK  |  Android Developers</a></li>

<li><a href="http://www.jkeabc.com/475203.html">Android NDK vs AOSP Build System</a></li>

<li><a href="https://developer.android.com/ndk/guides/stable_apis">Android NDK Native APIs  |  Android NDK  |  Android Developers</a></li>

<li><a href="https://software.intel.com/en-us/articles/building-an-android-command-line-application-using-the-ndk-build-tools">Building an Android* Command-Line Application Using the NDK Build Tools | Intel® Software</a></li>

<li><a href="https://www.jianshu.com/p/6332418b12b1">Android NDK开发扫盲及最新CMake的编译使用 - 简书</a></li>

<li><a href="https://blog.csdn.net/minghuang2017/article/details/78938852">在命令行下用cmake交叉编译可在android中运行的so包 - CSDN博客</a></li>

<li><a href="https://blog.csdn.net/minghuang2017/article/details/79000345">cmake使用独立工具链交叉编译可在android中运行的so包 - CSDN博客</a></li>

<li><a href="https://warpedtimes.wordpress.com/2010/02/03/building-open-source-libraries-with-android-ndk/">Building Open Source libraries with Android NDK | Thoughts and Ideas In Warped Times</a></li>
</ul>
</div>
</div>

        </div>
        <br />
        <footer class="article-footer">
          <span class="muted">
            <i class="icon-time icon-white"></i> <time datetime="2018-08-09T15:28:00+0800">2018年8月9日 15时</time>
          </span>
          <a class="tag" href="/tag/android/0.html"><i class="icon-tag icon-white"></i> android</a>
        </footer>
      </div>

<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'kankananblog';

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

      <div class="push-footer"></div>
    </div>

    <div id="footer">
  	  <div class="copyright" style="text-align: center;">
  	    版权所有 © 2011-2015 看看俺 – KanKanAn.com
  	    <p>Powered by <a href="https://github.com/tangxinfa/ediary">ediary</a>.</p>
  	  </div>
    </div>
  </body>
</html>
