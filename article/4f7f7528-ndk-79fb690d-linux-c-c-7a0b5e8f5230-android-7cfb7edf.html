<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8"/>
    <title>使用 NDK 移植 Linux C/C++ 程序到 Android 系统 | 看看俺 – KanKanAn.com</title>
    <link rel="shortcut icon" href="/static/favicon.ico" />
    <link rel="stylesheet" type="text/css" href="/style/ediary.css"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="generator" content="o-blog"/>
  </head>
  <body>
    <div class="navbar navbar-fixed-top" id="header">
      <div class="navbar-inner">
        <a class="brand" href="/" style="line-height:100%;">看看俺 – KanKanAn.com</a>
        <ul class="navbar-links">
          <li><a href="/index.xml"><i class="icon-rss icon-white"></i> 订阅</a></li>
          
          <li><a href="/index.html"><i class="icon-folder-close icon-white"></i> 技术</a></li>
          <li><a href="/category/life/0.html"><i class="icon-folder-close icon-white"></i> 生活</a></li>
        </ul>
      </div>
    </div>

    <div class="container container-fluid" id="page">
      <div class="push-header"></div>

      <div class="article">
        <header class="article-header">
          <h1>使用 NDK 移植 Linux C/C++ 程序到 Android 系统</h1>
        </header>
      
        <div class="article-content">
          
<div id="outline-container-org23ccf60" class="outline-2">
<h2 id="org23ccf60">区分基础概念：JNI 与 NDK</h2>
<div class="outline-text-2" id="text-org23ccf60">
<ul class="org-ul">
<li>JNI（Java Native Interface）是一种 Java 语言特性</li>
</ul>

<p>
用于 Java 程序与 C、C++ 库间的互相调用。
</p>

<ul class="org-ul">
<li>NDK（Native Development Kit）是 Google 提供的使用 C/C++ 编写 Android 程序的开
发工具包</li>
</ul>

<p>
它使用 JNI 实现 Java 程序调用 C/C++ 本地代码，允许 C/C++ 本地代码访问 Android
API，不只是用来开发或移植 C/C++ 库，也可以是 C/C++ 程序。
</p>

<p>
引用自 <a href="https://developer.android.com/ndk/">Android NDK  |  Android NDK  |  Android Developers</a>
</p>
<blockquote>
<p>
Android NDK
</p>

<p>
The Android NDK is a toolset that lets you implement parts of your app in native
code, using languages such as C and C++. For certain types of apps, this can
help you reuse code libraries written in those languages.
</p>
</blockquote>

<p>
NDK 提供一系列稳定的 C/C++ API，头文件在 <code>sysroot/usr/include</code> 下，主要包括 C 标
准库、C++ 标准库、jni、math、pthread、zlib、OpenGL、Android 相关的库，
<a href="https://developer.android.com/ndk/guides/stable_apis">NDK 支持的 API</a> 也会随着需求的增加而日趋完善。
</p>
</div>
</div>


<div id="outline-container-org2d91a23" class="outline-2">
<h2 id="org2d91a23">移植使用 GNU Autotools 的项目</h2>
<div class="outline-text-2" id="text-org2d91a23">
<p>
NDK 提供了创建独立工具链的工具，对于移植使用 GNU Autotools 的项目到 Android 平台
很有帮助，省去写 <code>Android.mk</code> 。
</p>

<ul class="org-ul">
<li><p>
创建独立工具链
</p>

<div class="org-src-container">
<pre class="src src-sh">/opt/android-ndk/build/tools/make_standalone_toolchain.py <span style="color: #8abeb7;">\</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   --arch arm64 --api 28 --stl=libc++ --install-dir /opt/android-toolchain
</pre>
</div></li>

<li><p>
环境变量配置
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b294bb;">export</span> <span style="color: #f0c674;">PATH</span>=$<span style="color: #f0c674;">PATH</span>:/opt/android-toolchain/bin
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">CC</span>=aarch64-linux-android-clang
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">CXX</span>=aarch64-linux-android-clang++
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">LD</span>=aarch64-linux-android-ld
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">AR</span>=aarch64-linux-android-ar
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">STRIP</span>=aarch64-linux-android-strip
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">RANLIB</span>=aarch64-linux-android-ranlib
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">AS</span>=aarch64-linux-android-clang
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">CFLAGS</span>=<span style="color: #8abeb7;">"-fPIE -fPIC"</span>
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">CXXFLAGS</span>=<span style="color: #8abeb7;">"-fPIE -fPIC"</span>
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">LDFLAGS</span>=<span style="color: #8abeb7;">"-pie"</span>
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">SYSROOT</span>=/opt/android-toolchain/sysroot
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">CROSS_COMPILE_HOST</span>=aarch64-linux-android
</pre>
</div></li>

<li><p>
交叉编译
</p>

<div class="org-src-container">
<pre class="src src-sh">./configure --host=${<span style="color: #f0c674;">CROSS_COMPILE_HOST</span>} --prefix=/opt/local
make
make install
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org5640d20" class="outline-2">
<h2 id="org5640d20">移植 Nginx 遇到的问题</h2>
<div class="outline-text-2" id="text-org5640d20">
<ul class="org-ul">
<li><p>
编译出错 <code>cstddef:43:25: fatal error: stddef.h: No such file or directory</code>
</p>

<p>
看起来是 C++ 编译器找不到 C 头文件，是已知问题，在 Standalone 工具链中使用
<code>gcc</code> 就会出现，见
</p>

<p>
<a href="https://github.com/android-ndk/ndk/issues/215">stddef.h: No such file or directory · Issue #215 · android-ndk/ndk</a>
</p>

<p>
改为使用 <code>clang</code> 就好了，以后的 NDK 将彻底移除对 <code>gcc</code> 的支持。
</p></li>

<li><p>
交叉编译 OpenSSL
</p>

<p>
网上有大量的移植文档，基本上是基于 <a href="https://wiki.openssl.org/index.php/Android">OpenSSL Android - OpenSSLWiki</a> ，最大的问题
是使用的 NDK 和 OpenSSL 版本都比较旧，最后主要参考
</p>

<p>
<a href="https://github.com/couchbaselabs/couchbase-lite-libcrypto">couchbaselabs/couchbase-lite-libcrypto: Pre-built OpenSSL libcrypto static libraries</a>
</p>

<p>
移植成功。OpenSSL 的交叉编译需要完整的 NDK 包，最好新开一个 Shell 来编译
OpenSSL，避免为独立工具链设置的环境变量影响到 OpenSSL 的编译。
</p>

<p>
编译过程中会报错 <code>crtbegin_so.o: No such file: No such file or directory</code> ，将
它从工具链中拷到当前目录即可， <code>crtend_so.o</code> 、 <code>crtbegin_dynamic.o</code> 、
<code>crtend_android.o</code> 也进行相同处理，参考
<a href="https://stackoverflow.com/questions/6881164/crtbegin-so-o-missing-for-android-toolchain-custom-build">gcc - crtbegin_so.o missing for android toolchain (custom build) - Stack Overflow</a>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">Download</span>
wget https://codeload.github.com/openssl/openssl/zip/OpenSSL_1_1_0-stable -O ope<span style="text-decoration: underline;">nssl-OpenSSL_1_1_0-stable.zip</span>
unzip openssl-OpenSSL_1_1_0-stable.zip
wget https://raw.githubusercontent.com/couchbaselabs/couchbase-lite-libcrypto/ma<span style="text-decoration: underline;">ster/build-android-setenv.sh -O openssl.setenv</span>
sed -i -e <span style="color: #8abeb7;">'s/^_ANDROID_NDK=/#_ANDROID_NDK=/g'</span> openssl.setenv

<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">Config</span>
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">ANDROID_NDK_ROOT</span>=/opt/android-ndk
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">_ANDROID_TARGET_SELECT</span>=arch-arm64-v8a
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">_ANDROID_NDK</span>=<span style="color: #8abeb7;">"android-ndk"</span>
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">ANDROID_EABI_PREFIX</span>=aarch64-linux-android
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">_ANDROID_EABI</span>=<span style="color: #8abeb7;">"${ANDROID_EABI_PREFIX}-4.9"</span>
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">_ANDROID_ARCH</span>=arch-arm64
<span style="color: #b294bb;">export</span> <span style="color: #f0c674;">_ANDROID_API</span>=<span style="color: #8abeb7;">"android-28"</span>
<span style="color: #b294bb;">source</span> openssl.setenv

<span style="color: #969896; font-style: italic;"># </span><span style="color: #969896; font-style: italic;">Build</span>
<span style="color: #b294bb;">cd</span> openssl-OpenSSL_1_1_0-stable
./Configure dist
./Configure no-ssl2 no-ssl3 no-comp no-hw no-engine --openssldir=/opt/local/ --p<span style="text-decoration: underline;">refix=/opt/local/ linux-generic64 -DB_ENDIAN -B$</span><span style="color: #f0c674; text-decoration: underline;">ANDROID_DEV</span><span style="text-decoration: underline;"> </span><span style="color: #8abeb7; text-decoration: underline;">\</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   -I${<span style="color: #f0c674;">ANDROID_NDK_ROOT</span>}/sysroot/usr/include -I${<span style="color: #f0c674;">ANDROID_NDK_ROOT</span>}/sysr<span style="text-decoration: underline;">oot/usr/include/${</span><span style="color: #f0c674; text-decoration: underline;">ANDROID_EABI_PREFIX</span><span style="text-decoration: underline;">} </span><span style="color: #8abeb7; text-decoration: underline;">\</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   -fPIE -pie -L${<span style="color: #f0c674;">ANDROID_NDK_ROOT</span>}/platforms/${<span style="color: #f0c674;">_ANDROID_API</span>}/${<span style="color: #f0c674;">_ANDROI</span><span style="color: #f0c674; text-decoration: underline;">D_ARCH</span><span style="text-decoration: underline;">}/usr/lib</span>
ln -s ${<span style="color: #f0c674;">SYSROOT</span>}/usr/lib/crtbegin_so.o
ln -s ${<span style="color: #f0c674;">SYSROOT</span>}/usr/lib/crtend_so.o
ln -s ${<span style="color: #f0c674;">SYSROOT</span>}/usr/lib/crtbegin_dynamic.o
ln -s ${<span style="color: #f0c674;">SYSROOT</span>}/usr/lib/crtend_android.o
make -j6
make install
</pre>
</div></li>

<li><p>
交叉编译出的配置检测程序无法直接运行
</p>

<p>
Nginx 没有使用 GNU Autotools，而是有自已的 Configure 脚本，遇到的第一个问题就
是 Nginx 是通过使用编译器编译一个测试程序来获取配置信息，交叉编译出来的程序肯
定是无法在编译机上运行的，一个可靠的办法就是修改 Configure 脚本，改为上传到目
标设备上执行。
</p>

<p>
下面是我写好的一个远程执行脚本 <code>execute</code>
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">!/bin/</span><span style="color: #b5bd68;">bash</span>

<span style="color: #b5bd68;">if</span> [ $<span style="color: #f0c674;">#</span> != 2 ] || ([ $<span style="color: #f0c674;">1</span> != <span style="color: #8abeb7;">"-c"</span> ] &amp;&amp; [ $<span style="color: #f0c674;">1</span> != <span style="color: #8abeb7;">"-f"</span> ]) ; <span style="color: #b5bd68;">then</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b294bb;">echo</span> <span style="color: #8abeb7;">"usage: $0 -&lt;c|f&gt; &lt;cmd|file&gt;"</span> &gt;&gt; /dev/stderr
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">exit</span> 22 <span style="color: #969896; font-style: italic;">#</span><span style="color: #969896; font-style: italic;">Invalid argument</span>
<span style="color: #b5bd68;">fi</span>

<span style="color: #f0c674;">LOG_FILE</span>=/dev/null

<span style="color: #b5bd68;">if</span> [[ <span style="color: #8abeb7;">"$CROSS_COMPILE_HOST"</span> = *<span style="color: #8abeb7;">"android"</span>* ]]; <span style="color: #b5bd68;">then</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   adb connect ${<span style="color: #f0c674;">CROSS_COMPILE_DEVICE_IP</span>} &gt;&gt;$<span style="color: #f0c674;">LOG_FILE</span> 2&gt;&amp;1
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   adb wait-for-device
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   adb root &gt;&gt;$<span style="color: #f0c674;">LOG_FILE</span> 2&gt;&amp;1
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   adb connect ${<span style="color: #f0c674;">CROSS_COMPILE_DEVICE_IP</span>} &gt;&gt;$<span style="color: #f0c674;">LOG_FILE</span> 2&gt;&amp;1
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   adb wait-for-device
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   adb remount &gt;&gt;$<span style="color: #f0c674;">LOG_FILE</span> 2&gt;&amp;1
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   adb connect ${<span style="color: #f0c674;">CROSS_COMPILE_DEVICE_IP</span>} &gt;&gt;$<span style="color: #f0c674;">LOG_FILE</span> 2&gt;&amp;1
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   adb wait-for-device
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> [ $<span style="color: #f0c674;">1</span> == <span style="color: #8abeb7;">"-f"</span> ]; <span style="color: #b5bd68;">then</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">tempfile</span>=<span style="color: #b294bb;">`mktemp -u XXXXXXXX`</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">tempdir</span>=/tmp/cross-compile
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   adb shell mkdir ${<span style="color: #f0c674;">tempdir</span>} &gt;&gt;$<span style="color: #f0c674;">LOG_FILE</span> 2&gt;&amp;1
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   adb push $<span style="color: #f0c674;">2</span> ${<span style="color: #f0c674;">tempdir</span>}/${<span style="color: #f0c674;">tempfile</span>} &gt;&gt;$<span style="color: #f0c674;">LOG_FILE</span> 2&gt;&amp;1
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   adb shell <span style="color: #8abeb7;">"find ${tempdir} -ctime +1 -type f -exec rm {} \; &gt;/dev/null 2</span><span style="color: #8abeb7; text-decoration: underline;">&gt;&amp;1; cd ${tempdir} &amp;&amp; chmod a+x $tempfile &amp;&amp; ./$tempfile"</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">else</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   adb shell $<span style="color: #f0c674;">2</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">fi</span>
<span style="color: #b5bd68;">else</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">if</span> [ $<span style="color: #f0c674;">1</span> == <span style="color: #8abeb7;">"-f"</span> ]; <span style="color: #b5bd68;">then</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">tempfile</span>=<span style="color: #b294bb;">`mktemp -u XXXXXXXX`</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #f0c674;">tempdir</span>=/tmp/cross-compile
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   ssh -o <span style="color: #f0c674;">StrictHostKeyChecking</span>=no root@${<span style="color: #f0c674;">CROSS_COMPILE_DEVICE_IP</span>} mkdir ${<span style="color: #f0c674; text-decoration: underline;">tempdir</span><span style="text-decoration: underline;">} &gt;&gt;$</span><span style="color: #f0c674; text-decoration: underline;">LOG_FILE</span><span style="text-decoration: underline;"> 2&gt;&amp;1</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   scp -o <span style="color: #f0c674;">StrictHostKeyChecking</span>=no $<span style="color: #f0c674;">2</span> root@${<span style="color: #f0c674;">CROSS_COMPILE_DEVICE_IP</span>}:${<span style="color: #f0c674;">tem</span><span style="color: #f0c674; text-decoration: underline;">pdir</span><span style="text-decoration: underline;">}/${</span><span style="color: #f0c674; text-decoration: underline;">tempfile</span><span style="text-decoration: underline;">} &gt;&gt;$</span><span style="color: #f0c674; text-decoration: underline;">LOG_FILE</span><span style="text-decoration: underline;"> 2&gt;&amp;1</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   ssh -o <span style="color: #f0c674;">StrictHostKeyChecking</span>=no root@${<span style="color: #f0c674;">CROSS_COMPILE_DEVICE_IP</span>} <span style="color: #8abeb7;">"find ${</span><span style="color: #8abeb7; text-decoration: underline;">tempdir} -mmin +1 -type f -exec rm {} \; &gt;/dev/null 2&gt;&amp;1; cd ${tempdir} &amp;&amp; chmod a+x $tempfile &amp;&amp; ./$tempfile"</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">else</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #969896; background-color: #22a224a427a7;"> </span>   ssh -o <span style="color: #f0c674;">StrictHostKeyChecking</span>=no root@${<span style="color: #f0c674;">CROSS_COMPILE_DEVICE_IP</span>} $<span style="color: #f0c674;">2</span>
<span style="color: #969896; background-color: #22a224a427a7;"> </span>   <span style="color: #b5bd68;">fi</span>
<span style="color: #b5bd68;">fi</span>
</pre>
</div>

<p>
修改 <code>nginx-1.14.0</code> 的配置脚本，将本地运行测试程序的地方改为远程执行
</p>
<div class="org-src-container">
<pre class="src src-sh">sed -i -e <span style="color: #8abeb7;">'s/\/bin\/sh -c $NGX_AUTOTEST/timeout 10 \/build\/execute -f $NGX_AUTO</span><span style="color: #8abeb7; text-decoration: underline;">TEST/g'</span><span style="text-decoration: underline;"> </span><span style="color: #b294bb; text-decoration: underline;">`find auto -type f`</span>
sed -i -e <span style="color: #8abeb7;">'s/$NGX_AUTOTEST &gt;\/dev\/null/timeout 10 \/build\/execute -f $NGX_AUTO</span><span style="color: #8abeb7; text-decoration: underline;">TEST &gt;\/dev\/null/g'</span><span style="text-decoration: underline;"> </span><span style="color: #b294bb; text-decoration: underline;">`find auto -type f`</span>
sed -i -e <span style="color: #8abeb7;">'s/`$NGX_AUTOTEST`/`timeout 10 \/build\/execute -f $NGX_AUTOTEST`/g'</span> <span style="color: #b294bb;">`</span><span style="color: #b294bb; text-decoration: underline;">find auto -type f`</span>
</pre>
</div>

<p>
运行时需要预先设置环境变量 <code>CROSS_COMPILE_DEVICE_IP</code> 为目标设备 IP，对于嵌入式
Linux 设备，需要使用 <code>ssh-copy-id</code> 命令设置为本机免密码 ssh 登录，对于 Android
设备需要预先 adb 授权通过。
</p></li>

<li><p>
编译时找不到 <code>crypt.h</code>
</p>

<p>
<code>crypt.h</code> 属于 <code>glibc</code> ， <code>glibc</code> 是 Linux 下的 C 标准库实现，除了实现 <code>ANSI
  C</code> 标准库还有大量方便 Linux 开发的扩展功能。而 NDK 提供的 C 标准库并非 <code>glibc</code>
而是 <a href="https://github.com/android/platform_bionic/">Bionic libc</a> ，这导致移植 Nginx 时由于缺少 <code>crypt.h</code> 头文件而编译不过。
</p>

<p>
可以将 <code>crypt</code> 调用替换为 <code>DES_crypt</code>
</p>
<div class="org-src-container">
<pre class="src src-sh">sed -i -e <span style="color: #8abeb7;">'s/#include &lt;crypt.h&gt;/#if (NGX_HAVE_CRYPT_H)\n#include &lt;crypt.h&gt;\n#end</span><span style="color: #8abeb7; text-decoration: underline;">if\n#include &lt;openssl\/des.h&gt;/g'</span><span style="text-decoration: underline;"> src/os/unix/ngx_linux_config.h</span>
sed -i -e <span style="color: #8abeb7;">'s/= crypt(/= DES_crypt(/g'</span> src/os/unix/ngx_user.c
</pre>
</div></li>

<li><p>
链接时找不到 <code>glob</code> 函数
</p>

<p>
NDK 工具链是有提供 <code>glob.h</code> 头文件的，但是链接时却找不到 <code>glob</code> 函数。网络上有
很多单独提供 <a href="https://github.com/tatowilson/Cross-Compile-Nginx-with-RTMP-Module-for-Android/tree/master/glob">glob</a> 下载的，但是都无法直接通过编译，因为里面有很多平台相关的特性。
</p>

<p>
<a href="https://github.com/android-ndk/ndk/issues/718">Undefined reference to glob and globfree in libc.so · Issue #718 · android-ndk/ndk</a>
中说是已经在 <code>r17b</code> 版本解决，需安装 <code>android-ndk-r17-beta2</code> 同时设置 <code>API
  Level</code> 为 <code>28</code> 即可。
</p></li>

<li><p>
交叉编译 Nginx
</p>

<p>
可使用独立工具链来交叉编译 Nginx，参考前面环境变量配置部分先设置好工具链的环境
变量。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #f0c674;">CC_TEST_FLAGS</span>=<span style="color: #8abeb7;">"${CFLAGS} ${LDFLAGS}"</span> ./configure --with-ld-opt=<span style="color: #8abeb7;">"${LDFLAGS}"</span> --pr<span style="text-decoration: underline;">efix=/opt/local --crossbuild=</span><span style="color: #b294bb; text-decoration: underline;">`/build/execute -c 'uname -srm' | tr ' ' ':'`</span><span style="text-decoration: underline;"> --user=root --group=root --with-select_module --with-poll_module --with-file-aio --with-http_ssl_module --without-mail_pop3_module --without-mail_imap_module  --without-mail_smtp_module</span>
make
make install
</pre>
</div></li>

<li><p>
编译出的 Nginx 无法在低版本的 Android 上运行
</p>

<p>
之前为了使用最新的 NDK 工具链包含的函数 <code>glob</code> ，而将 <code>API Level</code> 设置成 <code>28</code>
，这就意味着编译出来的程序无法在低版本的 Android（&lt;=8.1） 上运行，在 Android
7.1 上运行会报错 <code>/system/bin/nginx: No such file or directory</code> 。
</p>

<p>
将 NDK 最新工具链带的 <code>so</code> 也拷到设备上，运行程序前设置一下 <code>$LD_LIBRARY_PATH</code>
优先使用最新的 <code>so</code> ，Nginx 运行后直接卡死或者立即崩溃。
</p>

<p>
添加 <code>-static -Wl,--dynamic-linker=/system/bin/linker</code> 链接选项静态编译，运行
时会报错 <code>/system/bin/nginx: Accessing a corrupted shared library</code> 的错误，需
要使用 <code>/system/bin/linker64</code> 。
</p>

<p>
由于 <code>-static</code> 与 <code>-pie</code> 是互相冲突的选项，静态编译的程序运行时会报错 <code>only
  position independent executables (PIE) are supported.</code> 。
</p></li>

<li><p>
编译在 Android 5 及以上版本运行的 Nginx
</p>

<p>
参考以下项目，通过使用 docker 方便交叉编译 nginx-1.14.0
</p>

<p>
<a href="https://github.com/tangxinfa/android-nginx">tangxinfa/android-nginx: Cross compile nginx with android ndk</a>
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org6a0b0b5" class="outline-2">
<h2 id="org6a0b0b5">结论</h2>
<div class="outline-text-2" id="text-org6a0b0b5">
<p>
一般的 C/C++ 库通常本身就会注重可移植性，不会生硬地依赖系统底层特性，使用 NDK
移植是可行的，即使是 <code>ffmpeg</code> 这种大型的库也可以成功移植到 Android。
</p>

<p>
而对于一些 Linux 下的程序，使用 NDK 直接移植会有很大的失败机率，因为他们可能
使用了 NDK 不支持的特性（如 <code>glibc</code> ）。
</p>

<p>
NDK 一直在改进，以前阻碍我们移植到 Android 的问题很可能会在新版本中解决，遗憾
的是编译出的程序无法运行在旧版本 Android 上。
</p>
</div>
</div>

<div id="outline-container-org3c8205c" class="outline-2">
<h2 id="org3c8205c">参考</h2>
<div class="outline-text-2" id="text-org3c8205c">
<ul class="org-ul">
<li><a href="https://developer.android.com/ndk/guides/concepts">Concepts  |  Android NDK  |  Android Developers</a></li>

<li><a href="http://www.jkeabc.com/475203.html">Android NDK vs AOSP Build System</a></li>

<li><a href="https://developer.android.com/ndk/guides/stable_apis">Android NDK Native APIs  |  Android NDK  |  Android Developers</a></li>

<li><a href="https://software.intel.com/en-us/articles/building-an-android-command-line-application-using-the-ndk-build-tools">Building an Android* Command-Line Application Using the NDK Build Tools | Intel® Software</a></li>

<li><a href="https://www.jianshu.com/p/6332418b12b1">Android NDK开发扫盲及最新CMake的编译使用 - 简书</a></li>

<li><a href="https://blog.csdn.net/minghuang2017/article/details/78938852">在命令行下用cmake交叉编译可在android中运行的so包 - CSDN博客</a></li>

<li><a href="https://blog.csdn.net/minghuang2017/article/details/79000345">cmake使用独立工具链交叉编译可在android中运行的so包 - CSDN博客</a></li>

<li><a href="https://warpedtimes.wordpress.com/2010/02/03/building-open-source-libraries-with-android-ndk/">Building Open Source libraries with Android NDK | Thoughts and Ideas In Warped Times</a></li>

<li><a href="https://zhangtom.com/2017/07/11/%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91%E5%B8%A6RTMP%E6%A8%A1%E5%9D%97%E7%9A%84Nginx%E5%88%B0Android/">交叉编译带RTMP模块的Nginx到Android | Tom's Blog</a></li>

<li><a href="https://stackoverflow.com/questions/10380422/android-static-linking-vs-dynamic-linking-against-glibc">Android Static Linking vs Dynamic Linking against glibc - Stack Overflow</a></li>

<li><a href="https://stackoverflow.com/questions/27082959/gcc-static-and-pie-are-incompatible-for-x86">android 5.0 lollipop - GCC: -static and -pie are incompatible for x86? - Stack Overflow</a></li>
</ul>
</div>
</div>

        </div>
        <br />
        <footer class="article-footer">
          <span class="muted">
            <i class="icon-time icon-white"></i> <time datetime="2018-08-09T15:28:00+0800">2018年8月9日 15时</time>
          </span>
          <a class="tag" href="/tag/android/0.html"><i class="icon-tag icon-white"></i> android</a>
          <a class="tag" href="/tag/nginx/0.html"><i class="icon-tag icon-white"></i> nginx</a>
        </footer>
      </div>

<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'kankananblog';

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

      <div class="push-footer"></div>
    </div>

    <div id="footer">
  	  <div class="copyright" style="text-align: center;">
  	    版权所有 © 2011-2015 看看俺 – KanKanAn.com
  	    <p>Powered by <a href="https://github.com/tangxinfa/ediary">ediary</a>.</p>
  	  </div>
    </div>
  </body>
</html>
