<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8"/>
    <title>process.exit导致的控制台输出不全 | 看看俺 – KanKanAn.com</title>
    <link rel="shortcut icon" href="/static/favicon.ico" />
    <link rel="stylesheet" type="text/less" href="/style/less/o-blog.less"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="generator" content="o-blog"/>
    <script src="/style/js/less-1.3.0.min.js" type="text/javascript"></script>
    <script src="/style/js/jquery-1.7.1.min.js" type="text/javascript"></script>
    <script src="/style/bootstrap/js/bootstrap-modal.js" type="text/javascript"></script>
    <script src="/style/bootstrap/js/bootstrap-transition.js" type="text/javascript"></script>
    <script src="/style/bootstrap/js/bootstrap-dropdown.js" type="text/javascript"></script>
    <script src="/style/bootstrap/js/bootstrap-collapse.js" type="text/javascript"></script>
    <script src="/style/js/prettify.js" type="text/javascript"></script>
    <script src="/style/js/o-blog.linenumber.js" type="text/javascript"></script>
    <script src="/style/js/o-blog-fix.js" type="text/javascript"></script>
  </head>
  <body>
    <div class="navbar navbar-fixed-top" id="header">
      <div class="navbar-inner">
	    <div class="container">
	      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="/" style="line-height:100%;">看看俺 – KanKanAn.com</a>
	      <div class="nav-collapse collapse">
            <ul class="org-ul">
              <li><a href="/index.xml"><i class="icon-rss icon-white"></i> 订阅</a></li>
                
                <li><a href="/index.html"><i class="icon-folder-close icon-white"></i> 技术</a></li>
                <li><a href="/category/life/0.html"><i class="icon-folder-close icon-white"></i> 生活</a></li>
            </ul>
	      </div>
	    </div>
      </div>
    </div>

    <div class="container container-fluid" id="page">
      <div class="push-header"></div>

      <div class="article">
        <header class="article-header">
          <h1>process.exit导致的控制台输出不全</h1>
      	<div class="qr-code">
      	  <img style="min-width:90px; min-height:90px; max-width:90px; max-height:90px;" src="" alt="" id="qr-code" />
      	  <script>
      	    document.getElementById("qr-code").src = "http://chart.apis.google.com/chart?chs=90x90&cht=qr&chld=|0&chl=" + encodeURIComponent(document.location.href);
      	  </script>
      	</div>
        </header>
      
        <div class="article-content">
          <ul class="org-ul">
<li>先上案例程序：

<div class="org-src-container">

<pre class="src src-js"><span style="color: #b9ca4a;">for</span>(<span style="color: #b9ca4a;">var</span> <span style="color: #e7c547;">i</span> = 0; i &lt; 10000; ++i) {
<span style="color: #eaeaea; background-color: #424242;"> </span>   console.log(<span style="color: #70c0b1;">"this is long long long long long long long long long long long </span><span style="color: #70c0b1; text-decoration: underline;">long long long long long long long long long long long long long long long long long long log "</span><span style="text-decoration: underline;"> + i);</span>
}
process.exit(0);
</pre>
</div>

<p>
这个程序输出10000行日志，然后结束进程。
</p>
</li>

<li><code>Emacs Shell</code> 以及 <code>GNOME Terminal</code> 下运行结果（省略中间部分输出）：

<pre class="example">
$ node /home/tangxinfa/Examples/test_exit.js
this is long long long long long long long long long long long long long long long long long long long long long long long long long long long long long log 0
...
this is long long long long long long long long long long long long long long long long long long long long long long long long long long long long long log 119
$
</pre>

<p>
程序只输出了前面200行日志。
</p>
</li>

<li>按 <code>Ctrl+Alt+F2</code> 进入2号系统终端下运行结果（省略中间部分输出）：

<pre class="example">
$ node /home/tangxinfa/Examples/test_exit.js
this is long long long long long long long long long long long long long long long long long long long long long long long long long long long long long log 0
...
this is long long long long long long long long long long long long long long long long long long long long long long long long long long long long long log 9999
$
</pre>

<p>
程序输出了完整的日志。
</p>
</li>

<li>日志重定向到文件时 <code>Emacs Shell</code> 以及 <code>GNOME Terminal</code> 下运行结果（省略中间部分输出）：

<pre class="example">
$ node /home/tangxinfa/Examples/test_exit.js &gt; /tmp/test_exit.log
$ tail -1 /tmp/test_exit.log
this is long long long long long long long long long long long long long long long long long long long long long long long long long long long long long log 9999
$
</pre>

<p>
程序输出了完整的日志。
</p>
</li>

<li>原因

<p>
如果输出目标为终端（ <code>Emacs Shell</code> 以及 <code>GNOME Terminal</code> 并非真正的终端）或文件时，console函数是同步的（避免程序过早退出导致丢消息），目标为管道时则为异步（避免长时间堵塞）。
</p>

<blockquote>
<p>
The console functions are synchronous when the destination is a terminal or a file (to avoid lost messages in case of premature exit) and asynchronous when it's a pipe (to avoid blocking for long periods of time).
</p>
</blockquote>

<p>
参考：《<a href="http://stackoverflow.com/questions/18748164/process-exit0-output-disappears">process.exit(0): output disappears?</a>》
</p>
</li>

<li>解决方案

<p>
调用 <code>process.exit</code> 时确保输出完毕，封装如下：
</p>

<div class="org-src-container">

<pre class="src src-js"><span class="linenr">1: </span><span style="color: #969896; font-style: italic;">/// </span><span style="color: #969896; font-style: italic;">Safe exit. Makesure log output flushed to console.</span>
<span class="linenr">2: </span><span style="color: #b9ca4a;">function</span> <span style="color: #e78c45;">exit</span>(<span style="color: #e7c547;">code</span>) {
<span class="linenr">3: </span><span style="color: #eaeaea; background-color: #424242;"> </span>   process.stdout.write(<span style="color: #70c0b1;">''</span>, <span style="color: #b9ca4a;">function</span> () {
<span id="coderef-stderr-write" class="coderef-off"><span class="linenr">4: </span><span style="color: #eaeaea; background-color: #424242;"> </span>   <span style="color: #eaeaea; background-color: #424242;"> </span>   process.stderr.write(<span style="color: #70c0b1;">''</span>, <span style="color: #b9ca4a;">function</span> () {</span>
<span class="linenr">5: </span><span style="color: #eaeaea; background-color: #424242;"> </span>   <span style="color: #eaeaea; background-color: #424242;"> </span>   <span style="color: #eaeaea; background-color: #424242;"> </span>   process.exit(code);
<span class="linenr">6: </span><span style="color: #eaeaea; background-color: #424242;"> </span>   <span style="color: #eaeaea; background-color: #424242;"> </span>   });
<span class="linenr">7: </span><span style="color: #eaeaea; background-color: #424242;"> </span>   });
<span class="linenr">8: </span>}
</pre>
</div>

<p>
注意，上面的 <code>exit</code> 函数不会像 <code>process.exit</code> 一样立即终止程序，请将 <code>process.exit</code> 替换为  <code>return exit</code> 。
</p>

<p>
通过 <a href="https://github.com/Unitech/pm2">pm2</a> 运行 node.js 应用时会接管标准输出和错误输出到日志文件，不存在进程退出日志输出丢失的问题，
由于 <a href="https://github.com/Unitech/pm2">pm2</a> 会改写 process.stdout.write 和 process.stderr.write ，改写后的函数无返回值并忽略传入的回调函数，
导致前面封装的 exit 函数无效，需要针对 <a href="https://github.com/Unitech/pm2">pm2</a> 做处理：
</p>

<div class="org-src-container">

<pre class="src src-js"><span style="color: #969896; font-style: italic;">/// </span><span style="color: #969896; font-style: italic;">Safe exit, Makesure log output flushed to console.</span>
<span style="color: #969896; font-style: italic;">/// </span><span style="color: #969896; font-style: italic;">PM2 changed process.stderr.write and process.stdout.write's behavior,</span>
<span style="color: #969896; font-style: italic;">/// </span><span style="color: #969896; font-style: italic;">log output write to file will flushed automatically,</span>
<span style="color: #b9ca4a;">function</span> <span style="color: #e78c45;">exit</span>(<span style="color: #e7c547;">code</span>) {
<span style="color: #eaeaea; background-color: #424242;"> </span>   <span style="color: #b9ca4a;">if</span> (<span style="color: #b9ca4a;">typeof</span>(process.env.pm_id) == <span style="color: #70c0b1;">'undefined'</span>) {
<span style="color: #eaeaea; background-color: #424242;"> </span>   <span style="color: #eaeaea; background-color: #424242;"> </span>   process.stdout.write(<span style="color: #70c0b1;">''</span>, <span style="color: #b9ca4a;">function</span> () {
<span style="color: #eaeaea; background-color: #424242;"> </span>   <span style="color: #eaeaea; background-color: #424242;"> </span>   <span style="color: #eaeaea; background-color: #424242;"> </span>   process.stderr.write(<span style="color: #70c0b1;">''</span>, <span style="color: #b9ca4a;">function</span> () {
<span style="color: #eaeaea; background-color: #424242;"> </span>   <span style="color: #eaeaea; background-color: #424242;"> </span>   <span style="color: #eaeaea; background-color: #424242;"> </span>   <span style="color: #eaeaea; background-color: #424242;"> </span>   process.exit(code);
<span style="color: #eaeaea; background-color: #424242;"> </span>   <span style="color: #eaeaea; background-color: #424242;"> </span>   <span style="color: #eaeaea; background-color: #424242;"> </span>   });
<span style="color: #eaeaea; background-color: #424242;"> </span>   <span style="color: #eaeaea; background-color: #424242;"> </span>   });
<span style="color: #eaeaea; background-color: #424242;"> </span>   } <span style="color: #b9ca4a;">else</span> {
<span style="color: #eaeaea; background-color: #424242;"> </span>   <span style="color: #eaeaea; background-color: #424242;"> </span>   process.exit(code);
<span style="color: #eaeaea; background-color: #424242;"> </span>   }
}
</pre>
</div>
</li>
</ul>

        </div>
        <br />
        <footer class="article-footer">
          <a class="tag" href="/tag/node/0.html"><i class="icon-tag icon-white"></i> node</a>
          <span class="muted">
            <i class="icon-time icon-white"></i> <time datetime="2015-08-27T17:03:00+0800">2015年8月27日 17时</time>
          </span>
        </footer>
      </div>

<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'kankananblog';

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

      <div class="push-footer"></div>
    </div>

    <div id="footer">
  	  <div class="copyright" style="text-align: center;">
  	    版权所有 © 2011-2015 看看俺 – KanKanAn.com
  	    <p>Powered by <a href="https://github.com/tangxinfa/ediary">ediary</a>.</p>
  	  </div>
    </div>
  </body>
</html>
