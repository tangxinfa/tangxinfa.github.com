<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8"/>
    <title>ioredis Sentinel 实现就近访问 | 看看俺 – KanKanAn.com</title>
    <link rel="shortcut icon" href="/static/favicon.ico" />
    <link rel="stylesheet" type="text/less" href="/style/less/o-blog.less"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="generator" content="o-blog"/>
    <script src="/style/js/less-1.3.0.min.js" type="text/javascript"></script>
    <script src="/style/js/jquery-1.7.1.min.js" type="text/javascript"></script>
    <script src="/style/bootstrap/js/bootstrap-modal.js" type="text/javascript"></script>
    <script src="/style/bootstrap/js/bootstrap-transition.js" type="text/javascript"></script>
    <script src="/style/bootstrap/js/bootstrap-dropdown.js" type="text/javascript"></script>
    <script src="/style/bootstrap/js/bootstrap-collapse.js" type="text/javascript"></script>
    <script src="/style/js/prettify.js" type="text/javascript"></script>
    <script src="/style/js/o-blog.linenumber.js" type="text/javascript"></script>
    <script src="/style/js/o-blog-fix.js" type="text/javascript"></script>
  </head>
  <body>
    <div class="navbar navbar-fixed-top" id="header">
      <div class="navbar-inner">
	    <div class="container">
	      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="/" style="line-height:100%;">看看俺 – KanKanAn.com</a>
	      <div class="nav-collapse collapse">
            <ul class="org-ul">
              <li><a href="/index.xml"><i class="icon-rss icon-white"></i> 订阅</a></li>
                
                <li><a href="/index.html"><i class="icon-folder-close icon-white"></i> 技术</a></li>
                <li><a href="/category/life/0.html"><i class="icon-folder-close icon-white"></i> 生活</a></li>
            </ul>
	      </div>
	    </div>
      </div>
    </div>

    <div class="container container-fluid" id="page">
      <div class="push-header"></div>

      <div class="article">
        <header class="article-header">
          <h1>ioredis Sentinel 实现就近访问</h1>
      	<div class="qr-code">
      	  <img style="min-width:90px; min-height:90px; max-width:90px; max-height:90px;" src="" alt="" id="qr-code" />
      	  <script>
      	    document.getElementById("qr-code").src = "http://chart.apis.google.com/chart?chs=90x90&cht=qr&chld=|0&chl=" + encodeURIComponent(document.location.href);
      	  </script>
      	</div>
        </header>
      
        <div class="article-content">
          
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><a href="https://github.com/luin/ioredis/">ioredis</a> 支持按角色（Role）进行连接</h2>
<div class="outline-text-2" id="text-1">
<p>
引用自 <a href="https://github.com/luin/ioredis/">ioredis</a>
</p>
<blockquote>
<p>
ioredis 保证即使故障转移（failover）后你连接的结点依然是 master 。当故障转移发生，ioredis 会向 sentinels 询问新的 master 结点并连接，而不是尝试重连失效的结点（恢复可用后它会降级为 slave）。故障转移期间发送的所有命令将放入队列，当新连接建立后再执行，不会丢失命令。
</p>

<p>
可以指定 role 选项为 slave 以连接 slave 结点，ioredis 将尝试连接指定 master 的一个随机 slave 结点，并且保证连接的结点总是 slave 角色。当连接的结点因为故障转移而提升为 master，ioredis 将从该结点断开连接并询问 sentinels 获取另一个 slave 结点进行连接。
</p>

<p>
ioredis guarantees that the node you connected to is always a master even after a failover. When a failover happens, instead of trying to reconnect to the failed node (which will be demoted to slave when it's available again), ioredis will ask sentinels for the new master node and connect to it. All commands sent during the failover are queued and will be executed when the new connection is established so that none of the commands will be lost.
</p>

<p>
It's possible to connect to a slave instead of a master by specifying the option role with the value of slave, and ioredis will try to connect to a random slave of the specified master, with the guarantee that the connected node is always a slave. If the current node is promoted to master due to a failover, ioredis will disconnect from it and ask the sentinels for another slave node to connect to.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><a href="https://github.com/luin/ioredis/">ioredis</a> 会随机选择一个 Slave</h2>
<div class="outline-text-2" id="text-2">
<p>
引用自 ioredis/lib/connectors/sentinel_connector.js
</p>
<div class="org-src-container">

<pre class="src src-js">SentinelConnector.<span style="color: #6699cc;">prototype</span>.resolveSlave = <span style="color: #99cc99;">function</span> (<span style="color: #ffcc66;">client</span>, <span style="color: #ffcc66;">callback</span>) {
<span style="color: #999999; background-color: #2d2d2d;"> </span> client.sentinel(<span style="color: #66cccc;">'slaves'</span>, <span style="color: #6699cc;">this</span>.options.name, <span style="color: #99cc99;">function</span> (<span style="color: #ffcc66;">err</span>, <span style="color: #ffcc66;">result</span>) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   client.disconnect();
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">if</span> (err) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span> <span style="color: #99cc99;">return</span> callback(err);
<span style="color: #999999; background-color: #2d2d2d;"> </span>   }
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">var</span> <span style="color: #ffcc66;">selectedSlave</span>;
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">if</span> (Array.isArray(result)) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span> <span style="color: #99cc99;">var</span> <span style="color: #ffcc66;">availableSlaves</span> = [];
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span> <span style="color: #99cc99;">for</span> (<span style="color: #99cc99;">var</span> <span style="color: #ffcc66;">i</span> = 0; i &lt; result.length; ++i) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">var</span> <span style="color: #ffcc66;">slave</span> = utils.packObject(result[i]);
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">if</span> (slave.flags &amp;&amp; !slave.flags.match(<span style="color: #66cccc;">/(disconnected|s_down|o_down)/</span>)) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span> availableSlaves.push(slave);
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   }
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span> }
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span> selectedSlave = _.sample(availableSlaves);
<span style="color: #999999; background-color: #2d2d2d;"> </span>   }
<span style="color: #999999; background-color: #2d2d2d;"> </span>   callback(<span style="color: #6699cc;">null</span>, selectedSlave ? { host: selectedSlave.ip, port: selectedSlave<span style="text-decoration: underline;">.port } : </span><span style="color: #6699cc; text-decoration: underline;">null</span><span style="text-decoration: underline;">);</span>
<span style="color: #999999; background-color: #2d2d2d;"> </span> });
};
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">优先选择本地 Slave （不使用 preferredSlaves 选项）</h2>
<div class="outline-text-2" id="text-3">
<p>
相关讨论
</p>

<p>
<a href="https://github.com/luin/ioredis/issues/38">rfc - a preferred slave list in a sentinel setup · Issue #38 · luin/ioredis</a>
</p>

<p>
preferredSlaves 选项已经在 2.4.0 版实现，下面的代码依赖之前的 ioredis 版本代码，仅供参考，不建议使用。
</p>


<p>
尝试自已实现优先选择本地 Slave 算法：按 IP 地址进行推断，前三段一样则认为是本地。
</p>

<p>
假设本机 IP 为 11.22.33.1，则 Slave 11.22.33.123 由于前三段（11.22.33）与本机相同被认定为是本地 Slave，而 Slave 11.22.99.1 由于前三段（11.22.99）与本机不同被认定为是异地 Slave。
</p>

<p>
实现如下
</p>

<div class="org-src-container">

<pre class="src src-js"><span style="color: #99cc99;">var</span> <span style="color: #ffcc66;">Redis</span>     = require(<span style="color: #66cccc;">'ioredis'</span>),
<span style="color: #999999; background-color: #2d2d2d;"> </span>   utils     = require(<span style="color: #66cccc;">'ioredis/lib/utils'</span>),
<span style="color: #999999; background-color: #2d2d2d;"> </span>   _         = require(<span style="color: #66cccc;">'lodash'</span>),
<span style="color: #999999; background-color: #2d2d2d;"> </span>   net       = require(<span style="color: #66cccc;">'net'</span>),
<span style="color: #999999; background-color: #2d2d2d;"> </span>   assert    = require(<span style="color: #66cccc;">'assert'</span>);


<span style="color: #999999; font-style: italic;">/**</span>
<span style="color: #999999; background-color: #2d2d2d; font-style: italic;"> </span><span style="color: #999999; font-style: italic;">* A SentinelConnector.prototype.resolveSlave replacement, prefer local slave.</span>
<span style="color: #999999; background-color: #2d2d2d; font-style: italic;"> </span><span style="color: #999999; font-style: italic;">*</span>
<span style="color: #999999; background-color: #2d2d2d; font-style: italic;"> </span><span style="color: #999999; font-style: italic;">* </span><span style="color: #99cc99; font-style: italic;">@param</span><span style="color: #999999; font-style: italic;"> </span><span style="color: #ffcc66; font-style: italic;">client</span><span style="color: #999999; font-style: italic;"> redis client.</span>
<span style="color: #999999; background-color: #2d2d2d; font-style: italic;"> </span><span style="color: #999999; font-style: italic;">* </span><span style="color: #99cc99; font-style: italic;">@param</span><span style="color: #999999; font-style: italic;"> </span><span style="color: #ffcc66; font-style: italic;">callback</span><span style="color: #999999; font-style: italic;"> function (err, slave) called when done.</span>
<span style="color: #999999; background-color: #2d2d2d; font-style: italic;"> </span><span style="color: #999999; font-style: italic;">*                 slave with a extra boolean field "local_node" to indicate sla</span><span style="color: #999999; font-style: italic; text-decoration: underline;">ve is in local network.</span>
<span style="color: #999999; background-color: #2d2d2d; font-style: italic;"> </span><span style="color: #999999; font-style: italic;">*</span>
<span style="color: #999999; background-color: #2d2d2d; font-style: italic;"> </span><span style="color: #999999; font-style: italic;">*/</span>
<span style="color: #99cc99;">function</span> <span style="color: #f99157;">resolveSlavePreferLocal</span> (<span style="color: #ffcc66;">client</span>, <span style="color: #ffcc66;">callback</span>) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">var</span> <span style="color: #ffcc66;">self</span> = <span style="color: #6699cc;">this</span>;
<span style="color: #999999; background-color: #2d2d2d;"> </span>   client.sentinel(<span style="color: #66cccc;">'slaves'</span>, <span style="color: #6699cc;">this</span>.options.name, <span style="color: #99cc99;">function</span> (<span style="color: #ffcc66;">err</span>, <span style="color: #ffcc66;">result</span>) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">if</span> (err) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   client.disconnect();
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">return</span> callback(err);
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   }
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">var</span> <span style="color: #ffcc66;">localIP</span> = client.stream.localAddress;
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   client.disconnect();

<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">var</span> <span style="color: #ffcc66;">localIPSegments</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">Array</span>(4);
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">if</span> (net.isIPv4(localIP)) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   localIPSegments = localIP.split(<span style="color: #66cccc;">'.'</span>);
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   }

<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">var</span> <span style="color: #ffcc66;">selectedSlave</span>;
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">var</span> <span style="color: #ffcc66;">local_node</span> = <span style="color: #6699cc;">false</span>;
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">if</span> (Array.isArray(result)) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">var</span> <span style="color: #ffcc66;">localSlaves</span> = [];
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">var</span> <span style="color: #ffcc66;">remoteSlaves</span> = [];
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">for</span> (<span style="color: #99cc99;">var</span> <span style="color: #ffcc66;">i</span> = 0; i &lt; result.length; ++i) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">var</span> <span style="color: #ffcc66;">slave</span> = utils.packObject(result[i]);
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">if</span> (slave.flags &amp;&amp; !slave.flags.match(<span style="color: #66cccc;">/(disconnected|s_down|o_do</span><span style="color: #66cccc; text-decoration: underline;">wn)/</span><span style="text-decoration: underline;">)) {</span>
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">if</span> (net.isIPv4(slave.ip)) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">var</span> <span style="color: #ffcc66;">slaveIpSegments</span> = slave.ip.split(<span style="color: #66cccc;">'.'</span>);
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">if</span> (localIPSegments[0] === slaveIpSegments[0] &amp;&amp;
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   localIPSegments[1] === slaveIpSegments[1] &amp;&amp;
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   localIPSegments[2] === slaveIpSegments[2]) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   localSlaves.push(slave);
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">continue</span>;
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   }
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   }

<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   remoteSlaves.push(slave);
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   }
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   }
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   selectedSlave = _.sample(localSlaves.length ? localSlaves : remoteSl<span style="text-decoration: underline;">aves);</span>
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   local_node = Boolean(localSlaves.length);
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   }

<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   console.warn(<span style="color: #66cccc;">'redis('</span> + JSON.stringify({name: self.options.name, db: sel<span style="text-decoration: underline;">f.options.db, sentinels: self.options.sentinels}) + </span><span style="color: #66cccc; text-decoration: underline;">') resolve slave to'</span><span style="text-decoration: underline;"> + (local_node ? </span><span style="color: #66cccc; text-decoration: underline;">' local'</span><span style="text-decoration: underline;"> : </span><span style="color: #66cccc; text-decoration: underline;">''</span><span style="text-decoration: underline;">) + </span><span style="color: #66cccc; text-decoration: underline;">': '</span><span style="text-decoration: underline;"> + selectedSlave.ip + </span><span style="color: #66cccc; text-decoration: underline;">':'</span><span style="text-decoration: underline;"> + selectedSlave.port);</span>

<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   callback(<span style="color: #6699cc;">null</span>, selectedSlave ? { host: selectedSlave.ip, port: selectedS<span style="text-decoration: underline;">lave.port, local_node: local_node } : </span><span style="color: #6699cc; text-decoration: underline;">null</span><span style="text-decoration: underline;">);</span>
<span style="color: #999999; background-color: #2d2d2d;"> </span>   });
};

<span style="color: #999999; font-style: italic;">/**</span>
<span style="color: #999999; background-color: #2d2d2d; font-style: italic;"> </span><span style="color: #999999; font-style: italic;">* Prefer connect to local slave.</span>
<span style="color: #999999; background-color: #2d2d2d; font-style: italic;"> </span><span style="color: #999999; font-style: italic;">*</span>
<span style="color: #999999; background-color: #2d2d2d; font-style: italic;"> </span><span style="color: #999999; font-style: italic;">* </span><span style="color: #99cc99; font-style: italic;">@param</span><span style="color: #999999; font-style: italic;"> </span><span style="color: #ffcc66; font-style: italic;">client</span><span style="color: #999999; font-style: italic;"> redis client.</span>
<span style="color: #999999; background-color: #2d2d2d; font-style: italic;"> </span><span style="color: #999999; font-style: italic;">*</span>
<span style="color: #999999; background-color: #2d2d2d; font-style: italic;"> </span><span style="color: #999999; font-style: italic;">* </span><span style="color: #99cc99; font-style: italic;">@return</span><span style="color: #999999; font-style: italic;"> is this change successful.</span>
<span style="color: #999999; background-color: #2d2d2d; font-style: italic;"> </span><span style="color: #999999; font-style: italic;">*/</span>
<span style="color: #99cc99;">function</span> <span style="color: #f99157;">preferLocalSlave</span>(<span style="color: #ffcc66;">client</span>) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">if</span> (client.options.role === <span style="color: #66cccc;">'slave'</span> &amp;&amp; client.connector.resolveSlave) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">if</span> (client.options.lazyConnect &amp;&amp; client.status == <span style="color: #66cccc;">'wait'</span>) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   client.connector.resolveSlave = resolveSlavePreferLocal;
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">return</span> <span style="color: #6699cc;">true</span>;
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   }

<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   console.warn(<span style="color: #66cccc;">'redis client('</span> + JSON.stringify({name: client.options.name<span style="text-decoration: underline;">, db: client.options.db, sentinels: client.options.sentinels}) + </span><span style="color: #66cccc; text-decoration: underline;">') status unexpected'</span><span style="text-decoration: underline;">);</span>
<span style="color: #999999; background-color: #2d2d2d;"> </span>   }

<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">return</span> <span style="color: #6699cc;">false</span>;
}
</pre>
</div>

<p>
用法如下
</p>

<div class="org-src-container">

<pre class="src src-js"><span style="color: #99cc99;">var</span> <span style="color: #ffcc66;">options</span> = {name: <span style="color: #66cccc;">"data"</span>, sentinels: sentinels, db: 0, role: <span style="color: #66cccc;">"slave"</span>, lazyCon<span style="text-decoration: underline;">nect: </span><span style="color: #6699cc; text-decoration: underline;">true</span><span style="text-decoration: underline;">}</span>
<span style="color: #99cc99;">var</span> <span style="color: #ffcc66;">client</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">Redis</span>(options);
<span style="color: #99cc99;">if</span> (preferLocalSlave(client)) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   console.warn(<span style="color: #66cccc;">"prefer local slave on redis sentinel("</span> + JSON.stringify(option<span style="text-decoration: underline;">s) + </span><span style="color: #66cccc; text-decoration: underline;">")"</span><span style="text-decoration: underline;">);</span>
}
</pre>
</div>

<p>
值得注意的是必须指定 <code>lazyConnect: true</code> ，这样才能通过替换 client 中的方法实现功能。 
</p>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">优先选择本地结点 （不使用 preferredSlaves 选项）</h2>
<div class="outline-text-2" id="text-4">
<p>
preferredSlaves 选项已经在 2.4.0 版实现，下面的代码依赖之前的 ioredis 版本代码，仅供参考，不建议使用。
</p>

<p>
假设 redis 是以 1 Master + 1 Slave 方式进行跨机房部署，那么我们希望实现优先连接本地结点（忽略其角色），
连接成功后该连接可能是 Master 也可能是 Slave，我们把它当 Slave 用准没错。
</p>

<p>
在上一节的基础上，实现如下
</p>

<div class="org-src-container">

<pre class="src src-js"><span style="color: #999999; font-style: italic;">/**</span>
<span style="color: #999999; background-color: #2d2d2d; font-style: italic;"> </span><span style="color: #999999; font-style: italic;">* A SentinelConnector.prototype.resolveMaster replacement, indicate the resolve</span><span style="color: #999999; font-style: italic; text-decoration: underline;">d node is local node.</span>
<span style="color: #999999; background-color: #2d2d2d; font-style: italic;"> </span><span style="color: #999999; font-style: italic;">*</span>
<span style="color: #999999; background-color: #2d2d2d; font-style: italic;"> </span><span style="color: #999999; font-style: italic;">* </span><span style="color: #99cc99; font-style: italic;">@param</span><span style="color: #999999; font-style: italic;"> </span><span style="color: #ffcc66; font-style: italic;">client</span><span style="color: #999999; font-style: italic;"> redis client.</span>
<span style="color: #999999; background-color: #2d2d2d; font-style: italic;"> </span><span style="color: #999999; font-style: italic;">* </span><span style="color: #99cc99; font-style: italic;">@param</span><span style="color: #999999; font-style: italic;"> </span><span style="color: #ffcc66; font-style: italic;">callback</span><span style="color: #999999; font-style: italic;"> function (err, master) called when done.</span>
<span style="color: #999999; background-color: #2d2d2d; font-style: italic;"> </span><span style="color: #999999; font-style: italic;">*                 master with a extra boolean field "local_node" to indicate ma</span><span style="color: #999999; font-style: italic; text-decoration: underline;">ster is in local network.</span>
<span style="color: #999999; background-color: #2d2d2d; font-style: italic;"> </span><span style="color: #999999; font-style: italic;">*</span>
<span style="color: #999999; background-color: #2d2d2d; font-style: italic;"> </span><span style="color: #999999; font-style: italic;">*/</span>
<span style="color: #99cc99;">function</span> <span style="color: #f99157;">resolveMasterPreferLocal</span> (<span style="color: #ffcc66;">client</span>, <span style="color: #ffcc66;">callback</span>) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   client.sentinel(<span style="color: #66cccc;">'get-master-addr-by-name'</span>, <span style="color: #6699cc;">this</span>.options.name, <span style="color: #99cc99;">function</span> (<span style="color: #ffcc66;">err</span>,<span style="text-decoration: underline;"> </span><span style="color: #ffcc66; text-decoration: underline;">result</span><span style="text-decoration: underline;">) {</span>
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">if</span> (err) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   client.disconnect();
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">return</span> callback(err);
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   }

<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">var</span> <span style="color: #ffcc66;">localIP</span> = client.stream.localAddress;
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   client.disconnect();

<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">var</span> <span style="color: #ffcc66;">localIPSegments</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">Array</span>(4);
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">if</span> (net.isIPv4(localIP)) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   localIPSegments = localIP.split(<span style="color: #66cccc;">'.'</span>);
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   }

<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">var</span> <span style="color: #ffcc66;">local_node</span> = <span style="color: #6699cc;">false</span>;
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">if</span> (Array.isArray(result)) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">var</span> <span style="color: #ffcc66;">ip</span> = result[0];
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">if</span> (net.isIPv4(ip)) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">var</span> <span style="color: #ffcc66;">ipSegments</span> = ip.split(<span style="color: #66cccc;">'.'</span>);
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">if</span> (localIPSegments[0] === ipSegments[0] &amp;&amp;
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   localIPSegments[1] === ipSegments[1] &amp;&amp;
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   localIPSegments[2] === ipSegments[2]) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   local_node = <span style="color: #6699cc;">true</span>;
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   }
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   }
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   }

<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   callback(<span style="color: #6699cc;">null</span>, Array.isArray(result) ? { host: result[0], port: result[1<span style="text-decoration: underline;">], local_node: local_node } : </span><span style="color: #6699cc; text-decoration: underline;">null</span><span style="text-decoration: underline;">);</span>
<span style="color: #999999; background-color: #2d2d2d;"> </span>   });
};

<span style="color: #999999; font-style: italic;">/**</span>
<span style="color: #999999; background-color: #2d2d2d; font-style: italic;"> </span><span style="color: #999999; font-style: italic;">* A SentinelConnector.prototype.resolve replacement, prefer resolve to local no</span><span style="color: #999999; font-style: italic; text-decoration: underline;">de.</span>
<span style="color: #999999; background-color: #2d2d2d; font-style: italic;"> </span><span style="color: #999999; font-style: italic;">*</span>
<span style="color: #999999; background-color: #2d2d2d; font-style: italic;"> </span><span style="color: #999999; font-style: italic;">* </span><span style="color: #99cc99; font-style: italic;">@param</span><span style="color: #999999; font-style: italic;"> </span><span style="color: #ffcc66; font-style: italic;">endpoint</span><span style="color: #999999; font-style: italic;"> sentinel endpoint to connect.</span>
<span style="color: #999999; background-color: #2d2d2d; font-style: italic;"> </span><span style="color: #999999; font-style: italic;">* </span><span style="color: #99cc99; font-style: italic;">@param</span><span style="color: #999999; font-style: italic;"> </span><span style="color: #ffcc66; font-style: italic;">callback</span><span style="color: #999999; font-style: italic;"> function (err, node) called when done.</span>
<span style="color: #999999; background-color: #2d2d2d; font-style: italic;"> </span><span style="color: #999999; font-style: italic;">*                 node with a extra boolean field "local_node" to indicate node</span><span style="color: #999999; font-style: italic; text-decoration: underline;"> is in local network.</span>
<span style="color: #999999; background-color: #2d2d2d; font-style: italic;"> </span><span style="color: #999999; font-style: italic;">*</span>
<span style="color: #999999; background-color: #2d2d2d; font-style: italic;"> </span><span style="color: #999999; font-style: italic;">*/</span>
<span style="color: #99cc99;">function</span> <span style="color: #f99157;">resolvePreferLocal</span>(<span style="color: #ffcc66;">endpoint</span>, <span style="color: #ffcc66;">callback</span>) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   assert(<span style="color: #6699cc;">this</span>.options.role === <span style="color: #66cccc;">'slave'</span>);

<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">var</span> <span style="color: #ffcc66;">client</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">Redis</span>({
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   port: endpoint.port,
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   host: endpoint.host,
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   retryStrategy: <span style="color: #6699cc;">null</span>,
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   enableReadyCheck: <span style="color: #6699cc;">false</span>,
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   connectTimeout: <span style="color: #6699cc;">this</span>.options.connectTimeout
<span style="color: #999999; background-color: #2d2d2d;"> </span>   });

<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">var</span> <span style="color: #ffcc66;">self</span> = <span style="color: #6699cc;">this</span>;
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #6699cc;">this</span>.resolveSlave(client, <span style="color: #99cc99;">function</span> (<span style="color: #ffcc66;">slave_err</span>, <span style="color: #ffcc66;">slave</span>) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">if</span> (slave_err || !slave ||!slave.local_node) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">if</span> (slave_err) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   console.error(<span style="color: #66cccc;">'redis('</span> + JSON.stringify({name: self.options.name<span style="text-decoration: underline;">, db: self.options.db, sentinels: self.options.sentinels}) + </span><span style="color: #66cccc; text-decoration: underline;">') resolve slave error('</span><span style="text-decoration: underline;"> + slave_err.toString() + </span><span style="color: #66cccc; text-decoration: underline;">')'</span><span style="text-decoration: underline;">);</span>
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   }
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   client = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">Redis</span>({
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   port: endpoint.port,
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   host: endpoint.host,
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   retryStrategy: <span style="color: #6699cc;">null</span>,
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   enableReadyCheck: <span style="color: #6699cc;">false</span>,
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   connectTimeout: self.options.connectTimeout
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   });
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">return</span> self.resolveMaster(client, <span style="color: #99cc99;">function</span> (<span style="color: #ffcc66;">master_err</span>, <span style="color: #ffcc66;">master</span>) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">if</span> (master_err) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   console.error(<span style="color: #66cccc;">'redis('</span> + JSON.stringify({name: self.options.<span style="text-decoration: underline;">name, db: self.options.db, sentinels: self.options.sentinels}) + </span><span style="color: #66cccc; text-decoration: underline;">') resolve master error('</span><span style="text-decoration: underline;"> + master_err.toString() + </span><span style="color: #66cccc; text-decoration: underline;">')'</span><span style="text-decoration: underline;">);</span>
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   }
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">if</span> (!master_err &amp;&amp; master &amp;&amp; master.local_node) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   console.warn(<span style="color: #66cccc;">'redis('</span> + JSON.stringify({name: self.options.n<span style="text-decoration: underline;">ame, db: self.options.db, sentinels: self.options.sentinels}) + </span><span style="color: #66cccc; text-decoration: underline;">') resolve slave to local master: '</span><span style="text-decoration: underline;"> + master.host + </span><span style="color: #66cccc; text-decoration: underline;">':'</span><span style="text-decoration: underline;"> + master.port);</span>
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">return</span> callback(<span style="color: #6699cc;">null</span>, master);
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   } <span style="color: #99cc99;">else</span> <span style="color: #99cc99;">if</span> (slave || master) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">return</span> callback(<span style="color: #6699cc;">null</span>, slave || master);
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   }

<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">return</span> callback(slave_err || master_err, <span style="color: #6699cc;">null</span>);
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   });
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   } <span style="color: #99cc99;">else</span> {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">return</span> callback(<span style="color: #6699cc;">null</span>, slave);
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   }
<span style="color: #999999; background-color: #2d2d2d;"> </span>   });
}

<span style="color: #999999; font-style: italic;">/**</span>
<span style="color: #999999; background-color: #2d2d2d; font-style: italic;"> </span><span style="color: #999999; font-style: italic;">* A SentinelConnector.prototype.check replacement, enable connect local master </span><span style="color: #999999; font-style: italic; text-decoration: underline;">when connect to slave.</span>
<span style="color: #999999; background-color: #2d2d2d; font-style: italic;"> </span><span style="color: #999999; font-style: italic;">*/</span>
<span style="color: #99cc99;">function</span> <span style="color: #f99157;">checkPreferLocal</span>(<span style="color: #ffcc66;">info</span>) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">return</span> <span style="color: #6699cc;">true</span>;
}

<span style="color: #999999; font-style: italic;">/**</span>
<span style="color: #999999; background-color: #2d2d2d; font-style: italic;"> </span><span style="color: #999999; font-style: italic;">* Prefer connect to local redis node, slave first.</span>
<span style="color: #999999; background-color: #2d2d2d; font-style: italic;"> </span><span style="color: #999999; font-style: italic;">*</span>
<span style="color: #999999; background-color: #2d2d2d; font-style: italic;"> </span><span style="color: #999999; font-style: italic;">* </span><span style="color: #99cc99; font-style: italic;">@param</span><span style="color: #999999; font-style: italic;"> </span><span style="color: #ffcc66; font-style: italic;">client</span><span style="color: #999999; font-style: italic;"> redis client.</span>
<span style="color: #999999; background-color: #2d2d2d; font-style: italic;"> </span><span style="color: #999999; font-style: italic;">*</span>
<span style="color: #999999; background-color: #2d2d2d; font-style: italic;"> </span><span style="color: #999999; font-style: italic;">* </span><span style="color: #99cc99; font-style: italic;">@return</span><span style="color: #999999; font-style: italic;"> is this change successful.</span>
<span style="color: #999999; background-color: #2d2d2d; font-style: italic;"> </span><span style="color: #999999; font-style: italic;">*/</span>
<span style="color: #99cc99;">function</span> <span style="color: #f99157;">preferLocal</span>(<span style="color: #ffcc66;">client</span>) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">if</span> (client.options.role === <span style="color: #66cccc;">'slave'</span> &amp;&amp; client.connector.resolveSlave) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">if</span> (client.options.lazyConnect &amp;&amp; client.status == <span style="color: #66cccc;">'wait'</span>) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">if</span> (client.connector.resolveSlave != resolveSlavePreferLocal) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   preferLocalSlave(client);
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   }

<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   client.connector.resolveMaster = resolveMasterPreferLocal;
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   client.connector.resolve = resolvePreferLocal;
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   client.connector.check = checkPreferLocal;
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">return</span> <span style="color: #6699cc;">true</span>;
<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   }

<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #999999; background-color: #2d2d2d;"> </span>   console.warn(<span style="color: #66cccc;">'redis client('</span> + JSON.stringify({name: client.options.name<span style="text-decoration: underline;">, db: client.options.db, sentinels: client.options.sentinels}) + </span><span style="color: #66cccc; text-decoration: underline;">') status unexpected'</span><span style="text-decoration: underline;">);</span>
<span style="color: #999999; background-color: #2d2d2d;"> </span>   }

<span style="color: #999999; background-color: #2d2d2d;"> </span>   <span style="color: #99cc99;">return</span> <span style="color: #6699cc;">false</span>;
}
</pre>
</div>

<p>
用法如下
</p>

<div class="org-src-container">

<pre class="src src-js"><span style="color: #99cc99;">var</span> <span style="color: #ffcc66;">options</span> = {name: <span style="color: #66cccc;">"data"</span>, sentinels: sentinels, db: 0, role: <span style="color: #66cccc;">"slave"</span>, lazyCon<span style="text-decoration: underline;">nect: </span><span style="color: #6699cc; text-decoration: underline;">true</span><span style="text-decoration: underline;">}</span>
<span style="color: #99cc99;">var</span> <span style="color: #ffcc66;">client</span> = <span style="color: #99cc99;">new</span> <span style="color: #6699cc;">Redis</span>(options);
<span style="color: #99cc99;">if</span> (preferLocal(client)) {
<span style="color: #999999; background-color: #2d2d2d;"> </span>   console.warn(<span style="color: #66cccc;">"prefer local on redis sentinel("</span> + JSON.stringify(options) + <span style="color: #66cccc;">"</span><span style="color: #66cccc; text-decoration: underline;">)"</span><span style="text-decoration: underline;">);</span>
}
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">优先选择本地结点（使用 preferredSlaves 选项）</h2>
<div class="outline-text-2" id="text-5">
<p>
具体实现以及用法请参考 gist <a href="https://gist.github.com/tangxinfa/3361a11acf2270e8388b43bfcb25ce0e">Connect redis with Minimum Distance First(MDF) algorithm</a> ，使用 preferredSlaves 选项实现，要求 ioredis 版本至少为 2.4.0 。
</p>

<p>
与前面的实现有一点不同之处：当本地无 slave 而连上本地 master 后，下次重连时即使本地有 slave 了，也还是会继续重连 master。</p>
</div>
</div>

        </div>
        <br />
        <footer class="article-footer">
          <a class="tag" href="/tag/redis/0.html"><i class="icon-tag icon-white"></i> redis</a>
          <a class="tag" href="/tag/node/0.html"><i class="icon-tag icon-white"></i> node</a>
          <span class="muted">
            <i class="icon-time icon-white"></i> <time datetime="2016-09-10T18:12:00+0800">2016年9月10日 18时</time>
          </span>
        </footer>
      </div>

<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'kankananblog';

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

      <div class="push-footer"></div>
    </div>

    <div id="footer">
  	  <div class="copyright" style="text-align: center;">
  	    版权所有 © 2011-2015 看看俺 – KanKanAn.com
  	    <p>Powered by <a href="https://github.com/tangxinfa/ediary">ediary</a>.</p>
  	  </div>
    </div>
  </body>
</html>
